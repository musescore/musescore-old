<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: canvas.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>canvas.cpp</h1><a href="canvas_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: canvas.cpp,v 1.46 2005/06/27 19:50:06 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2005 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="pad_8h.html">pad.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="padstate_8h.html">padstate.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="preferences_8h.html">preferences.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="select_8h.html">select.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="input_8h.html">input.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="seq_8h.html">seq.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00023 
<a name="l00024"></a><a class="code" href="canvas_8cpp.html#a0">00024</a> <a class="code" href="structPadState.html">PadState</a> <a class="code" href="canvas_8cpp.html#a0">padState</a>;
00025 
00026 <span class="comment">//---------------------------------------------------------</span>
00027 <span class="comment">//   Canvas</span>
00028 <span class="comment">//---------------------------------------------------------</span>
00029 
<a name="l00030"></a><a class="code" href="classCanvas.html#a0">00030</a> <a class="code" href="classCanvas.html#a0">Canvas::Canvas</a>(QWidget* parent)
00031    : QWidget(parent, "scanvas")
00032       {
00033       setAttribute(Qt::WA_NoBackground);
00034       setFocusPolicy(Qt::StrongFocus);
00035 
00036       <a class="code" href="classCanvas.html#r0">_score</a>           = 0;
00037       <a class="code" href="classCanvas.html#r5">dragCanvasState</a>  = <span class="keyword">false</span>;
00038       <a class="code" href="classCanvas.html#r17">_bgColor</a>         = Qt::darkBlue;
00039       <a class="code" href="classCanvas.html#r18">_fgColor</a>         = Qt::white;
00040       <a class="code" href="classCanvas.html#r20">fgPixmap</a>         = 0;
00041       <a class="code" href="classCanvas.html#r19">bgPixmap</a>         = 0;
00042       <a class="code" href="classCanvas.html#r10">pad</a>              = 0;
00043       <a class="code" href="classCanvas.html#r6">cursorIsBlinking</a> = <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o2">cursorBlink</a>;
00044       <a class="code" href="classCanvas.html#r16">lasso</a>            = <span class="keyword">new</span> <a class="code" href="classLasso.html">Lasso</a>(<a class="code" href="classCanvas.html#r0">_score</a>);
00045 
00046       <a class="code" href="classCanvas.html#a23">setXoffset</a>(30);
00047       <a class="code" href="classCanvas.html#a24">setYoffset</a>(30);
00048       <a class="code" href="classCanvas.html#a22">setMag</a>(1.0);
00049 
00050       <a class="code" href="classCanvas.html#r4">state</a>            = <a class="code" href="classCanvas.html#w9w0">NORMAL</a>;
00051       <a class="code" href="classCanvas.html#r11">cursor</a>           = <span class="keyword">new</span> <a class="code" href="classCursor.html">Cursor</a>(<a class="code" href="classCanvas.html#r0">_score</a>, 6);
00052       <a class="code" href="classCanvas.html#r12">shadowNote</a>       = <span class="keyword">new</span> <a class="code" href="classShadowNote.html">ShadowNote</a>(<a class="code" href="classCanvas.html#r0">_score</a>);
00053       <a class="code" href="classCanvas.html#r13">cursorTimer</a>      = <span class="keyword">new</span> QTimer(<span class="keyword">this</span>);
00054       <a class="code" href="classCanvas.html#r3">buttonState</a>      = 0;
00055       <a class="code" href="classCanvas.html#r2">keyState</a>         = 0;
00056       <a class="code" href="classCanvas.html#r1">mouseClick</a>       = <span class="keyword">false</span>;
00057 
00058       connect(<a class="code" href="classCanvas.html#r13">cursorTimer</a>, SIGNAL(timeout()), SLOT(<a class="code" href="classCanvas.html#k0">cursorBlink</a>()));
00059       <a class="code" href="classCanvas.html#r13">cursorTimer</a>-&gt;start(500, <span class="keyword">false</span>);
00060       <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(<span class="keyword">false</span>);
00061       <a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(<span class="keyword">false</span>);
00062 
00063       <span class="keywordflow">if</span> (<a class="code" href="element_8cpp.html#a0">debugMode</a>)
00064             setMouseTracking(<span class="keyword">true</span>);
00065       }
00066 
00067 <span class="comment">//---------------------------------------------------------</span>
00068 <span class="comment">//   event</span>
00069 <span class="comment">//---------------------------------------------------------</span>
00070 
<a name="l00071"></a><a class="code" href="classCanvas.html#d13">00071</a> <span class="keywordtype">bool</span> <a class="code" href="classCanvas.html#d13">Canvas::event</a>(QEvent* ev)
00072       {
00073       <span class="keywordflow">if</span> (ev-&gt;type() == QEvent::KeyPress) {
00074             QKeyEvent* ke = (QKeyEvent*) ev;
00075             <span class="keywordflow">if</span> ((<a class="code" href="classCanvas.html#r4">state</a> == <a class="code" href="classCanvas.html#w9w4">EDIT</a>) &amp;&amp; (ke-&gt;key() == Qt::Key_Tab)) {
00076                   <a class="code" href="classCanvas.html#i0">keyPressEvent</a>(ke);
00077                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00078                   }
00079             }
00080       <span class="keywordflow">return</span> QWidget::event(ev);
00081       }
00082 
00083 <span class="comment">//---------------------------------------------------------</span>
00084 <span class="comment">//   cursorBlink</span>
00085 <span class="comment">//---------------------------------------------------------</span>
00086 
<a name="l00087"></a><a class="code" href="classCanvas.html#k0">00087</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#k0">Canvas::cursorBlink</a>()
00088       {
00089       <span class="keywordtype">bool</span> update = <span class="keyword">false</span>;
00090       <span class="keywordflow">if</span> (<a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o2">cursorBlink</a> != <a class="code" href="classCanvas.html#r6">cursorIsBlinking</a>) {
00091             <a class="code" href="classCanvas.html#r6">cursorIsBlinking</a> = <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o2">cursorBlink</a>;
00092             <span class="keywordflow">if</span> (!<a class="code" href="classCanvas.html#r6">cursorIsBlinking</a>) {
00093                   <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classCursor.html#a4">setOff</a>(<span class="keyword">false</span>);
00094                   update = <span class="keyword">true</span>;
00095                   }
00096             }
00097       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r6">cursorIsBlinking</a>) {
00098             <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classCursor.html#a4">setOff</a>(!<a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classCursor.html#a5">off</a>());
00099             update = <span class="keyword">true</span>;
00100             }
00101       <span class="keywordflow">if</span> (update)
00102             <a class="code" href="classCanvas.html#d0">redraw</a>(<a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00103       }
00104 
00105 <span class="comment">//---------------------------------------------------------</span>
00106 <span class="comment">//   Canvas</span>
00107 <span class="comment">//---------------------------------------------------------</span>
00108 
<a name="l00109"></a><a class="code" href="classCanvas.html#a1">00109</a> <a class="code" href="classCanvas.html#a1">Canvas::~Canvas</a>()
00110       {
00111       <span class="keyword">delete</span> <a class="code" href="classCanvas.html#r16">lasso</a>;
00112       <span class="keyword">delete</span> <a class="code" href="classCanvas.html#r11">cursor</a>;
00113       <span class="keyword">delete</span> <a class="code" href="classCanvas.html#r12">shadowNote</a>;
00114       }
00115 
00116 <span class="comment">//---------------------------------------------------------</span>
00117 <span class="comment">//   cavasPopup</span>
00118 <span class="comment">//---------------------------------------------------------</span>
00119 
<a name="l00120"></a><a class="code" href="classCanvas.html#d2">00120</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d2">Canvas::canvasPopup</a>(<span class="keyword">const</span> QPoint&amp; pos)
00121       {
00122       QMenu* popup = <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a7">genCreateMenu</a>(<span class="keyword">this</span>);
00123       popup-&gt;popup(pos);
00124       }
00125 
00126 <span class="comment">//---------------------------------------------------------</span>
00127 <span class="comment">//   objectPopup</span>
00128 <span class="comment">//---------------------------------------------------------</span>
00129 
<a name="l00130"></a><a class="code" href="classCanvas.html#d3">00130</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d3">Canvas::objectPopup</a>(<span class="keyword">const</span> QPoint&amp; pos, <a class="code" href="classElement.html">Element</a>* obj)
00131       {
00132       QMenu* popup = <span class="keyword">new</span> QMenu(<span class="keyword">this</span>);
00133       popup-&gt;setCheckable(<span class="keyword">false</span>);
00134       popup-&gt;insertItem(tr(<span class="stringliteral">"Cut"</span>), 0);
00135       popup-&gt;insertItem(tr(<span class="stringliteral">"Copy"</span>), 1);
00136       popup-&gt;insertItem(tr(<span class="stringliteral">"Delete"</span>), 2);
00137       popup-&gt;insertSeparator();
00138       <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="classElement.html#a16">visible</a>())
00139             popup-&gt;insertItem(tr(<span class="stringliteral">"Set Invisible"</span>), 4);
00140       <span class="keywordflow">else</span>
00141             popup-&gt;insertItem(tr(<span class="stringliteral">"Set Visible"</span>), 4);
00142       popup-&gt;insertItem(tr(<span class="stringliteral">"Color..."</span>), 5);
00143       popup-&gt;insertSeparator();
00144       popup-&gt;insertItem(tr(<span class="stringliteral">"Context"</span>), 3);
00145       QAction* action = popup-&gt;exec(pos);
00146       <span class="keywordflow">if</span> (action == 0)
00147             <span class="keywordflow">return</span>;
00148 <span class="preprocessor">#if 0 //TODO</span>
00149 <span class="preprocessor"></span>      <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>) {
00150             <span class="keywordflow">case</span> 0:
00151             <span class="keywordflow">case</span> 1:
00152                   <span class="keywordflow">break</span>;
00153             <span class="keywordflow">case</span> 2:
00154                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a73">deleteItem</a>(obj);
00155                   <span class="keywordflow">break</span>;
00156             <span class="keywordflow">case</span> 3:
00157                   <a class="code" href="classCanvas.html#d16">contextItem</a>(obj);
00158                   <span class="keywordflow">break</span>;
00159             <span class="keywordflow">case</span> 4:
00160                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a77">toggleInvisible</a>(obj);
00161                   <span class="keywordflow">break</span>;
00162             <span class="keywordflow">case</span> 5:
00163                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a104">colorItem</a>(obj);
00164                   <span class="keywordflow">break</span>;
00165             }
00166 <span class="preprocessor">#endif</span>
00167 <span class="preprocessor"></span>      }
00168 
00169 <span class="comment">//---------------------------------------------------------</span>
00170 <span class="comment">//   mousePressEvent</span>
00171 <span class="comment">//---------------------------------------------------------</span>
00172 
<a name="l00173"></a><a class="code" href="classCanvas.html#d7">00173</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d7">Canvas::mousePressEvent</a>(QMouseEvent* ev)
00174       {
00175       <a class="code" href="classCanvas.html#r1">mouseClick</a> = <span class="keyword">true</span>;
00176       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> != <a class="code" href="classCanvas.html#w9w4">EDIT</a>)
00177             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a83">startCmd</a>();
00178 
00179       <span class="keywordtype">bool</span> b1 = ev-&gt;button() == Qt::LeftButton;
00180       <span class="keywordtype">bool</span> b2 = ev-&gt;button() == Qt::MidButton;
00181       <span class="keywordtype">bool</span> b3 = ev-&gt;button() == Qt::RightButton;
00182 
00183       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> == <a class="code" href="classCanvas.html#w9w8">MAG</a>) {
00184             <span class="keywordflow">if</span> (b1)
00185                   <a class="code" href="classCanvas.html#d5">incMag</a>();
00186             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (b3)
00187                   <a class="code" href="classCanvas.html#d6">decMag</a>();
00188             <span class="keywordflow">return</span>;
00189             }
00190 
00191       <a class="code" href="classCanvas.html#r2">keyState</a>    = ev-&gt;state();
00192       <a class="code" href="classCanvas.html#r3">buttonState</a> = ev-&gt;button();
00193       <a class="code" href="classCanvas.html#r9">startMove</a>   = <a class="code" href="classCanvas.html#r8">imatrix</a>.map(QPointF(ev-&gt;pos()));
00194 
00195       <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a107">setDragObject</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a132">findSelectableElement</a>(<a class="code" href="classCanvas.html#r9">startMove</a>));
00196 
00197       <span class="keywordflow">if</span> (<a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o11">playNotes</a> &amp;&amp; <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>() &amp;&amp; <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>()-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>) {
00198             <a class="code" href="classNote.html">Note</a>* note = (<a class="code" href="classNote.html">Note</a>*)(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>());
00199             <a class="code" href="classStaff.html">Staff</a>* staff = note-&gt;<a class="code" href="classElement.html#a59">staff</a>();
00200             <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a15">playNote</a>(staff-&gt;<a class="code" href="classStaff.html#a9">midiChannel</a>(), note-&gt;<a class="code" href="classNote.html#a15">pitch</a>(), 100);
00201             }
00202 
00203       <span class="comment">//-----------------------------------------</span>
00204       <span class="comment">//  context menus</span>
00205       <span class="comment">//-----------------------------------------</span>
00206 
00207       <span class="keywordflow">if</span> (b3) {
00208             <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>())
00209                   <a class="code" href="classCanvas.html#d3">objectPopup</a>(ev-&gt;globalPos(), <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>());
00210             <span class="keywordflow">else</span>
00211                   <a class="code" href="classCanvas.html#d2">canvasPopup</a>(ev-&gt;globalPos());
00212             <span class="comment">// mouseRelease event is missing, so we must call:</span>
00213             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">true</span>);
00214             <span class="keywordflow">return</span>;
00215             }
00216 
00217       <span class="keywordflow">switch</span> (<a class="code" href="classCanvas.html#r4">state</a>) {
00218             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>:
00219                   <span class="keywordflow">if</span> (!(<a class="code" href="classCanvas.html#r2">keyState</a> &amp; Qt::AltButton))  <span class="comment">// Alt+move = drag canvas</span>
00220                         <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a80">putNote</a>(<a class="code" href="classCanvas.html#r9">startMove</a>, <a class="code" href="classCanvas.html#r2">keyState</a> &amp; Qt::ShiftButton);
00221                   <span class="keywordflow">break</span>;
00222 
00223             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w3">PALETTE</a>:
00224                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a91">paste</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a103">paletteObject</a>(), <a class="code" href="classCanvas.html#r9">startMove</a>);
00225                   <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00226                   <span class="keywordflow">break</span>;
00227 
00228             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w0">NORMAL</a>:
00229                   <span class="comment">//-----------------------------------------</span>
00230                   <span class="comment">//  paste operation</span>
00231                   <span class="comment">//-----------------------------------------</span>
00232 
00233                   <span class="keywordflow">if</span> (b2 &amp;&amp; (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a1">SEL_SINGLE</a>)) {
00234                         <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a91">paste</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a6">element</a>(), <a class="code" href="classCanvas.html#r9">startMove</a>);
00235                         <span class="keywordflow">break</span>;
00236                         }
00237 
00238                   <span class="comment">//-----------------------------------------</span>
00239                   <span class="comment">//  select operation</span>
00240                   <span class="comment">//-----------------------------------------</span>
00241 
00242                   <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>()) {
00243                         <a class="code" href="element_8h.html#a65">ElementType</a> type = <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>()-&gt;<a class="code" href="classElement.html#a40">type</a>();
00244                         <span class="keywordflow">if</span> (type == <a class="code" href="element_8h.html#a65a29">MEASURE</a>) {
00245                               <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o17">dragSystem</a> = (<a class="code" href="classSystem.html">System</a>*)(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>()-&gt;<a class="code" href="classElement.html#a10">parent</a>());
00246                               <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o18">dragStaff</a>  = <a class="code" href="utils_8h.html#a2">getStaff</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o17">dragSystem</a>, <a class="code" href="classCanvas.html#r9">startMove</a>);
00247                               }
00248                         <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>(), <a class="code" href="classCanvas.html#r2">keyState</a>, <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o18">dragStaff</a>);
00249                         }
00250                   <span class="keywordflow">break</span>;
00251 
00252             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w4">EDIT</a>:
00253                   <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a54">editStartDrag</a>(<a class="code" href="classCanvas.html#r9">startMove</a> - <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a27">aref</a>()))
00254                         <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w5">DRAG_EDIT</a>);
00255                   <span class="keywordflow">else</span>
00256                         <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00257                   <span class="keywordflow">break</span>;
00258 
00259             <span class="keywordflow">default</span>:
00260                   <span class="keywordflow">break</span>;
00261             }
00262       }
00263 
00264 <span class="comment">//---------------------------------------------------------</span>
00265 <span class="comment">//   mouseDoubleClickEvent</span>
00266 <span class="comment">//---------------------------------------------------------</span>
00267 
<a name="l00268"></a><a class="code" href="classCanvas.html#d12">00268</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d12">Canvas::mouseDoubleClickEvent</a>(QMouseEvent* ev)
00269       {
00270       <a class="code" href="classElement.html">Element</a>* element = <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>();
00271       <span class="keywordflow">if</span> (element) {
00272             <a class="code" href="classCanvas.html#r1">mouseClick</a> = <span class="keyword">true</span>;
00273             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a83">startCmd</a>();
00274             <span class="keywordflow">if</span> (element-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>) {
00275                   <a class="code" href="classCanvas.html#r2">keyState</a> = ev-&gt;state();
00276                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a107">setDragObject</a>(((<a class="code" href="classNote.html">Note</a>*)element)-&gt;chord());
00277                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>(), <a class="code" href="classCanvas.html#r2">keyState</a>, <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o18">dragStaff</a>);
00278                   }
00279             <span class="keywordflow">else</span> {
00280                   <a class="code" href="classCanvas.html#a15">startEdit</a>(element);
00281                   }
00282             }
00283       <span class="keywordflow">else</span>
00284             <a class="code" href="classCanvas.html#d7">mousePressEvent</a>(ev);
00285       }
00286 
00287 <span class="comment">//---------------------------------------------------------</span>
00288 <span class="comment">//   mouseMoveEvent</span>
00289 <span class="comment">//---------------------------------------------------------</span>
00290 
<a name="l00291"></a><a class="code" href="classCanvas.html#d8">00291</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d8">Canvas::mouseMoveEvent</a>(QMouseEvent* ev)
00292       {
00293       <a class="code" href="classCanvas.html#d9">mouseMoveEvent1</a>(ev);
00294       <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">false</span>);      <span class="comment">// update display but dont end undo</span>
00295       }
00296 
00297 <span class="comment">//---------------------------------------------------------</span>
00298 <span class="comment">//   mouseMoveEvent1</span>
00299 <span class="comment">//---------------------------------------------------------</span>
00300 
<a name="l00301"></a><a class="code" href="classCanvas.html#d9">00301</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d9">Canvas::mouseMoveEvent1</a>(QMouseEvent* ev)
00302       {
00303       QPointF p = <a class="code" href="classCanvas.html#r8">imatrix</a>.map(QPointF(ev-&gt;pos()));
00304       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> == <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>) {
00305             <a class="code" href="classCanvas.html#d20">setShadowNote</a>(p);
00306             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a86">addRefresh</a>(<a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00307             }
00308 
00309       <span class="keywordflow">if</span> (!<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>() &amp;&amp; !(<a class="code" href="classCanvas.html#r2">keyState</a> &amp; Qt::ShiftButton) &amp;&amp; <a class="code" href="classCanvas.html#r3">buttonState</a>) {
00310             <a class="code" href="classCanvas.html#r5">dragCanvasState</a> = <span class="keyword">true</span>;
00311             setCursor(Qt::SizeAllCursor);
00312             }
00313 
00314       QPointF delta = p - <a class="code" href="classCanvas.html#r9">startMove</a>;
00315       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r5">dragCanvasState</a>) {
00316             QPoint d = ev-&gt;pos() - <a class="code" href="classCanvas.html#r7">matrix</a>.map(startMove).toPoint();
00317             <span class="keywordtype">int</span> dx   = d.x();
00318             <span class="keywordtype">int</span> dy   = d.y();
00319             QApplication::sendPostedEvents(<span class="keyword">this</span>, 0);
00320             <a class="code" href="classCanvas.html#r7">matrix</a>.setMatrix(<a class="code" href="classCanvas.html#r7">matrix</a>.m11(), <a class="code" href="classCanvas.html#r7">matrix</a>.m12(), <a class="code" href="classCanvas.html#r7">matrix</a>.m21(),
00321                <a class="code" href="classCanvas.html#r7">matrix</a>.m22(), <a class="code" href="classCanvas.html#r7">matrix</a>.dx()+dx, <a class="code" href="classCanvas.html#r7">matrix</a>.dy()+dy);
00322             <a class="code" href="classCanvas.html#r8">imatrix</a> = <a class="code" href="classCanvas.html#r7">matrix</a>.inverted();
00323             scroll(dx, dy);
00324             <span class="keywordflow">return</span>;
00325             }
00326       <span class="keywordflow">switch</span> (<a class="code" href="classCanvas.html#r4">state</a>) {
00327             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w0">NORMAL</a>:
00328                   <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r3">buttonState</a> == 0)    <span class="comment">// debug</span>
00329                         <span class="keywordflow">return</span>;
00330                   <span class="keywordflow">if</span> (sqrt(pow(delta.x(),2)+pow(delta.y(),2))*<a class="code" href="classCanvas.html#r7">matrix</a>.m11() &lt;= 2.0)
00331                         <span class="keywordflow">return</span>;
00332                   <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>() &amp;&amp; <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>()-&gt;<a class="code" href="classElement.html#a49">startDrag</a>(p)) {
00333                         QPointF o;
00334                         <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a3">SEL_STAFF</a> || <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>) {
00335                               <span class="keywordtype">double</span> s(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o17">dragSystem</a>-&gt;<a class="code" href="classSystem.html#a14">distance</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o18">dragStaff</a>));
00336                               o = QPointF(0.0, <a class="code" href="classCanvas.html#a19">mag</a>() * s);
00337                               <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w2">DRAG_STAFF</a>);
00338                               }
00339                         <span class="keywordflow">else</span> {
00340                               <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a92">startDrag</a>();
00341                               o = QPointF(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>()-&gt;<a class="code" href="classElement.html#a28">userOff</a>() * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00342                               <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w1">DRAG_OBJ</a>);
00343                               }
00344                         startMove -= o;
00345                         <span class="keywordflow">break</span>;
00346                         }
00347                   <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r2">keyState</a> &amp; Qt::ShiftButton)
00348                         <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w6">LASSO</a>);
00349                   <span class="keywordflow">else</span> {
00350                         <a class="code" href="classCanvas.html#r5">dragCanvasState</a> = <span class="keyword">true</span>;
00351                         setCursor(QCursor(Qt::SizeAllCursor));
00352                         <span class="keywordflow">return</span>;
00353                         }
00354                   <span class="keywordflow">break</span>;
00355             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w6">LASSO</a>:
00356                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a86">addRefresh</a>(<a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00357                   <a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a32">setbbox</a>(QRectF(startMove, QSizeF(p.x(), p.y())));
00358                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a86">addRefresh</a>(<a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00359                   <a class="code" href="classCanvas.html#d17">lassoSelect</a>();
00360                   <span class="keywordflow">break</span>;
00361 
00362             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w4">EDIT</a>:
00363                   <span class="keywordflow">break</span>;
00364 
00365             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w5">DRAG_EDIT</a>:
00366                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a95">dragEdit</a>(<a class="code" href="classCanvas.html#r7">matrix</a>, &amp;startMove, delta);
00367                   startMove += delta;
00368                   <span class="keywordflow">break</span>;
00369 
00370             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w2">DRAG_STAFF</a>:
00371                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o17">dragSystem</a>-&gt;<a class="code" href="classSystem.html#a15">setDistance</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o18">dragStaff</a>, delta.y());
00372                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a53">layout1</a>();   <span class="comment">// DEBUG: does not work</span>
00373                   <span class="keywordflow">break</span>;
00374 
00375             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w1">DRAG_OBJ</a>:
00376                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a93">drag</a>(delta);
00377                   <span class="keywordflow">break</span>;
00378 
00379             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w3">PALETTE</a>:
00380             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>:
00381             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w8">MAG</a>:
00382                   <span class="keywordflow">break</span>;
00383             }
00384       }
00385 
00386 <span class="comment">//---------------------------------------------------------</span>
00387 <span class="comment">//   mouseReleaseEvent</span>
00388 <span class="comment">//---------------------------------------------------------</span>
00389 
<a name="l00390"></a><a class="code" href="classCanvas.html#d10">00390</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d10">Canvas::mouseReleaseEvent</a>(QMouseEvent* ev)
00391       {
00392       <span class="keywordflow">if</span> (!<a class="code" href="classCanvas.html#r1">mouseClick</a>) {
00393             <span class="comment">// printf("single mouse release, ignore\n");</span>
00394             <span class="keywordflow">return</span>;
00395             }
00396       <a class="code" href="classCanvas.html#r1">mouseClick</a> = <span class="keyword">false</span>;
00397       <span class="keywordflow">if</span> (<a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o11">playNotes</a> &amp;&amp; <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>() &amp;&amp; <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>()-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>) {
00398             <a class="code" href="classNote.html">Note</a>* note = (<a class="code" href="classNote.html">Note</a>*)(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>());
00399             <a class="code" href="classStaff.html">Staff</a>* staff = note-&gt;<a class="code" href="classElement.html#a59">staff</a>();
00400             <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a15">playNote</a>(staff-&gt;<a class="code" href="classStaff.html#a9">midiChannel</a>(), note-&gt;<a class="code" href="classNote.html#a15">pitch</a>(), 0);
00401             }
00402       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> == <a class="code" href="classCanvas.html#w9w4">EDIT</a>)
00403             <span class="keywordflow">return</span>;
00404       <a class="code" href="classCanvas.html#d11">mouseReleaseEvent1</a>(ev);
00405       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> != <a class="code" href="classCanvas.html#w9w4">EDIT</a>)
00406             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">true</span>);
00407       }
00408 
00409 <span class="comment">//---------------------------------------------------------</span>
00410 <span class="comment">//   mouseReleaseEvent</span>
00411 <span class="comment">//---------------------------------------------------------</span>
00412 
<a name="l00413"></a><a class="code" href="classCanvas.html#d11">00413</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d11">Canvas::mouseReleaseEvent1</a>(QMouseEvent* <span class="comment">/*ev*/</span>)
00414       {
00415       <a class="code" href="classCanvas.html#r3">buttonState</a> = 0;
00416       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r5">dragCanvasState</a>) {
00417             <a class="code" href="classCanvas.html#r5">dragCanvasState</a> = <span class="keyword">false</span>;
00418             <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#r4">state</a>);        <span class="comment">// reset cursor pixmap</span>
00419             <span class="keywordflow">return</span>;
00420             }
00421 
00422       <span class="keywordflow">switch</span> (<a class="code" href="classCanvas.html#r4">state</a>) {
00423 <span class="preprocessor">#if 0</span>
00424 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w4">EDIT</a>:
00425                   <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>() != <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o16">editObject</a>) {
00426                         <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00427                         <span class="comment">// Pos sm = tf-&gt;ipoint2fpos(startMove);</span>
00428                         <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>(), 0, 0);
00429                         }
00430                   <span class="keywordflow">break</span>;
00431 <span class="preprocessor">#endif</span>
00432 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w5">DRAG_EDIT</a>:
00433                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a56">editEndDrag</a>();
00434                   <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w4">EDIT</a>);
00435                   <span class="keywordflow">break</span>;
00436 
00437             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w6">LASSO</a>:
00438                   <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00439                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a86">addRefresh</a>(<a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00440                   <span class="keywordflow">break</span>;
00441 
00442             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w1">DRAG_OBJ</a>:
00443                   <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00444                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a94">endDrag</a>();
00445                   <span class="keywordflow">break</span>;
00446 
00447             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w2">DRAG_STAFF</a>:
00448                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a49">layout</a>();
00449                   <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00450                   <span class="keywordflow">break</span>;
00451 
00452             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w8">MAG</a>:
00453                   <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r2">keyState</a> &amp; Qt::ShiftButton)
00454                         <span class="keywordflow">break</span>;
00455                   <span class="comment">// fall through</span>
00456 
00457             <span class="keywordflow">default</span>:
00458                   <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00459 
00460             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>:
00461             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w3">PALETTE</a>:
00462                   <span class="keywordflow">break</span>;
00463 
00464             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w0">NORMAL</a>:
00465                   <span class="keywordflow">if</span> (!<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a106">dragObject</a>())
00466                         <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(0, 0, 0);      <span class="comment">// deselect all</span>
00467                   <span class="keywordflow">break</span>;
00468             }
00469       }
00470 
00471 <span class="comment">//---------------------------------------------------------</span>
00472 <span class="comment">//   setMag</span>
00473 <span class="comment">//---------------------------------------------------------</span>
00474 
00475 <span class="keywordtype">void</span> Canvas::setMag(<span class="keywordtype">double</span> nmag)
00476       {
00477       <span class="keywordtype">double</span> deltamag = nmag / <a class="code" href="classCanvas.html#a19">mag</a>();
00478       setXoffset(<a class="code" href="classCanvas.html#a20">xoffset</a>() * deltamag);
00479       setYoffset(<a class="code" href="classCanvas.html#a21">yoffset</a>() * deltamag);
00480 
00481       qreal m = nmag * qreal(appDpiX) / DPI;
00482       matrix.setMatrix(m, matrix.m12(), matrix.m21(),
00483          m * qreal(appDpiY)/qreal(appDpiX), matrix.dx(), matrix.dy());
00484       imatrix = matrix.inverted();
00485 
00486       <span class="keywordflow">if</span> (_score)
00487             _score-&gt;<a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classPageList.html#a1">update</a>(_score);
00488       update();
00489       }
00490 
00491 <span class="comment">//---------------------------------------------------------</span>
00492 <span class="comment">//   incMag</span>
00493 <span class="comment">//---------------------------------------------------------</span>
00494 
<a name="l00495"></a><a class="code" href="classCanvas.html#d5">00495</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d5">Canvas::incMag</a>()
00496       {
00497       qreal _mag = <a class="code" href="classCanvas.html#a19">mag</a>() * 1.7;
00498       <span class="keywordflow">if</span> (_mag &gt; 16.0)
00499             _mag = 16.0;
00500       <a class="code" href="classCanvas.html#a22">setMag</a>(_mag);
00501       emit <a class="code" href="classCanvas.html#l2">magChanged</a>();
00502       }
00503 
00504 <span class="comment">//---------------------------------------------------------</span>
00505 <span class="comment">//   decMag</span>
00506 <span class="comment">//---------------------------------------------------------</span>
00507 
<a name="l00508"></a><a class="code" href="classCanvas.html#d6">00508</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d6">Canvas::decMag</a>()
00509       {
00510       qreal nmag = <a class="code" href="classCanvas.html#a19">mag</a>() / 1.7;
00511       <span class="keywordflow">if</span> (nmag &lt; 0.05)
00512             nmag = 0.05;
00513       <a class="code" href="classCanvas.html#a22">setMag</a>(nmag);
00514       emit <a class="code" href="classCanvas.html#l2">magChanged</a>();
00515       }
00516 
00517 <span class="comment">//---------------------------------------------------------</span>
00518 <span class="comment">//   setBackground</span>
00519 <span class="comment">//---------------------------------------------------------</span>
00520 
<a name="l00521"></a><a class="code" href="classCanvas.html#a3">00521</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a3">Canvas::setBackground</a>(QPixmap* pm)
00522       {
00523       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r19">bgPixmap</a>)
00524             <span class="keyword">delete</span> <a class="code" href="classCanvas.html#r19">bgPixmap</a>;
00525       <a class="code" href="classCanvas.html#r19">bgPixmap</a> = pm;
00526       update();
00527       }
00528 
<a name="l00529"></a><a class="code" href="classCanvas.html#a4">00529</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a3">Canvas::setBackground</a>(<span class="keyword">const</span> QColor&amp; color)
00530       {
00531       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r19">bgPixmap</a>) {
00532             <span class="keyword">delete</span> <a class="code" href="classCanvas.html#r19">bgPixmap</a>;
00533             <a class="code" href="classCanvas.html#r19">bgPixmap</a> = 0;
00534             }
00535       <a class="code" href="classCanvas.html#r17">_bgColor</a> = color;
00536       update();
00537       }
00538 
00539 <span class="comment">//---------------------------------------------------------</span>
00540 <span class="comment">//   setForeground</span>
00541 <span class="comment">//---------------------------------------------------------</span>
00542 
<a name="l00543"></a><a class="code" href="classCanvas.html#a5">00543</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a5">Canvas::setForeground</a>(QPixmap* pm)
00544       {
00545       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r20">fgPixmap</a>)
00546             <span class="keyword">delete</span> <a class="code" href="classCanvas.html#r20">fgPixmap</a>;
00547       <a class="code" href="classCanvas.html#r20">fgPixmap</a> = pm;
00548       update();
00549       }
00550 
<a name="l00551"></a><a class="code" href="classCanvas.html#a6">00551</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a5">Canvas::setForeground</a>(<span class="keyword">const</span> QColor&amp; color)
00552       {
00553       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r20">fgPixmap</a>) {
00554             <span class="keyword">delete</span> <a class="code" href="classCanvas.html#r20">fgPixmap</a>;
00555             <a class="code" href="classCanvas.html#r20">fgPixmap</a> = 0;
00556             }
00557       <a class="code" href="classCanvas.html#r18">_fgColor</a> = color;
00558       update();
00559       }
00560 
00561 <span class="comment">//---------------------------------------------------------</span>
00562 <span class="comment">//   setState</span>
00563 <span class="comment">//---------------------------------------------------------</span>
00564 
<a name="l00565"></a><a class="code" href="classCanvas.html#a13">00565</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a13">Canvas::setState</a>(State s)
00566       {
00567       <span class="keywordflow">switch</span>(s) {
00568             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>:
00569             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w3">PALETTE</a>:
00570                   setCursor(QCursor(Qt::UpArrowCursor));
00571                   <span class="keywordflow">break</span>;
00572             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w8">MAG</a>:
00573                   setCursor(QCursor(Qt::SizeAllCursor));
00574                   <span class="keywordflow">break</span>;
00575             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w0">NORMAL</a>:
00576             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w4">EDIT</a>:
00577             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w1">DRAG_OBJ</a>:
00578             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w2">DRAG_STAFF</a>:
00579             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w5">DRAG_EDIT</a>:
00580             <span class="keywordflow">case</span> <a class="code" href="classCanvas.html#w9w6">LASSO</a>:
00581                   setCursor(QCursor(Qt::ArrowCursor));
00582                   <span class="keywordflow">break</span>;
00583             }
00584       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classElement.html#a16">visible</a>() != (s == <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>)) {
00585             <a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(s == <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>);
00586             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a86">addRefresh</a>(<a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00587             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a86">addRefresh</a>(<a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00588             }
00589       setMouseTracking(s == <a class="code" href="classCanvas.html#w9w7">NOTE_ENTRY</a>);
00590       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> == <a class="code" href="classCanvas.html#w9w6">LASSO</a> || s == <a class="code" href="classCanvas.html#w9w6">LASSO</a>)
00591             <a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(s == <a class="code" href="classCanvas.html#w9w6">LASSO</a>);
00592       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> == <a class="code" href="classCanvas.html#w9w4">EDIT</a> &amp;&amp; s != <a class="code" href="classCanvas.html#w9w4">EDIT</a> &amp;&amp; s != <a class="code" href="classCanvas.html#w9w5">DRAG_EDIT</a>) {
00593             <a class="code" href="classCanvas.html#d19">endEdit</a>();
00594             }
00595       <a class="code" href="classCanvas.html#r4">state</a> = s;
00596       }
00597 
00598 <span class="comment">//---------------------------------------------------------</span>
00599 <span class="comment">//   showPad</span>
00600 <span class="comment">//---------------------------------------------------------</span>
00601 
<a name="l00602"></a><a class="code" href="classCanvas.html#i1">00602</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#i1">Canvas::showPad</a>()
00603       {
00604       <span class="keywordtype">bool</span> visible;
00605       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r10">pad</a> == 0) {
00606             <a class="code" href="classCanvas.html#r10">pad</a> = <span class="keyword">new</span> <a class="code" href="classPad.html">Pad</a>(0, <span class="stringliteral">"pad"</span>);
00607             connect(<a class="code" href="classCanvas.html#r10">pad</a>, SIGNAL(keyPadToggled(<span class="keywordtype">int</span>)), <a class="code" href="classCanvas.html#r0">_score</a>, SLOT(keyPadToggle(<span class="keywordtype">int</span>)));
00608             connect(<a class="code" href="classCanvas.html#r10">pad</a>, SIGNAL(keyEvent(QKeyEvent*)), SLOT(<a class="code" href="classCanvas.html#i0">keyPressEvent</a>(QKeyEvent*)));
00609             connect(<a class="code" href="classCanvas.html#r0">_score</a>, SIGNAL(padChanged(<span class="keywordtype">bool</span>,<span class="keywordtype">int</span>)), <a class="code" href="classCanvas.html#r10">pad</a>, SLOT(setOn(<span class="keywordtype">bool</span>,<span class="keywordtype">int</span>)));
00610             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a82">setPadState</a>();
00611             visible = <span class="keyword">true</span>;
00612             }
00613       <span class="keywordflow">else</span> {
00614             visible = !<a class="code" href="classCanvas.html#r10">pad</a>-&gt;isVisible();
00615             }
00616       <span class="keywordflow">if</span> (visible)
00617             <a class="code" href="classCanvas.html#r10">pad</a>-&gt;show();
00618       <span class="keywordflow">else</span>
00619             <a class="code" href="classCanvas.html#r10">pad</a>-&gt;hide();
00620       emit <a class="code" href="classCanvas.html#l0">padVisible</a>(visible);
00621       }
00622 
00623 <span class="comment">//---------------------------------------------------------</span>
00624 <span class="comment">//   cmdCut</span>
00625 <span class="comment">//---------------------------------------------------------</span>
00626 
<a name="l00627"></a><a class="code" href="classCanvas.html#i2">00627</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#i2">Canvas::cmdCut</a>()
00628       {
00629       }
00630 
00631 <span class="comment">//---------------------------------------------------------</span>
00632 <span class="comment">//   cmdCopy</span>
00633 <span class="comment">//---------------------------------------------------------</span>
00634 
<a name="l00635"></a><a class="code" href="classCanvas.html#i3">00635</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#i3">Canvas::cmdCopy</a>()
00636       {
00637       }
00638 
00639 <span class="comment">//---------------------------------------------------------</span>
00640 <span class="comment">//   cmdPaste</span>
00641 <span class="comment">//---------------------------------------------------------</span>
00642 
<a name="l00643"></a><a class="code" href="classCanvas.html#i4">00643</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#i4">Canvas::cmdPaste</a>()
00644       {
00645       }
00646 
00647 <span class="comment">//---------------------------------------------------------</span>
00648 <span class="comment">//   magCanvas</span>
00649 <span class="comment">//---------------------------------------------------------</span>
00650 
<a name="l00651"></a><a class="code" href="classCanvas.html#i5">00651</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#i5">Canvas::magCanvas</a>()
00652       {
00653       <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w8">MAG</a>);
00654       }
00655 
00656 <span class="comment">//---------------------------------------------------------</span>
00657 <span class="comment">//   dataChanged</span>
00658 <span class="comment">//---------------------------------------------------------</span>
00659 
<a name="l00660"></a><a class="code" href="classCanvas.html#a12">00660</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a12">Canvas::dataChanged</a>(<a class="code" href="classScore.html">Score</a>*, <span class="keyword">const</span> QRectF&amp; r)
00661       {
00662       <a class="code" href="classCanvas.html#d0">redraw</a>(r);
00663       }
00664 
00665 <span class="comment">//---------------------------------------------------------</span>
00666 <span class="comment">//   redraw</span>
00667 <span class="comment">//---------------------------------------------------------</span>
00668 
<a name="l00669"></a><a class="code" href="classCanvas.html#d0">00669</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d0">Canvas::redraw</a>(<span class="keyword">const</span> QRectF&amp; fr)
00670       {
00671       update(<a class="code" href="classCanvas.html#r7">matrix</a>.mapRect(fr).toRect());  <span class="comment">// generate paint event</span>
00672       }
00673 
00674 <span class="comment">//---------------------------------------------------------</span>
00675 <span class="comment">//   resetStaffOffsets</span>
00676 <span class="comment">//---------------------------------------------------------</span>
00677 
<a name="l00678"></a><a class="code" href="classCanvas.html#i6">00678</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#i6">Canvas::resetStaffOffsets</a>()
00679       {
00680 <span class="comment">/*      for (iSystem i = _score-&gt;systems-&gt;begin(); i != _score-&gt;systems-&gt;end(); ++i) {</span>
00681 <span class="comment">            for (int staff = 0; staff &lt; _score-&gt;staves(); ++staff)</span>
00682 <span class="comment">                  (*i)-&gt;staff(staff)-&gt;setUserOff(0.0);</span>
00683 <span class="comment">            }</span>
00684 <span class="comment">      _score-&gt;layout();</span>
00685 <span class="comment">      redraw();</span>
00686 <span class="comment">*/</span>
00687       }
00688 
00689 <span class="comment">//---------------------------------------------------------</span>
00690 <span class="comment">//   showInvisibleClicked</span>
00691 <span class="comment">//---------------------------------------------------------</span>
00692 
<a name="l00693"></a><a class="code" href="classCanvas.html#i7">00693</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#i7">Canvas::showInvisibleClicked</a>()
00694       {
00695       <a class="code" href="element_8cpp.html#a1">showInvisible</a> = !<a class="code" href="element_8cpp.html#a1">showInvisible</a>;
00696       update();
00697       emit <a class="code" href="classCanvas.html#l1">showInvisibleChanged</a>();
00698       }
00699 
00700 <span class="comment">//---------------------------------------------------------</span>
00701 <span class="comment">//   startEdit</span>
00702 <span class="comment">//---------------------------------------------------------</span>
00703 
<a name="l00704"></a><a class="code" href="classCanvas.html#a15">00704</a> <span class="keywordtype">bool</span> <a class="code" href="classCanvas.html#a15">Canvas::startEdit</a>(<a class="code" href="classElement.html">Element</a>* element)
00705       {
00706       <span class="keywordflow">if</span> (element-&gt;<a class="code" href="classElement.html#a52">startEdit</a>(<a class="code" href="classCanvas.html#r7">matrix</a>)) {
00707             grabKeyboard();
00708             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a88">startEdit</a>(element);
00709             <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w4">EDIT</a>);
00710             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00711             }
00712       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00713       }
00714 
00715 <span class="comment">//---------------------------------------------------------</span>
00716 <span class="comment">//   endEdit</span>
00717 <span class="comment">//---------------------------------------------------------</span>
00718 
<a name="l00719"></a><a class="code" href="classCanvas.html#d19">00719</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d19">Canvas::endEdit</a>()
00720       {
00721       releaseKeyboard();
00722       <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a90">endEdit</a>();
00723       }
00724 
00725 <span class="comment">//---------------------------------------------------------</span>
00726 <span class="comment">//   clearScore</span>
00727 <span class="comment">//---------------------------------------------------------</span>
00728 
<a name="l00729"></a><a class="code" href="classCanvas.html#a11">00729</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a11">Canvas::clearScore</a>()
00730       {
00731       <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(<span class="keyword">false</span>);
00732       <a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(<span class="keyword">false</span>);
00733       update();
00734       <a class="code" href="canvas_8cpp.html#a0">padState</a>.<a class="code" href="structPadState.html#o6">pitch</a> = 64;
00735       <a class="code" href="classCanvas.html#a13">setState</a>(<a class="code" href="classCanvas.html#w9w0">NORMAL</a>);
00736       }
00737 
00738 <span class="comment">//---------------------------------------------------------</span>
00739 <span class="comment">//   focusInEvent</span>
00740 <span class="comment">//    grab keyboard in EDIT mode; this disables all</span>
00741 <span class="comment">//    accelerators</span>
00742 <span class="comment">//---------------------------------------------------------</span>
00743 
<a name="l00744"></a><a class="code" href="classCanvas.html#d14">00744</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d14">Canvas::focusInEvent</a>(QFocusEvent*)
00745       {
00746       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r4">state</a> == <a class="code" href="classCanvas.html#w9w4">EDIT</a>) {
00747             grabKeyboard();
00748             }
00749       }
00750 
00751 <span class="comment">//---------------------------------------------------------</span>
00752 <span class="comment">//   focusOutEvent</span>
00753 <span class="comment">//---------------------------------------------------------</span>
00754 
<a name="l00755"></a><a class="code" href="classCanvas.html#d15">00755</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d15">Canvas::focusOutEvent</a>(QFocusEvent*)
00756       {
00757       releaseKeyboard();
00758       }
00759 
00760 <span class="comment">//---------------------------------------------------------</span>
00761 <span class="comment">//   setPadNo</span>
00762 <span class="comment">//---------------------------------------------------------</span>
00763 
<a name="l00764"></a><a class="code" href="classCanvas.html#a16">00764</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a16">Canvas::setPadNo</a>(<span class="keywordtype">int</span> padno)
00765       {
00766       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r10">pad</a>)
00767             <a class="code" href="classCanvas.html#r10">pad</a>-&gt;<a class="code" href="classPad.html#i0">setPadNo</a>(padno);
00768       }
00769 
00770 <span class="comment">//---------------------------------------------------------</span>
00771 <span class="comment">//   moveCursor</span>
00772 <span class="comment">//    move cursor and set visible</span>
00773 <span class="comment">//    if (tick == -1) hide cursor</span>
00774 <span class="comment">//---------------------------------------------------------</span>
00775 
<a name="l00776"></a><a class="code" href="classCanvas.html#a10">00776</a> QRectF <a class="code" href="classCanvas.html#a10">Canvas::moveCursor</a>()
00777       {
00778       QRectF refresh;
00779 
00780       <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a63">setVoice</a>(<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o2">voice</a>);
00781       <span class="keywordtype">int</span> staff = <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>;
00782       <span class="keywordtype">int</span> tick  = <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a>;
00783       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a16">visible</a>()) {
00784             refresh |= <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00785             }
00786       <span class="keywordflow">if</span> (tick == -1) {
00787             <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(<span class="keyword">false</span>);
00788             <span class="keywordflow">return</span> refresh;
00789             }
00790       <span class="keywordflow">if</span> (staff == -1) {
00791             printf(<span class="stringliteral">"cannot set Cursor to staff -1\n"</span>);
00792             <span class="keywordflow">return</span> refresh;
00793             }
00794       <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a17">setVisible</a>(<span class="keyword">true</span>);
00795       <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a75">setTick</a>(tick);
00796 
00797       <a class="code" href="classMeasure.html">Measure</a>* measure = <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a128">tick2measure</a>(tick);
00798       <span class="keywordflow">if</span> (measure) {
00799             <a class="code" href="classSegment.html">Segment</a>* segment;
00800             <span class="keywordflow">for</span> (segment = measure-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00801                   <span class="keywordflow">if</span> (segment-&gt;<a class="code" href="classSegment.html#a18">type</a>() != Segment::SegChordRest)
00802                         <span class="keywordflow">continue</span>;
00803                   <span class="keywordflow">if</span> (segment-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick)
00804                         <span class="keywordflow">break</span>;
00805                   }
00806             <span class="keywordflow">if</span> (segment) {
00807                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a105">adjustCanvasPosition</a>(segment);
00808                   <a class="code" href="classSystem.html">System</a>* system = measure-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
00809                   <span class="keywordtype">double</span> x = segment-&gt;<a class="code" href="classSegment.html#a15">x</a>() + measure-&gt;<a class="code" href="classElement.html#a27">aref</a>().x();
00810                   <span class="keywordtype">double</span> y = system-&gt;<a class="code" href="classSystem.html#a11">bboxStaff</a>(staff).y() + system-&gt;<a class="code" href="classElement.html#a27">aref</a>().y();
00811                   refresh |= <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00812                   <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a23">setpos</a>(x - <a class="code" href="spatium_8h.html#a0">_spatium</a>, y - <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00813                   refresh |= <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00814                   <span class="keywordflow">return</span> refresh;
00815                   }
00816             }
00817       printf(<span class="stringliteral">"cursor position not found for tick %d\n"</span>, tick);
00818       <span class="keywordflow">return</span> refresh;
00819       }
00820 
00821 <span class="comment">//---------------------------------------------------------</span>
00822 <span class="comment">//   setShadowNote</span>
00823 <span class="comment">//---------------------------------------------------------</span>
00824 
<a name="l00825"></a><a class="code" href="classCanvas.html#d20">00825</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#d20">Canvas::setShadowNote</a>(<span class="keyword">const</span> QPointF&amp; p)
00826       {
00827       <span class="keywordtype">int</span> tick, line;
00828       <a class="code" href="classStaff.html">Staff</a>* staff;
00829       <a class="code" href="classSegment.html">Segment</a>* seg;
00830 
00831       <a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a22">pos2measure2</a>(p, &amp;tick, &amp;staff, &amp;line, &amp;seg);
00832       <span class="keywordflow">if</span> (m == 0)
00833             <span class="keywordflow">return</span>;
00834 
00835       <a class="code" href="classSystem.html">System</a>* s = m-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
00836       <a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classShadowNote.html#a4">setLine</a>(line);
00837 
00838       <span class="keywordtype">double</span> y = seg-&gt;<a class="code" href="classElement.html#a35">apos</a>().y() + s-&gt;<a class="code" href="classSystem.html#a13">staff</a>(staff-&gt;<a class="code" href="classStaff.html#a15">idx</a>())-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y();
00839       y += line * <a class="code" href="spatium_8h.html#a0">_spatium</a> * .5;
00840 
00841       <a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classElement.html#a23">setpos</a>(seg-&gt;<a class="code" href="classElement.html#a35">apos</a>().x(), y);
00842       <a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classShadowNote.html#a5">layout</a>();
00843       }
00844 
00845 <span class="comment">//---------------------------------------------------------</span>
00846 <span class="comment">//   mag</span>
00847 <span class="comment">//---------------------------------------------------------</span>
00848 
<a name="l00849"></a><a class="code" href="classCanvas.html#a19">00849</a> qreal <a class="code" href="classCanvas.html#a19">Canvas::mag</a>()<span class="keyword"> const</span>
00850 <span class="keyword">      </span>{
00851       <span class="keywordflow">return</span> <a class="code" href="classCanvas.html#r7">matrix</a>.m11() * DPI / qreal(<a class="code" href="globals_8h.html#a5">appDpiX</a>);
00852       }
00853 
00854 <span class="comment">//---------------------------------------------------------</span>
00855 <span class="comment">//   fsize</span>
00856 <span class="comment">//---------------------------------------------------------</span>
00857 
<a name="l00858"></a><a class="code" href="classCanvas.html#a26">00858</a> QSizeF <a class="code" href="classCanvas.html#a26">Canvas::fsize</a>()<span class="keyword"> const</span>
00859 <span class="keyword">      </span>{
00860       QSize s = size();
00861       <span class="keywordflow">return</span> QSizeF(s.width() * <a class="code" href="classCanvas.html#r8">imatrix</a>.m11(), s.height() * <a class="code" href="classCanvas.html#r8">imatrix</a>.m22());
00862       }
00863 
00864 <span class="comment">//---------------------------------------------------------</span>
00865 <span class="comment">//   paintEvent</span>
00866 <span class="comment">//    Note: desktop background and paper background are not</span>
00867 <span class="comment">//    scaled</span>
00868 <span class="comment">//---------------------------------------------------------</span>
00869 
<a name="l00870"></a><a class="code" href="classCanvas.html#a2">00870</a> <span class="keywordtype">void</span> <a class="code" href="classCanvas.html#a2">Canvas::paintEvent</a>(QPaintEvent* ev)
00871       {
00872       QRect rr;
00873       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a50">needLayout</a>()) {
00874             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a51">doLayout</a>();
00875             rr = QRect(00, 0, width(), height());
00876             }
00877       <span class="keywordflow">else</span> {
00878             <span class="keywordtype">int</span> dx = lrint(<a class="code" href="classCanvas.html#r7">matrix</a>.m11());
00879             <span class="keywordtype">int</span> dy = lrint(<a class="code" href="classCanvas.html#r7">matrix</a>.m22());
00880             rr = QRect(ev-&gt;rect().x()-dx, ev-&gt;rect().y()-dy,
00881                ev-&gt;rect().width()+2*dx, ev-&gt;rect().height()+2*dy);
00882             }
00883 
00884 <span class="comment">// printf("paint %d %d %d %d\n", rr.x(), rr.y(), rr.width(), rr.height());</span>
00885 
00886       <a class="code" href="classPainter.html">Painter</a> p(<span class="keyword">this</span>);
00887       p.setRenderHint(QPainter::Antialiasing, <span class="keyword">true</span>);
00888 
00889       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r20">fgPixmap</a> == 0 || <a class="code" href="classCanvas.html#r20">fgPixmap</a>-&gt;isNull())
00890             p.fillRect(rr, <a class="code" href="classCanvas.html#r18">_fgColor</a>);
00891       <span class="keywordflow">else</span> {
00892             p.drawTiledPixmap(rr, *<a class="code" href="classCanvas.html#r20">fgPixmap</a>, rr.topLeft()-QPoint(lrint(<a class="code" href="classCanvas.html#a20">xoffset</a>()), lrint(<a class="code" href="classCanvas.html#a21">yoffset</a>())));
00893             }
00894 
00895       p.setMatrix(<a class="code" href="classCanvas.html#r7">matrix</a>);
00896       QRectF fr = <a class="code" href="classCanvas.html#r8">imatrix</a>.mapRect(QRectF(rr));
00897       p.setClipRect(fr);
00898 
00899       QRegion r1(rr);
00900       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a0">iPage</a> ip = <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
00901             <a class="code" href="classPage.html">Page</a>* page = *ip;
00902             QRectF pbbox(page-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00903             r1 -= <a class="code" href="classCanvas.html#r7">matrix</a>.mapRect(pbbox).toRect();
00904             <span class="keywordflow">if</span> (fr.intersects(pbbox)) {
00905                   p.translate(page-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00906                   page-&gt;<a class="code" href="classPage.html#a20">draw</a>(p);
00907                   p.translate(-page-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00908                   }
00909             }
00910 <span class="preprocessor">#if 0</span>
00911 <span class="preprocessor"></span>      p.setClipRegion(rr);
00912       <a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a43">draw</a>(p);
00913       <a class="code" href="classCanvas.html#r11">cursor</a>-&gt;<a class="code" href="classElement.html#a43">draw</a>(p);
00914       <a class="code" href="classCanvas.html#r12">shadowNote</a>-&gt;<a class="code" href="classShadowNote.html#a6">draw</a>(p);
00915 <span class="preprocessor">#endif</span>
00916 <span class="preprocessor"></span>      p.setMatrixEnabled(<span class="keyword">false</span>);
00917       p.setClipRegion(r1);  <span class="comment">// only background</span>
00918       <span class="keywordflow">if</span> (<a class="code" href="classCanvas.html#r19">bgPixmap</a> == 0 || <a class="code" href="classCanvas.html#r19">bgPixmap</a>-&gt;isNull())
00919             p.fillRect(rr, <a class="code" href="classCanvas.html#r17">_bgColor</a>);
00920       <span class="keywordflow">else</span>
00921             p.drawTiledPixmap(rr, *<a class="code" href="classCanvas.html#r19">bgPixmap</a>, rr.topLeft()-QPoint(lrint(<a class="code" href="classCanvas.html#a20">xoffset</a>()), lrint(<a class="code" href="classCanvas.html#a21">yoffset</a>())));
00922       }
00923 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
