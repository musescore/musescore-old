<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: project.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>project.cpp</h1><a href="project_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: project.cpp,v 1.56 2005/06/27 19:50:24 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="alsa_8h.html">alsa.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="key_8h.html">key.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="tempo_8h.html">tempo.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="page_8h.html">page.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="undo_8h.html">undo.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="select_8h.html">select.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="xml_8h.html">xml.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="input_8h.html">input.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00026 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="padstate_8h.html">padstate.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="seq_8h.html">seq.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="part_8h.html">part.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00033 
<a name="l00034"></a><a class="code" href="project_8cpp.html#a0">00034</a> <a class="code" href="structInputState.html">InputState</a> <a class="code" href="project_8cpp.html#a0">inputState</a>;
<a name="l00035"></a><a class="code" href="project_8cpp.html#a1">00035</a> <a class="code" href="structInputState.html">InputState</a>* <a class="code" href="input_8h.html#a0">cis</a>;              <span class="comment">//  = &amp;inputState;</span>
00036 
00037 QPoint <a class="code" href="project_8cpp.html#a11">scorePos</a>(0,0);
00038 QSize  <a class="code" href="project_8cpp.html#a12">scoreSize</a>(950, 500);
<a name="l00039"></a><a class="code" href="project_8cpp.html#a2">00039</a> <a class="code" href="classMuseScore.html">MuseScore</a>* <a class="code" href="project_8cpp.html#a2">mscore</a>;
<a name="l00040"></a><a class="code" href="project_8cpp.html#a3">00040</a> <span class="keywordtype">bool</span> <a class="code" href="element_8cpp.html#a0">debugMode</a> = <span class="keyword">false</span>;
<a name="l00041"></a><a class="code" href="project_8cpp.html#a4">00041</a> <span class="keywordtype">bool</span> <a class="code" href="project_8cpp.html#a4">layoutDebug</a> = <span class="keyword">false</span>;
<a name="l00042"></a><a class="code" href="project_8cpp.html#a5">00042</a> <span class="keywordtype">bool</span> <a class="code" href="project_8cpp.html#a5">noSeq</a> = <span class="keyword">false</span>;
<a name="l00043"></a><a class="code" href="project_8cpp.html#a6">00043</a> <span class="keywordtype">bool</span> <a class="code" href="project_8cpp.html#a6">noMidi</a> = <span class="keyword">false</span>;
<a name="l00044"></a><a class="code" href="project_8cpp.html#a7">00044</a> <span class="keywordtype">bool</span> <a class="code" href="element_8cpp.html#a1">showInvisible</a> = <span class="keyword">false</span>;
<a name="l00045"></a><a class="code" href="project_8cpp.html#a8">00045</a> <span class="keywordtype">bool</span> <a class="code" href="project_8cpp.html#a8">showRubberBand</a> = <span class="keyword">true</span>;
00046 
00047 <span class="comment">//---------------------------------------------------------</span>
00048 <span class="comment">//   ScoreLayout</span>
00049 <span class="comment">//---------------------------------------------------------</span>
00050 
<a name="l00051"></a><a class="code" href="classScoreLayout.html#a0">00051</a> <a class="code" href="classScoreLayout.html#a0">ScoreLayout::ScoreLayout</a>()
00052       {
00053       <a class="code" href="classScoreLayout.html#o0">_spatium</a>   = ::_spatium; <span class="comment">// 2 * DPMM;</span>
00054       <a class="code" href="classScoreLayout.html#o1">pageFormat</a> = <span class="keyword">new</span> <a class="code" href="structPageFormat.html">PageFormat</a>;
00055       }
00056 
<a name="l00057"></a><a class="code" href="classScoreLayout.html#a1">00057</a> <a class="code" href="classScoreLayout.html#a1">ScoreLayout::~ScoreLayout</a>()
00058       {
00059       <span class="keyword">delete</span> <a class="code" href="classScoreLayout.html#o1">pageFormat</a>;
00060       }
00061 
00062 <span class="comment">//---------------------------------------------------------</span>
00063 <span class="comment">//   push_back</span>
00064 <span class="comment">//---------------------------------------------------------</span>
00065 
<a name="l00066"></a><a class="code" href="classElemList.html#a4">00066</a> <span class="keywordtype">void</span> <a class="code" href="classElemList.html#a4">ElemList::push_back</a>(<a class="code" href="classElement.html">Element</a>* e)
00067       {
00068       ++<a class="code" href="classElemList.html#r0">_size</a>;
00069       <span class="keywordflow">if</span> (<a class="code" href="classElemList.html#r2">_last</a>) {
00070             <a class="code" href="classElemList.html#r2">_last</a>-&gt;<a class="code" href="classElement.html#a7">setNext</a>(e);
00071             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(<a class="code" href="classElemList.html#r2">_last</a>);
00072             e-&gt;<a class="code" href="classElement.html#a7">setNext</a>(0);
00073             }
00074       <span class="keywordflow">else</span> {
00075             <a class="code" href="classElemList.html#r1">_first</a> = e;
00076             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(0);
00077             e-&gt;setNext(0);
00078             }
00079       <a class="code" href="classElemList.html#r2">_last</a> = e;
00080       }
00081 
00082 <span class="comment">//---------------------------------------------------------</span>
00083 <span class="comment">//   push_front</span>
00084 <span class="comment">//---------------------------------------------------------</span>
00085 
<a name="l00086"></a><a class="code" href="classElemList.html#a5">00086</a> <span class="keywordtype">void</span> <a class="code" href="classElemList.html#a5">ElemList::push_front</a>(<a class="code" href="classElement.html">Element</a>* e)
00087       {
00088       ++<a class="code" href="classElemList.html#r0">_size</a>;
00089       <span class="keywordflow">if</span> (<a class="code" href="classElemList.html#r1">_first</a>) {
00090             <a class="code" href="classElemList.html#r1">_first</a>-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(e);
00091             e-&gt;<a class="code" href="classElement.html#a7">setNext</a>(<a class="code" href="classElemList.html#r1">_first</a>);
00092             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(0);
00093             }
00094       <span class="keywordflow">else</span> {
00095             <a class="code" href="classElemList.html#r2">_last</a> = e;
00096             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(0);
00097             e-&gt;setNext(0);
00098             }
00099       <a class="code" href="classElemList.html#r1">_first</a> = e;
00100       }
00101 
00102 <span class="comment">//---------------------------------------------------------</span>
00103 <span class="comment">//   insert</span>
00104 <span class="comment">//---------------------------------------------------------</span>
00105 
<a name="l00106"></a><a class="code" href="classElemList.html#a6">00106</a> <span class="keywordtype">void</span> <a class="code" href="classElemList.html#a6">ElemList::insert</a>(<a class="code" href="classElement.html">Element</a>* e, <a class="code" href="classElement.html">Element</a>* el)
00107       {
00108       <span class="keywordflow">if</span> (el == 0) {
00109             <a class="code" href="classElemList.html#a4">push_back</a>(e);
00110             <span class="keywordflow">return</span>;
00111             }
00112       <span class="keywordflow">if</span> (el == <a class="code" href="classElemList.html#r1">_first</a>) {
00113             <a class="code" href="classElemList.html#a5">push_front</a>(e);
00114             <span class="keywordflow">return</span>;
00115             }
00116       ++<a class="code" href="classElemList.html#r0">_size</a>;
00117       e-&gt;<a class="code" href="classElement.html#a7">setNext</a>(el);
00118       e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(el-&gt;<a class="code" href="classElement.html#a8">prev</a>());
00119       el-&gt;<a class="code" href="classElement.html#a8">prev</a>()-&gt;<a class="code" href="classElement.html#a7">setNext</a>(e);
00120       el-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(e);
00121       }
00122 
00123 <span class="comment">//---------------------------------------------------------</span>
00124 <span class="comment">//   erase</span>
00125 <span class="comment">//---------------------------------------------------------</span>
00126 
<a name="l00127"></a><a class="code" href="classElemList.html#a7">00127</a> <span class="keywordtype">void</span> <a class="code" href="classElemList.html#a7">ElemList::erase</a>(<a class="code" href="classElement.html">Element</a>* el)
00128       {
00129       --<a class="code" href="classElemList.html#r0">_size</a>;
00130       <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a8">prev</a>())
00131             el-&gt;<a class="code" href="classElement.html#a8">prev</a>()-&gt;<a class="code" href="classElement.html#a7">setNext</a>(el-&gt;<a class="code" href="classElement.html#a6">next</a>());
00132       <span class="keywordflow">else</span> {
00133             <a class="code" href="classElemList.html#r1">_first</a> = el-&gt;<a class="code" href="classElement.html#a6">next</a>();
00134             }
00135       <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a6">next</a>())
00136             el-&gt;<a class="code" href="classElement.html#a6">next</a>()-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(el-&gt;<a class="code" href="classElement.html#a8">prev</a>());
00137       <span class="keywordflow">else</span>
00138             <a class="code" href="classElemList.html#r2">_last</a> = el-&gt;<a class="code" href="classElement.html#a8">prev</a>();
00139       }
00140 
00141 <span class="comment">//---------------------------------------------------------</span>
00142 <span class="comment">//   Score</span>
00143 <span class="comment">//---------------------------------------------------------</span>
00144 
<a name="l00145"></a><a class="code" href="classScore.html#a0">00145</a> <a class="code" href="classScore.html#a0">Score::Score</a>()
00146    :printer(QPrinter::HighResolution)
00147       {
00148       <a class="code" href="classScore.html#r2">_needLayout</a>       = <span class="keyword">false</span>;
00149       <a class="code" href="classScore.html#o13">systems</a>           = <span class="keyword">new</span> <a class="code" href="classSystemList.html">SystemList</a>;
00150       <a class="code" href="classScore.html#o12">pages</a>             = <span class="keyword">new</span> <a class="code" href="classPageList.html">PageList</a>;
00151       <a class="code" href="classScore.html#o11">tempomap</a>          = <span class="keyword">new</span> <a class="code" href="classTempoList.html">TempoList</a>;
00152       <a class="code" href="classScore.html#o9">sigmap</a>            = <span class="keyword">new</span> <a class="code" href="classSigList.html">SigList</a>;
00153       <a class="code" href="classScore.html#o10">keymap</a>            = <span class="keyword">new</span> <a class="code" href="classKeyList.html">KeyList</a>;
00154       <a class="code" href="classScore.html#o14">sel</a>               = <span class="keyword">new</span> <a class="code" href="classSelection.html">Selection</a>;
00155       <a class="code" href="classScore.html#r17">_staves</a>           = <span class="keyword">new</span> <a class="code" href="classStaffList.html">StaffList</a>;
00156       <a class="code" href="classScore.html#r16">_parts</a>            = <span class="keyword">new</span> <a class="code" href="classPartList.html">PartList</a>;
00157       <a class="code" href="classScore.html#o2">dirty</a>             = <span class="keyword">false</span>;
00158       <a class="code" href="classScore.html#o4">newScore</a>          = <span class="keyword">true</span>;
00159       <a class="code" href="classScore.html#o1">projectName</a>       = <span class="stringliteral">""</span>;
00160       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a>        = <a class="code" href="select_8h.html#a5a0">SEL_NONE</a>;
00161       <a class="code" href="classScore.html#o16">editObject</a>        = 0;
00162       <a class="code" href="classScore.html#r11">origDragObject</a>    = 0;
00163       <a class="code" href="classScore.html#r12">_dragObject</a>       = 0;
00164       <a class="code" href="input_8h.html#a0">cis</a>               = &amp;<a class="code" href="project_8cpp.html#a0">inputState</a>;
00165       <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a>          = -1;
00166       <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>        = 0;
00167       <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o2">voice</a>        = 0;
00168       <a class="code" href="classScore.html#r4">keyState</a>          = 0;
00169       <a class="code" href="classScore.html#r10">editTempo</a>         = 0;
00170       <a class="code" href="classScore.html#r3">updateAll</a>         = <span class="keyword">false</span>;
00171       <a class="code" href="classScore.html#o0">textList</a>          = 0;
00172       <a class="code" href="classScore.html#o8">_pageOffset</a>       = 0;
00173       <a class="code" href="classScore.html#r20">undoActive</a>        = <span class="keyword">false</span>;
00174       }
00175 
00176 <span class="comment">//---------------------------------------------------------</span>
00177 <span class="comment">//   ~Score</span>
00178 <span class="comment">//---------------------------------------------------------</span>
00179 
<a name="l00180"></a><a class="code" href="classScore.html#a1">00180</a> <a class="code" href="classScore.html#a1">Score::~Score</a>()
00181       {
00182       <span class="keyword">delete</span> <a class="code" href="classScore.html#o13">systems</a>;
00183       <span class="keyword">delete</span> <a class="code" href="classScore.html#o12">pages</a>;
00184       <span class="keyword">delete</span> <a class="code" href="classScore.html#o11">tempomap</a>;
00185       <span class="keyword">delete</span> <a class="code" href="classScore.html#o9">sigmap</a>;
00186       <span class="keyword">delete</span> <a class="code" href="classScore.html#o10">keymap</a>;
00187       <span class="keyword">delete</span> <a class="code" href="classScore.html#o14">sel</a>;
00188       <span class="keyword">delete</span> <a class="code" href="classScore.html#r17">_staves</a>;
00189       <span class="keyword">delete</span> <a class="code" href="classScore.html#r16">_parts</a>;
00190       }
00191 
00192 <span class="comment">//---------------------------------------------------------</span>
00193 <span class="comment">//   addViewer</span>
00194 <span class="comment">//---------------------------------------------------------</span>
00195 
<a name="l00196"></a><a class="code" href="classScore.html#a29">00196</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a29">Score::addViewer</a>(<a class="code" href="classViewer.html">Viewer</a>* v)
00197       {
00198       <a class="code" href="classScore.html#r5">viewer</a>.push_back(v);
00199       }
00200 <span class="comment">//---------------------------------------------------------</span>
00201 <span class="comment">//   clearViewer</span>
00202 <span class="comment">//---------------------------------------------------------</span>
00203 
<a name="l00204"></a><a class="code" href="classScore.html#a30">00204</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a30">Score::clearViewer</a>()
00205       {
00206       <a class="code" href="classScore.html#r5">viewer</a>.clear();
00207       }
00208 
00209 <span class="comment">//---------------------------------------------------------</span>
00210 <span class="comment">//   moveCursor</span>
00211 <span class="comment">//---------------------------------------------------------</span>
00212 
<a name="l00213"></a><a class="code" href="classScore.html#d8">00213</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#d8">Score::moveCursor</a>()
00214       {
00215       <span class="keywordflow">for</span> (std::list&lt;Viewer*&gt;::iterator i = <a class="code" href="classScore.html#r5">viewer</a>.begin(); i != <a class="code" href="classScore.html#r5">viewer</a>.end(); ++i)
00216             <a class="code" href="classScore.html#r1">refresh</a> |= (*i)-&gt;moveCursor();
00217       }
00218 
00219 <span class="comment">//---------------------------------------------------------</span>
00220 <span class="comment">//   canvas</span>
00221 <span class="comment">//---------------------------------------------------------</span>
00222 
<a name="l00223"></a><a class="code" href="classScore.html#a46">00223</a> <a class="code" href="classCanvas.html">Canvas</a>* <a class="code" href="classScore.html#a46">Score::canvas</a>()<span class="keyword"> const</span>
00224 <span class="keyword">      </span>{
00225       <span class="keywordflow">return</span>  <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a1">getCanvas</a>();
00226       }
00227 
00228 <span class="comment">//---------------------------------------------------------</span>
00229 <span class="comment">//   clear</span>
00230 <span class="comment">//---------------------------------------------------------</span>
00231 
<a name="l00232"></a><a class="code" href="classScore.html#a2">00232</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a2">Score::clear</a>()
00233       {
00234       <a class="code" href="classScore.html#o1">projectName</a>     = <span class="stringliteral">""</span>;
00235       <a class="code" href="classScore.html#o2">dirty</a>           = <span class="keyword">false</span>;
00236       <a class="code" href="classScore.html#o7">rights</a>          = <span class="stringliteral">""</span>;
00237       <a class="code" href="classScore.html#o5">movementNumber</a>  = <span class="stringliteral">""</span>;
00238       <a class="code" href="classScore.html#o6">movementTitle</a>   = <span class="stringliteral">""</span>;
00239       <a class="code" href="classScore.html#o8">_pageOffset</a>     = 0;
00240 
00241       <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> i = <a class="code" href="classScore.html#r17">_staves</a>-&gt;begin(); i != <a class="code" href="classScore.html#r17">_staves</a>-&gt;end(); ++i)
00242             <span class="keyword">delete</span> *i;
00243       <a class="code" href="classScore.html#r17">_staves</a>-&gt;clear();
00244       <a class="code" href="classScore.html#r15">_measures</a>.<a class="code" href="classElemList.html#a3">clear</a>();
00245       <span class="keywordflow">for</span> (<a class="code" href="part_8h.html#a0">iPart</a> i = <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00246             <span class="keyword">delete</span> *i;
00247       <a class="code" href="classScore.html#r16">_parts</a>-&gt;clear();
00248 
00249       <a class="code" href="classScore.html#o9">sigmap</a>-&gt;clear();
00250       <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a1">add</a>(0, 4, 4);
00251       <a class="code" href="classScore.html#o10">keymap</a>-&gt;clear();
00252       (*keymap)[0] = 0;
00253       <a class="code" href="classScore.html#o11">tempomap</a>-&gt;<a class="code" href="classTempoList.html#a1">clear</a>();
00254       <a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00255       <a class="code" href="classScore.html#o12">pages</a>-&gt;clear();
00256       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a5">clear</a>();
00257       <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;setCaption(<span class="stringliteral">"MuseScore"</span>);
00258       <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a13">invalidatePlaylist</a>();
00259       }
00260 
00261 <span class="comment">//---------------------------------------------------------</span>
00262 <span class="comment">//   write</span>
00263 <span class="comment">//---------------------------------------------------------</span>
00264 
<a name="l00265"></a><a class="code" href="classScore.html#a3">00265</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a3">Score::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)
00266       {
00267       <a class="code" href="classScore.html#a135">pageFormat</a>()-&gt;<a class="code" href="structPageFormat.html#a5">write</a>(xml);
00268       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#o7">rights</a>.isEmpty())
00269             xml.<a class="code" href="classXml.html#a16">strTag</a>(<span class="stringliteral">"rights"</span>, <a class="code" href="classScore.html#o7">rights</a>);
00270       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#o5">movementNumber</a>.isEmpty())
00271             xml.<a class="code" href="classXml.html#a16">strTag</a>(<span class="stringliteral">"movement-number"</span>, <a class="code" href="classScore.html#o5">movementNumber</a>);
00272       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#o6">movementTitle</a>.isEmpty())
00273             xml.<a class="code" href="classXml.html#a16">strTag</a>(<span class="stringliteral">"movement-title"</span>, <a class="code" href="classScore.html#o6">movementTitle</a>);
00274 
00275       <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a5">write</a>(xml);
00276       <a class="code" href="classScore.html#o10">keymap</a>-&gt;<a class="code" href="classKeyList.html#a4">write</a>(xml, <span class="stringliteral">"keylist"</span>);
00277       <a class="code" href="classScore.html#o11">tempomap</a>-&gt;<a class="code" href="classTempoList.html#a3">write</a>(xml);
00278       <span class="keywordflow">for</span> (<a class="code" href="part_8h.html#a0">iPart</a> i = <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00279             (*i)-&gt;write(xml);
00280 
00281       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = 0;
00282       <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> ip = <a class="code" href="classScore.html#r17">_staves</a>-&gt;begin(); ip != <a class="code" href="classScore.html#r17">_staves</a>-&gt;end(); ++ip, ++staff) {
00283             xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Staff id=\"%d\""</span>, staff+1);
00284             <span class="keywordtype">int</span> measureNumber = 1;
00285             <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>())
00286                   m-&gt;<a class="code" href="classMeasure.html#a6">write</a>(xml, measureNumber++, staff);
00287             xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Staff"</span>);
00288             }
00289       }
00290 
00291 <span class="comment">//---------------------------------------------------------</span>
00292 <span class="comment">//   instrument</span>
00293 <span class="comment">//---------------------------------------------------------</span>
00294 
<a name="l00295"></a><a class="code" href="classScore.html#a17">00295</a> <a class="code" href="classPart.html">Part</a>* <a class="code" href="classScore.html#a17">Score::part</a>(<span class="keywordtype">int</span> n)
00296       {
00297       <span class="keywordtype">int</span> idx = 0;
00298       <span class="keywordflow">for</span> (<a class="code" href="part_8h.html#a0">iPart</a> i = <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00299             idx += (*i)-&gt;nstaves();
00300             <span class="keywordflow">if</span> (n &lt; idx)
00301                   <span class="keywordflow">return</span> *i;
00302             }
00303       <span class="keywordflow">return</span> 0;
00304       }
00305 
00306 <span class="comment">//---------------------------------------------------------</span>
00307 <span class="comment">//   addMeasure</span>
00308 <span class="comment">//---------------------------------------------------------</span>
00309 
<a name="l00310"></a><a class="code" href="classScore.html#a18">00310</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a18">Score::addMeasure</a>(<a class="code" href="classMeasure.html">Measure</a>* m)
00311       {
00312       <span class="keywordtype">int</span> tick = m-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00313       <a class="code" href="classMeasure.html">Measure</a>* im;
00314       <span class="keywordflow">for</span> (im = <a class="code" href="classScore.html#a100">first</a>(); im; im = im-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00315             <span class="keywordtype">int</span> mtick = im-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00316             <span class="keywordflow">if</span> (mtick == tick)
00317                   <span class="keywordflow">break</span>;
00318             }
00319       <span class="keywordflow">if</span> (im) {
00320             <span class="keywordtype">int</span> mtick = im-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00321             <span class="keywordtype">int</span> len   = im-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>();
00322             <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a11">insertTime</a>(mtick, len);
00323             <a class="code" href="classScore.html#o10">keymap</a>-&gt;<a class="code" href="classKeyList.html#a6">insertTime</a>(mtick, len);
00324             <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> i = <a class="code" href="classScore.html#r17">_staves</a>-&gt;begin(); i != <a class="code" href="classScore.html#r17">_staves</a>-&gt;end(); ++i)
00325                   (*i)-&gt;clef()-&gt;insertTime(mtick, len);
00326             }
00327       <a class="code" href="classScore.html#r15">_measures</a>.<a class="code" href="classElemList.html#a6">insert</a>(im, m);
00328       <a class="code" href="classScore.html#a131">fixTicks</a>();
00329       }
00330 
00331 <span class="comment">//---------------------------------------------------------</span>
00332 <span class="comment">//   removeMeasure</span>
00333 <span class="comment">//---------------------------------------------------------</span>
00334 
<a name="l00335"></a><a class="code" href="classScore.html#a19">00335</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a19">Score::removeMeasure</a>(<span class="keywordtype">int</span> tick)
00336       {
00337       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* im = <a class="code" href="classScore.html#a100">first</a>(); im; im = im-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00338             <span class="keywordtype">int</span> mtick = im-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00339             <span class="keywordflow">if</span> (mtick == tick) {
00340                   <span class="keywordtype">int</span> len = im-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>();
00341                   <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a10">removeTime</a>(mtick, len);
00342                   <a class="code" href="classScore.html#o10">keymap</a>-&gt;<a class="code" href="classKeyList.html#a5">removeTime</a>(mtick, len);
00343                   <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> i = <a class="code" href="classScore.html#r17">_staves</a>-&gt;begin(); i != <a class="code" href="classScore.html#r17">_staves</a>-&gt;end(); ++i)
00344                         (*i)-&gt;clef()-&gt;removeTime(mtick, len);
00345                   <a class="code" href="classScore.html#r15">_measures</a>.<a class="code" href="classElemList.html#a7">erase</a>(im);
00346                   <a class="code" href="classScore.html#a131">fixTicks</a>();
00347                   <span class="keywordflow">return</span>;
00348                   }
00349             }
00350       printf(<span class="stringliteral">"no measure found at tick %d\n"</span>, tick);
00351       }
00352 
00353 <span class="comment">//---------------------------------------------------------</span>
00354 <span class="comment">//   fixTicks</span>
00355 <span class="comment">//    Recalculate all ticks and measure numbers.</span>
00356 <span class="comment">//    This is needed after inserting or removing a</span>
00357 <span class="comment">//    measure.</span>
00358 <span class="comment">//---------------------------------------------------------</span>
00359 
<a name="l00360"></a><a class="code" href="classScore.html#a131">00360</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a131">Score::fixTicks</a>()
00361       {
00362       <span class="keywordtype">int</span> bar  = 0;
00363       <span class="keywordtype">int</span> tick = 0;
00364       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00365             <span class="keywordflow">if</span> (m-&gt;<a class="code" href="classMeasure.html#a15">no</a>() != bar) {
00366                   m-&gt;<a class="code" href="classMeasure.html#a21">setNo</a>(bar);
00367                   <span class="keywordflow">if</span> (::style-&gt;showMeasureNumber) {
00368                         m-&gt;<a class="code" href="classMeasure.html#a20">setNoText</a>(<span class="stringliteral">""</span>);
00369                         <span class="keywordflow">if</span> (bar != 0 || ::style-&gt;showMeasureNumberOne) {
00370                               <span class="keywordflow">if</span> (::style-&gt;measureNumberSystem
00371                                  &amp;&amp; (((bar+1) % ::style-&gt;measureNumberInterval) == 0)) {
00372                                     QString s(<span class="stringliteral">"%1"</span>);
00373                                     s.arg(bar+1);
00374                                     m-&gt;<a class="code" href="classMeasure.html#a20">setNoText</a>(s);
00375                                     }
00376                               }
00377                         }
00378                   }
00379             <span class="keywordflow">if</span> (!m-&gt;<a class="code" href="classMeasure.html#a16">irregular</a>())
00380                   ++bar;
00381             <span class="keywordtype">int</span> mtick = m-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00382             <span class="keywordtype">int</span> diff = tick - mtick;
00383             tick += <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a9">ticksMeasure</a>(tick);
00384             <span class="keywordflow">if</span> (diff == 0)
00385                   <span class="keywordflow">continue</span>;
00386             m-&gt;<a class="code" href="classMeasure.html#a60">moveTicks</a>(diff);
00387             }
00388       }
00389 
00390 <span class="comment">//---------------------------------------------------------</span>
00391 <span class="comment">//   pos2measure</span>
00392 <span class="comment">//    p - canvas relative position</span>
00393 <span class="comment">//    if *rst != 0, then staff is fixed</span>
00394 <span class="comment">//---------------------------------------------------------</span>
00395 
<a name="l00396"></a><a class="code" href="classScore.html#a21">00396</a> <a class="code" href="classMeasure.html">Measure</a>* <a class="code" href="classScore.html#a21">Score::pos2measure</a>(<span class="keyword">const</span> QPointF&amp; p, <span class="keywordtype">int</span>* tick, <a class="code" href="classStaff.html">Staff</a>** rst, <span class="keywordtype">int</span>* pitch,
00397    <a class="code" href="classSegment.html">Segment</a>** seg, QPointF* offset)<span class="keyword"> const</span>
00398 <span class="keyword">      </span>{
00399       <span class="keywordtype">int</span> voice = <a class="code" href="canvas_8cpp.html#a0">padState</a>.<a class="code" href="structPadState.html#o5">voice</a>;
00400 
00401       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a1">ciPage</a> ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
00402             <span class="keyword">const</span> <a class="code" href="classPage.html">Page</a>* page = *ip;
00403             <span class="keywordflow">if</span> (!page-&gt;<a class="code" href="classElement.html#a30">contains</a>(p))
00404                   <span class="keywordflow">continue</span>;
00405             QPointF pp = p - page-&gt;<a class="code" href="classElement.html#a20">pos</a>();  <span class="comment">// transform to page relative</span>
00406 
00407             <a class="code" href="classSystemList.html">SystemList</a>* sl = page-&gt;<a class="code" href="classPage.html#a4">systems</a>();
00408             <span class="keywordtype">double</span> y1 = 0;
00409             <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciSystem</a> is = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); is != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>();) {
00410                   <span class="keywordtype">double</span> y2;
00411                   <a class="code" href="classSystem.html">System</a>* s = *is;
00412                   ++is;
00413                   <span class="keywordflow">if</span> (is != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00414                         <span class="keywordtype">double</span> sy2 = s-&gt;<a class="code" href="classElement.html#a22">y</a>() + s-&gt;<a class="code" href="classElement.html#a33">bbox</a>().height();
00415                         y2 = sy2 + ((*is)-&gt;y() - sy2)/2;
00416                         }
00417                   <span class="keywordflow">else</span>
00418                         y2 = page-&gt;<a class="code" href="classElement.html#a36">height</a>();
00419                   <span class="keywordflow">if</span> (pp.y() &gt; y2) {
00420                         y1 = y2;
00421                         <span class="keywordflow">continue</span>;
00422                         }
00423                   QPointF ppp = pp - s-&gt;<a class="code" href="classElement.html#a20">pos</a>();   <span class="comment">// system relative</span>
00424                   <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a11">ciMeasure</a> im = s-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); im != s-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++im) {
00425                         <a class="code" href="classMeasure.html">Measure</a>* m = *im;
00426                         <span class="keywordflow">if</span> (ppp.x() &gt; (m-&gt;<a class="code" href="classElement.html#a21">x</a>() + m-&gt;<a class="code" href="classElement.html#a33">bbox</a>().width()))
00427                               <span class="keywordflow">continue</span>;
00428                         <span class="keywordtype">double</span> sy1 = 0;
00429                         <span class="keywordflow">if</span> (rst &amp;&amp; *rst == 0) {
00430                               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classScore.html#a6">nstaves</a>();) {
00431                                     <span class="keywordtype">double</span> sy2;
00432 
00433                                     <a class="code" href="classSysStaff.html">SysStaff</a>* <a class="code" href="classScore.html#a7">staff</a> = s-&gt;<a class="code" href="classSystem.html#a13">staff</a>(i);
00434                                     ++i;
00435                                     <span class="keywordflow">if</span> (i != <a class="code" href="classScore.html#a6">nstaves</a>()) {
00436                                           <a class="code" href="classSysStaff.html">SysStaff</a>* nstaff = s-&gt;<a class="code" href="classSystem.html#a13">staff</a>(i);
00437                                           <span class="keywordtype">double</span> s1y2 = staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y() + staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().height();
00438                                           sy2 = s1y2 + (nstaff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y() - s1y2)/2;
00439                                           }
00440                                     <span class="keywordflow">else</span>
00441                                           sy2 = y2 - s-&gt;<a class="code" href="classElement.html#a20">pos</a>().y();   <span class="comment">// s-&gt;height();</span>
00442                                     <span class="keywordflow">if</span> (ppp.y() &gt; sy2) {
00443                                           sy1 = sy2;
00444                                           <span class="keywordflow">continue</span>;
00445                                           }
00446                                     <span class="comment">// search for segment + offset</span>
00447                                     QPointF pppp = ppp - m-&gt;<a class="code" href="classElement.html#a20">pos</a>();
00448                                     <span class="keywordtype">int</span> track = (i-1) * <a class="code" href="globals_8h.html#a3">VOICES</a> + voice;
00449                                     <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00450                                           <span class="keywordflow">if</span> (segment-&gt;<a class="code" href="classSegment.html#a18">type</a>() != Segment::SegChordRest || segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track) == 0) {
00451                                                 segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>();
00452                                                 <span class="keywordflow">continue</span>;
00453                                                 }
00454                                           <a class="code" href="classSegment.html">Segment</a>* ns = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>();
00455                                           <span class="keywordflow">for</span> (; ns; ns = ns-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00456                                                 <span class="keywordflow">if</span> (ns-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest &amp;&amp; ns-&gt;<a class="code" href="classSegment.html#a8">element</a>(track))
00457                                                       <span class="keywordflow">break</span>;
00458                                                 }
00459                                           <span class="keywordflow">if</span> (!ns || (pppp.x() &lt; (segment-&gt;<a class="code" href="classSegment.html#a15">x</a>() + (ns-&gt;<a class="code" href="classSegment.html#a15">x</a>() - segment-&gt;<a class="code" href="classSegment.html#a15">x</a>())/2.0))) {
00460                                                 i -= 1;
00461                                                 <span class="keywordflow">if</span> (rst)
00462                                                       *rst = (*_staves)[i];
00463                                                 <span class="keywordflow">if</span> (tick)
00464                                                       *tick = segment-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00465                                                 <span class="keywordflow">if</span> (pitch)
00466                                                       *pitch = <a class="code" href="classScore.html#a23">y2pitch</a>(pppp.y()-staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y(), (*_staves)[i], *tick);
00467                                                 <span class="keywordflow">if</span> (offset)
00468                                                       *offset = pppp - QPointF(segment-&gt;<a class="code" href="classSegment.html#a15">x</a>(), staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y());
00469                                                 <span class="keywordflow">if</span> (seg)
00470                                                       *seg = segment;
00471                                                 <span class="keywordflow">return</span> m;
00472                                                 }
00473                                           }
00474                                     <span class="keywordflow">break</span>;
00475                                     }
00476                               }
00477                         <span class="keywordflow">else</span> {
00478                               <span class="comment">// search for segment + offset</span>
00479                               QPointF pppp = ppp - m-&gt;<a class="code" href="classElement.html#a20">pos</a>();
00480                               <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00481                                     <span class="keywordflow">if</span> (segment-&gt;<a class="code" href="classSegment.html#a18">type</a>() != Segment::SegChordRest)
00482                                           <span class="keywordflow">continue</span>;
00483                                     <span class="keywordtype">bool</span> found = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>() == 0;
00484                                     <span class="keywordflow">if</span> (!found) {
00485                                           <span class="keywordtype">double</span> x1 = segment-&gt;<a class="code" href="classSegment.html#a15">x</a>();
00486                                           <span class="keywordtype">double</span> x2 = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()-&gt;<a class="code" href="classSegment.html#a15">x</a>();
00487                                           found = pppp.x() &lt; (x1 + (x2 - x1) / 2);
00488                                           }
00489                                     <span class="keywordflow">if</span> (!found)
00490                                           <span class="keywordflow">continue</span>;
00491                                     <span class="keywordflow">if</span> (tick)
00492                                           *tick = segment-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00493                                     <span class="keywordflow">if</span> (pitch)
00494                                           *pitch = <a class="code" href="classScore.html#a23">y2pitch</a>(pppp.y(), *rst, *tick);
00495                                     <span class="keywordflow">if</span> (offset) {
00496                                           <span class="comment">//??</span>
00497                                           <span class="keywordtype">int</span> staffIdx = <a class="code" href="classScore.html#r17">_staves</a>-&gt;<a class="code" href="classStaffList.html#a1">idx</a>(*rst);
00498                                           <a class="code" href="classSysStaff.html">SysStaff</a>* <a class="code" href="classScore.html#a7">staff</a> = s-&gt;<a class="code" href="classSystem.html#a13">staff</a>(staffIdx);
00499                                           *offset = pppp - QPointF(segment-&gt;<a class="code" href="classSegment.html#a15">x</a>(), staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y());
00500                                           }
00501                                     <span class="keywordflow">if</span> (seg)
00502                                           *seg = segment;
00503                                     <span class="keywordflow">return</span> m;
00504                                     }
00505                               <span class="keywordflow">break</span>;
00506                               }
00507                         }
00508                   }
00509             }
00510       <span class="keywordflow">return</span> 0;
00511       }
00512 
00513 <span class="comment">//---------------------------------------------------------</span>
00514 <span class="comment">//   pos2measure2</span>
00515 <span class="comment">//    p - canvas relative position</span>
00516 <span class="comment">//---------------------------------------------------------</span>
00517 
<a name="l00518"></a><a class="code" href="classScore.html#a22">00518</a> <a class="code" href="classMeasure.html">Measure</a>* <a class="code" href="classScore.html#a22">Score::pos2measure2</a>(<span class="keyword">const</span> QPointF&amp; p, <span class="keywordtype">int</span>* tick, <a class="code" href="classStaff.html">Staff</a>** rst, <span class="keywordtype">int</span>* line,
00519    <a class="code" href="classSegment.html">Segment</a>** seg)<span class="keyword"> const</span>
00520 <span class="keyword">      </span>{
00521       <span class="keywordtype">int</span> voice = <a class="code" href="canvas_8cpp.html#a0">padState</a>.<a class="code" href="structPadState.html#o5">voice</a>;
00522 
00523       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a1">ciPage</a> ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
00524             <span class="keyword">const</span> <a class="code" href="classPage.html">Page</a>* page = *ip;
00525             <span class="keywordflow">if</span> (!page-&gt;<a class="code" href="classElement.html#a30">contains</a>(p))
00526                   <span class="keywordflow">continue</span>;
00527             QPointF pp = p - page-&gt;<a class="code" href="classElement.html#a20">pos</a>();  <span class="comment">// transform to page relative</span>
00528 
00529             <a class="code" href="classSystemList.html">SystemList</a>* sl = page-&gt;<a class="code" href="classPage.html#a4">systems</a>();
00530             <span class="keywordtype">double</span> y1 = 0;
00531             <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciSystem</a> is = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); is != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>();) {
00532                   <span class="keywordtype">double</span> y2;
00533                   <a class="code" href="classSystem.html">System</a>* s = *is;
00534                   ++is;
00535                   <span class="keywordflow">if</span> (is != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00536                         <span class="keywordtype">double</span> sy2 = s-&gt;<a class="code" href="classElement.html#a22">y</a>() + s-&gt;<a class="code" href="classElement.html#a33">bbox</a>().height();
00537                         y2 = sy2 + ((*is)-&gt;y() - sy2)/2;
00538                         }
00539                   <span class="keywordflow">else</span>
00540                         y2 = page-&gt;<a class="code" href="classElement.html#a36">height</a>();
00541                   <span class="keywordflow">if</span> (pp.y() &gt; y2) {
00542                         y1 = y2;
00543                         <span class="keywordflow">continue</span>;
00544                         }
00545                   QPointF ppp = pp - s-&gt;<a class="code" href="classElement.html#a20">pos</a>();   <span class="comment">// system relative</span>
00546                   <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a11">ciMeasure</a> im = s-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); im != s-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++im) {
00547                         <a class="code" href="classMeasure.html">Measure</a>* m = *im;
00548                         <span class="keywordflow">if</span> (ppp.x() &gt; (m-&gt;<a class="code" href="classElement.html#a21">x</a>() + m-&gt;<a class="code" href="classElement.html#a33">bbox</a>().width()))
00549                               <span class="keywordflow">continue</span>;
00550                         <span class="keywordtype">double</span> sy1 = 0;
00551                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classScore.html#a6">nstaves</a>();) {
00552                               <span class="keywordtype">double</span> sy2;
00553 
00554                               <a class="code" href="classSysStaff.html">SysStaff</a>* <a class="code" href="classScore.html#a7">staff</a> = s-&gt;<a class="code" href="classSystem.html#a13">staff</a>(i);
00555                               ++i;
00556                               <span class="keywordflow">if</span> (i != <a class="code" href="classScore.html#a6">nstaves</a>()) {
00557                                     <a class="code" href="classSysStaff.html">SysStaff</a>* nstaff = s-&gt;<a class="code" href="classSystem.html#a13">staff</a>(i);
00558                                     <span class="keywordtype">double</span> s1y2 = staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y() + staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().height();
00559                                     sy2 = s1y2 + (nstaff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y() - s1y2)/2;
00560                                     }
00561                               <span class="keywordflow">else</span>
00562                                     sy2 = y2 - s-&gt;<a class="code" href="classElement.html#a20">pos</a>().y();   <span class="comment">// s-&gt;height();</span>
00563                               <span class="keywordflow">if</span> (ppp.y() &gt; sy2) {
00564                                     sy1 = sy2;
00565                                     <span class="keywordflow">continue</span>;
00566                                     }
00567                               <span class="comment">// search for segment + offset</span>
00568                               QPointF pppp = ppp - m-&gt;<a class="code" href="classElement.html#a20">pos</a>();
00569                               <span class="keywordtype">int</span> track = (i-1) * <a class="code" href="globals_8h.html#a3">VOICES</a> + voice;
00570                               <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment;) {
00571                                     <span class="keywordflow">if</span> (segment-&gt;<a class="code" href="classSegment.html#a18">type</a>() != Segment::SegChordRest || segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track) == 0) {
00572                                           segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>();
00573                                           <span class="keywordflow">continue</span>;
00574                                           }
00575                                     <a class="code" href="classSegment.html">Segment</a>* ns = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>();
00576                                     <span class="keywordflow">for</span> (; ns; ns = ns-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00577                                           <span class="keywordflow">if</span> (ns-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest &amp;&amp; ns-&gt;<a class="code" href="classSegment.html#a8">element</a>(track))
00578                                                 <span class="keywordflow">break</span>;
00579                                           }
00580                                     <span class="keywordflow">if</span> (!ns || (pppp.x() &lt; (segment-&gt;<a class="code" href="classSegment.html#a15">x</a>() + (ns-&gt;<a class="code" href="classSegment.html#a15">x</a>() - segment-&gt;<a class="code" href="classSegment.html#a15">x</a>())/2.0))) {
00581                                           i     -= 1;
00582                                           *rst   = (*_staves)[i];
00583                                           *tick  = segment-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00584                                           *line  = lrint((pppp.y()-staff-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y())/<a class="code" href="spatium_8h.html#a0">_spatium</a> * 2);
00585                                           *seg   = segment;
00586                                           <span class="keywordflow">return</span> m;
00587                                           }
00588                                     segment = ns;
00589                                     }
00590                               <span class="keywordflow">break</span>;
00591                               }
00592                         }
00593                   }
00594             }
00595       <span class="keywordflow">return</span> 0;
00596       }
00597 
00598 <span class="comment">//---------------------------------------------------------</span>
00599 <span class="comment">//   pitchTable</span>
00600 <span class="comment">//---------------------------------------------------------</span>
00601 
<a name="l00602"></a><a class="code" href="project_8cpp.html#a9">00602</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="project_8cpp.html#a9">pitchTable</a>[] = {
00603       127,
00604       125,124, 122, 120, 119, 117, 115,
00605       113,112, 110, 108, 107, 105, 103,
00606       101,100,  98,  96, 95,  93,  91,
00607       89,  88,  86,  84, 83,  81,  79,
00608 
00609       77,  76,  74,  72, 71,  69,  67,
00610       65,  64,  62,  60, 59,  57,  55,
00611       53,  52,  50,  48, 47,  45,  43,
00612       41,  40,  38,  36, 35,  33,  31,
00613       29,  28,  26,  24, 23,  21,  19,
00614       17,  16,  14,  12, 11,  9,   7,
00615       5,   4,   2,   0
00616       };
00617 
<a name="l00618"></a><a class="code" href="project_8cpp.html#a10">00618</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="project_8cpp.html#a10">pitchTableSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="project_8cpp.html#a9">pitchTable</a>)/<span class="keyword">sizeof</span>(*pitchTable);
00619 
00620 <span class="comment">//---------------------------------------------------------</span>
00621 <span class="comment">//   y2pitch</span>
00622 <span class="comment">//---------------------------------------------------------</span>
00623 
<a name="l00624"></a><a class="code" href="classScore.html#a23">00624</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a23">Score::y2pitch</a>(<span class="keywordtype">double</span> y, <a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> tick)<span class="keyword"> const</span>
00625 <span class="keyword">      </span>{
00626       <span class="keywordtype">int</span> clefIdx = staff-&gt;<a class="code" href="classStaff.html#a2">clef</a>()-&gt;<a class="code" href="classClefList.html#a1">clef</a>(tick);
00627       <span class="keywordtype">int</span> offset  = <a class="code" href="clef_8h.html#a0">clefTable</a>[clefIdx].<a class="code" href="structClefInfo.html#o3">pitchOffset</a>;
00628 
00629       <span class="keywordtype">int</span> l = lrint(y / <a class="code" href="spatium_8h.html#a0">_spatium</a> * 2) + 29;
00630       <span class="keywordtype">int</span> pitch;
00631       <span class="keywordflow">if</span> (l &lt; 0)
00632             pitch = 127;
00633       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l &gt;= int(<a class="code" href="project_8cpp.html#a10">pitchTableSize</a>))
00634             pitch = 0;
00635       <span class="keywordflow">else</span>
00636             pitch = <a class="code" href="project_8cpp.html#a9">pitchTable</a>[l] + offset;
00637       <span class="keywordflow">if</span> (pitch &gt; 127)
00638             pitch = 127;
00639       <span class="keywordflow">if</span> (pitch &lt; 0)
00640             pitch = 0;
00641       <span class="keywordflow">return</span> pitch;
00642       }
00643 
00644 <span class="comment">//---------------------------------------------------------</span>
00645 <span class="comment">//   line2pitch</span>
00646 <span class="comment">//---------------------------------------------------------</span>
00647 
<a name="l00648"></a><a class="code" href="classScore.html#a24">00648</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a24">Score::line2pitch</a>(<span class="keywordtype">int</span> line, <span class="keywordtype">int</span> staffIdx, <span class="keywordtype">int</span> tick)<span class="keyword"> const</span>
00649 <span class="keyword">      </span>{
00650       <span class="keywordtype">int</span> clefIdx = <a class="code" href="classScore.html#a7">staff</a>(staffIdx)-&gt;clef()-&gt;clef(tick);
00651       <span class="keywordtype">int</span> offset  = <a class="code" href="clef_8h.html#a0">clefTable</a>[clefIdx].<a class="code" href="structClefInfo.html#o3">pitchOffset</a>;
00652 
00653       <span class="keywordtype">int</span> l = line + 29;
00654       <span class="keywordflow">if</span> (l &lt; 0)
00655             <span class="keywordflow">return</span> 127;
00656       <span class="keywordflow">if</span> (l &gt;= int(<a class="code" href="project_8cpp.html#a10">pitchTableSize</a>))
00657             <span class="keywordflow">return</span> 0;
00658       <span class="keywordflow">return</span> <a class="code" href="project_8cpp.html#a9">pitchTable</a>[l] + offset;
00659       }
00660 
00661 <span class="comment">//---------------------------------------------------------</span>
00662 <span class="comment">//   staff</span>
00663 <span class="comment">//---------------------------------------------------------</span>
00664 
<a name="l00665"></a><a class="code" href="classScore.html#a7">00665</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">Score::staff</a>(<span class="keyword">const</span> <a class="code" href="classPart.html">Part</a>* part)<span class="keyword"> const</span>
00666 <span class="keyword">      </span>{
00667       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = 0;
00668       <span class="keywordflow">for</span> (<a class="code" href="part_8h.html#a2">ciPart</a> i = <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00669             <span class="keywordflow">if</span> (*i == part)
00670                   <span class="keywordflow">break</span>;
00671             staff += (*i)-&gt;nstaves();
00672             }
00673       <span class="keywordflow">return</span> staff;
00674       }
00675 
00676 <span class="comment">//---------------------------------------------------------</span>
00677 <span class="comment">//   staff</span>
00678 <span class="comment">//---------------------------------------------------------</span>
00679 
<a name="l00680"></a><a class="code" href="classScore.html#a8">00680</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">Score::staff</a>(<span class="keyword">const</span> <a class="code" href="classStaff.html">Staff</a>* p)<span class="keyword"> const</span>
00681 <span class="keyword">      </span>{
00682       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = 0;
00683       <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a1">ciStaff</a> i = <a class="code" href="classScore.html#r17">_staves</a>-&gt;begin(); i != <a class="code" href="classScore.html#r17">_staves</a>-&gt;end(); ++i, ++staff) {
00684             <span class="keywordflow">if</span> (*i == p)
00685                   <span class="keywordflow">break</span>;
00686             }
00687       <span class="keywordflow">return</span> staff;
00688       }
00689 
00690 <span class="comment">//---------------------------------------------------------</span>
00691 <span class="comment">//   addPage</span>
00692 <span class="comment">//---------------------------------------------------------</span>
00693 
<a name="l00694"></a><a class="code" href="classScore.html#a25">00694</a> <a class="code" href="classPage.html">Page</a>* <a class="code" href="classScore.html#a25">Score::addPage</a>()
00695       {
00696       <a class="code" href="classPage.html">Page</a>* page = <span class="keyword">new</span> <a class="code" href="classPage.html">Page</a>(<span class="keyword">this</span>, <a class="code" href="classScore.html#o12">pages</a>-&gt;size());
00697       <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(page);
00698       <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classPageList.html#a1">update</a>(<span class="keyword">this</span>);
00699       <span class="keywordflow">return</span> page;
00700       }
00701 
00702 <span class="comment">//---------------------------------------------------------</span>
00703 <span class="comment">//   setInstrumentNames</span>
00704 <span class="comment">//---------------------------------------------------------</span>
00705 
<a name="l00706"></a><a class="code" href="classScore.html#a20">00706</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a20">Score::setInstrumentNames</a>()
00707       {
00708       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">iSystem</a> is = <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); is != <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++is)
00709             (*is)-&gt;setInstrumentNames();
00710       }
00711 
00712 <span class="comment">//---------------------------------------------------------</span>
00713 <span class="comment">//   part</span>
00714 <span class="comment">//---------------------------------------------------------</span>
00715 
<a name="l00716"></a><a class="code" href="classScore.html#a9">00716</a> <a class="code" href="classStaff.html">Staff</a>* <a class="code" href="classScore.html#a7">Score::staff</a>(<span class="keywordtype">int</span> n)<span class="keyword"> const</span>
00717 <span class="keyword">      </span>{
00718       <span class="keywordflow">if</span> (n &lt; int(<a class="code" href="classScore.html#r17">_staves</a>-&gt;size()))
00719             <span class="keywordflow">return</span> (*_staves)[n];
00720       printf(<span class="stringliteral">"staff %d out of range; %d\n"</span>, n, <a class="code" href="classScore.html#r17">_staves</a>-&gt;size());
00721       <span class="keywordflow">return</span> 0;
00722       }
00723 
00724 <span class="comment">//---------------------------------------------------------</span>
00725 <span class="comment">//   readStaff</span>
00726 <span class="comment">//---------------------------------------------------------</span>
00727 
<a name="l00728"></a><a class="code" href="classScore.html#a4">00728</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a4">Score::readStaff</a>(QDomNode node)
00729       {
00730       <a class="code" href="classMeasure.html">Measure</a>* im = <a class="code" href="classScore.html#a100">first</a>();
00731 
00732       QDomElement e = node.toElement();
00733       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = e.attribute(<span class="stringliteral">"id"</span>, <span class="stringliteral">"1"</span>).toInt() - 1;
00734 
00735       node = node.firstChild();
00736       <span class="keywordflow">while</span> (!node.isNull()) {
00737             QDomElement e = node.toElement();
00738             QString tag(e.tagName());
00739 
00740             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Measure"</span>) {
00741                   <a class="code" href="classMeasure.html">Measure</a>* measure;
00742                   <span class="keywordflow">if</span> (staff == 0) {
00743                         measure = <span class="keyword">new</span> <a class="code" href="classMeasure.html">Measure</a>(<span class="keyword">this</span>);
00744                         <a class="code" href="classScore.html#a102">push_back</a>(measure);
00745                         }
00746                   <span class="keywordflow">else</span> {
00747                         <span class="keywordflow">if</span> (im) {
00748                               measure = im;
00749                               im = im-&gt;<a class="code" href="classMeasure.html#a64">next</a>();
00750                               }
00751                         <span class="keywordflow">else</span> {
00752                               printf(<span class="stringliteral">"Score::readStaff(): missing measure!\n"</span>);
00753                               measure = <span class="keyword">new</span> <a class="code" href="classMeasure.html">Measure</a>(<span class="keyword">this</span>);
00754                               <a class="code" href="classScore.html#a102">push_back</a>(measure);
00755                               }
00756                         }
00757                   measure-&gt;<a class="code" href="classMeasure.html#a5">read</a>(node, staff);
00758                   }
00759             <span class="keywordflow">else</span>
00760                   printf(<span class="stringliteral">"Mscore:Staff: unknown tag %s\n"</span>,
00761                      tag.latin1());
00762             node = node.nextSibling();
00763             }
00764       }
00765 
00766 <span class="comment">//---------------------------------------------------------</span>
00767 <span class="comment">//   snap</span>
00768 <span class="comment">//---------------------------------------------------------</span>
00769 
<a name="l00770"></a><a class="code" href="classScore.html#a27">00770</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a27">Score::snap</a>(<span class="keywordtype">int</span> tick, <span class="keyword">const</span> QPointF p)<span class="keyword"> const</span>
00771 <span class="keyword">      </span>{
00772       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a0">iPage</a> ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
00773             <a class="code" href="classPage.html">Page</a>* page = *ip;
00774             <span class="keywordflow">if</span> (!page-&gt;<a class="code" href="classElement.html#a30">contains</a>(p))
00775                   <span class="keywordflow">continue</span>;
00776             QPointF rp = p - page-&gt;<a class="code" href="classElement.html#a20">pos</a>();  <span class="comment">// transform to page relative</span>
00777             <a class="code" href="classSystemList.html">SystemList</a>* sl = page-&gt;<a class="code" href="classPage.html#a4">systems</a>();
00778             <span class="keywordtype">double</span> y = 0.0;
00779             <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciSystem</a> is = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); is != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++is) {
00780                   <a class="code" href="classSystem.html">System</a>* system = *is;
00781                   <a class="code" href="classpstl_1_1plist.html">ciSystem</a> nis = is;
00782                   ++nis;
00783                   <span class="keywordflow">if</span> (nis == sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00784                         <span class="keywordflow">return</span> system-&gt;<a class="code" href="classSystem.html#a25">snap</a>(tick, rp - system-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00785                         }
00786                   <a class="code" href="classSystem.html">System</a>* nsystem = *nis;
00787                   <span class="keywordtype">double</span> nexty = nsystem-&gt;<a class="code" href="classElement.html#a22">y</a>();
00788                   <span class="keywordtype">double</span> gap = nexty - y - system-&gt;<a class="code" href="classElement.html#a36">height</a>();
00789                   nexty -= gap/2.0;
00790                   <span class="keywordflow">if</span> (p.y() &gt;= y &amp;&amp; p.y() &lt; nexty) {
00791                         <span class="keywordflow">return</span> system-&gt;<a class="code" href="classSystem.html#a25">snap</a>(tick, rp - system-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00792                         }
00793                   }
00794             }
00795       printf(<span class="stringliteral">"snapSegment: nothing found\n"</span>);
00796       <span class="keywordflow">return</span> tick;
00797       }
00798 
00799 <span class="comment">//---------------------------------------------------------</span>
00800 <span class="comment">//   pos2sel</span>
00801 <span class="comment">//---------------------------------------------------------</span>
00802 
<a name="l00803"></a><a class="code" href="classMeasure.html#a51">00803</a> <span class="keywordtype">int</span> <a class="code" href="classMeasure.html#a51">Measure::snap</a>(<span class="keywordtype">int</span> tick, <span class="keyword">const</span> QPointF p)<span class="keyword"> const</span>
00804 <span class="keyword">      </span>{
00805       <a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#r0">_first</a>;
00806       <span class="keywordflow">for</span> (; s-&gt;<a class="code" href="classSegment.html#a4">next</a>(); s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00807             <span class="keywordtype">double</span> x  = s-&gt;<a class="code" href="classSegment.html#a15">x</a>();
00808             <span class="keywordtype">double</span> dx = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()-&gt;<a class="code" href="classSegment.html#a15">x</a>() - x;
00809             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick)
00810                   x += dx / 3.0 * 2.0;
00811             <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a4">next</a>()-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick)
00812                   x += dx / 3.0;
00813             <span class="keywordflow">else</span>
00814                   x += dx / 2.0;
00815             <span class="keywordflow">if</span> (p.x() &lt; x)
00816                   <span class="keywordflow">break</span>;
00817             }
00818       <span class="keywordflow">return</span> s-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00819       }
00820 
00821 <span class="comment">//---------------------------------------------------------</span>
00822 <span class="comment">//   startEdit</span>
00823 <span class="comment">//---------------------------------------------------------</span>
00824 
<a name="l00825"></a><a class="code" href="classScore.html#a88">00825</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a88">Score::startEdit</a>(<a class="code" href="classElement.html">Element</a>* element)
00826       {
00827       <a class="code" href="classScore.html#o15">origEditObject</a> = element;
00828       <a class="code" href="classScore.html#o16">editObject</a>     = element-&gt;<a class="code" href="classElement.html#a3">clone</a>();
00829 
00830       <a class="code" href="classScore.html#a47">select</a>(<a class="code" href="classScore.html#o16">editObject</a>, 0, 0);
00831 
00832       <a class="code" href="classScore.html#a61">removeObject</a>(element);
00833       element-&gt;resetMode();
00834       <a class="code" href="classScore.html#a60">addObject</a>(<a class="code" href="classScore.html#o16">editObject</a>);
00835 
00836       <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemoveObject, <a class="code" href="classScore.html#o15">origEditObject</a>);
00837       <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::AddObject, <a class="code" href="classScore.html#o16">editObject</a>);
00838 
00839       <a class="code" href="classScore.html#r3">updateAll</a> = <span class="keyword">true</span>;
00840       <a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">false</span>);
00841       }
00842 
00843 <span class="comment">//---------------------------------------------------------</span>
00844 <span class="comment">//   edit</span>
00845 <span class="comment">//    return true if end edit</span>
00846 <span class="comment">//---------------------------------------------------------</span>
00847 
<a name="l00848"></a><a class="code" href="classScore.html#a89">00848</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a89">Score::edit</a>(QKeyEvent* ev)
00849       {
00850       <span class="keywordflow">if</span> ((ev-&gt;key() == Qt::Key_Escape) || <a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a53">edit</a>(ev)) {
00851             <a class="code" href="classScore.html#a90">endEdit</a>();
00852             <a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">true</span>);
00853             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00854             }
00855       <a class="code" href="classScore.html#a49">layout</a>();
00856       <a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">false</span>);
00857       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00858       }
00859 
00860 <span class="comment">//---------------------------------------------------------</span>
00861 <span class="comment">//   endEdit</span>
00862 <span class="comment">//---------------------------------------------------------</span>
00863 
<a name="l00864"></a><a class="code" href="classScore.html#a90">00864</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a90">Score::endEdit</a>()
00865       {
00866       <a class="code" href="classScore.html#r1">refresh</a> |= <a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a33">bbox</a>();
00867       <a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a58">endEdit</a>();
00868       <a class="code" href="classScore.html#r1">refresh</a> |= <a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a33">bbox</a>();
00869 
00870       <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a37">INSTRUMENT_NAME2</a>) {
00871 <span class="comment">//            InstrumentName2* in = (InstrumentName2*)editObject;</span>
00872 <span class="comment">//            int staff           = in-&gt;staff();</span>
00873 <span class="comment">//            Instrument* instr   = instrument(staff);</span>
00874 <span class="comment">//            instr-&gt;setShortName(in-&gt;text());</span>
00875             <a class="code" href="classScore.html#a20">setInstrumentNames</a>();
00876             }
00877       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a36">INSTRUMENT_NAME1</a>) {
00878 <span class="comment">//            InstrumentName1* in = (InstrumentName1*)editObject;</span>
00879 <span class="comment">//            int staff           = in-&gt;staff();</span>
00880 <span class="comment">//            Instrument* instr   = instrument(staff);</span>
00881 <span class="comment">//            instr-&gt;setLongName(in-&gt;text());</span>
00882 <span class="comment">//            setInstrumentNames();</span>
00883             }
00884       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a35">LYRICS</a>) {
00885             <a class="code" href="classLyrics.html">Lyrics</a>* lyrics = (<a class="code" href="classLyrics.html">Lyrics</a>*)<a class="code" href="classScore.html#o16">editObject</a>;
00886             <a class="code" href="classLyrics.html">Lyrics</a>* origL = (<a class="code" href="classLyrics.html">Lyrics</a>*)<a class="code" href="classScore.html#o15">origEditObject</a>;
00887             <span class="keywordflow">if</span> (lyrics-&gt;<a class="code" href="classSText.html#a11">text</a>().isEmpty() &amp;&amp; origL-&gt;<a class="code" href="classSText.html#a11">text</a>().isEmpty()) {
00888                   <a class="code" href="classMeasure.html">Measure</a>* measure = (<a class="code" href="classMeasure.html">Measure</a>*)(lyrics-&gt;<a class="code" href="classElement.html#a10">parent</a>());
00889                   measure-&gt;<a class="code" href="classMeasure.html#a9">remove</a>(lyrics);
00890                   }
00891             }
00892       <a class="code" href="classScore.html#a49">layout</a>();
00893       }
00894 
00895 <span class="comment">//---------------------------------------------------------</span>
00896 <span class="comment">//   paste</span>
00897 <span class="comment">//    paste element el at position pos</span>
00898 <span class="comment">//---------------------------------------------------------</span>
00899 
<a name="l00900"></a><a class="code" href="classScore.html#a91">00900</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a91">Score::paste</a>(<span class="keyword">const</span> <a class="code" href="classElement.html">Element</a>* el, <span class="keyword">const</span> QPointF&amp; pos)
00901       {
00902       <a class="code" href="classScore.html#r12">_dragObject</a> = <a class="code" href="classScore.html#a76">cmdAddElement</a>(el-&gt;<a class="code" href="classElement.html#a3">clone</a>(), pos);
00903       <span class="keywordflow">if</span> (<a class="code" href="classScore.html#r12">_dragObject</a>)
00904             <a class="code" href="classScore.html#a47">select</a>(<a class="code" href="classScore.html#r12">_dragObject</a>, 0, 0);
00905       }
00906 
00907 <span class="comment">//---------------------------------------------------------</span>
00908 <span class="comment">//   startDrag</span>
00909 <span class="comment">//---------------------------------------------------------</span>
00910 
<a name="l00911"></a><a class="code" href="classScore.html#a92">00911</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a92">Score::startDrag</a>()
00912       {
00913       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a5">clear</a>();
00914       <a class="code" href="classElement.html">Element</a>* el    = <a class="code" href="classScore.html#r12">_dragObject</a>-&gt;<a class="code" href="classElement.html#a3">clone</a>();
00915       <a class="code" href="classScore.html#r11">origDragObject</a> = <a class="code" href="classScore.html#r12">_dragObject</a>;
00916       _dragObject     = el;
00917       <a class="code" href="classScore.html#a61">removeObject</a>(<a class="code" href="classScore.html#r11">origDragObject</a>);
00918       <a class="code" href="classScore.html#a60">addObject</a>(_dragObject);
00919       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a1">add</a>(el);
00920       }
00921 
00922 <span class="comment">//---------------------------------------------------------</span>
00923 <span class="comment">//   drag</span>
00924 <span class="comment">//---------------------------------------------------------</span>
00925 
<a name="l00926"></a><a class="code" href="classScore.html#a93">00926</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a93">Score::drag</a>(<span class="keyword">const</span> QPointF&amp; delta)
00927       {
00928       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a0">elements</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a0">elements</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00929             <a class="code" href="classScore.html#r1">refresh</a> |= (*i)-&gt;drag(delta);
00930       }
00931 
00932 <span class="comment">//---------------------------------------------------------</span>
00933 <span class="comment">//   endDrag</span>
00934 <span class="comment">//---------------------------------------------------------</span>
00935 
<a name="l00936"></a><a class="code" href="classScore.html#a94">00936</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a94">Score::endDrag</a>()
00937       {
00938       <a class="code" href="classScore.html#r12">_dragObject</a>-&gt;<a class="code" href="classElement.html#a51">endDrag</a>();
00939       <span class="keywordflow">if</span> (<a class="code" href="classScore.html#r11">origDragObject</a>) {
00940             <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemoveObject, <a class="code" href="classScore.html#r11">origDragObject</a>);
00941             <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::AddObject, <a class="code" href="classScore.html#r12">_dragObject</a>);
00942             <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a5">clear</a>();
00943             <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a1">add</a>(<a class="code" href="classScore.html#r12">_dragObject</a>);
00944             <a class="code" href="classScore.html#r11">origDragObject</a> = 0;
00945             }
00946       <a class="code" href="classScore.html#a49">layout</a>();
00947       }
00948 
00949 <span class="comment">//---------------------------------------------------------</span>
00950 <span class="comment">//   dragEdit</span>
00951 <span class="comment">//---------------------------------------------------------</span>
00952 
<a name="l00953"></a><a class="code" href="classScore.html#a95">00953</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a95">Score::dragEdit</a>(QMatrix&amp; matrix, QPointF* startMove, <span class="keyword">const</span> QPointF&amp; fdelta)
00954       {
00955       <a class="code" href="classScore.html#r1">refresh</a> |= <a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00956       <a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a55">editDrag</a>(matrix, startMove, fdelta);
00957       <a class="code" href="classScore.html#r1">refresh</a> |= <a class="code" href="classScore.html#o16">editObject</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00958       }
00959 
00960 <span class="comment">//---------------------------------------------------------</span>
00961 <span class="comment">//   setNoteEntry</span>
00962 <span class="comment">//    switch note entry mode</span>
00963 <span class="comment">//---------------------------------------------------------</span>
00964 
<a name="l00965"></a><a class="code" href="classScore.html#a98">00965</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a98">Score::setNoteEntry</a>(<span class="keywordtype">bool</span> val, <span class="keywordtype">bool</span> step)
00966       {
00967       <span class="keywordflow">if</span> (val) {
00968             <a class="code" href="classElement.html">Element</a>* el = <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a6">element</a>();
00969             <span class="keywordflow">if</span> (<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> != -1) {     <span class="comment">// already in note entry mode</span>
00970                   <span class="keywordflow">if</span> (el) {
00971                         <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>)
00972                               el = el-&gt;<a class="code" href="classElement.html#a10">parent</a>();
00973                         <span class="keywordflow">if</span> (!el-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>())
00974                               <span class="keywordflow">return</span>;
00975                         <a class="code" href="classChordRest.html">ChordRest</a>* cr = (<a class="code" href="classChordRest.html">ChordRest</a>*)el;
00976                         <span class="keywordflow">if</span> (cr-&gt;<a class="code" href="classElement.html#a74">tick</a>() == <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a>)
00977                               <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> += cr-&gt;<a class="code" href="classElement.html#a76">tickLen</a>();
00978                         }
00979                   <span class="keywordflow">return</span>;
00980                   }
00981             <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> != <a class="code" href="select_8h.html#a5a1">SEL_SINGLE</a> || !el || (el-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a12">NOTE</a> &amp;&amp;
00982                !el-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>())) {
00983                   QMessageBox::information(0, <span class="stringliteral">"MuseScore: Note Entry"</span>,
00984                         tr(<span class="stringliteral">"First select a single note or rest and then try again"</span>),
00985                         QMessageBox::Ok);
00986                   <span class="keywordflow">return</span>;
00987                   }
00988             <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>)
00989                   el = el-&gt;<a class="code" href="classElement.html#a10">parent</a>();
00990             <a class="code" href="classChordRest.html">ChordRest</a>* cr = (<a class="code" href="classChordRest.html">ChordRest</a>*)el;
00991             <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> = cr-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00992             <span class="keywordflow">if</span> (step)
00993                   <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> += cr-&gt;<a class="code" href="classElement.html#a76">tickLen</a>();
00994             <a class="code" href="classScore.html#a46">canvas</a>()-&gt;<a class="code" href="classCanvas.html#a13">setState</a>(Canvas::NOTE_ENTRY);
00995             }
00996       <span class="keywordflow">else</span> {
00997             <a class="code" href="canvas_8cpp.html#a0">padState</a>.<a class="code" href="structPadState.html#o1">len</a> = 0;
00998             <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> = -1;
00999             <a class="code" href="classScore.html#a82">setPadState</a>();
01000             <a class="code" href="classScore.html#a46">canvas</a>()-&gt;<a class="code" href="classCanvas.html#a13">setState</a>(Canvas::NORMAL);
01001             }
01002       <a class="code" href="classScore.html#d8">moveCursor</a>();
01003       }
01004 
01005 <span class="comment">//---------------------------------------------------------</span>
01006 <span class="comment">//   startNoteEntry</span>
01007 <span class="comment">//---------------------------------------------------------</span>
01008 
<a name="l01009"></a><a class="code" href="classScore.html#i15">01009</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#i15">Score::startNoteEntry</a>()
01010       {
01011       <a class="code" href="classScore.html#a98">setNoteEntry</a>(<span class="keyword">true</span>, <span class="keyword">false</span>);
01012       <a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">false</span>);
01013       }
01014 
01015 <span class="comment">//---------------------------------------------------------</span>
01016 <span class="comment">//   midiReceived</span>
01017 <span class="comment">//---------------------------------------------------------</span>
01018 
<a name="l01019"></a><a class="code" href="classScore.html#i19">01019</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#i19">Score::midiReceived</a>()
01020       {
01021       <a class="code" href="alsa_8cpp.html#a2">readMidiEvent</a>();
01022       }
01023 
01024 <span class="comment">//---------------------------------------------------------</span>
01025 <span class="comment">//   midiNoteReceived</span>
01026 <span class="comment">//---------------------------------------------------------</span>
01027 
<a name="l01028"></a><a class="code" href="classScore.html#a108">01028</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a108">Score::midiNoteReceived</a>(<span class="keywordtype">int</span> pitch, <span class="keywordtype">bool</span> chord)
01029       {
01030       <a class="code" href="classScore.html#a83">startCmd</a>();
01031       <span class="keywordflow">if</span> (<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> == -1) {
01032             <a class="code" href="classScore.html#a98">setNoteEntry</a>(<span class="keyword">true</span>, <span class="keyword">false</span>);
01033             }
01034       <span class="keywordflow">if</span> (<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> != -1) {
01035             <span class="keywordtype">int</span> len = <a class="code" href="canvas_8cpp.html#a0">padState</a>.<a class="code" href="structPadState.html#o2">tickLen</a>;
01036             <span class="keywordflow">if</span> (chord) {
01037                   <a class="code" href="classNote.html">Note</a>* on = <a class="code" href="classScore.html#d9">getSelectedNote</a>();
01038                   <a class="code" href="classNote.html">Note</a>* n = <a class="code" href="classScore.html#a68">addNote</a>(on-&gt;<a class="code" href="classNote.html#a37">chord</a>(), pitch);
01039                   <a class="code" href="classScore.html#a47">select</a>(n, 0, 0);
01040                   }
01041             <span class="keywordflow">else</span> {
01042                   <a class="code" href="classScore.html#a41">setNote</a>(<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a>, <a class="code" href="classScore.html#a7">staff</a>(<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>), <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o2">voice</a>, pitch, len);
01043                   <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o0">pos</a> += len;
01044                   <a class="code" href="classScore.html#d8">moveCursor</a>();
01045                   }
01046             }
01047       <a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">true</span>);
01048       }
01049 
01050 <span class="comment">//---------------------------------------------------------</span>
01051 <span class="comment">//   searchTieNote</span>
01052 <span class="comment">//---------------------------------------------------------</span>
01053 
<a name="l01054"></a><a class="code" href="classScore.html#d10">01054</a> <a class="code" href="classNote.html">Note</a>* <a class="code" href="classScore.html#d10">Score::searchTieNote</a>(<a class="code" href="classNote.html">Note</a>* note, <a class="code" href="classSegment.html">Segment</a>* segment, <span class="keywordtype">int</span> track)
01055       {
01056       <span class="keywordtype">int</span> pitch = note-&gt;<a class="code" href="classNote.html#a15">pitch</a>();
01057 
01058       <span class="keywordflow">while</span> ((segment = segment-&gt;<a class="code" href="classSegment.html#a6">next1</a>())) {
01059             <a class="code" href="classElement.html">Element</a>* element = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
01060             <span class="keywordflow">if</span> (element == 0 || element-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
01061                   <span class="keywordflow">continue</span>;
01062             <span class="keyword">const</span> <a class="code" href="classNoteList.html">NoteList</a>* nl = ((<a class="code" href="classChord.html">Chord</a>*)element)-&gt;noteList();
01063             <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a3">ciNote</a> in = nl-&gt;begin(); in != nl-&gt;end(); ++in) {
01064                   <span class="keywordflow">if</span> (in-&gt;second-&gt;pitch() == pitch)
01065                         <span class="keywordflow">return</span> in-&gt;second;
01066                   }
01067             }
01068       <span class="keywordflow">return</span> 0;
01069       }
01070 
01071 <span class="comment">//---------------------------------------------------------</span>
01072 <span class="comment">//   connectTies</span>
01073 <span class="comment">//    rebuild tie connections</span>
01074 <span class="comment">//---------------------------------------------------------</span>
01075 
<a name="l01076"></a><a class="code" href="classScore.html#a99">01076</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a99">Score::connectTies</a>()
01077       {
01078       <span class="keywordtype">int</span> tracks = <a class="code" href="classScore.html#a6">nstaves</a>() * <a class="code" href="globals_8h.html#a3">VOICES</a>;
01079       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
01080             <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
01081                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; tracks; ++i) {
01082                         <a class="code" href="classElement.html">Element</a>* el = s-&gt;<a class="code" href="classSegment.html#a8">element</a>(i);
01083                         <span class="keywordflow">if</span> (el == 0 || el-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
01084                               <span class="keywordflow">continue</span>;
01085                         <span class="keyword">const</span> <a class="code" href="classNoteList.html">NoteList</a>* nl = ((<a class="code" href="classChord.html">Chord</a>*)el)-&gt;noteList();
01086                         <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a3">ciNote</a> in = nl-&gt;begin(); in != nl-&gt;end(); ++in) {
01087                               <a class="code" href="classTie.html">Tie</a>* tie = in-&gt;second-&gt;tieFor();
01088                               <span class="keywordflow">if</span> (!tie)
01089                                     <span class="keywordflow">continue</span>;
01090                               <a class="code" href="classNote.html">Note</a>* nnote = <a class="code" href="classScore.html#d10">searchTieNote</a>(in-&gt;second, s, i);
01091                               <span class="keywordflow">if</span> (nnote == 0)
01092                                     printf(<span class="stringliteral">"next note for tie not found\n"</span>);
01093                               <span class="keywordflow">else</span> {
01094                                     tie-&gt;<a class="code" href="classTie.html#a4">setEndNote</a>(nnote);
01095                                     nnote-&gt;<a class="code" href="classNote.html#a36">setTieBack</a>(tie);
01096                                     }
01097                               }
01098                         }
01099                   }
01100             }
01101       }
01102 
01103 <span class="comment">//---------------------------------------------------------</span>
01104 <span class="comment">//   snapNote</span>
01105 <span class="comment">//    p - absolute position</span>
01106 <span class="comment">//---------------------------------------------------------</span>
01107 
<a name="l01108"></a><a class="code" href="classScore.html#a28">01108</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a28">Score::snapNote</a>(<span class="keywordtype">int</span> tick, <span class="keyword">const</span> QPointF p, <span class="keywordtype">int</span> staff)<span class="keyword"> const</span>
01109 <span class="keyword">      </span>{
01110       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a0">iPage</a> ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
01111             <a class="code" href="classPage.html">Page</a>* page = *ip;
01112             <span class="keywordflow">if</span> (!page-&gt;<a class="code" href="classElement.html#a30">contains</a>(p))
01113                   <span class="keywordflow">continue</span>;
01114             QPointF rp = p - page-&gt;<a class="code" href="classElement.html#a20">pos</a>();  <span class="comment">// transform to page relative</span>
01115             <a class="code" href="classSystemList.html">SystemList</a>* sl = page-&gt;<a class="code" href="classPage.html#a4">systems</a>();
01116             <span class="keywordtype">double</span> y = 0.0;
01117             <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciSystem</a> is = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); is != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++is) {
01118                   <a class="code" href="classSystem.html">System</a>* system = *is;
01119                   <a class="code" href="classpstl_1_1plist.html">ciSystem</a> nis   = is;
01120                   ++nis;
01121                   <span class="keywordflow">if</span> (nis == sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
01122                         <span class="keywordflow">return</span> system-&gt;<a class="code" href="classSystem.html#a26">snapNote</a>(tick, rp - system-&gt;<a class="code" href="classElement.html#a20">pos</a>(), staff);
01123                         }
01124                   <a class="code" href="classSystem.html">System</a>* nsystem = *nis;
01125                   <span class="keywordtype">double</span> nexty = nsystem-&gt;<a class="code" href="classElement.html#a22">y</a>();
01126                   <span class="keywordtype">double</span> gap = nexty - (system-&gt;<a class="code" href="classElement.html#a22">y</a>() + system-&gt;<a class="code" href="classElement.html#a36">height</a>());
01127                   nexty -= gap/2.0;
01128                   <span class="keywordflow">if</span> (p.y() &gt;= y &amp;&amp; p.y() &lt; nexty) {
01129                         <span class="keywordflow">return</span> system-&gt;<a class="code" href="classSystem.html#a26">snapNote</a>(tick, rp - system-&gt;<a class="code" href="classElement.html#a20">pos</a>(), staff);
01130                         }
01131                   y = nexty;
01132                   }
01133             }
01134       printf(<span class="stringliteral">"snapNote: nothing found\n"</span>);
01135       <span class="keywordflow">return</span> tick;
01136       }
01137 
01138 <span class="comment">//---------------------------------------------------------</span>
01139 <span class="comment">//   pos2sel</span>
01140 <span class="comment">//---------------------------------------------------------</span>
01141 
<a name="l01142"></a><a class="code" href="classMeasure.html#a52">01142</a> <span class="keywordtype">int</span> <a class="code" href="classMeasure.html#a52">Measure::snapNote</a>(<span class="keywordtype">int</span> <span class="comment">/*tick*/</span>, <span class="keyword">const</span> QPointF p, <span class="keywordtype">int</span> staff)<span class="keyword"> const</span>
01143 <span class="keyword">      </span>{
01144       <a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#r0">_first</a>;
01145       <span class="keywordflow">for</span> (;;) {
01146             <a class="code" href="classSegment.html">Segment</a>* ns = s-&gt;<a class="code" href="classSegment.html#a4">next</a>();
01147             <span class="keywordflow">while</span> (ns &amp;&amp; ns-&gt;<a class="code" href="classSegment.html#a8">element</a>(staff) == 0)
01148                   ns = ns-&gt;<a class="code" href="classSegment.html#a4">next</a>();
01149             <span class="keywordflow">if</span> (ns == 0)
01150                   <span class="keywordflow">break</span>;
01151             <span class="keywordtype">double</span> x  = s-&gt;<a class="code" href="classSegment.html#a15">x</a>();
01152             <span class="keywordtype">double</span> nx = x + (ns-&gt;<a class="code" href="classSegment.html#a15">x</a>() - x) / 2;
01153 <span class="preprocessor">#if 0</span>
01154 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick)
01155                   x += dx / 3.0 * 2.0;
01156             <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (ns-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick)
01157                   x += dx / 3.0;
01158             <span class="keywordflow">else</span>
01159                   x += dx / 2.0;
01160 <span class="preprocessor">#endif</span>
01161 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (p.x() &lt; nx)
01162                   <span class="keywordflow">break</span>;
01163             s = ns;
01164             }
01165       <span class="keywordflow">return</span> s-&gt;<a class="code" href="classElement.html#a74">tick</a>();
01166       }
01167 
01168 <span class="comment">//---------------------------------------------------------</span>
01169 <span class="comment">//   nstaves</span>
01170 <span class="comment">//---------------------------------------------------------</span>
01171 
<a name="l01172"></a><a class="code" href="classScore.html#a6">01172</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a6">Score::nstaves</a>()<span class="keyword"> const</span>
01173 <span class="keyword">      </span>{
01174       <span class="keywordflow">return</span> <a class="code" href="classScore.html#r17">_staves</a>-&gt;size();
01175       }
01176 
01177 <span class="comment">//---------------------------------------------------------</span>
01178 <span class="comment">//   noStaves</span>
01179 <span class="comment">//---------------------------------------------------------</span>
01180 
<a name="l01181"></a><a class="code" href="classScore.html#a10">01181</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a10">Score::noStaves</a>()<span class="keyword"> const</span>
01182 <span class="keyword">      </span>{
01183       <span class="keywordflow">return</span> <a class="code" href="classScore.html#r17">_staves</a>-&gt;empty();
01184       }
01185 
01186 <span class="comment">//---------------------------------------------------------</span>
01187 <span class="comment">//   read</span>
01188 <span class="comment">//---------------------------------------------------------</span>
01189 
<a name="l01190"></a><a class="code" href="classScore.html#a112">01190</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a112">Score::read</a>(QString name)
01191       {
01192 <span class="comment">//      clearScore();</span>
01193 
01194       <a class="code" href="classScore.html#o3">saved</a> = <span class="keyword">false</span>;
01195       <a class="code" href="classScore.html#r0">info</a>.setFile(name);
01196 
01197       <a class="code" href="classScore.html#o1">projectName</a> = <a class="code" href="classScore.html#r0">info</a>.baseName();
01198 
01199       <span class="keywordflow">if</span> (<a class="code" href="classScore.html#r0">info</a>.extension(<span class="keyword">true</span>) == <span class="stringliteral">"xml"</span>) {
01200             <a class="code" href="classScore.html#a124">importMusicXml</a>(name);
01201             <a class="code" href="classScore.html#o4">newScore</a> = <span class="keyword">false</span>;
01202             }
01203       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classScore.html#r0">info</a>.extension(<span class="keyword">true</span>) == <span class="stringliteral">"mid"</span>) {
01204             <a class="code" href="classScore.html#a126">importMidi</a>(name);
01205             <a class="code" href="classScore.html#o4">newScore</a> = <span class="keyword">false</span>;
01206             }
01207       <span class="keywordflow">else</span> {
01208             <a class="code" href="classScore.html#o4">newScore</a> = <a class="code" href="classScore.html#a122">loadMsc</a>(name);
01209             }
01210       }
01211 
01212 <span class="comment">//---------------------------------------------------------</span>
01213 <span class="comment">//   textStyleChanged</span>
01214 <span class="comment">//---------------------------------------------------------</span>
01215 
<a name="l01216"></a><a class="code" href="classScore.html#i25">01216</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#i25">Score::textStyleChanged</a>()
01217       {
01218       <a class="code" href="classElement.html">Element</a>* l = <a class="code" href="classScore.html#o0">textList</a>;
01219       <span class="keywordflow">while</span> (l) {
01220             l-&gt;<a class="code" href="classElement.html#a66">layout</a>();
01221             l = l-&gt;<a class="code" href="classElement.html#a6">next</a>();
01222             }
01223       <a class="code" href="classScore.html#a49">layout</a>();
01224       <a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">false</span>);
01225       }
01226 
01227 <span class="comment">//---------------------------------------------------------</span>
01228 <span class="comment">//   undoEmpty</span>
01229 <span class="comment">//---------------------------------------------------------</span>
01230 
<a name="l01231"></a><a class="code" href="classScore.html#a133">01231</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a133">Score::undoEmpty</a>()<span class="keyword"> const</span>
01232 <span class="keyword">      </span>{
01233       <span class="keywordflow">return</span> <a class="code" href="classScore.html#r18">undoList</a>.empty();
01234       }
01235 
01236 <span class="comment">//---------------------------------------------------------</span>
01237 <span class="comment">//   redoEmpty</span>
01238 <span class="comment">//---------------------------------------------------------</span>
01239 
<a name="l01240"></a><a class="code" href="classScore.html#a134">01240</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a134">Score::redoEmpty</a>()<span class="keyword"> const</span>
01241 <span class="keyword">      </span>{
01242       <span class="keywordflow">return</span> <a class="code" href="classScore.html#r19">redoList</a>.empty();
01243       }
01244 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
