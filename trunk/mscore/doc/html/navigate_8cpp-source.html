<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: navigate.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>navigate.cpp</h1><a href="navigate_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: navigate.cpp,v 1.24 2005/06/20 13:54:53 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="element_8h.html">element.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="input_8h.html">input.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00019 
00020 <span class="comment">//</span>
00021 <span class="comment">//  Liste der möglichen enharmonischen Verwechslungen</span>
00022 <span class="comment">//    für jeden Ton</span>
00023 
<a name="l00024"></a><a class="code" href="navigate_8cpp.html#a0">00024</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="navigate_8cpp.html#a0">table0</a>[12][5] = {
00025     <span class="comment">//  -   #  b   ## bb</span>
00026       { 0, -1, 0, -1, 1  },   <span class="comment">// c</span>
00027       { 0,  0, 1, -1, 1  },   <span class="comment">// cis</span>
00028       { 1,  1, 1,  0, 2  },   <span class="comment">// d</span>
00029       { 2,  1, 2,  2, 3  },   <span class="comment">// dis</span>
00030       { 2,  2, 3,  1, 3  },   <span class="comment">// e</span>
00031       { 3,  2, 3,  2, 4  },   <span class="comment">// f</span>
00032       { 3,  3, 4,  2, 4  },   <span class="comment">// fis</span>
00033       { 4,  4, 4,  3, 5  },   <span class="comment">// g</span>
00034       { 4,  4, 5,  4, 5  },   <span class="comment">// gis</span>
00035       { 5,  5, 5,  4, 6  },   <span class="comment">// a</span>
00036       { 6,  5, 6,  5, 7  },   <span class="comment">// #a</span>
00037       { 6,  6, 7,  5, 7  }    <span class="comment">// b</span>
00038       };
00039 
00040 <span class="comment">//</span>
00041 <span class="comment">// Notenlinie für jede Note einer Oktave,</span>
00042 <span class="comment">//    abhängig von der Tonart (feste Versetzungszeichen)</span>
00043 <span class="comment">//</span>
00044 
<a name="l00045"></a><a class="code" href="navigate_8cpp.html#a1">00045</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="navigate_8cpp.html#a1">table1</a>[15][12] = {
00046       { 0, 1, 2, 2, 3, 3, 4, 4, 5, 6, 6, 7 },  <span class="comment">// ces</span>
00047       { 0, 1, 1, 2, 3, 3, 4, 4, 5, 6, 6, 7 },  <span class="comment">// ges</span>
00048       { 0, 1, 1, 2, 3, 3, 4, 4, 5, 5, 6, 7 },  <span class="comment">// des</span>
00049       { 0, 1, 1, 2, 2, 3, 4, 4, 5, 5, 6, 7 },  <span class="comment">// as</span>
00050       { 0, 1, 1, 2, 2, 3, 4, 4, 5, 5, 6, 6 },  <span class="comment">// es</span>
00051       { 0, 1, 1, 2, 2, 3, 3, 4, 5, 5, 6, 6 },  <span class="comment">// B</span>
00052       { 0, 0, 1, 2, 2, 3, 3, 4, 5, 5, 6, 6 },  <span class="comment">// F</span>
00053 
00054       { 0, 0, 1, 2, 2, 3, 3, 4, 4, 5, 6, 6 },  <span class="comment">// C</span>
00055 
00056       { 0, 0, 1, 1, 2, 3, 3, 4, 4, 5, 6, 6 },  <span class="comment">// G</span>
00057       { 0, 0, 1, 1, 2, 3, 3, 4, 4, 5, 5, 6 },  <span class="comment">// D</span>
00058       { 0, 0, 1, 1, 2, 2, 3, 4, 4, 5, 5, 6 },  <span class="comment">// A</span>
00059       { 0, 0, 1, 1, 2, 2, 3, 4, 4, 5, 5, 6 },  <span class="comment">// E</span>
00060       { 0, 0, 1, 1, 2, 2, 3, 3, 4, 5, 5, 6 },  <span class="comment">// H</span>
00061       { 0, 0, 0, 1, 2, 2, 3, 3, 4, 5, 5, 6 },  <span class="comment">// fis</span>
00062       { 0, 0, 0, 1, 2, 2, 3, 3, 4, 4, 5, 6 }   <span class="comment">// cis</span>
00063       };
00064 
00065 <span class="comment">//</span>
00066 <span class="comment">//    feste Versetzungszeichen</span>
00067 <span class="comment">//</span>
<a name="l00068"></a><a class="code" href="navigate_8cpp.html#a2">00068</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="navigate_8cpp.html#a2">tab3</a>[15][8] = {
00069       <span class="comment">//c  d  e  f  g  a  b  c</span>
00070       <span class="comment">//------------------------</span>
00071       { 2, 2, 2, 2, 2, 2, 2, 2 },    <span class="comment">// ces</span>
00072       { 2, 2, 2, 0, 2, 2, 2, 2 },    <span class="comment">// ges</span>
00073       { 0, 2, 2, 0, 2, 2, 2, 0 },    <span class="comment">// des</span>
00074       { 0, 2, 2, 0, 0, 2, 2, 0 },    <span class="comment">// as</span>
00075       { 0, 0, 2, 0, 0, 2, 2, 0 },    <span class="comment">// es</span>
00076       { 0, 0, 2, 0, 0, 0, 2, 0 },    <span class="comment">// B</span>
00077       { 0, 0, 0, 0, 0, 0, 2, 0 },    <span class="comment">// F</span>
00078 
00079       { 0, 0, 0, 0, 0, 0, 0, 0 },    <span class="comment">// C</span>
00080 
00081       { 0, 0, 0, 1, 0, 0, 0, 0 },    <span class="comment">// G</span>
00082       { 1, 0, 0, 1, 0, 0, 0, 1 },    <span class="comment">// D</span>
00083       { 1, 0, 0, 1, 1, 0, 0, 1 },    <span class="comment">// A</span>
00084       { 1, 1, 0, 1, 1, 0, 0, 1 },    <span class="comment">// E</span>
00085       { 1, 1, 0, 1, 1, 1, 0, 1 },    <span class="comment">// H</span>
00086       { 1, 1, 1, 1, 1, 1, 0, 1 },    <span class="comment">// fis</span>
00087       { 1, 1, 1, 1, 1, 1, 1, 1 }     <span class="comment">// cis</span>
00088       };
00089 
00090 <span class="comment">//---------------------------------------------------------</span>
00091 <span class="comment">//    pitch2y</span>
00092 <span class="comment">//    y  = 0 = top staff line</span>
00093 <span class="comment">//</span>
00094 <span class="comment">//    key: -7 - +7  (C==0)</span>
00095 <span class="comment">//    userPrefix = -1   no user defined prefix</span>
00096 <span class="comment">//---------------------------------------------------------</span>
00097 
<a name="l00098"></a><a class="code" href="navigate_8h.html#a0">00098</a> <span class="keywordtype">int</span> <a class="code" href="navigate_8h.html#a0">pitch2y</a>(<span class="keywordtype">int</span> pitch, <span class="keywordtype">int</span> userPrefix, <span class="keywordtype">int</span> clefOffset, <span class="keywordtype">int</span> key, <span class="keywordtype">int</span>&amp; prefix, <span class="keyword">const</span> <span class="keywordtype">char</span>* tversatz)
00099       {
00100       <span class="comment">//</span>
00101       <span class="comment">//  wenn eine enharmonische Verwechslung vorgegeben ist,</span>
00102       <span class="comment">//  dann wird die Notenlinie aus Tabelle 0 gezogen,</span>
00103       <span class="comment">//  ansonsten in Abhängigkeit der Tonleiter aus Tabelle 1</span>
00104 
00105       <span class="keywordtype">bool</span> natural = <span class="keyword">false</span>;
00106       <span class="keywordflow">if</span> (userPrefix == <a class="code" href="element_8h.html#a66a52">ACC_NATURAL</a>) {
00107             userPrefix = <a class="code" href="element_8h.html#a66a47">ACC_NONE</a>;
00108             natural = <span class="keyword">true</span>;
00109             }
00110       <span class="keywordtype">int</span> l1;
00111       <span class="keywordtype">int</span> mtone  = pitch % 12;
00112       <span class="keywordtype">int</span> octave = pitch / 12;
00113 
00114       <span class="keywordflow">if</span> (userPrefix != -1)
00115             l1 = <a class="code" href="navigate_8cpp.html#a0">table0</a>[mtone][userPrefix];
00116       <span class="keywordflow">else</span>
00117             l1 = <a class="code" href="navigate_8cpp.html#a1">table1</a>[key+7][mtone];
00118 
00119       <span class="keywordflow">while</span> (l1 &lt; 0) {
00120             l1 += 7;
00121             octave--;
00122             mtone += 12;
00123             }
00124 
00125       <span class="keyword">static</span> <span class="keywordtype">char</span> table2[8] = { 0, 2, 4, 5, 7, 9, 11, 12 };
00126 
00127       <span class="keywordtype">int</span> l2     = 45 - l1 - (octave * 7) + clefOffset;
00128       <span class="keywordtype">int</span> offset = mtone - table2[l1];
00129 
00130       <span class="keywordflow">switch</span> (offset) {
00131             <span class="keywordflow">case</span> -2:   prefix = 4; <span class="keywordflow">break</span>;
00132             <span class="keywordflow">case</span> -1:   prefix = 2; <span class="keywordflow">break</span>;
00133             <span class="keywordflow">case</span> 0:    prefix = 0; <span class="keywordflow">break</span>;
00134             <span class="keywordflow">case</span> 1:    prefix = 1; <span class="keywordflow">break</span>;
00135             <span class="keywordflow">case</span> 2:    prefix = 3; <span class="keywordflow">break</span>;
00136             <span class="keywordflow">default</span>:
00137                   printf(<span class="stringliteral">"pitch2y: internal error: bad val %d\n"</span>, offset);
00138                   abort();
00139             }
00140 
00141       <span class="keywordtype">int</span> cprefix = tversatz[l1 + octave * 7];
00142       <span class="keywordflow">if</span> (cprefix == 0)
00143             cprefix = <a class="code" href="navigate_8cpp.html#a2">tab3</a>[key+7][l1];
00144       <span class="keywordflow">if</span> (cprefix == 5)
00145             cprefix = 0;
00146       <span class="keywordflow">if</span> (cprefix) {
00147             <span class="keywordflow">if</span> (prefix == cprefix)
00148                   prefix = 0;             <span class="comment">// keine Versetzung</span>
00149             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prefix == 0) {
00150                   prefix = 5;             <span class="comment">// Auflösung</span>
00151                   }
00152             }
00153       <span class="keywordflow">if</span> (natural)
00154             prefix = 5;
00155       <span class="keywordflow">return</span> l2;
00156       }
00157 
00158 <span class="comment">//---------------------------------------------------------</span>
00159 <span class="comment">//   upAlt</span>
00160 <span class="comment">//    select next higher pitched note in chord</span>
00161 <span class="comment">//---------------------------------------------------------</span>
00162 
<a name="l00163"></a><a class="code" href="classScore.html#d17">00163</a> <a class="code" href="classNote.html">Note</a>* <a class="code" href="classScore.html#d17">Score::upAlt</a>(<a class="code" href="classElement.html">Element</a>* element)
00164       {
00165       <a class="code" href="classElement.html">Element</a>* re = 0;
00166       <span class="keywordflow">if</span> (element-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a26">REST</a>) {
00167             <span class="keywordflow">if</span> (<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a> &lt;= 0)
00168                   <span class="keywordflow">return</span> 0;
00169             --(<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>);
00170             re = <a class="code" href="classScore.html#a57">searchNote</a>(((<a class="code" href="classRest.html">Rest</a>*)element)-&gt;tick(), <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>);
00171             }
00172       <span class="keywordflow">else</span> {
00173             <span class="comment">// find segment</span>
00174             <a class="code" href="classChord.html">Chord</a>* chord     = ((<a class="code" href="classNote.html">Note</a>*) element)-&gt;chord();
00175             <a class="code" href="classSegment.html">Segment</a>* segment = chord-&gt;<a class="code" href="classChordRest.html#a4">segment</a>();
00176 
00177             <span class="comment">// collect all notes for this segment in noteList:</span>
00178             <a class="code" href="classNoteList.html">NoteList</a> rnl;
00179             <a class="code" href="note_8h.html#a1">iNote</a> inote = rnl.end();
00180             <span class="keywordtype">int</span> tracks = <a class="code" href="classScore.html#a6">nstaves</a>() * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00181             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00182                   <a class="code" href="classElement.html">Element</a>* el = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00183                   <span class="keywordflow">if</span> (!el || el-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00184                         <span class="keywordflow">continue</span>;
00185                   <a class="code" href="classNoteList.html">NoteList</a>* nl = ((<a class="code" href="classChord.html">Chord</a>*)el)-&gt;noteList();
00186                   <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a2">riNote</a> in   = nl-&gt;rbegin(); in != nl-&gt;rend(); ++in) {
00187                         <a class="code" href="classNote.html">Note</a>* note = in-&gt;second;
00188                         <a class="code" href="note_8h.html#a1">iNote</a> ii = rnl.<a class="code" href="classNoteList.html#a0">add</a>(note);
00189                         <span class="keywordflow">if</span> (note == element) {
00190                               inote = ii;
00191                               }
00192                         }
00193                   }
00194             <span class="keywordflow">if</span> (inote != rnl.end()) {
00195                   ++inote;
00196                   <span class="keywordflow">if</span> (inote != rnl.end())
00197                         re = inote-&gt;second;
00198                   }
00199             }
00200       <span class="keywordflow">if</span> (re == 0)
00201             <span class="keywordflow">return</span> 0;
00202       <span class="keywordflow">if</span> (re-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00203             re = ((<a class="code" href="classChord.html">Chord</a>*)re)-&gt;noteList()-&gt;front();
00204       <span class="keywordflow">return</span> (<a class="code" href="classNote.html">Note</a>*)re;
00205       }
00206 
00207 <span class="comment">//---------------------------------------------------------</span>
00208 <span class="comment">//   upAltCtrl</span>
00209 <span class="comment">//    höchste Note in Chord selektieren</span>
00210 <span class="comment">//---------------------------------------------------------</span>
00211 
<a name="l00212"></a><a class="code" href="classScore.html#d18">00212</a> <a class="code" href="classNote.html">Note</a>* <a class="code" href="classScore.html#d18">Score::upAltCtrl</a>(<a class="code" href="classNote.html">Note</a>* note)<span class="keyword"> const</span>
00213 <span class="keyword">      </span>{
00214       <a class="code" href="classChord.html">Chord</a>* chord = note-&gt;<a class="code" href="classNote.html#a37">chord</a>();
00215       <a class="code" href="classNoteList.html">NoteList</a>* nl  = chord-&gt;<a class="code" href="classChord.html#a15">noteList</a>();
00216       <span class="keywordflow">return</span> nl-&gt;rbegin()-&gt;second;
00217       }
00218 
00219 <span class="comment">//---------------------------------------------------------</span>
00220 <span class="comment">//   downAlt</span>
00221 <span class="comment">//    nächst niedrige Note in Chord oder Element im</span>
00222 <span class="comment">//    nächsten Staff selektieren</span>
00223 <span class="comment">//---------------------------------------------------------</span>
00224 
<a name="l00225"></a><a class="code" href="classScore.html#d19">00225</a> <a class="code" href="classNote.html">Note</a>* <a class="code" href="classScore.html#d19">Score::downAlt</a>(<a class="code" href="classElement.html">Element</a>* element)
00226       {
00227       <a class="code" href="classElement.html">Element</a>* re = 0;
00228       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a5">staves</a> = <a class="code" href="classScore.html#a6">nstaves</a>();
00229       <span class="keywordflow">if</span> (element-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a26">REST</a>) {
00230             <span class="keywordflow">if</span> ((<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>+1) &gt;= staves)
00231                   <span class="keywordflow">return</span> 0;
00232             ++(<a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>);
00233             re = <a class="code" href="classScore.html#a57">searchNote</a>(((<a class="code" href="classRest.html">Rest</a>*)element)-&gt;tick(), <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>);
00234             }
00235       <span class="keywordflow">else</span> {
00236             <span class="comment">// find segment</span>
00237             <a class="code" href="classChord.html">Chord</a>* chord     = ((<a class="code" href="classNote.html">Note</a>*) element)-&gt;chord();
00238             <a class="code" href="classSegment.html">Segment</a>* segment = chord-&gt;<a class="code" href="classChordRest.html#a4">segment</a>();
00239 
00240             <span class="comment">// collect all notes for this segment in noteList:</span>
00241             <a class="code" href="classNoteList.html">NoteList</a> rnl;
00242             <a class="code" href="note_8h.html#a1">iNote</a> inote = rnl.end();
00243             <span class="keywordtype">int</span> tracks = staves * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00244             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00245                   <a class="code" href="classElement.html">Element</a>* el = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00246                   <span class="keywordflow">if</span> (!el || el-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00247                         <span class="keywordflow">continue</span>;
00248                   <a class="code" href="classNoteList.html">NoteList</a>* nl = ((<a class="code" href="classChord.html">Chord</a>*)el)-&gt;noteList();
00249                   <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a2">riNote</a> in   = nl-&gt;rbegin(); in != nl-&gt;rend(); ++in) {
00250                         <a class="code" href="classNote.html">Note</a>* note = in-&gt;second;
00251                         <a class="code" href="note_8h.html#a1">iNote</a> ii = rnl.<a class="code" href="classNoteList.html#a0">add</a>(note);
00252                         <span class="keywordflow">if</span> (note == element) {
00253                               inote = ii;
00254                               }
00255                         }
00256                   }
00257             <span class="keywordflow">if</span> (inote != rnl.end()) {
00258                   <span class="keywordflow">if</span> (inote != rnl.begin()) {
00259                         inote--;
00260                         re = inote-&gt;second;
00261                         }
00262                   }
00263             }
00264 
00265       <span class="keywordflow">if</span> (re == 0)
00266             <span class="keywordflow">return</span> 0;
00267       <span class="keywordflow">if</span> (re-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00268             re = ((<a class="code" href="classChord.html">Chord</a>*)re)-&gt;noteList()-&gt;back();
00269       <span class="keywordflow">return</span> (<a class="code" href="classNote.html">Note</a>*)re;
00270       }
00271 
00272 <span class="comment">//---------------------------------------------------------</span>
00273 <span class="comment">//   downAltCtrl</span>
00274 <span class="comment">//    niedrigste Note in Chord selektieren</span>
00275 <span class="comment">//---------------------------------------------------------</span>
00276 
<a name="l00277"></a><a class="code" href="classScore.html#d20">00277</a> <a class="code" href="classNote.html">Note</a>* <a class="code" href="classScore.html#d20">Score::downAltCtrl</a>(<a class="code" href="classNote.html">Note</a>* note)<span class="keyword"> const</span>
00278 <span class="keyword">      </span>{
00279       <a class="code" href="classChord.html">Chord</a>* chord = note-&gt;<a class="code" href="classNote.html#a37">chord</a>();
00280       <a class="code" href="classNoteList.html">NoteList</a>* nl  = chord-&gt;<a class="code" href="classChord.html#a15">noteList</a>();
00281       <span class="keywordflow">return</span> nl-&gt;begin()-&gt;second;
00282       }
00283 
00284 <span class="comment">//---------------------------------------------------------</span>
00285 <span class="comment">//   nextChordRest</span>
00286 <span class="comment">//    return next NOTE or REST</span>
00287 <span class="comment">//    element - current element</span>
00288 <span class="comment">//---------------------------------------------------------</span>
00289 
<a name="l00290"></a><a class="code" href="classScore.html#d0">00290</a> <a class="code" href="classChordRest.html">ChordRest</a>* <a class="code" href="classScore.html#d0">Score::nextChordRest</a>(<a class="code" href="classChordRest.html">ChordRest</a>* element)
00291       {
00292       <span class="keywordflow">if</span> (!element)
00293             <span class="keywordflow">return</span> 0;
00294 
00295       <a class="code" href="classElement.html">Element</a>* pel = (<a class="code" href="classChordRest.html">ChordRest</a>*)element;
00296       <a class="code" href="classSegment.html">Segment</a>* seg = element-&gt;<a class="code" href="classChordRest.html#a4">segment</a>();
00297 
00298       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = element-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00299       <span class="keywordtype">int</span> strack = staff * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00300       <span class="keywordtype">int</span> etrack = strack + <a class="code" href="globals_8h.html#a3">VOICES</a>;
00301 
00302       <span class="keywordflow">for</span> (;;) {
00303             seg = seg-&gt;<a class="code" href="classSegment.html#a6">next1</a>();
00304             <span class="keywordflow">if</span> (!seg)
00305                   <span class="keywordflow">break</span>;
00306             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = strack; track &lt; etrack; ++track) {
00307                   pel = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00308                   <span class="keywordflow">if</span> (pel &amp;&amp; pel-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>())
00309                         <span class="keywordflow">return</span> (<a class="code" href="classChordRest.html">ChordRest</a>*) pel;
00310                   }
00311             }
00312       <span class="keywordflow">return</span> 0;
00313       }
00314 
00315 <span class="comment">//---------------------------------------------------------</span>
00316 <span class="comment">//   prevChordRest</span>
00317 <span class="comment">//    return previous Chord or Rest</span>
00318 <span class="comment">//---------------------------------------------------------</span>
00319 
<a name="l00320"></a><a class="code" href="classScore.html#d1">00320</a> <a class="code" href="classChordRest.html">ChordRest</a>* <a class="code" href="classScore.html#d1">Score::prevChordRest</a>(<a class="code" href="classChordRest.html">ChordRest</a>* element)
00321       {
00322       <span class="keywordflow">if</span> (!element)
00323             <span class="keywordflow">return</span> 0;
00324 
00325       <a class="code" href="classMeasure.html">Measure</a>* measure = element-&gt;<a class="code" href="classChordRest.html#a11">measure</a>();
00326       <a class="code" href="classSegment.html">Segment</a>* seg     = element-&gt;<a class="code" href="classChordRest.html#a4">segment</a>();
00327       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a>        = element-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00328 
00329       seg = seg-&gt;<a class="code" href="classSegment.html#a5">prev</a>();
00330       <span class="keywordflow">for</span> (;;) {
00331             <span class="keywordflow">while</span> (seg) {
00332                   <span class="keywordtype">int</span> strack = staff * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00333                   <span class="keywordtype">int</span> etrack = strack + <a class="code" href="globals_8h.html#a3">VOICES</a>;
00334                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = strack; track &lt; etrack; ++track) {
00335                         <a class="code" href="classElement.html">Element</a>* el = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00336                         <span class="keywordflow">if</span> (el &amp;&amp; el-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>())
00337                               <span class="keywordflow">return</span> (<a class="code" href="classChordRest.html">ChordRest</a>*) el;
00338                         }
00339                   seg = seg-&gt;<a class="code" href="classSegment.html#a5">prev</a>();
00340                   }
00341             measure = measure-&gt;<a class="code" href="classMeasure.html#a65">prev</a>();
00342             <span class="keywordflow">if</span> (measure == 0)
00343                   <span class="keywordflow">break</span>;
00344             seg = measure-&gt;<a class="code" href="classMeasure.html#a29">last</a>();
00345             }
00346       <span class="keywordflow">return</span> 0;
00347       }
00348 
00349 <span class="comment">//---------------------------------------------------------</span>
00350 <span class="comment">//   nextMeasure</span>
00351 <span class="comment">//---------------------------------------------------------</span>
00352 
<a name="l00353"></a><a class="code" href="classScore.html#d2">00353</a> <a class="code" href="classChordRest.html">ChordRest</a>* <a class="code" href="classScore.html#d2">Score::nextMeasure</a>(<a class="code" href="classChordRest.html">ChordRest</a>* element)
00354       {
00355       <span class="keywordflow">if</span> (!element)
00356             <span class="keywordflow">return</span> 0;
00357 
00358       <a class="code" href="classMeasure.html">Measure</a>* measure = element-&gt;<a class="code" href="classChordRest.html#a11">measure</a>()-&gt;<a class="code" href="classMeasure.html#a64">next</a>();
00359       <span class="keywordflow">if</span> (!measure)
00360             <span class="keywordflow">return</span> 0;
00361       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = element-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00362 
00363       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = measure-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00364             <span class="keywordtype">int</span> etrack = (staff+1) * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00365             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = staff * <a class="code" href="globals_8h.html#a3">VOICES</a>; track &lt; etrack; ++track) {
00366                   <a class="code" href="classElement.html">Element</a>* pel = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00367 
00368                   <span class="keywordflow">if</span> (pel &amp;&amp; pel-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>())
00369                         <span class="keywordflow">return</span> (<a class="code" href="classChordRest.html">ChordRest</a>*)pel;
00370                   }
00371             }
00372       <span class="keywordflow">return</span> 0;
00373       }
00374 
00375 <span class="comment">//---------------------------------------------------------</span>
00376 <span class="comment">//   prevMeasure</span>
00377 <span class="comment">//---------------------------------------------------------</span>
00378 
<a name="l00379"></a><a class="code" href="classScore.html#d3">00379</a> <a class="code" href="classChordRest.html">ChordRest</a>* <a class="code" href="classScore.html#d3">Score::prevMeasure</a>(<a class="code" href="classChordRest.html">ChordRest</a>* element)
00380       {
00381       <span class="keywordflow">if</span> (!element)
00382             <span class="keywordflow">return</span> 0;
00383 
00384       <a class="code" href="classMeasure.html">Measure</a>* measure = element-&gt;<a class="code" href="classChordRest.html#a11">measure</a>()-&gt;<a class="code" href="classMeasure.html#a65">prev</a>();
00385       <span class="keywordflow">if</span> (!measure)
00386             <span class="keywordflow">return</span> 0;
00387       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = element-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00388 
00389       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = measure-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00390             <span class="keywordtype">int</span> etrack = (staff+1) * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00391             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = staff * <a class="code" href="globals_8h.html#a3">VOICES</a>; track &lt; etrack; ++track) {
00392                   <a class="code" href="classElement.html">Element</a>* pel = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00393 
00394                   <span class="keywordflow">if</span> (pel &amp;&amp; pel-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>())
00395                         <span class="keywordflow">return</span> (<a class="code" href="classChordRest.html">ChordRest</a>*)pel;
00396                   }
00397             }
00398       <span class="keywordflow">return</span> 0;
00399       }
00400 
00401 <span class="comment">//---------------------------------------------------------</span>
00402 <span class="comment">//   adjustCanvasPosition</span>
00403 <span class="comment">//---------------------------------------------------------</span>
00404 
<a name="l00405"></a><a class="code" href="classScore.html#a105">00405</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a105">Score::adjustCanvasPosition</a>(<a class="code" href="classElement.html">Element</a>* el)
00406       {
00407       QPointF p(el-&gt;<a class="code" href="classElement.html#a35">apos</a>());
00408       QRectF r(<a class="code" href="classScore.html#a46">canvas</a>()-&gt;geometry());
00409       <span class="keywordflow">if</span> (r.contains(p))
00410             <span class="keywordflow">return</span>;
00411       <a class="code" href="classMeasure.html">Measure</a>* m;
00412       <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>)
00413             m = ((<a class="code" href="classNote.html">Note</a>*)el)-&gt;chord()-&gt;segment()-&gt;measure();
00414       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a26">REST</a>)
00415             m = ((<a class="code" href="classRest.html">Rest</a>*)el)-&gt;segment()-&gt;measure();
00416       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a44">SEGMENT</a>)
00417             m = ((<a class="code" href="classSegment.html">Segment</a>*)el)-&gt;measure();
00418       <span class="keywordflow">else</span>
00419             <span class="keywordflow">return</span>;
00420 
00421       qreal deltax = 0;
00422       qreal deltay = 0;
00423       qreal mx1 = m-&gt;<a class="code" href="classElement.html#a35">apos</a>().x();
00424       qreal mx2 = m-&gt;<a class="code" href="classElement.html#a35">apos</a>().x() + m-&gt;<a class="code" href="classElement.html#a37">width</a>();
00425 
00426       <span class="comment">//TODO handle special cases:</span>
00427       <span class="comment">//    - canvas smaller than measure</span>
00428 
00429       <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> BORDER = 10;
00430       <span class="keywordflow">if</span> (p.x() &lt; r.x()) {
00431             <span class="comment">// move right</span>
00432             <span class="comment">// move left edge of measure to left edge of canvas</span>
00433             deltax = r.x() - mx1 + BORDER;
00434             }
00435       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p.x() &gt; (r.x() + r.width())) {
00436             <span class="comment">// move left</span>
00437             <span class="comment">// move right edge of measure to right edge of canvas</span>
00438             deltax = (r.x() + r.width()) - mx2 - BORDER;
00439             }
00440       <span class="keywordflow">if</span> (p.y() &lt; r.y() || p.y() &gt; (r.y() + r.height()))
00441             deltay = r.y() - p.y();
00442 <span class="comment">//      t-&gt;xoffset += deltax;</span>
00443 <span class="comment">//      t-&gt;yoffset += deltay;</span>
00444       <a class="code" href="classScore.html#r3">updateAll</a> = <span class="keyword">true</span>;
00445       }
00446 
00447 <span class="comment">//---------------------------------------------------------</span>
00448 <span class="comment">//   pageNext</span>
00449 <span class="comment">//---------------------------------------------------------</span>
00450 
<a name="l00451"></a><a class="code" href="classScore.html#d13">00451</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#d13">Score::pageNext</a>()
00452       {
00453 <span class="preprocessor">#if 0</span>
00454 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o12">pages</a>-&gt;empty())
00455             <span class="keywordflow">return</span>;
00456       <a class="code" href="classPage.html">Page</a>* page = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00457       Transformation* t = <a class="code" href="classScore.html#a46">canvas</a>()-&gt;transformation();
00458       <span class="keywordtype">int</span> dx = t-&gt;rdot2pixel(page-&gt;<a class="code" href="classElement.html#a37">width</a>());
00459 
00460       t-&gt;xoffset -= dx;
00461       t-&gt;yoffset = 0;
00462       <a class="code" href="classScore.html#r3">updateAll</a> = <span class="keyword">true</span>;
00463 <span class="preprocessor">#endif</span>
00464 <span class="preprocessor"></span>      }
00465 
00466 <span class="comment">//---------------------------------------------------------</span>
00467 <span class="comment">//   pagePrev</span>
00468 <span class="comment">//---------------------------------------------------------</span>
00469 
<a name="l00470"></a><a class="code" href="classScore.html#d14">00470</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#d14">Score::pagePrev</a>()
00471       {
00472 <span class="preprocessor">#if 0</span>
00473 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o12">pages</a>-&gt;empty())
00474             <span class="keywordflow">return</span>;
00475       <a class="code" href="classPage.html">Page</a>* page = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00476       Transformation* t = <a class="code" href="classScore.html#a46">canvas</a>()-&gt;transformation();
00477       <span class="keywordtype">int</span> dx = t-&gt;rdot2pixel(page-&gt;<a class="code" href="classElement.html#a37">width</a>());
00478       t-&gt;xoffset += dx;
00479       <span class="keywordflow">if</span> (t-&gt;xoffset &gt; 0)
00480             t-&gt;xoffset = 0;
00481       t-&gt;yoffset = 0;
00482       <a class="code" href="classScore.html#r3">updateAll</a> = <span class="keyword">true</span>;
00483 <span class="preprocessor">#endif</span>
00484 <span class="preprocessor"></span>      }
00485 
00486 <span class="comment">//---------------------------------------------------------</span>
00487 <span class="comment">//   pageTop</span>
00488 <span class="comment">//---------------------------------------------------------</span>
00489 
<a name="l00490"></a><a class="code" href="classScore.html#d15">00490</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#d15">Score::pageTop</a>()
00491       {
00492 <span class="preprocessor">#if 0</span>
00493 <span class="preprocessor"></span>      Transformation* t = <a class="code" href="classScore.html#a46">canvas</a>()-&gt;transformation();
00494       t-&gt;xoffset = 0;
00495       t-&gt;yoffset = 0;
00496       <a class="code" href="classScore.html#r3">updateAll</a> = <span class="keyword">true</span>;
00497 <span class="preprocessor">#endif</span>
00498 <span class="preprocessor"></span>      }
00499 
00500 <span class="comment">//---------------------------------------------------------</span>
00501 <span class="comment">//   pageEnd</span>
00502 <span class="comment">//---------------------------------------------------------</span>
00503 
<a name="l00504"></a><a class="code" href="classScore.html#d16">00504</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#d16">Score::pageEnd</a>()
00505       {
00506 <span class="preprocessor">#if 0</span>
00507 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o12">pages</a>-&gt;empty())
00508             <span class="keywordflow">return</span>;
00509       <a class="code" href="classPage.html">Page</a>* lastPage = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00510       Transformation* t = <a class="code" href="classScore.html#a46">canvas</a>()-&gt;transformation();
00511       QPoint p(t-&gt;fpos2ipoint(lastPage-&gt;<a class="code" href="classElement.html#a35">apos</a>()));
00512       t-&gt;xoffset += -p.x();
00513       t-&gt;yoffset = 0;
00514       <a class="code" href="classScore.html#r3">updateAll</a> = <span class="keyword">true</span>;
00515 <span class="preprocessor">#endif</span>
00516 <span class="preprocessor"></span>      }
00517 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
