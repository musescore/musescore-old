<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: jackaudio.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>jackaudio.cpp</h1><a href="jackaudio_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MusE Score</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: jackaudio.cpp,v 1.2 2005/02/26 09:52:49 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="jackaudio_8h.html">jackaudio.h</a>"</span>
00010 
00011 <span class="preprocessor">#ifdef USE_JACK</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="preferences_8h.html">preferences.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="synti_8h.html">synti.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="seq_8h.html">seq.h</a>"</span>
00017 
00018 <span class="comment">//---------------------------------------------------------</span>
00019 <span class="comment">//   jack_thread_init</span>
00020 <span class="comment">//---------------------------------------------------------</span>
00021 
<a name="l00022"></a><a class="code" href="jackaudio_8cpp.html#a0">00022</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="jackaudio_8cpp.html#a0">jack_thread_init</a> (<span class="keywordtype">void</span>* <span class="comment">/*data*/</span>)
00023       {
00024       <span class="keywordflow">if</span> (<a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a12">isRealtime</a>()) {
00025             <span class="keyword">struct </span>sched_param rt_param;
00026             <span class="keywordtype">int</span> rv;
00027             memset(&amp;rt_param, 0, <span class="keyword">sizeof</span>(sched_param));
00028             <span class="keywordtype">int</span> type;
00029             rv = pthread_getschedparam(pthread_self(), &amp;type, &amp;rt_param);
00030             <span class="keywordflow">if</span> (rv == -1)
00031                   perror(<span class="stringliteral">"get scheduler parameter"</span>);
00032             <span class="keywordflow">if</span> (type != SCHED_FIFO) {
00033                   fprintf(stderr, <span class="stringliteral">"JACK thread not running SCHED_FIFO, try to set...\n"</span>);
00034 
00035                   memset(&amp;rt_param, 0, <span class="keyword">sizeof</span>(sched_param));
00036                   rt_param.sched_priority = 1;
00037                   rv = pthread_setschedparam(pthread_self(), SCHED_FIFO, &amp;rt_param);
00038                   <span class="keywordflow">if</span> (rv == -1)
00039                         perror(<span class="stringliteral">"set realtime scheduler"</span>);
00040                   memset(&amp;rt_param, 0, <span class="keyword">sizeof</span>(sched_param));
00041                   rv = pthread_getschedparam(pthread_self(), &amp;type, &amp;rt_param);
00042                   <span class="keywordflow">if</span> (rv == -1)
00043                         perror(<span class="stringliteral">"get scheduler parameter"</span>);
00044                   <span class="keywordflow">if</span> (type != SCHED_FIFO)
00045                         fprintf(stderr, <span class="stringliteral">"JACK still not running FIFO !?!\n"</span>
00046                         <span class="stringliteral">"======reliable RT operation not possible!!======\n"</span>);
00047                   <span class="keywordflow">else</span>
00048                         fprintf(stderr, <span class="stringliteral">"JACK thread succesfully set to SCHED_FIFO\n"</span>);
00049                   }
00050             }
00051       }
00052 
00053 <span class="comment">//---------------------------------------------------------</span>
00054 <span class="comment">//   JackAudio</span>
00055 <span class="comment">//---------------------------------------------------------</span>
00056 
<a name="l00057"></a><a class="code" href="classJackAudio.html#a0">00057</a> <a class="code" href="classJackAudio.html#a0">JackAudio::JackAudio</a>()
00058    : <a class="code" href="classAudio.html">Audio</a>()
00059       {
00060       <a class="code" href="classJackAudio.html#r2">client</a> = 0;
00061       }
00062 
00063 <span class="comment">//---------------------------------------------------------</span>
00064 <span class="comment">//   ~JackAudio</span>
00065 <span class="comment">//---------------------------------------------------------</span>
00066 
<a name="l00067"></a><a class="code" href="classJackAudio.html#a1">00067</a> <a class="code" href="classJackAudio.html#a1">JackAudio::~JackAudio</a>()
00068       {
00069       <span class="keywordflow">if</span> (<a class="code" href="classJackAudio.html#r2">client</a>) {
00070             <span class="keywordflow">if</span> (jack_client_close(<a class="code" href="classJackAudio.html#r2">client</a>)) {
00071                   fprintf(stderr, <span class="stringliteral">"jack_client_close() failed: %s\n"</span>,
00072                      strerror(errno));
00073                   }
00074             }
00075       }
00076 
00077 <span class="comment">//---------------------------------------------------------</span>
00078 <span class="comment">//   registerPort</span>
00079 <span class="comment">//---------------------------------------------------------</span>
00080 
<a name="l00081"></a><a class="code" href="classJackAudio.html#a3">00081</a> <span class="keywordtype">void</span>* <a class="code" href="classJackAudio.html#a3">JackAudio::registerPort</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* name)
00082       {
00083       <span class="keywordflow">return</span> jack_port_register(<a class="code" href="classJackAudio.html#r2">client</a>, name, JACK_DEFAULT_AUDIO_TYPE, JackPortIsInput, 0);
00084       }
00085 
00086 <span class="comment">//---------------------------------------------------------</span>
00087 <span class="comment">//   unregisterPort</span>
00088 <span class="comment">//---------------------------------------------------------</span>
00089 
<a name="l00090"></a><a class="code" href="classJackAudio.html#a4">00090</a> <span class="keywordtype">void</span> <a class="code" href="classJackAudio.html#a4">JackAudio::unregisterPort</a>(<span class="keywordtype">void</span>* p)
00091       {
00092       jack_port_unregister(<a class="code" href="classJackAudio.html#r2">client</a>, (jack_port_t*)p);
00093       }
00094 
00095 <span class="comment">//---------------------------------------------------------</span>
00096 <span class="comment">//   inputPorts</span>
00097 <span class="comment">//---------------------------------------------------------</span>
00098 
<a name="l00099"></a><a class="code" href="classJackAudio.html#a5">00099</a> std::list&lt;QString&gt; <a class="code" href="classJackAudio.html#a5">JackAudio::inputPorts</a>()
00100       {
00101       <span class="keyword">const</span> <span class="keywordtype">char</span>** ports = jack_get_ports(<a class="code" href="classJackAudio.html#r2">client</a>, 0, 0, 0);
00102       std::list&lt;QString&gt; clientList;
00103       <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keywordtype">char</span>** p = ports; p &amp;&amp; *p; ++p) {
00104             jack_port_t* port = jack_port_by_name(<a class="code" href="classJackAudio.html#r2">client</a>, *p);
00105             <span class="keywordtype">int</span> flags = jack_port_flags(port);
00106             <span class="keywordflow">if</span> (!(flags &amp; JackPortIsInput))
00107                   <span class="keywordflow">continue</span>;
00108             <span class="keywordtype">char</span> buffer[128];
00109             strncpy(buffer, *p, 128);
00110             <span class="keywordflow">if</span> (strncmp(buffer, <span class="stringliteral">"Mscore"</span>, 6) == 0)
00111                   <span class="keywordflow">continue</span>;
00112             clientList.push_back(QString(buffer));
00113             }
00114       <span class="keywordflow">return</span> clientList;
00115       }
00116 
00117 <span class="comment">//---------------------------------------------------------</span>
00118 <span class="comment">//   connect</span>
00119 <span class="comment">//---------------------------------------------------------</span>
00120 
<a name="l00121"></a><a class="code" href="classJackAudio.html#a9">00121</a> <span class="keywordtype">void</span> <a class="code" href="classJackAudio.html#a9">JackAudio::connect</a>(<span class="keywordtype">void</span>* src, <span class="keywordtype">void</span>* dst)
00122       {
00123       <span class="keyword">const</span> <span class="keywordtype">char</span>* sn = jack_port_name((jack_port_t*) src);
00124       <span class="keyword">const</span> <span class="keywordtype">char</span>* dn = jack_port_name((jack_port_t*) dst);
00125       <span class="keywordflow">if</span> (sn == 0 || dn == 0) {
00126             fprintf(stderr, <span class="stringliteral">"JackAudio::connect: unknown jack ports\n"</span>);
00127             <span class="keywordflow">return</span>;
00128             }
00129       <span class="keywordflow">if</span> (jack_connect(<a class="code" href="classJackAudio.html#r2">client</a>, sn, dn)) {
00130             fprintf(stderr, <span class="stringliteral">"jack connect &lt;%s&gt;%p - &lt;%s&gt;%p failed\n"</span>,
00131                sn, src, dn, dst);
00132             }
00133       }
00134 
00135 <span class="comment">//---------------------------------------------------------</span>
00136 <span class="comment">//   disconnect</span>
00137 <span class="comment">//---------------------------------------------------------</span>
00138 
<a name="l00139"></a><a class="code" href="classJackAudio.html#a10">00139</a> <span class="keywordtype">void</span> <a class="code" href="classJackAudio.html#a10">JackAudio::disconnect</a>(<span class="keywordtype">void</span>* src, <span class="keywordtype">void</span>* dst)
00140       {
00141       <span class="keyword">const</span> <span class="keywordtype">char</span>* sn = jack_port_name((jack_port_t*) src);
00142       <span class="keyword">const</span> <span class="keywordtype">char</span>* dn = jack_port_name((jack_port_t*) dst);
00143       <span class="keywordflow">if</span> (sn == 0 || dn == 0) {
00144             fprintf(stderr, <span class="stringliteral">"JackAudio::disconnect: unknown jack ports\n"</span>);
00145             <span class="keywordflow">return</span>;
00146             }
00147       <span class="keywordflow">if</span> (jack_disconnect(<a class="code" href="classJackAudio.html#r2">client</a>, sn, dn)) {
00148             fprintf(stderr, <span class="stringliteral">"jack disconnect &lt;%s&gt; - &lt;%s&gt; failed\n"</span>,
00149                sn, dn);
00150             }
00151       }
00152 
00153 <span class="comment">//---------------------------------------------------------</span>
00154 <span class="comment">//   start</span>
00155 <span class="comment">//---------------------------------------------------------</span>
00156 
<a name="l00157"></a><a class="code" href="classJackAudio.html#a6">00157</a> <span class="keywordtype">bool</span> <a class="code" href="classJackAudio.html#a6">JackAudio::start</a>()
00158       {
00159       <span class="keywordflow">if</span> (jack_activate(<a class="code" href="classJackAudio.html#r2">client</a>)) {
00160             fprintf (stderr, <span class="stringliteral">"JACK: cannot activate client\n"</span>);
00161             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00162             }
00163       <span class="comment">/* connect the ports. Note: you can't do this before</span>
00164 <span class="comment">         the client is activated, because we can't allow</span>
00165 <span class="comment">         connections to be made to clients that aren't</span>
00166 <span class="comment">         running.</span>
00167 <span class="comment">       */</span>
00168       QString lport = <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o13">lPort</a>;
00169       QString rport = <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o14">rPort</a>;
00170 
00171       <span class="keyword">const</span> <span class="keywordtype">char</span>* src = jack_port_name(<a class="code" href="classJackAudio.html#r5">portL</a>);
00172       <span class="keywordtype">int</span> rv;
00173       rv = jack_connect(<a class="code" href="classJackAudio.html#r2">client</a>, src, lport.latin1());
00174       <span class="keywordflow">if</span> (rv) {
00175             fprintf(stderr, <span class="stringliteral">"jack connect &lt;%s&gt; - &lt;%s&gt; failed: %d\n"</span>,
00176                src, lport.latin1(), rv);
00177             }
00178       src = jack_port_name(<a class="code" href="classJackAudio.html#r4">portR</a>);
00179       <span class="keywordflow">if</span> (!rport.isEmpty()) {
00180             <span class="keywordflow">if</span> (jack_connect(<a class="code" href="classJackAudio.html#r2">client</a>, src, rport.latin1())) {
00181                   fprintf(stderr, <span class="stringliteral">"jack connect &lt;%s&gt; - &lt;%s&gt; failed\n"</span>,
00182                      src, rport.latin1());
00183                   }
00184             }
00185       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00186       }
00187 
00188 <span class="comment">//---------------------------------------------------------</span>
00189 <span class="comment">//   stop</span>
00190 <span class="comment">//---------------------------------------------------------</span>
00191 
<a name="l00192"></a><a class="code" href="classJackAudio.html#a7">00192</a> <span class="keywordtype">bool</span> <a class="code" href="classJackAudio.html#a7">JackAudio::stop</a>()
00193       {
00194       <span class="keywordflow">if</span> (jack_deactivate(<a class="code" href="classJackAudio.html#r2">client</a>)) {
00195             fprintf (stderr, <span class="stringliteral">"cannot deactivate client"</span>);
00196             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00197             }
00198       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00199       }
00200 
00201 <span class="comment">//---------------------------------------------------------</span>
00202 <span class="comment">//   framePos</span>
00203 <span class="comment">//---------------------------------------------------------</span>
00204 
<a name="l00205"></a><a class="code" href="classJackAudio.html#a8">00205</a> <span class="keywordtype">int</span> <a class="code" href="classJackAudio.html#a8">JackAudio::framePos</a>()<span class="keyword"> const</span>
00206 <span class="keyword">      </span>{
00207       jack_nframes_t n = jack_frame_time(<a class="code" href="classJackAudio.html#r2">client</a>);
00208       <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)n;
00209       }
00210 
00211 
<a name="l00212"></a><a class="code" href="jackaudio_8cpp.html#a1">00212</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="jackaudio_8cpp.html#a1">bufsize_callback</a>(jack_nframes_t n, <span class="keywordtype">void</span>*)
00213       {
00214       printf(<span class="stringliteral">"JACK: buffersize changed %d\n"</span>, n);
00215       <span class="keywordflow">return</span> 0;
00216       }
00217 
00218 <span class="comment">//---------------------------------------------------------</span>
00219 <span class="comment">//   freewheel_callback</span>
00220 <span class="comment">//---------------------------------------------------------</span>
00221 
<a name="l00222"></a><a class="code" href="jackaudio_8cpp.html#a2">00222</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="jackaudio_8cpp.html#a2">freewheel_callback</a>(<span class="keywordtype">int</span> <span class="comment">/*starting*/</span>, <span class="keywordtype">void</span>*)
00223       {
00224       }
00225 
<a name="l00226"></a><a class="code" href="jackaudio_8cpp.html#a3">00226</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="jackaudio_8cpp.html#a3">srate_callback</a>(jack_nframes_t, <span class="keywordtype">void</span>*)
00227       {
00228 <span class="comment">//      printf("JACK: sample rate changed: %d\n", n);</span>
00229       <span class="keywordflow">return</span> 0;
00230       }
00231 
<a name="l00232"></a><a class="code" href="jackaudio_8cpp.html#a4">00232</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="jackaudio_8cpp.html#a4">registration_callback</a>(jack_port_id_t, <span class="keywordtype">int</span>, <span class="keywordtype">void</span>*)
00233       {
00234       printf(<span class="stringliteral">"JACK: registration changed\n"</span>);
00235       }
00236 
<a name="l00237"></a><a class="code" href="jackaudio_8cpp.html#a5">00237</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="jackaudio_8cpp.html#a5">graph_callback</a>(<span class="keywordtype">void</span>*)
00238       {
00239 <span class="comment">//      printf("JACK: graph changed\n");</span>
00240       <span class="keywordflow">return</span> 0;
00241       }
00242 
00243 <span class="comment">//---------------------------------------------------------</span>
00244 <span class="comment">//   processAudio</span>
00245 <span class="comment">//    JACK callback</span>
00246 <span class="comment">//---------------------------------------------------------</span>
00247 
<a name="l00248"></a><a class="code" href="jackaudio_8cpp.html#a6">00248</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="jackaudio_8cpp.html#a6">processAudio</a>(jack_nframes_t frames, <span class="keywordtype">void</span>*)
00249       {
00250       <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a6">process</a>((<span class="keywordtype">unsigned</span>)frames);
00251       <span class="keywordflow">return</span> 0;
00252       }
00253 
00254 <span class="comment">//---------------------------------------------------------</span>
00255 <span class="comment">//   processShutdown</span>
00256 <span class="comment">//---------------------------------------------------------</span>
00257 
<a name="l00258"></a><a class="code" href="jackaudio_8cpp.html#a7">00258</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="jackaudio_8cpp.html#a7">processShutdown</a>(<span class="keywordtype">void</span>*)
00259       {
00260       fprintf(stderr, <span class="stringliteral">"JACK SHUTDOWN\n"</span>);
00261       }
00262 
00263 <span class="comment">//---------------------------------------------------------</span>
00264 <span class="comment">//   jackError</span>
00265 <span class="comment">//---------------------------------------------------------</span>
00266 
<a name="l00267"></a><a class="code" href="jackaudio_8cpp.html#a8">00267</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="jackaudio_8cpp.html#a8">jackError</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s)
00268       {
00269       fprintf(stderr, <span class="stringliteral">"JACK ERROR: %s\n"</span>, s);
00270       }
00271 
00272 <span class="comment">//---------------------------------------------------------</span>
00273 <span class="comment">//   noJackError</span>
00274 <span class="comment">//---------------------------------------------------------</span>
00275 
<a name="l00276"></a><a class="code" href="jackaudio_8cpp.html#a9">00276</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="jackaudio_8cpp.html#a9">noJackError</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="comment">/* s */</span>)
00277       {
00278       }
00279 
00280 <span class="comment">//---------------------------------------------------------</span>
00281 <span class="comment">//   register</span>
00282 <span class="comment">//---------------------------------------------------------</span>
00283 
<a name="l00284"></a><a class="code" href="classJackAudio.html#d0">00284</a> <span class="keywordtype">void</span> <a class="code" href="classJackAudio.html#d0">JackAudio::registerClient</a>()
00285       {
00286       jack_set_process_callback(<a class="code" href="classJackAudio.html#r2">client</a>, <a class="code" href="jackaudio_8cpp.html#a6">processAudio</a>, 0);
00287       jack_on_shutdown(<a class="code" href="classJackAudio.html#r2">client</a>, <a class="code" href="jackaudio_8cpp.html#a7">processShutdown</a>, 0);
00288       jack_set_buffer_size_callback(<a class="code" href="classJackAudio.html#r2">client</a>, <a class="code" href="jackaudio_8cpp.html#a1">bufsize_callback</a>, 0);
00289       jack_set_sample_rate_callback(<a class="code" href="classJackAudio.html#r2">client</a>, <a class="code" href="jackaudio_8cpp.html#a3">srate_callback</a>, 0);
00290       jack_set_port_registration_callback(<a class="code" href="classJackAudio.html#r2">client</a>, <a class="code" href="jackaudio_8cpp.html#a4">registration_callback</a>, 0);
00291       jack_set_graph_order_callback(<a class="code" href="classJackAudio.html#r2">client</a>, <a class="code" href="jackaudio_8cpp.html#a5">graph_callback</a>, 0);
00292       jack_set_freewheel_callback (<a class="code" href="classJackAudio.html#r2">client</a>, <a class="code" href="jackaudio_8cpp.html#a2">freewheel_callback</a>, 0);
00293       }
00294 
00295 <span class="comment">//---------------------------------------------------------</span>
00296 <span class="comment">//   init</span>
00297 <span class="comment">//    return true on error</span>
00298 <span class="comment">//---------------------------------------------------------</span>
00299 
<a name="l00300"></a><a class="code" href="classJackAudio.html#a2">00300</a> <span class="keywordtype">bool</span> <a class="code" href="classJackAudio.html#a2">JackAudio::init</a>()
00301       {
00302       jack_set_error_function(<a class="code" href="jackaudio_8cpp.html#a9">noJackError</a>);
00303 
00304       <a class="code" href="classJackAudio.html#r5">portL</a> = 0;
00305       <a class="code" href="classJackAudio.html#r4">portR</a> = 0;
00306       <a class="code" href="classJackAudio.html#r2">client</a> = 0;
00307       <span class="keywordtype">int</span> i = 0;
00308       <span class="keywordflow">for</span> (i = 0; i &lt; 5; ++i) {
00309             sprintf(<a class="code" href="classJackAudio.html#r3">_jackName</a>, <span class="stringliteral">"Mscore%d"</span>, i+1);
00310             <a class="code" href="classJackAudio.html#r2">client</a> = jack_client_new(<a class="code" href="classJackAudio.html#r3">_jackName</a>);
00311             <span class="keywordflow">if</span> (<a class="code" href="classJackAudio.html#r2">client</a>)
00312                   <span class="keywordflow">break</span>;
00313             }
00314       <span class="keywordflow">if</span> (<a class="code" href="classJackAudio.html#r2">client</a> == 0)
00315             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00316       jack_set_error_function(<a class="code" href="jackaudio_8cpp.html#a8">jackError</a>);
00317       <a class="code" href="classJackAudio.html#d0">registerClient</a>();
00318       <a class="code" href="classJackAudio.html#r0">_sampleRate</a>   = jack_get_sample_rate(<a class="code" href="classJackAudio.html#r2">client</a>);
00319       <a class="code" href="classJackAudio.html#r1">_segmentSize</a>  = jack_get_buffer_size(<a class="code" href="classJackAudio.html#r2">client</a>);
00320       jack_set_thread_init_callback(<a class="code" href="classJackAudio.html#r2">client</a>, (JackThreadInitCallback) <a class="code" href="jackaudio_8cpp.html#a0">jack_thread_init</a>, 0);
00321 
00322       <span class="comment">// register mscore left/right output ports</span>
00323       <a class="code" href="classJackAudio.html#r5">portL</a> = jack_port_register(<a class="code" href="classJackAudio.html#r2">client</a>, <span class="stringliteral">"left"</span>,  JACK_DEFAULT_AUDIO_TYPE, JackPortIsOutput, 0);
00324       <a class="code" href="classJackAudio.html#r4">portR</a> = jack_port_register(<a class="code" href="classJackAudio.html#r2">client</a>, <span class="stringliteral">"right"</span>, JACK_DEFAULT_AUDIO_TYPE, JackPortIsOutput, 0);
00325 
00326       <span class="comment">// connect mscore output ports to jack input ports</span>
00327       QString lport = <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o13">lPort</a>;
00328       QString rport = <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o14">rPort</a>;
00329       std::list&lt;QString&gt; ports = <a class="code" href="classJackAudio.html#a5">inputPorts</a>();
00330       std::list&lt;QString&gt;::iterator pi = ports.begin();
00331       <span class="keywordflow">if</span> (lport.isEmpty()) {
00332             <span class="keywordflow">if</span> (pi != ports.end()) {
00333                   lport = *pi;
00334                   ++pi;
00335                   }
00336             <span class="keywordflow">else</span> {
00337                   fprintf(stderr, <span class="stringliteral">"no jack ports found\n"</span>);
00338                   jack_client_close(<a class="code" href="classJackAudio.html#r2">client</a>);
00339                   <a class="code" href="classJackAudio.html#r2">client</a> = 0;
00340                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00341                   }
00342             }
00343       <span class="keywordflow">if</span> (rport.isEmpty()) {
00344             <span class="keywordflow">if</span> (pi != ports.end())
00345                   rport = *pi;
00346             <span class="keywordflow">else</span> {
00347                   fprintf(stderr, <span class="stringliteral">"no jack port for right channel found!\n"</span>);
00348                   }
00349             }
00350       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00351       }
00352 
00353 <span class="comment">//---------------------------------------------------------</span>
00354 <span class="comment">//   startTrasnport</span>
00355 <span class="comment">//---------------------------------------------------------</span>
00356 
<a name="l00357"></a><a class="code" href="classJackAudio.html#a14">00357</a> <span class="keywordtype">void</span> <a class="code" href="classJackAudio.html#a14">JackAudio::startTransport</a>()
00358       {
00359       jack_transport_start(<a class="code" href="classJackAudio.html#r2">client</a>);
00360       }
00361 
00362 <span class="comment">//---------------------------------------------------------</span>
00363 <span class="comment">//   stopTrasnport</span>
00364 <span class="comment">//---------------------------------------------------------</span>
00365 
<a name="l00366"></a><a class="code" href="classJackAudio.html#a15">00366</a> <span class="keywordtype">void</span> <a class="code" href="classJackAudio.html#a15">JackAudio::stopTransport</a>()
00367       {
00368       jack_transport_stop(<a class="code" href="classJackAudio.html#r2">client</a>);
00369       }
00370 
00371 <span class="comment">//---------------------------------------------------------</span>
00372 <span class="comment">//   getState</span>
00373 <span class="comment">//---------------------------------------------------------</span>
00374 
<a name="l00375"></a><a class="code" href="classJackAudio.html#a16">00375</a> <span class="keywordtype">int</span> <a class="code" href="classJackAudio.html#a16">JackAudio::getState</a>()
00376       {
00377       jack_position_t pos;
00378       <span class="keywordtype">int</span> transportState = jack_transport_query(<a class="code" href="classJackAudio.html#r2">client</a>, &amp;pos);
00379       <span class="keywordflow">switch</span> (transportState) {
00380             <span class="keywordflow">case</span> JackTransportStopped:  <span class="keywordflow">return</span> Seq::STOP;
00381             <span class="keywordflow">case</span> JackTransportLooping:
00382             <span class="keywordflow">case</span> JackTransportRolling:  <span class="keywordflow">return</span> Seq::PLAY;
00383             <span class="keywordflow">case</span> JackTransportStarting:  <span class="keywordflow">return</span> Seq::START_PLAY;
00384             <span class="keywordflow">default</span>:
00385                   <span class="keywordflow">return</span> Seq::STOP;
00386             }
00387       }
00388 
00389 <span class="preprocessor">#endif</span>
00390 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
