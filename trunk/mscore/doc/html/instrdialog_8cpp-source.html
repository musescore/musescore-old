<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: instrdialog.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>instrdialog.cpp</h1><a href="instrdialog_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: instrdialog.cpp,v 1.16 2005/06/26 09:17:49 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="instrdialog_8h.html">instrdialog.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="undo_8h.html">undo.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="part_8h.html">part.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00020 
<a name="l00021"></a><a class="code" href="instrdialog_8cpp.html#a0">00021</a> <a class="code" href="instrdialog_8h.html#a0">InstrumentTemplateList</a> <a class="code" href="instrdialog_8cpp.html#a0">instrumentTemplates</a>;
00022 
00023 <span class="comment">//---------------------------------------------------------</span>
00024 <span class="comment">//   InstrumentTemplate</span>
00025 <span class="comment">//---------------------------------------------------------</span>
00026 
<a name="l00027"></a><a class="code" href="structInstrumentTemplate.html#a0">00027</a> <a class="code" href="structInstrumentTemplate.html#a0">InstrumentTemplate::InstrumentTemplate</a>(<span class="keyword">const</span> QString&amp; grp, <span class="keyword">const</span> QString&amp; n, <span class="keyword">const</span> QString&amp; sn,
00028    <span class="keywordtype">int</span> noSystems, <span class="keyword">const</span> <span class="keywordtype">int</span>* ci) : group(grp), name(n), shortName(sn)
00029       {
00030       <a class="code" href="structInstrumentTemplate.html#o5">midiProgram</a> = 0;
00031       <a class="code" href="structInstrumentTemplate.html#o3">staves</a> = noSystems;
00032       <a class="code" href="structInstrumentTemplate.html#o6">minPitch</a> = 0;
00033       <a class="code" href="structInstrumentTemplate.html#o7">maxPitch</a> = 127;
00034       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="structInstrumentTemplate.html#o3">staves</a>; ++i)
00035             <a class="code" href="structInstrumentTemplate.html#o4">clefIdx</a>[i] = *ci++;
00036       }
00037 
00038 <span class="comment">//---------------------------------------------------------</span>
00039 <span class="comment">//   InstrumentTemplateListItem</span>
00040 <span class="comment">//---------------------------------------------------------</span>
00041 
<a name="l00042"></a><a class="code" href="classInstrumentTemplateListItem.html#a0">00042</a> <a class="code" href="classInstrumentTemplateListItem.html#a0">InstrumentTemplateListItem::InstrumentTemplateListItem</a>(QString group, Q3ListView* parent)
00043    : Q3ListViewItem(parent) {
00044       <a class="code" href="classInstrumentTemplateListItem.html#r0">_instrumentTemplate</a> = 0;
00045       <a class="code" href="classInstrumentTemplateListItem.html#r1">_group</a> = group;
00046       }
00047 
<a name="l00048"></a><a class="code" href="classInstrumentTemplateListItem.html#a1">00048</a> <a class="code" href="classInstrumentTemplateListItem.html#a0">InstrumentTemplateListItem::InstrumentTemplateListItem</a>(<span class="keyword">const</span> <a class="code" href="structInstrumentTemplate.html">InstrumentTemplate</a>* i, <a class="code" href="classInstrumentTemplateListItem.html">InstrumentTemplateListItem</a>* item)
00049    : Q3ListViewItem(item) {
00050       <a class="code" href="classInstrumentTemplateListItem.html#r0">_instrumentTemplate</a> = i;
00051       <a class="code" href="classInstrumentTemplateListItem.html#r1">_group</a> = <a class="code" href="classInstrumentTemplateListItem.html#r0">_instrumentTemplate</a>-&gt;<a class="code" href="structInstrumentTemplate.html#o0">group</a>;
00052       }
00053 
<a name="l00054"></a><a class="code" href="classInstrumentTemplateListItem.html#a2">00054</a> <a class="code" href="classInstrumentTemplateListItem.html#a0">InstrumentTemplateListItem::InstrumentTemplateListItem</a>(<span class="keyword">const</span> <a class="code" href="structInstrumentTemplate.html">InstrumentTemplate</a>* i, Q3ListView* parent)
00055    : Q3ListViewItem(parent) {
00056       <a class="code" href="classInstrumentTemplateListItem.html#r0">_instrumentTemplate</a> = i;
00057       <a class="code" href="classInstrumentTemplateListItem.html#r1">_group</a> = <a class="code" href="classInstrumentTemplateListItem.html#r0">_instrumentTemplate</a>-&gt;<a class="code" href="structInstrumentTemplate.html#o0">group</a>;
00058       }
00059 
00060 <span class="comment">//---------------------------------------------------------</span>
00061 <span class="comment">//   text</span>
00062 <span class="comment">//---------------------------------------------------------</span>
00063 
<a name="l00064"></a><a class="code" href="classInstrumentTemplateListItem.html#a4">00064</a> QString <a class="code" href="classInstrumentTemplateListItem.html#a4">InstrumentTemplateListItem::text</a>(<span class="keywordtype">int</span> col)<span class="keyword"> const</span>
00065 <span class="keyword">      </span>{
00066       <span class="keywordflow">switch</span> (col) {
00067             <span class="keywordflow">case</span> 0:
00068                   <span class="keywordflow">return</span> <a class="code" href="classInstrumentTemplateListItem.html#r0">_instrumentTemplate</a> ?
00069                      <a class="code" href="classInstrumentTemplateListItem.html#r0">_instrumentTemplate</a>-&gt;<a class="code" href="structInstrumentTemplate.html#o1">name</a> : <a class="code" href="classInstrumentTemplateListItem.html#r1">_group</a>;
00070             <span class="keywordflow">default</span>:
00071                   <span class="keywordflow">return</span> QString(<span class="stringliteral">""</span>);
00072             }
00073       }
00074 
00075 <span class="comment">//---------------------------------------------------------</span>
00076 <span class="comment">//   PartListItem</span>
00077 <span class="comment">//---------------------------------------------------------</span>
00078 
<a name="l00079"></a><a class="code" href="classPartListItem.html#a2">00079</a> QString <a class="code" href="classPartListItem.html#a2">PartListItem::text</a>(<span class="keywordtype">int</span>)<span class="keyword"> const</span>
00080 <span class="keyword">      </span>{
00081       <span class="keywordflow">if</span> (<a class="code" href="classPartListItem.html#o1">part</a>)
00082             <span class="keywordflow">return</span> <a class="code" href="classPartListItem.html#o1">part</a>-&gt;<a class="code" href="classPart.html#a11">trackName</a>();
00083       <span class="keywordflow">else</span>
00084             <span class="keywordflow">return</span> <a class="code" href="classPartListItem.html#o2">it</a>-&gt;<a class="code" href="structInstrumentTemplate.html#o1">name</a>;
00085       }
00086 
00087 <span class="comment">//---------------------------------------------------------</span>
00088 <span class="comment">//   StaffListItem</span>
00089 <span class="comment">//---------------------------------------------------------</span>
00090 
<a name="l00091"></a><a class="code" href="classStaffListItem.html#a1">00091</a> QString <a class="code" href="classStaffListItem.html#a1">StaffListItem::text</a>(<span class="keywordtype">int</span>)<span class="keyword"> const</span>
00092 <span class="keyword">      </span>{
00093       QString s;
00094       s.sprintf(<span class="stringliteral">"Staff %d"</span>, <a class="code" href="classStaffListItem.html#o2">partIdx</a> + 1);
00095       <span class="keywordflow">return</span> s;
00096       }
00097 
00098 <span class="comment">//---------------------------------------------------------</span>
00099 <span class="comment">//   paintCell</span>
00100 <span class="comment">//---------------------------------------------------------</span>
00101 
<a name="l00102"></a><a class="code" href="classPartListItem.html#d0">00102</a> <span class="keywordtype">void</span> <a class="code" href="classPartListItem.html#d0">PartListItem::paintCell</a>(QPainter* p, <span class="keyword">const</span> QColorGroup&amp; cg,
00103    <span class="keywordtype">int</span> column, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> align)
00104       {
00105       <span class="keywordflow">if</span> (!p)
00106             <span class="keywordflow">return</span>;
00107       Q3ListView *lv = listView();
00108       <span class="keywordflow">if</span> (!lv )
00109             <span class="keywordflow">return</span>;
00110 
00111       <span class="keywordflow">if</span> (isSelected() &amp;&amp; (column == 0 || lv-&gt;allColumnsShowFocus())) {
00112             p-&gt;fillRect(0, 0, width, height(), cg.brush(QColorGroup::Highlight));
00113             p-&gt;setPen(cg.highlightedText());
00114             }
00115       <span class="keywordflow">else</span>
00116             p-&gt;fillRect(0, 0, width, height(), cg.brush(QColorGroup::Base));
00117 
00118       QString t = <a class="code" href="classPartListItem.html#a2">text</a>(column);
00119       <span class="keywordflow">if</span> (!t.isEmpty()) {
00120             <span class="keywordflow">if</span> (!(align &amp; Qt::AlignVCenter || align &amp; Qt::AlignBottom))
00121                   align |= Qt::AlignTop;
00122             <span class="keywordtype">int</span> marg = lv-&gt;itemMargin();
00123             <span class="keywordflow">if</span> (<a class="code" href="classPartListItem.html#o0">op</a> == <a class="code" href="instrdialog_8h.html#a8a4">ITEM_DELETE</a>) {
00124                   p-&gt;setPen(QPen(Qt::gray));
00125                   }
00126             p-&gt;drawText(marg, marg, width-marg-marg, height(), align, t);
00127             }
00128       }
00129 
00130 <span class="comment">//---------------------------------------------------------</span>
00131 <span class="comment">//   paintCell</span>
00132 <span class="comment">//---------------------------------------------------------</span>
00133 
<a name="l00134"></a><a class="code" href="classStaffListItem.html#d0">00134</a> <span class="keywordtype">void</span> <a class="code" href="classStaffListItem.html#d0">StaffListItem::paintCell</a>(QPainter* p, <span class="keyword">const</span> QColorGroup&amp; cg,
00135    <span class="keywordtype">int</span> column, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> align)
00136       {
00137       <span class="keywordflow">if</span> (!p)
00138             <span class="keywordflow">return</span>;
00139       Q3ListView *lv = listView();
00140       <span class="keywordflow">if</span> (!lv )
00141             <span class="keywordflow">return</span>;
00142 
00143       <span class="keywordflow">if</span> (isSelected() &amp;&amp; (column == 0 || lv-&gt;allColumnsShowFocus())) {
00144             p-&gt;fillRect(0, 0, width, height(), cg.brush(QColorGroup::Highlight));
00145             p-&gt;setPen(cg.highlightedText());
00146             }
00147       <span class="keywordflow">else</span>
00148             p-&gt;fillRect(0, 0, width, height(), cg.brush(QColorGroup::Base));
00149       QString t = <a class="code" href="classStaffListItem.html#a1">text</a>(column);
00150       <span class="keywordflow">if</span> (!t.isEmpty()) {
00151             <span class="keywordflow">if</span> (!(align &amp; Qt::AlignVCenter || align &amp; Qt::AlignBottom))
00152                   align |= Qt::AlignTop;
00153             <span class="keywordtype">int</span> marg = lv-&gt;itemMargin();
00154             <span class="keywordflow">if</span> (<a class="code" href="classStaffListItem.html#o0">op</a> == <a class="code" href="instrdialog_8h.html#a8a4">ITEM_DELETE</a>)
00155                   p-&gt;setPen(QPen(Qt::gray));
00156             p-&gt;drawText(marg, marg, width-marg-marg, height(), align, t);
00157             }
00158       }
00159 
00160 <span class="comment">//---------------------------------------------------------</span>
00161 <span class="comment">//   InstrumentsDialog</span>
00162 <span class="comment">//---------------------------------------------------------</span>
00163 
<a name="l00164"></a><a class="code" href="classInstrumentsDialog.html#a0">00164</a> <a class="code" href="classInstrumentsDialog.html#a0">InstrumentsDialog::InstrumentsDialog</a>(<a class="code" href="classScore.html">Score</a>* s, QWidget* parent, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keywordtype">bool</span> modal, Qt::WFlags fl)
00165    : <a class="code" href="classInstrumentsBase.html">InstrumentsBase</a>(parent, name, modal, fl)
00166       {
00167       <a class="code" href="classInstrumentsDialog.html#r0">cs</a> = s;
00168       partiturList-&gt;setSorting(-1);
00169       QString curGroup;
00170 
00171       <a class="code" href="classInstrumentTemplateListItem.html">InstrumentTemplateListItem</a>* group = 0;
00172       <span class="keywordflow">for</span> (<a class="code" href="instrdialog_8h.html#a1">ciInstrumentTemplate</a> i = <a class="code" href="instrdialog_8cpp.html#a0">instrumentTemplates</a>.begin(); i != <a class="code" href="instrdialog_8cpp.html#a0">instrumentTemplates</a>.end(); ++i) {
00173             <span class="keywordflow">if</span> (curGroup != i-&gt;group) {
00174                   curGroup = i-&gt;group;
00175                   group    = <span class="keyword">new</span> <a class="code" href="classInstrumentTemplateListItem.html">InstrumentTemplateListItem</a>(curGroup, instrumentList);
00176                   }
00177             <span class="keyword">new</span> <a class="code" href="classInstrumentTemplateListItem.html">InstrumentTemplateListItem</a>(&amp;*i, group);
00178             }
00179       connect(instrumentList, SIGNAL(selectionChanged()),
00180          SLOT(<a class="code" href="classInstrumentsDialog.html#k0">instrumentSelectionChanged</a>()));
00181       connect(partiturList, SIGNAL(selectionChanged()),
00182          SLOT(<a class="code" href="classInstrumentsDialog.html#k1">partiturSelectionChanged</a>()));
00183       connect(addButton,    SIGNAL(pressed()), SLOT(<a class="code" href="classInstrumentsDialog.html#k2">addPressed</a>()));
00184       connect(removeButton, SIGNAL(pressed()), SLOT(<a class="code" href="classInstrumentsDialog.html#k3">removePressed</a>()));
00185       connect(upButton,     SIGNAL(pressed()), SLOT(<a class="code" href="classInstrumentsDialog.html#k4">upPressed</a>()));
00186       connect(downButton,   SIGNAL(pressed()), SLOT(<a class="code" href="classInstrumentsDialog.html#k5">downPressed</a>()));
00187       connect(editButton,   SIGNAL(pressed()), SLOT(<a class="code" href="classInstrumentsDialog.html#k6">editPressed</a>()));
00188       connect(aboveButton,   SIGNAL(pressed()), SLOT(<a class="code" href="classInstrumentsDialog.html#k7">abovePressed</a>()));
00189       connect(belowButton,   SIGNAL(pressed()), SLOT(<a class="code" href="classInstrumentsDialog.html#k8">belowPressed</a>()));
00190 
00191       addButton-&gt;setEnabled(<span class="keyword">false</span>);
00192       removeButton-&gt;setEnabled(<span class="keyword">false</span>);
00193       upButton-&gt;setEnabled(<span class="keyword">false</span>);
00194       downButton-&gt;setEnabled(<span class="keyword">false</span>);
00195       editButton-&gt;setEnabled(<span class="keyword">false</span>);
00196       aboveButton-&gt;setEnabled(<span class="keyword">false</span>);
00197       belowButton-&gt;setEnabled(<span class="keyword">false</span>);
00198       }
00199 
00200 <span class="comment">//---------------------------------------------------------</span>
00201 <span class="comment">//   genPartList</span>
00202 <span class="comment">//---------------------------------------------------------</span>
00203 
<a name="l00204"></a><a class="code" href="classInstrumentsDialog.html#a1">00204</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#a1">InstrumentsDialog::genPartList</a>()
00205       {
00206       partiturList-&gt;clear();
00207 
00208       <a class="code" href="classPartList.html">PartList</a>* pl = <a class="code" href="classInstrumentsDialog.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a109">parts</a>();
00209       <span class="keywordflow">for</span> (<a class="code" href="part_8h.html#a1">riPart</a> ip = pl-&gt;<a class="code" href="classpstl_1_1plist.html#a7">rbegin</a>(); ip != pl-&gt;<a class="code" href="classpstl_1_1plist.html#a8">rend</a>(); ++ip) {
00210             <a class="code" href="classPartListItem.html">PartListItem</a>* pli = <span class="keyword">new</span> <a class="code" href="classPartListItem.html">PartListItem</a>(*ip, partiturList);
00211             <a class="code" href="classStaffList.html">StaffList</a>* sl = (*ip)-&gt;staves();
00212             <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a2">riStaff</a> is = sl-&gt;rbegin(); is != sl-&gt;rend(); ++is) {
00213                   <a class="code" href="classStaffListItem.html">StaffListItem</a>* sli = <span class="keyword">new</span> <a class="code" href="classStaffListItem.html">StaffListItem</a>(pli);
00214                   sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a> = *is;
00215                   sli-&gt;<a class="code" href="classStaffListItem.html#o2">partIdx</a> = sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a>-&gt;<a class="code" href="classStaff.html#a14">rstaff</a>();
00216                   sli-&gt;<a class="code" href="classStaffListItem.html#o3">staffIdx</a> = <a class="code" href="classInstrumentsDialog.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(*is);
00217                   sli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a>     = (*is)-&gt;clef()-&gt;clef(0);
00218                   }
00219             partiturList-&gt;setOpen(pli, <span class="keyword">true</span>);
00220             }
00221       }
00222 
00223 <span class="comment">//---------------------------------------------------------</span>
00224 <span class="comment">//   instrumentSelectionChanged</span>
00225 <span class="comment">//---------------------------------------------------------</span>
00226 
<a name="l00227"></a><a class="code" href="classInstrumentsDialog.html#k0">00227</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k0">InstrumentsDialog::instrumentSelectionChanged</a>()
00228       {
00229       Q3ListViewItem* item = instrumentList-&gt;selectedItem();
00230       <span class="keywordtype">bool</span> flag = <span class="keyword">true</span>;
00231       <span class="keywordflow">if</span> (item == 0 || item-&gt;parent() == 0)
00232             flag = <span class="keyword">false</span>;
00233       addButton-&gt;setEnabled(flag);
00234       editButton-&gt;setEnabled(flag);
00235       }
00236 
00237 <span class="comment">//---------------------------------------------------------</span>
00238 <span class="comment">//   partiturSelectionChanged</span>
00239 <span class="comment">//---------------------------------------------------------</span>
00240 
<a name="l00241"></a><a class="code" href="classInstrumentsDialog.html#k1">00241</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k1">InstrumentsDialog::partiturSelectionChanged</a>()
00242       {
00243       Q3ListViewItem* item = partiturList-&gt;selectedItem();
00244       <span class="keywordtype">bool</span> flag = item != 0;
00245       removeButton-&gt;setEnabled(flag);
00246       upButton-&gt;setEnabled(flag);
00247       downButton-&gt;setEnabled(flag);
00248       aboveButton-&gt;setEnabled(item &amp;&amp; item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>);
00249       belowButton-&gt;setEnabled(item &amp;&amp; item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>);
00250       }
00251 
00252 <span class="comment">//---------------------------------------------------------</span>
00253 <span class="comment">//   addPressed</span>
00254 <span class="comment">//    add instrument to partitur</span>
00255 <span class="comment">//---------------------------------------------------------</span>
00256 
<a name="l00257"></a><a class="code" href="classInstrumentsDialog.html#k2">00257</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k2">InstrumentsDialog::addPressed</a>()
00258       {
00259       <a class="code" href="classInstrumentTemplateListItem.html">InstrumentTemplateListItem</a>* item = (<a class="code" href="classInstrumentTemplateListItem.html">InstrumentTemplateListItem</a>*)instrumentList-&gt;selectedItem();
00260       <span class="keywordflow">if</span> (item == 0)
00261             <span class="keywordflow">return</span>;
00262       <span class="keyword">const</span> <a class="code" href="structInstrumentTemplate.html">InstrumentTemplate</a>* it = item-&gt;<a class="code" href="classInstrumentTemplateListItem.html#a3">instrumentTemplate</a>();
00263       <a class="code" href="classPartListItem.html">PartListItem</a>* pli = <span class="keyword">new</span> <a class="code" href="classPartListItem.html">PartListItem</a>(it, partiturList);
00264       pli-&gt;<a class="code" href="classPartListItem.html#o0">op</a> = <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>;
00265 
00266       <span class="keywordtype">int</span> n = it-&gt;<a class="code" href="structInstrumentTemplate.html#o3">staves</a>;
00267       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = n-1; i &gt;= 0; --i) {
00268             <a class="code" href="classStaffListItem.html">StaffListItem</a>* sli = <span class="keyword">new</span> <a class="code" href="classStaffListItem.html">StaffListItem</a>(pli);
00269             sli-&gt;<a class="code" href="classStaffListItem.html#o0">op</a>       = <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>;
00270             sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a>    = 0;
00271             sli-&gt;<a class="code" href="classStaffListItem.html#o2">partIdx</a>  = i;
00272             sli-&gt;<a class="code" href="classStaffListItem.html#o3">staffIdx</a> = -1;
00273             sli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a>     = it-&gt;<a class="code" href="structInstrumentTemplate.html#o4">clefIdx</a>[i];
00274             }
00275       partiturList-&gt;setOpen(pli, <span class="keyword">true</span>);
00276       partiturList-&gt;setSelected(pli, <span class="keyword">true</span>);
00277       }
00278 
00279 <span class="comment">//---------------------------------------------------------</span>
00280 <span class="comment">//   removePressed</span>
00281 <span class="comment">//    remove instrument from partitur</span>
00282 <span class="comment">//---------------------------------------------------------</span>
00283 
<a name="l00284"></a><a class="code" href="classInstrumentsDialog.html#k3">00284</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k3">InstrumentsDialog::removePressed</a>()
00285       {
00286       Q3ListViewItem* item = partiturList-&gt;selectedItem();
00287       <span class="keywordflow">if</span> (item == 0)
00288             <span class="keywordflow">return</span>;
00289       <span class="keywordflow">if</span> (item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>) {
00290             <span class="keywordflow">if</span> (((<a class="code" href="classStaffListItem.html">StaffListItem</a>*)item)-&gt;op == <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>) {
00291                   Q3ListViewItemIterator it(item);
00292                   --it;
00293                   Q3ListViewItem* prev = it.current();
00294                   ++it;
00295                   ++it;
00296                   Q3ListViewItem* next = it.current();
00297                   <span class="keywordflow">if</span> (next &amp;&amp; next-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a> &amp;&amp; prev &amp;&amp; prev-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>)
00298                         <span class="keyword">delete</span> prev;
00299                   <span class="keywordflow">else</span>
00300                         <span class="keyword">delete</span> item;
00301                   }
00302             <span class="keywordflow">else</span> {
00303                   ((<a class="code" href="classStaffListItem.html">StaffListItem</a>*)item)-&gt;op = <a class="code" href="instrdialog_8h.html#a8a4">ITEM_DELETE</a>;
00304                   }
00305             }
00306       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>) {
00307             <span class="keywordflow">if</span> (((<a class="code" href="classPartListItem.html">PartListItem</a>*)item)-&gt;op == <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>)
00308                   <span class="keyword">delete</span> item;
00309             <span class="keywordflow">else</span> {
00310                   ((<a class="code" href="classPartListItem.html">PartListItem</a>*)item)-&gt;op = <a class="code" href="instrdialog_8h.html#a8a4">ITEM_DELETE</a>;
00311                   }
00312             }
00313       partiturList-&gt;clearSelection();
00314       }
00315 
00316 <span class="comment">//---------------------------------------------------------</span>
00317 <span class="comment">//   upPressed</span>
00318 <span class="comment">//    move instrument up in partitur</span>
00319 <span class="comment">//---------------------------------------------------------</span>
00320 
<a name="l00321"></a><a class="code" href="classInstrumentsDialog.html#k4">00321</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k4">InstrumentsDialog::upPressed</a>()
00322       {
00323       Q3ListViewItem* item = partiturList-&gt;selectedItem();
00324       <span class="keywordflow">if</span> (item == 0)
00325             <span class="keywordflow">return</span>;
00326       Q3ListViewItem* aitem = 0;
00327       Q3ListViewItemIterator it(item);
00328       <span class="keywordflow">if</span> (item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>) {
00329             --it;
00330             <span class="keywordflow">while</span> (it.current() &amp;&amp; it.current()-&gt;rtti() != <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>)
00331                   --it;
00332             aitem = it.current();
00333             }
00334       <span class="keywordflow">else</span> {
00335             --it;
00336             <span class="keywordflow">if</span> (it.current() &amp;&amp; it.current()-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>)
00337                   aitem = it.current();
00338             }
00339       <span class="keywordflow">if</span> (aitem)
00340             aitem-&gt;moveItem(item);
00341       }
00342 
00343 <span class="comment">//---------------------------------------------------------</span>
00344 <span class="comment">//   downPressed</span>
00345 <span class="comment">//    move instrument down in partitur</span>
00346 <span class="comment">//---------------------------------------------------------</span>
00347 
<a name="l00348"></a><a class="code" href="classInstrumentsDialog.html#k5">00348</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k5">InstrumentsDialog::downPressed</a>()
00349       {
00350       Q3ListViewItem* item = partiturList-&gt;selectedItem();
00351       <span class="keywordflow">if</span> (item == 0)
00352             <span class="keywordflow">return</span>;
00353       Q3ListViewItem* bitem = 0;
00354       Q3ListViewItemIterator it(item);
00355       <span class="keywordflow">if</span> (item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>) {
00356             ++it;
00357             <span class="keywordflow">while</span> (it.current() &amp;&amp; it.current()-&gt;rtti() != <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>)
00358                   ++it;
00359             bitem = it.current();
00360             }
00361       <span class="keywordflow">else</span> {
00362             ++it;
00363             <span class="keywordflow">if</span> (it.current() &amp;&amp; it.current()-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>)
00364                   bitem = it.current();
00365             }
00366       <span class="keywordflow">if</span> (bitem)
00367             item-&gt;moveItem(bitem);
00368       }
00369 
00370 <span class="comment">//---------------------------------------------------------</span>
00371 <span class="comment">//   editPressed</span>
00372 <span class="comment">//    start instrument editor for selected instrument</span>
00373 <span class="comment">//---------------------------------------------------------</span>
00374 
<a name="l00375"></a><a class="code" href="classInstrumentsDialog.html#k6">00375</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k6">InstrumentsDialog::editPressed</a>()
00376       {
00377       Q3ListViewItem* item = instrumentList-&gt;selectedItem();
00378       <span class="keywordflow">if</span> (item == 0)
00379             <span class="keywordflow">return</span>;
00380       printf(<span class="stringliteral">"edit not implemented\n"</span>);
00381       }
00382 
00383 <span class="comment">//---------------------------------------------------------</span>
00384 <span class="comment">//   abovePressed</span>
00385 <span class="comment">//---------------------------------------------------------</span>
00386 
<a name="l00387"></a><a class="code" href="classInstrumentsDialog.html#k7">00387</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k7">InstrumentsDialog::abovePressed</a>()
00388       {
00389       Q3ListViewItem* item = partiturList-&gt;selectedItem();
00390       <span class="keywordflow">if</span> (item == 0 || item-&gt;rtti() != <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>) {
00391             <span class="keywordflow">return</span>;
00392             }
00393       <a class="code" href="classStaffListItem.html">StaffListItem</a>* sli = (<a class="code" href="classStaffListItem.html">StaffListItem</a>*)item;
00394       <a class="code" href="classStaff.html">Staff</a>* staff = sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a>;
00395       <a class="code" href="classPartListItem.html">PartListItem</a>* pli = (<a class="code" href="classPartListItem.html">PartListItem</a>*)sli-&gt;parent();
00396       <a class="code" href="classStaffListItem.html">StaffListItem</a>* nsli = <span class="keyword">new</span> <a class="code" href="classStaffListItem.html">StaffListItem</a>(pli);
00397       nsli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a> = staff;
00398       nsli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a> = sli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a>;
00399       <span class="keywordflow">if</span> (staff)
00400             nsli-&gt;<a class="code" href="classStaffListItem.html#o0">op</a> = <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>;
00401       Q3ListViewItemIterator it(item);
00402       --it;
00403       <span class="keywordflow">if</span> (it.current() &amp;&amp; it.current()-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>) {
00404             nsli-&gt;moveItem(it.current());
00405             }
00406       }
00407 
00408 <span class="comment">//---------------------------------------------------------</span>
00409 <span class="comment">//   belowPressed</span>
00410 <span class="comment">//---------------------------------------------------------</span>
00411 
<a name="l00412"></a><a class="code" href="classInstrumentsDialog.html#k8">00412</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k8">InstrumentsDialog::belowPressed</a>()
00413       {
00414       Q3ListViewItem* item = partiturList-&gt;selectedItem();
00415       <span class="keywordflow">if</span> (item == 0 || item-&gt;rtti() != <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>)
00416             <span class="keywordflow">return</span>;
00417       <a class="code" href="classStaffListItem.html">StaffListItem</a>* sli = (<a class="code" href="classStaffListItem.html">StaffListItem</a>*)item;
00418       <a class="code" href="classStaff.html">Staff</a>* staff = sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a>;
00419       <a class="code" href="classPartListItem.html">PartListItem</a>* pli = (<a class="code" href="classPartListItem.html">PartListItem</a>*)sli-&gt;parent();
00420 <span class="comment">//      Part* part = pli-&gt;part;</span>
00421       <a class="code" href="classStaffListItem.html">StaffListItem</a>* nsli = <span class="keyword">new</span> <a class="code" href="classStaffListItem.html">StaffListItem</a>(pli);
00422       nsli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a> = staff;
00423       nsli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a> = sli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a>;
00424       <span class="keywordflow">if</span> (staff)
00425             nsli-&gt;<a class="code" href="classStaffListItem.html#o0">op</a> = <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>;
00426       nsli-&gt;moveItem(item);
00427       }
00428 
00429 <span class="comment">//---------------------------------------------------------</span>
00430 <span class="comment">//   accept</span>
00431 <span class="comment">//---------------------------------------------------------</span>
00432 
<a name="l00433"></a><a class="code" href="classInstrumentsDialog.html#k9">00433</a> <span class="keywordtype">void</span> <a class="code" href="classInstrumentsDialog.html#k9">InstrumentsDialog::accept</a>()
00434       {
00435       done(1);
00436       }
00437 
00438 <span class="comment">//---------------------------------------------------------</span>
00439 <span class="comment">//   editInstrList</span>
00440 <span class="comment">//---------------------------------------------------------</span>
00441 
<a name="l00442"></a><a class="code" href="classMuseScore.html#k31">00442</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k31">MuseScore::editInstrList</a>()
00443       {
00444       <span class="keywordflow">if</span> (!<a class="code" href="classMuseScore.html#r25">instrList</a>)
00445             <a class="code" href="classMuseScore.html#r25">instrList</a> = <span class="keyword">new</span> <a class="code" href="classInstrumentsDialog.html">InstrumentsDialog</a>(<a class="code" href="classMuseScore.html#r0">cs</a>, <span class="keyword">this</span>, <span class="stringliteral">"edit_instrumentlist"</span>);
00446       <a class="code" href="classMuseScore.html#r25">instrList</a>-&gt;<a class="code" href="classInstrumentsDialog.html#a1">genPartList</a>();
00447       <span class="keywordtype">int</span> rv = <a class="code" href="classMuseScore.html#r25">instrList</a>-&gt;exec();
00448       <span class="keywordflow">if</span> (rv == 0)
00449             <span class="keywordflow">return</span>;
00450 
00451       Q3ListView* pl = <a class="code" href="classMuseScore.html#r25">instrList</a>-&gt;<a class="code" href="classUi__InstrumentsBase.html#o6">partiturList</a>;
00452 
00453       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a83">startCmd</a>();
00454 
00455       <a class="code" href="classPart.html">Part</a>* part = 0;
00456       <span class="keywordtype">int</span> staffIdx = 0;
00457       <span class="keywordtype">int</span> rstaff = 0;
00458       <span class="keywordflow">for</span> (Q3ListViewItemIterator it(pl); it.current();) {
00459             Q3ListViewItem* item = it.current();
00460             <span class="comment">//</span>
00461             <span class="comment">//  Parts</span>
00462             <span class="comment">//</span>
00463             <span class="keywordflow">if</span> (item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>) {
00464                   rstaff = 0;
00465                   <a class="code" href="classPartListItem.html">PartListItem</a>* pli = (<a class="code" href="classPartListItem.html">PartListItem</a>*)item;
00466                   <span class="keywordflow">if</span> (pli-&gt;<a class="code" href="classPartListItem.html#o0">op</a> == <a class="code" href="instrdialog_8h.html#a8a4">ITEM_DELETE</a>) {
00467                         <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a13">cmdRemovePart</a>(pli-&gt;<a class="code" href="classPartListItem.html#o1">part</a>);
00468                         ++it;
00469                         <span class="keywordflow">while</span> (it.current() &amp;&amp; it.current()-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>)
00470                               ++it;
00471                         }
00472                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pli-&gt;<a class="code" href="classPartListItem.html#o0">op</a> == <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>) {
00473                         <span class="keyword">const</span> <a class="code" href="structInstrumentTemplate.html">InstrumentTemplate</a>* t = ((<a class="code" href="classPartListItem.html">PartListItem</a>*)item)-&gt;it;
00474                         part = <span class="keyword">new</span> <a class="code" href="classPart.html">Part</a>(<a class="code" href="classMuseScore.html#r0">cs</a>);
00475                         part-&gt;<a class="code" href="classPart.html#a17">setMidiProgram</a>(t-&gt;<a class="code" href="structInstrumentTemplate.html#o5">midiProgram</a>);
00476                         part-&gt;<a class="code" href="classPart.html#a18">setMinPitch</a>(t-&gt;<a class="code" href="structInstrumentTemplate.html#o6">minPitch</a>);
00477                         part-&gt;<a class="code" href="classPart.html#a19">setMaxPitch</a>(t-&gt;<a class="code" href="structInstrumentTemplate.html#o7">maxPitch</a>);
00478                         part-&gt;<a class="code" href="classPart.html#a13">setShortName</a>(t-&gt;<a class="code" href="structInstrumentTemplate.html#o2">shortName</a>);
00479                         part-&gt;<a class="code" href="classPart.html#a14">setTrackName</a>(t-&gt;<a class="code" href="structInstrumentTemplate.html#o1">name</a>);
00480                         part-&gt;<a class="code" href="classPart.html#a12">setLongName</a>(t-&gt;<a class="code" href="structInstrumentTemplate.html#o1">name</a>);
00481                         pli-&gt;<a class="code" href="classPartListItem.html#o1">part</a> = part;
00482                         ++it;
00483                         <span class="keywordflow">while</span> (it.current() &amp;&amp; it.current()-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a7">STAFF_LIST_ITEM</a>) {
00484                               <a class="code" href="classStaffListItem.html">StaffListItem</a>* sli = (<a class="code" href="classStaffListItem.html">StaffListItem</a>*)it.current();
00485                               <a class="code" href="classStaff.html">Staff</a>* staff = <span class="keyword">new</span> <a class="code" href="classStaff.html">Staff</a>(<a class="code" href="classMuseScore.html#r0">cs</a>, part, rstaff);
00486                               sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a> = staff;
00487                               staff-&gt;<a class="code" href="classStaff.html#a16">setRstaff</a>(rstaff);
00488                               ++rstaff;
00489                               staff-&gt;<a class="code" href="classStaff.html#a2">clef</a>()-&gt;<a class="code" href="classClefList.html#a2">setClef</a>(0, sli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a>);
00490                               part-&gt;<a class="code" href="classPart.html#a5">staves</a>()-&gt;push_back(staff);
00491                               ++it;
00492                               }
00493                         <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a11">cmdInsertPart</a>(part, staffIdx);
00494                         staffIdx += rstaff;
00495                         }
00496                   <span class="keywordflow">else</span> {
00497                         part = pli-&gt;<a class="code" href="classPartListItem.html#o1">part</a>;
00498                         ++it;
00499                         }
00500                   }
00501             <span class="comment">//</span>
00502             <span class="comment">//    Staves</span>
00503             <span class="comment">//</span>
00504             <span class="keywordflow">else</span> {
00505                   <a class="code" href="classStaffListItem.html">StaffListItem</a>* sli = (<a class="code" href="classStaffListItem.html">StaffListItem</a>*)item;
00506                   <span class="keywordflow">if</span> (sli-&gt;<a class="code" href="classStaffListItem.html#o0">op</a> == <a class="code" href="instrdialog_8h.html#a8a4">ITEM_DELETE</a>) {
00507                         <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00508                         <a class="code" href="classStaff.html">Staff</a>* staff = sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a>;
00509                         <span class="keywordtype">int</span> sidx = <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff);
00510                         <span class="keywordtype">int</span> eidx = sidx + 1;
00511                         <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>())
00512                               m-&gt;<a class="code" href="classMeasure.html#a62">cmdRemoveStaves</a>(sidx, eidx);
00513                         <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemoveStaff, staff, sidx);
00514                         <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a16">removeStaff</a>(staff);
00515                         }
00516                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sli-&gt;<a class="code" href="classStaffListItem.html#o0">op</a> == <a class="code" href="instrdialog_8h.html#a8a5">ITEM_ADD</a>) {
00517                         <a class="code" href="classStaff.html">Staff</a>* staff = <span class="keyword">new</span> <a class="code" href="classStaff.html">Staff</a>(<a class="code" href="classMuseScore.html#r0">cs</a>, part, rstaff);
00518                         sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a> = staff;
00519                         staff-&gt;<a class="code" href="classStaff.html#a2">clef</a>()-&gt;<a class="code" href="classClefList.html#a2">setClef</a>(0, sli-&gt;<a class="code" href="classStaffListItem.html#o4">clef</a>);
00520 
00521                         <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>())
00522                               m-&gt;<a class="code" href="classMeasure.html#a63">cmdAddStaves</a>(staffIdx, staffIdx+1);
00523 
00524                         <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a15">insertStaff</a>(staff, staffIdx);
00525                         <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::InsertStaff, staff, staffIdx);
00526 
00527                         ++staffIdx;
00528                         ++rstaff;
00529                         }
00530                   <span class="keywordflow">else</span> {
00531                         ++staffIdx;
00532                         ++rstaff;
00533                         }
00534                   ++it;
00535                   }
00536             }
00537       <span class="comment">//</span>
00538       <span class="comment">//    sort staves</span>
00539       <span class="comment">//</span>
00540 
00541       <a class="code" href="classStaffList.html">StaffList</a> dst;
00542       <span class="keywordflow">for</span> (Q3ListViewItemIterator it(pl); it.current(); ++it) {
00543             Q3ListViewItem* item = it.current();
00544             <span class="keywordflow">if</span> (item-&gt;rtti() == <a class="code" href="instrdialog_8h.html#a9a6">PART_LIST_ITEM</a>)
00545                   <span class="keywordflow">continue</span>;
00546             <a class="code" href="classStaffListItem.html">StaffListItem</a>* sli = (<a class="code" href="classStaffListItem.html">StaffListItem</a>*)item;
00547             <span class="keywordflow">if</span> (sli-&gt;<a class="code" href="classStaffListItem.html#o0">op</a> == <a class="code" href="instrdialog_8h.html#a8a4">ITEM_DELETE</a>)
00548                   <span class="keywordflow">continue</span>;
00549             dst.push_back(sli-&gt;<a class="code" href="classStaffListItem.html#o1">staff</a>);
00550             }
00551       std::list&lt;int&gt; sl;
00552       std::list&lt;int&gt; dl;
00553       <a class="code" href="classStaffList.html">StaffList</a>* src = <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a5">staves</a>();
00554       <span class="keywordtype">int</span> idx = 0;
00555       <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> i = src-&gt;begin(); i != src-&gt;end(); ++i, ++idx)
00556             sl.push_back(idx);
00557 
00558       <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> i = dst.begin(); i != dst.end(); ++i) {
00559             <a class="code" href="classStaff.html">Staff</a>* staff = *i;
00560             <span class="keywordtype">int</span> idx = 0;
00561             <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> i = src-&gt;begin(); i != src-&gt;end(); ++i, ++idx) {
00562                   <span class="keywordflow">if</span> (*i == staff) {
00563                         dl.push_back(idx);
00564                         <span class="keywordflow">break</span>;
00565                         }
00566                   }
00567             }
00568       <span class="keywordflow">if</span> (sl.size() != dl.size())
00569             printf(<span class="stringliteral">"cannot happen: sl(%d) != dl(%d)\n"</span>, sl.size(), dl.size());
00570       <span class="keywordtype">bool</span> sort = <span class="keyword">false</span>;
00571       std::list&lt;int&gt;::iterator isl = sl.begin();
00572       std::list&lt;int&gt;::iterator dsl = dl.begin();
00573       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; sl.size(); ++i, ++isl, ++dsl) {
00574             <span class="keywordflow">if</span> (*isl != *dsl) {
00575                   sort = <span class="keyword">true</span>;
00576                   <span class="keywordflow">break</span>;
00577                   }
00578             }
00579       <span class="keywordflow">if</span> (sort) {
00580             <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a111">sortStaves</a>(sl, dl);
00581             <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(sl, dl);
00582             }
00583       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a49">layout</a>();
00584       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">true</span>);
00585       }
00586 
00587 <span class="comment">//---------------------------------------------------------</span>
00588 <span class="comment">//   cmdInsertPart</span>
00589 <span class="comment">//    insert before staffIdx</span>
00590 <span class="comment">//---------------------------------------------------------</span>
00591 
<a name="l00592"></a><a class="code" href="classScore.html#a11">00592</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a11">Score::cmdInsertPart</a>(<a class="code" href="classPart.html">Part</a>* part, <span class="keywordtype">int</span> staffIdx)
00593       {
00594       <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::InsertPart, part, staffIdx);
00595       <a class="code" href="classScore.html#a12">insertPart</a>(part, staffIdx);
00596 
00597       <span class="keywordtype">int</span> sidx = <a class="code" href="classScore.html#a7">staff</a>(part);
00598       <span class="keywordtype">int</span> eidx = sidx + part-&gt;<a class="code" href="classPart.html#a4">nstaves</a>();
00599 
00600       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>())
00601             m-&gt;<a class="code" href="classMeasure.html#a63">cmdAddStaves</a>(sidx, eidx);
00602 
00603       <span class="keywordtype">int</span> rstaff = 0;
00604       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = sidx; i &lt; eidx; ++i, ++rstaff) {
00605             <a class="code" href="classStaff.html">Staff</a>* staff = part-&gt;<a class="code" href="classPart.html#a6">staff</a>(rstaff);
00606             <a class="code" href="classScore.html#r17">_staves</a>-&gt;insert(<a class="code" href="classScore.html#r17">_staves</a>-&gt;begin() + i, staff);
00607             <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::InsertStaff, staff, i);
00608             }
00609       }
00610 
00611 <span class="comment">//---------------------------------------------------------</span>
00612 <span class="comment">//   cmdRemovePart</span>
00613 <span class="comment">//---------------------------------------------------------</span>
00614 
<a name="l00615"></a><a class="code" href="classScore.html#a13">00615</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a13">Score::cmdRemovePart</a>(<a class="code" href="classPart.html">Part</a>* part)
00616       {
00617       <a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00618 
00619       <span class="keywordtype">int</span> sidx = <a class="code" href="classScore.html#a7">staff</a>(part);
00620       <span class="keywordtype">int</span> n    = part-&gt;<a class="code" href="classPart.html#a4">nstaves</a>();
00621       <span class="keywordtype">int</span> eidx = sidx + n;
00622 
00623       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>())
00624             m-&gt;<a class="code" href="classMeasure.html#a62">cmdRemoveStaves</a>(sidx, eidx);
00625 
00626       <span class="keywordflow">for</span> (<a class="code" href="staff_8h.html#a0">iStaff</a> i = <a class="code" href="classScore.html#r17">_staves</a>-&gt;begin() + sidx; n &gt; 0; --n, ++sidx) {
00627             <a class="code" href="staff_8h.html#a0">iStaff</a> ni = i + 1;
00628             <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemoveStaff, *i, sidx);
00629             part-&gt;<a class="code" href="classPart.html#a5">staves</a>()-&gt;<a class="code" href="classStaffList.html#a0">remove</a>(*i);
00630             <a class="code" href="classScore.html#r17">_staves</a>-&gt;erase(i);
00631             i = ni;
00632             }
00633       <span class="keywordtype">int</span> staffIdx = staff(part);
00634       <a class="code" href="classScore.html#r16">_parts</a>-&gt;remove(part);
00635       <a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemovePart, part, staffIdx);
00636       }
00637 
00638 <span class="comment">//---------------------------------------------------------</span>
00639 <span class="comment">//   insertPart</span>
00640 <span class="comment">//---------------------------------------------------------</span>
00641 
<a name="l00642"></a><a class="code" href="classScore.html#a12">00642</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a12">Score::insertPart</a>(<a class="code" href="classPart.html">Part</a>* part, <span class="keywordtype">int</span> idx)
00643       {
00644       <a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00645       <span class="keywordtype">int</span> <a class="code" href="classScore.html#a7">staff</a> = 0;
00646       <span class="keywordflow">for</span> (<a class="code" href="part_8h.html#a0">iPart</a> i = <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00647             <span class="keywordflow">if</span> (staff &gt;= idx) {
00648                   <a class="code" href="classScore.html#r16">_parts</a>-&gt;insert(i, part);
00649                   <span class="keywordflow">return</span>;
00650                   }
00651             staff += (*i)-&gt;nstaves();
00652             }
00653       <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(part);
00654       }
00655 
00656 <span class="comment">//---------------------------------------------------------</span>
00657 <span class="comment">//   removePart</span>
00658 <span class="comment">//---------------------------------------------------------</span>
00659 
<a name="l00660"></a><a class="code" href="classScore.html#a14">00660</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a14">Score::removePart</a>(<a class="code" href="classPart.html">Part</a>* part)
00661       {
00662       <a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00663       <a class="code" href="classScore.html#r16">_parts</a>-&gt;remove(part);
00664       }
00665 
00666 <span class="comment">//---------------------------------------------------------</span>
00667 <span class="comment">//   insertStaff</span>
00668 <span class="comment">//---------------------------------------------------------</span>
00669 
<a name="l00670"></a><a class="code" href="classScore.html#a15">00670</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a15">Score::insertStaff</a>(<a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> idx)
00671       {
00672       <a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00673       <a class="code" href="classScore.html#r17">_staves</a>-&gt;insert(<a class="code" href="classScore.html#r17">_staves</a>-&gt;begin() + idx, staff);
00674       staff-&gt;<a class="code" href="classStaff.html#a20">part</a>()-&gt;<a class="code" href="classPart.html#a27">insertStaff</a>(staff);
00675       }
00676 
00677 <span class="comment">//---------------------------------------------------------</span>
00678 <span class="comment">//   removeStaff</span>
00679 <span class="comment">//---------------------------------------------------------</span>
00680 
<a name="l00681"></a><a class="code" href="classScore.html#a16">00681</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a16">Score::removeStaff</a>(<a class="code" href="classStaff.html">Staff</a>* staff)
00682       {
00683       <a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00684       <a class="code" href="classScore.html#r17">_staves</a>-&gt;<a class="code" href="classStaffList.html#a0">remove</a>(staff);
00685       staff-&gt;<a class="code" href="classStaff.html#a20">part</a>()-&gt;<a class="code" href="classPart.html#a28">removeStaff</a>(staff);
00686       }
00687 
00688 <span class="comment">//---------------------------------------------------------</span>
00689 <span class="comment">//   sortStaves</span>
00690 <span class="comment">//---------------------------------------------------------</span>
00691 
<a name="l00692"></a><a class="code" href="classScore.html#a111">00692</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a111">Score::sortStaves</a>(std::list&lt;int&gt; src, std::list&lt;int&gt; dst)
00693       {
00694       <a class="code" href="classScore.html#o13">systems</a>-&gt;clear();
00695 
00696       <a class="code" href="classScore.html#r16">_parts</a>-&gt;clear();
00697       <a class="code" href="classPart.html">Part</a>* curPart = 0;
00698       <a class="code" href="classStaffList.html">StaffList</a>* dl = <span class="keyword">new</span> <a class="code" href="classStaffList.html">StaffList</a>;
00699       <span class="keywordflow">for</span> (std::list&lt;int&gt;::iterator i = dst.begin(); i != dst.end(); ++i) {
00700             <span class="keywordtype">int</span> didx = *i;
00701             <span class="keywordtype">int</span> sidx = 0;
00702             <span class="keywordflow">for</span> (std::list&lt;int&gt;::iterator ii = src.begin(); ii != src.end(); ++ii, ++sidx) {
00703                   <span class="keywordflow">if</span> (didx == *ii) {
00704                         <a class="code" href="classStaff.html">Staff</a>* <a class="code" href="classScore.html#a7">staff</a> = (*_staves)[sidx];
00705                         <span class="keywordflow">if</span> (staff-&gt;<a class="code" href="classStaff.html#a20">part</a>() != curPart) {
00706                               curPart = staff-&gt;<a class="code" href="classStaff.html#a20">part</a>();
00707                               curPart-&gt;<a class="code" href="classPart.html#a5">staves</a>()-&gt;clear();
00708                               <a class="code" href="classScore.html#r16">_parts</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(curPart);
00709                               }
00710                         curPart-&gt;<a class="code" href="classPart.html#a5">staves</a>()-&gt;push_back(staff);
00711                         dl-&gt;push_back(staff);
00712                         <span class="keywordflow">break</span>;
00713                         }
00714                   }
00715             }
00716       <span class="keyword">delete</span> <a class="code" href="classScore.html#r17">_staves</a>;
00717       <a class="code" href="classScore.html#r17">_staves</a> = dl;
00718 
00719       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00720             m-&gt;<a class="code" href="classMeasure.html#a68">sortStaves</a>(src, dst);
00721             }
00722       }
00723 
00724 <span class="comment">//---------------------------------------------------------</span>
00725 <span class="comment">//   sortStaves</span>
00726 <span class="comment">//---------------------------------------------------------</span>
00727 
<a name="l00728"></a><a class="code" href="classMeasure.html#a68">00728</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a68">Measure::sortStaves</a>(std::list&lt;int&gt;&amp; src, std::list&lt;int&gt;&amp; dst)
00729       {
00730       <a class="code" href="measure_8h.html#a6">MStaffList</a> ms;
00731 
00732       <span class="keywordflow">for</span> (std::list&lt;int&gt;::iterator i = dst.begin(); i != dst.end(); ++i) {
00733             <span class="keywordtype">int</span> didx = *i;
00734             <span class="keywordtype">int</span> sidx = 0;
00735             <span class="keywordflow">for</span> (std::list&lt;int&gt;::iterator ii = src.begin(); ii != src.end(); ++ii, ++sidx) {
00736                   <span class="keywordflow">if</span> (didx == *ii) {
00737                         ms.push_back(<a class="code" href="classMeasure.html#r3">staves</a>[sidx]);
00738                         <span class="keywordflow">break</span>;
00739                         }
00740                   }
00741             }
00742       <a class="code" href="classMeasure.html#r3">staves</a> = ms;
00743 
00744       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00745             s-&gt;<a class="code" href="classSegment.html#a25">sortStaves</a>(src, dst);
00746             }
00747       }
00748 
00749 <span class="comment">//---------------------------------------------------------</span>
00750 <span class="comment">//   sortStaves</span>
00751 <span class="comment">//---------------------------------------------------------</span>
00752 
<a name="l00753"></a><a class="code" href="classSegment.html#a25">00753</a> <span class="keywordtype">void</span> <a class="code" href="classSegment.html#a25">Segment::sortStaves</a>(std::list&lt;int&gt;&amp; src, std::list&lt;int&gt;&amp; dst)
00754       {
00755       std::vector&lt;Element*&gt; dl;
00756 
00757       <span class="keywordflow">for</span> (std::list&lt;int&gt;::iterator i = dst.begin(); i != dst.end(); ++i) {
00758             <span class="keywordtype">int</span> didx = *i;
00759             <span class="keywordtype">int</span> sidx = 0;
00760             <span class="keywordflow">for</span> (std::list&lt;int&gt;::iterator ii = src.begin(); ii != src.end(); ++ii, ++sidx) {
00761                   <span class="keywordflow">if</span> (didx == *ii) {
00762                         <span class="keywordtype">int</span> startTrack = sidx * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00763                         <span class="keywordtype">int</span> endTrack = startTrack + <a class="code" href="globals_8h.html#a3">VOICES</a>;
00764                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = startTrack; k &lt; endTrack; ++k)
00765                               dl.push_back(<a class="code" href="classSegment.html#r1">_elist</a>[k]);
00766                         <span class="keywordflow">break</span>;
00767                         }
00768                   }
00769             }
00770       <a class="code" href="classSegment.html#r1">_elist</a> = dl;
00771       }
00772 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
