<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: sig.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>sig.cpp</h1><a href="sig_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: sig.cpp,v 1.6 2005/06/26 19:00:31 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="xml_8h.html">xml.h</a>"</span>
00011 
<a name="l00012"></a><a class="code" href="sig_8cpp.html#a0">00012</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="mtime_8h.html#a0">division</a> = 384;
00013 
00014 <span class="comment">//---------------------------------------------------------</span>
00015 <span class="comment">//   ticks_beat</span>
00016 <span class="comment">//---------------------------------------------------------</span>
00017 
<a name="l00018"></a><a class="code" href="sig_8cpp.html#a1">00018</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="sig_8cpp.html#a1">ticks_beat</a>(<span class="keywordtype">int</span> N)
00019       {
00020       <span class="keywordtype">int</span> m = <a class="code" href="mtime_8h.html#a0">division</a>;
00021       <span class="keywordflow">switch</span> (N) {
00022             <span class="keywordflow">case</span>  1:  m &lt;&lt;= 2; <span class="keywordflow">break</span>;           <span class="comment">// 1536</span>
00023             <span class="keywordflow">case</span>  2:  m &lt;&lt;= 1; <span class="keywordflow">break</span>;           <span class="comment">// 768</span>
00024             <span class="keywordflow">case</span>  4:  <span class="keywordflow">break</span>;                    <span class="comment">// 384</span>
00025             <span class="keywordflow">case</span>  8:  m &gt;&gt;= 1; <span class="keywordflow">break</span>;           <span class="comment">// 192</span>
00026             <span class="keywordflow">case</span> 16:  m &gt;&gt;= 2; <span class="keywordflow">break</span>;           <span class="comment">// 96</span>
00027             <span class="keywordflow">case</span> 32:  m &gt;&gt;= 3; <span class="keywordflow">break</span>;           <span class="comment">// 48</span>
00028             <span class="keywordflow">case</span> 64:  m &gt;&gt;= 4; <span class="keywordflow">break</span>;           <span class="comment">// 24</span>
00029             <span class="keywordflow">case</span> 128: m &gt;&gt;= 5; <span class="keywordflow">break</span>;           <span class="comment">// 12</span>
00030             <span class="keywordflow">default</span>:
00031                   fprintf(stderr, <span class="stringliteral">"bad divisor %d\n"</span>, N);
00032                   assert(<span class="keyword">false</span>);
00033                   <span class="keywordflow">break</span>;
00034             }
00035       <span class="keywordflow">return</span> m;
00036       }
00037 
00038 <span class="comment">//---------------------------------------------------------</span>
00039 <span class="comment">//   ticks_measure</span>
00040 <span class="comment">//---------------------------------------------------------</span>
00041 
<a name="l00042"></a><a class="code" href="sig_8h.html#a2">00042</a> <span class="keywordtype">int</span> <a class="code" href="sig_8h.html#a2">ticks_measure</a>(<span class="keywordtype">int</span> Z, <span class="keywordtype">int</span> N)
00043       {
00044       <span class="keywordflow">return</span> <a class="code" href="sig_8cpp.html#a1">ticks_beat</a>(N) * Z;
00045       }
00046 
00047 <span class="comment">//---------------------------------------------------------</span>
00048 <span class="comment">//   SigEvent</span>
00049 <span class="comment">//---------------------------------------------------------</span>
00050 
<a name="l00051"></a><a class="code" href="structSigEvent.html#a3">00051</a> <a class="code" href="structSigEvent.html#a2">SigEvent::SigEvent</a>(<span class="keywordtype">int</span> Z, <span class="keywordtype">int</span> N)
00052       {
00053       <a class="code" href="structSigEvent.html#o0">irregular</a> = <span class="keyword">false</span>;
00054       <a class="code" href="structSigEvent.html#o2">z</a>   = Z;
00055       <a class="code" href="structSigEvent.html#o3">n</a>   = N;
00056       <a class="code" href="structSigEvent.html#o4">bar</a> = 0;
00057       <a class="code" href="structSigEvent.html#o1">ticks</a> = <a class="code" href="sig_8h.html#a2">ticks_measure</a>(<a class="code" href="structSigEvent.html#o2">z</a>, <a class="code" href="structSigEvent.html#o3">n</a>);
00058       }
00059 
<a name="l00060"></a><a class="code" href="structSigEvent.html#a4">00060</a> <a class="code" href="structSigEvent.html#a2">SigEvent::SigEvent</a>(<span class="keywordtype">int</span> Z, <span class="keywordtype">int</span> N, <span class="keywordtype">int</span> t)
00061       {
00062       <a class="code" href="structSigEvent.html#o0">irregular</a> = <span class="keyword">true</span>;
00063       <a class="code" href="structSigEvent.html#o1">ticks</a> = t;
00064       <a class="code" href="structSigEvent.html#o2">z</a>   = Z;
00065       <a class="code" href="structSigEvent.html#o3">n</a>   = N;
00066       <a class="code" href="structSigEvent.html#o4">bar</a> = 0;
00067       }
00068 
00069 <span class="comment">//---------------------------------------------------------</span>
00070 <span class="comment">//   add</span>
00071 <span class="comment">//---------------------------------------------------------</span>
00072 
<a name="l00073"></a><a class="code" href="classSigList.html#a1">00073</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a1">SigList::add</a>(<span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> n)
00074       {
00075       <span class="keywordflow">if</span> (z == 0 || n == 0) {
00076             printf(<span class="stringliteral">"illegal signature %d/%d\n"</span>, z, n);
00077             }
00078       (*this)[tick] = <a class="code" href="structSigEvent.html">SigEvent</a>(z, n);
00079       <a class="code" href="classSigList.html#d0">normalize</a>();
00080       }
00081 
00082 <span class="comment">//---------------------------------------------------------</span>
00083 <span class="comment">//   add</span>
00084 <span class="comment">//---------------------------------------------------------</span>
00085 
<a name="l00086"></a><a class="code" href="classSigList.html#a2">00086</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a1">SigList::add</a>(<span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> ticks, <span class="keywordtype">int</span> z, <span class="keywordtype">int</span> n)
00087       {
00088       <span class="keywordflow">if</span> (z == 0 || n == 0) {
00089             printf(<span class="stringliteral">"illegal signature %d/%d\n"</span>, z, n);
00090             }
00091       (*this)[tick] = <a class="code" href="structSigEvent.html">SigEvent</a>(z, n, ticks);
00092       <a class="code" href="classSigList.html#d0">normalize</a>();
00093       }
00094 
00095 <span class="comment">//---------------------------------------------------------</span>
00096 <span class="comment">//   del</span>
00097 <span class="comment">//---------------------------------------------------------</span>
00098 
<a name="l00099"></a><a class="code" href="classSigList.html#a3">00099</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a3">SigList::del</a>(<span class="keywordtype">int</span> tick)
00100       {
00101       erase(tick);
00102       <a class="code" href="classSigList.html#d0">normalize</a>();
00103       }
00104 
00105 <span class="comment">//---------------------------------------------------------</span>
00106 <span class="comment">//   SigList::normalize</span>
00107 <span class="comment">//---------------------------------------------------------</span>
00108 
<a name="l00109"></a><a class="code" href="classSigList.html#d0">00109</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#d0">SigList::normalize</a>()
00110       {
00111       <span class="keywordtype">int</span> z    = 4;
00112       <span class="keywordtype">int</span> n    = 4;
00113       <span class="keywordtype">int</span> tick = 0;
00114       <span class="keywordtype">int</span> bar  = 0;
00115       <span class="keywordtype">int</span> tm   = <a class="code" href="sig_8h.html#a2">ticks_measure</a>(z, n);
00116 
00117       <span class="keywordflow">for</span> (<a class="code" href="sig_8h.html#a0">iSigEvent</a> e = begin(); e != end(); ++e) {
00118             e-&gt;second.bar = bar + (e-&gt;first - tick) / tm;
00119             bar           = e-&gt;second.bar;
00120             tick          = e-&gt;first;
00121             <span class="keywordflow">if</span> (!e-&gt;second.irregular) {
00122                   tm = <a class="code" href="sig_8h.html#a2">ticks_measure</a>(e-&gt;second.z, e-&gt;second.n);
00123                   e-&gt;second.ticks = tm;
00124                   }
00125             }
00126       }
00127 
00128 <span class="comment">//---------------------------------------------------------</span>
00129 <span class="comment">//   ticksMeasure</span>
00130 <span class="comment">//---------------------------------------------------------</span>
00131 
<a name="l00132"></a><a class="code" href="classSigList.html#a9">00132</a> <span class="keywordtype">int</span> <a class="code" href="classSigList.html#a9">SigList::ticksMeasure</a>(<span class="keywordtype">int</span> tick)<span class="keyword"> const</span>
00133 <span class="keyword">      </span>{
00134       <a class="code" href="sig_8h.html#a1">ciSigEvent</a> i = upper_bound(tick);
00135       <span class="keywordflow">if</span> (empty() || i == begin()) {
00136             printf(<span class="stringliteral">"timesig(%d): not found\n"</span>, tick);
00137             <span class="keywordflow">return</span> 4 * <a class="code" href="mtime_8h.html#a0">division</a>;
00138             }
00139       --i;
00140       <span class="keywordflow">return</span> i-&gt;second.ticks;
00141       }
00142 
00143 <span class="comment">//---------------------------------------------------------</span>
00144 <span class="comment">//   timesig</span>
00145 <span class="comment">//---------------------------------------------------------</span>
00146 
<a name="l00147"></a><a class="code" href="classSigList.html#a6">00147</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a6">SigList::timesig</a>(<span class="keywordtype">int</span> tick, <span class="keywordtype">int</span>&amp; z, <span class="keywordtype">int</span>&amp; n)<span class="keyword"> const</span>
00148 <span class="keyword">      </span>{
00149       <a class="code" href="sig_8h.html#a1">ciSigEvent</a> i = upper_bound(tick);
00150       <span class="keywordflow">if</span> (empty() || i == begin()) {
00151             z = 4;
00152             n = 4;
00153             printf(<span class="stringliteral">"timesig(%d): not found\n"</span>, tick);
00154             <span class="keywordflow">return</span>;
00155             }
00156       --i;
00157       z = i-&gt;second.z;
00158       n = i-&gt;second.n;
00159       }
00160 
00161 <span class="comment">//---------------------------------------------------------</span>
00162 <span class="comment">//   tickValues</span>
00163 <span class="comment">//---------------------------------------------------------</span>
00164 
<a name="l00165"></a><a class="code" href="classSigList.html#a7">00165</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a7">SigList::tickValues</a>(<span class="keywordtype">int</span> t, <span class="keywordtype">int</span>* bar, <span class="keywordtype">int</span>* beat, <span class="keywordtype">int</span>* tick)<span class="keyword"> const</span>
00166 <span class="keyword">      </span>{
00167       <a class="code" href="sig_8h.html#a1">ciSigEvent</a> e = upper_bound(t);
00168       <span class="keywordflow">if</span> (empty() || e == begin()) {
00169             fprintf(stderr, <span class="stringliteral">"tickValue(0x%x) not found\n"</span>, t);
00170             abort();
00171             }
00172       --e;
00173       <span class="keywordtype">int</span> delta  = t - e-&gt;first;
00174       <span class="keywordtype">int</span> ticksB = <a class="code" href="sig_8cpp.html#a1">ticks_beat</a>(e-&gt;second.n);
00175       <span class="keywordtype">int</span> ticksM = ticksB * e-&gt;second.z;
00176       *bar       = e-&gt;second.bar + delta / ticksM;
00177       <span class="keywordtype">int</span> rest   = delta % ticksM;
00178       *beat      = rest / ticksB;
00179       *tick      = rest % ticksB;
00180       }
00181 
00182 <span class="comment">//---------------------------------------------------------</span>
00183 <span class="comment">//   bar2tick</span>
00184 <span class="comment">//---------------------------------------------------------</span>
00185 
<a name="l00186"></a><a class="code" href="classSigList.html#a8">00186</a> <span class="keywordtype">int</span> <a class="code" href="classSigList.html#a8">SigList::bar2tick</a>(<span class="keywordtype">int</span> bar, <span class="keywordtype">int</span> beat, <span class="keywordtype">int</span> tick)<span class="keyword"> const</span>
00187 <span class="keyword">      </span>{
00188       <a class="code" href="sig_8h.html#a1">ciSigEvent</a> e;
00189 
00190       <span class="keywordflow">for</span> (e = begin(); e != end(); ++e) {
00191             <span class="keywordflow">if</span> (bar &lt; e-&gt;second.bar)
00192                   <span class="keywordflow">break</span>;
00193             }
00194       <span class="keywordflow">if</span> (empty() || e == begin()) {
00195             fprintf(stderr, <span class="stringliteral">"SigList::bar2tick(): not found(%d,%d,%d) not found\n"</span>,
00196                bar, beat, tick);
00197             abort();
00198             }
00199       --e;
00200       <span class="keywordtype">int</span> ticksB = <a class="code" href="sig_8cpp.html#a1">ticks_beat</a>(e-&gt;second.n);
00201       <span class="keywordtype">int</span> ticksM = ticksB * e-&gt;second.z;
00202       <span class="keywordflow">return</span> e-&gt;first + (bar - e-&gt;second.bar) * ticksM + ticksB * beat + tick;
00203       }
00204 
00205 <span class="comment">//---------------------------------------------------------</span>
00206 <span class="comment">//   SigList::write</span>
00207 <span class="comment">//---------------------------------------------------------</span>
00208 
<a name="l00209"></a><a class="code" href="classSigList.html#a5">00209</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a5">SigList::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00210 <span class="keyword">      </span>{
00211       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"siglist"</span>);
00212       <span class="keywordflow">for</span> (<a class="code" href="sig_8h.html#a1">ciSigEvent</a> i = begin(); i != end(); ++i)
00213             i-&gt;second.write(xml, i-&gt;first);
00214       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"siglist"</span>);
00215       }
00216 
00217 <span class="comment">//---------------------------------------------------------</span>
00218 <span class="comment">//   SigList::read</span>
00219 <span class="comment">//---------------------------------------------------------</span>
00220 
<a name="l00221"></a><a class="code" href="classSigList.html#a4">00221</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a4">SigList::read</a>(QDomNode node)
00222       {
00223       node = node.firstChild();
00224       <span class="keywordflow">while</span> (!node.isNull()) {
00225             QDomElement e = node.toElement();
00226             QString tag(e.tagName());
00227             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"sig"</span>) {
00228                   <a class="code" href="structSigEvent.html">SigEvent</a> t;
00229                   <span class="keywordtype">int</span> tick = t.<a class="code" href="structSigEvent.html#a0">read</a>(node);
00230                   (*this)[tick] = t;
00231                   }
00232             <span class="keywordflow">else</span>
00233                   printf(<span class="stringliteral">"Mscore:SigList: unknown tag %s\n"</span>,
00234                      tag.latin1());
00235             node = node.nextSibling();
00236             }
00237       <a class="code" href="classSigList.html#d0">normalize</a>();
00238       }
00239 
00240 <span class="comment">//---------------------------------------------------------</span>
00241 <span class="comment">//   SigEvent::write</span>
00242 <span class="comment">//---------------------------------------------------------</span>
00243 
<a name="l00244"></a><a class="code" href="structSigEvent.html#a1">00244</a> <span class="keywordtype">void</span> <a class="code" href="structSigEvent.html#a1">SigEvent::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml, <span class="keywordtype">int</span> tick)<span class="keyword"> const</span>
00245 <span class="keyword">      </span>{
00246       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"sig tick=\"%d\""</span>, tick);
00247       <span class="keywordflow">if</span> (<a class="code" href="structSigEvent.html#o0">irregular</a>)
00248             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"ticks"</span>, <a class="code" href="structSigEvent.html#o1">ticks</a>);
00249       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"nom"</span>, <a class="code" href="structSigEvent.html#o2">z</a>);
00250       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"denom"</span>, <a class="code" href="structSigEvent.html#o3">n</a>);
00251       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"sig"</span>);
00252       }
00253 
00254 <span class="comment">//---------------------------------------------------------</span>
00255 <span class="comment">//   SigEvent::read</span>
00256 <span class="comment">//---------------------------------------------------------</span>
00257 
<a name="l00258"></a><a class="code" href="structSigEvent.html#a0">00258</a> <span class="keywordtype">int</span> <a class="code" href="structSigEvent.html#a0">SigEvent::read</a>(QDomNode node)
00259       {
00260       <a class="code" href="structSigEvent.html#o0">irregular</a> = <span class="keyword">false</span>;
00261 
00262       QDomElement e = node.toElement();
00263       <span class="keywordtype">int</span> tick = e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt();
00264 
00265       node = node.firstChild();
00266       <span class="keywordflow">while</span> (!node.isNull()) {
00267             QDomElement e = node.toElement();
00268             QString tag(e.tagName());
00269             QString val(e.text());
00270             <span class="keywordtype">int</span> i = val.toInt();
00271             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"nom"</span>)
00272                   <a class="code" href="structSigEvent.html#o2">z</a> = i;
00273             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"denom"</span>)
00274                   <a class="code" href="structSigEvent.html#o3">n</a> = i;
00275             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"ticks"</span>) {
00276                   <a class="code" href="structSigEvent.html#o1">ticks</a> = i;
00277                   <a class="code" href="structSigEvent.html#o0">irregular</a> = <span class="keyword">true</span>;
00278                   }
00279             <span class="keywordflow">else</span>
00280                   printf(<span class="stringliteral">"Mscore:SigEvent: unknown tag %s\n"</span>,
00281                      tag.latin1());
00282             node = node.nextSibling();
00283             }
00284       <span class="keywordflow">if</span> (!<a class="code" href="structSigEvent.html#o0">irregular</a>)
00285             <a class="code" href="structSigEvent.html#o1">ticks</a> = <a class="code" href="sig_8h.html#a2">ticks_measure</a>(<a class="code" href="structSigEvent.html#o2">z</a>, <a class="code" href="structSigEvent.html#o3">n</a>);
00286       <span class="keywordflow">return</span> tick;
00287       }
00288 
00289 <span class="comment">//---------------------------------------------------------</span>
00290 <span class="comment">//   remove</span>
00291 <span class="comment">//---------------------------------------------------------</span>
00292 
<a name="l00293"></a><a class="code" href="classSigList.html#a10">00293</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a10">SigList::removeTime</a>(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)
00294       {
00295       printf(<span class="stringliteral">"SigList::removeTime(): not impl.\n"</span>);
00296       }
00297 
00298 <span class="comment">//---------------------------------------------------------</span>
00299 <span class="comment">//   insert</span>
00300 <span class="comment">//---------------------------------------------------------</span>
00301 
<a name="l00302"></a><a class="code" href="classSigList.html#a11">00302</a> <span class="keywordtype">void</span> <a class="code" href="classSigList.html#a11">SigList::insertTime</a>(<span class="keywordtype">int</span>, <span class="keywordtype">int</span>)
00303       {
00304       printf(<span class="stringliteral">"SigList::insertTime(): not impl.\n"</span>);
00305       }
00306 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
