<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: palette.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>palette.cpp</h1><a href="palette_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: palette.cpp,v 1.11 2005/06/27 19:50:24 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2005 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="palette_8h.html">palette.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="element_8h.html">element.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00013 
00014 <span class="comment">//---------------------------------------------------------</span>
00015 <span class="comment">//   SymbolPalette</span>
00016 <span class="comment">//---------------------------------------------------------</span>
00017 
<a name="l00018"></a><a class="code" href="classSymbolPalette.html#a0">00018</a> <a class="code" href="classSymbolPalette.html#a0">SymbolPalette::SymbolPalette</a>(<span class="keywordtype">int</span> r, <span class="keywordtype">int</span> c, QWidget* parent, QString name)
00019    : QWidget(parent)
00020       {
00021       <a class="code" href="classSymbolPalette.html#r8">staff</a>         = <span class="keyword">false</span>;
00022       <a class="code" href="classSymbolPalette.html#r3">rows</a>          = r;
00023       <a class="code" href="classSymbolPalette.html#r4">columns</a>       = c;
00024       <a class="code" href="classSymbolPalette.html#r7">currentSymbol</a> = 0;;
00025       <a class="code" href="classSymbolPalette.html#r0">mag</a>           = .3;
00026       <a class="code" href="classSymbolPalette.html#r1">symbols</a> = <span class="keyword">new</span> <a class="code" href="classElement.html">Element</a>*[<a class="code" href="classSymbolPalette.html#r3">rows</a>*<a class="code" href="classSymbolPalette.html#r4">columns</a>];
00027       <a class="code" href="classSymbolPalette.html#r2">names</a>   = <span class="keyword">new</span> QString[<a class="code" href="classSymbolPalette.html#r3">rows</a>*<a class="code" href="classSymbolPalette.html#r4">columns</a>];
00028       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classSymbolPalette.html#r3">rows</a>*<a class="code" href="classSymbolPalette.html#r4">columns</a>; ++i)
00029             <a class="code" href="classSymbolPalette.html#r1">symbols</a>[i] = 0;
00030       setCaption(name);
00031       }
00032 
<a name="l00033"></a><a class="code" href="classSymbolPalette.html#a1">00033</a> <a class="code" href="classSymbolPalette.html#a1">SymbolPalette::~SymbolPalette</a>()
00034       {
00035       <span class="keyword">delete</span> <a class="code" href="classSymbolPalette.html#r1">symbols</a>;
00036       <span class="keyword">delete</span> <a class="code" href="classSymbolPalette.html#r2">names</a>;
00037       }
00038 
00039 <span class="comment">//---------------------------------------------------------</span>
00040 <span class="comment">//   setMag</span>
00041 <span class="comment">//---------------------------------------------------------</span>
00042 
<a name="l00043"></a><a class="code" href="classSymbolPalette.html#a6">00043</a> <span class="keywordtype">void</span> <a class="code" href="classSymbolPalette.html#a6">SymbolPalette::setMag</a>(<span class="keywordtype">double</span> m)
00044       {
00045       <a class="code" href="classSymbolPalette.html#r0">mag</a> = m * .3;
00046       <span class="keywordtype">int</span> w = <a class="code" href="classSymbolPalette.html#r4">columns</a> * <a class="code" href="classSymbolPalette.html#r5">hgrid</a>;
00047       <span class="keywordtype">int</span> h = <a class="code" href="classSymbolPalette.html#r3">rows</a> * <a class="code" href="classSymbolPalette.html#r6">vgrid</a>;
00048       setFixedSize(lrint(w * <a class="code" href="classSymbolPalette.html#r0">mag</a>), lrint(h * mag));
00049       }
00050 
00051 <span class="comment">//---------------------------------------------------------</span>
00052 <span class="comment">//   setGrid</span>
00053 <span class="comment">//---------------------------------------------------------</span>
00054 
<a name="l00055"></a><a class="code" href="classSymbolPalette.html#a4">00055</a> <span class="keywordtype">void</span> <a class="code" href="classSymbolPalette.html#a4">SymbolPalette::setGrid</a>(<span class="keywordtype">int</span> hh, <span class="keywordtype">int</span> vv)
00056       {
00057       <a class="code" href="classSymbolPalette.html#r5">hgrid</a> = hh;
00058       <a class="code" href="classSymbolPalette.html#r6">vgrid</a> = vv;
00059       <span class="keywordtype">int</span> w = <a class="code" href="classSymbolPalette.html#r4">columns</a> * <a class="code" href="classSymbolPalette.html#r5">hgrid</a>;
00060       <span class="keywordtype">int</span> h = <a class="code" href="classSymbolPalette.html#r3">rows</a> * <a class="code" href="classSymbolPalette.html#r6">vgrid</a>;
00061       setFixedSize(lrint(w * <a class="code" href="classSymbolPalette.html#r0">mag</a>), lrint(h * mag));
00062       }
00063 
00064 <span class="comment">//---------------------------------------------------------</span>
00065 <span class="comment">//   showStaff</span>
00066 <span class="comment">//---------------------------------------------------------</span>
00067 
<a name="l00068"></a><a class="code" href="classSymbolPalette.html#a5">00068</a> <span class="keywordtype">void</span> <a class="code" href="classSymbolPalette.html#a5">SymbolPalette::showStaff</a>(<span class="keywordtype">bool</span> flag)
00069       {
00070       <a class="code" href="classSymbolPalette.html#r8">staff</a> = flag;
00071       }
00072 
00073 <span class="comment">//---------------------------------------------------------</span>
00074 <span class="comment">//   contentsMousePressEvent</span>
00075 <span class="comment">//---------------------------------------------------------</span>
00076 
<a name="l00077"></a><a class="code" href="classSymbolPalette.html#d2">00077</a> <span class="keywordtype">void</span> <a class="code" href="classSymbolPalette.html#d2">SymbolPalette::mousePressEvent</a>(QMouseEvent* ev)
00078       {
00079       <span class="keywordtype">int</span> x = lrint(<span class="keywordtype">double</span>(ev-&gt;pos().x()) / <a class="code" href="classSymbolPalette.html#r0">mag</a>);
00080       <span class="keywordtype">int</span> y = lrint(<span class="keywordtype">double</span>(ev-&gt;pos().y()) / <a class="code" href="classSymbolPalette.html#r0">mag</a>);
00081 
00082       <span class="keywordtype">int</span> row = y / <a class="code" href="classSymbolPalette.html#r6">vgrid</a>;
00083       <span class="keywordtype">int</span> col = x / <a class="code" href="classSymbolPalette.html#r5">hgrid</a>;
00084 
00085       <span class="keywordflow">if</span> (row &lt; 0 || row &gt;= <a class="code" href="classSymbolPalette.html#r3">rows</a>)
00086             <span class="keywordflow">return</span>;
00087       <span class="keywordflow">if</span> (col &lt; 0 || col &gt;= <a class="code" href="classSymbolPalette.html#r4">columns</a>)
00088             <span class="keywordflow">return</span>;
00089       <span class="keywordtype">int</span> idx = row * <a class="code" href="classSymbolPalette.html#r4">columns</a> + col;
00090       <span class="keywordflow">if</span> (<a class="code" href="classSymbolPalette.html#r1">symbols</a>[idx] == 0)
00091             <span class="keywordflow">return</span>;
00092       <span class="keywordtype">int</span> cc = <a class="code" href="classSymbolPalette.html#r7">currentSymbol</a> % <a class="code" href="classSymbolPalette.html#r4">columns</a>;
00093       <span class="keywordtype">int</span> cr = <a class="code" href="classSymbolPalette.html#r7">currentSymbol</a> / <a class="code" href="classSymbolPalette.html#r4">columns</a>;
00094       QRect r(<span class="keywordtype">int</span>(cc * <a class="code" href="classSymbolPalette.html#r5">hgrid</a> * <a class="code" href="classSymbolPalette.html#r0">mag</a>), 
00095          <span class="keywordtype">int</span>(cr * <a class="code" href="classSymbolPalette.html#r6">vgrid</a> * mag), 
00096          <span class="keywordtype">int</span>(<a class="code" href="classSymbolPalette.html#r5">hgrid</a> * mag), 
00097          <span class="keywordtype">int</span>(<a class="code" href="classSymbolPalette.html#r6">vgrid</a> * mag));
00098       <a class="code" href="classSymbolPalette.html#r1">symbols</a>[<a class="code" href="classSymbolPalette.html#r7">currentSymbol</a>]-&gt;<a class="code" href="classElement.html#a15">setSelected</a>(<span class="keyword">false</span>);
00099       <a class="code" href="classSymbolPalette.html#r7">currentSymbol</a> = idx;
00100       <a class="code" href="classSymbolPalette.html#r1">symbols</a>[<a class="code" href="classSymbolPalette.html#r7">currentSymbol</a>]-&gt;<a class="code" href="classElement.html#a15">setSelected</a>(<span class="keyword">true</span>);
00101       emit <a class="code" href="classSymbolPalette.html#l0">paletteSelected</a>(<a class="code" href="classSymbolPalette.html#r1">symbols</a>[<a class="code" href="classSymbolPalette.html#r7">currentSymbol</a>]);
00102       cc = currentSymbol % <a class="code" href="classSymbolPalette.html#r4">columns</a>;
00103       cr = currentSymbol / <a class="code" href="classSymbolPalette.html#r4">columns</a>;
00104       r |= QRect(<span class="keywordtype">int</span>(cc * <a class="code" href="classSymbolPalette.html#r5">hgrid</a> * mag), 
00105          <span class="keywordtype">int</span>(cr * <a class="code" href="classSymbolPalette.html#r6">vgrid</a> * mag), 
00106          <span class="keywordtype">int</span>(<a class="code" href="classSymbolPalette.html#r5">hgrid</a> * mag), 
00107          <span class="keywordtype">int</span>(<a class="code" href="classSymbolPalette.html#r6">vgrid</a> * mag));
00108       update(r);
00109       }
00110 
00111 <span class="comment">//---------------------------------------------------------</span>
00112 <span class="comment">//   addObject</span>
00113 <span class="comment">//---------------------------------------------------------</span>
00114 
<a name="l00115"></a><a class="code" href="classSymbolPalette.html#a2">00115</a> <span class="keywordtype">void</span> <a class="code" href="classSymbolPalette.html#a2">SymbolPalette::addObject</a>(<span class="keywordtype">int</span> idx, <a class="code" href="classElement.html">Element</a>* s, <span class="keyword">const</span> QString&amp; name)
00116       {
00117       <a class="code" href="classSymbolPalette.html#r1">symbols</a>[idx] = s;
00118       <a class="code" href="classSymbolPalette.html#r2">names</a>[idx]   = name;
00119       <span class="keywordtype">int</span> row      = idx / <a class="code" href="classSymbolPalette.html#r4">columns</a>;
00120       <span class="keywordtype">int</span> column   = idx % <a class="code" href="classSymbolPalette.html#r4">columns</a>;
00121       s-&gt;setSelected(<span class="keyword">false</span>);
00122 
00123       QRect r(column*<a class="code" href="classSymbolPalette.html#r5">hgrid</a>, row*<a class="code" href="classSymbolPalette.html#r6">vgrid</a>, hgrid, vgrid);
00124       QToolTip::add(<span class="keyword">this</span>, r, name);
00125 
00126       <span class="keywordtype">double</span> gx = column * hgrid;
00127       <span class="keywordtype">double</span> gy = row    * vgrid;
00128       <span class="keywordtype">double</span> gw = hgrid;
00129       <span class="keywordtype">double</span> gh = vgrid;
00130 
00131       <span class="keywordtype">double</span> sw = s-&gt;width();
00132       <span class="keywordtype">double</span> sy = gy - s-&gt;bbox().y();
00133       <span class="keywordtype">double</span> sh = s-&gt;bbox().height();
00134 
00135       <span class="keywordtype">double</span> sx;
00136 
00137       <span class="keywordflow">if</span> (!<a class="code" href="classSymbolPalette.html#r8">staff</a>) {
00138             sy += (gh - sh) / 2;
00139             sx = (gw - s-&gt;bbox().width())/2.0 + gx - s-&gt;bbox().x();
00140             }
00141       <span class="keywordflow">else</span> {
00142             sy = gy + (gh / 2) - 2 * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00143             sx = gx + (gw-sw) / 2;
00144             }
00145       s-&gt;setpos(sx, sy);
00146       update(r);
00147       }
00148 
00149 <span class="comment">//---------------------------------------------------------</span>
00150 <span class="comment">//   addObject</span>
00151 <span class="comment">//---------------------------------------------------------</span>
00152 
<a name="l00153"></a><a class="code" href="classSymbolPalette.html#a3">00153</a> <span class="keywordtype">void</span> <a class="code" href="classSymbolPalette.html#a2">SymbolPalette::addObject</a>(<span class="keywordtype">int</span> idx, <span class="keyword">const</span> <a class="code" href="structSym.html">Sym</a>&amp; sym)
00154       {
00155       <a class="code" href="classSymbol.html">Symbol</a>* s = <span class="keyword">new</span> <a class="code" href="classSymbol.html">Symbol</a>(0);
00156       s-&gt;<a class="code" href="classSymbol.html#a4">setSym</a>(sym);
00157       <a class="code" href="classSymbolPalette.html#a2">addObject</a>(idx, s, sym.<a class="code" href="structSym.html#a3">name</a>());
00158       }
00159 
00160 <span class="comment">//---------------------------------------------------------</span>
00161 <span class="comment">//   paintEvent</span>
00162 <span class="comment">//---------------------------------------------------------</span>
00163 
<a name="l00164"></a><a class="code" href="classSymbolPalette.html#d1">00164</a> <span class="keywordtype">void</span> <a class="code" href="classSymbolPalette.html#d1">SymbolPalette::paintEvent</a>(QPaintEvent* e)
00165       {
00166       QRect rect(e-&gt;rect());
00167 
00168       <a class="code" href="classPainter.html">Painter</a> p(<span class="keyword">this</span>);
00169       p.setRenderHint(QPainter::Antialiasing, <span class="keyword">true</span>);
00170       p.fillRect(rect, Qt::white);
00171       p.setClipRect(rect);
00172       p.scale(<a class="code" href="classSymbolPalette.html#r0">mag</a>, <a class="code" href="classSymbolPalette.html#r0">mag</a>);
00173 
00174       <span class="comment">//</span>
00175       <span class="comment">// draw grid</span>
00176       <span class="comment">//</span>
00177 
00178       p.setPen(Qt::gray);
00179       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> row = 1; row &lt; <a class="code" href="classSymbolPalette.html#r3">rows</a>; ++row)
00180             p.drawLine(0, row*<a class="code" href="classSymbolPalette.html#r6">vgrid</a>, <a class="code" href="classSymbolPalette.html#r4">columns</a>*<a class="code" href="classSymbolPalette.html#r5">hgrid</a>, row*vgrid);
00181       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> column = 1; column &lt; <a class="code" href="classSymbolPalette.html#r4">columns</a>; ++column)
00182             p.drawLine(hgrid*column, 0, hgrid*column, rows*vgrid);
00183 
00184       qreal lw = point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o24">staffLineWidth</a>);
00185       qreal dy = lrint(2 * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00186 
00187       <span class="comment">//</span>
00188       <span class="comment">// draw symbols</span>
00189       <span class="comment">//</span>
00190 
00191       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> row = 0; row &lt; rows; ++row) {
00192             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> column = 0; column &lt; columns; ++column) {
00193                   QRect r(column*hgrid, row*vgrid, hgrid, vgrid);
00194                   <span class="keywordflow">if</span> (!p.clipRegion().boundingRect().intersects(r))
00195                         <span class="keywordflow">continue</span>;
00196                   <span class="keywordflow">if</span> (<a class="code" href="classSymbolPalette.html#r8">staff</a>) {
00197                         QPen pen(QColor(Qt::gray));
00198                         pen.setWidthF(lw);
00199                         p.setPen(pen);
00200                         qreal y = r.y() + vgrid / 2 - dy;
00201                         qreal x = r.x() + 8;
00202                         qreal w = hgrid - 16;
00203                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 5; ++i) {
00204                               qreal yy = y + <a class="code" href="spatium_8h.html#a0">_spatium</a> * i;
00205                               p.drawLine(QLineF(x, yy, x + w, yy));
00206                               }
00207                         }
00208                   <span class="keywordtype">int</span> idx = row * columns + column;
00209                   <span class="keywordflow">if</span> (<a class="code" href="classSymbolPalette.html#r1">symbols</a>[idx] == 0)
00210                         <span class="keywordflow">continue</span>;
00211                   <a class="code" href="classSymbolPalette.html#r1">symbols</a>[idx]-&gt;<a class="code" href="classElement.html#a43">draw</a>(p);
00212                   }
00213             }
00214       }
00215 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
