<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: hairpin.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>hairpin.cpp</h1><a href="hairpin_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: hairpin.cpp,v 1.10 2005/06/20 13:54:53 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="hairpin_8h.html">hairpin.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="xml_8h.html">xml.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="preferences_8h.html">preferences.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00019 
00020 <span class="comment">//---------------------------------------------------------</span>
00021 <span class="comment">//   write</span>
00022 <span class="comment">//---------------------------------------------------------</span>
00023 
<a name="l00024"></a><a class="code" href="classHairpin.html#a21">00024</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#a21">Hairpin::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00025 <span class="keyword">      </span>{
00026       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"HairPin"</span>);
00027       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"tick1"</span>, <a class="code" href="classHairpin.html#r0">_tick1</a>);
00028       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"tick2"</span>, <a class="code" href="classHairpin.html#r1">_tick2</a>);
00029       <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r2">flip</a>)
00030             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"flip"</span>, <a class="code" href="classHairpin.html#r2">flip</a>);
00031       <span class="keywordflow">if</span> (!<a class="code" href="classHairpin.html#r3">off1</a>.isNull())
00032             xml.<a class="code" href="classXml.html#a20">writePoint</a>(<a class="code" href="classHairpin.html#r3">off1</a>, <span class="stringliteral">"off1"</span>);
00033       <span class="keywordflow">if</span> (!<a class="code" href="classHairpin.html#r4">off2</a>.isNull())
00034             xml.<a class="code" href="classXml.html#a20">writePoint</a>(<a class="code" href="classHairpin.html#r4">off2</a>, <span class="stringliteral">"off2"</span>);
00035       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"HairPin"</span>);
00036       }
00037 
00038 <span class="comment">//---------------------------------------------------------</span>
00039 <span class="comment">//   read</span>
00040 <span class="comment">//---------------------------------------------------------</span>
00041 
<a name="l00042"></a><a class="code" href="classHairpin.html#a22">00042</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#a22">Hairpin::read</a>(QDomNode node)
00043       {
00044       node = node.firstChild();
00045       <span class="keywordflow">while</span> (!node.isNull()) {
00046             QDomElement e = node.toElement();
00047             QString tag(e.tagName());
00048             QString val(e.text());
00049             <span class="keywordtype">int</span> i = val.toInt();
00050             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"off1"</span>)
00051                   <a class="code" href="classHairpin.html#r3">off1</a> = <a class="code" href="xml_8h.html#a2">readPoint</a>(node);
00052             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"off2"</span>)
00053                   <a class="code" href="classHairpin.html#r4">off2</a> = <a class="code" href="xml_8h.html#a2">readPoint</a>(node);
00054             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"flip"</span>)
00055                   <a class="code" href="classHairpin.html#r2">flip</a> = i;
00056             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"tick1"</span>)
00057                   <a class="code" href="classHairpin.html#r0">_tick1</a> = i;
00058             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"tick2"</span>)
00059                   <a class="code" href="classHairpin.html#r1">_tick2</a> = i;
00060             <span class="keywordflow">else</span>
00061                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00062             node = node.nextSibling();
00063             }
00064       }
00065 
00066 <span class="comment">//---------------------------------------------------------</span>
00067 <span class="comment">//   setFlip</span>
00068 <span class="comment">//---------------------------------------------------------</span>
00069 
<a name="l00070"></a><a class="code" href="classHairpin.html#a4">00070</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#a4">Hairpin::setFlip</a>(<span class="keywordtype">bool</span> f)
00071       {
00072       <a class="code" href="classHairpin.html#r2">flip</a> = f;
00073       <a class="code" href="classHairpin.html#d0">bboxUpdate</a>();
00074       }
00075 
00076 <span class="comment">//---------------------------------------------------------</span>
00077 <span class="comment">//   bboxUpdate</span>
00078 <span class="comment">//---------------------------------------------------------</span>
00079 
<a name="l00080"></a><a class="code" href="classHairpin.html#d0">00080</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#d0">Hairpin::bboxUpdate</a>()
00081       {
00082       <span class="keywordtype">double</span> h1 = point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o44">hairpinHeight</a>) * .5;
00083       <span class="keywordtype">double</span> h2 = point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o45">hairpinContHeight</a>) * .5;
00084 
00085       QRectF r(0, 0, 0, 0);
00086       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciHairpinSegment</a> i = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00087             <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* s = *i;
00088             s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> = QRectF(0, 0, 0, 0);
00089 
00090             <a class="code" href="classpstl_1_1plist.html">ciHairpinSegment</a> ii = i;
00091             ++ii;
00092             QPointF pp1(s-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a>);
00093             QPointF pp2(s-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a>);
00094 
00095             <span class="keywordflow">if</span> (i == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>())
00096                   pp1 += <a class="code" href="classHairpin.html#r3">off1</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00097             <span class="keywordflow">if</span> (ii == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>())
00098                   pp2 += <a class="code" href="classHairpin.html#r4">off2</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00099 
00100             <span class="keywordflow">if</span> (i == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>() &amp;&amp; !<a class="code" href="classHairpin.html#r2">flip</a>) {
00101                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> = QRectF(pp2.x(), pp2.y() + h1, pp2.x(), pp2.y() - h1);
00102                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> |= QRectF(pp1, QSizeF(1.0, 1.0));
00103                   }
00104 
00105             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ii == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>() &amp;&amp; <a class="code" href="classHairpin.html#r2">flip</a>) {
00106                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> = QRectF(pp2.x(), pp1.y() + h1, pp2.x(), pp1.y() - h1);
00107                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> |= QRectF(pp2, QSizeF(1.0, 1.0));
00108                   }
00109             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r2">flip</a>) {
00110                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> = QRectF(pp1.x(), pp1.y()+h1, pp1.x(), pp1.y()-h1);
00111                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> |= QRectF(pp2.x(), pp2.y()+h2, 1.0, 1.0);
00112                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> |= QRectF(pp2.x(), pp2.y()-h2, 1.0, 1.0);
00113                   }
00114             <span class="keywordflow">else</span> {
00115                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> = QRectF(pp1.x(), pp1.y()+h2, pp1.x(), pp1.y()-h2);
00116                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> |= QRectF(pp2.x(), pp2.y()+h1, 1.0, 1.0);
00117                   s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a> |= QRectF(pp2.x(), pp2.y()-h1, 1.0, 1.0);
00118                   }
00119             r |= s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a>;
00120             }
00121 
00122       <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> != <a class="code" href="classHairpin.html#y3y0">NORMAL</a>) {
00123             r |= <a class="code" href="classHairpin.html#r5">r1</a>;
00124             r |= <a class="code" href="classHairpin.html#r6">r2</a>;
00125             }
00126 <span class="comment">//      setbbox(r.expand(1));   // DEBUG: 1.0 = lineWidth</span>
00127       }
00128 
00129 <span class="comment">//---------------------------------------------------------</span>
00130 <span class="comment">//   draw</span>
00131 <span class="comment">//---------------------------------------------------------</span>
00132 
<a name="l00133"></a><a class="code" href="classHairpin.html#a11">00133</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#a11">Hairpin::draw1</a>(<a class="code" href="classPainter.html">Painter</a>&amp; p)<span class="keyword"> const</span>
00134 <span class="keyword">      </span>{
00135       <span class="keywordtype">double</span> h1 = point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o44">hairpinHeight</a>) * .5;
00136       <span class="keywordtype">double</span> h2 = point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o45">hairpinContHeight</a>) * .5;
00137 
00138       QColor <a class="code" href="classElement.html#a79">color</a>(<a class="code" href="classElement.html#a14">isSelected</a>() ? <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o9">selectColor</a>[0] : Qt::black);
00139       QPen pen(color);   <span class="comment">// Qt::SolidLine, Qt::FlatCap, Qt::MiterJoin);</span>
00140       pen.setWidthF(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o46">hairpinWidth</a>.<a class="code" href="classSpatium.html#a2">point</a>());
00141       p.setPen(pen);
00142 
00143       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciHairpinSegment</a> i = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00144             <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* s = *i;
00145 
00146             <a class="code" href="classpstl_1_1plist.html">ciHairpinSegment</a> ii = i;
00147             ++ii;
00148             QPointF pp1(s-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a>);
00149             QPointF pp2(s-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a>);
00150 
00151             <span class="keywordflow">if</span> (i == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>())
00152                   pp1 += <a class="code" href="classHairpin.html#r3">off1</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00153             <span class="keywordflow">if</span> (ii == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>())
00154                   pp2 += <a class="code" href="classHairpin.html#r4">off2</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00155 
00156             <span class="keywordflow">if</span> (i == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>() &amp;&amp; !<a class="code" href="classHairpin.html#r2">flip</a>) {
00157                   p.drawLine(QLineF(pp1.x(), pp1.y(), pp2.x(), pp2.y() + h1));
00158                   p.drawLine(QLineF(pp1.x(), pp1.y(), pp2.x(), pp2.y() - h1));
00159                   }
00160             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ii == <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>() &amp;&amp; <a class="code" href="classHairpin.html#r2">flip</a>) {
00161                   p.drawLine(QLineF(pp1.x(), pp1.y() + h1, pp2.x(), pp2.y()));
00162                   p.drawLine(QLineF(pp1.x(), pp1.y() - h1, pp2.x(), pp2.y()));
00163                   }
00164             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r2">flip</a>) {
00165                   p.drawLine(QLineF(pp1.x(), pp1.y()+h1, pp2.x(), pp2.y()+h2));
00166                   p.drawLine(QLineF(pp1.x(), pp1.y()-h1, pp2.x(), pp2.y()-h2));
00167                   }
00168             <span class="keywordflow">else</span> {
00169                   p.drawLine(QLineF(pp1.x(), pp1.y()+h2, pp2.x(), pp2.y()+h1));
00170                   p.drawLine(QLineF(pp1.x(), pp1.y()-h2, pp2.x(), pp2.y()-h1));
00171                   }
00172 <span class="comment">/*            if (debugMode) {</span>
00173 <span class="comment">                  Transformation m;</span>
00174 <span class="comment">                  m.setMag(p.tf()-&gt;mag());</span>
00175 <span class="comment">                  m.xoffset = p.tf()-&gt;xoffset;</span>
00176 <span class="comment">                  m.yoffset = p.tf()-&gt;yoffset;</span>
00177 <span class="comment">                  QPainter pp(p.device(), &amp;m);</span>
00178 <span class="comment">                  pp.setPen(Qt::red);</span>
00179 <span class="comment">                  pp.setBrush(Qt::NoBrush);</span>
00180 <span class="comment">                  pp.drawRect(s-&gt;bbox + aref());</span>
00181 <span class="comment">                  pp.setPen(Qt::blue);</span>
00182 <span class="comment">                  }</span>
00183 <span class="comment">*/</span>
00184             }
00185 
00186       <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> != <a class="code" href="classHairpin.html#y3y0">NORMAL</a>) {
00187             <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* s1 = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a12">front</a>();
00188             <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* s2 = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00189             QPointF pp1(s1-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a> + <a class="code" href="classHairpin.html#r3">off1</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00190             QPointF pp2(s2-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a> + <a class="code" href="classHairpin.html#r4">off2</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00191             <a class="code" href="utils_8h.html#a0">drawHandle</a>(p, pp1, <a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y1">DRAG1</a>);
00192             <a class="code" href="utils_8h.html#a0">drawHandle</a>(p, pp2, <a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y2">DRAG2</a>);
00193             }
00194       }
00195 
00196 <span class="comment">//---------------------------------------------------------</span>
00197 <span class="comment">//   startEdit</span>
00198 <span class="comment">//---------------------------------------------------------</span>
00199 
<a name="l00200"></a><a class="code" href="classHairpin.html#a14">00200</a> <span class="keywordtype">bool</span> <a class="code" href="classHairpin.html#a14">Hairpin::startEdit</a>()
00201       {
00202 <span class="preprocessor">#if 0</span>
00203 <span class="preprocessor"></span>      <a class="code" href="classHairpin.html#r8">mode</a> = <a class="code" href="classHairpin.html#y3y2">DRAG2</a>;
00204       <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* s1 = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a12">front</a>();
00205       <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* s2 = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00206       QPointF pp1(s1-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a> + <a class="code" href="classHairpin.html#r3">off1</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00207       QPointF pp2(s2-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a> + <a class="code" href="classHairpin.html#r4">off2</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00208       <a class="code" href="classHairpin.html#r5">r1</a> = QRectF(tf-&gt;irect2frect(<a class="code" href="utils_8cpp.html#a2">handleRect</a>(tf-&gt;fpos2ipoint(pp1))));
00209       <a class="code" href="classHairpin.html#r6">r2</a> = QRectF(tf-&gt;irect2frect(<a class="code" href="utils_8cpp.html#a2">handleRect</a>(tf-&gt;fpos2ipoint(pp2))));
00210       <a class="code" href="classHairpin.html#d0">bboxUpdate</a>();
00211 <span class="preprocessor">#endif</span>
00212 <span class="preprocessor"></span>      <span class="keywordflow">return</span> <span class="keyword">true</span>;
00213       }
00214 
00215 <span class="comment">//---------------------------------------------------------</span>
00216 <span class="comment">//   editStartDrag</span>
00217 <span class="comment">//---------------------------------------------------------</span>
00218 
<a name="l00219"></a><a class="code" href="classHairpin.html#a15">00219</a> <span class="keywordtype">bool</span> <a class="code" href="classHairpin.html#a15">Hairpin::editStartDrag</a>(<span class="keyword">const</span> QPointF&amp; p)
00220       {
00221       <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r5">r1</a>.contains(p))
00222             <a class="code" href="classHairpin.html#r8">mode</a> = <a class="code" href="classHairpin.html#y3y1">DRAG1</a>;
00223       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r6">r2</a>.contains(p))
00224             <a class="code" href="classHairpin.html#r8">mode</a> = <a class="code" href="classHairpin.html#y3y2">DRAG2</a>;
00225       <span class="keywordflow">else</span>
00226             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00227       <a class="code" href="classHairpin.html#d0">bboxUpdate</a>();
00228       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00229       }
00230 
00231 <span class="comment">//---------------------------------------------------------</span>
00232 <span class="comment">//   dragOff</span>
00233 <span class="comment">//---------------------------------------------------------</span>
00234 
<a name="l00235"></a><a class="code" href="classHairpin.html#a10">00235</a> QPointF <a class="code" href="classHairpin.html#a10">Hairpin::dragOff</a>()<span class="keyword"> const</span>
00236 <span class="keyword">      </span>{
00237       <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y1">DRAG1</a>)
00238             <span class="keywordflow">return</span> <a class="code" href="classHairpin.html#r3">off1</a>;
00239       <span class="keywordflow">else</span>
00240             <span class="keywordflow">return</span> <a class="code" href="classHairpin.html#r4">off2</a>;
00241       <span class="keywordflow">return</span> QPointF(0,0);
00242       }
00243 
00244 <span class="comment">//---------------------------------------------------------</span>
00245 <span class="comment">//   editDrag</span>
00246 <span class="comment">//---------------------------------------------------------</span>
00247 
<a name="l00248"></a><a class="code" href="classHairpin.html#a17">00248</a> <span class="keywordtype">bool</span> <a class="code" href="classHairpin.html#a17">Hairpin::editDrag</a>(QPointF*, <span class="keyword">const</span> QPointF&amp; d)
00249       {
00250       QPointF delta(d.x(), 0);    <span class="comment">// only x-axis move</span>
00251       delta /= <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00252       <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y1">DRAG1</a>) {
00253             QPointF d = delta - <a class="code" href="classHairpin.html#r3">off1</a>;
00254             off1  = delta;
00255             <a class="code" href="classHairpin.html#r5">r1</a>.moveTopLeft(<a class="code" href="classHairpin.html#r5">r1</a>.topLeft() + d);
00256             }
00257       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y2">DRAG2</a>) {
00258             QPointF d = delta - <a class="code" href="classHairpin.html#r4">off2</a>;
00259             off2 = delta;
00260             <a class="code" href="classHairpin.html#r6">r2</a>.moveTopLeft(<a class="code" href="classHairpin.html#r6">r2</a>.topLeft() + d);
00261             }
00262       <span class="keywordflow">else</span>
00263             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00264       <a class="code" href="classHairpin.html#d0">bboxUpdate</a>();
00265       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00266       }
00267 
00268 <span class="comment">//---------------------------------------------------------</span>
00269 <span class="comment">//   endEdit</span>
00270 <span class="comment">//---------------------------------------------------------</span>
00271 
<a name="l00272"></a><a class="code" href="classHairpin.html#a18">00272</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#a18">Hairpin::endEdit</a>()
00273       {
00274       <a class="code" href="classHairpin.html#r8">mode</a> = <a class="code" href="classHairpin.html#y3y0">NORMAL</a>;
00275       <a class="code" href="classHairpin.html#d0">bboxUpdate</a>();
00276       }
00277 
00278 <span class="comment">//---------------------------------------------------------</span>
00279 <span class="comment">//   edit</span>
00280 <span class="comment">//---------------------------------------------------------</span>
00281 
<a name="l00282"></a><a class="code" href="classHairpin.html#a19">00282</a> <span class="keywordtype">bool</span> <a class="code" href="classHairpin.html#a19">Hairpin::edit</a>(QKeyEvent* ev)
00283       {
00284       QPointF delta;
00285       <span class="keywordflow">switch</span> (ev-&gt;key()) {
00286             <span class="keywordflow">case</span> Qt::Key_Up:
00287                   _userOff.ry() += -.3;
00288                   <span class="keywordflow">break</span>;
00289             <span class="keywordflow">case</span> Qt::Key_Down:
00290                   _userOff.ry() += .3;
00291                   <span class="keywordflow">break</span>;
00292             <span class="keywordflow">case</span> Qt::Key_Left:
00293                   delta = QPointF(-1, 0);
00294                   <span class="keywordflow">break</span>;
00295             <span class="keywordflow">case</span> Qt::Key_Right:
00296                   delta = QPointF(1, 0);
00297                   <span class="keywordflow">break</span>;
00298             <span class="keywordflow">case</span> Qt::Key_Tab:
00299                   <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y1">DRAG1</a>)
00300                         <a class="code" href="classHairpin.html#r8">mode</a> = <a class="code" href="classHairpin.html#y3y2">DRAG2</a>;
00301                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> == DRAG2)
00302                         <a class="code" href="classHairpin.html#r8">mode</a> = <a class="code" href="classHairpin.html#y3y1">DRAG1</a>;
00303                   <span class="keywordflow">break</span>;
00304             }
00305       <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y1">DRAG1</a>) {
00306             <a class="code" href="classHairpin.html#r3">off1</a> += delta;
00307             <a class="code" href="classHairpin.html#r5">r1</a>.moveTopLeft(<a class="code" href="classHairpin.html#r5">r1</a>.topLeft() + delta * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00308             }
00309       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classHairpin.html#r8">mode</a> == <a class="code" href="classHairpin.html#y3y2">DRAG2</a>) {
00310             <a class="code" href="classHairpin.html#r4">off2</a> += delta;
00311             <a class="code" href="classHairpin.html#r6">r2</a>.moveTopLeft(<a class="code" href="classHairpin.html#r6">r2</a>.topLeft() + delta * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00312             }
00313 <span class="comment">//TODO      layout2();</span>
00314       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00315       }
00316 
00317 <span class="comment">//---------------------------------------------------------</span>
00318 <span class="comment">//   editEndDrag</span>
00319 <span class="comment">//---------------------------------------------------------</span>
00320 
<a name="l00321"></a><a class="code" href="classHairpin.html#a16">00321</a> <span class="keywordtype">bool</span> <a class="code" href="classHairpin.html#a16">Hairpin::editEndDrag</a>()
00322       {
00323 <span class="comment">//      layout2();</span>
00324       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00325       }
00326 
00327 <span class="comment">//---------------------------------------------------------</span>
00328 <span class="comment">//   contains</span>
00329 <span class="comment">//    return true if p is inside of bounding box of object</span>
00330 <span class="comment">//    p is relative to the coordinate system of parent()</span>
00331 <span class="comment">//---------------------------------------------------------</span>
00332 
<a name="l00333"></a><a class="code" href="classHairpin.html#a9">00333</a> <span class="keywordtype">bool</span> <a class="code" href="classHairpin.html#a9">Hairpin::contains</a>(<span class="keyword">const</span> QPointF&amp; p)<span class="keyword"> const</span>
00334 <span class="keyword">      </span>{
00335       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciHairpinSegment</a> i = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00336             <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* s = *i;
00337             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structHairpinSegment.html#o2">bbox</a>.contains(p - <a class="code" href="classElement.html#a20">pos</a>()))
00338                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00339             }
00340       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00341       }
00342 
00343 <span class="comment">//---------------------------------------------------------</span>
00344 <span class="comment">//   endDrag</span>
00345 <span class="comment">//---------------------------------------------------------</span>
00346 
<a name="l00347"></a><a class="code" href="classHairpin.html#a13">00347</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#a13">Hairpin::endDrag</a>()
00348       {
00349 <span class="comment">//      layout2();</span>
00350       }
00351 
00352 <span class="comment">//---------------------------------------------------------</span>
00353 <span class="comment">//   layout2</span>
00354 <span class="comment">//    snap to next tick positions</span>
00355 <span class="comment">//---------------------------------------------------------</span>
00356 
00357 <span class="preprocessor">#if 0</span>
00358 <span class="preprocessor"></span><span class="keywordtype">void</span> Hairpin::layout2(<a class="code" href="classScore.html">Score</a>* cs)
00359       {
00360 <span class="comment">//      printf("layout2 %d %d\n", _tick1, _tick2);</span>
00361 
00362       QPointF apos = <a class="code" href="classElement.html#a27">aref</a>();
00363       QPointF pp1(segments.<a class="code" href="classpstl_1_1plist.html#a12">front</a>()-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a> + off1 * <a class="code" href="spatium_8h.html#a0">_spatium</a> + apos);
00364       QPointF pp2(segments.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a>  + off2 * <a class="code" href="spatium_8h.html#a0">_spatium</a> + apos);
00365 
00366       <a class="code" href="classSegment.html">Segment</a>* seg1;
00367       <a class="code" href="classSegment.html">Segment</a>* seg2;
00368       QPointF o1;
00369       QPointF o2;
00370       <a class="code" href="classStaff.html">Staff</a>* stf = <a class="code" href="classElement.html#a59">staff</a>();
00371       <a class="code" href="classMeasure.html">Measure</a>* measure1 = cs-&gt;<a class="code" href="classScore.html#a21">pos2measure</a>(pp1, &amp;_tick1, &amp;stf, 0, &amp;seg1, &amp;o1);
00372       <a class="code" href="classMeasure.html">Measure</a>* measure2 = cs-&gt;<a class="code" href="classScore.html#a21">pos2measure</a>(pp2, &amp;_tick2, &amp;stf, 0, &amp;seg2, &amp;o2);
00373 
00374       <span class="keywordflow">if</span> (measure1 == 0 || measure2 == 0) {
00375             printf(<span class="stringliteral">"layout2: cannot layout hairpin\n"</span>);
00376             <span class="keywordflow">return</span>;
00377             }
00378       <a class="code" href="classHairpin.html#r3">off1</a> = (o1 - <a class="code" href="classElement.html#p1">_pos</a>) / <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00379       <a class="code" href="classHairpin.html#r4">off2</a> = (o2 - <a class="code" href="classElement.html#p1">_pos</a>) / <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00380       }
00381 <span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>
00383 <span class="comment">//---------------------------------------------------------</span>
00384 <span class="comment">//   layout</span>
00385 <span class="comment">//    compute segments from tick1 tick2</span>
00386 <span class="comment">//---------------------------------------------------------</span>
00387 
<a name="l00388"></a><a class="code" href="classHairpin.html#a20">00388</a> <span class="keywordtype">void</span> <a class="code" href="classElement.html#a66">Hairpin::layout</a>(<a class="code" href="classScore.html">Score</a>* cs)
00389       {
00390       <span class="keywordtype">double</span> y = 0;
00391 <span class="comment">//      printf("layout %d %d\n", _tick1, _tick2);</span>
00392 
00393       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">iHairpinSegment</a> i = <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00394             <span class="keyword">delete</span> *i;
00395       <a class="code" href="classHairpin.html#r7">segments</a>.clear();
00396 
00397       <a class="code" href="classSegment.html">Segment</a>* seg1     = cs-&gt;<a class="code" href="classScore.html#a129">tick2segment</a>(<a class="code" href="classHairpin.html#r0">_tick1</a>);
00398       <a class="code" href="classSegment.html">Segment</a>* seg2     = cs-&gt;<a class="code" href="classScore.html#a129">tick2segment</a>(<a class="code" href="classHairpin.html#r1">_tick2</a>);
00399       <span class="keywordflow">if</span> (seg1 == 0 || seg2 == 0) {
00400             printf(<span class="stringliteral">"Hairpin Layout: seg not found\n"</span>);
00401             <span class="keywordflow">return</span>;
00402             }
00403       <a class="code" href="classMeasure.html">Measure</a>* measure1 = seg1-&gt;<a class="code" href="classSegment.html#a14">measure</a>();
00404       <a class="code" href="classMeasure.html">Measure</a>* measure2 = seg2-&gt;<a class="code" href="classSegment.html#a14">measure</a>();
00405       <a class="code" href="classSystem.html">System</a>* system1   = measure1-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
00406       <a class="code" href="classSystem.html">System</a>* system2   = measure2-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
00407       <a class="code" href="classMeasure.html">Measure</a>* m        = (<a class="code" href="classMeasure.html">Measure</a>*)<a class="code" href="classElement.html#a10">parent</a>();
00408       <a class="code" href="classSystem.html">System</a>* s         = m-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
00409 
00410       QPointF ppos(m-&gt;<a class="code" href="classElement.html#a20">pos</a>() + s-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00411       QPointF p1 = QPointF(seg1-&gt;<a class="code" href="classSegment.html#a15">x</a>(), 0) + measure1-&gt;<a class="code" href="classElement.html#a20">pos</a>() + system1-&gt;<a class="code" href="classElement.html#a20">pos</a>() - ppos;
00412       QPointF p2 = QPointF(seg2-&gt;<a class="code" href="classSegment.html#a15">x</a>(), 0) + measure2-&gt;<a class="code" href="classElement.html#a20">pos</a>() + system2-&gt;<a class="code" href="classElement.html#a20">pos</a>() - ppos;
00413       <a class="code" href="classpstl_1_1plist.html">iSystem</a> is = cs-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00414       <span class="keywordflow">while</span> (is != cs-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00415             <span class="keywordflow">if</span> (*is == system1)
00416                   <span class="keywordflow">break</span>;
00417             ++is;
00418             }
00419       <span class="keywordflow">for</span> (;is != cs-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++is) {
00420             <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* hps = <span class="keyword">new</span> <a class="code" href="structHairpinSegment.html">HairpinSegment</a>;
00421             <span class="keywordflow">if</span> (*is == system1)
00422                   hps-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a> = p1;
00423             <span class="keywordflow">else</span> {
00424                   <a class="code" href="classMeasure.html">Measure</a>* mm = (*is)-&gt;measures()-&gt;front();
00425                   hps-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a> = (*is)-&gt;pos() + mm-&gt;<a class="code" href="classElement.html#a20">pos</a>() - ppos;
00426                   }
00427             hps-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a> = p2;
00428             <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(hps);
00429             <span class="keywordflow">if</span> (*is == system2)
00430                   <span class="keywordflow">break</span>;
00431             hps-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a> = (*is)-&gt;pos() + QPointF((*is)-&gt;bbox().width() - <a class="code" href="spatium_8h.html#a0">_spatium</a> * 0.5, 0) - ppos;
00432             }
00433       setpos(0, <a class="code" href="spatium_8h.html#a0">_spatium</a> * 6 + y);
00434       <a class="code" href="classHairpin.html#d0">bboxUpdate</a>();
00435       }
00436 
00437 <span class="comment">//---------------------------------------------------------</span>
00438 <span class="comment">//   setLen</span>
00439 <span class="comment">//    used to create a Hairpin object suitable for palette</span>
00440 <span class="comment">//---------------------------------------------------------</span>
00441 
<a name="l00442"></a><a class="code" href="classHairpin.html#a3">00442</a> <span class="keywordtype">void</span> <a class="code" href="classHairpin.html#a3">Hairpin::setLen</a>(<span class="keywordtype">double</span> l)
00443       {
00444       <a class="code" href="structHairpinSegment.html">HairpinSegment</a>* hps = <span class="keyword">new</span> <a class="code" href="structHairpinSegment.html">HairpinSegment</a>;
00445       hps-&gt;<a class="code" href="structHairpinSegment.html#o0">p1</a> = QPointF(0, 0);
00446       hps-&gt;<a class="code" href="structHairpinSegment.html#o1">p2</a> = QPointF(l, 0);
00447       <a class="code" href="classHairpin.html#r7">segments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(hps);
00448       <a class="code" href="classHairpin.html#d0">bboxUpdate</a>();
00449       }
00450 
00451 <span class="comment">//---------------------------------------------------------</span>
00452 <span class="comment">//   Hairpin</span>
00453 <span class="comment">//---------------------------------------------------------</span>
00454 
<a name="l00455"></a><a class="code" href="classHairpin.html#a0">00455</a> <a class="code" href="classHairpin.html#a0">Hairpin::Hairpin</a>(<a class="code" href="classScore.html">Score</a>* s)
00456    : <a class="code" href="classElement.html">Element</a>(s, <a class="code" href="element_8h.html#a65a10">GABEL</a>)
00457       {
00458       <a class="code" href="classHairpin.html#r2">flip</a> = <span class="keyword">false</span>;
00459       <a class="code" href="classHairpin.html#r8">mode</a>   = <a class="code" href="classHairpin.html#y3y0">NORMAL</a>;
00460       }
00461 
<a name="l00462"></a><a class="code" href="classHairpin.html#a1">00462</a> <a class="code" href="classHairpin.html#a0">Hairpin::Hairpin</a>(<span class="keyword">const</span> <a class="code" href="classHairpin.html">Hairpin</a>&amp; g)
00463    : <a class="code" href="classElement.html">Element</a>(g)
00464       {
00465       <a class="code" href="classHairpin.html#r8">mode</a>   = g.<a class="code" href="classHairpin.html#r8">mode</a>;
00466       <a class="code" href="classHairpin.html#r2">flip</a>   = g.<a class="code" href="classHairpin.html#r2">flip</a>;
00467       <a class="code" href="classHairpin.html#r0">_tick1</a> = g.<a class="code" href="classHairpin.html#r0">_tick1</a>;
00468       <a class="code" href="classHairpin.html#r1">_tick2</a> = g.<a class="code" href="classHairpin.html#r1">_tick2</a>;
00469       }
00470 
00471 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
