<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: file.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>file.cpp</h1><a href="file_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: file.cpp,v 1.37 2005/06/27 19:50:18 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="xml_8h.html">xml.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="element_8h.html">element.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="key_8h.html">key.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="instrdialog_8h.html">instrdialog.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="page_8h.html">page.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="dynamics_8h.html">dynamics.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="file_8h.html">file.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="tempo_8h.html">tempo.h</a>"</span>
00026 <span class="preprocessor">#include "<a class="code" href="select_8h.html">select.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="padstate_8h.html">padstate.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="preferences_8h.html">preferences.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="input_8h.html">input.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="playpanel_8h.html">playpanel.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="part_8h.html">part.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00034 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00035 
00036 <span class="comment">//---------------------------------------------------------</span>
00037 <span class="comment">//   readInstrument</span>
00038 <span class="comment">//---------------------------------------------------------</span>
00039 
<a name="l00040"></a><a class="code" href="file_8cpp.html#a0">00040</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="file_8cpp.html#a0">readInstrument</a>(<span class="keyword">const</span> QString&amp; group, QDomNode node)
00041       {
00042       <span class="keywordtype">int</span> clef[<a class="code" href="globals_8h.html#a4">MAX_STAVES</a>];
00043       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="globals_8h.html#a4">MAX_STAVES</a>; ++i)
00044             clef[i] = 0;
00045       QString name;
00046       QString shortName;
00047       <span class="keywordtype">int</span> staves = 1;
00048       <span class="keywordtype">int</span> clefIdx = 0;
00049 
00050       node = node.firstChild();
00051       <span class="keywordflow">while</span> (!node.isNull()) {
00052             QDomElement e = node.toElement();
00053             QString tag(e.tagName());
00054             QString val(e.text());
00055             <span class="keywordtype">int</span> i = val.toInt();
00056             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"name"</span>)
00057                   name = val;
00058             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"short-name"</span>)
00059                   shortName = val;
00060             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"staves"</span>)
00061                   staves = i;
00062             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"clef"</span>) {
00063                   clef[clefIdx] = i;
00064                   ++clefIdx;
00065                   <span class="keywordflow">if</span> (clefIdx &gt;= <a class="code" href="globals_8h.html#a4">MAX_STAVES</a>)
00066                         clefIdx = <a class="code" href="globals_8h.html#a4">MAX_STAVES</a>-1;
00067                   }
00068             <span class="keywordflow">else</span>
00069                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00070             node = node.nextSibling();
00071             }
00072 
00073       <a class="code" href="instrdialog_8cpp.html#a0">instrumentTemplates</a>.push_back(<a class="code" href="structInstrumentTemplate.html">InstrumentTemplate</a>(group, name, shortName,
00074          staves, clef));
00075       }
00076 
00077 <span class="comment">//---------------------------------------------------------</span>
00078 <span class="comment">//   readInstrumentGroup</span>
00079 <span class="comment">//---------------------------------------------------------</span>
00080 
<a name="l00081"></a><a class="code" href="file_8cpp.html#a1">00081</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="file_8cpp.html#a1">readInstrumentGroup</a>(QDomNode node)
00082       {
00083       QDomElement e = node.toElement();
00084       QString group = e.attribute(<span class="stringliteral">"name"</span>);
00085 
00086       node = node.firstChild();
00087       <span class="keywordflow">while</span> (!node.isNull()) {
00088             QDomElement e = node.toElement();
00089             QString tag(e.tagName());
00090 
00091             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"instrument"</span>)
00092                   <a class="code" href="file_8cpp.html#a0">readInstrument</a>(group, node);
00093             <span class="keywordflow">else</span>
00094                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00095             node = node.nextSibling();
00096             }
00097       }
00098 
00099 <span class="comment">//---------------------------------------------------------</span>
00100 <span class="comment">//   getFile</span>
00101 <span class="comment">//    return true on error</span>
00102 <span class="comment">//---------------------------------------------------------</span>
00103 
<a name="l00104"></a><a class="code" href="classLoadFile.html#a3">00104</a> <span class="keywordtype">bool</span> <a class="code" href="classLoadFile.html#a3">LoadFile::load</a>(QWidget* parent, <span class="keyword">const</span> QString&amp; base, <span class="keyword">const</span> QString&amp; ext,
00105    <span class="keyword">const</span> QString&amp; caption)
00106       {
00107       <a class="code" href="classLoadFile.html#p0">error</a> = <span class="stringliteral">""</span>;
00108       <a class="code" href="classLoadFile.html#r1">_name</a> = Q3FileDialog::getOpenFileName(
00109          base, ext, parent, QWidget::tr(<span class="stringliteral">"load"</span>), caption);
00110       <span class="keywordflow">if</span> (<a class="code" href="classLoadFile.html#r1">_name</a>.isEmpty())
00111             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00112       QFileInfo info(<a class="code" href="classLoadFile.html#r1">_name</a>);
00113       QString zip;
00114 
00115       <a class="code" href="classLoadFile.html#r0">popenFlag</a> = <span class="keyword">false</span>;
00116       <span class="keywordflow">if</span> (info.extension(<span class="keyword">true</span>) == QString(<span class="stringliteral">""</span>)) {
00117             <a class="code" href="classLoadFile.html#r1">_name</a> += ext;
00118             info.setFile(<a class="code" href="classLoadFile.html#r1">_name</a>);
00119             }
00120       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == QString(<span class="stringliteral">"gz"</span>)) {
00121             <a class="code" href="classLoadFile.html#r0">popenFlag</a> = <span class="keyword">true</span>;
00122             zip = QString(<span class="stringliteral">"gunzip"</span>);
00123             }
00124       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == QString(<span class="stringliteral">"bz2"</span>)) {
00125             <a class="code" href="classLoadFile.html#r0">popenFlag</a> = <span class="keyword">true</span>;
00126             zip = QString(<span class="stringliteral">"bunzip2"</span>);
00127             }
00128       FILE* fp = 0;
00129       <span class="keywordflow">if</span> (<a class="code" href="classLoadFile.html#r0">popenFlag</a>) {
00130             zip += QString(<span class="stringliteral">" &lt; "</span>);
00131             zip += <a class="code" href="classLoadFile.html#r1">_name</a>;
00132             fp  = popen(zip.ascii(), <span class="stringliteral">"r"</span>);
00133             }
00134       <span class="keywordflow">else</span> {
00135             fp = fopen(<a class="code" href="classLoadFile.html#r1">_name</a>.ascii(), <span class="stringliteral">"r"</span>);
00136             }
00137       <span class="keywordflow">if</span> (fp == 0)
00138             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00139       <span class="keywordflow">if</span> (<a class="code" href="classLoadFile.html#a2">loader</a>(fp)) {
00140             QMessageBox::warning(parent,
00141                QWidget::tr(<span class="stringliteral">"MuseScore: load failed:"</span>),
00142                <a class="code" href="classLoadFile.html#p0">error</a>,
00143                QString::null, QWidget::tr(<span class="stringliteral">"Quit"</span>), QString::null, 0, 1);
00144             }
00145       <span class="keywordflow">if</span> (<a class="code" href="classLoadFile.html#r0">popenFlag</a>)
00146             pclose(fp);
00147       <span class="keywordflow">else</span>
00148             fclose(fp);
00149       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00150       }
00151 
<a name="l00152"></a><a class="code" href="classLoadFile.html#a4">00152</a> <span class="keywordtype">bool</span> <a class="code" href="classLoadFile.html#a3">LoadFile::load</a>(<span class="keyword">const</span> QString&amp; name)
00153       {
00154       <span class="keywordflow">if</span> (name.isEmpty())
00155             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00156       QString zip;
00157 
00158       QFileInfo info(name);
00159       <a class="code" href="classLoadFile.html#r0">popenFlag</a> = <span class="keyword">false</span>;
00160       <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == QString(<span class="stringliteral">"gz"</span>)) {
00161             <a class="code" href="classLoadFile.html#r0">popenFlag</a> = <span class="keyword">true</span>;
00162             zip = QString(<span class="stringliteral">"gzip"</span>);
00163             }
00164       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == QString(<span class="stringliteral">"bz2"</span>)) {
00165             <a class="code" href="classLoadFile.html#r0">popenFlag</a> = <span class="keyword">true</span>;
00166             zip = QString(<span class="stringliteral">"bzip2"</span>);
00167             }
00168       FILE* fp = 0;
00169       <span class="keywordflow">if</span> (<a class="code" href="classLoadFile.html#r0">popenFlag</a>) {
00170             zip += QString(<span class="stringliteral">" &gt; "</span>);
00171             zip += name;
00172             fp  = popen(zip.ascii(), <span class="stringliteral">"r"</span>);
00173             }
00174       <span class="keywordflow">else</span> {
00175             fp = fopen(name.ascii(), <span class="stringliteral">"r"</span>);
00176             }
00177       <span class="keywordflow">if</span> (fp == 0)
00178             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00179       <span class="keywordflow">if</span> (<a class="code" href="classLoadFile.html#a2">loader</a>(fp)) {
00180             QMessageBox::warning(0,
00181                QWidget::tr(<span class="stringliteral">"MuseScore: load failed:"</span>),
00182                <a class="code" href="classLoadFile.html#p0">error</a>,
00183                QString::null, QWidget::tr(<span class="stringliteral">"Quit"</span>), QString::null, 0, 1);
00184             }
00185       <span class="keywordflow">if</span> (<a class="code" href="classLoadFile.html#r0">popenFlag</a>)
00186             pclose(fp);
00187       <span class="keywordflow">else</span>
00188             fclose(fp);
00189       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00190       }
00191 
00192 <span class="comment">//---------------------------------------------------------</span>
00193 <span class="comment">//   SaveFile</span>
00194 <span class="comment">//---------------------------------------------------------</span>
00195 
<a name="l00196"></a><a class="code" href="classSaveFile.html#a3">00196</a> <span class="keywordtype">bool</span> <a class="code" href="classSaveFile.html#a3">SaveFile::save</a>(QWidget* p, <span class="keyword">const</span> QString&amp; base, <span class="keyword">const</span> QString&amp; ext,
00197    <span class="keyword">const</span> QString&amp; caption)
00198       {
00199       <a class="code" href="classSaveFile.html#p0">parent</a> = p;
00200       QString pattern(<span class="stringliteral">"*"</span>);
00201       pattern += ext;
00202       <a class="code" href="classSaveFile.html#r1">_name</a> = Q3FileDialog::getSaveFileName(
00203          base, pattern, <a class="code" href="classSaveFile.html#p0">parent</a>, QWidget::tr(<span class="stringliteral">"save"</span>), caption);
00204       <span class="keywordflow">if</span> (<a class="code" href="classSaveFile.html#r1">_name</a>.isEmpty())
00205             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00206       <span class="keywordtype">bool</span> <a class="code" href="classSaveFile.html#r0">popenFlag</a> = <span class="keyword">false</span>;
00207       QFileInfo info(<a class="code" href="classSaveFile.html#r1">_name</a>);
00208       QString zip;
00209 
00210       <span class="keywordflow">if</span> (info.extension(<span class="keyword">true</span>) == QString(<span class="stringliteral">""</span>)) {
00211             <a class="code" href="classSaveFile.html#r1">_name</a> += ext;
00212             info.setFile(<a class="code" href="classSaveFile.html#r1">_name</a>);
00213             }
00214       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == QString(<span class="stringliteral">"gz"</span>)) {
00215             popenFlag = <span class="keyword">true</span>;
00216             zip = <span class="stringliteral">"gzip"</span>;
00217             }
00218       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == QString(<span class="stringliteral">"bz2"</span>)) {
00219             popenFlag = <span class="keyword">true</span>;
00220             zip = <span class="stringliteral">"bzip2"</span>;
00221             }
00222       <span class="keywordflow">if</span> (info.exists()) {
00223             QString s = QWidget::tr(<span class="stringliteral">"File\n"</span>) + <a class="code" href="classSaveFile.html#r1">_name</a> + QWidget::tr(<span class="stringliteral">"\nexists"</span>);
00224             <span class="keywordtype">int</span> rv = QMessageBox::warning(<a class="code" href="classSaveFile.html#p0">parent</a>,
00225                QWidget::tr(<span class="stringliteral">"MuseScore: write"</span>),
00226                s,
00227                QWidget::tr(<span class="stringliteral">"Overwrite"</span>), QWidget::tr(<span class="stringliteral">"Quit"</span>), QString::null, 0, 1);
00228             <span class="keywordflow">switch</span>(rv) {
00229                   <span class="keywordflow">case</span> 0:  <span class="comment">// overwrite</span>
00230                         <span class="keywordflow">break</span>;
00231                   <span class="keywordflow">case</span> 1:  <span class="comment">// quit</span>
00232                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00233                   }
00234             }
00235       <span class="keywordflow">if</span> (popenFlag) {
00236             zip += <span class="stringliteral">" &gt; "</span>;
00237             zip += <a class="code" href="classSaveFile.html#r1">_name</a>;
00238             <a class="code" href="classSaveFile.html#p1">f</a>  = popen(zip.ascii(), <span class="stringliteral">"w"</span>);
00239             }
00240       <span class="keywordflow">else</span> {
00241             <a class="code" href="classSaveFile.html#p1">f</a> = fopen(<a class="code" href="classSaveFile.html#r1">_name</a>.ascii(), <span class="stringliteral">"w"</span>);
00242             }
00243       <span class="keywordflow">if</span> (<a class="code" href="classSaveFile.html#p1">f</a> == 0) {
00244             QString s = QWidget::tr(<span class="stringliteral">"Open File\n"</span>) + <a class="code" href="classSaveFile.html#r1">_name</a> + QWidget::tr(<span class="stringliteral">"\nfailed: "</span>)
00245                + QString(strerror(errno));
00246             QMessageBox::critical(<a class="code" href="classSaveFile.html#p0">parent</a>, QWidget::tr(<span class="stringliteral">"MuseScore: Open File"</span>), s);
00247             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00248             }
00249       <a class="code" href="classSaveFile.html#a2">saver</a>();
00250       <span class="keywordtype">bool</span> notOk = ferror(<a class="code" href="classSaveFile.html#p1">f</a>);
00251       <span class="keywordflow">if</span> (notOk) {
00252             QString s = QString(<span class="stringliteral">"Write failed: "</span>) + QString(strerror(errno));
00253             QMessageBox::critical(<a class="code" href="classSaveFile.html#p0">parent</a>, QWidget::tr(<span class="stringliteral">"MuseScore: Write"</span>), s);
00254             }
00255       <span class="keywordflow">if</span> (popenFlag)
00256             pclose(<a class="code" href="classSaveFile.html#p1">f</a>);
00257       <span class="keywordflow">else</span>
00258             fclose(<a class="code" href="classSaveFile.html#p1">f</a>);
00259       <span class="keywordflow">return</span> notOk;
00260       }
00261 
00262 <span class="comment">//---------------------------------------------------------</span>
00263 <span class="comment">//   checkDirty</span>
00264 <span class="comment">//    if dirty, save current project</span>
00265 <span class="comment">//    return true if project stays dirty</span>
00266 <span class="comment">//---------------------------------------------------------</span>
00267 
<a name="l00268"></a><a class="code" href="classMuseScore.html#a2">00268</a> <span class="keywordtype">bool</span> <a class="code" href="classMuseScore.html#a2">MuseScore::checkDirty</a>()
00269       {
00270       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o2">dirty</a>) {
00271             <span class="keywordtype">int</span> n = QMessageBox::warning(<span class="keyword">this</span>, tr(<span class="stringliteral">"MuseScore"</span>),
00272                tr(<span class="stringliteral">"The current Score contains unsaved data\n"</span>
00273                <span class="stringliteral">"Save Current Score?"</span>),
00274                tr(<span class="stringliteral">"&amp;Save"</span>), tr(<span class="stringliteral">"&amp;Nosave"</span>), tr(<span class="stringliteral">"&amp;Abort"</span>), 0, 2);
00275             <span class="keywordflow">if</span> (n == 0) {
00276                   <span class="keywordflow">if</span> (!<a class="code" href="classMuseScore.html#k25">saveFile</a>())
00277                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00278                   }
00279             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n == 2)
00280                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00281             }
00282       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00283       }
00284 
00285 <span class="comment">//---------------------------------------------------------</span>
00286 <span class="comment">//   clearScore</span>
00287 <span class="comment">//---------------------------------------------------------</span>
00288 
<a name="l00289"></a><a class="code" href="classMuseScore.html#a3">00289</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#a3">MuseScore::clearScore</a>()
00290       {
00291       <a class="code" href="style_8cpp.html#a7">setDefaultStyle</a>();
00292       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a2">clear</a>();
00293       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a5">clear</a>();
00294       <a class="code" href="classMuseScore.html#r1">canvas</a>-&gt;<a class="code" href="classCanvas.html#a11">clearScore</a>();
00295       }
00296 
00297 <span class="comment">//---------------------------------------------------------</span>
00298 <span class="comment">//   loadFile</span>
00299 <span class="comment">//---------------------------------------------------------</span>
00300 
<a name="l00301"></a><a class="code" href="classMuseScore.html#k24">00301</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k24">MuseScore::loadFile</a>()
00302       {
00303       QString fn = Q3FileDialog::getOpenFileName(
00304          QString(<span class="stringliteral">"."</span>),
00305          QString(<span class="stringliteral">"Score files (*.msc);; MusicXml files (*.xml *.xml.gz *.xml.bz2);; All files (*)"</span>),
00306          <span class="keyword">this</span>, tr(<span class="stringliteral">"loadFile"</span>), tr(<span class="stringliteral">"MuseScore: load Score"</span>));
00307       <span class="keywordflow">if</span> (fn.isEmpty())
00308             <span class="keywordflow">return</span>;
00309       <a class="code" href="classScore.html">Score</a>* score = <span class="keyword">new</span> <a class="code" href="classScore.html">Score</a>();
00310       score-&gt;<a class="code" href="classScore.html#a112">read</a>(fn);
00311       <a class="code" href="classMuseScore.html#a8">appendScore</a>(score);
00312       <a class="code" href="classMuseScore.html#r3">tab</a>-&gt;setCurrentTab(<a class="code" href="classMuseScore.html#r43">scoreList</a>.size() - 1);
00313       }
00314 
00315 <span class="comment">//---------------------------------------------------------</span>
00316 <span class="comment">//   saveFile</span>
00317 <span class="comment">//    return true on success</span>
00318 <span class="comment">//---------------------------------------------------------</span>
00319 
<a name="l00320"></a><a class="code" href="classMuseScore.html#k25">00320</a> <span class="keywordtype">bool</span> <a class="code" href="classMuseScore.html#k25">MuseScore::saveFile</a>()
00321       {
00322       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o1">projectName</a>.isEmpty()) {
00323             QString fn = Q3FileDialog::getSaveFileName(
00324                QString(<span class="stringliteral">"."</span>), QString(<span class="stringliteral">"*.msc"</span>), <span class="keyword">this</span>, tr(<span class="stringliteral">"saveFile"</span>), tr(<span class="stringliteral">"MuseScore: save Score"</span>));
00325             <span class="keywordflow">if</span> (fn.isEmpty())
00326                   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00327             <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o1">projectName</a> = fn;
00328             }
00329 
00330       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o3">saved</a>) {
00331             <span class="keywordtype">bool</span> rv = <a class="code" href="classMuseScore.html#k25">saveFile</a>(<a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o1">projectName</a>, <span class="keyword">false</span>);
00332             <span class="keywordflow">if</span> (rv)
00333                   <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o2">dirty</a> = <span class="keyword">false</span>;
00334             <span class="keywordflow">return</span> rv;
00335             }
00336 
00337       QString name(<a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o1">projectName</a>);
00338       QFileInfo qf(name);
00339       <span class="keywordflow">if</span> (qf.extension(<span class="keyword">true</span>) == <span class="stringliteral">""</span>)
00340             name += QString(<span class="stringliteral">".msc"</span>);
00341       QString backupName = qf.dirPath() + QString(<span class="stringliteral">"/."</span>) + qf.fileName() + QString(<span class="stringliteral">","</span>);
00342 
00343       <span class="keywordtype">int</span> n = strlen(qf.dirPath().latin1()) + 2 + 6 + 1;
00344       <span class="keywordtype">char</span> tname[n];
00345       sprintf(tname, <span class="stringliteral">"%s/msXXXXXX"</span>, qf.dirPath().latin1());
00346       <span class="keywordtype">int</span> fd = mkstemp(tname);
00347       FILE* fp = fdopen(fd, <span class="stringliteral">"w"</span>);
00348 
00349       <span class="keywordflow">if</span> (fp == 0) {
00350             QString s = tr(<span class="stringliteral">"Open Temp File\n"</span>) + QString(tname) + tr(<span class="stringliteral">"\nfailed: "</span>)
00351                + QString(strerror(errno));
00352             QMessageBox::critical(<span class="keyword">this</span>, tr(<span class="stringliteral">"MuseScore: Open File"</span>), s);
00353             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00354             }
00355       <span class="keyword">const</span> <span class="keywordtype">char</span>* pname = name.latin1();
00356       <span class="keywordtype">bool</span> rv = <a class="code" href="classMuseScore.html#k25">saveFile</a>(fp);
00357       fclose(fp);
00358       <span class="keywordflow">if</span> (!rv)
00359             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00360 
00361       unlink(backupName.latin1());
00362       <span class="keywordflow">if</span> (link(pname, backupName.latin1()) == 0) {
00363             <span class="keywordflow">if</span> (unlink(pname))
00364                   printf(<span class="stringliteral">"unlink %s failed: %s\n"</span>, pname, strerror(errno));
00365             }
00366 
00367       <span class="keywordflow">if</span> (link(tname, pname) == 0) {
00368             <span class="keywordflow">if</span> (unlink(tname))
00369                   printf(<span class="stringliteral">"unlink %s failed: %s\n"</span>, tname, strerror(errno));
00370             }
00371       <span class="keywordflow">else</span>
00372             printf(<span class="stringliteral">"link %s -&gt; %s failed: %s\n"</span>, tname, pname, strerror(errno));
00373       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o2">dirty</a> = <span class="keyword">false</span>;
00374       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o3">saved</a> = <span class="keyword">true</span>;
00375       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00376       }
00377 
00378 <span class="comment">//---------------------------------------------------------</span>
00379 <span class="comment">//   saveAs</span>
00380 <span class="comment">//    return true on success</span>
00381 <span class="comment">//---------------------------------------------------------</span>
00382 
<a name="l00383"></a><a class="code" href="classMuseScore.html#k26">00383</a> <span class="keywordtype">bool</span> <a class="code" href="classMuseScore.html#k26">MuseScore::saveAs</a>()
00384       {
00385       QString fn = Q3FileDialog::getSaveFileName(
00386          QString(<span class="stringliteral">"."</span>), QString(<span class="stringliteral">"*.msc"</span>), <span class="keyword">this</span>, tr(<span class="stringliteral">"saveAs"</span>), tr(<span class="stringliteral">"MuseScore: save As"</span>)
00387          );
00388       <span class="keywordflow">if</span> (fn.isEmpty())
00389             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00390       <span class="keywordflow">return</span> <a class="code" href="classMuseScore.html#k25">saveFile</a>(fn, <span class="keyword">true</span>);
00391       }
00392 
00393 <span class="comment">//---------------------------------------------------------</span>
00394 <span class="comment">//   newFile</span>
00395 <span class="comment">//    create new score</span>
00396 <span class="comment">//---------------------------------------------------------</span>
00397 
<a name="l00398"></a><a class="code" href="classMuseScore.html#k27">00398</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k27">MuseScore::newFile</a>()
00399       {
00400       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#a2">checkDirty</a>())
00401             <span class="keywordflow">return</span>;
00402       QString path(<a class="code" href="mscore_8cpp.html#a0">mscoreGlobalShare</a>);
00403       path += <span class="stringliteral">"/templates"</span>;
00404       QString fn = Q3FileDialog::getOpenFileName(
00405          path,
00406          <span class="stringliteral">"Score templates (*.msc *.msc.gz *.msc.bz2);; Any files (*)"</span>,
00407          <span class="keyword">this</span>, tr(<span class="stringliteral">"newFile"</span>), tr(<span class="stringliteral">"MuseScore: load template"</span>));
00408       <span class="keywordflow">if</span> (fn.isEmpty()) {
00409             <a class="code" href="classMuseScore.html#a3">clearScore</a>();
00410             <span class="keywordflow">return</span>;
00411             }
00412 <span class="comment">//TODO      loadFile(fn, true);</span>
00413       }
00414 
00415 <span class="comment">//---------------------------------------------------------</span>
00416 <span class="comment">//   saveFile</span>
00417 <span class="comment">//    return true on success</span>
00418 <span class="comment">//---------------------------------------------------------</span>
00419 
<a name="l00420"></a><a class="code" href="classMuseScore.html#a4">00420</a> <span class="keywordtype">bool</span> <a class="code" href="classMuseScore.html#k25">MuseScore::saveFile</a>(<span class="keyword">const</span> QString&amp; n, <span class="keywordtype">bool</span> overwriteWarning)
00421       {
00422       QString name(n);
00423       QFileInfo info(name);
00424       QString zip;
00425       QString ext(<span class="stringliteral">".msc"</span>);
00426 
00427       <span class="keywordtype">bool</span> popenFlag = <span class="keyword">false</span>;
00428       <span class="keywordflow">if</span> (info.extension(<span class="keyword">true</span>).isEmpty()) {
00429             name += ext;
00430             info.setFile(name);
00431             }
00432       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == <span class="stringliteral">"gz"</span>) {
00433             popenFlag = <span class="keyword">true</span>;
00434             zip = <span class="stringliteral">"gzip"</span>;
00435             }
00436       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == <span class="stringliteral">"bz2"</span>) {
00437             popenFlag = <span class="keyword">true</span>;
00438             zip = <span class="stringliteral">"bzip2"</span>;
00439             }
00440       <span class="keywordflow">if</span> (info.exists() &amp;&amp; overwriteWarning) {
00441             QString s = tr(<span class="stringliteral">"File\n"</span>) + name + tr(<span class="stringliteral">"\nexists"</span>);
00442             <span class="keywordtype">int</span> rv = QMessageBox::warning(<span class="keyword">this</span>,
00443                tr(<span class="stringliteral">"MuseScore: write"</span>),
00444                s,
00445                tr(<span class="stringliteral">"Overwrite"</span>), tr(<span class="stringliteral">"Quit"</span>), QString::null, 0, 1);
00446             <span class="keywordflow">switch</span>(rv) {
00447                   <span class="keywordflow">case</span> 0:  <span class="comment">// overwrite</span>
00448                         <span class="keywordflow">break</span>;
00449                   <span class="keywordflow">case</span> 1:  <span class="comment">// quit</span>
00450                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00451                   }
00452             }
00453       FILE* fp = 0;
00454       <span class="keywordflow">if</span> (popenFlag) {
00455             zip += <span class="stringliteral">" &gt; "</span>;
00456             zip += name;
00457             fp  = popen(zip.ascii(), <span class="stringliteral">"w"</span>);
00458             }
00459       <span class="keywordflow">else</span> {
00460             fp = fopen(name.ascii(), <span class="stringliteral">"w"</span>);
00461             }
00462       <span class="keywordflow">if</span> (fp == 0) {
00463             QString s = tr(<span class="stringliteral">"Open File\n"</span>) + name + tr(<span class="stringliteral">"\nfailed: "</span>)
00464                + QString(strerror(errno));
00465             QMessageBox::critical(<span class="keyword">this</span>, tr(<span class="stringliteral">"MuseScore: Open File"</span>), s);
00466             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00467             }
00468       <span class="keywordtype">bool</span> rv = <a class="code" href="classMuseScore.html#k25">saveFile</a>(fp);
00469       <span class="keywordflow">if</span> (popenFlag)
00470             pclose(fp);
00471       <span class="keywordflow">else</span>
00472             fclose(fp);
00473       <span class="keywordflow">return</span> rv;
00474       }
00475 
00476 <span class="comment">//---------------------------------------------------------</span>
00477 <span class="comment">//   write Rest</span>
00478 <span class="comment">//---------------------------------------------------------</span>
00479 
<a name="l00480"></a><a class="code" href="classRest.html#a7">00480</a> <span class="keywordtype">void</span> <a class="code" href="classRest.html#a7">Rest::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00481 <span class="keyword">      </span>{
00482       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Rest"</span>);
00483       ChordRest::writeProperties(xml);
00484       <span class="keywordflow">if</span> (<a class="code" href="classRest.html#r1">_move</a>)
00485             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"move"</span>, <a class="code" href="classRest.html#r1">_move</a>);
00486       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Rest"</span>);
00487       }
00488 
00489 <span class="comment">//---------------------------------------------------------</span>
00490 <span class="comment">//   write Clef</span>
00491 <span class="comment">//---------------------------------------------------------</span>
00492 
<a name="l00493"></a><a class="code" href="classClef.html#a8">00493</a> <span class="keywordtype">void</span> <a class="code" href="classClef.html#a8">Clef::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00494 <span class="keyword">      </span>{
00495       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Clef"</span>);
00496       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"idx"</span>, <a class="code" href="classClef.html#a5">idx</a>());
00497       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"small"</span>, <a class="code" href="classClef.html#a6">small</a>());
00498       Element::writeProperties(xml);
00499       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Clef"</span>);
00500       }
00501 
00502 <span class="comment">//---------------------------------------------------------</span>
00503 <span class="comment">//   write TimeSig</span>
00504 <span class="comment">//---------------------------------------------------------</span>
00505 
<a name="l00506"></a><a class="code" href="classTimeSig.html#a6">00506</a> <span class="keywordtype">void</span> <a class="code" href="classTimeSig.html#a6">TimeSig::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00507 <span class="keyword">      </span>{
00508       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"TimeSig"</span>);
00509       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"idx"</span>, <a class="code" href="classTimeSig.html#a5">idx</a>());
00510       Element::writeProperties(xml);
00511       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"TimeSig"</span>);
00512       }
00513 
00514 <span class="comment">//---------------------------------------------------------</span>
00515 <span class="comment">//   write KeySig</span>
00516 <span class="comment">//---------------------------------------------------------</span>
00517 
<a name="l00518"></a><a class="code" href="classKeySig.html#a6">00518</a> <span class="keywordtype">void</span> <a class="code" href="classKeySig.html#a6">KeySig::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00519 <span class="keyword">      </span>{
00520       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"KeySig"</span>);
00521       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"offset"</span>, <a class="code" href="classKeySig.html#r1">off</a>);
00522       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"idx"</span>, <a class="code" href="classKeySig.html#a5">idx</a>());
00523       Element::writeProperties(xml);
00524       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"KeySig"</span>);
00525       }
00526 
00527 <span class="comment">//---------------------------------------------------------</span>
00528 <span class="comment">//   SStaff::write</span>
00529 <span class="comment">//---------------------------------------------------------</span>
00530 
<a name="l00531"></a><a class="code" href="classSStaff.html#a4">00531</a> <span class="keywordtype">void</span> <a class="code" href="classSStaff.html#a4">SStaff::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00532 <span class="keyword">      </span>{
00533       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Staff"</span>);
00534       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"lines"</span>, <a class="code" href="classSStaff.html#r1">lines</a>);
00535       Element::writeProperties(xml);
00536       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Staff"</span>);
00537       }
00538 
00539 <span class="comment">//---------------------------------------------------------</span>
00540 <span class="comment">//   SStaff::read</span>
00541 <span class="comment">//---------------------------------------------------------</span>
00542 
<a name="l00543"></a><a class="code" href="classSStaff.html#a5">00543</a> <span class="keywordtype">void</span> <a class="code" href="classSStaff.html#a5">SStaff::read</a>(QDomNode node)
00544       {
00545       QDomElement e = node.toElement();
00546       setTick(e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt());
00547 
00548       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00549             QDomElement e = node.toElement();
00550             <span class="keywordflow">if</span> (e.isNull())
00551                   <span class="keywordflow">continue</span>;
00552             QString tag(e.tagName());
00553             QString val(e.text());
00554             <span class="keywordtype">int</span> i = val.toInt();
00555             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"lines"</span>)
00556                   <a class="code" href="classSStaff.html#r1">lines</a> = i;
00557             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00558                   ;
00559             <span class="keywordflow">else</span>
00560                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00561             }
00562       }
00563 
00564 <span class="comment">//---------------------------------------------------------</span>
00565 <span class="comment">//   Symbol::write</span>
00566 <span class="comment">//---------------------------------------------------------</span>
00567 
<a name="l00568"></a><a class="code" href="classSymbol.html#a10">00568</a> <span class="keywordtype">void</span> <a class="code" href="classSymbol.html#a10">Symbol::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00569 <span class="keyword">      </span>{
00570       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Symbol"</span>);
00571       xml.<a class="code" href="classXml.html#a13">qcharTag</a>(<span class="stringliteral">"code"</span>, <a class="code" href="classSymbol.html#p0">_sym</a>.<a class="code" href="structSym.html#a10">code</a>());
00572       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"style"</span>, <a class="code" href="classSymbol.html#p0">_sym</a>.<a class="code" href="structSym.html#o1">textStyle</a>);
00573       xml.<a class="code" href="classXml.html#a14">doubleTag</a>(<span class="stringliteral">"x"</span>, <a class="code" href="classElement.html#a20">pos</a>().<a class="code" href="classElement.html#a21">x</a>());
00574       xml.<a class="code" href="classXml.html#a14">doubleTag</a>(<span class="stringliteral">"y"</span>, <a class="code" href="classElement.html#a20">pos</a>().<a class="code" href="classElement.html#a22">y</a>());
00575       Element::writeProperties(xml);
00576       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Symbol"</span>);
00577       }
00578 
00579 <span class="comment">//---------------------------------------------------------</span>
00580 <span class="comment">//   Symbol::read</span>
00581 <span class="comment">//---------------------------------------------------------</span>
00582 
<a name="l00583"></a><a class="code" href="classSymbol.html#a11">00583</a> <span class="keywordtype">void</span> <a class="code" href="classSymbol.html#a11">Symbol::read</a>(QDomNode node)
00584       {
00585       QDomElement e = node.toElement();
00586       setTick(e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt());
00587 
00588       QPointF pos;
00589       <a class="code" href="structSym.html">Sym</a> s;
00590 
00591       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00592             QDomElement e = node.toElement();
00593             <span class="keywordflow">if</span> (e.isNull())
00594                   <span class="keywordflow">continue</span>;
00595             QString tag(e.tagName());
00596             QString val(e.text());
00597             <span class="keywordtype">int</span> i = val.toInt();
00598             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"code"</span>)
00599                   s.<a class="code" href="structSym.html#o0">_code</a> = i;
00600             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00601                   ;
00602             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"style"</span>)
00603                   s.<a class="code" href="structSym.html#o1">textStyle</a> = i;
00604             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"x"</span>)
00605                   pos.setX(val.toDouble());
00606             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"y"</span>)
00607                   pos.setY(val.toDouble());
00608             <span class="keywordflow">else</span>
00609                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00610             }
00611       setpos(pos);
00612       <a class="code" href="classSymbol.html#a4">setSym</a>(s);
00613       }
00614 
00615 <span class="comment">//---------------------------------------------------------</span>
00616 <span class="comment">//   Rest::read</span>
00617 <span class="comment">//---------------------------------------------------------</span>
00618 
<a name="l00619"></a><a class="code" href="classRest.html#a8">00619</a> <span class="keywordtype">void</span> <a class="code" href="classRest.html#a8">Rest::read</a>(QDomNode node)
00620       {
00621       QDomElement e = node.toElement();
00622 
00623       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00624             QDomElement e = node.toElement();
00625             <span class="keywordflow">if</span> (e.isNull())
00626                   <span class="keywordflow">continue</span>;
00627             QString tag(e.tagName());
00628             QString val(e.text());
00629             <span class="keywordtype">int</span> i = val.toInt();
00630             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"len"</span>)
00631                   <a class="code" href="classRest.html#a4">setTickLen</a>(i);
00632             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"move"</span>)
00633                   <a class="code" href="classRest.html#r1">_move</a> = i;
00634             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ChordRest::readProperties(node))
00635                   ;
00636             <span class="keywordflow">else</span>
00637                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00638             }
00639       }
00640 
00641 <span class="comment">//---------------------------------------------------------</span>
00642 <span class="comment">//   Clef::read</span>
00643 <span class="comment">//---------------------------------------------------------</span>
00644 
<a name="l00645"></a><a class="code" href="classClef.html#a9">00645</a> <span class="keywordtype">void</span> <a class="code" href="classClef.html#a9">Clef::read</a>(QDomNode node)
00646       {
00647       QDomElement e = node.toElement();
00648       setTick(e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt());
00649 
00650       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00651             QDomElement e = node.toElement();
00652             <span class="keywordflow">if</span> (e.isNull())
00653                   <span class="keywordflow">continue</span>;
00654             QString tag(e.tagName());
00655             QString <a class="code" href="classClef.html#r0">val</a>(e.text());
00656             <span class="keywordtype">int</span> i = val.toInt();
00657             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"small"</span>)
00658                   <a class="code" href="classClef.html#a7">setSmall</a>(i);
00659             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"idx"</span>)
00660                   <a class="code" href="classClef.html#a4">setIdx</a>(i);
00661             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00662                   ;
00663             <span class="keywordflow">else</span>
00664                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00665             }
00666       }
00667 
00668 <span class="comment">//---------------------------------------------------------</span>
00669 <span class="comment">//   TimeSig::read</span>
00670 <span class="comment">//---------------------------------------------------------</span>
00671 
<a name="l00672"></a><a class="code" href="classTimeSig.html#a7">00672</a> <span class="keywordtype">void</span> <a class="code" href="classTimeSig.html#a7">TimeSig::read</a>(QDomNode node)
00673       {
00674       QDomElement e = node.toElement();
00675       setTick(e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt());
00676 
00677       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00678             QDomElement e = node.toElement();
00679             <span class="keywordflow">if</span> (e.isNull())
00680                   <span class="keywordflow">continue</span>;
00681             QString tag(e.tagName());
00682             QString <a class="code" href="classTimeSig.html#r0">val</a>(e.text());
00683             <span class="keywordtype">int</span> i = val.toInt();
00684             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"idx"</span>)
00685                   <a class="code" href="classTimeSig.html#a4">setIdx</a>(i);
00686             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00687                   ;
00688             <span class="keywordflow">else</span>
00689                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00690             }
00691       }
00692 
00693 <span class="comment">//---------------------------------------------------------</span>
00694 <span class="comment">//   KeySig::read</span>
00695 <span class="comment">//---------------------------------------------------------</span>
00696 
<a name="l00697"></a><a class="code" href="classKeySig.html#a7">00697</a> <span class="keywordtype">void</span> <a class="code" href="classKeySig.html#a7">KeySig::read</a>(QDomNode node)
00698       {
00699       QDomElement e = node.toElement();
00700       setTick(e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt());
00701 
00702       <span class="keywordtype">int</span> yoffset = 0;
00703 
00704       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00705             QDomElement e = node.toElement();
00706             <span class="keywordflow">if</span> (e.isNull())
00707                   <span class="keywordflow">continue</span>;
00708             QString tag(e.tagName());
00709             QString <a class="code" href="classKeySig.html#r0">val</a>(e.text());
00710             <span class="keywordtype">int</span> i = val.toInt();
00711             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"offset"</span>)
00712                   yoffset = i;
00713             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"idx"</span>)
00714                   <a class="code" href="classKeySig.html#a4">setIdx</a>(i, yoffset);
00715             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00716                   ;
00717             <span class="keywordflow">else</span>
00718                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00719             }
00720       }
00721 
00722 <span class="comment">//---------------------------------------------------------</span>
00723 <span class="comment">//   readGeometry</span>
00724 <span class="comment">//---------------------------------------------------------</span>
00725 
<a name="l00726"></a><a class="code" href="classScore.html#a26">00726</a> <span class="keywordtype">void</span> <a class="code" href="xml_8h.html#a0">Score::readGeometry</a>(QDomNode node)
00727       {
00728       QDomElement e = node.toElement();
00729       <a class="code" href="project_8h.html#a0">scorePos</a>.setX(e.attribute(<span class="stringliteral">"x"</span>, <span class="stringliteral">"0"</span>).toInt());
00730       <a class="code" href="project_8h.html#a0">scorePos</a>.setY(e.attribute(<span class="stringliteral">"y"</span>, <span class="stringliteral">"0"</span>).toInt());
00731       <a class="code" href="project_8h.html#a1">scoreSize</a>.setWidth(e.attribute(<span class="stringliteral">"w"</span>, <span class="stringliteral">"0"</span>).toInt());
00732       <a class="code" href="project_8h.html#a1">scoreSize</a>.setHeight(e.attribute(<span class="stringliteral">"h"</span>, <span class="stringliteral">"0"</span>).toInt());
00733       }
00734 
00735 <span class="comment">//---------------------------------------------------------</span>
00736 <span class="comment">//   loadStyle</span>
00737 <span class="comment">//---------------------------------------------------------</span>
00738 
<a name="l00739"></a><a class="code" href="classLoadStyle.html">00739</a> <span class="keyword">class </span><a class="code" href="classLoadStyle.html">LoadStyle</a> : <span class="keyword">public</span> <a class="code" href="classLoadFile.html">LoadFile</a> {
00740    <span class="keyword">public</span>:
00741       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classLoadStyle.html#a0">loader</a>(FILE* f);
00742       };
00743 
<a name="l00744"></a><a class="code" href="classMuseScore.html#k30">00744</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k30">MuseScore::loadStyle</a>()
00745       {
00746       <a class="code" href="classLoadStyle.html">LoadStyle</a> ls;
00747       ls.<a class="code" href="classLoadFile.html#a3">load</a>(<span class="keyword">this</span>, QString(<span class="stringliteral">"."</span>), QString(<span class="stringliteral">"*.mss"</span>), tr(<span class="stringliteral">"MuseScore: load Style"</span>));
00748       }
00749 
00750 <span class="comment">//---------------------------------------------------------</span>
00751 <span class="comment">//   loader</span>
00752 <span class="comment">//    return true on error</span>
00753 <span class="comment">//---------------------------------------------------------</span>
00754 
<a name="l00755"></a><a class="code" href="classLoadStyle.html#a0">00755</a> <span class="keywordtype">bool</span> <a class="code" href="classLoadStyle.html#a0">LoadStyle::loader</a>(FILE* f)
00756       {
00757       QFile qf(<a class="code" href="classLoadFile.html#a5">name</a>());
00758       qf.open(QIODevice::ReadOnly, f);
00759 
00760       QDomDocument doc;
00761       <span class="keywordtype">int</span> line, column;
00762       QString err;
00763       <span class="keywordflow">if</span> (!doc.setContent(&amp;qf, <span class="keyword">false</span>, &amp;err, &amp;line, &amp;column)) {
00764             error.sprintf(<span class="stringliteral">"error reading file %s at line %d column %d: %s\n"</span>,
00765                <a class="code" href="classLoadFile.html#a5">name</a>().latin1(), line, column, err.latin1());
00766             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00767             }
00768 
00769       <span class="keywordflow">for</span> (QDomNode node = doc.documentElement(); !node.isNull(); node = node.nextSibling()) {
00770             QDomElement e = node.toElement();
00771             <span class="keywordflow">if</span> (e.isNull())
00772                   <span class="keywordflow">continue</span>;
00773             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"museScore"</span>) {
00774                   <span class="comment">// QString version = e.attribute(QString("version"));</span>
00775                   QDomNode n = node.firstChild();
00776                   <span class="keywordflow">while</span> (!n.isNull()) {
00777                         e = n.toElement();
00778                         <span class="keywordflow">if</span> (e.isNull())
00779                               <span class="keywordflow">continue</span>;
00780                         QString tag(e.tagName());
00781                         QString val(e.text());
00782                         <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Style"</span>)
00783                               <a class="code" href="style_8h.html#a40">loadStyle</a>(n);
00784                         <span class="keywordflow">else</span>
00785                               <a class="code" href="utils_8h.html#a4">domError</a>(node);
00786                         n = n.nextSibling();
00787                         }
00788                   }
00789             }
00790       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00791       }
00792 
00793 <span class="comment">//---------------------------------------------------------</span>
00794 <span class="comment">//   saveStyle</span>
00795 <span class="comment">//---------------------------------------------------------</span>
00796 
<a name="l00797"></a><a class="code" href="classSaveStyle.html">00797</a> <span class="keyword">class </span><a class="code" href="classSaveStyle.html">SaveStyle</a> : <span class="keyword">public</span> <a class="code" href="classSaveFile.html">SaveFile</a> {
00798    <span class="keyword">public</span>:
00799       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classSaveStyle.html#a0">saver</a>();
00800       };
00801 
<a name="l00802"></a><a class="code" href="classMuseScore.html#k29">00802</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k29">MuseScore::saveStyle</a>()
00803       {
00804       <a class="code" href="classSaveStyle.html">SaveStyle</a> ls;
00805       ls.<a class="code" href="classSaveFile.html#a3">save</a>(<span class="keyword">this</span>, QString(<span class="stringliteral">"."</span>), QString(<span class="stringliteral">".mss"</span>), tr(<span class="stringliteral">"MuseScore: Save Style"</span>));
00806       }
00807 
<a name="l00808"></a><a class="code" href="classSaveStyle.html#a0">00808</a> <span class="keywordtype">bool</span> <a class="code" href="classSaveStyle.html#a0">SaveStyle::saver</a>()
00809       {
00810       <a class="code" href="classXml.html">Xml</a> xml(f);
00811       xml.<a class="code" href="classXml.html#a4">header</a>();
00812       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"museScore version=\"1.0\""</span>);
00813 
00814       ::saveStyle(xml);
00815 
00816       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"museScore"</span>);
00817       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00818       }
00819 
00820 <span class="comment">//---------------------------------------------------------</span>
00821 <span class="comment">//   saveFile</span>
00822 <span class="comment">//    return true on success</span>
00823 <span class="comment">//---------------------------------------------------------</span>
00824 
<a name="l00825"></a><a class="code" href="classMuseScore.html#a5">00825</a> <span class="keywordtype">bool</span> <a class="code" href="classMuseScore.html#k25">MuseScore::saveFile</a>(FILE* f)
00826       {
00827       <a class="code" href="classXml.html">Xml</a> xml(f);
00828       xml.<a class="code" href="classXml.html#a4">header</a>();
00829       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"museScore version=\"1.0\""</span>);
00830 
00831       xml.<a class="code" href="classXml.html#a18">geometryTag</a>(<span class="stringliteral">"Geometry"</span>, <a class="code" href="project_8cpp.html#a2">mscore</a>);
00832       xml.<a class="code" href="classXml.html#a14">doubleTag</a>(<span class="stringliteral">"Spatium"</span>, <a class="code" href="spatium_8h.html#a0">_spatium</a> / DPMM);
00833       xml.<a class="code" href="classXml.html#a14">doubleTag</a>(<span class="stringliteral">"Mag"</span>, <a class="code" href="classMuseScore.html#r1">canvas</a>-&gt;<a class="code" href="classCanvas.html#a19">mag</a>());
00834       xml.<a class="code" href="classXml.html#a14">doubleTag</a>(<span class="stringliteral">"xoff"</span>, <a class="code" href="classMuseScore.html#r1">canvas</a>-&gt;<a class="code" href="classCanvas.html#a20">xoffset</a>());
00835       xml.<a class="code" href="classXml.html#a14">doubleTag</a>(<span class="stringliteral">"yoff"</span>, <a class="code" href="classMuseScore.html#r1">canvas</a>-&gt;<a class="code" href="classCanvas.html#a21">yoffset</a>());
00836       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"showInvisible"</span>, <a class="code" href="element_8cpp.html#a1">showInvisible</a>);
00837       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r29">playPanel</a> != 0 &amp;&amp; <a class="code" href="classMuseScore.html#r29">playPanel</a>-&gt;isVisible()) {
00838             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"showPlayPanel"</span>, 1);
00839             xml.<a class="code" href="classXml.html#a18">geometryTag</a>(<span class="stringliteral">"PlayPanelGeometry"</span>, (QWidget*)<a class="code" href="classMuseScore.html#r29">playPanel</a>);
00840             }
00841       ::saveStyle(xml);       <span class="comment">// should style really saved with score?</span>
00842 
00843       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a3">write</a>(xml);
00844 
00845       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"cursorStaff"</span>, <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a>);
00846       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"cursorVoice"</span>, <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o2">voice</a>);
00847 
00848       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"museScore"</span>);
00849       <span class="keywordflow">if</span> (ferror(f)) {
00850             QString s = QString(<span class="stringliteral">"Write File failed: "</span>) + QString(strerror(errno));
00851             QMessageBox::critical(<span class="keyword">this</span>, tr(<span class="stringliteral">"MuseScore: Write File"</span>), s);
00852             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00853             }
00854       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00855       }
00856 
00857 <span class="comment">//---------------------------------------------------------</span>
00858 <span class="comment">//   loadFile</span>
00859 <span class="comment">//    return true on error</span>
00860 <span class="comment">//---------------------------------------------------------</span>
00861 
<a name="l00862"></a><a class="code" href="classScore.html#a123">00862</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a123">Score::loadFile</a>(FILE* f, <span class="keyword">const</span> QString&amp; name)
00863       {
00864       QFile qf(name);
00865       qf.open(QIODevice::ReadOnly, f);
00866 
00867       QDomDocument doc;
00868       <span class="keywordtype">int</span> line, column;
00869       QString err;
00870       <span class="keywordflow">if</span> (!doc.setContent(&amp;qf, <span class="keyword">false</span>, &amp;err, &amp;line, &amp;column)) {
00871             QString s;
00872             s.sprintf(<span class="stringliteral">"error reading file %s at line %d column %d: %s\n"</span>,
00873                name.latin1(), line, column, err.latin1());
00874 
00875             QMessageBox::critical(<a class="code" href="project_8cpp.html#a2">mscore</a>, tr(<span class="stringliteral">"MuseScore: Read File"</span>), s);
00876             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00877             }
00878 
00879       <span class="keywordflow">for</span> (QDomNode node = doc.documentElement(); !node.isNull(); node = node.nextSibling()) {
00880             QDomElement e = node.toElement();
00881             <span class="keywordflow">if</span> (e.isNull())
00882                   <span class="keywordflow">continue</span>;
00883             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"museScore"</span>) {
00884                   <span class="keywordflow">for</span> (QDomNode n = node.firstChild(); !n.isNull(); n = n.nextSibling()) {
00885                         e = n.toElement();
00886                         <span class="keywordflow">if</span> (e.isNull())
00887                               <span class="keywordflow">continue</span>;
00888                         QString tag(e.tagName());
00889                         QString val(e.text());
00890                         <span class="keywordtype">int</span> i = val.toInt();
00891                         <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Staff"</span>)
00892                               <a class="code" href="classScore.html#a4">readStaff</a>(n);
00893                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"siglist"</span>)
00894                               <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a4">read</a>(n);
00895                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"keylist"</span>)
00896                               <a class="code" href="classScore.html#o10">keymap</a>-&gt;<a class="code" href="classKeyList.html#a2">read</a>(n);
00897                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"tempolist"</span>)
00898                               <a class="code" href="classScore.html#o11">tempomap</a>-&gt;<a class="code" href="classTempoList.html#a2">read</a>(n);
00899                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"cursorStaff"</span>)
00900                               <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a> = i;
00901                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"cursorVoice"</span>)
00902                               <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o2">voice</a> = i;
00903                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Geometry"</span>)
00904                               <a class="code" href="xml_8h.html#a0">readGeometry</a>(n);
00905                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Mag"</span>)
00906                               <a class="code" href="classScore.html#a116">setMag</a>(val.toDouble());
00907                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"xoff"</span>)
00908                               <a class="code" href="classScore.html#a119">setXoffset</a>(val.toDouble());
00909                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"yoff"</span>)
00910                               <a class="code" href="classScore.html#a120">setYoffset</a>(val.toDouble());
00911                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Spatium"</span>)
00912                               <a class="code" href="classScore.html#a113">setSpatium</a> (val.toDouble() * DPMM);
00913                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"showInvisible"</span>)
00914                               <a class="code" href="classScore.html#r8">_showInvisible</a> = i;
00915                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"showPlayPanel"</span>) {
00916                               ; <span class="comment">// TODO showPlayPanel(i);</span>
00917                               }
00918 <span class="preprocessor">#if 0 //TODO</span>
00919 <span class="preprocessor"></span>                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"PlayPanelGeometry"</span> &amp;&amp; playPanel != 0) {
00920                               QPoint pos;
00921                               QSize size;
00922                               pos.setX(e.attribute(<span class="stringliteral">"x"</span>, <span class="stringliteral">"0"</span>).toInt());
00923                               pos.setY(e.attribute(<span class="stringliteral">"y"</span>, <span class="stringliteral">"0"</span>).toInt());
00924                               size.setWidth(e.attribute(<span class="stringliteral">"w"</span>, <span class="stringliteral">"200"</span>).toInt());
00925                               size.setHeight(e.attribute(<span class="stringliteral">"h"</span>, <span class="stringliteral">"100"</span>).toInt());
00926                               QWidget* w = (QWidget*)playPanel;
00927                               w-&gt;resize(size);
00928                               w-&gt;move(pos);
00929                               }
00930 <span class="preprocessor">#endif</span>
00931 <span class="preprocessor"></span>                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Style"</span>)
00932                               ::loadStyle(n);
00933                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"page-layout"</span>)
00934                               <a class="code" href="classScore.html#a135">pageFormat</a>()-&gt;<a class="code" href="structPageFormat.html#a4">read</a>(n);
00935                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"instrument-group"</span>)
00936                               <a class="code" href="file_8cpp.html#a1">readInstrumentGroup</a>(n);
00937                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"rights"</span>)
00938                               <a class="code" href="classScore.html#o7">rights</a> = val;
00939                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"movement-number"</span>)
00940                               <a class="code" href="classScore.html#o5">movementNumber</a> = val;
00941                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"movement-title"</span>)
00942                               <a class="code" href="classScore.html#o6">movementTitle</a> = val;
00943                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Part"</span>) {
00944                               <a class="code" href="classPart.html">Part</a>* <a class="code" href="classScore.html#a17">part</a> = <span class="keyword">new</span> <a class="code" href="classPart.html">Part</a>(<span class="keyword">this</span>);
00945                               part-&gt;<a class="code" href="classPart.html#a2">read</a>(<span class="keyword">this</span>, n);
00946                               <a class="code" href="classScore.html#a109">parts</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(part);
00947                               }
00948                         <span class="keywordflow">else</span>
00949                               <a class="code" href="utils_8h.html#a4">domError</a>(e);
00950                         }
00951                   }
00952             }
00953       <span class="comment">// fixTicks();       //DEBUG</span>
00954 
00955       <a class="code" href="classScore.html#a99">connectTies</a>();
00956       <a class="code" href="classScore.html#a48">searchSelectedElements</a>();
00957       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00958       }
00959 
00960 <span class="comment">//---------------------------------------------------------</span>
00961 <span class="comment">//   loadMsc</span>
00962 <span class="comment">//    return true if file not found or error loading</span>
00963 <span class="comment">//---------------------------------------------------------</span>
00964 
<a name="l00965"></a><a class="code" href="classScore.html#a122">00965</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a122">Score::loadMsc</a>(QString name)
00966       {
00967       QString zip;
00968       QString ext(<span class="stringliteral">".msc"</span>);
00969       <span class="keywordtype">bool</span> popenFlag = <span class="keyword">false</span>;
00970 
00971       QFileInfo <a class="code" href="classScore.html#r0">info</a>(name);
00972       <span class="keywordflow">if</span> (info.extension(<span class="keyword">true</span>) == <span class="stringliteral">""</span>) {
00973             name += ext;
00974             info.setFile(name);
00975             }
00976       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == <span class="stringliteral">"gz"</span>) {
00977             popenFlag = <span class="keyword">true</span>;
00978             zip = <span class="stringliteral">"gunzip"</span>;
00979             }
00980       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.extension(<span class="keyword">false</span>) == <span class="stringliteral">"bz2"</span>) {
00981             popenFlag = <span class="keyword">true</span>;
00982             zip = <span class="stringliteral">"bunzip2"</span>;
00983             }
00984       FILE* fp = 0;
00985       <span class="keywordflow">if</span> (popenFlag) {
00986             zip += <span class="stringliteral">" &lt; "</span>;
00987             zip += name;
00988             fp  = popen(zip.ascii(), <span class="stringliteral">"r"</span>);
00989             }
00990       <span class="keywordflow">else</span> {
00991             fp = fopen(name.ascii(), <span class="stringliteral">"r"</span>);
00992             }
00993       <span class="keywordflow">if</span> (fp == 0)
00994             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00995       <span class="keywordtype">bool</span> rv = <a class="code" href="classScore.html#a123">loadFile</a>(fp, name);
00996       <span class="keywordflow">if</span> (popenFlag)
00997             pclose(fp);
00998       <span class="keywordflow">else</span>
00999             fclose(fp);
01000       <span class="keywordflow">return</span> rv;
01001       }
01002 
01003 <span class="comment">//---------------------------------------------------------</span>
01004 <span class="comment">//   loadInstrumentTemplates</span>
01005 <span class="comment">//---------------------------------------------------------</span>
01006 
<a name="l01007"></a><a class="code" href="classMuseScore.html#d9">01007</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#d9">MuseScore::loadInstrumentTemplates</a>()
01008       {
01009       QString l = QString(QTextCodec::locale());
01010       QString instrTemplates = <a class="code" href="mscore_8cpp.html#a0">mscoreGlobalShare</a> + <span class="stringliteral">"/templates/instruments_"</span> + l + <span class="stringliteral">".xml"</span>;
01011       QFileInfo info(instrTemplates);
01012       <span class="keywordflow">if</span> (!info.isReadable()) {
01013             instrTemplates = <a class="code" href="mscore_8cpp.html#a0">mscoreGlobalShare</a> + <span class="stringliteral">"/templates/instruments.xml"</span>;
01014             info.setFile(instrTemplates);
01015             }
01016       <span class="keywordflow">if</span> (!info.isReadable()) {
01017             fprintf(stderr, <span class="stringliteral">"cannot find instrument templates &lt;%s&gt;\n"</span>, instrTemplates.latin1());
01018             <span class="keywordflow">return</span>;
01019             }
01020       QString zip;
01021 
01022       QFile qf(instrTemplates);
01023       <span class="keywordflow">if</span> (!qf.open(QIODevice::ReadOnly))
01024             <span class="keywordflow">return</span>;
01025 
01026       QDomDocument doc;
01027       <span class="keywordtype">int</span> line, column;
01028       QString err;
01029       <span class="keywordtype">bool</span> rv = doc.setContent(&amp;qf, <span class="keyword">false</span>, &amp;err, &amp;line, &amp;column);
01030       qf.close();
01031 
01032       <span class="keywordflow">if</span> (!rv) {
01033             QString s;
01034             s.sprintf(<span class="stringliteral">"error reading file %s at line %d column %d: %s\n"</span>,
01035                instrTemplates.latin1(), line, column, err.latin1());
01036 
01037             QMessageBox::critical(<a class="code" href="project_8cpp.html#a2">mscore</a>, tr(<span class="stringliteral">"MuseScore: Read File"</span>), s);
01038             <span class="keywordflow">return</span>;
01039             }
01040 
01041       <span class="keywordflow">for</span> (QDomNode node = doc.documentElement(); !node.isNull(); node = node.nextSibling()) {
01042             QDomElement e = node.toElement();
01043             <span class="keywordflow">if</span> (e.isNull())
01044                   <span class="keywordflow">continue</span>;
01045             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"museScore"</span>) {
01046                   <span class="keywordflow">for</span> (QDomNode n = node.firstChild(); !n.isNull(); n = n.nextSibling()) {
01047                         e = n.toElement();
01048                         <span class="keywordflow">if</span> (e.isNull())
01049                               <span class="keywordflow">continue</span>;
01050                         QString tag(e.tagName());
01051                         QString val(e.text());
01052                         <span class="keywordflow">if</span> (tag == <span class="stringliteral">"instrument-group"</span>)
01053                               <a class="code" href="file_8cpp.html#a1">readInstrumentGroup</a>(n);
01054                         <span class="keywordflow">else</span>
01055                               <a class="code" href="utils_8h.html#a4">domError</a>(e);
01056                         }
01057                   }
01058             }
01059       }
01060 
01061 <span class="comment">//---------------------------------------------------------</span>
01062 <span class="comment">//   write</span>
01063 <span class="comment">//---------------------------------------------------------</span>
01064 
<a name="l01065"></a><a class="code" href="classElementList.html#a3">01065</a> <span class="keywordtype">void</span> <a class="code" href="classElementList.html#a3">ElementList::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
01066 <span class="keyword">      </span>{
01067       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> ie = <a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ie != <a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ie)
01068             (*ie)-&gt;write(xml);
01069       }
01070 
01071 <span class="comment">//---------------------------------------------------------</span>
01072 <span class="comment">//   printFile</span>
01073 <span class="comment">//---------------------------------------------------------</span>
01074 
<a name="l01075"></a><a class="code" href="classScore.html#i0">01075</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#i0">Score::printFile</a>()
01076       {
01077 <span class="comment">//      printer.setMargins(0, 0, 0, 0);</span>
01078 <span class="comment">//         lrint(cs-&gt;pageFormat()-&gt;topMargin),</span>
01079 <span class="comment">//         lrint(cs-&gt;pageFormat()-&gt;leftMargin),</span>
01080 <span class="comment">//         lrint(cs-&gt;pageFormat()-&gt;bottomMargin),</span>
01081 <span class="comment">//         lrint(cs-&gt;pageFormat()-&gt;rightMargin)</span>
01082 <span class="comment">//         );</span>
01083 <span class="comment">//      printf("print format %d\n", paperSizes[pageFormat()-&gt;size].qtsize);</span>
01084 
01085       <a class="code" href="classScore.html#r14">printer</a>.setPageSize(<a class="code" href="page_8h.html#a4">paperSizes</a>[<a class="code" href="classScore.html#a135">pageFormat</a>()-&gt;size].qtsize);
01086       <a class="code" href="classScore.html#r14">printer</a>.setOrientation(<a class="code" href="classScore.html#a135">pageFormat</a>()-&gt;landscape ? QPrinter::Landscape : QPrinter::Portrait);
01087 
01088       <span class="keywordtype">char</span> tempName[512];
01089       <span class="keywordflow">if</span> (<a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o0">printCmd</a>.isEmpty()) {
01090             <span class="comment">//</span>
01091             <span class="comment">//  use default qt printer setup</span>
01092             <span class="comment">//</span>
01093             <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r14">printer</a>.setup())
01094                   <span class="keywordflow">return</span>;
01095             }
01096       <span class="keywordflow">else</span> {
01097             sprintf(tempName, <span class="stringliteral">"%s/mscorePrint%d.ps"</span>, P_tmpdir, getpid());
01098             QString s(tempName);
01099             <a class="code" href="classScore.html#r14">printer</a>.setOutputFileName(s);
01100             }
01101 
01102       <a class="code" href="classScore.html#r14">printer</a>.setCreator(tr(<span class="stringliteral">"MuseScore Version: "</span> <a class="code" href="config_8h.html#a20">VERSION</a>));
01103       <a class="code" href="classScore.html#r14">printer</a>.setFullPage(<span class="keyword">true</span>);
01104 
01105       <a class="code" href="classPainter.html">Painter</a> p(&amp;<a class="code" href="classScore.html#r14">printer</a>);
01106       p.setClipRect(QRectF(0, 0, 100000, 100000));
01107       p.scale(<a class="code" href="classScore.html#r14">printer</a>.resolution()/DPI, <a class="code" href="classScore.html#r14">printer</a>.resolution()/DPI);
01108 
01109 printf(<span class="stringliteral">"MAG %f\n"</span>, <span class="keywordtype">double</span>(<a class="code" href="classScore.html#r14">printer</a>.resolution()) / double(<a class="code" href="globals_8h.html#a6">appDpiY</a>));
01110       p.<a class="code" href="classPainter.html#a1">setPrint</a>(<span class="keyword">true</span>);
01111 
01112       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a1">ciPage</a> ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();;) {
01113             <a class="code" href="classPage.html">Page</a>* page = *ip;
01114             page-&gt;<a class="code" href="classPage.html#a20">draw</a>(p);
01115             ++ip;
01116             <span class="keywordflow">if</span> (ip == <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>())
01117                   <span class="keywordflow">break</span>;
01118             <a class="code" href="classScore.html#r14">printer</a>.newPage();
01119             }
01120       p.end();
01121       <span class="keywordflow">if</span> (tempName) {
01122             <span class="keywordtype">int</span> len = <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o0">printCmd</a>.length() + strlen(tempName) + 16;
01123             <span class="keywordtype">char</span> buffer[len];
01124             sprintf(buffer, <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o0">printCmd</a>.latin1(), tempName);
01125             system(buffer);
01126             }
01127       }
01128 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
