<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: beam.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>beam.cpp</h1><a href="beam_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: beam.cpp,v 1.26 2005/06/20 13:54:53 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2005 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="beam_8h.html">beam.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="preferences_8h.html">preferences.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="globals_8h.html">globals.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00019 
00020 <span class="comment">//---------------------------------------------------------</span>
00021 <span class="comment">//   Beam</span>
00022 <span class="comment">//---------------------------------------------------------</span>
00023 
<a name="l00024"></a><a class="code" href="classBeam.html#a1">00024</a> <a class="code" href="classBeam.html#a1">Beam::~Beam</a>()
00025       {
00026       <span class="comment">//</span>
00027       <span class="comment">// delete all references from chords</span>
00028       <span class="comment">//</span>
00029       <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00030             <a class="code" href="classChordRest.html">ChordRest</a>* cr = i-&gt;second;
00031             cr-&gt;<a class="code" href="classChordRest.html#a7">setBeam</a>(0);
00032             }
00033       <span class="keywordflow">for</span> (<a class="code" href="beam_8h.html#a1">iBeamSegment</a> i = <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00034          i != <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00035             <span class="keyword">delete</span> *i;
00036             }
00037       }
00038 
00039 <span class="comment">//---------------------------------------------------------</span>
00040 <span class="comment">//   remove</span>
00041 <span class="comment">//---------------------------------------------------------</span>
00042 
<a name="l00043"></a><a class="code" href="classBeam.html#a6">00043</a> <span class="keywordtype">void</span> <a class="code" href="classBeam.html#a6">Beam::remove</a>(<a class="code" href="classChordRest.html">ChordRest</a>* a)
00044       {
00045       <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00046             <span class="keywordflow">if</span> (i-&gt;second == a) {
00047                   <a class="code" href="classBeam.html#r0">elements</a>.erase(i);
00048                   <span class="keywordflow">return</span>;
00049                   }
00050             }
00051       }
00052 
00053 <span class="comment">//---------------------------------------------------------</span>
00054 <span class="comment">//   draw</span>
00055 <span class="comment">//---------------------------------------------------------</span>
00056 
<a name="l00057"></a><a class="code" href="classBeam.html#a9">00057</a> <span class="keywordtype">void</span> <a class="code" href="classBeam.html#a9">Beam::draw1</a>(<a class="code" href="classPainter.html">Painter</a>&amp; p)<span class="keyword"> const</span>
00058 <span class="keyword">      </span>{
00059       p.setPen(QPen(Qt::NoPen));
00060       p.setBrush(<a class="code" href="classElement.html#a14">isSelected</a>() ? <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o9">selectColor</a>[0] : Qt::black);
00061 
00062       <span class="keywordflow">for</span> (<a class="code" href="beam_8h.html#a2">ciBeamSegment</a> ibs = <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00063          ibs != <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ibs) {
00064             <a class="code" href="structBeamSegment.html">BeamSegment</a>* bs = *ibs;
00065 
00066             QPointF ip1 = bs-&gt;<a class="code" href="structBeamSegment.html#o0">p1</a>;
00067             QPointF ip2 = bs-&gt;<a class="code" href="structBeamSegment.html#o1">p2</a>;
00068             qreal lw2   = point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o30">beamWidth</a>) * .5;
00069 
00070             QPolygonF a(4);
00071             a[0] = QPointF(ip1.x(), ip1.y()-lw2);
00072             a[1] = QPointF(ip2.x(), ip2.y()-lw2);
00073             a[2] = QPointF(ip2.x(), ip2.y()+lw2);
00074             a[3] = QPointF(ip1.x(), ip1.y()+lw2);
00075             p.drawPolygon(a);
00076             }
00077       }
00078 
00079 <span class="comment">//---------------------------------------------------------</span>
00080 <span class="comment">//   move</span>
00081 <span class="comment">//---------------------------------------------------------</span>
00082 
<a name="l00083"></a><a class="code" href="classBeam.html#a8">00083</a> <span class="keywordtype">void</span> <a class="code" href="classBeam.html#a8">Beam::move</a>(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y)
00084       {
00085       Element::move(x, y);
00086       <span class="keywordflow">for</span> (<a class="code" href="beam_8h.html#a2">ciBeamSegment</a> ibs = <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00087          ibs != <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ibs) {
00088             <a class="code" href="structBeamSegment.html">BeamSegment</a>* bs = *ibs;
00089             bs-&gt;<a class="code" href="structBeamSegment.html#a2">move</a>(x, y);
00090             }
00091       }
00092 
00093 <span class="comment">//---------------------------------------------------------</span>
00094 <span class="comment">//   layoutBeams</span>
00095 <span class="comment">//    layout beams and stems</span>
00096 <span class="comment">//    auto - beamer</span>
00097 <span class="comment">//---------------------------------------------------------</span>
00098 
<a name="l00099"></a><a class="code" href="classMeasure.html#a58">00099</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a58">Measure::layoutBeams</a>()
00100       {
00101       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">iBeam</a> i = <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00102             <span class="keyword">delete</span> *i;
00103       <a class="code" href="classMeasure.html#r4">_beamList</a>.clear();
00104 
00105       <span class="keywordtype">int</span> tracks = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>() * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00106       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00107             <a class="code" href="classChordRest.html">ChordRest</a>* a1 = 0;      <span class="comment">// start of (potential) beam</span>
00108             <a class="code" href="classBeam.html">Beam</a>* beam    = 0;
00109             <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00110                   <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00111                   <span class="keywordflow">if</span> (e == 0)
00112                         <span class="keywordflow">continue</span>;
00113                   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a22">CLEF</a>) {
00114                         <span class="keywordflow">if</span> (beam) {
00115                               beam-&gt;<a class="code" href="classBeam.html#a4">layout</a>();
00116                               beam = 0;
00117                               }
00118                         <span class="keywordflow">if</span> (a1) {
00119                               a1-&gt;<a class="code" href="classChordRest.html#a14">layoutStem</a>();
00120                               a1 = 0;
00121                               }
00122                         <span class="keywordflow">continue</span>;
00123                         }
00124                   <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>())
00125                         <span class="keywordflow">continue</span>;
00126                   <a class="code" href="classChordRest.html">ChordRest</a>* cr = (<a class="code" href="classChordRest.html">ChordRest</a>*) e;
00127                   <a class="code" href="note_8h.html#a36">BeamMode</a> bm = cr-&gt;<a class="code" href="classChordRest.html#a6">beamMode</a>();
00128 
00129                   <span class="comment">//---------------------------------------</span>
00130                   <span class="comment">//   check for beam end:</span>
00131                   <span class="comment">//    - beam ends on next quarter note</span>
00132                   <span class="comment">//---------------------------------------</span>
00133 
00134                   <span class="keywordtype">bool</span> tooLong = cr-&gt;<a class="code" href="classElement.html#a76">tickLen</a>() &gt;= <a class="code" href="mtime_8h.html#a0">division</a>;
00135                   <span class="keywordflow">if</span> (beam) {
00136                         <span class="keywordtype">int</span> mbt = <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o35">maxBeamTicks</a>;
00137                         <span class="keywordtype">int</span> z, n;
00138                         _score-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a6">timesig</a>(cr-&gt;<a class="code" href="classElement.html#a74">tick</a>(), z, n);
00139                         <span class="keywordflow">if</span> (z == 3 &amp;&amp; n == 8)   <span class="comment">// hack!</span>
00140                               mbt = <a class="code" href="mtime_8h.html#a0">division</a> * 3 / 2;
00141                         <span class="keywordtype">bool</span> styleBreak = (cr-&gt;<a class="code" href="classElement.html#a74">tick</a>() % mbt) == 0;
00142                         <span class="keywordtype">bool</span> hintBreak  = bm == <a class="code" href="note_8h.html#a36a30">BEAM_BEGIN</a> || bm == <a class="code" href="note_8h.html#a36a33">BEAM_NO</a>;
00143 
00144                         <span class="keywordtype">bool</span> tbr = (bm != <a class="code" href="note_8h.html#a36a31">BEAM_MID</a>) &amp;&amp; (bm != <a class="code" href="note_8h.html#a36a32">BEAM_END</a>) &amp;&amp; (styleBreak || tooLong || hintBreak);
00145                         <span class="keywordflow">if</span> (tbr) {
00146                               beam-&gt;<a class="code" href="classBeam.html#a4">layout</a>();
00147                               beam = 0;
00148                               a1   = 0;
00149                               <span class="keywordflow">goto</span> newBeam;
00150                               }
00151                         <span class="keywordflow">else</span> {
00152                               cr-&gt;<a class="code" href="classChordRest.html#a7">setBeam</a>(beam);
00153                               beam-&gt;<a class="code" href="classBeam.html#a5">add</a>(cr);
00154 
00155                               <span class="comment">// is this the last beam element?</span>
00156                               <span class="keywordflow">if</span> (bm == <a class="code" href="note_8h.html#a36a32">BEAM_END</a>) {
00157                                     beam-&gt;<a class="code" href="classBeam.html#a4">layout</a>();
00158                                     beam = 0;
00159                                     a1   = 0;
00160                                     }
00161                               }
00162                         }
00163                   <span class="keywordflow">else</span> {
00164 newBeam:
00165                         <span class="keywordtype">bool</span> hint = (bm != <a class="code" href="note_8h.html#a36a33">BEAM_NO</a>) &amp;&amp; !tooLong;
00166                         <span class="comment">// dont automatically start beam at a rest</span>
00167                         <span class="keywordflow">if</span> (bm == <a class="code" href="note_8h.html#a36a29">BEAM_AUTO</a> &amp;&amp; cr-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a26">REST</a> &amp;&amp; a1 == 0)
00168                               hint = <span class="keyword">false</span>;
00169                         <span class="keywordflow">if</span> (hint) {
00170                               <span class="keywordflow">if</span> (a1 == 0) {
00171                                     a1 = cr;
00172                                     }
00173                               <span class="keywordflow">else</span> {
00174                                     <span class="keywordflow">if</span> (bm == <a class="code" href="note_8h.html#a36a30">BEAM_BEGIN</a>) {
00175                                           a1-&gt;<a class="code" href="classChordRest.html#a14">layoutStem</a>();
00176                                           a1 = cr;
00177                                           }
00178                                     <span class="keywordflow">else</span> {
00179                                           beam = <span class="keyword">new</span> <a class="code" href="classBeam.html">Beam</a>(<a class="code" href="classElement.html#a4">score</a>());
00180                                           <a class="code" href="classMeasure.html#a38">addBeam</a>(beam);
00181                                           a1-&gt;setBeam(beam);
00182                                           beam-&gt;<a class="code" href="classBeam.html#a5">add</a>(a1);
00183                                           cr-&gt;<a class="code" href="classChordRest.html#a7">setBeam</a>(beam);
00184                                           beam-&gt;<a class="code" href="classBeam.html#a5">add</a>(cr);
00185                                           }
00186                                     }
00187                               }
00188                         <span class="keywordflow">else</span> {
00189                               cr-&gt;<a class="code" href="classChordRest.html#a14">layoutStem</a>();
00190                               <span class="keywordflow">if</span> (a1)
00191                                     a1-&gt;layoutStem();
00192                               a1 = 0;
00193                               }
00194                         }
00195                   }
00196             <span class="keywordflow">if</span> (beam)
00197                   beam-&gt;<a class="code" href="classBeam.html#a4">layout</a>();
00198             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a1)
00199                   a1-&gt;<a class="code" href="classChordRest.html#a14">layoutStem</a>();
00200             }
00201       }
00202 
00203 <span class="comment">//---------------------------------------------------------</span>
00204 <span class="comment">//   add</span>
00205 <span class="comment">//---------------------------------------------------------</span>
00206 
<a name="l00207"></a><a class="code" href="classChordRestList.html#a0">00207</a> <span class="keywordtype">void</span> <a class="code" href="classChordRestList.html#a0">ChordRestList::add</a>(<a class="code" href="classChordRest.html">ChordRest</a>* n)
00208       {
00209       std::multimap&lt;const int, ChordRest*, std::less&lt;int&gt; &gt;::insert(std::pair&lt;const int, ChordRest*&gt; (n-&gt;<a class="code" href="classElement.html#a74">tick</a>(), n));
00210       }
00211 
00212 <span class="comment">//---------------------------------------------------------</span>
00213 <span class="comment">//   xmlType</span>
00214 <span class="comment">//---------------------------------------------------------</span>
00215 
<a name="l00216"></a><a class="code" href="classBeam.html#a7">00216</a> QString <a class="code" href="classBeam.html#a7">Beam::xmlType</a>(<a class="code" href="classChordRest.html">ChordRest</a>* cr)<span class="keyword"> const</span>
00217 <span class="keyword">      </span>{
00218       <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a2">ciChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00219             <span class="keywordflow">if</span> (i-&gt;second == cr) {
00220                   <span class="keywordflow">if</span> (i == <a class="code" href="classBeam.html#r0">elements</a>.begin())
00221                         <span class="keywordflow">return</span> QString(<span class="stringliteral">"begin"</span>);
00222                   ++i;
00223                   <span class="keywordflow">if</span> (i == <a class="code" href="classBeam.html#r0">elements</a>.end())
00224                         <span class="keywordflow">return</span> QString(<span class="stringliteral">"end"</span>);
00225                   <span class="keywordflow">return</span> QString(<span class="stringliteral">"continue"</span>);
00226                   }
00227             }
00228       printf(<span class="stringliteral">"Beam::xmlType(): cannot find ChordRest\n"</span>);
00229       <span class="keywordflow">return</span> QString(<span class="stringliteral">"continue"</span>);
00230       }
00231 
00232 <span class="comment">//---------------------------------------------------------</span>
00233 <span class="comment">//   layout</span>
00234 <span class="comment">//---------------------------------------------------------</span>
00235 
<a name="l00236"></a><a class="code" href="classBeam.html#a4">00236</a> <span class="keywordtype">void</span> <a class="code" href="classBeam.html#a4">Beam::layout</a>()
00237       {
00238       <span class="comment">//delete old segments</span>
00239       <span class="keywordflow">for</span> (<a class="code" href="beam_8h.html#a1">iBeamSegment</a> i = <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00240             <span class="keyword">delete</span> *i;
00241       <a class="code" href="classBeam.html#r1">beamSegments</a>.clear();
00242 
00243       <span class="comment">//---------------------------------------------------</span>
00244       <span class="comment">//   calculate direction of beam</span>
00245       <span class="comment">//    - majority</span>
00246       <span class="comment">//          number count of up or down notes</span>
00247       <span class="comment">//    - mean</span>
00248       <span class="comment">//          mean centre distance of all notes</span>
00249       <span class="comment">//    - median</span>
00250       <span class="comment">//          mean centre distance weighted per note</span>
00251       <span class="comment">//</span>
00252       <span class="comment">//   currently we use the "majority" method</span>
00253       <span class="comment">//---------------------------------------------------</span>
00254 
00255       <span class="keywordtype">int</span> upCount    = 0;
00256       <span class="keywordtype">int</span> maxTickLen = 0;
00257       <span class="keyword">const</span> <a class="code" href="classChordRest.html">ChordRest</a>* a1  = <a class="code" href="classBeam.html#r0">elements</a>.<a class="code" href="classChordRestList.html#a1">front</a>();
00258       <span class="keyword">const</span> <a class="code" href="classChordRest.html">ChordRest</a>* a2  = <a class="code" href="classBeam.html#r0">elements</a>.<a class="code" href="classChordRestList.html#a2">back</a>();
00259       <a class="code" href="classChord.html">Chord</a>* c1      = 0;
00260       <a class="code" href="classChord.html">Chord</a>* c2      = 0;
00261       <span class="keywordtype">int</span> <a class="code" href="classBeam.html#a8">move</a>       = 0;
00262       <span class="keywordtype">int</span> firstMove  = <a class="code" href="classBeam.html#r0">elements</a>.<a class="code" href="classChordRestList.html#a1">front</a>()-&gt;<a class="code" href="classChordRest.html#a13">move</a>();
00263 
00264       <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00265             <span class="comment">//</span>
00266             <span class="comment">// delete stem &amp; flag for this chord</span>
00267             <span class="comment">//</span>
00268             <span class="keywordflow">if</span> (i-&gt;second-&gt;type() == <a class="code" href="element_8h.html#a65a25">CHORD</a>) {
00269                   c2 = (<a class="code" href="classChord.html">Chord</a>*)(i-&gt;second);
00270                   <span class="keywordflow">if</span> (c1 == 0)
00271                         c1 = c2;
00272                   <a class="code" href="classChord.html">Chord</a>* chord = c2;
00273                   chord-&gt;<a class="code" href="classChord.html#a24">setStem</a>(0);
00274                   chord-&gt;<a class="code" href="classChord.html#a27">setFlag</a>(0);
00275                   <span class="comment">//</span>
00276                   <span class="comment">// if only one stem direction is manually set it</span>
00277                   <span class="comment">// determines if beams are up or down</span>
00278                   <span class="comment">//</span>
00279                   <span class="keywordflow">if</span> (chord-&gt;<a class="code" href="classChord.html#a11">stemDirection</a>() != <a class="code" href="globals_8h.html#a24a7">AUTO</a>)
00280                         upCount += chord-&gt;<a class="code" href="classChord.html#a11">stemDirection</a>() == <a class="code" href="structUP.html">UP</a> ? 1000 : -1000;
00281                   <span class="keywordflow">else</span>
00282                         upCount += chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>() ? 1 : -1;
00283                   <span class="keywordflow">if</span> (chord-&gt;<a class="code" href="classChord.html#a21">move</a>()) {
00284                         <span class="keywordflow">if</span> (firstMove == 0)
00285                               move = chord-&gt;<a class="code" href="classChord.html#a21">move</a>() * -1;
00286                         <span class="keywordflow">else</span>
00287                               move = chord-&gt;<a class="code" href="classChord.html#a21">move</a>() * -1; <span class="comment">// -1;</span>
00288                         }
00289                   }
00290             <span class="keywordtype">int</span> tl = i-&gt;second-&gt;tickLen();
00291             <span class="keywordflow">if</span> (tl &gt; maxTickLen)
00292                   maxTickLen = tl;
00293             }
00294 
00295       <span class="keywordtype">bool</span> upFlag = upCount &gt;= 0;
00296       <span class="comment">//</span>
00297       <span class="comment">//  move = 0     no cross beaming</span>
00298       <span class="comment">//       = -1    staff 1 - 2</span>
00299       <span class="comment">//       = 1     staff 2 - 1</span>
00300 
00301       <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00302             <a class="code" href="classChordRest.html">ChordRest</a>* cr = (<a class="code" href="classChordRest.html">ChordRest</a>*)(i-&gt;second);
00303             <span class="keywordflow">if</span> (move == 1)
00304                   cr-&gt;<a class="code" href="classChordRest.html#a20">setUp</a>(cr-&gt;<a class="code" href="classChordRest.html#a13">move</a>() == 0);
00305             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (move == -1)
00306                   cr-&gt;<a class="code" href="classChordRest.html#a20">setUp</a>(cr-&gt;<a class="code" href="classChordRest.html#a13">move</a>() != 0);
00307             <span class="keywordflow">else</span>
00308                   cr-&gt;<a class="code" href="classChordRest.html#a20">setUp</a>(upFlag);
00309             }
00310 
00311       <span class="keywordflow">if</span> (move == 1)
00312             upFlag = <span class="keyword">true</span>;
00313       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (move == -1)
00314             upFlag = <span class="keyword">false</span>;
00315 
00316       <span class="comment">//------------------------------------------------------------</span>
00317       <span class="comment">//   calculate slope of beam</span>
00318       <span class="comment">//    - die Steigung ist null bei "konkaven" notenfolgen</span>
00319       <span class="comment">//------------------------------------------------------------</span>
00320 
00321       <span class="keywordtype">int</span> concave = 0;
00322       <span class="keywordtype">int</span> l1      = a1-&gt;<a class="code" href="classChordRest.html#a17">line</a>(a1-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>());
00323       <span class="keywordtype">int</span> l2      = a2-&gt;<a class="code" href="classChordRest.html#a17">line</a>(a2-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>());
00324       {
00325       <a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin();
00326       ++i;
00327       <span class="keywordtype">int</span> ll = l1;
00328       <span class="keywordflow">for</span> (;;) {
00329             <a class="code" href="classChordRest.html">ChordRest</a>* cr = i-&gt;second;
00330             ++i;
00331             <span class="keywordflow">if</span> (i == <a class="code" href="classBeam.html#r0">elements</a>.end())
00332                   <span class="keywordflow">break</span>;
00333             <span class="keywordtype">int</span> l = cr-&gt;<a class="code" href="classChordRest.html#a17">line</a>(cr-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>());
00334             <span class="keywordflow">if</span> (l1 &lt; l2) {                <span class="comment">// abfallend</span>
00335                   <span class="keywordflow">if</span> (l &lt; l1) {
00336                         <span class="keywordflow">if</span> (l1-l &gt; concave)
00337                               concave = l1 - l;
00338                         <span class="keywordflow">break</span>;
00339                         }
00340                   }
00341             <span class="keywordflow">else</span> {                       <span class="comment">// aufsteigend</span>
00342                   <span class="keywordflow">if</span> (upFlag) {
00343                         <span class="keywordflow">if</span> (l &gt; ll) {
00344                               <span class="keywordflow">if</span> (l - ll &gt; concave)
00345                                     concave = l - ll;
00346                               <span class="keywordflow">break</span>;
00347                               }
00348                         }
00349                   <span class="keywordflow">else</span> {
00350                         <span class="keywordflow">if</span> (l &lt; l2) {
00351                               <span class="keywordflow">if</span> (l2-l &gt; concave)
00352                                     concave = l2 - l;
00353                               <span class="keywordflow">break</span>;
00354                               }
00355                         }
00356                   }
00357             ll = l;
00358             }
00359       }
00360 
00361       <span class="keywordtype">double</span> spatium2 = <a class="code" href="spatium_8h.html#a0">_spatium</a> * .5;
00362       <span class="keywordtype">int</span> cut = 0;
00363       <span class="keywordtype">double</span> q1, q2;
00364       <span class="keywordflow">if</span> (concave)
00365             q1 = q2 = 0.0;
00366       <span class="keywordflow">else</span> {
00367             <span class="keywordtype">double</span> div = (a2-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + a2-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x())
00368                           - (a1-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + a1-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x());
00369             <span class="keywordflow">if</span> (div == 0)
00370                   q1 = 1;
00371             <span class="keywordflow">else</span>
00372                   q1 = (l2 - l1) / div;
00373             <span class="keywordflow">if</span> (fabs(q1) &lt; <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o33">beamMinSteigung</a>) {
00374                   cut = q1 &gt; 0.0 ? 0 : -1;
00375                   q1 = 0;
00376                   }
00377             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (q1 &gt; <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o34">beamMaxSteigung</a>) {
00378                   q1 = <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o34">beamMaxSteigung</a>;
00379                   cut = 1;
00380                   }
00381             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (-q1 &gt; <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o34">beamMaxSteigung</a>) {
00382                   q1 = -<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o34">beamMaxSteigung</a>;
00383                   cut = -1;
00384                   }
00385             q2 = q1 * spatium2;
00386             }
00387 
00388       cut *= (upFlag ? 1 : -1);
00389 
00390       <span class="comment">//---------------------------------------------------</span>
00391       <span class="comment">//    create beam segments</span>
00392       <span class="comment">//---------------------------------------------------</span>
00393 
00394             <span class="comment">//---------------------------------------------</span>
00395             <span class="comment">//   create top beam segment</span>
00396             <span class="comment">//---------------------------------------------</span>
00397 
00398       <span class="keywordtype">double</span> xoffLeft  = point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o15">stemWidth</a>)/2;
00399       <span class="keywordtype">double</span> xoffRight = xoffLeft;
00400 
00401       QPointF p1s(a1-&gt;<a class="code" href="classChordRest.html#a18">stemPos</a>(a1-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>(), <span class="keyword">false</span>) + a1-&gt;<a class="code" href="classElement.html#a20">pos</a>() + a1-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00402       QPointF p2s(a2-&gt;<a class="code" href="classChordRest.html#a18">stemPos</a>(a2-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>(), <span class="keyword">false</span>) + a2-&gt;<a class="code" href="classElement.html#a20">pos</a>() + a2-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00403       <span class="keywordtype">double</span> x1 = p1s.x() - xoffLeft;
00404       <span class="keywordtype">double</span> x2 = p2s.x() + xoffRight;
00405 
00406       QPointF p1, p2;
00407       <span class="keywordtype">double</span> ys = (x2 - x1) * q2;    <span class="comment">// y steigung</span>
00408       <span class="keywordflow">if</span> (cut &gt;= 0) {
00409             <span class="comment">// linker Punkt ist Referenz</span>
00410             p1 = QPointF(x1, p1s.y());
00411             p2 = QPointF(x2, p1.y() + ys);
00412             }
00413       <span class="keywordflow">else</span> {
00414             <span class="comment">// rechter Punkt ist Referenz</span>
00415             p2 = QPointF(x2, p2s.y());
00416             p1 = QPointF(x1, p2.y() - ys);
00417             }
00418 
00419       <span class="comment">//---------------------------------------------------</span>
00420       <span class="comment">// calculate min stem len</span>
00421       <span class="comment">//    adjust beam position if necessary</span>
00422       <span class="comment">//</span>
00423       <span class="keywordtype">double</span> beamDist = point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o31">beamDistance</a> * <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o30">beamWidth</a>
00424                         + <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o30">beamWidth</a>) * (upFlag ? 1.0 : -1.0);
00425       <span class="keywordtype">double</span> min = 1000;
00426       <span class="keywordtype">double</span> max = -1000;
00427       <span class="keywordtype">int</span> lmove = <a class="code" href="classBeam.html#r0">elements</a>.<a class="code" href="classChordRestList.html#a1">front</a>()-&gt;<a class="code" href="classChordRest.html#a13">move</a>();
00428       <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00429             <span class="keywordflow">if</span> (i-&gt;second-&gt;type() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00430                   <span class="keywordflow">continue</span>;
00431             <a class="code" href="classChord.html">Chord</a>* chord  = (<a class="code" href="classChord.html">Chord</a>*)(i-&gt;second);
00432             <span class="keywordflow">if</span> (chord-&gt;<a class="code" href="classChord.html#a21">move</a>() != lmove)
00433                   <span class="keywordflow">break</span>;
00434             QPointF npos(chord-&gt;<a class="code" href="classChord.html#a25">stemPos</a>(chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>(), <span class="keyword">true</span>) + chord-&gt;<a class="code" href="classElement.html#a20">pos</a>() + chord-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00435             <span class="keywordtype">double</span> bd = (chord-&gt;<a class="code" href="classChordRest.html#a12">beams</a>() - 1) * beamDist * (chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>() ? 1.0 : -1.0);
00436             <span class="keywordtype">double</span> y1 = npos.y();
00437             <span class="keywordtype">double</span> y2  = p1.y() + (npos.x() - x1) * q2;
00438             <span class="keywordtype">double</span> stemLen = chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>() ? (y1 - y2) : (y2 - y1);
00439             stemLen -= bd;
00440             <span class="keywordflow">if</span> (stemLen &lt; min)
00441                   min = stemLen;
00442             <span class="keywordflow">if</span> (stemLen &gt; max)
00443                   max = stemLen;
00444             }
00445 
00446       <span class="comment">// adjst beam position</span>
00447       <span class="keywordtype">double</span> n = 3.0;   <span class="comment">// minimum stem len (should be a style parameter)</span>
00448       <span class="keywordflow">if</span> (fabs(max-min) &gt; <a class="code" href="spatium_8h.html#a0">_spatium</a> * 2)
00449             n = 2.0;    <span class="comment">// reduce minimum stem len (heuristic)</span>
00450 
00451       {
00452       <span class="keywordtype">double</span> diff = <a class="code" href="spatium_8h.html#a0">_spatium</a> * n - min;
00453       <span class="keywordflow">if</span> (upFlag)
00454             diff = -diff;
00455       p1.ry() += diff;
00456       p2.ry() += diff;
00457       }
00458 
00459       <span class="comment">//---------------------------------------------------</span>
00460 
00461       <a class="code" href="structBeamSegment.html">BeamSegment</a>* bs = <span class="keyword">new</span> <a class="code" href="structBeamSegment.html">BeamSegment</a>;
00462       <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00463       bs-&gt;<a class="code" href="structBeamSegment.html#o0">p1</a>  = p1;
00464       bs-&gt;<a class="code" href="structBeamSegment.html#o1">p2</a>  = p2;
00465 
00466       <span class="keywordflow">switch</span> (maxTickLen) {
00467             <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/16:       <span class="comment">// 1/64     24</span>
00468                   bs = <span class="keyword">new</span> BeamSegment(p1, p2);
00469                   bs-&gt;<a class="code" href="structBeamSegment.html#a2">move</a>(0, beamDist * 3);
00470                   <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00471 
00472             <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/8:        <span class="comment">// 1/32   48</span>
00473                   bs = <span class="keyword">new</span> BeamSegment(p1, p2);
00474                   bs-&gt;<a class="code" href="structBeamSegment.html#a2">move</a>(0, beamDist * 2);
00475                   <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00476 
00477             <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/4:              <span class="comment">// 1/16  96</span>
00478             <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/4+<a class="code" href="mtime_8h.html#a0">division</a>/8:   <span class="comment">//       144</span>
00479                   bs = <span class="keyword">new</span> BeamSegment(p1, p2);
00480                   bs-&gt;<a class="code" href="structBeamSegment.html#a2">move</a>(0, beamDist);
00481                   <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00482                   <span class="keywordflow">break</span>;
00483 
00484             <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/2:              <span class="comment">// 192</span>
00485             <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/2+<a class="code" href="mtime_8h.html#a0">division</a>/4:
00486                   <span class="keywordflow">break</span>;
00487             <span class="keywordflow">default</span>:
00488                   printf(<span class="stringliteral">"beam error(1): %d\n"</span>, maxTickLen);
00489                   <span class="keywordflow">break</span>;
00490             }
00491 
00492             <span class="comment">//---------------------------------------------</span>
00493             <span class="comment">//   create broken/short beam segments</span>
00494             <span class="comment">//---------------------------------------------</span>
00495 
00496       <span class="keywordtype">int</span> l = maxTickLen;
00497       <span class="keywordflow">if</span> (l &gt; <a class="code" href="mtime_8h.html#a0">division</a>/4)
00498             l = <a class="code" href="mtime_8h.html#a0">division</a>/4;
00499       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l &gt; <a class="code" href="mtime_8h.html#a0">division</a>/8)
00500             l = <a class="code" href="mtime_8h.html#a0">division</a>/8;
00501       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (l &gt; <a class="code" href="mtime_8h.html#a0">division</a>/16)
00502             l = <a class="code" href="mtime_8h.html#a0">division</a>/16;
00503       <span class="keywordflow">else</span>
00504             l /= 2;
00505 
00506       <span class="keywordflow">for</span> (;l &gt;= <a class="code" href="mtime_8h.html#a0">division</a>/16; l = l/2) {
00507             <span class="keywordtype">int</span> n = 1;
00508             <span class="keywordflow">switch</span> (l) {
00509                   <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/4:  n = 1; <span class="keywordflow">break</span>;
00510                   <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/8:  n = 2; <span class="keywordflow">break</span>;
00511                   <span class="keywordflow">case</span> <a class="code" href="mtime_8h.html#a0">division</a>/16: n = 3; <span class="keywordflow">break</span>;
00512                   }
00513 
00514             <span class="keywordtype">double</span> y1 = p1.y() + beamDist * n;
00515 
00516             <a class="code" href="classNote.html">Note</a>* nn1 = 0;
00517             <a class="code" href="classNote.html">Note</a>* nn2 = 0;
00518             <span class="keywordtype">bool</span> nn1r = <span class="keyword">false</span>;
00519             <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00520                   <span class="keywordflow">if</span> (i-&gt;second-&gt;type() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00521                         <span class="keywordflow">continue</span>;
00522                   <a class="code" href="classChord.html">Chord</a>* chord = (<a class="code" href="classChord.html">Chord</a>*)(i-&gt;second);
00523                   <span class="keywordtype">int</span> tl = chord-&gt;<a class="code" href="classElement.html#a76">tickLen</a>();
00524                   <span class="keywordflow">if</span> (tl &gt; l) {
00525                         <span class="keywordflow">if</span> (nn2) {
00526                               <span class="comment">// create short segment</span>
00527                               bs = <span class="keyword">new</span> BeamSegment;
00528                               <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00529                               <span class="keywordtype">double</span> x2 = nn1-&gt;<a class="code" href="classNote.html#a42">stemPos</a>(nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>()).x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x();
00530                               <span class="keywordtype">double</span> x3 = nn2-&gt;<a class="code" href="classNote.html#a42">stemPos</a>(nn2-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>()).x() + nn2-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + nn2-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x();
00531                               bs-&gt;<a class="code" href="structBeamSegment.html#o0">p1</a> = QPointF(x2, (x2 - x1) * q2 + y1);
00532                               bs-&gt;<a class="code" href="structBeamSegment.html#o1">p2</a> = QPointF(x3, (x3 - x1) * q2 + y1);
00533                               }
00534                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nn1) {
00535                               <span class="comment">// create broken segment</span>
00536                               bs = <span class="keyword">new</span> BeamSegment;
00537                               <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00538                               <span class="keywordtype">double</span> x2, x3;
00539                               <span class="keywordflow">if</span> (!nn1r) {
00540                                     x3 = nn1-&gt;<a class="code" href="classNote.html#a42">stemPos</a>(nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>()).x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x();
00541                                     x2 = x3 - point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o32">beamMinLen</a>);
00542                                     }
00543                               <span class="keywordflow">else</span> {
00544                                     x2 = nn1-&gt;<a class="code" href="classNote.html#a42">stemPos</a>(nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>()).x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x();
00545                                     x3 = x2 + point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o32">beamMinLen</a>);
00546                                     }
00547 
00548                               bs-&gt;<a class="code" href="structBeamSegment.html#o0">p1</a> = QPointF(x2, (x2 - x1) * q2 + y1);
00549                               bs-&gt;<a class="code" href="structBeamSegment.html#o1">p2</a> = QPointF(x3, (x3 - x1) * q2 + y1);
00550                               }
00551                         nn1r = <span class="keyword">false</span>;
00552                         nn1 = nn2 = 0;
00553                         <span class="keywordflow">continue</span>;
00554                         }
00555                   <a class="code" href="classNote.html">Note</a>* n = chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>() ? chord-&gt;<a class="code" href="classChord.html#a15">noteList</a>()-&gt;<a class="code" href="classNoteList.html#a2">back</a>()
00556                                       : chord-&gt;<a class="code" href="classChord.html#a15">noteList</a>()-&gt;<a class="code" href="classNoteList.html#a1">front</a>();
00557                   nn1r = <span class="keyword">false</span>;
00558                   <span class="keywordflow">if</span> (nn1)
00559                         nn2 = n;
00560                   <span class="keywordflow">else</span> {
00561                         nn1 = n;
00562                         nn1r = i == <a class="code" href="classBeam.html#r0">elements</a>.begin();
00563                         }
00564                   }
00565             <span class="keywordflow">if</span> (nn2) {
00566                   <span class="comment">// create short segment</span>
00567                   bs = <span class="keyword">new</span> BeamSegment;
00568                   <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00569                   <span class="keywordtype">double</span> x2 = nn1-&gt;<a class="code" href="classNote.html#a42">stemPos</a>(nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>()).x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x();
00570                   <span class="keywordtype">double</span> x3 = nn2-&gt;<a class="code" href="classNote.html#a42">stemPos</a>(nn2-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>()).x() + nn2-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + nn2-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x();
00571                   bs-&gt;<a class="code" href="structBeamSegment.html#o0">p1</a> = QPointF(x2, (x2 - x1) * q2 + y1);
00572                   bs-&gt;<a class="code" href="structBeamSegment.html#o1">p2</a> = QPointF(x3, (x3 - x1) * q2 + y1);
00573                   }
00574            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nn1) {
00575                   <span class="comment">// create broken segment</span>
00576                   bs = <span class="keyword">new</span> BeamSegment;
00577                   <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(bs);
00578                   <span class="keywordtype">double</span> x3 = nn1-&gt;<a class="code" href="classNote.html#a42">stemPos</a>(nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>()).x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x() + nn1-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().x();
00579                   <span class="keywordtype">double</span> x2 = x3 - point(<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o32">beamMinLen</a>);
00580                   bs-&gt;<a class="code" href="structBeamSegment.html#o0">p1</a> = QPointF(x2, (x2 - x1) * q2 + y1);
00581                   bs-&gt;<a class="code" href="structBeamSegment.html#o1">p2</a> = QPointF(x3, (x3 - x1) * q2 + y1);
00582                   }
00583             }
00584 
00585       <span class="comment">//---------------------------------------------------</span>
00586       <span class="comment">//    create stem's</span>
00587       <span class="comment">//    stem Pos() is relative to Chord</span>
00588       <span class="comment">//---------------------------------------------------</span>
00589 
00590       <span class="keywordflow">for</span> (<a class="code" href="chordlist_8h.html#a0">iChordRest</a> i = <a class="code" href="classBeam.html#r0">elements</a>.begin(); i != <a class="code" href="classBeam.html#r0">elements</a>.end(); ++i) {
00591             <span class="keywordflow">if</span> (i-&gt;second-&gt;type() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00592                   <span class="keywordflow">continue</span>;
00593             <a class="code" href="classChord.html">Chord</a>* chord = (<a class="code" href="classChord.html">Chord</a>*)(i-&gt;second);
00594 
00595             QPointF npos(chord-&gt;<a class="code" href="classChord.html#a25">stemPos</a>(chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>(), <span class="keyword">false</span>) + chord-&gt;<a class="code" href="classElement.html#a20">pos</a>() + chord-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00596 
00597             <a class="code" href="classStem.html">Stem</a>* stem = chord-&gt;<a class="code" href="classChord.html#a23">stem</a>();
00598             <span class="keywordflow">if</span> (!stem) {
00599                   stem = <span class="keyword">new</span> <a class="code" href="classStem.html">Stem</a>(<a class="code" href="classElement.html#a4">score</a>());
00600                   chord-&gt;<a class="code" href="classChord.html#a24">setStem</a>(stem);
00601                   }
00602 
00603             <span class="keywordtype">double</span> x2 = npos.x();
00604             <span class="keywordtype">double</span> xd = x2 - x1;
00605             <span class="keywordtype">double</span> y1 = npos.y();
00606             <span class="keywordtype">double</span> y2 = p1.y() + xd * q2;
00607 
00608             <span class="keywordtype">double</span> stemLen = chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>() ? (y1 - y2) : (y2 - y1);
00609             stem-&gt;<a class="code" href="classLine.html#a10">setLen</a>(spatium(stemLen));
00610 
00611             <span class="keywordflow">if</span> (chord-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>())
00612                   npos += QPointF(0, -stemLen);
00613             stem-&gt;<a class="code" href="classElement.html#a23">setpos</a>(npos - chord-&gt;<a class="code" href="classElement.html#a20">pos</a>() - chord-&gt;<a class="code" href="classChordRest.html#a4">segment</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>());
00614             chord-&gt;<a class="code" href="classChord.html#a9">bboxUpdate</a>();
00615             }
00616       _bbox = QRectF(0, 0, 0, 0);
00617       <span class="keywordflow">for</span> (<a class="code" href="beam_8h.html#a2">ciBeamSegment</a> ibs = <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00618          ibs != <a class="code" href="classBeam.html#r1">beamSegments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ibs) {
00619             BeamSegment* bs = *ibs;
00620             _bbox |= QRectF(bs-&gt;<a class="code" href="structBeamSegment.html#o0">p1</a>, QSizeF(1.0, 1.0));
00621             _bbox |= QRectF(bs-&gt;<a class="code" href="structBeamSegment.html#o1">p2</a>, QSizeF(1.0, 1.0));
00622             }
00623 <span class="comment">//??      _bbox = _bbox.expand(point(style-&gt;beamWidth));</span>
00624       }
00625 
00626 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
