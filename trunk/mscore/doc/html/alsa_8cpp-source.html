<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: alsa.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>alsa.cpp</h1><a href="alsa_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: alsa.cpp,v 1.7 2005/04/17 09:28:16 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00010 
00011 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="alsa_8h.html">alsa.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00015 
00016 <span class="preprocessor">#ifdef USE_ALSA</span>
00017 <span class="preprocessor"></span>
00018 <span class="keyword">static</span> snd_seq_t* alsaSeq;
00019 <span class="keyword">static</span> <span class="keywordtype">int</span> alsaSeqFdi = -1;
00020 <span class="keyword">static</span> <span class="keywordtype">int</span> alsaSeqFdo = -1;
00021 <span class="keyword">static</span> snd_seq_addr_t musePort;
00022 
00023 <span class="comment">//---------------------------------------------------------</span>
00024 <span class="comment">//   curTime</span>
00025 <span class="comment">//---------------------------------------------------------</span>
00026 
00027 <span class="keyword">static</span> <span class="keywordtype">double</span> curTime()
00028       {
00029       <span class="keyword">struct </span>timeval t;
00030       gettimeofday(&amp;t, 0);
00031       <span class="keywordflow">return</span> (<span class="keywordtype">double</span>)((<span class="keywordtype">double</span>)t.tv_sec + (t.tv_usec / 1000000.0));
00032       }
00033 
00034 <span class="comment">//---------------------------------------------------------</span>
00035 <span class="comment">//   AlsaAudio</span>
00036 <span class="comment">//---------------------------------------------------------</span>
00037 
00038 <a class="code" href="classAlsaAudio.html#a0">AlsaAudio::AlsaAudio</a>()
00039       {
00040       state = <a class="code" href="classAudio.html#w3w0">Audio::STOP</a>;
00041       seekflag = <span class="keyword">false</span>;
00042       startTime = curTime();
00043       }
00044 
00045 <span class="comment">//---------------------------------------------------------</span>
00046 <span class="comment">//   AlsaAudio</span>
00047 <span class="comment">//---------------------------------------------------------</span>
00048 
00049 <a class="code" href="classAlsaAudio.html#a1">AlsaAudio::~AlsaAudio</a>()
00050       {
00051       }
00052 
00053 <span class="comment">//---------------------------------------------------------</span>
00054 <span class="comment">//   init</span>
00055 <span class="comment">//---------------------------------------------------------</span>
00056 
00057 <span class="keywordtype">bool</span> <a class="code" href="classAlsaAudio.html#a2">AlsaAudio::init</a>()
00058       {
00059       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00060       }
00061 
00062 <span class="comment">//---------------------------------------------------------</span>
00063 <span class="comment">//   alsaLoop</span>
00064 <span class="comment">//---------------------------------------------------------</span>
00065 
00066 <span class="keyword">static</span> <span class="keywordtype">void</span>* alsaLoop(<span class="keywordtype">void</span>*)
00067       {
00068       <span class="keywordflow">for</span> (;;)
00069             sleep(1);
00070       <span class="keywordflow">return</span> 0;
00071       }
00072 
00073 <span class="comment">//---------------------------------------------------------</span>
00074 <span class="comment">//   start</span>
00075 <span class="comment">//---------------------------------------------------------</span>
00076 
00077 <span class="keywordtype">bool</span> <a class="code" href="classAlsaAudio.html#a6">AlsaAudio::start</a>()
00078       {
00079       pthread_attr_t* attributes = (pthread_attr_t*) malloc(<span class="keyword">sizeof</span>(pthread_attr_t));
00080       pthread_attr_init(attributes);
00081       <span class="keywordflow">if</span> (pthread_create(&amp;thread, attributes, ::alsaLoop, <span class="keyword">this</span>))
00082             perror(<span class="stringliteral">"creating thread failed:"</span>);
00083       pthread_attr_destroy(attributes);
00084       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00085       }
00086 
00087 <span class="comment">//---------------------------------------------------------</span>
00088 <span class="comment">//   stop</span>
00089 <span class="comment">//---------------------------------------------------------</span>
00090 
00091 <span class="keywordtype">bool</span> <a class="code" href="classAlsaAudio.html#a7">AlsaAudio::stop</a>()
00092       {
00093       pthread_cancel(thread);
00094       pthread_join(thread, 0);
00095       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00096       }
00097 
00098 <span class="comment">//---------------------------------------------------------</span>
00099 <span class="comment">//   registerPort</span>
00100 <span class="comment">//---------------------------------------------------------</span>
00101 
00102 <span class="keywordtype">void</span>* <a class="code" href="classAlsaAudio.html#a3">AlsaAudio::registerPort</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* <span class="comment">/*name*/</span>)
00103       {
00104       <span class="keywordflow">return</span> 0;
00105       }
00106 
00107 <span class="comment">//---------------------------------------------------------</span>
00108 <span class="comment">//   unregisterPort</span>
00109 <span class="comment">//---------------------------------------------------------</span>
00110 
00111 <span class="keywordtype">void</span> <a class="code" href="classAlsaAudio.html#a4">AlsaAudio::unregisterPort</a>(<span class="keywordtype">void</span>*)
00112       {
00113       }
00114 
00115 <span class="comment">//---------------------------------------------------------</span>
00116 <span class="comment">//   inputPorts</span>
00117 <span class="comment">//---------------------------------------------------------</span>
00118 
00119 std::list&lt;QString&gt; <a class="code" href="classAlsaAudio.html#a5">AlsaAudio::inputPorts</a>()
00120       {
00121       std::list&lt;QString&gt; l;
00122       <span class="keywordflow">return</span> l;
00123       }
00124 
00125 <span class="comment">//---------------------------------------------------------</span>
00126 <span class="comment">//   framePos</span>
00127 <span class="comment">//---------------------------------------------------------</span>
00128 
00129 <span class="keywordtype">int</span> <a class="code" href="classAlsaAudio.html#a8">AlsaAudio::framePos</a>()<span class="keyword"> const</span>
00130 <span class="keyword">      </span>{
00131       <span class="keywordflow">return</span> lrint((curTime()-startTime) * _sampleRate);
00132       }
00133 
00134 <span class="comment">//---------------------------------------------------------</span>
00135 <span class="comment">//   disconnect</span>
00136 <span class="comment">//---------------------------------------------------------</span>
00137 
00138 <span class="keywordtype">void</span> <a class="code" href="classAlsaAudio.html#a10">AlsaAudio::disconnect</a>(<span class="keywordtype">void</span>* <span class="comment">/*src*/</span>, <span class="keywordtype">void</span>* <span class="comment">/*dst*/</span>)
00139       {
00140       }
00141 
00142 <span class="comment">//---------------------------------------------------------</span>
00143 <span class="comment">//   getLBuffer</span>
00144 <span class="comment">//---------------------------------------------------------</span>
00145 
00146 <span class="keywordtype">float</span>* <a class="code" href="classAlsaAudio.html#a11">AlsaAudio::getLBuffer</a>(<span class="keywordtype">long</span> <span class="comment">/*n*/</span>)
00147       {
00148       <span class="keywordflow">return</span> 0;
00149       }
00150 
00151 <span class="comment">//---------------------------------------------------------</span>
00152 <span class="comment">//   getRBuffer</span>
00153 <span class="comment">//---------------------------------------------------------</span>
00154 
00155 <span class="keywordtype">float</span>* <a class="code" href="classAlsaAudio.html#a12">AlsaAudio::getRBuffer</a>(<span class="keywordtype">long</span> <span class="comment">/*n*/</span>)
00156       {
00157       <span class="keywordflow">return</span> 0;
00158       }
00159 
00160 <span class="comment">//---------------------------------------------------------</span>
00161 <span class="comment">//   startTransport</span>
00162 <span class="comment">//---------------------------------------------------------</span>
00163 
00164 <span class="keywordtype">void</span> <a class="code" href="classAlsaAudio.html#a14">AlsaAudio::startTransport</a>()
00165       {
00166       state = <a class="code" href="classAudio.html#w3w2">Audio::PLAY</a>;
00167       }
00168 
00169 <span class="comment">//---------------------------------------------------------</span>
00170 <span class="comment">//   stopTransport</span>
00171 <span class="comment">//---------------------------------------------------------</span>
00172 
00173 <span class="keywordtype">void</span> <a class="code" href="classAlsaAudio.html#a15">AlsaAudio::stopTransport</a>()
00174       {
00175       state = <a class="code" href="classAudio.html#w3w0">Audio::STOP</a>;
00176       }
00177 
00178 <span class="comment">//---------------------------------------------------------</span>
00179 <span class="comment">//   getState</span>
00180 <span class="comment">//---------------------------------------------------------</span>
00181 
00182 <span class="keywordtype">int</span> <a class="code" href="classAlsaAudio.html#a16">AlsaAudio::getState</a>()
00183       {
00184       <span class="keywordflow">return</span> state;
00185       }
00186 
00187 <span class="comment">//---------------------------------------------------------</span>
00188 <span class="comment">//   MidiDevice</span>
00189 <span class="comment">//---------------------------------------------------------</span>
00190 
00191 <span class="keyword">class </span>MidiDevice {
00192       snd_seq_addr_t adr;
00193       QString name;
00194       <span class="keywordtype">int</span> flags;
00195 
00196    <span class="keyword">public</span>:
00197       MidiDevice(snd_seq_addr_t adr, <span class="keyword">const</span> QString&amp; name);
00198       <span class="keywordtype">void</span> setrwFlags(<span class="keywordtype">int</span> f)  { flags = f; }
00199       <span class="keywordtype">bool</span> hasInput()<span class="keyword"> const   </span>{ <span class="keywordflow">return</span> (flags &amp; 2); }
00200       <span class="keywordtype">void</span> openInput();
00201       };
00202 
00203 <span class="keyword">typedef</span> std::list&lt;MidiDevice*&gt; MidiDeviceList;
00204 <span class="keyword">typedef</span> MidiDeviceList::iterator iMidiDevice;
00205 
00206 MidiDeviceList midiDevices;
00207 
00208 <span class="comment">//---------------------------------------------------------</span>
00209 <span class="comment">//   MidiDevice</span>
00210 <span class="comment">//---------------------------------------------------------</span>
00211 
00212 MidiDevice::MidiDevice(snd_seq_addr_t a, <span class="keyword">const</span> QString&amp; s)
00213    : name(s)
00214       {
00215       flags = 0;
00216       adr   = a;
00217       }
00218 
00219 <span class="comment">//---------------------------------------------------------</span>
00220 <span class="comment">//   openInput</span>
00221 <span class="comment">//---------------------------------------------------------</span>
00222 
00223 <span class="keywordtype">void</span> MidiDevice::openInput()
00224       {
00225       <span class="keywordflow">if</span> (hasInput()) {
00226             snd_seq_port_subscribe_t* subs;
00227             snd_seq_port_subscribe_alloca(&amp;subs);
00228             snd_seq_port_subscribe_set_dest(subs, &amp;musePort);
00229             snd_seq_port_subscribe_set_sender(subs, &amp;adr);
00230             snd_seq_subscribe_port(alsaSeq, subs);
00231             }
00232       }
00233 
00234 <span class="comment">//---------------------------------------------------------</span>
00235 <span class="comment">//   getMidiReadFd</span>
00236 <span class="comment">//---------------------------------------------------------</span>
00237 
00238 <span class="keywordtype">int</span> <a class="code" href="alsa_8cpp.html#a1">getMidiReadFd</a>()
00239       {
00240       <span class="keywordflow">return</span> alsaSeqFdi;
00241       }
00242 
00243 <span class="comment">//---------------------------------------------------------</span>
00244 <span class="comment">//   initMidi</span>
00245 <span class="comment">//    return true on error</span>
00246 <span class="comment">//---------------------------------------------------------</span>
00247 
00248 <span class="keywordtype">bool</span> <a class="code" href="alsa_8cpp.html#a0">initMidi</a>()
00249       {
00250       <span class="keywordtype">int</span> error = snd_seq_open(&amp;alsaSeq, <span class="stringliteral">"hw"</span>, SND_SEQ_OPEN_DUPLEX, SND_SEQ_NONBLOCK);
00251       <span class="keywordflow">if</span> (error &lt; 0) {
00252             fprintf(stderr, <span class="stringliteral">"Could not open ALSA sequencer: %s\n"</span>,
00253                snd_strerror(error));
00254             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00255             }
00256       <span class="keyword">const</span> <span class="keywordtype">int</span> inCap  = SND_SEQ_PORT_CAP_SUBS_READ;
00257       <span class="keyword">const</span> <span class="keywordtype">int</span> outCap = SND_SEQ_PORT_CAP_SUBS_WRITE;
00258 
00259       snd_seq_client_info_t *cinfo;
00260       snd_seq_client_info_alloca(&amp;cinfo);
00261       snd_seq_client_info_set_client(cinfo, -1);
00262 
00263       <span class="keywordflow">while</span> (snd_seq_query_next_client(alsaSeq, cinfo) &gt;= 0) {
00264             snd_seq_port_info_t *pinfo;
00265             snd_seq_port_info_alloca(&amp;pinfo);
00266             snd_seq_port_info_set_client(pinfo, snd_seq_client_info_get_client(cinfo));
00267             snd_seq_port_info_set_port(pinfo, -1);
00268 
00269             <span class="keywordflow">while</span> (snd_seq_query_next_port(alsaSeq, pinfo) &gt;= 0) {
00270                   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> capability = snd_seq_port_info_get_capability(pinfo);
00271                   <span class="keywordflow">if</span> ((capability &amp; outCap) == 0)
00272                         <span class="keywordflow">continue</span>;
00273                   snd_seq_addr_t adr = *snd_seq_port_info_get_addr(pinfo);
00274                   MidiDevice* dev = <span class="keyword">new</span> MidiDevice(adr, QString(snd_seq_port_info_get_name(pinfo)));
00275                   <span class="keywordtype">int</span> flags = 0;
00276                   <span class="keywordflow">if</span> (capability &amp; outCap)
00277                         flags |= 1;
00278                   <span class="keywordflow">if</span> (capability &amp; inCap)
00279                         flags |= 2;
00280                   dev-&gt;setrwFlags(flags);
00281                   midiDevices.push_back(dev);
00282                   }
00283             }
00284       snd_seq_set_client_name(alsaSeq, <span class="stringliteral">"MuseScore"</span>);
00285       <span class="keywordtype">int</span> ci = snd_seq_poll_descriptors_count(alsaSeq, POLLIN);
00286       <span class="keywordtype">int</span> co = snd_seq_poll_descriptors_count(alsaSeq, POLLOUT);
00287 
00288       <span class="keywordflow">if</span> (ci &gt; 1 || co &gt; 1) {
00289             printf(<span class="stringliteral">"ALSA midi: cannot handle more than one poll fd\n"</span>);
00290             abort();
00291             }
00292 
00293       <span class="keyword">struct </span>pollfd pfdi[ci];
00294       <span class="keyword">struct </span>pollfd pfdo[co];
00295       snd_seq_poll_descriptors(alsaSeq, pfdi, ci, POLLIN);
00296       snd_seq_poll_descriptors(alsaSeq, pfdo, co, POLLOUT);
00297       alsaSeqFdo = pfdo[0].fd;
00298       alsaSeqFdi = pfdi[0].fd;
00299 
00300       <span class="keywordtype">int</span> port  = snd_seq_create_simple_port(alsaSeq, <span class="stringliteral">"MuseScore Port 0"</span>,
00301          inCap | outCap | SND_SEQ_PORT_CAP_READ | SND_SEQ_PORT_CAP_WRITE,
00302          SND_SEQ_PORT_TYPE_APPLICATION);
00303       <span class="keywordflow">if</span> (port &lt; 0) {
00304             perror(<span class="stringliteral">"create port"</span>);
00305             exit(1);
00306             }
00307       musePort.port   = port;
00308       musePort.client = snd_seq_client_id(alsaSeq);
00309 
00310       <span class="comment">//-----------------------------------------</span>
00311       <span class="comment">//    subscribe to "Announce"</span>
00312       <span class="comment">//    this enables callbacks for any</span>
00313       <span class="comment">//    alsa port changes</span>
00314       <span class="comment">//-----------------------------------------</span>
00315 
00316       snd_seq_addr_t aadr;
00317       aadr.client = SND_SEQ_CLIENT_SYSTEM;
00318       aadr.port   = SND_SEQ_PORT_SYSTEM_ANNOUNCE;
00319 
00320       snd_seq_port_subscribe_t* subs;
00321       snd_seq_port_subscribe_alloca(&amp;subs);
00322       snd_seq_port_subscribe_set_dest(subs, &amp;musePort);
00323       snd_seq_port_subscribe_set_sender(subs, &amp;aadr);
00324       error = snd_seq_subscribe_port(alsaSeq, subs);
00325       <span class="keywordflow">if</span> (error &lt; 0) {
00326             printf(<span class="stringliteral">"Alsa: Subscribe System failed: %s"</span>, snd_strerror(error));
00327             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00328             }
00329 
00330       <span class="comment">// subscribe all devices for reading</span>
00331       <span class="keywordflow">for</span> (iMidiDevice i = midiDevices.begin(); i != midiDevices.end(); ++i) {
00332             MidiDevice* dev = *i;
00333             dev-&gt;openInput();
00334             }
00335 
00336       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00337       }
00338 
00339 <span class="comment">//---------------------------------------------------------</span>
00340 <span class="comment">//   midiReadEvent</span>
00341 <span class="comment">//---------------------------------------------------------</span>
00342 
00343 snd_seq_event* midiReadEvent()
00344       {
00345       snd_seq_event_t* ev;
00346       <span class="keywordtype">int</span> rv = snd_seq_event_input(alsaSeq, &amp;ev);
00347       <span class="keywordflow">if</span> (rv &lt; 0)
00348             <span class="keywordflow">return</span> 0;
00349       <span class="keywordflow">return</span> ev;
00350       }
00351 
00352 <span class="comment">//---------------------------------------------------------</span>
00353 <span class="comment">//   midiFreeEvent</span>
00354 <span class="comment">//---------------------------------------------------------</span>
00355 
00356 <span class="keywordtype">void</span> midiFreeEvent(snd_seq_event* ev)
00357       {
00358       snd_seq_free_event(ev);
00359       }
00360 
00361 <span class="comment">//---------------------------------------------------------</span>
00362 <span class="comment">//    readMidiEvent</span>
00363 <span class="comment">//---------------------------------------------------------</span>
00364 
00365 <span class="keywordtype">void</span> <a class="code" href="alsa_8cpp.html#a2">readMidiEvent</a>()
00366       {
00367       <span class="keyword">static</span> <span class="keywordtype">int</span> active;
00368       snd_seq_event_t* ev = midiReadEvent();
00369       <span class="keywordflow">if</span> (ev) {
00370             <span class="keywordflow">if</span> (ev-&gt;type == SND_SEQ_EVENT_NOTEON) {
00371 <span class="comment">//                  int channel = ev-&gt;data.note.channel;</span>
00372                   <span class="keywordtype">int</span> pitch   = ev-&gt;data.note.note;
00373                   <span class="keywordtype">int</span> velo    = ev-&gt;data.note.velocity;
00374                   <span class="keywordflow">if</span> (velo) {
00375 <span class="comment">//                        printf("note ON channel %2d pitch %3d  velo %3d\n",</span>
00376 <span class="comment">//                           channel, pitch, velo);</span>
00377                         <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a10">midiNoteReceived</a>(pitch, active);
00378                         ++active;
00379                         }
00380                   <span class="keywordflow">else</span>
00381                         --active;
00382                   }
00383             midiFreeEvent(ev);
00384             }
00385       }
00386 
00387 <span class="preprocessor">#else</span>
00388 <span class="preprocessor"></span><span class="comment">//</span>
00389 <span class="comment">// some dummy Routines</span>
00390 <span class="comment">//</span>
<a name="l00391"></a><a class="code" href="alsa_8h.html#a1">00391</a> <span class="keywordtype">bool</span> <a class="code" href="alsa_8cpp.html#a0">initMidi</a>()      { <span class="keywordflow">return</span> <span class="keyword">true</span>; }
<a name="l00392"></a><a class="code" href="alsa_8h.html#a2">00392</a> <span class="keywordtype">int</span> <a class="code" href="alsa_8cpp.html#a1">getMidiReadFd</a>()  { <span class="keywordflow">return</span> -1; }
<a name="l00393"></a><a class="code" href="alsa_8h.html#a3">00393</a> <span class="keywordtype">void</span> <a class="code" href="alsa_8cpp.html#a2">readMidiEvent</a>() {}
00394 
00395 <span class="preprocessor">#endif</span>
00396 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
