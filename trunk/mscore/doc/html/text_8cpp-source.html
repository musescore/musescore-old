<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: text.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>text.cpp</h1><a href="text_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: text.cpp,v 1.13 2005/06/27 19:50:39 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="globals_8h.html">globals.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="xml_8h.html">xml.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00017 
00018 <span class="comment">//---------------------------------------------------------</span>
00019 <span class="comment">//   init</span>
00020 <span class="comment">//---------------------------------------------------------</span>
00021 
<a name="l00022"></a><a class="code" href="classSText.html#d1">00022</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#d1">SText::init</a>()
00023       {
00024       <a class="code" href="classSText.html#r1">editMode</a> = <span class="keyword">false</span>;
00025       <span class="keywordflow">if</span> (_score-&gt;<a class="code" href="classScore.html#o0">textList</a>)
00026             _score-&gt;<a class="code" href="classScore.html#o0">textList</a>-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(<span class="keyword">this</span>);
00027       setNext(_score-&gt;<a class="code" href="classScore.html#o0">textList</a>);
00028       setPrev(0);
00029       _score-&gt;<a class="code" href="classScore.html#o0">textList</a> = <span class="keyword">this</span>;
00030       <a class="code" href="structTextStyle.html">TextStyle</a>* s = &amp;<a class="code" href="style_8cpp.html#a3">textStyles</a>[<a class="code" href="classSText.html#p0">textStyle</a>];
00031       <a class="code" href="classSText.html#r2">_off</a> = QPointF(s-&gt;<a class="code" href="structTextStyle.html#o8">xoff</a>, s-&gt;<a class="code" href="structTextStyle.html#o9">yoff</a>);
00032       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o10">offsetType</a> == <a class="code" href="style_8h.html#a44a18">OFFSET_SPATIUM</a>)
00033             <a class="code" href="classSText.html#r2">_off</a> *= _score-&gt;<a class="code" href="classScore.html#a114">spatium</a>();
00034       }
00035 
00036 <span class="comment">//---------------------------------------------------------</span>
00037 <span class="comment">//   SText</span>
00038 <span class="comment">//---------------------------------------------------------</span>
00039 
<a name="l00040"></a><a class="code" href="classSText.html#a0">00040</a> <a class="code" href="classSText.html#a0">SText::SText</a>(<a class="code" href="classScore.html">Score</a>* s)
00041    : <a class="code" href="classElement.html">Element</a>(s, <a class="code" href="element_8h.html#a65a8">TEXT</a>)
00042       {
00043       <a class="code" href="classSText.html#p0">textStyle</a> = <a class="code" href="style_8h.html#a45a25">TEXT_STYLE_LYRIC</a>;
00044       <a class="code" href="classSText.html#d1">init</a>();
00045       }
00046 
<a name="l00047"></a><a class="code" href="classSText.html#a1">00047</a> <a class="code" href="classSText.html#a0">SText::SText</a>(<a class="code" href="classScore.html">Score</a>* s, ElementType type, <span class="keywordtype">int</span> style)
00048    : <a class="code" href="classElement.html">Element</a>(s, type)
00049       {
00050       <a class="code" href="classSText.html#p0">textStyle</a> = <a class="code" href="style_8cpp.html#a1">style</a>;
00051       <a class="code" href="classSText.html#d1">init</a>();
00052       }
00053 
<a name="l00054"></a><a class="code" href="classSText.html#a2">00054</a> <a class="code" href="classSText.html#a0">SText::SText</a>(<span class="keyword">const</span> <a class="code" href="classSText.html">SText</a>&amp; s)
00055    : <a class="code" href="classElement.html">Element</a>(s), txt(s.txt), _off(s._off)
00056       {
00057       <a class="code" href="classSText.html#r1">editMode</a>     = s.<a class="code" href="classSText.html#r1">editMode</a>;
00058       <a class="code" href="classSText.html#p0">textStyle</a>    = s.<a class="code" href="classSText.html#p0">textStyle</a>;
00059       <a class="code" href="classSText.html#r3">cursorLine</a>   = s.<a class="code" href="classSText.html#r3">cursorLine</a>;
00060       <a class="code" href="classSText.html#r4">cursorColumn</a> = s.<a class="code" href="classSText.html#r4">cursorColumn</a>;
00061       }
00062 
<a name="l00063"></a><a class="code" href="classSText.html#a3">00063</a> <a class="code" href="classSText.html#a3">SText::~SText</a>()
00064       {
00065       <span class="keywordflow">if</span> (<span class="keyword">this</span> == _score-&gt;<a class="code" href="classScore.html#o0">textList</a>)
00066             _score-&gt;<a class="code" href="classScore.html#o0">textList</a> = <a class="code" href="classElement.html#a6">next</a>();
00067       <span class="keywordflow">else</span> {
00068             <span class="keywordflow">if</span> (<a class="code" href="classElement.html#a6">next</a>())
00069                   <a class="code" href="classElement.html#a6">next</a>()-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(<a class="code" href="classElement.html#a8">prev</a>());
00070             <a class="code" href="classElement.html#a8">prev</a>()-&gt;<a class="code" href="classElement.html#a7">setNext</a>(<a class="code" href="classElement.html#a6">next</a>());
00071             }
00072       }
00073 
00074 <span class="comment">//---------------------------------------------------------</span>
00075 <span class="comment">//   layout</span>
00076 <span class="comment">//---------------------------------------------------------</span>
00077 
<a name="l00078"></a><a class="code" href="classSText.html#a22">00078</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a22">SText::layout</a>()
00079       {
00080       <a class="code" href="structTextStyle.html">TextStyle</a>* s = &amp;<a class="code" href="style_8cpp.html#a3">textStyles</a>[<a class="code" href="classSText.html#p0">textStyle</a>];
00081       <a class="code" href="classSText.html#r2">_off</a> = QPointF(s-&gt;<a class="code" href="structTextStyle.html#o8">xoff</a>, s-&gt;<a class="code" href="structTextStyle.html#o9">yoff</a>);
00082       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o10">offsetType</a> == <a class="code" href="style_8h.html#a44a18">OFFSET_SPATIUM</a>)
00083             <a class="code" href="classSText.html#r2">_off</a> *= _score-&gt;<a class="code" href="classScore.html#a114">spatium</a>();
00084 
00085       <span class="keywordflow">if</span> (<a class="code" href="classElement.html#a10">parent</a>() == 0) {
00086 <span class="comment">//            printf("SText::layout: %p no parent\n", this);</span>
00087             <span class="keywordflow">return</span>;
00088             }
00089       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o7">anchor</a> == <a class="code" href="style_8h.html#a43a12">ANCHOR_PAGE</a>) {
00090             <a class="code" href="classPage.html">Page</a>* page = (<a class="code" href="classPage.html">Page</a>*)<a class="code" href="classElement.html#a10">parent</a>();
00091             <span class="keywordtype">double</span> w = page-&gt;<a class="code" href="classElement.html#a37">width</a>() - page-&gt;<a class="code" href="classPage.html#a12">lm</a>() - page-&gt;<a class="code" href="classPage.html#a13">rm</a>();
00092             <span class="keywordtype">double</span> h = page-&gt;<a class="code" href="classElement.html#a36">height</a>() - page-&gt;<a class="code" href="classPage.html#a10">tm</a>() - page-&gt;<a class="code" href="classPage.html#a11">bm</a>();
00093 
00094             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o10">offsetType</a> == <a class="code" href="style_8h.html#a44a17">OFFSET_REL</a>)
00095                   <a class="code" href="classSText.html#r2">_off</a> = QPointF(s-&gt;<a class="code" href="structTextStyle.html#o8">xoff</a> * w / 100.0, s-&gt;<a class="code" href="structTextStyle.html#o9">yoff</a> * h / 100.0);
00096 
00097             <span class="keywordtype">double</span> <a class="code" href="classSText.html#a7">x</a> = 0.0, <a class="code" href="classSText.html#a8">y</a> = 0.0;
00098             if (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a6">ALIGN_LEFT</a>)
00099                   <a class="code" href="classSText.html#a7">x</a> = page-&gt;<a class="code" href="classPage.html#a12">lm</a>();
00100             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a7">ALIGN_RIGHT</a>)
00101                   x  = page-&gt;<a class="code" href="classPage.html#a12">lm</a>() + w;
00102             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a8">ALIGN_HCENTER</a>)
00103                   x  = page-&gt;<a class="code" href="classPage.html#a12">lm</a>() + w/2.0;
00104             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a9">ALIGN_TOP</a>)
00105                   <a class="code" href="classSText.html#a8">y</a> = page-&gt;<a class="code" href="classPage.html#a10">tm</a>();
00106             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a10">ALIGN_BOTTOM</a>)
00107                   <a class="code" href="classSText.html#a8">y</a> = page-&gt;<a class="code" href="classPage.html#a10">tm</a>() + h;
00108             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a11">ALIGN_VCENTER</a>)
00109                   <a class="code" href="classSText.html#a8">y</a> = page-&gt;<a class="code" href="classPage.html#a10">tm</a>() + h/2;
00110             setpos(x, <a class="code" href="classSText.html#a8">y</a>);
00111             }
00112       <a class="code" href="classSText.html#d0">bboxUpdate</a>();
00113       }
00114 
00115 <span class="comment">//---------------------------------------------------------</span>
00116 <span class="comment">//   setText</span>
00117 <span class="comment">//---------------------------------------------------------</span>
00118 
<a name="l00119"></a><a class="code" href="classSText.html#a5">00119</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a5">SText::setText</a>(<span class="keyword">const</span> QString&amp; s)
00120       {
00121       <a class="code" href="classSText.html#r0">txt</a> = s;
00122       <a class="code" href="classSText.html#a22">layout</a>();
00123       <a class="code" href="classSText.html#d0">bboxUpdate</a>();
00124       }
00125 
00126 <span class="comment">//---------------------------------------------------------</span>
00127 <span class="comment">//   setStyle</span>
00128 <span class="comment">//---------------------------------------------------------</span>
00129 
<a name="l00130"></a><a class="code" href="classSText.html#a12">00130</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a12">SText::setStyle</a>(<span class="keywordtype">int</span> n)
00131       {
00132       <span class="keywordflow">if</span> (<a class="code" href="classSText.html#p0">textStyle</a> != n) {
00133             <a class="code" href="classSText.html#p0">textStyle</a> = n;
00134             <a class="code" href="classSText.html#a22">layout</a>();
00135             }
00136       }
00137 
00138 <span class="comment">//---------------------------------------------------------</span>
00139 <span class="comment">//   SText::write</span>
00140 <span class="comment">//---------------------------------------------------------</span>
00141 
<a name="l00142"></a><a class="code" href="classSText.html#a19">00142</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a19">SText::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00143 <span class="keyword">      </span>{
00144       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Text"</span>);
00145       xml.<a class="code" href="classXml.html#a16">strTag</a>(<span class="stringliteral">"data"</span>, <a class="code" href="classSText.html#r0">txt</a>);
00146       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"style"</span>, <a class="code" href="classSText.html#p0">textStyle</a>);
00147       Element::writeProperties(xml);
00148       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Text"</span>);
00149       }
00150 
00151 <span class="comment">//---------------------------------------------------------</span>
00152 <span class="comment">//   SText::write</span>
00153 <span class="comment">//---------------------------------------------------------</span>
00154 
<a name="l00155"></a><a class="code" href="classSText.html#a20">00155</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a19">SText::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml, <span class="keyword">const</span> <span class="keywordtype">char</span>* name)<span class="keyword"> const</span>
00156 <span class="keyword">      </span>{
00157       xml.<a class="code" href="classXml.html#a8">tag</a>(name);
00158       xml.<a class="code" href="classXml.html#a16">strTag</a>(<span class="stringliteral">"data"</span>, <a class="code" href="classSText.html#r0">txt</a>);
00159       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"style"</span>, <a class="code" href="classSText.html#p0">textStyle</a>);
00160       Element::writeProperties(xml);
00161       xml.<a class="code" href="classXml.html#a9">etag</a>(name);
00162       }
00163 
00164 <span class="comment">//---------------------------------------------------------</span>
00165 <span class="comment">//   SText::read</span>
00166 <span class="comment">//---------------------------------------------------------</span>
00167 
<a name="l00168"></a><a class="code" href="classSText.html#a21">00168</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a21">SText::read</a>(QDomNode node)
00169       {
00170       node = node.firstChild();
00171       <span class="keywordflow">while</span> (!node.isNull()) {
00172             QDomElement e = node.toElement();
00173             QString tag(e.tagName());
00174             QString val(e.text());
00175             <span class="keywordtype">int</span> i = val.toInt();
00176             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"data"</span>)
00177                   <a class="code" href="classSText.html#a5">setText</a>(val);
00178             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"style"</span>)
00179                   <a class="code" href="classSText.html#p0">textStyle</a> = i;
00180             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00181                   ;
00182             <span class="keywordflow">else</span>
00183                   printf(<span class="stringliteral">"Mscore:Text: unknown tag %s\n"</span>,
00184                      tag.latin1());
00185             node = node.nextSibling();
00186             }
00187       <a class="code" href="classSText.html#a22">layout</a>();
00188       }
00189 
00190 <span class="comment">//---------------------------------------------------------</span>
00191 <span class="comment">//   startEdit</span>
00192 <span class="comment">//---------------------------------------------------------</span>
00193 
<a name="l00194"></a><a class="code" href="classSText.html#a15">00194</a> <span class="keywordtype">bool</span> <a class="code" href="classSText.html#a15">SText::startEdit</a>()
00195       {
00196       <a class="code" href="classSText.html#r1">editMode</a>      = <span class="keyword">true</span>;
00197       QStringList l = QStringList::split(QString(<span class="stringliteral">"\n"</span>), <a class="code" href="classSText.html#r0">txt</a>, <span class="keyword">true</span>);
00198       <a class="code" href="classSText.html#r3">cursorLine</a>    = l.size() - 1;
00199       <a class="code" href="classSText.html#r4">cursorColumn</a>  = l[<a class="code" href="classSText.html#r3">cursorLine</a>].length();
00200       <a class="code" href="classSText.html#d0">bboxUpdate</a>();
00201       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00202       }
00203 
00204 <span class="comment">//---------------------------------------------------------</span>
00205 <span class="comment">//   edit</span>
00206 <span class="comment">//---------------------------------------------------------</span>
00207 
<a name="l00208"></a><a class="code" href="classSText.html#a16">00208</a> <span class="keywordtype">bool</span> <a class="code" href="classSText.html#a16">SText::edit</a>(QKeyEvent* ev)
00209       {
00210       QStringList l = QStringList::split(<span class="charliteral">'\n'</span>, <a class="code" href="classSText.html#r0">txt</a>, <span class="keyword">true</span>);
00211       <span class="keywordtype">int</span> lines     = l.size();
00212 
00213       <span class="keywordflow">switch</span> (ev-&gt;key()) {
00214             <span class="keywordflow">case</span> Qt::Key_Return:
00215                   {
00216                   QString s = l[<a class="code" href="classSText.html#r3">cursorLine</a>].mid(<a class="code" href="classSText.html#r4">cursorColumn</a>);
00217                   l[<a class="code" href="classSText.html#r3">cursorLine</a>].remove(<a class="code" href="classSText.html#r4">cursorColumn</a>, 10000); <span class="comment">// 0xffffffff does not work</span>
00218                   l.insert(<a class="code" href="classSText.html#r3">cursorLine</a>+1, s);
00219                   ++<a class="code" href="classSText.html#r3">cursorLine</a>;
00220                   <a class="code" href="classSText.html#r4">cursorColumn</a> = 0;
00221                   }
00222                   <span class="keywordflow">break</span>;
00223 
00224             <span class="keywordflow">case</span> Qt::Key_Backspace:
00225             <span class="keywordflow">case</span> Qt::Key_Delete:
00226                   <span class="keywordflow">if</span> (<a class="code" href="classSText.html#r4">cursorColumn</a> == 0) {
00227                         <span class="keywordflow">if</span> (<a class="code" href="classSText.html#r3">cursorLine</a> == 0)
00228                               <span class="keywordflow">break</span>;
00229                         --<a class="code" href="classSText.html#r3">cursorLine</a>;
00230                         <a class="code" href="classSText.html#r4">cursorColumn</a> = l[<a class="code" href="classSText.html#r3">cursorLine</a>].length();
00231                         l[<a class="code" href="classSText.html#r3">cursorLine</a>].append(l[<a class="code" href="classSText.html#r3">cursorLine</a>+1]);
00232                         l.remove(l.at(cursorLine+1));
00233                         <span class="keywordflow">break</span>;
00234                         }
00235                   l[<a class="code" href="classSText.html#r3">cursorLine</a>].remove(<a class="code" href="classSText.html#r4">cursorColumn</a>-1, 1);
00236                   --<a class="code" href="classSText.html#r4">cursorColumn</a>;
00237                   <span class="keywordflow">break</span>;
00238 
00239             <span class="keywordflow">case</span> Qt::Key_Left:
00240                   <span class="keywordflow">if</span> (--<a class="code" href="classSText.html#r4">cursorColumn</a> &lt; 0)
00241                         <a class="code" href="classSText.html#r4">cursorColumn</a> = 0;
00242                   <span class="keywordflow">break</span>;
00243 
00244             <span class="keywordflow">case</span> Qt::Key_Right:
00245                   <span class="keywordflow">if</span> (++<a class="code" href="classSText.html#r4">cursorColumn</a> &gt; int(l[<a class="code" href="classSText.html#r3">cursorLine</a>].length()))
00246                         <a class="code" href="classSText.html#r4">cursorColumn</a> = l[cursorLine].length();
00247                   <span class="keywordflow">break</span>;
00248 
00249             <span class="keywordflow">case</span> Qt::Key_Up:
00250                   <span class="keywordflow">if</span> (--cursorLine &lt; 0)
00251                         cursorLine = 0;
00252                   <span class="keywordflow">if</span> (<a class="code" href="classSText.html#r4">cursorColumn</a> &gt; int(l[cursorLine].length()))
00253                         <a class="code" href="classSText.html#r4">cursorColumn</a> = l[cursorLine].length();
00254                   <span class="keywordflow">break</span>;
00255 
00256             <span class="keywordflow">case</span> Qt::Key_Down:
00257                   <span class="keywordflow">if</span> (++cursorLine &gt;= lines)
00258                         cursorLine = lines-1;
00259                   <span class="keywordflow">if</span> (<a class="code" href="classSText.html#r4">cursorColumn</a> &gt; int(l[cursorLine].length()))
00260                         <a class="code" href="classSText.html#r4">cursorColumn</a> = l[cursorLine].length();
00261                   <span class="keywordflow">break</span>;
00262 
00263             <span class="keywordflow">default</span>:
00264                   <span class="keywordflow">if</span> (ev-&gt;text()[0].isPrint()) {
00265                         l[cursorLine].insert(<a class="code" href="classSText.html#r4">cursorColumn</a>, ev-&gt;text());
00266                         ++<a class="code" href="classSText.html#r4">cursorColumn</a>;
00267                         }
00268                   <span class="keywordflow">break</span>;
00269             }
00270       <a class="code" href="classSText.html#r0">txt</a> = l.join(QString(<span class="stringliteral">"\n"</span>));
00271       <a class="code" href="classSText.html#d0">bboxUpdate</a>();
00272       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00273       }
00274 
00275 <span class="comment">//---------------------------------------------------------</span>
00276 <span class="comment">//   endEdit</span>
00277 <span class="comment">//---------------------------------------------------------</span>
00278 
<a name="l00279"></a><a class="code" href="classSText.html#a17">00279</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a17">SText::endEdit</a>()
00280       {
00281       <a class="code" href="classSText.html#r1">editMode</a> = <span class="keyword">false</span>;
00282       <a class="code" href="classSText.html#d0">bboxUpdate</a>();
00283       }
00284 
00285 <span class="comment">//---------------------------------------------------------</span>
00286 <span class="comment">//   font</span>
00287 <span class="comment">//---------------------------------------------------------</span>
00288 
<a name="l00289"></a><a class="code" href="classSText.html#b0">00289</a> QFont <a class="code" href="classSText.html#b0">SText::font</a>()<span class="keyword"> const</span>
00290 <span class="keyword">      </span>{
00291       <a class="code" href="structTextStyle.html">TextStyle</a>* s = &amp;<a class="code" href="style_8cpp.html#a3">textStyles</a>[<a class="code" href="classSText.html#p0">textStyle</a>];
00292       QFont f;
00293       f.setFamily(s-&gt;<a class="code" href="structTextStyle.html#o1">family</a>);
00294       f.setItalic(s-&gt;<a class="code" href="structTextStyle.html#o4">italic</a>);
00295       f.setUnderline(s-&gt;<a class="code" href="structTextStyle.html#o5">underline</a>);
00296       f.setBold(s-&gt;<a class="code" href="structTextStyle.html#o3">bold</a>);
00297       f.setPixelSize(lrint(s-&gt;<a class="code" href="structTextStyle.html#o2">size</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a> / 5.0));
00298       <span class="keywordflow">return</span> f;
00299       }
00300 
00301 <span class="comment">//---------------------------------------------------------</span>
00302 <span class="comment">//   lineSpacing</span>
00303 <span class="comment">//---------------------------------------------------------</span>
00304 
<a name="l00305"></a><a class="code" href="classSText.html#a9">00305</a> <span class="keywordtype">double</span> <a class="code" href="classSText.html#a9">SText::lineSpacing</a>()<span class="keyword"> const</span>
00306 <span class="keyword">      </span>{
00307       QFontMetricsF fm(<a class="code" href="classSText.html#b0">font</a>());
00308       <span class="keywordflow">return</span> fm.lineSpacing();
00309       }
00310 
00311 <span class="comment">//---------------------------------------------------------</span>
00312 <span class="comment">//   bboxUpdate</span>
00313 <span class="comment">//---------------------------------------------------------</span>
00314 
<a name="l00315"></a><a class="code" href="classSText.html#d0">00315</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#d0">SText::bboxUpdate</a>()
00316       {
00317       <span class="keywordflow">if</span> (<a class="code" href="classSText.html#r0">txt</a>.isNull())
00318             <span class="keywordflow">return</span>;
00319       <a class="code" href="structTextStyle.html">TextStyle</a>* s = &amp;<a class="code" href="style_8cpp.html#a3">textStyles</a>[<a class="code" href="classSText.html#p0">textStyle</a>];
00320 
00321       QFontMetricsF fm(<a class="code" href="classSText.html#b0">font</a>());
00322 
00323       QStringList l = QStringList::split(<span class="charliteral">'\n'</span>, <a class="code" href="classSText.html#r0">txt</a>, <span class="keyword">true</span>);
00324       <span class="keywordtype">int</span> lines = l.size();
00325 
00326       <span class="keywordtype">double</span> <a class="code" href="classSText.html#a8">y</a> = 0;
00327       <span class="keywordtype">double</span> h = fm.height() * lines;
00328 
00329       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a9">ALIGN_TOP</a>)
00330             ;
00331       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a10">ALIGN_BOTTOM</a>)
00332             y -= h;
00333       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a11">ALIGN_VCENTER</a>)
00334             y -= h/2;
00335       <span class="keywordflow">else</span>
00336             y -= fm.ascent();
00337 
00338       QRectF r;
00339       <span class="keywordflow">for</span> (QStringList::Iterator i = l.begin(); i != l.end(); ++i) {
00340             QString str = *i;
00341             qreal w     = fm.width(str);
00342             QRectF rr   = fm.boundingRect(str);
00343 
00344             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a7">ALIGN_RIGHT</a>)
00345                   rr.translate(-w, 0);
00346             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a8">ALIGN_HCENTER</a>)
00347                   rr.translate(-w/2, 0);
00348             r |= rr;
00349             }
00350       <span class="keywordtype">double</span> ew = 0;
00351       <span class="keywordflow">if</span> (<a class="code" href="classSText.html#r1">editMode</a>)
00352             ew = fm.width(<span class="charliteral">' '</span>) + 1;
00353       _bbox = QRectF((r.x()-1) + <a class="code" href="classSText.html#r2">_off</a>.x(),
00354          y-1, (r.width() + ew + 2), h + 2);
00355       }
00356 
00357 <span class="comment">//---------------------------------------------------------</span>
00358 <span class="comment">//   SText::draw</span>
00359 <span class="comment">//---------------------------------------------------------</span>
00360 
<a name="l00361"></a><a class="code" href="classSText.html#a14">00361</a> <span class="keywordtype">void</span> <a class="code" href="classSText.html#a14">SText::draw1</a>(<a class="code" href="classPainter.html">Painter</a>&amp; p)<span class="keyword"> const</span>
00362 <span class="keyword">      </span>{
00363       <a class="code" href="structTextStyle.html">TextStyle</a>* s = &amp;<a class="code" href="style_8cpp.html#a3">textStyles</a>[<a class="code" href="classSText.html#p0">textStyle</a>];
00364       QFont nfont(<a class="code" href="classSText.html#b0">font</a>());
00365       p.setFont(nfont);
00366       QFontMetricsF fm(nfont);
00367 
00368       QPointF pp; <span class="comment">// (_off);</span>
00369       QStringList l = QStringList::split(<span class="charliteral">'\n'</span>, <a class="code" href="classSText.html#r0">txt</a>, <span class="keyword">true</span>);
00370 
00371       qreal ix  = pp.x();
00372       qreal iy  = pp.y();
00373       <span class="keywordtype">int</span> lines = l.size();
00374       qreal h   = fm.height() * lines;
00375 
00376       <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a9">ALIGN_TOP</a>)
00377             iy += fm.ascent();
00378       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a10">ALIGN_BOTTOM</a>)
00379             iy -= fm.descent();
00380       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a11">ALIGN_VCENTER</a>)
00381             iy += h/2 - fm.descent();
00382 
00383       qreal <a class="code" href="classSText.html#a8">y</a> = iy;
00384       <span class="keywordtype">int</span> line = 0;
00385       <span class="keywordflow">for</span> (QStringList::Iterator i = l.begin(); i != l.end(); ++i) {
00386             QString str(*i);
00387             qreal <a class="code" href="classSText.html#a7">x</a> = ix;
00388             qreal w = fm.width(str);
00389             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a7">ALIGN_RIGHT</a>)
00390                   x -= w;
00391             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structTextStyle.html#o6">align</a> &amp; <a class="code" href="style_8h.html#a42a8">ALIGN_HCENTER</a>)
00392                   x -= w/2;
00393             p.drawText(QPointF(x, y), str);
00394             <span class="keywordflow">if</span> (<a class="code" href="classSText.html#r1">editMode</a> &amp;&amp; <a class="code" href="classSText.html#r3">cursorLine</a> == line) {
00395                   qreal xx  = fm.width(str);
00396                   QChar c = (str.mid(<a class="code" href="classSText.html#r4">cursorColumn</a>, 1))[0];
00397                   <span class="keywordflow">if</span> (c.isNull())
00398                         c = <span class="charliteral">' '</span>;
00399                   p.drawRect(QRectF(x + xx + 1 + fm.leftBearing(c), y - fm.ascent()+1, fm.width(c)-2, fm.height()-2));
00400                   }
00401             y += fm.height();
00402             ++line;
00403 <span class="comment">//            if (debugMode &amp;&amp; isSelected())</span>
00404 <span class="comment">//                  p.drawMarker(pp); // draw reference point</span>
00405             }
00406       }
00407 
00408 <span class="comment">//---------------------------------------------------------</span>
00409 <span class="comment">//   Lyrics</span>
00410 <span class="comment">//---------------------------------------------------------</span>
00411 
<a name="l00412"></a><a class="code" href="classLyrics.html#a0">00412</a> <a class="code" href="classLyrics.html#a0">Lyrics::Lyrics</a>(<a class="code" href="classScore.html">Score</a>* s)
00413    : <a class="code" href="classSText.html">SText</a>(s, <a class="code" href="element_8h.html#a65a35">LYRICS</a>, <a class="code" href="style_8h.html#a45a25">TEXT_STYLE_LYRIC</a>)
00414       {
00415       <a class="code" href="classLyrics.html#r0">_no</a> = 0;
00416       }
00417 
<a name="l00418"></a><a class="code" href="classLyrics.html#a1">00418</a> <a class="code" href="classLyrics.html#a0">Lyrics::Lyrics</a>(<span class="keyword">const</span> <a class="code" href="classLyrics.html">Lyrics</a>&amp; l)
00419    : <a class="code" href="classSText.html">SText</a>(l)
00420       {
00421       <a class="code" href="classLyrics.html#r0">_no</a>       = l.<a class="code" href="classLyrics.html#r0">_no</a>;
00422       <a class="code" href="classLyrics.html#r1">_syllabic</a> = l.<a class="code" href="classLyrics.html#r1">_syllabic</a>;
00423       }
00424 
00425 <span class="comment">//---------------------------------------------------------</span>
00426 <span class="comment">//   write</span>
00427 <span class="comment">//---------------------------------------------------------</span>
00428 
<a name="l00429"></a><a class="code" href="classLyrics.html#a3">00429</a> <span class="keywordtype">void</span> <a class="code" href="classLyrics.html#a3">Lyrics::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00430 <span class="keyword">      </span>{
00431       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Lyrics"</span>);
00432       xml.<a class="code" href="classXml.html#a16">strTag</a>(<span class="stringliteral">"data"</span>, <a class="code" href="classSText.html#a11">text</a>());
00433       <span class="keywordflow">if</span> (<a class="code" href="classLyrics.html#r0">_no</a>)
00434             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"no"</span>, <a class="code" href="classLyrics.html#r0">_no</a>);
00435       Element::writeProperties(xml);
00436       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Lyrics"</span>);
00437       }
00438 
00439 <span class="comment">//---------------------------------------------------------</span>
00440 <span class="comment">//   read</span>
00441 <span class="comment">//---------------------------------------------------------</span>
00442 
<a name="l00443"></a><a class="code" href="classLyrics.html#a4">00443</a> <span class="keywordtype">void</span> <a class="code" href="classLyrics.html#a4">Lyrics::read</a>(QDomNode node)
00444       {
00445       QDomElement e = node.toElement();
00446       setTick(e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt());
00447 
00448       node = node.firstChild();
00449       <span class="keywordflow">while</span> (!node.isNull()) {
00450             QDomElement e = node.toElement();
00451             QString tag(e.tagName());
00452             QString val(e.text());
00453             <span class="keywordtype">int</span> i = val.toInt();
00454             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"data"</span>)
00455                   setText(val);
00456             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"no"</span>)
00457                   <a class="code" href="classLyrics.html#r0">_no</a> = i;
00458             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00459                   ;
00460             <span class="keywordflow">else</span>
00461                   printf(<span class="stringliteral">"Mscore:Lyrics: unknown tag %s\n"</span>,
00462                      tag.latin1());
00463             node = node.nextSibling();
00464             }
00465       }
00466 
00467 <span class="comment">//---------------------------------------------------------</span>
00468 <span class="comment">//   Fingering</span>
00469 <span class="comment">//---------------------------------------------------------</span>
00470 
<a name="l00471"></a><a class="code" href="classFingering.html#a0">00471</a> <a class="code" href="classFingering.html#a0">Fingering::Fingering</a>(<a class="code" href="classScore.html">Score</a>* s)
00472    : <a class="code" href="classSText.html">SText</a>(s, <a class="code" href="element_8h.html#a65a38">FINGERING</a>, <a class="code" href="style_8h.html#a45a26">TEXT_STYLE_FINGERING</a>)
00473       {
00474       }
00475 
00476 <span class="comment">//---------------------------------------------------------</span>
00477 <span class="comment">//   write</span>
00478 <span class="comment">//---------------------------------------------------------</span>
00479 
<a name="l00480"></a><a class="code" href="classFingering.html#a3">00480</a> <span class="keywordtype">void</span> <a class="code" href="classFingering.html#a3">Fingering::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00481 <span class="keyword">      </span>{
00482       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Fingering"</span>);
00483       xml.<a class="code" href="classXml.html#a16">strTag</a>(<span class="stringliteral">"data"</span>, <a class="code" href="classSText.html#a11">text</a>());
00484       Element::writeProperties(xml);
00485       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Fingering"</span>);
00486       }
00487 
00488 <span class="comment">//---------------------------------------------------------</span>
00489 <span class="comment">//   read</span>
00490 <span class="comment">//---------------------------------------------------------</span>
00491 
<a name="l00492"></a><a class="code" href="classFingering.html#a4">00492</a> <span class="keywordtype">void</span> <a class="code" href="classFingering.html#a4">Fingering::read</a>(QDomNode node)
00493       {
00494       node = node.firstChild();
00495       <span class="keywordflow">while</span> (!node.isNull()) {
00496             QDomElement e = node.toElement();
00497             QString tag(e.tagName());
00498             QString val(e.text());
00499             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"data"</span>)
00500                   setText(val);
00501             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Element::readProperties(node))
00502                   ;
00503             <span class="keywordflow">else</span>
00504                   printf(<span class="stringliteral">"Mscore:Fingering: unknown tag %s\n"</span>,
00505                      tag.latin1());
00506             node = node.nextSibling();
00507             }
00508       }
00509 
00510 <span class="comment">//---------------------------------------------------------</span>
00511 <span class="comment">//   InstrumentName1</span>
00512 <span class="comment">//---------------------------------------------------------</span>
00513 
<a name="l00514"></a><a class="code" href="classInstrumentName1.html#a0">00514</a> <a class="code" href="classInstrumentName1.html#a0">InstrumentName1::InstrumentName1</a>(<a class="code" href="classScore.html">Score</a>* s)
00515    : <a class="code" href="classSText.html">SText</a>(s, <a class="code" href="element_8h.html#a65a36">INSTRUMENT_NAME1</a>, <a class="code" href="style_8h.html#a45a27">TEXT_STYLE_INSTRUMENT_LONG</a>)
00516       {
00517       }
00518 
00519 <span class="comment">//---------------------------------------------------------</span>
00520 <span class="comment">//   InstrumentName2</span>
00521 <span class="comment">//---------------------------------------------------------</span>
00522 
<a name="l00523"></a><a class="code" href="classInstrumentName2.html#a0">00523</a> <a class="code" href="classInstrumentName2.html#a0">InstrumentName2::InstrumentName2</a>(<a class="code" href="classScore.html">Score</a>* s)
00524    : <a class="code" href="classSText.html">SText</a>(s, <a class="code" href="element_8h.html#a65a37">INSTRUMENT_NAME2</a>, <a class="code" href="style_8h.html#a45a28">TEXT_STYLE_INSTRUMENT_SHORT</a>)
00525       {
00526       }
00527 
00528 <span class="comment">//---------------------------------------------------------</span>
00529 <span class="comment">//   TempoText</span>
00530 <span class="comment">//---------------------------------------------------------</span>
00531 
<a name="l00532"></a><a class="code" href="classTempoText.html#a0">00532</a> <a class="code" href="classTempoText.html#a0">TempoText::TempoText</a>(<a class="code" href="classScore.html">Score</a>* s)
00533    : <a class="code" href="classSText.html">SText</a>(s, <a class="code" href="element_8h.html#a65a45">TEMPO_TEXT</a>, <a class="code" href="style_8h.html#a45a31">TEXT_STYLE_TEMPO</a>)
00534       {
00535       }
00536 
00537 <span class="comment">//---------------------------------------------------------</span>
00538 <span class="comment">//   pos</span>
00539 <span class="comment">//---------------------------------------------------------</span>
00540 
<a name="l00541"></a><a class="code" href="classSText.html#a6">00541</a> QPointF <a class="code" href="classSText.html#a6">SText::pos</a>()<span class="keyword"> const</span>
00542 <span class="keyword">      </span>{
00543       <span class="keywordflow">return</span> _pos + <a class="code" href="classSText.html#r2">_off</a> + _userOff * _score-&gt;<a class="code" href="classScore.html#a114">spatium</a>();
00544       }
00545 
<a name="l00546"></a><a class="code" href="classSText.html#a7">00546</a> <span class="keywordtype">double</span> <a class="code" href="classSText.html#a7">SText::x</a>()<span class="keyword"> const</span>
00547 <span class="keyword">      </span>{
00548       <span class="keywordflow">return</span> _pos.x() +<a class="code" href="classSText.html#r2">_off</a>.x() + _userOff.x() * _score-&gt;<a class="code" href="classScore.html#a114">spatium</a>();
00549       }
00550 
<a name="l00551"></a><a class="code" href="classSText.html#a8">00551</a> <span class="keywordtype">double</span> <a class="code" href="classSText.html#a8">SText::y</a>()<span class="keyword"> const</span>
00552 <span class="keyword">      </span>{
00553       <span class="keywordflow">return</span> _pos.y() + <a class="code" href="classSText.html#r2">_off</a>.x() + _userOff.y() * _score-&gt;<a class="code" href="classScore.html#a114">spatium</a>();
00554       }
00555 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:30 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
