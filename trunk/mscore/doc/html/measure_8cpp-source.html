<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: measure.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>measure.cpp</h1><a href="measure_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: measure.cpp,v 1.70 2005/06/26 09:17:49 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="xml_8h.html">xml.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="key_8h.html">key.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="dynamics_8h.html">dynamics.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="beam_8h.html">beam.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="tuplet_8h.html">tuplet.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="undo_8h.html">undo.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="hairpin_8h.html">hairpin.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="select_8h.html">select.h</a>"</span>
00026 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="part_8h.html">part.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00030 
00031 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="navigate_8h.html#a0">pitch2y</a>(<span class="keywordtype">int</span> pitch, <span class="keywordtype">int</span> enh, <span class="keywordtype">int</span> keyOffset, <span class="keywordtype">int</span> scale, <span class="keywordtype">int</span>&amp; prefix, <span class="keyword">const</span> <span class="keywordtype">char</span>* tversatz);
00032 
00033 <span class="comment">//---------------------------------------------------------</span>
00034 <span class="comment">//   Measure</span>
00035 <span class="comment">//---------------------------------------------------------</span>
00036 
<a name="l00037"></a><a class="code" href="classMeasure.html#a0">00037</a> <a class="code" href="classMeasure.html#a0">Measure::Measure</a>(<a class="code" href="classScore.html">Score</a>* s)
00038    : <a class="code" href="classElement.html">Element</a>(s, <a class="code" href="element_8h.html#a65a29">MEASURE</a>)
00039       {
00040       <a class="code" href="classMeasure.html#r0">_first</a> = 0;
00041       <a class="code" href="classMeasure.html#r1">_last</a>  = 0;
00042       <a class="code" href="classMeasure.html#r2">_size</a>  = 0;
00043 
00044       <span class="keywordtype">int</span> n = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00045       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; n; ++staff) {
00046             <a class="code" href="structMStaff.html">MStaff</a> s;
00047             s.<a class="code" href="structMStaff.html#o1">distance</a> = point(staff == 0 ? <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o4">systemDistance</a> : <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o2">staffDistance</a>);
00048             s.<a class="code" href="structMStaff.html#o2">userDistance</a> = 0.0;
00049             <a class="code" href="classMeasure.html#r3">staves</a>.push_back(s);
00050             }
00051 
00052       setTickLen(-1);
00053       <a class="code" href="classMeasure.html#r11">_userStretch</a> = 1.0;     <span class="comment">// ::style-&gt;measureSpacing;</span>
00054       <a class="code" href="classMeasure.html#r12">_lineBreak</a>   = <span class="keyword">false</span>;
00055       <a class="code" href="classMeasure.html#r13">_pageBreak</a>   = <span class="keyword">false</span>;
00056       <a class="code" href="classMeasure.html#r8">_no</a>          = 0;
00057       <a class="code" href="classMeasure.html#r14">_irregular</a>   = <span class="keyword">false</span>;
00058       <a class="code" href="classMeasure.html#r9">_noOffset</a>    = 0;
00059       <a class="code" href="classMeasure.html#r10">_noText</a>      = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a34">TEXT_STYLE_MEASURE_NUMBER</a>);
00060       <a class="code" href="classMeasure.html#r10">_noText</a>-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
00061       }
00062 
00063 <span class="comment">//---------------------------------------------------------</span>
00064 <span class="comment">//   Measure</span>
00065 <span class="comment">//---------------------------------------------------------</span>
00066 
<a name="l00067"></a><a class="code" href="classMeasure.html#a1">00067</a> <a class="code" href="classMeasure.html#a1">Measure::~Measure</a>()
00068       {
00069       <span class="keyword">delete</span> <a class="code" href="classMeasure.html#r10">_noText</a>;
00070       }
00071 
<a name="l00072"></a><a class="code" href="classMeasure.html#a2">00072</a> <a class="code" href="classMeasure.html#a0">Measure::Measure</a>(<span class="keyword">const</span> <a class="code" href="classMeasure.html">Measure</a>&amp; m)
00073    : <a class="code" href="classElement.html">Element</a>(m)
00074       {
00075       printf(<span class="stringliteral">"no clone measure !"</span>);
00076       abort();
00077       }
00078 
00079 <span class="comment">//---------------------------------------------------------</span>
00080 <span class="comment">//   insert</span>
00081 <span class="comment">//    insert e before el</span>
00082 <span class="comment">//---------------------------------------------------------</span>
00083 
<a name="l00084"></a><a class="code" href="classMeasure.html#a61">00084</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a61">Measure::insert</a>(<a class="code" href="classSegment.html">Segment</a>* e, <a class="code" href="classSegment.html">Segment</a>* el)
00085       {
00086       e-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
00087       <span class="keywordflow">if</span> (el == 0) {
00088             <a class="code" href="classMeasure.html#d0">push_back</a>(e);
00089             <span class="keywordflow">return</span>;
00090             }
00091       <span class="keywordflow">if</span> (el == <a class="code" href="classMeasure.html#r0">_first</a>) {
00092             <a class="code" href="classMeasure.html#d1">push_front</a>(e);
00093             <span class="keywordflow">return</span>;
00094             }
00095       ++<a class="code" href="classMeasure.html#r2">_size</a>;
00096       e-&gt;<a class="code" href="classElement.html#a7">setNext</a>(el);
00097       e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(el-&gt;<a class="code" href="classSegment.html#a5">prev</a>());
00098       el-&gt;<a class="code" href="classSegment.html#a5">prev</a>()-&gt;<a class="code" href="classElement.html#a7">setNext</a>(e);
00099       el-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(e);
00100       }
00101 
00102 <span class="comment">//---------------------------------------------------------</span>
00103 <span class="comment">//   dump</span>
00104 <span class="comment">//    debug only</span>
00105 <span class="comment">//---------------------------------------------------------</span>
00106 
<a name="l00107"></a><a class="code" href="classMeasure.html#a69">00107</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a69">Measure::dump</a>()<span class="keyword"> const</span>
00108 <span class="keyword">      </span>{
00109       printf(<span class="stringliteral">"dump measure:\n"</span>);
00110       }
00111 
00112 <span class="comment">//---------------------------------------------------------</span>
00113 <span class="comment">//   tickLen</span>
00114 <span class="comment">//---------------------------------------------------------</span>
00115 
<a name="l00116"></a><a class="code" href="classMeasure.html#a26">00116</a> <span class="keywordtype">int</span> <a class="code" href="classMeasure.html#a26">Measure::tickLen</a>()<span class="keyword"> const</span>
00117 <span class="keyword">      </span>{
00118       <span class="keywordflow">if</span> (<a class="code" href="classElement.html#a76">Element::tickLen</a>() == -1)
00119             _duration.<a class="code" href="classMTime.html#a4">setTick</a>(_score-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a9">ticksMeasure</a>(tick()));
00120       <span class="keywordflow">return</span> <a class="code" href="classElement.html#a76">Element::tickLen</a>();
00121       }
00122 
00123 <span class="comment">//---------------------------------------------------------</span>
00124 <span class="comment">//   remove</span>
00125 <span class="comment">//---------------------------------------------------------</span>
00126 
<a name="l00127"></a><a class="code" href="classMeasure.html#a30">00127</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a9">Measure::remove</a>(<a class="code" href="classSegment.html">Segment</a>* el)
00128       {
00129       --<a class="code" href="classMeasure.html#r2">_size</a>;
00130       <span class="keywordflow">if</span> (el == <a class="code" href="classMeasure.html#r0">_first</a>) {
00131             <a class="code" href="classMeasure.html#r0">_first</a> = <a class="code" href="classMeasure.html#r0">_first</a>-&gt;<a class="code" href="classSegment.html#a4">next</a>();
00132             <span class="keywordflow">if</span> (el == <a class="code" href="classMeasure.html#r1">_last</a>)
00133                   <a class="code" href="classMeasure.html#r1">_last</a> = 0;
00134             <span class="keywordflow">return</span>;
00135             }
00136       <span class="keywordflow">if</span> (el == <a class="code" href="classMeasure.html#r1">_last</a>) {
00137             <a class="code" href="classMeasure.html#r1">_last</a> = <a class="code" href="classMeasure.html#r1">_last</a>-&gt;<a class="code" href="classSegment.html#a5">prev</a>();
00138             <a class="code" href="classMeasure.html#r1">_last</a>-&gt;<a class="code" href="classElement.html#a7">setNext</a>(0);
00139             <span class="keywordflow">return</span>;
00140             }
00141       el-&gt;<a class="code" href="classSegment.html#a5">prev</a>()-&gt;<a class="code" href="classElement.html#a7">setNext</a>(el-&gt;<a class="code" href="classSegment.html#a4">next</a>());
00142       el-&gt;<a class="code" href="classSegment.html#a4">next</a>()-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(el-&gt;<a class="code" href="classSegment.html#a5">prev</a>());
00143       }
00144 
00145 <span class="comment">//---------------------------------------------------------</span>
00146 <span class="comment">//   push_back</span>
00147 <span class="comment">//---------------------------------------------------------</span>
00148 
<a name="l00149"></a><a class="code" href="classMeasure.html#d0">00149</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#d0">Measure::push_back</a>(<a class="code" href="classSegment.html">Segment</a>* e)
00150       {
00151       ++<a class="code" href="classMeasure.html#r2">_size</a>;
00152       e-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
00153       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r1">_last</a>) {
00154             <a class="code" href="classMeasure.html#r1">_last</a>-&gt;<a class="code" href="classElement.html#a7">setNext</a>(e);
00155             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(<a class="code" href="classMeasure.html#r1">_last</a>);
00156             e-&gt;<a class="code" href="classElement.html#a7">setNext</a>(0);
00157             }
00158       <span class="keywordflow">else</span> {
00159             <a class="code" href="classMeasure.html#r0">_first</a> = e;
00160             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(0);
00161             e-&gt;setNext(0);
00162             }
00163       <a class="code" href="classMeasure.html#r1">_last</a> = e;
00164       }
00165 
00166 <span class="comment">//---------------------------------------------------------</span>
00167 <span class="comment">//   push_front</span>
00168 <span class="comment">//---------------------------------------------------------</span>
00169 
<a name="l00170"></a><a class="code" href="classMeasure.html#d1">00170</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#d1">Measure::push_front</a>(<a class="code" href="classSegment.html">Segment</a>* e)
00171       {
00172       ++<a class="code" href="classMeasure.html#r2">_size</a>;
00173       e-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
00174       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r0">_first</a>) {
00175             <a class="code" href="classMeasure.html#r0">_first</a>-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(e);
00176             e-&gt;<a class="code" href="classElement.html#a7">setNext</a>(<a class="code" href="classMeasure.html#r0">_first</a>);
00177             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(0);
00178             }
00179       <span class="keywordflow">else</span> {
00180             <a class="code" href="classMeasure.html#r1">_last</a> = e;
00181             e-&gt;<a class="code" href="classElement.html#a9">setPrev</a>(0);
00182             e-&gt;setNext(0);
00183             }
00184       <a class="code" href="classMeasure.html#r0">_first</a> = e;
00185       }
00186 
00187 <span class="comment">//---------------------------------------------------------</span>
00188 <span class="comment">//   moveAll</span>
00189 <span class="comment">//---------------------------------------------------------</span>
00190 
<a name="l00191"></a><a class="code" href="classMeasure.html#a27">00191</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a27">Measure::moveAll</a>(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y)
00192       {
00193       move(x, y);
00194       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a7">iMStaff</a> ib = <a class="code" href="classMeasure.html#r3">staves</a>.begin(); ib != <a class="code" href="classMeasure.html#r3">staves</a>.end(); ++ib) {
00195             <span class="keywordflow">if</span> (ib-&gt;endBar)
00196                   ib-&gt;endBar-&gt;move(x, y);
00197             }
00198       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00199             (*i)-&gt;move(x, y);
00200 
00201       <span class="keywordtype">int</span> <a class="code" href="classMeasure.html#r3">staves</a> = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00202       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00203             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; staves * <a class="code" href="globals_8h.html#a3">VOICES</a>; ++track) {
00204                   segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track)-&gt;<a class="code" href="classElement.html#a25">move</a>(x, y);
00205                   <a class="code" href="segment_8h.html#a0">LyricsList</a>* ll = segment-&gt;<a class="code" href="classSegment.html#a11">lyricsList</a>(track);
00206                   <span class="keywordflow">for</span> (<a class="code" href="segment_8h.html#a1">iLyrics</a> il = ll-&gt;begin(); il != ll-&gt;end(); ++il)
00207                         (*il)-&gt;move(x, y);
00208                   }
00209             }
00210       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciBeam</a> i = <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00211             (*i)-&gt;move(x, y);
00212       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a5">ciTuplet</a> i = <a class="code" href="classMeasure.html#r5">_tupletList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r5">_tupletList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00213             (*i)-&gt;move(x, y);
00214       }
00215 
00216 <span class="comment">//---------------------------------------------------------</span>
00217 <span class="comment">//   findSelectableElement</span>
00218 <span class="comment">//    p is System relative</span>
00219 <span class="comment">//---------------------------------------------------------</span>
00220 
<a name="l00221"></a><a class="code" href="classMeasure.html#a57">00221</a> <a class="code" href="classElement.html">Element</a>* <a class="code" href="classMeasure.html#a57">Measure::findSelectableElement</a>(QPointF p)<span class="keyword"> const</span>
00222 <span class="keyword">      </span>{
00223       p -= <a class="code" href="classElement.html#a20">pos</a>();
00224       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00225             QPointF pp  = p - segment-&gt;<a class="code" href="classElement.html#a20">pos</a>();   <span class="comment">// segment relative</span>
00226             <span class="keywordtype">int</span> <a class="code" href="classMeasure.html#r3">staves</a> = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00227             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; staves; ++staff) {
00228                   <span class="keyword">const</span> <a class="code" href="segment_8h.html#a0">LyricsList</a>* ll = segment-&gt;<a class="code" href="classSegment.html#a11">lyricsList</a>(staff);
00229                   <span class="keywordflow">for</span> (<a class="code" href="segment_8h.html#a2">ciLyrics</a> i = ll-&gt;begin(); i != ll-&gt;end(); ++i) {
00230                         <span class="keywordflow">if</span> ((*i) &amp;&amp; (*i)-&gt;contains(pp)) {
00231                               <span class="keywordflow">return</span> *i;
00232                               }
00233                         }
00234                   }
00235             <span class="keywordtype">int</span> tracks = staves * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00236             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = 0; t &lt; tracks; ++t) {
00237                   <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(t);
00238                   <span class="keywordflow">if</span> (e == 0)
00239                         <span class="keywordflow">continue</span>;
00240                   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>) {
00241                         <a class="code" href="classElement.html">Element</a>* se = ((<a class="code" href="classChord.html">Chord</a>*)e)-&gt;findSelectableElement(pp);
00242                         <span class="keywordflow">if</span> (se)
00243                               <span class="keywordflow">return</span> se;
00244                         }
00245                   <span class="keywordflow">else</span> {
00246                         <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a30">contains</a>(pp))
00247                               <span class="keywordflow">return</span> e;
00248                         }
00249                   }
00250             }
00251       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00252             <span class="keywordflow">if</span> ((*i)-&gt;contains(p))
00253                   <span class="keywordflow">return</span> *i;
00254             }
00255       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a8">ciMStaff</a> is = <a class="code" href="classMeasure.html#r3">staves</a>.begin(); is != <a class="code" href="classMeasure.html#r3">staves</a>.end(); ++is) {
00256             <span class="keywordflow">if</span> (is-&gt;endBar &amp;&amp; is-&gt;endBar-&gt;contains(p))
00257                   <span class="keywordflow">return</span> is-&gt;endBar;
00258             }
00259       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r10">_noText</a>-&gt;<a class="code" href="classElement.html#a30">contains</a>(p))
00260             <span class="keywordflow">return</span> <a class="code" href="classMeasure.html#r10">_noText</a>;
00261       <span class="keywordflow">return</span> 0;
00262       }
00263 
00264 <span class="comment">//---------------------------------------------------------</span>
00265 <span class="comment">//   write</span>
00266 <span class="comment">//---------------------------------------------------------</span>
00267 
<a name="l00268"></a><a class="code" href="classMeasure.html#a6">00268</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a6">Measure::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml, <span class="keywordtype">int</span> no, <span class="keywordtype">int</span> staff)<span class="keyword"> const</span>
00269 <span class="keyword">      </span>{
00270       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Measure number=\"%d\" tick=\"%d\""</span>, no, <a class="code" href="classElement.html#a74">tick</a>());
00271 
00272       <span class="keywordflow">if</span> (staff == 0) {
00273             <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> ie = <a class="code" href="classMeasure.html#r6">_pel</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ie != <a class="code" href="classMeasure.html#r6">_pel</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ie) {
00274                   <a class="code" href="classElement.html">Element</a>* e = *ie;
00275                   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a8">TEXT</a>) {
00276                         <a class="code" href="classSText.html">SText</a>* t = (<a class="code" href="classSText.html">SText</a>*)e;
00277                         <span class="keywordflow">switch</span>(t-&gt;<a class="code" href="classSText.html#a13">style</a>()) {
00278                               <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a21">TEXT_STYLE_TITLE</a>:
00279                                     t-&gt;<a class="code" href="classSText.html#a19">write</a>(xml, <span class="stringliteral">"work-title"</span>);
00280                                     <span class="keywordflow">break</span>;
00281                               <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a22">TEXT_STYLE_SUBTITLE</a>:
00282                                     t-&gt;<a class="code" href="classSText.html#a19">write</a>(xml, <span class="stringliteral">"work-number"</span>);
00283                                     <span class="keywordflow">break</span>;
00284                               <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a23">TEXT_STYLE_COMPOSER</a>:
00285                                     t-&gt;<a class="code" href="classSText.html#a19">write</a>(xml, <span class="stringliteral">"creator-composer"</span>);
00286                                     <span class="keywordflow">break</span>;
00287                               <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a24">TEXT_STYLE_POET</a>:
00288                                     t-&gt;<a class="code" href="classSText.html#a19">write</a>(xml, <span class="stringliteral">"creator-poet"</span>);
00289                                     <span class="keywordflow">break</span>;
00290                               <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a37">TEXT_STYLE_TRANSLATOR</a>:
00291                                     t-&gt;<a class="code" href="classSText.html#a19">write</a>(xml, <span class="stringliteral">"creator-translator"</span>);
00292                                     <span class="keywordflow">break</span>;
00293                               <span class="keywordflow">default</span>:
00294                                     t-&gt;<a class="code" href="classSText.html#a19">write</a>(xml);
00295                               }
00296                         }
00297                   <span class="keywordflow">else</span>
00298                         (*ie)-&gt;write(xml);
00299                   }
00300             }
00301 
00302       <span class="keyword">const</span> <a class="code" href="structMStaff.html">MStaff</a>* ms = &amp;<a class="code" href="classMeasure.html#r3">staves</a>[staff];
00303       <span class="keywordflow">if</span> (ms-&gt;<a class="code" href="structMStaff.html#o0">endBar</a>)
00304             ms-&gt;<a class="code" href="structMStaff.html#o0">endBar</a>-&gt;<a class="code" href="classBar.html#a5">write</a>(xml);
00305       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r11">_userStretch</a> != 1.0)
00306             xml.<a class="code" href="classXml.html#a14">doubleTag</a>(<span class="stringliteral">"stretch"</span>, <a class="code" href="classMeasure.html#r11">_userStretch</a>);
00307       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r12">_lineBreak</a>)
00308             xml.<a class="code" href="classXml.html#a10">tagE</a>(<span class="stringliteral">"lineBreak"</span>);
00309       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r13">_pageBreak</a>)
00310             xml.<a class="code" href="classXml.html#a10">tagE</a>(<span class="stringliteral">"pageBreak"</span>);
00311       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00312             <span class="keywordflow">if</span> ((*i)-&gt;staff() == _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff))
00313                   (*i)-&gt;write(xml);
00314             }
00315       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = staff * <a class="code" href="globals_8h.html#a3">VOICES</a>; track &lt; staff * <a class="code" href="globals_8h.html#a3">VOICES</a> + <a class="code" href="globals_8h.html#a3">VOICES</a>; ++track) {
00316             <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00317                   <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00318                   <span class="keywordflow">if</span> (e &amp;&amp; !e-&gt;<a class="code" href="classElement.html#a18">generated</a>())
00319                         e-&gt;<a class="code" href="classElement.html#a47">write</a>(xml);
00320                   }
00321             }
00322       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00323             <span class="keyword">const</span> <a class="code" href="segment_8h.html#a0">LyricsList</a>* ll = segment-&gt;<a class="code" href="classSegment.html#a11">lyricsList</a>(staff);
00324             <span class="keywordflow">for</span> (<a class="code" href="segment_8h.html#a2">ciLyrics</a> i = ll-&gt;begin(); i != ll-&gt;end(); ++i) {
00325                   <span class="keywordflow">if</span> (*i)
00326                         (*i)-&gt;write(xml);
00327                   }
00328             }
00329       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Measure"</span>);
00330       }
00331 
00332 <span class="comment">//---------------------------------------------------------</span>
00333 <span class="comment">//   Measure::read</span>
00334 <span class="comment">//    read Measure</span>
00335 <span class="comment">//---------------------------------------------------------</span>
00336 
<a name="l00337"></a><a class="code" href="classMeasure.html#a5">00337</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a5">Measure::read</a>(QDomNode node, <span class="keywordtype">int</span> idx)
00338       {
00339       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n = <a class="code" href="classMeasure.html#r3">staves</a>.size(); n &lt;= idx; ++n) {
00340             <a class="code" href="structMStaff.html">MStaff</a> s;
00341             s.<a class="code" href="structMStaff.html#o1">distance</a> = point(n == 0 ? <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o4">systemDistance</a> : <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o2">staffDistance</a>);
00342             s.<a class="code" href="structMStaff.html#o2">userDistance</a> = 0.0;
00343             <a class="code" href="classMeasure.html#r3">staves</a>.push_back(s);
00344             }
00345 
00346       QDomElement e = node.toElement();
00347       setTick(e.attribute(<span class="stringliteral">"tick"</span>, <span class="stringliteral">"0"</span>).toInt());
00348 
00349       <a class="code" href="classStaff.html">Staff</a>* staff = _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(idx);
00350 
00351       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00352             QDomElement e = node.toElement();
00353             <span class="keywordflow">if</span> (e.isNull())
00354                   <span class="keywordflow">continue</span>;
00355             QString tag(e.tagName());
00356             QString val(e.text());
00357 
00358             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Bar"</span>) {
00359                   <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = <span class="keyword">new</span> <a class="code" href="classBar.html">Bar</a>(<a class="code" href="classElement.html#a4">score</a>());
00360                   bar-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
00361                   bar-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00362                   bar-&gt;<a class="code" href="classBar.html#a6">read</a>(node);
00363                   <span class="keywordflow">if</span> (bar-&gt;<a class="code" href="classBar.html#a3">barType</a>() == Bar::START_REPEAT)
00364                         <a class="code" href="classMeasure.html#a8">add</a>(bar);
00365                   <span class="keywordflow">else</span>
00366                         <a class="code" href="classMeasure.html#r3">staves</a>[idx].endBar = bar;
00367                   }
00368             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Chord"</span>) {
00369                   <a class="code" href="classChord.html">Chord</a>* chord = <span class="keyword">new</span> <a class="code" href="classChord.html">Chord</a>(<a class="code" href="classElement.html#a4">score</a>());
00370                   chord-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
00371                   chord-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00372                   chord-&gt;<a class="code" href="classChord.html#a6">read</a>(node, idx);
00373                   <a class="code" href="classMeasure.html#a8">add</a>(chord);
00374                   }
00375             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Rest"</span>) {
00376                   <a class="code" href="classRest.html">Rest</a>* rest = <span class="keyword">new</span> <a class="code" href="classRest.html">Rest</a>(<a class="code" href="classElement.html#a4">score</a>());
00377                   rest-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00378                   rest-&gt;<a class="code" href="classRest.html#a8">read</a>(node);
00379                   <a class="code" href="classMeasure.html#a8">add</a>(rest);
00380                   }
00381             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Clef"</span>) {
00382                   <a class="code" href="classClef.html">Clef</a>* clef = <span class="keyword">new</span> <a class="code" href="classClef.html">Clef</a>(<a class="code" href="classElement.html#a4">score</a>());
00383                   clef-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00384                   clef-&gt;<a class="code" href="classClef.html#a9">read</a>(node);
00385                   <a class="code" href="classMeasure.html#a8">add</a>(clef);
00386                   }
00387             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"TimeSig"</span>) {
00388                   <a class="code" href="classTimeSig.html">TimeSig</a>* ts = <span class="keyword">new</span> <a class="code" href="classTimeSig.html">TimeSig</a>(<a class="code" href="classElement.html#a4">score</a>());
00389                   ts-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00390                   ts-&gt;<a class="code" href="classTimeSig.html#a7">read</a>(node);
00391                   <a class="code" href="classMeasure.html#a8">add</a>(ts);
00392                   }
00393             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"KeySig"</span>) {
00394                   <a class="code" href="classKeySig.html">KeySig</a>* ks = <span class="keyword">new</span> <a class="code" href="classKeySig.html">KeySig</a>(<a class="code" href="classElement.html#a4">score</a>());
00395                   ks-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00396                   ks-&gt;<a class="code" href="classKeySig.html#a7">read</a>(node);
00397                   <a class="code" href="classMeasure.html#a8">add</a>(ks);
00398                   }
00399             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Dynamic"</span>) {
00400                   <a class="code" href="classDynamic.html">Dynamic</a>* dyn = <span class="keyword">new</span> <a class="code" href="classDynamic.html">Dynamic</a>(<a class="code" href="classElement.html#a4">score</a>());
00401                   dyn-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00402                   dyn-&gt;<a class="code" href="classDynamic.html#a9">read</a>(node);
00403                   <a class="code" href="classMeasure.html#a8">add</a>(dyn);
00404                   }
00405             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Slur"</span>) {
00406                   <a class="code" href="classSlur.html">Slur</a>* slur = <span class="keyword">new</span> <a class="code" href="classSlur.html">Slur</a>(<a class="code" href="classElement.html#a4">score</a>());
00407                   slur-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00408                   slur-&gt;<a class="code" href="classSlur.html#a5">read</a>(_score, node);
00409                   <a class="code" href="classMeasure.html#a8">add</a>(slur);
00410                   }
00411             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"HairPin"</span>) {
00412                   <a class="code" href="classHairpin.html">Hairpin</a>* hairpin = <span class="keyword">new</span> <a class="code" href="classHairpin.html">Hairpin</a>(<a class="code" href="classElement.html#a4">score</a>());
00413                   hairpin-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00414                   hairpin-&gt;<a class="code" href="classHairpin.html#a22">read</a>(node);
00415                   <a class="code" href="classMeasure.html#a8">add</a>(hairpin);
00416                   }
00417             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Lyrics"</span>) {
00418                   <a class="code" href="classLyrics.html">Lyrics</a>* lyrics = <span class="keyword">new</span> <a class="code" href="classLyrics.html">Lyrics</a>(<a class="code" href="classElement.html#a4">score</a>());
00419                   lyrics-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00420                   lyrics-&gt;<a class="code" href="classLyrics.html#a4">read</a>(node);
00421                   <a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a67">tick2segment</a>(lyrics-&gt;<a class="code" href="classElement.html#a74">tick</a>());
00422                   segment-&gt;<a class="code" href="classSegment.html#a22">add</a>(lyrics);
00423                   }
00424             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Text"</span>) {
00425                   <a class="code" href="classSText.html">SText</a>* t = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classElement.html#a4">score</a>());
00426                   t-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00427                   t-&gt;<a class="code" href="classSText.html#a21">read</a>(node);
00428                   <a class="code" href="classMeasure.html#a8">add</a>(t);
00429                   }
00430             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Symbol"</span>) {
00431                   <a class="code" href="classSymbol.html">Symbol</a>* sym = <span class="keyword">new</span> <a class="code" href="classSymbol.html">Symbol</a>(<a class="code" href="classElement.html#a4">score</a>());
00432                   sym-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
00433                   sym-&gt;<a class="code" href="classSymbol.html#a11">read</a>(node);
00434                   <a class="code" href="classMeasure.html#a8">add</a>(sym);
00435                   }
00436             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"stretch"</span>)
00437                   <a class="code" href="classMeasure.html#r11">_userStretch</a> = val.toDouble();
00438             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"lineBreak"</span>)
00439                   <a class="code" href="classMeasure.html#r12">_lineBreak</a> = <span class="keyword">true</span>;
00440             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"pageBreak"</span>)
00441                   <a class="code" href="classMeasure.html#r13">_pageBreak</a> = <span class="keyword">true</span>;
00442             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"work-title"</span>) {
00443                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a21">TEXT_STYLE_TITLE</a>);
00444                   text-&gt;<a class="code" href="classSText.html#a21">read</a>(node);
00445                   <a class="code" href="classMeasure.html#a8">add</a>(text);
00446                   }
00447             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"work-number"</span>) {
00448                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a22">TEXT_STYLE_SUBTITLE</a>);
00449                   text-&gt;<a class="code" href="classSText.html#a21">read</a>(node);
00450                   <a class="code" href="classMeasure.html#a8">add</a>(text);
00451                   }
00452             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"creator-composer"</span>) {
00453                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a23">TEXT_STYLE_COMPOSER</a>);
00454                   text-&gt;<a class="code" href="classSText.html#a21">read</a>(node);
00455                   <a class="code" href="classMeasure.html#a8">add</a>(text);
00456                   }
00457             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"creator-poet"</span>) {
00458                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a24">TEXT_STYLE_POET</a>);
00459                   text-&gt;<a class="code" href="classSText.html#a21">read</a>(node);
00460                   <a class="code" href="classMeasure.html#a8">add</a>(text);
00461                   }
00462             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"creator-translator"</span>) {
00463                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a37">TEXT_STYLE_TRANSLATOR</a>);
00464                   text-&gt;<a class="code" href="classSText.html#a21">read</a>(node);
00465                   <a class="code" href="classMeasure.html#a8">add</a>(text);
00466                   }
00467             <span class="keywordflow">else</span>
00468                   printf(<span class="stringliteral">"Mscore:Measure: unknown tag %s\n"</span>,
00469                      tag.latin1());
00470             }
00471 
00472       <a class="code" href="classMeasure.html#a59">layoutNoteHeads</a>(idx);
00473       }
00474 
00475 <span class="comment">//---------------------------------------------------------</span>
00476 <span class="comment">//   layoutNoteHeads</span>
00477 <span class="comment">//    set line &amp; prefix &amp; mirror for notes depending</span>
00478 <span class="comment">//    on context</span>
00479 <span class="comment">//---------------------------------------------------------</span>
00480 
<a name="l00481"></a><a class="code" href="classMeasure.html#a59">00481</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a59">Measure::layoutNoteHeads</a>(<span class="keywordtype">int</span> staff)
00482       {
00483       <span class="keywordtype">char</span> tversatz[75];
00484       memset(tversatz, 0, <span class="keyword">sizeof</span>(tversatz));
00485       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00486             <span class="keywordtype">int</span> startTrack = staff * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00487             <span class="keywordtype">int</span> endTrack   = startTrack + <a class="code" href="globals_8h.html#a3">VOICES</a>;
00488             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = startTrack; track &lt; endTrack; ++track) {
00489                   <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00490                   <span class="keywordflow">if</span> (e == 0 || e-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00491                         <span class="keywordflow">continue</span>;
00492                   <a class="code" href="classNoteList.html">NoteList</a>* nl = ((<a class="code" href="classChord.html">Chord</a>*)e)-&gt;noteList();
00493                   <span class="keywordtype">bool</span> mirror  = <span class="keyword">false</span>;   <span class="comment">// start with head left from stem</span>
00494                   <span class="keywordtype">int</span> tick     = ((<a class="code" href="classChord.html">Chord</a>*)e)-&gt;tick();
00495                   <span class="keywordtype">int</span> ll       = 1000;    <span class="comment">// make sure first head is not mirrored</span>
00496                   <span class="keywordtype">int</span> move1    = nl-&gt;<a class="code" href="classNoteList.html#a1">front</a>()-&gt;<a class="code" href="classNote.html#a18">move</a>();
00497 
00498                   <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a1">iNote</a> in = nl-&gt;begin(); in != nl-&gt;end(); ++in) {
00499                         <a class="code" href="classNote.html">Note</a>* note  = in-&gt;second;
00500                         <span class="keywordtype">int</span> pitch   = note-&gt;<a class="code" href="classNote.html#a15">pitch</a>();
00501                         <span class="keywordtype">int</span> move    = note-&gt;<a class="code" href="classNote.html#a18">move</a>();
00502                         <a class="code" href="classStaff.html">Staff</a>* staffp = _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff+move);
00503                         <span class="keywordtype">int</span> offset  = <a class="code" href="clef_8h.html#a0">clefTable</a>[staffp-&gt;<a class="code" href="classStaff.html#a2">clef</a>()-&gt;<a class="code" href="classClefList.html#a1">clef</a>(tick)].<a class="code" href="structClefInfo.html#o2">yOffset</a>;
00504                         <span class="keywordtype">int</span> userAcc = note-&gt;<a class="code" href="classNote.html#a20">userAccidental</a>();
00505                         <span class="keywordtype">int</span> key     = _score-&gt;<a class="code" href="classScore.html#o10">keymap</a>-&gt;<a class="code" href="classKeyList.html#a1">key</a>(tick);
00506                         <span class="keywordtype">int</span> prefix;
00507                         <span class="keywordtype">int</span> line = ::pitch2y(pitch, userAcc, offset, key, prefix, tversatz);
00508                         note-&gt;<a class="code" href="classNote.html#a27">setLine</a>(line);
00509                         <span class="keywordflow">if</span> (prefix) {
00510                               <span class="keywordtype">int</span> l1       = 45 - line + offset;
00511                               tversatz[l1] = prefix;
00512                               }
00513                         <span class="keywordflow">if</span> (mirror || (((ll - line) &lt; 2) &amp;&amp; move1 == move)) {
00514                               mirror = !mirror;
00515                               }
00516                         move1 = move;
00517                         note-&gt;<a class="code" href="classNote.html#a32">setMirror</a>(mirror);
00518                         note-&gt;<a class="code" href="classNote.html#a24">setAccidental</a>(userAcc == -1 ? prefix : userAcc);
00519                         ll = line;
00520                         }
00521                   }
00522             }
00523       }
00524 
00525 <span class="comment">//---------------------------------------------------------</span>
00526 <span class="comment">//   Measure::layout</span>
00527 <span class="comment">//    layout measure; must fit into "width"</span>
00528 <span class="comment">//    minWidth = width - stretch;</span>
00529 <span class="comment">//---------------------------------------------------------</span>
00530 
<a name="l00531"></a><a class="code" href="classMeasure.html#a46">00531</a> <span class="keywordtype">void</span> <a class="code" href="classElement.html#a66">Measure::layout</a>(<span class="keywordtype">double</span> width)
00532       {
00533       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#a28">first</a>() == 0)
00534             <span class="keywordflow">return</span>;
00535 
00536       <span class="keywordtype">int</span> n = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00537       <span class="keywordtype">double</span> staffY[n];
00538       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n; ++i) {
00539             staffY[i] = <a class="code" href="classMeasure.html#a40">system</a>()-&gt;<a class="code" href="classSystem.html#a13">staff</a>(i)-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y();
00540             }
00541       _bbox = QRectF(0, 0, width, <a class="code" href="classMeasure.html#a40">system</a>()-&gt;<a class="code" href="classElement.html#a36">height</a>());
00542 
00543       <a class="code" href="classMeasure.html#a45">layoutX</a>(width);
00544 
00545       <span class="comment">//---------------------------------------------------</span>
00546       <span class="comment">//    layout bars</span>
00547       <span class="comment">//---------------------------------------------------</span>
00548 
00549       <a class="code" href="classPartList.html">PartList</a>* pl = _score-&gt;<a class="code" href="classScore.html#a109">parts</a>();
00550       <span class="keywordtype">double</span> x  = width;
00551       <span class="keywordtype">int</span> staff = 0;
00552       <a class="code" href="classSpatium.html">Spatium</a> barLen(4);
00553       barLen += ::style-&gt;staffLineWidth;
00554       <span class="keywordflow">for</span> (<a class="code" href="part_8h.html#a0">iPart</a> ip = pl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != pl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
00555             <a class="code" href="classPart.html">Part</a>* p = *ip;
00556             <a class="code" href="structMStaff.html">MStaff</a>* ms = &amp;<a class="code" href="classMeasure.html#r3">staves</a>[staff];
00557             <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = ms-&gt;<a class="code" href="structMStaff.html#o0">endBar</a>;
00558             <span class="keywordflow">if</span> (bar) {
00559                   <span class="keywordtype">double</span> y1 = staffY[staff];
00560                   <span class="keywordtype">double</span> y2 = staffY[staff + p-&gt;<a class="code" href="classPart.html#a4">nstaves</a>() - 1] + point(barLen);
00561                   bar-&gt;<a class="code" href="classElement.html#a39">setHeight</a>(y2 - y1);
00562                   bar-&gt;<a class="code" href="classElement.html#a23">setpos</a>(x - bar-&gt;<a class="code" href="classElement.html#a37">width</a>(), y1 - point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o24">staffLineWidth</a>) * .5);
00563                   }
00564             staff += p-&gt;<a class="code" href="classPart.html#a4">nstaves</a>();
00565             }
00566 
00567 <span class="preprocessor">#if 0</span>
00568 <span class="preprocessor"></span>      <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a7">iMStaff</a> is = <a class="code" href="classMeasure.html#r3">staves</a>.begin(); is != <a class="code" href="classMeasure.html#r3">staves</a>.end(); ++is, ++staff) {
00569             <span class="keywordtype">double</span> y = staffY[staff];
00570             <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = is-&gt;endBar;
00571             <span class="keywordflow">if</span> (bar) {
00572                   <span class="keywordtype">bool</span> split = _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff)-&gt;isTopSplit();
00573                   <a class="code" href="classSpatium.html">Spatium</a> barLen(4);
00574                   barLen += ::style-&gt;staffLineWidth;
00575                   <span class="keywordflow">if</span> (split)
00576                         barLen += spatium(staffY[staff+1] - y);
00577                   bar-&gt;<a class="code" href="classElement.html#a39">setHeight</a>(point(barLen));
00578                   bar-&gt;<a class="code" href="classElement.html#a23">setpos</a>(x - bar-&gt;<a class="code" href="classElement.html#a37">width</a>(), y - point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o24">staffLineWidth</a>) * .5);
00579                   }
00580             }
00581 <span class="preprocessor">#endif</span>
00582 <span class="preprocessor"></span>
00583       <span class="comment">//---------------------------------------------------</span>
00584       <span class="comment">//   layout Chords/Lyrics/Symbols/BeginRepeatBar</span>
00585       <span class="comment">//---------------------------------------------------</span>
00586 
00587       <span class="keywordtype">int</span> st = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00588       <span class="keywordtype">int</span> tracks = st * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00589       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00590             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00591                   <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00592                   <span class="keywordflow">if</span> (e == 0)
00593                         <span class="keywordflow">continue</span>;
00594                   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00595                         ((<a class="code" href="classChord.html">Chord</a>*)(e))-&gt;layout(-1);
00596                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a13">BAR</a>) {
00597                         <span class="comment">//</span>
00598                         <span class="comment">// must be begin repeat bar</span>
00599                         <span class="comment">//</span>
00600                         <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = (<a class="code" href="classBar.html">Bar</a>*)e;
00601                         <span class="keywordtype">int</span> staff = track / <a class="code" href="globals_8h.html#a3">VOICES</a>;
00602                         <span class="keywordtype">double</span> y = staffY[staff];
00603                         <span class="keywordtype">bool</span> split = _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff)-&gt;isTopSplit();
00604                         <a class="code" href="classSpatium.html">Spatium</a> barLen(4);
00605                         barLen += ::style-&gt;staffLineWidth;
00606                         <span class="keywordflow">if</span> (split)
00607                               barLen += spatium(staffY[staff+1] - y);
00608                         bar-&gt;<a class="code" href="classElement.html#a39">setHeight</a>(point(barLen));
00609                         bar-&gt;<a class="code" href="classElement.html#a23">setpos</a>(bar-&gt;<a class="code" href="classElement.html#a20">pos</a>().x(), y - point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o24">staffLineWidth</a>) * .5);
00610                         }
00611                   }
00612             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; st; ++staff) {
00613                   <a class="code" href="segment_8h.html#a0">LyricsList</a>* ll = segment-&gt;<a class="code" href="classSegment.html#a11">lyricsList</a>(staff);
00614                   <span class="keywordtype">int</span> line = 0;
00615                   <span class="keywordflow">for</span> (<a class="code" href="segment_8h.html#a1">iLyrics</a> i = ll-&gt;begin(); i != ll-&gt;end(); ++i, ++line) {
00616                         <a class="code" href="classLyrics.html">Lyrics</a>* lyrics = *i;
00617                         <span class="keywordflow">if</span> (lyrics == 0)
00618                               <span class="keywordflow">continue</span>;
00619                         <span class="comment">// center to middle of notehead:</span>
00620                         <span class="keywordtype">double</span> noteHeadWidth = <a class="code" href="symbols_8cpp.html#a35">quartheadSym</a>.<a class="code" href="structSym.html#a4">width</a>();
00621                         <span class="keywordtype">double</span> lh = lyrics-&gt;<a class="code" href="classSText.html#a9">lineSpacing</a>();
00622                         <span class="keywordtype">double</span> y = lh * line;
00623                         <span class="comment">// lyrics-&gt;setpos(segment-&gt;x() + noteHeadWidth/2, y);</span>
00624                         lyrics-&gt;<a class="code" href="classElement.html#a23">setpos</a>(noteHeadWidth/2, y);
00625                         y += <a class="code" href="spatium_8h.html#a0">_spatium</a> * 6;
00626                         <span class="keywordflow">if</span> ((staff+1) &lt; st) {
00627                               <span class="keywordflow">if</span> (y &gt; <a class="code" href="classMeasure.html#r3">staves</a>[staff+1].distance) {
00628                                     staves[staff+1].distance = y;
00629                                     }
00630                               }
00631                         }
00632                   }
00633             }
00634 
00635       <span class="comment">//---------------------------------------------------</span>
00636       <span class="comment">//    layout beams and tuplets</span>
00637       <span class="comment">//---------------------------------------------------</span>
00638 
00639       <a class="code" href="classMeasure.html#a58">layoutBeams</a>();
00640       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a4">iTuplet</a> i = <a class="code" href="classMeasure.html#r5">_tupletList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r5">_tupletList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00641             (*i)-&gt;layout();
00642 
00643 <span class="preprocessor">#if 0  // adjust topDistance, bottomDistance</span>
00644 <span class="preprocessor"></span>      <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">iBeam</a> ib = <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ib != <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ib) {
00645             <a class="code" href="classBeam.html">Beam</a>* b = *ib;
00646 
00647             <span class="keywordtype">double</span> y1 = b-&gt;<a class="code" href="classElement.html#a33">bbox</a>().y();
00648             <span class="keywordtype">double</span> y2 = y1 + b-&gt;<a class="code" href="classElement.html#a33">bbox</a>().height();
00649             }
00650 <span class="preprocessor">#endif</span>
00651 <span class="preprocessor"></span>      }
00652 
00653 <span class="comment">//---------------------------------------------------------</span>
00654 <span class="comment">//   tick2pos</span>
00655 <span class="comment">//---------------------------------------------------------</span>
00656 
<a name="l00657"></a><a class="code" href="classMeasure.html#a66">00657</a> <span class="keywordtype">double</span> <a class="code" href="classMeasure.html#a66">Measure::tick2pos</a>(<span class="keywordtype">int</span> tck)<span class="keyword"> const</span>
00658 <span class="keyword">      </span>{
00659       <a class="code" href="classSegment.html">Segment</a>* s;
00660       <span class="keywordtype">double</span> x1 = 0;
00661       <span class="keywordtype">double</span> x2 = 0;
00662       <span class="keywordtype">int</span> tick1 = <a class="code" href="classElement.html#a74">tick</a>();
00663       <span class="keywordtype">int</span> tick2 = tick1;
00664       <span class="keywordflow">for</span> (s = <a class="code" href="classMeasure.html#r0">_first</a>; s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00665             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a18">type</a>() != Segment::SegChordRest)
00666                   <span class="keywordflow">continue</span>;
00667             x2 = s-&gt;<a class="code" href="classSegment.html#a15">x</a>();
00668             tick2 = s-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00669             <span class="keywordflow">if</span> (tck &lt;= tick2) {
00670                   <span class="keywordflow">if</span> (tck == tick2)
00671                         x1 = x2;
00672                   <span class="keywordflow">break</span>;
00673                   }
00674             x1    = x2;
00675             tick1 = tick2;
00676             }
00677       <span class="keywordflow">if</span> (s == 0) {
00678             x2    = <a class="code" href="classElement.html#a37">width</a>();
00679             tick2 = <a class="code" href="classElement.html#a74">tick</a>() + _score-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a9">ticksMeasure</a>(<a class="code" href="classElement.html#a74">tick</a>());
00680             }
00681       <span class="keywordtype">double</span> x = 0;
00682       <span class="keywordflow">if</span> (tick2 &gt; tick1) {
00683             <span class="keywordtype">double</span> dx = x2 - x1;
00684             <span class="keywordtype">int</span> dt    = tick2 - tick1;
00685             <span class="keywordflow">if</span> (dt == 0)
00686                   x = 0.0;
00687             <span class="keywordflow">else</span>
00688                   x = dx * (tck - tick1) / dt;
00689             }
00690       <span class="keywordflow">return</span> x1 + x;
00691       }
00692 
00693 <span class="comment">//---------------------------------------------------------</span>
00694 <span class="comment">//   layout2</span>
00695 <span class="comment">//---------------------------------------------------------</span>
00696 
<a name="l00697"></a><a class="code" href="classMeasure.html#a48">00697</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a48">Measure::layout2</a>()
00698       {
00699       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> pe = <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); pe != <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++pe) {
00700             <a class="code" href="classElement.html">Element</a>* <a class="code" href="classMeasure.html#a13">pel</a> = *pe;
00701             <span class="keywordtype">int</span> staff = _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(pel-&gt;<a class="code" href="classElement.html#a59">staff</a>());
00702             <span class="keywordtype">double</span> y  = staff * point(<a class="code" href="classSpatium.html">Spatium</a>(4) + <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o2">staffDistance</a>);
00703 
00704             pel-&gt;<a class="code" href="classElement.html#a66">layout</a>();
00705             <span class="keywordflow">switch</span>(pel-&gt;<a class="code" href="classElement.html#a40">type</a>()) {
00706                   <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a31">DYNAMIC</a>:
00707                   <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a7">SYMBOL</a>:
00708                   <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a8">TEXT</a>:
00709                   <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a45">TEMPO_TEXT</a>:
00710                         {
00711                         <span class="keywordtype">double</span> x = <a class="code" href="classMeasure.html#a66">tick2pos</a>(pel-&gt;<a class="code" href="classElement.html#a74">tick</a>());
00712                         pel-&gt;<a class="code" href="classElement.html#a23">setpos</a>(x, y);
00713                         }
00714                         <span class="keywordflow">break</span>;
00715                   <span class="keywordflow">default</span>:
00716                         <span class="keywordflow">break</span>;
00717                   }
00718 
00719             }
00720 
00721       <span class="comment">//</span>
00722       <span class="comment">//   set measure number</span>
00723       <span class="comment">//</span>
00724       <span class="keywordtype">int</span> pn = <a class="code" href="classMeasure.html#r8">_no</a> + <a class="code" href="classMeasure.html#r9">_noOffset</a>;
00725       QString s(<span class="stringliteral">"%1"</span>);
00726       s = s.arg(pn + 1);
00727 
00728       QString ns;
00729       <span class="keywordflow">if</span> (::style-&gt;showMeasureNumber
00730          &amp;&amp; !<a class="code" href="classMeasure.html#r14">_irregular</a>
00731          &amp;&amp; (pn || ::style-&gt;showMeasureNumberOne)) {
00732             <span class="keywordflow">if</span> (::style-&gt;measureNumberSystem) {
00733                   <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#a40">system</a>()-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a12">front</a>() == <span class="keyword">this</span>)
00734                         ns = s;
00735                   }
00736             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pn % ::style-&gt;measureNumberInterval) == 0)
00737                   ns = s;
00738             }
00739       <a class="code" href="classMeasure.html#r10">_noText</a>-&gt;<a class="code" href="classSText.html#a5">setText</a>(ns);
00740 
00741       <span class="keywordtype">int</span> tracks = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>() * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00742       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00743             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00744                   <a class="code" href="classElement.html">Element</a>* <a class="code" href="classMeasure.html#a42">el</a> = s-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00745                   <span class="keywordflow">if</span> (el &amp;&amp; (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>)) {
00746                         <a class="code" href="classChord.html">Chord</a>* a = (<a class="code" href="classChord.html">Chord</a>*)el;
00747                         <span class="keyword">const</span> <a class="code" href="classNoteList.html">NoteList</a>* nl = a-&gt;<a class="code" href="classChord.html#a15">noteList</a>();
00748                         <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a3">ciNote</a> in = nl-&gt;begin(); in != nl-&gt;end(); ++in) {
00749                               <a class="code" href="classTie.html">Tie</a>* tie = in-&gt;second-&gt;tieFor();
00750                               <span class="keywordflow">if</span> (tie) {
00751                                     tie-&gt;<a class="code" href="classTie.html#a9">layout</a>();
00752                                     in-&gt;second-&gt;bboxUpdate();
00753                                     }
00754                               }
00755                         }
00756                   }
00757             }
00758       }
00759 
00760 <span class="comment">//---------------------------------------------------------</span>
00761 <span class="comment">//   findChord</span>
00762 <span class="comment">//    search for chord at tick position</span>
00763 <span class="comment">//---------------------------------------------------------</span>
00764 
<a name="l00765"></a><a class="code" href="classMeasure.html#a49">00765</a> <a class="code" href="classChord.html">Chord</a>* <a class="code" href="classMeasure.html#a49">Measure::findChord</a>(<span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> staff, <span class="keywordtype">int</span> voice, <span class="keywordtype">bool</span> <span class="comment">/*grace*/</span>)
00766       {
00767       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = <a class="code" href="classMeasure.html#r0">_first</a>; seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00768             <span class="keywordflow">if</span> (seg-&gt;<a class="code" href="classElement.html#a74">tick</a>() &gt; tick)
00769                   <span class="keywordflow">return</span> 0;
00770             <span class="keywordflow">if</span> (seg-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick) {
00771                   <a class="code" href="classElement.html">Element</a>* <a class="code" href="classMeasure.html#a42">el</a> = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(staff * <a class="code" href="globals_8h.html#a3">VOICES</a> + voice);
00772                   <span class="keywordflow">if</span> (el &amp;&amp; el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>) {
00773                         <span class="keywordflow">return</span> (<a class="code" href="classChord.html">Chord</a>*)el;
00774                         }
00775                   }
00776             }
00777       <span class="keywordflow">return</span> 0;
00778       }
00779 
00780 <span class="comment">//---------------------------------------------------------</span>
00781 <span class="comment">//   findChordRest</span>
00782 <span class="comment">//    search for chord/Rest at tick position</span>
00783 <span class="comment">//---------------------------------------------------------</span>
00784 
<a name="l00785"></a><a class="code" href="classMeasure.html#a50">00785</a> <a class="code" href="classChordRest.html">ChordRest</a>* <a class="code" href="classMeasure.html#a50">Measure::findChordRest</a>(<span class="keywordtype">int</span> tick, <a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> voice, <span class="keywordtype">bool</span> <span class="comment">/*grace*/</span>)
00786       {
00787       <span class="keywordtype">int</span> staffIdx = _score-&gt;<a class="code" href="classScore.html#a5">staves</a>()-&gt;<a class="code" href="classStaffList.html#a1">idx</a>(staff);
00788       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = <a class="code" href="classMeasure.html#r0">_first</a>; seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00789             <span class="keywordflow">if</span> (seg-&gt;<a class="code" href="classElement.html#a74">tick</a>() &gt; tick)
00790                   <span class="keywordflow">return</span> 0;
00791             <span class="keywordflow">if</span> (seg-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick) {
00792                   <a class="code" href="classElement.html">Element</a>* <a class="code" href="classMeasure.html#a42">el</a> = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(staffIdx * <a class="code" href="globals_8h.html#a3">VOICES</a> + voice);
00793                   <span class="keywordflow">if</span> (el &amp;&amp; (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a> || el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a26">REST</a>)) {
00794                         <span class="keywordflow">return</span> (<a class="code" href="classChord.html">Chord</a>*)el;
00795                         }
00796                   }
00797             }
00798       <span class="keywordflow">return</span> 0;
00799       }
00800 
00801 <span class="comment">//---------------------------------------------------------</span>
00802 <span class="comment">//   tick2segment</span>
00803 <span class="comment">//---------------------------------------------------------</span>
00804 
<a name="l00805"></a><a class="code" href="classMeasure.html#a67">00805</a> <a class="code" href="classSegment.html">Segment</a>* <a class="code" href="classMeasure.html#a67">Measure::tick2segment</a>(<span class="keywordtype">int</span> tick)<span class="keyword"> const</span>
00806 <span class="keyword">      </span>{
00807       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>())
00808             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick)
00809                   <span class="keywordflow">return</span> s;
00810       <span class="keywordflow">return</span> 0;
00811       }
00812 
00813 <span class="comment">//---------------------------------------------------------</span>
00814 <span class="comment">//   add</span>
00815 <span class="comment">//    add new Element to Measure</span>
00816 <span class="comment">//---------------------------------------------------------</span>
00817 
<a name="l00818"></a><a class="code" href="classMeasure.html#a8">00818</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a8">Measure::add</a>(<a class="code" href="classElement.html">Element</a>* el)
00819       {
00820       <a class="code" href="classStaff.html">Staff</a>* staffp = el-&gt;<a class="code" href="classElement.html#a59">staff</a>();
00821       <span class="keywordtype">int</span> staffIdx  = staffp ? staffp-&gt;<a class="code" href="classStaff.html#a15">idx</a>() : -1;
00822 
00823       <span class="keywordflow">if</span> (staffp == 0) {
00824             <a class="code" href="classMeasure.html#r6">_pel</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(el);
00825             el-&gt;<a class="code" href="classElement.html#a13">setAnchor</a>(<span class="keyword">this</span>);
00826             <span class="keywordflow">return</span>;
00827             }
00828       <span class="keywordtype">int</span> voice = el-&gt;<a class="code" href="classElement.html#a62">voice</a>();
00829       <span class="keywordtype">int</span> track = staffIdx * <a class="code" href="globals_8h.html#a3">VOICES</a> + voice;
00830 
00831       el-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
00832       <span class="keywordtype">int</span> t = el-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00833       <a class="code" href="element_8h.html#a65">ElementType</a> type = el-&gt;<a class="code" href="classElement.html#a40">type</a>();
00834 
00835       <span class="keywordflow">switch</span>(type) {
00836 <span class="comment">//            case LYRICS:</span>
00837 <span class="comment">//                  ((Lyrics*)el)-&gt;segment()-&gt;add(el);</span>
00838 <span class="comment">//                  break;</span>
00839             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a11">SLUR_SEGMENT</a>:
00840                   ((<a class="code" href="classSlurSegment.html">SlurSegment</a>*)el)-&gt;slurTie()-&gt;add(el);
00841                   <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(el);
00842                   <span class="keywordflow">break</span>;
00843             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a28">SLUR</a>:
00844             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a10">GABEL</a>:
00845             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a31">DYNAMIC</a>:
00846             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a7">SYMBOL</a>:
00847             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a8">TEXT</a>:
00848             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a45">TEMPO_TEXT</a>:
00849                   <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(el);
00850                   <span class="keywordflow">break</span>;
00851             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a13">BAR</a>:
00852                   <span class="keywordflow">if</span> (((<a class="code" href="classBar.html">Bar</a>*)el)-&gt;barType() != Bar::START_REPEAT) {
00853                         <a class="code" href="classMeasure.html#r3">staves</a>[staffIdx].endBar = (<a class="code" href="classBar.html">Bar</a>*)el;
00854                         <span class="keywordflow">break</span>;
00855                         }
00856                   <span class="comment">// add Bar::START_REPEAT into segment</span>
00857                   <span class="comment">//</span>
00858             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a22">CLEF</a>:
00859             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a23">KEYSIG</a>:
00860             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a24">TIMESIG</a>:
00861             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a25">CHORD</a>:
00862             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a26">REST</a>:
00863                   {
00864                   Segment::SegmentType st = (Segment::SegmentType)-1;
00865                   <span class="keywordflow">if</span> (type == <a class="code" href="element_8h.html#a65a25">CHORD</a> || type == <a class="code" href="element_8h.html#a65a26">REST</a>)
00866                         st = Segment::SegChordRest;
00867                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="element_8h.html#a65a22">CLEF</a>)
00868                         st = Segment::SegClef;
00869                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="element_8h.html#a65a23">KEYSIG</a>)
00870                         st = Segment::SegKeySig;
00871                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="element_8h.html#a65a24">TIMESIG</a>)
00872                         st = Segment::SegTimeSig;
00873                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="element_8h.html#a65a13">BAR</a>)
00874                         st = Segment::SegBeginRepeat;
00875                   <span class="keywordflow">else</span>
00876                         printf(<span class="stringliteral">"Measure::add() bad type!\n"</span>);
00877 
00878                   <a class="code" href="classSegment.html">Segment</a>* s;
00879                   <span class="keywordflow">for</span> (s = <a class="code" href="classMeasure.html#a28">first</a>(); s &amp;&amp; s-&gt;<a class="code" href="classElement.html#a74">tick</a>() &lt; t; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>())
00880                         ;
00881 
00882                   <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* ss = s; ss &amp;&amp; ss-&gt;<a class="code" href="classElement.html#a74">tick</a>() == t; ss = ss-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00883                         <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="classSegment.html#a18">type</a>() != st)
00884                               <span class="keywordflow">continue</span>;
00885                         <span class="keywordflow">if</span> (ss-&gt;<a class="code" href="classSegment.html#a8">element</a>(track)) {
00886                               printf(<span class="stringliteral">"Measure::add(%s,%d,tick:%d): element &lt;%s&gt; exists!\n"</span>,
00887                               el-&gt;<a class="code" href="classElement.html#a69">name</a>(), track, t, ss-&gt;<a class="code" href="classSegment.html#a8">element</a>(track)-&gt;<a class="code" href="classElement.html#a69">name</a>());
00888                               }
00889                         <span class="keywordflow">else</span> {
00890                               ss-&gt;<a class="code" href="classSegment.html#a10">setElement</a>(track, el);
00891                               <span class="keywordflow">return</span>;
00892                               }
00893                         }
00894                   <a class="code" href="classSegment.html">Segment</a>* newSegment = <span class="keyword">new</span> <a class="code" href="classSegment.html">Segment</a>(<span class="keyword">this</span>, t);
00895                   newSegment-&gt;<a class="code" href="classSegment.html#a19">setType</a>(st);
00896                   <span class="keywordflow">if</span> (s) {
00897                         <span class="keywordflow">if</span> (st == Segment::SegChordRest) {
00898                               <span class="keywordflow">while</span> (s &amp;&amp; s-&gt;<a class="code" href="classSegment.html#a18">type</a>() != Segment::SegChordRest &amp;&amp; s-&gt;<a class="code" href="classElement.html#a74">tick</a>() == t) {
00899                                     s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>();
00900                                     }
00901                               }
00902                         <span class="keywordflow">else</span> {
00903                               <span class="keywordflow">while</span> (s-&gt;<a class="code" href="classSegment.html#a18">type</a>() &lt;= st &amp;&amp; s-&gt;<a class="code" href="classSegment.html#a4">next</a>() &amp;&amp; s-&gt;<a class="code" href="classSegment.html#a4">next</a>()-&gt;<a class="code" href="classElement.html#a74">tick</a>() == t) {
00904                                     s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>();
00905                                     }
00906                               }
00907                         }
00908                   <a class="code" href="classMeasure.html#a61">insert</a>(newSegment, s);
00909                   newSegment-&gt;<a class="code" href="classSegment.html#a10">setElement</a>(track, el);
00910                   }
00911                   <span class="keywordflow">break</span>;
00912 
00913             <span class="keywordflow">default</span>:
00914                   printf(<span class="stringliteral">"Measure::add(%s) not impl.\n"</span>, el-&gt;<a class="code" href="classElement.html#a69">name</a>());
00915                   <span class="keywordflow">break</span>;
00916             }
00917       }
00918 
00919 <span class="comment">//---------------------------------------------------------</span>
00920 <span class="comment">//   remove</span>
00921 <span class="comment">//---------------------------------------------------------</span>
00922 
<a name="l00923"></a><a class="code" href="classMeasure.html#a9">00923</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a9">Measure::remove</a>(<a class="code" href="classElement.html">Element</a>* el)
00924       {
00925       <span class="keywordtype">int</span> staff = _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(el-&gt;<a class="code" href="classElement.html#a59">staff</a>());
00926       <span class="keywordflow">if</span> (staff == -1) {
00927             <a class="code" href="classMeasure.html#r6">_pel</a>.<a class="code" href="classElementList.html#a1">remove</a>(el);
00928             <span class="keywordflow">return</span>;
00929             }
00930 
00931 <span class="comment">// printf("measure %p: remove %s %p, staff %d\n", this, el-&gt;name(), el, staff);</span>
00932 
00933       <span class="keywordflow">switch</span>(el-&gt;<a class="code" href="classElement.html#a40">type</a>()) {
00934             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a11">SLUR_SEGMENT</a>:
00935                   ((<a class="code" href="classSlurSegment.html">SlurSegment</a>*)el)-&gt;slurTie()-&gt;remove(el);
00936                   <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classElementList.html#a1">remove</a>(el);
00937                   <span class="keywordflow">break</span>;
00938 
00939             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a31">DYNAMIC</a>:
00940             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a28">SLUR</a>:
00941             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a10">GABEL</a>:
00942             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a45">TEMPO_TEXT</a>:
00943             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a8">TEXT</a>:
00944             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a7">SYMBOL</a>:
00945                   <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classElementList.html#a1">remove</a>(el);
00946                   <span class="keywordflow">break</span>;
00947 
00948             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a22">CLEF</a>:
00949             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a25">CHORD</a>:
00950             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a26">REST</a>:
00951             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a24">TIMESIG</a>:
00952 <span class="comment">//            case LYRICS:</span>
00953                   <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00954                         <span class="keywordtype">int</span> <a class="code" href="classMeasure.html#r3">staves</a> = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00955                         <span class="keywordtype">int</span> tracks = staves * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00956                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00957                               <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00958                               <span class="keywordflow">if</span> (el == e) {
00959                                     segment-&gt;<a class="code" href="classSegment.html#a10">setElement</a>(track, 0);
00960                                     <span class="keywordflow">return</span>;
00961                                     }
00962                               }
00963                         }
00964                   printf(<span class="stringliteral">"Measure::remove: %s %p not found\n"</span>, el-&gt;<a class="code" href="classElement.html#a69">name</a>(), el);
00965                   <span class="keywordflow">break</span>;
00966             <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a13">BAR</a>:
00967                   <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r3">staves</a>[staff].endBar == el)
00968                         <a class="code" href="classMeasure.html#r3">staves</a>[staff].endBar = 0;
00969                   <span class="keywordflow">else</span>
00970                         printf(<span class="stringliteral">"Measure::remove: cannot find bar\n"</span>);
00971                   <span class="keywordflow">break</span>;
00972 
00973             <span class="keywordflow">default</span>:
00974                   printf(<span class="stringliteral">"Measure::remove %s: not impl.\n"</span>, el-&gt;<a class="code" href="classElement.html#a69">name</a>());
00975                   <span class="keywordflow">break</span>;
00976             }
00977       }
00978 
00979 <span class="comment">//---------------------------------------------------------</span>
00980 <span class="comment">//   moveTicks</span>
00981 <span class="comment">//---------------------------------------------------------</span>
00982 
<a name="l00983"></a><a class="code" href="classMeasure.html#a60">00983</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a60">Measure::moveTicks</a>(<span class="keywordtype">int</span> diff)
00984       {
00985       setTick(<a class="code" href="classElement.html#a74">tick</a>() + diff);
00986       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a7">iMStaff</a> is = <a class="code" href="classMeasure.html#r3">staves</a>.begin(); is != <a class="code" href="classMeasure.html#r3">staves</a>.end(); ++is) {
00987             <span class="keywordflow">if</span> (is-&gt;endBar)
00988                   is-&gt;endBar-&gt;setTick(is-&gt;endBar-&gt;tick() + diff);
00989             }
00990       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> ii = <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ii != <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ii)
00991             (*ii)-&gt;setTick((*ii)-&gt;tick() + diff);
00992       <span class="keywordtype">int</span> <a class="code" href="classMeasure.html#r3">staves</a> = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00993       <span class="keywordtype">int</span> tracks = staves * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00994       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00995             segment-&gt;<a class="code" href="classElement.html#a75">setTick</a>(segment-&gt;<a class="code" href="classElement.html#a74">tick</a>() + diff);
00996             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00997                   <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00998                   <span class="keywordflow">if</span> (e)
00999                         e-&gt;<a class="code" href="classElement.html#a75">setTick</a>(e-&gt;<a class="code" href="classElement.html#a74">tick</a>() + diff);
01000                   }
01001             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; staves; ++staff) {
01002                   <span class="keyword">const</span> <a class="code" href="segment_8h.html#a0">LyricsList</a>* ll = segment-&gt;<a class="code" href="classSegment.html#a11">lyricsList</a>(staff);
01003                   <span class="keywordflow">for</span> (<a class="code" href="segment_8h.html#a2">ciLyrics</a> i = ll-&gt;begin(); i != ll-&gt;end(); ++i) {
01004                         <span class="keywordflow">if</span> (*i)
01005                               (*i)-&gt;setTick((*i)-&gt;tick() + diff);
01006                         }
01007                   }
01008             }
01009       }
01010 
01011 <span class="comment">//---------------------------------------------------------</span>
01012 <span class="comment">//   draw</span>
01013 <span class="comment">//---------------------------------------------------------</span>
01014 
<a name="l01015"></a><a class="code" href="classMeasure.html#a4">01015</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a4">Measure::draw</a>(<a class="code" href="classPainter.html">Painter</a>&amp; p)<span class="keyword"> const</span>
01016 <span class="keyword">      </span>{
01017       p.translate(<a class="code" href="classElement.html#a20">pos</a>());
01018 
01019       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>())
01020             segment-&gt;<a class="code" href="classSegment.html#a24">draw</a>(p);
01021       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciBeam</a> i = <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
01022             (*i)-&gt;draw(p);
01023       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a5">ciTuplet</a> i = <a class="code" href="classMeasure.html#r5">_tupletList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r5">_tupletList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
01024             (*i)-&gt;draw(p);
01025             }
01026       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a8">ciMStaff</a> is = <a class="code" href="classMeasure.html#r3">staves</a>.begin(); is != <a class="code" href="classMeasure.html#r3">staves</a>.end(); ++is) {
01027             <span class="keywordflow">if</span> (is-&gt;endBar)
01028                   is-&gt;endBar-&gt;draw(p);
01029             }
01030       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classMeasure.html#r7">_sel</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
01031             (*i)-&gt;draw(p);
01032 
01033       <span class="keywordflow">if</span> (<a class="code" href="classMeasure.html#r10">_noText</a>)
01034             <a class="code" href="classMeasure.html#r10">_noText</a>-&gt;<a class="code" href="classElement.html#a43">draw</a>(p);
01035 
01036       <span class="comment">//-------------------------------</span>
01037       <span class="comment">// draw selection:</span>
01038       <span class="comment">//-------------------------------</span>
01039 
01040       <span class="keywordflow">if</span> (_score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> != <a class="code" href="select_8h.html#a5a3">SEL_STAFF</a> &amp;&amp; _score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> != <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>) {
01041             p.translate(-<a class="code" href="classElement.html#a20">pos</a>());
01042             <span class="keywordflow">return</span>;
01043             }
01044       <span class="keywordtype">int</span> sstart = _score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o1">tickStart</a>;
01045       <span class="keywordtype">int</span> send   = _score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o2">tickEnd</a>;
01046       <span class="keywordtype">int</span> mstart = <a class="code" href="classElement.html#a74">tick</a>();
01047       <span class="keywordtype">int</span> mend   = <a class="code" href="classElement.html#a74">tick</a>() + <a class="code" href="classMeasure.html#a26">tickLen</a>();
01048 
01049       <span class="keywordflow">if</span> (send &lt;= mstart || sstart &gt;= mend) {
01050             p.translate(-<a class="code" href="classElement.html#a20">pos</a>());
01051             <span class="keywordflow">return</span>;
01052             }
01053 
01054       p.setBrush(Qt::NoBrush);
01055 
01056       <span class="keywordtype">double</span> x1 = _bbox.x();
01057       <span class="keywordtype">double</span> x2 = x1 + _bbox.width();
01058       <span class="keywordflow">if</span> (_score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>) {
01059             p.setPen(QPen(QColor(Qt::blue), 4, Qt::DotLine));
01060             <span class="keywordtype">double</span> y1 = _bbox.y() - <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01061             <span class="keywordtype">double</span> y2 = y1 + _bbox.height() + 2 * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01062 
01063             <span class="comment">// is this measure start of selection?</span>
01064             <span class="keywordflow">if</span> (sstart &gt;= mstart &amp;&amp; sstart &lt; mend) {
01065                   x1 -= <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01066                   p.drawLine(QLineF(x1, y1, x1, y2));
01067                   }
01068             <span class="comment">// is this measure end of selection?</span>
01069             <span class="keywordflow">if</span> (send &gt; mstart &amp;&amp; send &lt;= mend) {
01070                   x2 += <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01071                   p.drawLine(QLineF(x2, y1, x2, y2));
01072                   }
01073             p.drawLine(QLineF(x1, y1, x2, y1));
01074             p.drawLine(QLineF(x1, y2, x2, y2));
01075             }
01076       <span class="keywordflow">else</span> {
01077             p.setPen(QPen(QColor(Qt::blue), 2, Qt::SolidLine));
01078             <span class="keywordtype">double</span> y1 = <a class="code" href="classMeasure.html#a40">system</a>()-&gt;<a class="code" href="classSystem.html#a13">staff</a>(_score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o3">staffStart</a>)-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y() - <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01079             <span class="keywordtype">double</span> y2 = <a class="code" href="classMeasure.html#a40">system</a>()-&gt;<a class="code" href="classSystem.html#a13">staff</a>(_score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o4">staffEnd</a>-1)-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y()
01080                         + <a class="code" href="classMeasure.html#a40">system</a>()-&gt;<a class="code" href="classSystem.html#a13">staff</a>(_score-&gt;<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o4">staffEnd</a>-1)-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().height()
01081                         + <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01082 
01083             <span class="comment">// is this measure start of selection?</span>
01084             <span class="keywordflow">if</span> (sstart &gt;= mstart &amp;&amp; sstart &lt; mend) {
01085                   x1 -= <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01086                   p.drawLine(QLineF(x1, y1, x1, y2));
01087                   }
01088             <span class="comment">// is this measure end of selection?</span>
01089             <span class="keywordflow">if</span> (send &gt; mstart &amp;&amp; send &lt;= mend) {
01090                   x2 += <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01091                   p.drawLine(QLineF(x2, y1, x2, y2));
01092                   }
01093             p.drawLine(QLineF(x1, y1, x2, y1));
01094             p.drawLine(QLineF(x1, y2, x2, y2));
01095             }
01096       p.translate(-<a class="code" href="classElement.html#a20">pos</a>());
01097       }
01098 
01099 <span class="comment">//---------------------------------------------------------</span>
01100 <span class="comment">//   moveY</span>
01101 <span class="comment">//---------------------------------------------------------</span>
01102 
<a name="l01103"></a><a class="code" href="classMeasure.html#a47">01103</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a47">Measure::moveY</a>(<span class="keywordtype">int</span> staff, <span class="keywordtype">double</span> dy)
01104       {
01105       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = <a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
01106             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = staff*<a class="code" href="globals_8h.html#a3">VOICES</a>; track &lt; staff*<a class="code" href="globals_8h.html#a3">VOICES</a>+<a class="code" href="globals_8h.html#a3">VOICES</a>; ++track) {
01107                   <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
01108                   <span class="keywordflow">if</span> (e)
01109                         e-&gt;<a class="code" href="classElement.html#a25">move</a>(0, dy);
01110                   }
01111             }
01112       <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = <a class="code" href="classMeasure.html#r3">staves</a>[staff].endBar;
01113       <span class="keywordflow">if</span> (bar) {
01114             bar-&gt;<a class="code" href="classElement.html#a25">move</a>(0, dy);
01115             <span class="keywordflow">if</span> (_score-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff)-&gt;isTopSplit()) {
01116                   <a class="code" href="classSpatium.html">Spatium</a> barLen = <a class="code" href="classSpatium.html">Spatium</a>(8) + ::style-&gt;staffDistance;
01117                   bar-&gt;<a class="code" href="classElement.html#a39">setHeight</a>(point(barLen));
01118                   }
01119             }
01120       <a class="code" href="classMeasure.html#r10">_noText</a>-&gt;<a class="code" href="classElement.html#a25">move</a>(0, dy);
01121       }
01122 
01123 <span class="comment">//---------------------------------------------------------</span>
01124 <span class="comment">//   addBeam</span>
01125 <span class="comment">//---------------------------------------------------------</span>
01126 
<a name="l01127"></a><a class="code" href="classMeasure.html#a38">01127</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a38">Measure::addBeam</a>(<a class="code" href="classBeam.html">Beam</a>* b)
01128       {
01129       b-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
01130       <a class="code" href="classMeasure.html#r4">_beamList</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(b);
01131       }
01132 
01133 <span class="comment">//---------------------------------------------------------</span>
01134 <span class="comment">//   addTuplet</span>
01135 <span class="comment">//---------------------------------------------------------</span>
01136 
<a name="l01137"></a><a class="code" href="classMeasure.html#a39">01137</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a39">Measure::addTuplet</a>(<a class="code" href="classTuplet.html">Tuplet</a>* b)
01138       {
01139       b-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
01140       <a class="code" href="classMeasure.html#r5">_tupletList</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(b);
01141       }
01142 
01143 <span class="comment">//---------------------------------------------------------</span>
01144 <span class="comment">//   Space</span>
01145 <span class="comment">//    - unit of horizontal measure</span>
01146 <span class="comment">//---------------------------------------------------------</span>
01147 
<a name="l01148"></a><a class="code" href="classSpace.html">01148</a> <span class="keyword">class </span><a class="code" href="classSpace.html">Space</a> {
<a name="l01149"></a><a class="code" href="classSpace.html#r0">01149</a>       <span class="keywordtype">double</span> <a class="code" href="classSpace.html#r0">_min</a>;      <span class="comment">// minimum width</span>
<a name="l01150"></a><a class="code" href="classSpace.html#r1">01150</a>       <span class="keywordtype">double</span> <a class="code" href="classSpace.html#r1">_extra</a>;    <span class="comment">// left bearing</span>
<a name="l01151"></a><a class="code" href="classSpace.html#r2">01151</a>       <span class="keywordtype">bool</span> <a class="code" href="classSpace.html#r2">_valid</a>;
01152 
01153    <span class="keyword">public</span>:
<a name="l01154"></a><a class="code" href="classSpace.html#a0">01154</a>       <a class="code" href="classSpace.html#a0">Space</a>()                       { <a class="code" href="classSpace.html#r2">_valid</a> = <span class="keyword">false</span>; <a class="code" href="classSpace.html#r0">_min</a> = 0.0; <a class="code" href="classSpace.html#r1">_extra</a> = 0.0; }
<a name="l01155"></a><a class="code" href="classSpace.html#a1">01155</a>       <span class="keywordtype">bool</span> <a class="code" href="classSpace.html#a1">valid</a>()<span class="keyword"> const            </span>{ <span class="keywordflow">return</span> <a class="code" href="classSpace.html#r2">_valid</a>; }
<a name="l01156"></a><a class="code" href="classSpace.html#a2">01156</a>       <span class="keywordtype">void</span> <a class="code" href="classSpace.html#a2">setValid</a>(<span class="keywordtype">bool</span> val)       { <a class="code" href="classSpace.html#r2">_valid</a> = val; }
<a name="l01157"></a><a class="code" href="classSpace.html#a3">01157</a>       <span class="keywordtype">double</span> <a class="code" href="classSpace.html#a3">min</a>()<span class="keyword"> const            </span>{ <span class="keywordflow">return</span> <a class="code" href="classSpace.html#r0">_min</a>; }
<a name="l01158"></a><a class="code" href="classSpace.html#a4">01158</a>       <span class="keywordtype">double</span> <a class="code" href="classSpace.html#a4">extra</a>()<span class="keyword"> const          </span>{ <span class="keywordflow">return</span> <a class="code" href="classSpace.html#r1">_extra</a>; }
<a name="l01159"></a><a class="code" href="classSpace.html#a5">01159</a>       <span class="keywordtype">void</span> <a class="code" href="classSpace.html#a5">setExtra</a>(<span class="keywordtype">double</span> e)       { <a class="code" href="classSpace.html#r1">_extra</a> = e; }
<a name="l01160"></a><a class="code" href="classSpace.html#a6">01160</a>       <span class="keywordtype">void</span> <a class="code" href="classSpace.html#a6">setMin</a>(<span class="keywordtype">double</span> m)         { <a class="code" href="classSpace.html#r0">_min</a> = m; }
<a name="l01161"></a><a class="code" href="classSpace.html#a7">01161</a>       <span class="keywordtype">void</span> <a class="code" href="classSpace.html#a7">addMin</a>(<span class="keywordtype">double</span> m)         { <a class="code" href="classSpace.html#r0">_min</a> += m; }
<a name="l01162"></a><a class="code" href="classSpace.html#a8">01162</a>       <span class="keywordtype">void</span> <a class="code" href="classSpace.html#a8">max</a>(<span class="keyword">const</span> <a class="code" href="classSpace.html">Space</a>&amp; s) {
01163             <span class="keywordflow">if</span> (s.<a class="code" href="classSpace.html#r0">_min</a> &gt; <a class="code" href="classSpace.html#r0">_min</a>) {
01164                   <a class="code" href="classSpace.html#r0">_min</a> = s.<a class="code" href="classSpace.html#r0">_min</a>;
01165                   }
01166             <span class="keywordflow">if</span> (s.<a class="code" href="classSpace.html#r1">_extra</a> &gt; <a class="code" href="classSpace.html#r1">_extra</a>)
01167                   <a class="code" href="classSpace.html#r1">_extra</a> = s.<a class="code" href="classSpace.html#r1">_extra</a>;
01168             }
<a name="l01169"></a><a class="code" href="classSpace.html#a9">01169</a>       <span class="keywordtype">void</span> <a class="code" href="classSpace.html#a9">maxMin</a>(<a class="code" href="classSpace.html">Space</a> v) {
01170             <span class="keywordflow">if</span> (<a class="code" href="classSpace.html#r0">_min</a> &lt; v.<a class="code" href="classSpace.html#r0">_min</a>) {
01171                   <a class="code" href="classSpace.html#r0">_min</a> = v.<a class="code" href="classSpace.html#r0">_min</a>;
01172                   }
01173             }
01174       };
01175 
01176 <span class="comment">//---------------------------------------------------------</span>
01177 <span class="comment">//   Spring</span>
01178 <span class="comment">//---------------------------------------------------------</span>
01179 
<a name="l01180"></a><a class="code" href="structSpring.html">01180</a> <span class="keyword">struct </span><a class="code" href="structSpring.html">Spring</a> {
<a name="l01181"></a><a class="code" href="structSpring.html#o0">01181</a>       <span class="keywordtype">int</span> <a class="code" href="structSpring.html#o0">seg</a>;
<a name="l01182"></a><a class="code" href="structSpring.html#o1">01182</a>       <span class="keywordtype">double</span> <a class="code" href="structSpring.html#o1">stretch</a>;
<a name="l01183"></a><a class="code" href="structSpring.html#o2">01183</a>       <span class="keywordtype">double</span> <a class="code" href="structSpring.html#o2">fix</a>;
<a name="l01184"></a><a class="code" href="structSpring.html#a0">01184</a>       <a class="code" href="structSpring.html">Spring</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">double</span> s, <span class="keywordtype">double</span> f) : <a class="code" href="structSpring.html#o0">seg</a>(i), <a class="code" href="structSpring.html#o1">stretch</a>(s), <a class="code" href="structSpring.html#o2">fix</a>(f) {}
01185       };
01186 
<a name="l01187"></a><a class="code" href="measure_8cpp.html#a0">01187</a> <span class="keyword">typedef</span> std::multimap&lt;double, Spring, std::less&lt;double&gt; &gt; <a class="code" href="measure_8cpp.html#a0">SpringMap</a>;
<a name="l01188"></a><a class="code" href="measure_8cpp.html#a1">01188</a> <span class="keyword">typedef</span> SpringMap::iterator <a class="code" href="measure_8cpp.html#a1">iSpring</a>;
01189 
<a name="l01190"></a><a class="code" href="measure_8cpp.html#a2">01190</a> <span class="keyword">static</span> <a class="code" href="measure_8cpp.html#a0">SpringMap</a> <a class="code" href="measure_8cpp.html#a2">springs</a>;
01191 
01192 <span class="comment">//---------------------------------------------------------</span>
01193 <span class="comment">//   sff</span>
01194 <span class="comment">//    compute 1/Force for a given Extend</span>
01195 <span class="comment">//---------------------------------------------------------</span>
01196 
<a name="l01197"></a><a class="code" href="measure_8cpp.html#a4">01197</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="measure_8cpp.html#a4">sff</a>(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> xMin)
01198       {
01199       <span class="keywordflow">if</span> (x &lt;= xMin)
01200             <span class="keywordflow">return</span> 0.0;
01201       <a class="code" href="measure_8cpp.html#a1">iSpring</a> i = <a class="code" href="measure_8cpp.html#a2">springs</a>.begin();
01202       <span class="keywordtype">double</span> c  = i-&gt;second.stretch;
01203       <span class="keywordflow">if</span> (c == 0.0)           <span class="comment">//DEBUG</span>
01204             c = 1.1;
01205       <span class="keywordtype">double</span> f = 0.0;
01206       <span class="keywordflow">for</span> (; i != <a class="code" href="measure_8cpp.html#a2">springs</a>.end();) {
01207             xMin -= i-&gt;second.fix;
01208             f = (x - xMin) / c;
01209             ++i;
01210             <span class="keywordflow">if</span> (i == <a class="code" href="measure_8cpp.html#a2">springs</a>.end() || f &lt;= i-&gt;first)
01211                   <span class="keywordflow">break</span>;
01212             c += i-&gt;second.stretch;
01213             }
01214       <span class="keywordflow">return</span> f;
01215       }
01216 
01217 <span class="comment">//---------------------------------------------------------</span>
01218 <span class="comment">//   Measure::layoutX</span>
01219 <span class="comment">//    returns width of measure</span>
01220 <span class="comment">//---------------------------------------------------------</span>
01221 
<a name="l01222"></a><a class="code" href="classMeasure.html#a45">01222</a> <a class="code" href="structMeasureWidth.html">MeasureWidth</a> <a class="code" href="classMeasure.html#a45">Measure::layoutX</a>(<span class="keywordtype">double</span> stretch)
01223       {
01224       <span class="keywordtype">int</span> nstaves = _score-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
01225       <span class="keywordtype">int</span> tracks  = nstaves * <a class="code" href="globals_8h.html#a3">VOICES</a>;
01226 
01227       <span class="keywordtype">int</span> segs   = <a class="code" href="classMeasure.html#a25">size</a>();
01228       <span class="keywordflow">if</span> (nstaves == 0 || segs == 0)
01229             <span class="keywordflow">return</span> <a class="code" href="structMeasureWidth.html">MeasureWidth</a>(1.0, 0.0);
01230 
01231       <span class="comment">//-----------------------------------------------------------------------</span>
01232       <span class="comment">//    remove empty segments</span>
01233       <span class="comment">//-----------------------------------------------------------------------</span>
01234 again:
01235       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
01236             <span class="keywordtype">bool</span> <a class="code" href="classMeasure.html#a31">empty</a> = <span class="keyword">true</span>;
01237             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
01238                   <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a8">element</a>(track)) {
01239                         empty = <span class="keyword">false</span>;
01240                         <span class="keywordflow">break</span>;
01241                         }
01242                   }
01243             <span class="keywordflow">if</span> (empty) {
01244                   <a class="code" href="classMeasure.html#a9">remove</a>(s);
01245                   <span class="keywordflow">goto</span> again;
01246                   }
01247             }
01248 
01249       <span class="comment">//-----------------------------------------------------------------------</span>
01250       <span class="comment">//    fill array of Spaces for all segments and staves</span>
01251       <span class="comment">//    spaces[0]      - left margin</span>
01252       <span class="comment">//    spaces[segs+1] - right margin</span>
01253       <span class="comment">//    xpos[segs+2]   - start of next measure (width of current measure)</span>
01254       <span class="comment">//-----------------------------------------------------------------------</span>
01255 
01256       <a class="code" href="classSpace.html">Space</a> spaces[segs+2][tracks + nstaves]; <span class="comment">// dont forget lyrics</span>
01257       <span class="keywordtype">double</span> xpos[segs+3], ypos[tracks], width[segs+2];
01258 
01259       <span class="keywordtype">int</span> seg = 1;
01260       <span class="keywordtype">bool</span> notesSeg = <a class="code" href="classMeasure.html#a28">first</a>()-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest;
01261       <span class="keywordtype">bool</span> firstNoteRest = <span class="keyword">true</span>;
01262       <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>(), ++seg) {
01263             <span class="comment">//</span>
01264             <span class="comment">// add extra space between clef/key/timesig and first notes</span>
01265             <span class="comment">//</span>
01266             <span class="keywordtype">double</span> additionalMin = 0.0;
01267             <span class="keywordtype">double</span> additionalExtra = 0.0;
01268             <span class="keywordflow">if</span> (!notesSeg &amp;&amp; s-&gt;<a class="code" href="classSegment.html#a4">next</a>() &amp;&amp; s-&gt;<a class="code" href="classSegment.html#a4">next</a>()-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest) {
01269                   additionalMin = point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o14">clefKeyRightMargin</a>);
01270                   notesSeg = <span class="keyword">true</span>;
01271                   }
01272             <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest) {
01273                   <span class="keywordflow">if</span> (firstNoteRest) {
01274                         firstNoteRest = <span class="keyword">false</span>;
01275                         }
01276                   <span class="keywordflow">else</span>
01277                         additionalExtra = point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o16">minNoteDistance</a>);
01278                   }
01279             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegClef)
01280                   additionalExtra = point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o11">clefLeftMargin</a>);
01281             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegTimeSig)
01282                   additionalExtra = point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o13">timesigLeftMargin</a>);
01283             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegKeySig)
01284                   additionalExtra = point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o12">keysigLeftMargin</a>);
01285 
01286             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
01287                   <span class="keyword">const</span> <a class="code" href="classElement.html">Element</a>* <a class="code" href="classMeasure.html#a42">el</a> = s-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
01288                   spaces[seg][track].<a class="code" href="classSpace.html#a2">setValid</a>(el);
01289                   <span class="keywordflow">if</span> (el) {
01290                         <span class="keywordtype">double</span> min, extra;
01291                         el-&gt;<a class="code" href="classElement.html#a78">space</a>(min, extra);
01292                         spaces[seg][track].<a class="code" href="classSpace.html#a6">setMin</a>(min + additionalMin);
01293                         spaces[seg][track].<a class="code" href="classSpace.html#a5">setExtra</a>(extra + additionalExtra);
01294                         }
01295                   }
01296             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nstaves; ++i) {
01297                   <span class="keyword">const</span> <a class="code" href="segment_8h.html#a0">LyricsList</a>* ll = s-&gt;<a class="code" href="classSegment.html#a11">lyricsList</a>(i);
01298                   <span class="keywordtype">double</span> min = 0;
01299                   <span class="keywordtype">double</span> extra = 0;
01300                   <span class="keywordflow">for</span> (<a class="code" href="segment_8h.html#a2">ciLyrics</a> l = ll-&gt;begin(); l != ll-&gt;end(); ++l) {
01301                         <span class="keywordflow">if</span> (!*l)
01302                               <span class="keywordflow">continue</span>;
01303                         <span class="keywordtype">double</span> lw = ((*l)-&gt;bbox().width() + <a class="code" href="spatium_8h.html#a0">_spatium</a> * 0) / 2.0;
01304                         <span class="keywordflow">if</span> (lw &gt; min)
01305                               min = lw;
01306                         <span class="keywordflow">if</span> (lw &gt; extra)
01307                               extra = lw;
01308                         }
01309                   spaces[seg][tracks+i].<a class="code" href="classSpace.html#a6">setMin</a>(min);
01310                   spaces[seg][tracks+i].<a class="code" href="classSpace.html#a5">setExtra</a>(extra);
01311                   spaces[seg][tracks+i].<a class="code" href="classSpace.html#a2">setValid</a>(!ll-&gt;empty());
01312                   }
01313             }
01314       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
01315             <a class="code" href="classSpatium.html">Spatium</a> lMargin;
01316             <span class="keywordflow">switch</span>(<a class="code" href="classMeasure.html#a28">first</a>()-&gt;<a class="code" href="classSegment.html#a18">type</a>()) {
01317                   <span class="keywordflow">case</span> Segment::SegClef:
01318                         lMargin = ::style-&gt;clefLeftMargin;
01319                         <span class="keywordflow">break</span>;
01320                   <span class="keywordflow">case</span> Segment::SegKeySig:
01321                         lMargin = ::style-&gt;keysigLeftMargin;
01322                         <span class="keywordflow">break</span>;
01323                   <span class="keywordflow">case</span> Segment::SegTimeSig:
01324                         lMargin = ::style-&gt;timesigLeftMargin;
01325                         <span class="keywordflow">break</span>;
01326                   <span class="keywordflow">case</span> Segment::SegChordRest:
01327                         lMargin = ::style-&gt;barNoteDistance;
01328                         <span class="keywordflow">break</span>;
01329                   <span class="keywordflow">case</span> Segment::SegBeginRepeat:
01330                         lMargin = <a class="code" href="classSpatium.html">Spatium</a>(0);
01331                         <span class="keywordflow">break</span>;
01332                   }
01333             spaces[0][track].<a class="code" href="classSpace.html#a6">setMin</a>(point(lMargin));
01334             spaces[0][track].<a class="code" href="classSpace.html#a5">setExtra</a>(0.0);
01335             spaces[0][track].<a class="code" href="classSpace.html#a2">setValid</a>(<span class="keyword">true</span>);
01336             spaces[segs+1][track].<a class="code" href="classSpace.html#a5">setExtra</a>(point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o18">noteBarDistance</a>));
01337             <span class="keywordtype">double</span> w;
01338             <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = <a class="code" href="classMeasure.html#r3">staves</a>[track/<a class="code" href="globals_8h.html#a3">VOICES</a>].endBar;
01339             <span class="keywordflow">if</span> (bar)
01340                   w = bar-&gt;<a class="code" href="classElement.html#a37">width</a>();
01341             <span class="keywordflow">else</span>
01342                   w = 0.0;
01343             spaces[segs+1][track].<a class="code" href="classSpace.html#a6">setMin</a>(w);
01344             spaces[segs+1][track].<a class="code" href="classSpace.html#a2">setValid</a>(<span class="keyword">true</span>);
01345             }
01346       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = tracks; track &lt; tracks+nstaves; ++track) {
01347             spaces[0][track].<a class="code" href="classSpace.html#a2">setValid</a>(<span class="keyword">false</span>);
01348             spaces[segs+1][track].<a class="code" href="classSpace.html#a2">setValid</a>(<span class="keyword">false</span>);
01349             }
01350 
01351 <span class="preprocessor">#ifdef DEBUG</span>
01352 <span class="preprocessor"></span>      printf(<span class="stringliteral">"1======== "</span>);
01353       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks+nstaves; ++track) {
01354             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> seg = 0; seg &lt; segs+2; ++seg) {
01355                   <span class="keywordflow">if</span> (spaces[seg][track].<a class="code" href="classSpace.html#a1">valid</a>())
01356                         printf(<span class="stringliteral">"%3.1f+%3.1f "</span>, spaces[seg][track].min(), spaces[seg][track].extra());
01357                   <span class="keywordflow">else</span>
01358                         printf(<span class="stringliteral">"     -     "</span>);
01359                   }
01360             printf(<span class="stringliteral">"          \n"</span>);
01361             }
01362 <span class="preprocessor">#endif</span>
01363 <span class="preprocessor"></span>
01364       <span class="comment">//---------------------------------------------------</span>
01365       <span class="comment">//    move extra space to previous cells</span>
01366       <span class="comment">//---------------------------------------------------</span>
01367 
01368       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; tracks+nstaves; ++staff) {
01369             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> seg = segs+1; seg &gt; 0; --seg) {    <span class="comment">// seg 0 kann keinen Platz mehr verschieben</span>
01370                   <span class="keywordtype">double</span> extra = spaces[seg][staff].<a class="code" href="classSpace.html#a4">extra</a>();
01371                   <span class="keywordflow">if</span> (extra &lt; 0.00001)
01372                         <span class="keywordflow">continue</span>;
01373                   <span class="comment">// extra Platz auf vorheriges nichtleeres Segment verschieben</span>
01374                   <span class="keywordtype">int</span> tseg;
01375                   <span class="keywordflow">for</span> (tseg = seg-1; tseg &gt;= 0; --tseg) {
01376                         <span class="keywordflow">if</span> (spaces[tseg][staff].valid())
01377                               <span class="keywordflow">break</span>;
01378                         }
01379                   <span class="keywordflow">if</span> (tseg == 0) {
01380                         <span class="keywordflow">if</span> (spaces[tseg][staff].min() &lt; extra)
01381                               spaces[tseg][staff].setMin(extra);
01382                         }
01383                   <span class="keywordflow">else</span>
01384                         spaces[tseg][staff].addMin(extra);
01385                   }
01386             }
01387 <span class="preprocessor">#ifdef DEBUG</span>
01388 <span class="preprocessor"></span>      printf(<span class="stringliteral">"2======== "</span>);
01389       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; tracks+nstaves; ++staff) {
01390             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> seg = 0; seg &lt; segs+2; ++seg) {
01391                   <span class="keywordflow">if</span> (spaces[seg][staff].<a class="code" href="classSpace.html#a1">valid</a>())
01392                         printf(<span class="stringliteral">"%3.1f+%3.1f "</span>, spaces[seg][staff].min(), spaces[seg][staff].extra());
01393                   <span class="keywordflow">else</span>
01394                         printf(<span class="stringliteral">"     -     "</span>);
01395                   }
01396             printf(<span class="stringliteral">"          \n"</span>);
01397             }
01398 <span class="preprocessor">#endif</span>
01399 <span class="preprocessor"></span>      <span class="comment">//---------------------------------------------------</span>
01400       <span class="comment">//    populate width[] array</span>
01401       <span class="comment">//---------------------------------------------------</span>
01402 
01403       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> seg = segs+1; seg &gt;= 0; --seg) {
01404             <span class="keywordtype">double</span> ww = 0.0;
01405             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; tracks+nstaves; ++staff) {
01406                   <span class="keywordflow">if</span> (spaces[seg][staff].<a class="code" href="classSpace.html#a1">valid</a>()) {
01407                         <span class="keywordtype">double</span> w = spaces[seg][staff].<a class="code" href="classSpace.html#a3">min</a>();
01408                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nseg = seg+1; nseg &lt; segs+2; ++nseg) {
01409                               <span class="keywordflow">if</span> (spaces[nseg][staff].valid())
01410                                     <span class="keywordflow">break</span>;
01411                               w -= width[nseg];
01412                               <span class="keywordflow">if</span> (w &lt; 0.0)
01413                                     <span class="keywordflow">break</span>;
01414                               }
01415                         <span class="keywordflow">if</span> (w &gt; ww)
01416                               ww = w;
01417                         }
01418                   }
01419             width[seg] = ww;
01420             }
01421 
01422 <span class="preprocessor">#ifdef DEBUG</span>
01423 <span class="preprocessor"></span>      printf(<span class="stringliteral">"3width:==="</span>);
01424       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; segs+2; ++i)
01425             printf(<span class="stringliteral">"%3.1f   "</span>, width[i]);
01426       printf(<span class="stringliteral">"\n"</span>);
01427 <span class="preprocessor">#endif</span>
01428 <span class="preprocessor"></span>      <span class="comment">//---------------------------------------------------</span>
01429       <span class="comment">//    segments with equal duration should have</span>
01430       <span class="comment">//    equal width</span>
01431       <span class="comment">//---------------------------------------------------</span>
01432 
01433       <span class="keywordtype">int</span> ticks[segs+2];
01434       memset(ticks, 0, (segs+2) * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
01435 
01436       <span class="comment">//--------tick table for segments</span>
01437       <span class="keywordtype">int</span> minTick   = 100000;
01438       <span class="keywordtype">int</span> ntick     = <a class="code" href="classElement.html#a74">tick</a>() + <a class="code" href="classMeasure.html#a26">tickLen</a>();   <span class="comment">// position of next measure</span>
01439       <span class="keywordtype">int</span> i         = 1;
01440       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = <a class="code" href="classMeasure.html#a28">first</a>(); seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>(), ++i) {
01441             <span class="keywordflow">if</span> (seg-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest) {
01442                   <a class="code" href="classSegment.html">Segment</a>* nseg = seg;
01443                   <span class="keywordflow">for</span> (;;) {
01444                         nseg = nseg-&gt;<a class="code" href="classSegment.html#a4">next</a>();
01445                         <span class="keywordflow">if</span> (nseg == 0 || nseg-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest)
01446                               <span class="keywordflow">break</span>;
01447                         }
01448                   <span class="keywordtype">int</span> nticks = (nseg ? nseg-&gt;<a class="code" href="classElement.html#a74">tick</a>() : ntick) - seg-&gt;<a class="code" href="classElement.html#a74">tick</a>();
01449                   <span class="keywordflow">if</span> (nticks == 0) {
01450                         printf(<span class="stringliteral">"NTICKS is NULL size %d, idx %d, %d %d  %p %p types %d %d\n"</span>,
01451                            <a class="code" href="classMeasure.html#a25">size</a>(), i-1, seg-&gt;<a class="code" href="classElement.html#a74">tick</a>(), nseg ? nseg-&gt;<a class="code" href="classElement.html#a74">tick</a>() : 0, seg, nseg,
01452                            seg-&gt;<a class="code" href="classSegment.html#a18">type</a>(), nseg ? nseg-&gt;type() : 0);
01453                         }
01454                   <span class="keywordflow">else</span> {
01455                         <span class="keywordflow">if</span> (nticks &lt; minTick)
01456                               minTick = nticks;
01457                         }
01458                   ticks[i] = nticks;
01459                   }
01460             }
01461 <span class="preprocessor">#ifdef DEBUG</span>
01462 <span class="preprocessor"></span>      printf(<span class="stringliteral">"ticks:    "</span>);
01463       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; segs+2; ++i)
01464             printf(<span class="stringliteral">"%d "</span>, ticks[i]);
01465       printf(<span class="stringliteral">"\n"</span>);
01466 <span class="preprocessor">#endif</span>
01467 <span class="preprocessor"></span>
01468       <span class="comment">// compute stretches:</span>
01469 
01470       <a class="code" href="measure_8cpp.html#a2">springs</a>.clear();
01471       <span class="keywordtype">double</span> stretchList[segs+2];
01472       <span class="keywordtype">double</span> stretchSum   = 0.0;
01473       stretchList[0]      = 0.0;
01474       stretchList[segs+1] = 0.0;
01475       <span class="keywordtype">double</span> minimum      = width[0] + width[segs+1];
01476       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; segs+1; ++i) {
01477             <span class="keywordtype">double</span> str = 1.0;
01478             <span class="keywordtype">double</span> d;
01479             <span class="keywordflow">if</span> (ticks[i] &gt; 0) {
01480                   <span class="keywordflow">if</span> (minTick &gt; 0)
01481                         str += .6 * log2(<span class="keywordtype">double</span>(ticks[i]) / <span class="keywordtype">double</span>(minTick));
01482                   stretchList[i] = str;
01483                   d = width[i] / str;
01484                   }
01485             <span class="keywordflow">else</span> {
01486                   stretchList[i] = 0.0;   <span class="comment">// dont stretch timeSig and key</span>
01487                   d = 100000000.0;        <span class="comment">// CHECK</span>
01488                   }
01489             stretchSum += stretchList[i];
01490             minimum += width[i];
01491             <a class="code" href="measure_8cpp.html#a2">springs</a>.insert(std::pair&lt;double, Spring&gt;(d, <a class="code" href="structSpring.html">Spring</a>(i, stretchList[i], width[i])));
01492             }
01493 <span class="preprocessor">#ifdef DEBUG</span>
01494 <span class="preprocessor"></span>      printf(<span class="stringliteral">"stretch:    "</span>);
01495       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; segs+2; ++i)
01496             printf(<span class="stringliteral">"%3.1f "</span>, stretchList[i]);
01497       printf(<span class="stringliteral">"\n"</span>);
01498 <span class="preprocessor">#endif</span>
01499 <span class="preprocessor"></span>
01500       <span class="comment">//---------------------------------------------------</span>
01501       <span class="comment">//    distribute "stretch" to segments</span>
01502       <span class="comment">//---------------------------------------------------</span>
01503 
01504       <span class="keywordtype">double</span> force = <a class="code" href="measure_8cpp.html#a4">sff</a>(stretch, minimum);
01505       <span class="keywordflow">for</span> (<a class="code" href="measure_8cpp.html#a1">iSpring</a> i = <a class="code" href="measure_8cpp.html#a2">springs</a>.begin(); i != <a class="code" href="measure_8cpp.html#a2">springs</a>.end(); ++i) {
01506             <span class="keywordtype">double</span> stretch = force * i-&gt;second.stretch;
01507             <span class="keywordflow">if</span> (stretch &lt; i-&gt;second.fix)
01508                   stretch = i-&gt;second.fix;
01509             width[i-&gt;second.seg] = stretch;
01510             }
01511 
01512       xpos[0] = 0.0;
01513       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> seg = 0; seg &lt; segs+2; ++seg)
01514             xpos[seg+1] = xpos[seg] + width[seg];
01515 
01516 <span class="preprocessor">#ifdef DEBUG</span>
01517 <span class="preprocessor"></span>      printf(<span class="stringliteral">"a.stretch "</span>);
01518       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> seg = 0; seg &lt; segs+2; ++seg)
01519             printf(<span class="stringliteral">"%3.1f(%3.1f) "</span>, xpos[seg], width[seg]);
01520       printf(<span class="stringliteral">"\n"</span>);
01521 <span class="preprocessor">#endif</span>
01522 <span class="preprocessor"></span>
01523       <span class="comment">//---------------------------------------------------</span>
01524       <span class="comment">//    populate ypos[] array</span>
01525       <span class="comment">//---------------------------------------------------</span>
01526 
01527       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; nstaves; ++staff)
01528             ypos[staff] = <a class="code" href="classMeasure.html#a40">system</a>()-&gt;<a class="code" href="classSystem.html#a13">staff</a>(staff)-&gt;<a class="code" href="classSysStaff.html#a0">bbox</a>().y();
01529 
01530       <span class="comment">//---------------------------------------------------</span>
01531       <span class="comment">//    layout individual elements</span>
01532       <span class="comment">//---------------------------------------------------</span>
01533 
01534       seg = 1;
01535       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>(), ++seg) {
01536             s-&gt;<a class="code" href="classElement.html#a23">setpos</a>(xpos[seg], 0.0);
01537             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; tracks; ++staff) {
01538                   <span class="keywordtype">double</span> y = ypos[staff/<a class="code" href="globals_8h.html#a3">VOICES</a>];
01539                   QPointF <a class="code" href="classElement.html#a20">pos</a>(0.0, y);
01540                   <a class="code" href="classElement.html">Element</a>* e = s-&gt;<a class="code" href="classSegment.html#a8">element</a>(staff);
01541                   <span class="keywordflow">if</span> (e == 0)
01542                         <span class="keywordflow">continue</span>;
01543                   <a class="code" href="element_8h.html#a65">ElementType</a> t = e-&gt;<a class="code" href="classElement.html#a40">type</a>();
01544                   <span class="keywordflow">if</span> (t == <a class="code" href="element_8h.html#a65a26">REST</a>) {
01545                         <span class="keywordtype">double</span> y = ypos[staff/<a class="code" href="globals_8h.html#a3">VOICES</a> + ((<a class="code" href="classRest.html">Rest</a>*)e)-&gt;move()];
01546                         <span class="keywordtype">int</span> len = e-&gt;<a class="code" href="classElement.html#a76">tickLen</a>();
01547                         <span class="comment">//</span>
01548                         <span class="comment">// center symbol if its a whole rest</span>
01549                         <span class="comment">//</span>
01550                         <span class="keywordflow">if</span> (!<a class="code" href="classMeasure.html#r14">_irregular</a> &amp;&amp; len == _score-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a9">ticksMeasure</a>(e-&gt;<a class="code" href="classElement.html#a74">tick</a>())) {
01551                               <span class="comment">// center whole rest</span>
01552                               <span class="keywordtype">int</span> idx = 0;
01553                               <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#r0">_first</a>; s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>(), ++idx) {
01554                                     <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest)
01555                                           <span class="keywordflow">break</span>;
01556                                     }
01557                               <span class="keywordtype">double</span> o = xpos[idx+1];
01558                               <span class="keywordtype">double</span> w = xpos[segs+2] - o;
01559                               pos.setX(w/2.0 - e-&gt;<a class="code" href="classElement.html#a37">width</a>()/2.0);
01560                               }
01561                         <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a62">voice</a>() == 1)
01562                               y += -1 * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01563                         <span class="keywordflow">else</span>
01564                               y += 2 * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01565                         e-&gt;<a class="code" href="classElement.html#a23">setpos</a>(pos.x(), y);
01566                         }
01567                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == <a class="code" href="element_8h.html#a65a25">CHORD</a>) {
01568                         <span class="keywordtype">int</span> move = 0; <span class="comment">// TODO ((ChordRest*)e)-&gt;translate();</span>
01569                         <span class="keywordtype">double</span> y = ypos[staff/<a class="code" href="globals_8h.html#a3">VOICES</a> + move];
01570                         <span class="keywordflow">if</span> (((<a class="code" href="classChord.html">Chord</a>*)e)-&gt;grace()) {
01571                               <span class="keywordtype">double</span> min, extra;
01572                               ((<a class="code" href="classChord.html">Chord</a>*)e)-&gt;space(min, extra);
01573                               e-&gt;<a class="code" href="classElement.html#a23">setpos</a>(- min, y);
01574                               }
01575                         <span class="keywordflow">else</span> {
01576                               e-&gt;<a class="code" href="classElement.html#a23">setpos</a>(0.0, y);
01577                               }
01578                         }
01579                   <span class="keywordflow">else</span> {
01580                         <span class="keywordtype">double</span> xo = spaces[seg][staff].<a class="code" href="classSpace.html#a4">extra</a>();
01581                         <span class="keywordflow">if</span> (t == <a class="code" href="element_8h.html#a65a22">CLEF</a>)
01582                               e-&gt;<a class="code" href="classElement.html#a23">setpos</a>(-e-&gt;<a class="code" href="classElement.html#a33">bbox</a>().x() - xo + point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o11">clefLeftMargin</a>), y);
01583                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == <a class="code" href="element_8h.html#a65a24">TIMESIG</a>)
01584                               e-&gt;<a class="code" href="classElement.html#a23">setpos</a>(- e-&gt;<a class="code" href="classElement.html#a33">bbox</a>().x() - xo + point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o13">timesigLeftMargin</a>), y);
01585                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == <a class="code" href="element_8h.html#a65a23">KEYSIG</a>)
01586                               e-&gt;<a class="code" href="classElement.html#a23">setpos</a>(- e-&gt;<a class="code" href="classElement.html#a33">bbox</a>().x() - xo + point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o12">keysigLeftMargin</a>), y);
01587                         <span class="keywordflow">else</span>
01588                               e-&gt;<a class="code" href="classElement.html#a23">setpos</a>(- e-&gt;<a class="code" href="classElement.html#a33">bbox</a>().x() - xo, y);
01589                         }
01590                   }
01591             }
01592       <span class="keywordflow">return</span> <a class="code" href="structMeasureWidth.html">MeasureWidth</a>(xpos[segs+2], 0.0);
01593       }
01594 
01595 <span class="comment">//---------------------------------------------------------</span>
01596 <span class="comment">//   setNoText</span>
01597 <span class="comment">//---------------------------------------------------------</span>
01598 
<a name="l01599"></a><a class="code" href="classMeasure.html#a20">01599</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a20">Measure::setNoText</a>(<span class="keyword">const</span> QString&amp; s)
01600       {
01601       <a class="code" href="classMeasure.html#r10">_noText</a>-&gt;<a class="code" href="classSText.html#a5">setText</a>(s);
01602       }
01603 
01604 <span class="comment">//---------------------------------------------------------</span>
01605 <span class="comment">//   cmdRemoveStaves</span>
01606 <span class="comment">//---------------------------------------------------------</span>
01607 
<a name="l01608"></a><a class="code" href="classMeasure.html#a62">01608</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a62">Measure::cmdRemoveStaves</a>(<span class="keywordtype">int</span> sStaff, <span class="keywordtype">int</span> eStaff)
01609       {
01610       <span class="keywordtype">int</span> sTrack = sStaff * <a class="code" href="globals_8h.html#a3">VOICES</a>;
01611       <span class="keywordtype">int</span> eTrack = eStaff * <a class="code" href="globals_8h.html#a3">VOICES</a>;
01612       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#r0">_first</a>; s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
01613             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = sTrack; track &lt; eTrack; ++track) {
01614                   <a class="code" href="classElement.html">Element</a>* <a class="code" href="classMeasure.html#a42">el</a> = s-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
01615                   <span class="keywordflow">if</span> (el &amp;&amp; !el-&gt;<a class="code" href="classElement.html#a18">generated</a>()) {
01616                         _score-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemoveObject, el);
01617                         }
01618                   }
01619 
01620             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = sStaff; staff &lt; eStaff; ++staff) {
01621                   _score-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemoveSegStaff, s, sStaff);
01622                   s-&gt;<a class="code" href="classSegment.html#a21">removeStaff</a>(sStaff);
01623                   }
01624             }
01625 
01626       <span class="keywordtype">int</span> idx = sStaff;
01627       <a class="code" href="measure_8h.html#a7">iMStaff</a> si = <a class="code" href="classMeasure.html#r3">staves</a>.begin() + sStaff;
01628       <a class="code" href="measure_8h.html#a7">iMStaff</a> ei = <a class="code" href="classMeasure.html#r3">staves</a>.begin() + eStaff;
01629       <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a7">iMStaff</a> i = si; i != ei; ++i, ++idx) {
01630             _score-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::RemoveMStaff, <span class="keyword">this</span>, *i, idx);
01631             }
01632       <a class="code" href="classMeasure.html#r3">staves</a>.erase(si, ei);
01633 
01634       <span class="comment">// BeamList   _beamList;</span>
01635       <span class="comment">// TupletList _tupletList;</span>
01636       <span class="comment">// TODO</span>
01637       }
01638 
01639 <span class="comment">//---------------------------------------------------------</span>
01640 <span class="comment">//   cmdAddStaves</span>
01641 <span class="comment">//---------------------------------------------------------</span>
01642 
<a name="l01643"></a><a class="code" href="classMeasure.html#a63">01643</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a63">Measure::cmdAddStaves</a>(<span class="keywordtype">int</span> sStaff, <span class="keywordtype">int</span> eStaff)
01644       {
01645       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#r0">_first</a>; s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
01646             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = sStaff; staff &lt; eStaff; ++staff) {
01647                   s-&gt;<a class="code" href="classSegment.html#a20">insertStaff</a>(staff);
01648                   _score-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::InsertSegStaff, s, staff);
01649                   }
01650             }
01651       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = sStaff; i &lt; eStaff; ++i) {
01652             <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = 0;
01653             <span class="keywordflow">if</span> (i == sStaff) {
01654                   bar = <span class="keyword">new</span> <a class="code" href="classBar.html">Bar</a>(<a class="code" href="classElement.html#a4">score</a>());
01655                   bar-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
01656                   }
01657             <a class="code" href="structMStaff.html">MStaff</a> ms;
01658             ms.<a class="code" href="structMStaff.html#o0">endBar</a> = bar;
01659             <a class="code" href="classMeasure.html#r3">staves</a>.insert(<a class="code" href="classMeasure.html#r3">staves</a>.begin() + i, ms);
01660             _score-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::InsertMStaff, <span class="keyword">this</span>, ms, i);
01661 
01662             <a class="code" href="classRest.html">Rest</a>* rest = <span class="keyword">new</span> <a class="code" href="classRest.html">Rest</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="classElement.html#a74">tick</a>(), _score-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a9">ticksMeasure</a>(tick()));
01663             <a class="code" href="classStaff.html">Staff</a>* staff = _score-&gt;<a class="code" href="classScore.html#a7">staff</a>(i);
01664             rest-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
01665             <a class="code" href="classMeasure.html#a8">add</a>(rest);
01666             _score-&gt;<a class="code" href="classScore.html#a33">undoOp</a>(UndoOp::AddObject, rest);
01667             }
01668       }
01669 
01670 <span class="comment">//---------------------------------------------------------</span>
01671 <span class="comment">//   insertMStaff</span>
01672 <span class="comment">//---------------------------------------------------------</span>
01673 
<a name="l01674"></a><a class="code" href="classMeasure.html#a55">01674</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a55">Measure::insertMStaff</a>(<a class="code" href="structMStaff.html">MStaff</a> staff, <span class="keywordtype">int</span> idx)
01675       {
01676       <a class="code" href="classMeasure.html#r3">staves</a>.insert(<a class="code" href="classMeasure.html#r3">staves</a>.begin() + idx, staff);
01677       }
01678 
01679 <span class="comment">//---------------------------------------------------------</span>
01680 <span class="comment">//   removeMStaff</span>
01681 <span class="comment">//---------------------------------------------------------</span>
01682 
<a name="l01683"></a><a class="code" href="classMeasure.html#a56">01683</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a56">Measure::removeMStaff</a>(<a class="code" href="structMStaff.html">MStaff</a> <span class="comment">/*staff*/</span>, <span class="keywordtype">int</span> idx)
01684       {
01685       <a class="code" href="classMeasure.html#r3">staves</a>.erase(<a class="code" href="classMeasure.html#r3">staves</a>.begin() + idx);
01686       }
01687 
01688 <span class="comment">//---------------------------------------------------------</span>
01689 <span class="comment">//   insertStaff</span>
01690 <span class="comment">//---------------------------------------------------------</span>
01691 
<a name="l01692"></a><a class="code" href="classMeasure.html#a53">01692</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a53">Measure::insertStaff</a>(<a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> staffIdx)
01693       {
01694       <a class="code" href="classMeasure.html#a54">insertStaff1</a>(staff, staffIdx);
01695       <a class="code" href="classRest.html">Rest</a>* rest = <span class="keyword">new</span> <a class="code" href="classRest.html">Rest</a>(<a class="code" href="classElement.html#a4">score</a>(), <a class="code" href="classElement.html#a74">tick</a>(), _score-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a9">ticksMeasure</a>(tick()));
01696       rest-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staff);
01697       }
01698 
01699 <span class="comment">//---------------------------------------------------------</span>
01700 <span class="comment">//   insertStaff1</span>
01701 <span class="comment">//---------------------------------------------------------</span>
01702 
<a name="l01703"></a><a class="code" href="classMeasure.html#a54">01703</a> <span class="keywordtype">void</span> <a class="code" href="classMeasure.html#a54">Measure::insertStaff1</a>(<a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> staffIdx)
01704       {
01705       <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = <a class="code" href="classMeasure.html#r0">_first</a>; s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>())
01706             s-&gt;<a class="code" href="classSegment.html#a20">insertStaff</a>(staffIdx);
01707 
01708       <a class="code" href="classBar.html">Bar</a>* <a class="code" href="classMeasure.html#a44">bar</a> = 0;
01709       <span class="keywordflow">if</span> (staff-&gt;<a class="code" href="classStaff.html#a4">isTop</a>()) {
01710             bar = <span class="keyword">new</span> <a class="code" href="classBar.html">Bar</a>(<a class="code" href="classElement.html#a4">score</a>());
01711             bar-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<span class="keyword">this</span>);
01712             }
01713       <a class="code" href="structMStaff.html">MStaff</a> ms;
01714       ms.<a class="code" href="structMStaff.html#o0">endBar</a> = bar;
01715       ms.<a class="code" href="structMStaff.html#o1">distance</a> = point(staffIdx == 0 ? <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o4">systemDistance</a> : <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o2">staffDistance</a>);
01716       <a class="code" href="classMeasure.html#r3">staves</a>.insert(<a class="code" href="classMeasure.html#r3">staves</a>.begin()+staffIdx, ms);
01717       }
01718 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
