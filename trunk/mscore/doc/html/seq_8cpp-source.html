<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: seq.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>seq.cpp</h1><a href="seq_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: seq.cpp,v 1.31 2005/06/26 09:17:49 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="seq_8h.html">seq.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="fluid_8h.html">fluid.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="jackaudio_8h.html">jackaudio.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="alsa_8h.html">alsa.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="tempo_8h.html">tempo.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="playpanel_8h.html">playpanel.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="seq_8cpp.html#a0">00025</a> <a class="code" href="classSeq.html">Seq</a>* <a class="code" href="seq_8cpp.html#a0">seq</a>;
00026 
00027 <span class="comment">//---------------------------------------------------------</span>
00028 <span class="comment">//   Seq</span>
00029 <span class="comment">//---------------------------------------------------------</span>
00030 
<a name="l00031"></a><a class="code" href="classSeq.html#a0">00031</a> <a class="code" href="classSeq.html#a0">Seq::Seq</a>()
00032       {
00033       <a class="code" href="classSeq.html#r9">playlistValid</a> = <span class="keyword">false</span>;
00034       <a class="code" href="classSeq.html#r14">endTick</a>  = 0;
00035       <a class="code" href="classSeq.html#r1">running</a>  = <span class="keyword">false</span>;
00036       <a class="code" href="classSeq.html#r2">state</a>    = <a class="code" href="classSeq.html#w3w0">STOP</a>;
00037 
00038       <a class="code" href="classSeq.html#r3">synti</a>    = <span class="keyword">new</span> <a class="code" href="classISynth.html">ISynth</a>();
00039       <a class="code" href="classSeq.html#r4">audio</a>    = 0;
00040       <a class="code" href="classSeq.html#r15">_volume</a>  = 1.0;
00041       <a class="code" href="classSeq.html#r12">playPos</a>  = <a class="code" href="classSeq.html#r8">events</a>.begin();
00042 
00043       <span class="comment">//---------------------------------------------------</span>
00044       <span class="comment">//  pipe for asynchronous gui to sequencer</span>
00045       <span class="comment">//  messages</span>
00046       <span class="comment">//---------------------------------------------------</span>
00047 
00048       <span class="keywordtype">int</span> filedes[2];         <span class="comment">// 0 - reading   1 - writing</span>
00049       <span class="keywordflow">if</span> (pipe(filedes) == -1) {
00050             perror(<span class="stringliteral">"creating pipe0"</span>);
00051             exit(-1);
00052             }
00053       <span class="comment">// pipe for gui -&gt; sequencer</span>
00054       <a class="code" href="classSeq.html#r6">fromThreadFdr</a> = filedes[0];
00055       <a class="code" href="classSeq.html#r5">fromThreadFdw</a> = filedes[1];
00056       <span class="keywordtype">int</span> rv = fcntl(<a class="code" href="classSeq.html#r5">fromThreadFdw</a>, F_SETFL, O_NONBLOCK);
00057       <span class="keywordflow">if</span> (rv == -1)
00058             perror(<span class="stringliteral">"set pipe write O_NONBLOCK"</span>);
00059       rv = fcntl(<a class="code" href="classSeq.html#r6">fromThreadFdr</a>, F_SETFL, O_NONBLOCK);
00060       <span class="keywordflow">if</span> (rv == -1)
00061             perror(<span class="stringliteral">"set pipe read O_NONBLOCK"</span>);
00062 
00063       <span class="comment">//</span>
00064       <span class="comment">// pipe for asynchronous sequencer to gui messages</span>
00065       <span class="comment">//</span>
00066       <span class="keywordflow">if</span> (pipe(filedes) == -1) {
00067             perror(<span class="stringliteral">"creating pipe1"</span>);
00068             exit(-1);
00069             }
00070       <a class="code" href="classSeq.html#r7">sigFd</a> = filedes[1];
00071       QSocketNotifier* ss = <span class="keyword">new</span> QSocketNotifier(filedes[0], QSocketNotifier::Read);
00072       connect(ss, SIGNAL(activated(<span class="keywordtype">int</span>)), <span class="keyword">this</span>, SLOT(<a class="code" href="classSeq.html#k0">seqMessage</a>(<span class="keywordtype">int</span>)));
00073       <a class="code" href="classSeq.html#r16">heartBeatTimer</a> = <span class="keyword">new</span> QTimer(<span class="keyword">this</span>, <span class="stringliteral">"timer"</span>);
00074       connect(<a class="code" href="classSeq.html#r16">heartBeatTimer</a>, SIGNAL(timeout()), <span class="keyword">this</span>, SLOT(<a class="code" href="classSeq.html#k1">heartBeat</a>()));
00075       <a class="code" href="classSeq.html#r16">heartBeatTimer</a>-&gt;stop();
00076       }
00077 
00078 <span class="comment">//---------------------------------------------------------</span>
00079 <span class="comment">//   Seq</span>
00080 <span class="comment">//---------------------------------------------------------</span>
00081 
<a name="l00082"></a><a class="code" href="classSeq.html#a1">00082</a> <a class="code" href="classSeq.html#a1">Seq::~Seq</a>()
00083       {
00084       <span class="keyword">delete</span> <a class="code" href="classSeq.html#r3">synti</a>;
00085       <span class="keyword">delete</span> <a class="code" href="classSeq.html#r4">audio</a>;
00086       <span class="keyword">delete</span> <a class="code" href="classSeq.html#r16">heartBeatTimer</a>;
00087       }
00088 
00089 <span class="comment">//---------------------------------------------------------</span>
00090 <span class="comment">//   isRealtime</span>
00091 <span class="comment">//---------------------------------------------------------</span>
00092 
<a name="l00093"></a><a class="code" href="classSeq.html#a12">00093</a> <span class="keywordtype">bool</span> <a class="code" href="classSeq.html#a12">Seq::isRealtime</a>()<span class="keyword"> const</span>
00094 <span class="keyword">      </span>{
00095       <span class="keywordflow">return</span> <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a12">isRealtime</a>();
00096       }
00097 
00098 <span class="comment">//---------------------------------------------------------</span>
00099 <span class="comment">//   init</span>
00100 <span class="comment">//    return true on error</span>
00101 <span class="comment">//---------------------------------------------------------</span>
00102 
<a name="l00103"></a><a class="code" href="classSeq.html#a3">00103</a> <span class="keywordtype">bool</span> <a class="code" href="classSeq.html#a3">Seq::init</a>()
00104       {
00105       <a class="code" href="classSeq.html#r4">audio</a> = <span class="keyword">new</span> <a class="code" href="classJackAudio.html">JackAudio</a>();
00106       <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a2">init</a>()) {
00107             printf(<span class="stringliteral">"no JACK server found\n"</span>);
00108             <a class="code" href="classSeq.html#r4">audio</a> = <span class="keyword">new</span> <a class="code" href="classAlsaAudio.html">AlsaAudio</a>();
00109             <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a2">init</a>()) {
00110                   printf(<span class="stringliteral">"no ALSA audio found\n"</span>);
00111                   <span class="keyword">delete</span> <a class="code" href="classSeq.html#r4">audio</a>;
00112                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00113                   }
00114             }
00115       <span class="keywordflow">if</span> (!<a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a2">init</a>(<a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a11">sampleRate</a>())) {
00116             <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a3">start</a>();
00117             <a class="code" href="classSeq.html#r1">running</a> = <span class="keyword">true</span>;
00118             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00119             }
00120       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00121       }
00122 
00123 <span class="comment">//---------------------------------------------------------</span>
00124 <span class="comment">//   sampleRate</span>
00125 <span class="comment">//---------------------------------------------------------</span>
00126 
<a name="l00127"></a><a class="code" href="classSeq.html#a9">00127</a> <span class="keywordtype">int</span> <a class="code" href="classSeq.html#a9">Seq::sampleRate</a>()<span class="keyword"> const</span>
00128 <span class="keyword">      </span>{
00129       <span class="keywordflow">return</span> <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a11">sampleRate</a>();
00130       }
00131 
00132 <span class="comment">//---------------------------------------------------------</span>
00133 <span class="comment">//   frame2tick</span>
00134 <span class="comment">//---------------------------------------------------------</span>
00135 
<a name="l00136"></a><a class="code" href="classSeq.html#d4">00136</a> <span class="keywordtype">int</span> <a class="code" href="classSeq.html#d4">Seq::frame2tick</a>(<span class="keywordtype">int</span> frame)<span class="keyword"> const</span>
00137 <span class="keyword">      </span>{
00138       <span class="keywordflow">return</span> <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o11">tempomap</a>-&gt;<a class="code" href="classTempoList.html#a9">time2tick</a>(<span class="keywordtype">double</span>(frame) / <a class="code" href="classSeq.html#a9">sampleRate</a>());
00139       }
00140 
00141 <span class="comment">//---------------------------------------------------------</span>
00142 <span class="comment">//   tick2frame</span>
00143 <span class="comment">//---------------------------------------------------------</span>
00144 
<a name="l00145"></a><a class="code" href="classSeq.html#d5">00145</a> <span class="keywordtype">int</span> <a class="code" href="classSeq.html#d5">Seq::tick2frame</a>(<span class="keywordtype">int</span> tick)<span class="keyword"> const</span>
00146 <span class="keyword">      </span>{
00147       <span class="keywordflow">return</span> int(<a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o11">tempomap</a>-&gt;<a class="code" href="classTempoList.html#a6">tick2time</a>(tick) * <a class="code" href="classSeq.html#a9">sampleRate</a>());
00148       }
00149 
00150 <span class="comment">//---------------------------------------------------------</span>
00151 <span class="comment">//   inputPorts</span>
00152 <span class="comment">//---------------------------------------------------------</span>
00153 
<a name="l00154"></a><a class="code" href="classSeq.html#a7">00154</a> std::list&lt;QString&gt; <a class="code" href="classSeq.html#a7">Seq::inputPorts</a>()
00155       {
00156       <span class="keywordflow">return</span> <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a5">inputPorts</a>();
00157       }
00158 
00159 <span class="comment">//---------------------------------------------------------</span>
00160 <span class="comment">//   loadSoundFont</span>
00161 <span class="comment">//---------------------------------------------------------</span>
00162 
<a name="l00163"></a><a class="code" href="classSeq.html#a2">00163</a> <span class="keywordtype">bool</span> <a class="code" href="classSeq.html#a2">Seq::loadSoundFont</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* s)
00164       {
00165       <span class="keywordflow">return</span> <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a3">loadSoundFont</a>(s);
00166       }
00167 
00168 <span class="comment">//---------------------------------------------------------</span>
00169 <span class="comment">//   rewindStart</span>
00170 <span class="comment">//---------------------------------------------------------</span>
00171 
<a name="l00172"></a><a class="code" href="classSeq.html#i2">00172</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#i2">Seq::rewindStart</a>()
00173       {
00174       <a class="code" href="classSeq.html#r11">playFrame</a> = 0;
00175       <a class="code" href="classSeq.html#r12">playPos</a>   = <a class="code" href="classSeq.html#r8">events</a>.begin();
00176       <a class="code" href="classSeq.html#r13">guiPos</a>    = <a class="code" href="classSeq.html#r12">playPos</a>;
00177       }
00178 
00179 <span class="comment">//---------------------------------------------------------</span>
00180 <span class="comment">//   start</span>
00181 <span class="comment">//    called from gui thread</span>
00182 <span class="comment">//---------------------------------------------------------</span>
00183 
<a name="l00184"></a><a class="code" href="classSeq.html#i0">00184</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#i0">Seq::start</a>()
00185       {
00186       <span class="keywordflow">if</span> (!<a class="code" href="classSeq.html#r9">playlistValid</a>) {
00187             <a class="code" href="classSeq.html#d1">collectEvents</a>();
00188             <a class="code" href="classSeq.html#r11">playFrame</a> = 0;
00189             <a class="code" href="classSeq.html#r12">playPos</a>   = <a class="code" href="classSeq.html#r8">events</a>.begin();
00190             <a class="code" href="classSeq.html#r13">guiPos</a>    = <a class="code" href="classSeq.html#r12">playPos</a>;
00191             }
00192       <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a9">startTransport</a>();
00193       <a class="code" href="classSeq.html#r16">heartBeatTimer</a>-&gt;start(1000/20);
00194       }
00195 
00196 <span class="comment">//---------------------------------------------------------</span>
00197 <span class="comment">//   stop</span>
00198 <span class="comment">//    called from gui thread</span>
00199 <span class="comment">//---------------------------------------------------------</span>
00200 
<a name="l00201"></a><a class="code" href="classSeq.html#i1">00201</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#i1">Seq::stop</a>()
00202       {
00203       <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a8">stopTransport</a>();
00204       }
00205 
00206 <span class="comment">//---------------------------------------------------------</span>
00207 <span class="comment">//   setStop</span>
00208 <span class="comment">//    called from button toggled</span>
00209 <span class="comment">//---------------------------------------------------------</span>
00210 
<a name="l00211"></a><a class="code" href="classMuseScore.html#k16">00211</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k16">MuseScore::setStop</a>(<span class="keywordtype">bool</span> f)
00212       {
00213       <span class="keywordflow">if</span> (!f) {
00214             <a class="code" href="classMuseScore.html#r28">stopAction</a>-&gt;setOn(<span class="keyword">true</span>);
00215             <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r29">playPanel</a>)
00216                   <a class="code" href="classMuseScore.html#r29">playPanel</a>-&gt;<a class="code" href="classPlayPanel.html#a2">setStop</a>(<span class="keyword">true</span>);
00217             }
00218       <span class="keywordflow">else</span> {
00219             <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#i1">stop</a>();
00220             }
00221       }
00222 
00223 <span class="comment">//---------------------------------------------------------</span>
00224 <span class="comment">//   setPlay</span>
00225 <span class="comment">//    called from button toggled</span>
00226 <span class="comment">//---------------------------------------------------------</span>
00227 
<a name="l00228"></a><a class="code" href="classMuseScore.html#k17">00228</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k17">MuseScore::setPlay</a>(<span class="keywordtype">bool</span> f)
00229       {
00230       <span class="keywordflow">if</span> (!f) {
00231             <a class="code" href="classMuseScore.html#r27">playAction</a>-&gt;setOn(<span class="keyword">true</span>);
00232             <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r29">playPanel</a>)
00233                   <a class="code" href="classMuseScore.html#r29">playPanel</a>-&gt;<a class="code" href="classPlayPanel.html#a3">setPlay</a>(<span class="keyword">true</span>);
00234             }
00235       <span class="keywordflow">else</span> {
00236             <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#i0">start</a>();
00237             }
00238       }
00239 
00240 <span class="comment">//---------------------------------------------------------</span>
00241 <span class="comment">//   seqStarted</span>
00242 <span class="comment">//---------------------------------------------------------</span>
00243 
<a name="l00244"></a><a class="code" href="classMuseScore.html#k33">00244</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k33">MuseScore::seqStarted</a>()
00245       {
00246       <a class="code" href="classMuseScore.html#r28">stopAction</a>-&gt;blockSignals(<span class="keyword">true</span>);
00247       <a class="code" href="classMuseScore.html#r28">stopAction</a>-&gt;setOn(<span class="keyword">false</span>);
00248       <a class="code" href="classMuseScore.html#r28">stopAction</a>-&gt;blockSignals(<span class="keyword">false</span>);
00249       <a class="code" href="classMuseScore.html#r27">playAction</a>-&gt;blockSignals(<span class="keyword">true</span>);
00250       <a class="code" href="classMuseScore.html#r27">playAction</a>-&gt;setOn(<span class="keyword">true</span>);
00251       <a class="code" href="classMuseScore.html#r27">playAction</a>-&gt;blockSignals(<span class="keyword">false</span>);
00252       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r29">playPanel</a>) {
00253             <a class="code" href="classMuseScore.html#r29">playPanel</a>-&gt;<a class="code" href="classPlayPanel.html#a2">setStop</a>(<span class="keyword">false</span>);
00254             <a class="code" href="classMuseScore.html#r29">playPanel</a>-&gt;<a class="code" href="classPlayPanel.html#a3">setPlay</a>(<span class="keyword">true</span>);
00255             }
00256       <a class="code" href="classPlayPanel.html">PlayPanel</a>* pp = <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a6">getPlayPanel</a>();
00257       <span class="keywordflow">if</span> (pp)
00258             pp-&gt;<a class="code" href="classPlayPanel.html#a7">enableSeek</a>(<span class="keyword">false</span>);
00259       }
00260 
00261 <span class="comment">//---------------------------------------------------------</span>
00262 <span class="comment">//   seqStopped</span>
00263 <span class="comment">//    JACK has stopped</span>
00264 <span class="comment">//    executed in gui environment</span>
00265 <span class="comment">//---------------------------------------------------------</span>
00266 
<a name="l00267"></a><a class="code" href="classMuseScore.html#k34">00267</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k34">MuseScore::seqStopped</a>()
00268       {
00269       <a class="code" href="classMuseScore.html#r28">stopAction</a>-&gt;blockSignals(<span class="keyword">true</span>);
00270       <a class="code" href="classMuseScore.html#r28">stopAction</a>-&gt;setOn(<span class="keyword">true</span>);
00271       <a class="code" href="classMuseScore.html#r28">stopAction</a>-&gt;blockSignals(<span class="keyword">false</span>);
00272       <a class="code" href="classMuseScore.html#r27">playAction</a>-&gt;blockSignals(<span class="keyword">true</span>);
00273       <a class="code" href="classMuseScore.html#r27">playAction</a>-&gt;setOn(<span class="keyword">false</span>);
00274       <a class="code" href="classMuseScore.html#r27">playAction</a>-&gt;blockSignals(<span class="keyword">false</span>);
00275       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#r29">playPanel</a>) {
00276             <a class="code" href="classMuseScore.html#r29">playPanel</a>-&gt;<a class="code" href="classPlayPanel.html#a2">setStop</a>(<span class="keyword">true</span>);
00277             <a class="code" href="classMuseScore.html#r29">playPanel</a>-&gt;<a class="code" href="classPlayPanel.html#a3">setPlay</a>(<span class="keyword">false</span>);
00278             }
00279 
00280       <a class="code" href="classPainter.html">Painter</a> painter(<a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a46">canvas</a>());
00281       painter.setClipRect(QRectF(0, 0, 100000, 100000));
00282       <span class="keywordflow">for</span> (<a class="code" href="seq_8h.html#a6">aEvent</a> i = <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a8">activeNotes</a>().begin(); i != <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a8">activeNotes</a>().end(); ++i) {
00283             <a class="code" href="classNote.html">Note</a>* note = i-&gt;second.note;
00284             <a class="code" href="structSym.html">Sym</a>* head = note-&gt;<a class="code" href="classNote.html#a14">noteHead</a>();
00285             painter.translate(note-&gt;<a class="code" href="classElement.html#a35">apos</a>());
00286             painter.setPen(Qt::black);
00287             head-&gt;<a class="code" href="structSym.html#a7">draw</a>(painter);
00288             painter.translate(0, 0);
00289 <span class="comment">//TODO            QPaintEvent ev(tf.frect2irect(head-&gt;bbox() + note-&gt;aref()));</span>
00290 <span class="comment">//            canvas-&gt;paintEvent(&amp;ev);</span>
00291             }
00292       <a class="code" href="seq_8cpp.html#a0">seq</a>-&gt;<a class="code" href="classSeq.html#a8">activeNotes</a>().clear();
00293       <a class="code" href="classPlayPanel.html">PlayPanel</a>* pp = <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a6">getPlayPanel</a>();
00294       <span class="keywordflow">if</span> (pp)
00295             pp-&gt;<a class="code" href="classPlayPanel.html#a7">enableSeek</a>(<span class="keyword">true</span>);
00296       }
00297 
00298 <span class="comment">//---------------------------------------------------------</span>
00299 <span class="comment">//   seqSignal</span>
00300 <span class="comment">//    sequencer message to GUI</span>
00301 <span class="comment">//    execution environment: gui thread</span>
00302 <span class="comment">//---------------------------------------------------------</span>
00303 
<a name="l00304"></a><a class="code" href="classSeq.html#k0">00304</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#k0">Seq::seqMessage</a>(<span class="keywordtype">int</span> fd)
00305       {
00306       <span class="keywordtype">char</span> buffer[16];
00307 
00308       <span class="keywordtype">int</span> n = ::read(fd, buffer, 16);
00309       <span class="keywordflow">if</span> (n &lt; 0) {
00310             printf(<span class="stringliteral">"MScore::Seq: seqMessage(): READ PIPE failed: %s\n"</span>,
00311                strerror(errno));
00312             <span class="keywordflow">return</span>;
00313             }
00314       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n; ++i) {
00315             <span class="keywordflow">switch</span>(buffer[i]) {
00316                   <span class="keywordflow">case</span> <span class="charliteral">'0'</span>:         <span class="comment">// STOP</span>
00317                         emit <a class="code" href="classSeq.html#l1">stopped</a>();
00318                         <span class="keywordflow">break</span>;
00319                   <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:         <span class="comment">// PLAY</span>
00320                         emit <a class="code" href="classSeq.html#l0">started</a>();
00321                         <span class="keywordflow">break</span>;
00322                   <span class="keywordflow">default</span>:
00323                         printf(<span class="stringliteral">"MScore::Seq:: unknown seq msg %d\n"</span>, buffer[i]);
00324                         <span class="keywordflow">break</span>;
00325                   }
00326             }
00327       }
00328 
00329 <span class="comment">//---------------------------------------------------------</span>
00330 <span class="comment">//   stopTransport</span>
00331 <span class="comment">//    JACK has stopped</span>
00332 <span class="comment">//    executed in realtime environment</span>
00333 <span class="comment">//---------------------------------------------------------</span>
00334 
<a name="l00335"></a><a class="code" href="classSeq.html#d2">00335</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#d2">Seq::stopTransport</a>()
00336       {
00337       <span class="comment">// send note off events</span>
00338       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> i = <a class="code" href="classSeq.html#r10">_activeNotes</a>.begin(); i != <a class="code" href="classSeq.html#r10">_activeNotes</a>.end(); ++i)
00339             <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a5">playNote</a>(i-&gt;second.channel, i-&gt;second.val1, 0);
00340       <a class="code" href="classSeq.html#d0">toGui</a>(<span class="charliteral">'0'</span>);
00341       <a class="code" href="classSeq.html#r2">state</a> = <a class="code" href="classSeq.html#w3w0">STOP</a>;
00342       }
00343 
00344 <span class="comment">//---------------------------------------------------------</span>
00345 <span class="comment">//   startTransport</span>
00346 <span class="comment">//    JACK has started</span>
00347 <span class="comment">//    executed in realtime environment</span>
00348 <span class="comment">//---------------------------------------------------------</span>
00349 
<a name="l00350"></a><a class="code" href="classSeq.html#d3">00350</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#d3">Seq::startTransport</a>()
00351       {
00352       <span class="comment">// dont start transport, if we have nothing to play</span>
00353       <span class="comment">//</span>
00354       <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r14">endTick</a>) {
00355             <a class="code" href="classSeq.html#d0">toGui</a>(<span class="charliteral">'1'</span>);
00356             <a class="code" href="classSeq.html#r2">state</a> = <a class="code" href="classSeq.html#w3w1">PLAY</a>;
00357             }
00358       }
00359 
00360 <span class="comment">//---------------------------------------------------------</span>
00361 <span class="comment">//   process</span>
00362 <span class="comment">//---------------------------------------------------------</span>
00363 
<a name="l00364"></a><a class="code" href="classSeq.html#a6">00364</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#a6">Seq::process</a>(<span class="keywordtype">unsigned</span> frames)
00365       {
00366       <span class="keywordtype">int</span> jackState = <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a10">getState</a>();
00367       <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r2">state</a> == <a class="code" href="classSeq.html#w3w2">START_PLAY</a> &amp;&amp; jackState == <a class="code" href="classSeq.html#w3w1">PLAY</a>) {
00368             <a class="code" href="classSeq.html#d3">startTransport</a>();
00369             }
00370       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r2">state</a> == <a class="code" href="classSeq.html#w3w1">PLAY</a> &amp;&amp; jackState == <a class="code" href="classSeq.html#w3w0">STOP</a>) {
00371             <a class="code" href="classSeq.html#d2">stopTransport</a>();
00372             }
00373       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r2">state</a> == <a class="code" href="classSeq.html#w3w2">START_PLAY</a> &amp;&amp; jackState == <a class="code" href="classSeq.html#w3w0">STOP</a>) {
00374             <a class="code" href="classSeq.html#d2">stopTransport</a>();
00375             }
00376       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r2">state</a> == <a class="code" href="classSeq.html#w3w0">STOP</a> &amp;&amp; jackState == <a class="code" href="classSeq.html#w3w1">PLAY</a>) {
00377             <a class="code" href="classSeq.html#d3">startTransport</a>();
00378             }
00379       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r2">state</a> != jackState)
00380             printf(<span class="stringliteral">"JACK: state transition %d -&gt; %d ?\n"</span>,
00381                <a class="code" href="classSeq.html#r2">state</a>, jackState);
00382 
00383       <span class="keywordtype">float</span>* lbuffer = <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a6">getLBuffer</a>(frames);
00384       <span class="keywordtype">float</span>* rbuffer = <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a7">getRBuffer</a>(frames);
00385       <span class="keywordtype">float</span>* l = lbuffer;
00386       <span class="keywordtype">float</span>* r = rbuffer;
00387 
00388       <a class="code" href="seq_8h.html#a0">EList</a> pe;   <span class="comment">// events to play in this cycle</span>
00389 
00390       <span class="comment">//</span>
00391       <span class="comment">// read messages from gui</span>
00392       <span class="comment">//</span>
00393       <a class="code" href="structSeqMsg.html">SeqMsg</a> msg;
00394       <span class="keywordflow">while</span> (read(<a class="code" href="classSeq.html#r6">fromThreadFdr</a>, &amp;msg, <span class="keyword">sizeof</span>(<a class="code" href="structSeqMsg.html">SeqMsg</a>)) == <span class="keyword">sizeof</span>(SeqMsg)) {
00395             <span class="keywordflow">switch</span>(msg.<a class="code" href="structSeqMsg.html#o0">id</a>) {
00396                   <span class="keywordflow">case</span> <a class="code" href="seq_8h.html#a11a8">SEQ_TEMPO_CHANGE</a>:
00397                         <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o11">tempomap</a>-&gt;<a class="code" href="classTempoList.html#a19">setRelTempo</a>(msg.<a class="code" href="structSeqMsg.html#o1">data1</a>);
00398                         <a class="code" href="classSeq.html#r11">playFrame</a> = <a class="code" href="classSeq.html#d5">tick2frame</a>(<a class="code" href="classSeq.html#r12">playPos</a>-&gt;first);
00399                         <span class="keywordflow">break</span>;
00400 
00401                   <span class="keywordflow">case</span> <a class="code" href="seq_8h.html#a11a9">SEQ_PLAY</a>:
00402                         {
00403                         <a class="code" href="structEvent.html">Event</a> ev;
00404                         ev.<a class="code" href="structEvent.html#o0">type</a>    = msg.<a class="code" href="structSeqMsg.html#o1">data1</a> &amp; 0xf0;
00405                         ev.<a class="code" href="structEvent.html#o1">channel</a> = msg.<a class="code" href="structSeqMsg.html#o1">data1</a> &amp; 0xf;
00406                         ev.<a class="code" href="structEvent.html#o2">val1</a>    = msg.<a class="code" href="structSeqMsg.html#o2">data2</a>;
00407                         ev.<a class="code" href="structEvent.html#o3">val2</a>    = msg.<a class="code" href="structSeqMsg.html#o3">data3</a>;
00408                         ev.<a class="code" href="structEvent.html#o4">note</a>    = 0;
00409                         pe.insert(std::pair&lt;const unsigned, Event&gt; (0, ev));
00410                         }
00411                         <span class="keywordflow">break</span>;
00412                   <span class="keywordflow">default</span>:
00413                         printf(<span class="stringliteral">"unknown seq msg %d\n"</span>, msg.<a class="code" href="structSeqMsg.html#o0">id</a>);
00414                         <span class="keywordflow">break</span>;
00415                   }
00416             }
00417 
00418       <span class="keywordtype">bool</span> eof = <span class="keyword">false</span>;
00419       <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r2">state</a> == <a class="code" href="classSeq.html#w3w1">PLAY</a>) {
00420             <span class="comment">//</span>
00421             <span class="comment">// collect events</span>
00422             <span class="comment">//</span>
00423             <a class="code" href="midi_8h.html#a8">ciEvent</a> s        = <a class="code" href="classSeq.html#r12">playPos</a>;
00424             <span class="keywordtype">int</span> endFrameTick = <a class="code" href="classSeq.html#d4">frame2tick</a>(<a class="code" href="classSeq.html#r11">playFrame</a> + frames);
00425             <a class="code" href="midi_8h.html#a8">ciEvent</a> e        = <a class="code" href="classSeq.html#r8">events</a>.lower_bound(endFrameTick);
00426             <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a8">ciEvent</a> i = s; i != e; ++i)
00427                   pe.insert(*i);
00428             eof = (e == <a class="code" href="classSeq.html#r8">events</a>.end());
00429             playPos = e;
00430 
00431             <span class="keywordtype">int</span> cpos  = <a class="code" href="classSeq.html#r11">playFrame</a>;
00432             <span class="keywordtype">int</span> ctick = frame2tick(cpos);
00433             <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a8">ciEvent</a> i = pe.begin(); i != pe.end(); ++i) {
00434                   <span class="keywordflow">if</span> (ctick &lt; i-&gt;first) {
00435                         <span class="keywordtype">int</span> f = <a class="code" href="classSeq.html#d5">tick2frame</a>(i-&gt;first);
00436                         <span class="keywordtype">int</span> n = f - cpos;
00437                         <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a4">process</a>(n, l, r);
00438                         l += n;
00439                         r += n;
00440                         cpos = f;
00441                         }
00442                   <span class="keywordtype">int</span> key = (i-&gt;second.channel &lt;&lt; 8) | i-&gt;second.val1;
00443                   <span class="keywordflow">if</span> (i-&gt;second.val2) {
00444                         <span class="comment">// note on:</span>
00445                         <a class="code" href="classSeq.html#r10">_activeNotes</a>.insert(std::pair&lt;const int, Event&gt; (key, i-&gt;second));
00446                         }
00447                   <span class="keywordflow">else</span> {
00448                         <span class="comment">// note off; dont "play" note off until a note on was send</span>
00449                         <a class="code" href="seq_8h.html#a6">aEvent</a> ia = <a class="code" href="classSeq.html#r10">_activeNotes</a>.find(key);
00450                         <span class="keywordflow">if</span> (ia == <a class="code" href="classSeq.html#r10">_activeNotes</a>.end())
00451                               <span class="keywordflow">continue</span>;
00452                         <a class="code" href="classSeq.html#r10">_activeNotes</a>.erase(ia);
00453                         }
00454                   <span class="keywordtype">int</span> channel = i-&gt;second.channel;
00455                   <span class="keywordtype">int</span> type    = i-&gt;second.type;
00456                   <span class="keywordflow">if</span> (type == 0x90)
00457                         <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a5">playNote</a>(channel, i-&gt;second.val1, i-&gt;second.val2);
00458                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == 0xb0)
00459                         <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a6">setController</a>(channel, i-&gt;second.val1, i-&gt;second.val2);
00460                   <span class="keywordflow">else</span>
00461                         printf(<span class="stringliteral">"bad event type %x\n"</span>, type);
00462 
00463                   }
00464             playFrame += frames;
00465             <span class="keywordflow">if</span> (cpos &lt; playFrame)
00466                   <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a4">process</a>(playFrame - cpos, l, r);
00467             <span class="keywordflow">if</span> (eof)
00468                   <a class="code" href="classSeq.html#r4">audio</a>-&gt;<a class="code" href="classAudio.html#a8">stopTransport</a>();
00469             }
00470       <span class="keywordflow">else</span> {
00471             <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a8">ciEvent</a> i = pe.begin(); i != pe.end(); ++i) {
00472                   <span class="keywordtype">int</span> channel = i-&gt;second.channel;
00473                   <span class="keywordtype">int</span> type    = i-&gt;second.type;
00474                   <span class="keywordflow">if</span> (type == 0x90)
00475                         <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a5">playNote</a>(channel, i-&gt;second.val1, i-&gt;second.val2);
00476                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == 0xb0)
00477                         <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a6">setController</a>(channel, i-&gt;second.val1, i-&gt;second.val2);
00478                   }
00479             <a class="code" href="classSeq.html#r3">synti</a>-&gt;<a class="code" href="classSynth.html#a4">process</a>(frames, l, r);
00480             }
00481 
00482       <span class="comment">// apply volume:</span>
00483       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; frames; ++i) {
00484             lbuffer[i] *= <a class="code" href="classSeq.html#r15">_volume</a>;
00485             rbuffer[i] *= _volume;
00486             }
00487       }
00488 
00489 <span class="comment">//---------------------------------------------------------</span>
00490 <span class="comment">//   collectEvents</span>
00491 <span class="comment">//---------------------------------------------------------</span>
00492 
<a name="l00493"></a><a class="code" href="classSeq.html#d1">00493</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#d1">Seq::collectEvents</a>()
00494       {
00495       <a class="code" href="classSeq.html#r8">events</a>.clear();
00496 
00497       <span class="keywordtype">int</span> staves = <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00498       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> tr = 0; tr &lt; staves; ++tr) {
00499             <a class="code" href="classStaff.html">Staff</a>* staff  = <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(tr);
00500             <span class="keywordtype">int</span> channel = staff-&gt;<a class="code" href="classStaff.html#a9">midiChannel</a>();
00501 <span class="comment">//            int program = staff-&gt;midiProgram();</span>
00502             <a class="code" href="classSeq.html#a16">setController</a>(channel, <a class="code" href="synti_8h.html#a7a1">CTRL_PROGRAM</a>, staff-&gt;<a class="code" href="classStaff.html#a10">midiProgram</a>());
00503             <a class="code" href="classSeq.html#a16">setController</a>(channel, <a class="code" href="synti_8h.html#a7a3">CTRL_VOLUME</a>, staff-&gt;<a class="code" href="classStaff.html#a11">volume</a>());
00504             <a class="code" href="classSeq.html#a16">setController</a>(channel, <a class="code" href="synti_8h.html#a7a6">CTRL_REVERB_SEND</a>, staff-&gt;<a class="code" href="classStaff.html#a12">reverb</a>());
00505             <a class="code" href="classSeq.html#a16">setController</a>(channel, <a class="code" href="synti_8h.html#a7a5">CTRL_CHORUS_SEND</a>, staff-&gt;<a class="code" href="classStaff.html#a13">chorus</a>());
00506             }
00507 
00508       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> tr = 0; tr &lt; staves; ++tr) {
00509             <a class="code" href="classStaff.html">Staff</a>* staff  = <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(tr);
00510             <span class="keywordtype">int</span> channel = staff-&gt;<a class="code" href="classStaff.html#a9">midiChannel</a>();
00511 
00512             <span class="keywordtype">int</span> gateTime = 80;  <span class="comment">// 100 - legato (100%)</span>
00513             <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00514                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> voice = 0; voice &lt; <a class="code" href="globals_8h.html#a3">VOICES</a>; ++voice) {
00515                         <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00516                               <a class="code" href="classElement.html">Element</a>* el = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(tr * <a class="code" href="globals_8h.html#a3">VOICES</a> + voice);
00517                               <span class="keywordflow">if</span> (el) {
00518                                     <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00519                                           <span class="keywordflow">continue</span>;
00520                                     <a class="code" href="classChord.html">Chord</a>* chord = (<a class="code" href="classChord.html">Chord</a>*)el;
00521                                     <a class="code" href="classNoteList.html">NoteList</a>* nl = chord-&gt;<a class="code" href="classChord.html#a15">noteList</a>();
00522 
00523                                     <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a1">iNote</a> in = nl-&gt;begin(); in != nl-&gt;end(); ++in) {
00524                                           <a class="code" href="classNote.html">Note</a>* note = in-&gt;second;
00525                                           <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classNote.html#a34">tieBack</a>())
00526                                                 <span class="keywordflow">continue</span>;
00527                                           <span class="keywordtype">unsigned</span> len = 0;
00528                                           <span class="keywordflow">while</span> (note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>()) {
00529                                                 <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>()-&gt;<a class="code" href="classTie.html#a6">endNote</a>() == 0)
00530                                                       <span class="keywordflow">break</span>;
00531                                                 len += note-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a76">tickLen</a>();
00532                                                 note = note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>()-&gt;<a class="code" href="classTie.html#a6">endNote</a>();
00533                                                 }
00534                                           len += (note-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a76">tickLen</a>() * gateTime / 100);
00535 
00536                                           <a class="code" href="structEvent.html">Event</a> ev;
00537                                           ev.<a class="code" href="structEvent.html#o0">type</a>       = 0x90; <span class="comment">// note on</span>
00538                                           ev.<a class="code" href="structEvent.html#o2">val1</a>       = note-&gt;<a class="code" href="classNote.html#a15">pitch</a>();
00539                                           ev.<a class="code" href="structEvent.html#o3">val2</a>       = 60;
00540                                           ev.<a class="code" href="structEvent.html#o4">note</a>       = note;
00541                                           ev.<a class="code" href="structEvent.html#o1">channel</a>    = channel;
00542                                           <span class="keywordtype">unsigned</span> tick = chord-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00543                                           <a class="code" href="classSeq.html#r8">events</a>.insert(std::pair&lt;const unsigned, Event&gt; (tick, ev));
00544 
00545                                           ev.<a class="code" href="structEvent.html#o3">val2</a> = 0;
00546                                           <a class="code" href="classSeq.html#r8">events</a>.insert(std::pair&lt;const unsigned, Event&gt; (tick+len, ev));
00547                                           }
00548                                     }
00549                               }
00550                         }
00551                   }
00552             }
00553       <a class="code" href="classMeasure.html">Measure</a>* lm = <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a101">last</a>();
00554       <a class="code" href="classSeq.html#r14">endTick</a>   = lm-&gt;<a class="code" href="classElement.html#a74">tick</a>() + lm-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>();
00555       <a class="code" href="classPlayPanel.html">PlayPanel</a>* pp = <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a6">getPlayPanel</a>();
00556       <span class="keywordflow">if</span> (pp)
00557             pp-&gt;<a class="code" href="classPlayPanel.html#a6">setEndpos</a>(<a class="code" href="classSeq.html#r14">endTick</a>);
00558       <a class="code" href="classSeq.html#r9">playlistValid</a> = <span class="keyword">true</span>;
00559       }
00560 
00561 <span class="comment">//---------------------------------------------------------</span>
00562 <span class="comment">//   heartBeat</span>
00563 <span class="comment">//    paint currently sounding notes</span>
00564 <span class="comment">//---------------------------------------------------------</span>
00565 
<a name="l00566"></a><a class="code" href="classSeq.html#k1">00566</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#k1">Seq::heartBeat</a>()
00567       {
00568       <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r13">guiPos</a> == <a class="code" href="classSeq.html#r12">playPos</a>)
00569             <span class="keywordflow">return</span>;
00570       <a class="code" href="classCanvas.html">Canvas</a>* canvas = <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a46">canvas</a>();
00571       <a class="code" href="classPainter.html">Painter</a> painter(canvas);
00572       painter.setClipRect(QRectF(0, 0, 100000, 100000));
00573 
00574       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a8">ciEvent</a> i = <a class="code" href="classSeq.html#r13">guiPos</a>; i != <a class="code" href="classSeq.html#r12">playPos</a>; ++i) {
00575             <a class="code" href="classNote.html">Note</a>* note = i-&gt;second.note;
00576             <a class="code" href="structSym.html">Sym</a>* head = note-&gt;<a class="code" href="classNote.html#a14">noteHead</a>();
00577             painter.translate(note-&gt;<a class="code" href="classElement.html#a35">apos</a>());
00578             painter.setPen(i-&gt;second.val2 ? Qt::red : Qt::black);
00579             head-&gt;<a class="code" href="structSym.html#a7">draw</a>(painter);
00580             painter.translate(0, 0);
00581 <span class="comment">//TODO            QPaintEvent ev(tf.frect2irect(head-&gt;bbox() + note-&gt;aref()));</span>
00582 <span class="comment">//            canvas-&gt;paintEvent(&amp;ev);</span>
00583             }
00584       <a class="code" href="classPlayPanel.html">PlayPanel</a>* pp = <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a6">getPlayPanel</a>();
00585       <span class="keywordflow">if</span> (pp)
00586             pp-&gt;<a class="code" href="classPlayPanel.html#a1">heartBeat</a>(<a class="code" href="classSeq.html#d4">frame2tick</a>(<a class="code" href="classSeq.html#r11">playFrame</a>));
00587       guiPos = <a class="code" href="classSeq.html#r12">playPos</a>;
00588       }
00589 
00590 <span class="comment">//---------------------------------------------------------</span>
00591 <span class="comment">//   setVolume</span>
00592 <span class="comment">//---------------------------------------------------------</span>
00593 
<a name="l00594"></a><a class="code" href="classSeq.html#i3">00594</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#i3">Seq::setVolume</a>(<span class="keywordtype">float</span> val)
00595       {
00596       <a class="code" href="classSeq.html#r15">_volume</a> = val;
00597       }
00598 
00599 <span class="comment">//---------------------------------------------------------</span>
00600 <span class="comment">//   setTempo</span>
00601 <span class="comment">//---------------------------------------------------------</span>
00602 
<a name="l00603"></a><a class="code" href="classSeq.html#i4">00603</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#i4">Seq::setTempo</a>(<span class="keywordtype">int</span> relTempo)
00604       {
00605       <a class="code" href="structSeqMsg.html">SeqMsg</a> msg;
00606       msg.<a class="code" href="structSeqMsg.html#o0">id</a> = <a class="code" href="seq_8h.html#a11a8">SEQ_TEMPO_CHANGE</a>;
00607       msg.<a class="code" href="structSeqMsg.html#o1">data1</a> = relTempo;
00608       <a class="code" href="classSeq.html#a14">sendMessage</a>(msg);
00609 
00610       <span class="keywordtype">int</span> tempo = <a class="code" href="classSeq.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o11">tempomap</a>-&gt;<a class="code" href="classTempoList.html#a5">tempo</a>(<a class="code" href="classSeq.html#r12">playPos</a>-&gt;first) * 100 / relTempo;
00611 
00612       <a class="code" href="classPlayPanel.html">PlayPanel</a>* pp = <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a6">getPlayPanel</a>();
00613       <span class="keywordflow">if</span> (pp)
00614             pp-&gt;<a class="code" href="classPlayPanel.html#a4">setTempo</a>(tempo);
00615       }
00616 
00617 <span class="comment">//---------------------------------------------------------</span>
00618 <span class="comment">//   setPos</span>
00619 <span class="comment">//---------------------------------------------------------</span>
00620 
<a name="l00621"></a><a class="code" href="classSeq.html#i5">00621</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#i5">Seq::setPos</a>(<span class="keywordtype">int</span> tick)
00622       {
00623       <span class="keywordflow">if</span> (<a class="code" href="classSeq.html#r2">state</a> != <a class="code" href="classSeq.html#w3w0">STOP</a>)
00624             <span class="keywordflow">return</span>;
00625       <a class="code" href="classSeq.html#r11">playFrame</a> = <a class="code" href="classSeq.html#d5">tick2frame</a>(tick);
00626       <a class="code" href="classSeq.html#r12">playPos</a>   = <a class="code" href="classSeq.html#r8">events</a>.lower_bound(tick);
00627       <a class="code" href="classSeq.html#r13">guiPos</a>    = <a class="code" href="classSeq.html#r12">playPos</a>;
00628       <a class="code" href="classPlayPanel.html">PlayPanel</a>* pp = <a class="code" href="project_8cpp.html#a2">mscore</a>-&gt;<a class="code" href="classMuseScore.html#a6">getPlayPanel</a>();
00629       <span class="keywordflow">if</span> (pp)
00630             pp-&gt;<a class="code" href="classPlayPanel.html#a1">heartBeat</a>(tick);
00631       }
00632 
00633 <span class="comment">//---------------------------------------------------------</span>
00634 <span class="comment">//   sendMessage</span>
00635 <span class="comment">//    send Message to sequencer</span>
00636 <span class="comment">//---------------------------------------------------------</span>
00637 
<a name="l00638"></a><a class="code" href="classSeq.html#a14">00638</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#a14">Seq::sendMessage</a>(<a class="code" href="structSeqMsg.html">SeqMsg</a>&amp; msg)<span class="keyword"> const</span>
00639 <span class="keyword">      </span>{
00640       <span class="keywordflow">if</span> (!<a class="code" href="classSeq.html#r1">running</a>)
00641             <span class="keywordflow">return</span>;
00642       <span class="keywordflow">if</span> (write(<a class="code" href="classSeq.html#r5">fromThreadFdw</a>, &amp;msg, <span class="keyword">sizeof</span>(<a class="code" href="structSeqMsg.html">SeqMsg</a>)) != <span class="keyword">sizeof</span>(SeqMsg)) {
00643             fprintf(stderr, <span class="stringliteral">"sendMessage to sequencer failed: %s\n"</span>,
00644                strerror(errno));
00645             }
00646       }
00647 
00648 <span class="comment">//---------------------------------------------------------</span>
00649 <span class="comment">//   playNote</span>
00650 <span class="comment">//---------------------------------------------------------</span>
00651 
<a name="l00652"></a><a class="code" href="classSeq.html#a15">00652</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#a15">Seq::playNote</a>(<span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> pitch, <span class="keywordtype">int</span> velo)<span class="keyword"> const</span>
00653 <span class="keyword">      </span>{
00654       <a class="code" href="structSeqMsg.html">SeqMsg</a> msg;
00655       msg.<a class="code" href="structSeqMsg.html#o0">id</a>    = <a class="code" href="seq_8h.html#a11a9">SEQ_PLAY</a>;
00656       msg.<a class="code" href="structSeqMsg.html#o1">data1</a> = 0x90 | channel;
00657       msg.<a class="code" href="structSeqMsg.html#o2">data2</a> = pitch;
00658       msg.<a class="code" href="structSeqMsg.html#o3">data3</a> = velo;
00659       <a class="code" href="classSeq.html#a14">sendMessage</a>(msg);
00660       }
00661 
00662 <span class="comment">//---------------------------------------------------------</span>
00663 <span class="comment">//   setController</span>
00664 <span class="comment">//---------------------------------------------------------</span>
00665 
<a name="l00666"></a><a class="code" href="classSeq.html#a16">00666</a> <span class="keywordtype">void</span> <a class="code" href="classSeq.html#a16">Seq::setController</a>(<span class="keywordtype">int</span> channel, <span class="keywordtype">int</span> ctrl, <span class="keywordtype">int</span> data)<span class="keyword"> const</span>
00667 <span class="keyword">      </span>{
00668       <a class="code" href="structSeqMsg.html">SeqMsg</a> msg;
00669       msg.<a class="code" href="structSeqMsg.html#o0">id</a>    = <a class="code" href="seq_8h.html#a11a9">SEQ_PLAY</a>;
00670       msg.<a class="code" href="structSeqMsg.html#o1">data1</a> = 0xb0 | channel;
00671       msg.<a class="code" href="structSeqMsg.html#o2">data2</a> = ctrl;
00672       msg.<a class="code" href="structSeqMsg.html#o3">data3</a> = data;
00673       <a class="code" href="classSeq.html#a14">sendMessage</a>(msg);
00674       }
00675 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
