<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: undo.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>undo.cpp</h1><a href="undo_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: undo.cpp,v 1.31 2005/06/26 09:17:49 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2005 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="undo_8h.html">undo.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="element_8h.html">element.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="select_8h.html">select.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="input_8h.html">input.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00021 
00022 <span class="keyword">extern</span> <a class="code" href="classMeasure.html">Measure</a>* <a class="code" href="undo_8cpp.html#a3">tick2measure</a>(<span class="keywordtype">int</span> tick);
00023 
<a name="l00024"></a><a class="code" href="undo_8cpp.html#a0">00024</a> <span class="keyword">extern</span> QAction* <a class="code" href="mscore_8cpp.html#a11">undoAction</a>;
<a name="l00025"></a><a class="code" href="undo_8cpp.html#a1">00025</a> <span class="keyword">extern</span> QAction* <a class="code" href="mscore_8cpp.html#a12">redoAction</a>;
00026 
<a name="l00027"></a><a class="code" href="undo_8cpp.html#a2">00027</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="undo_8cpp.html#a2">undoName</a>[] = {
00028       <span class="stringliteral">"RemoveObject"</span>, <span class="stringliteral">"AddObject"</span>,
00029       <span class="stringliteral">"InsertPart"</span>, <span class="stringliteral">"RemovePart"</span>,
00030       <span class="stringliteral">"InsertStaff"</span>, <span class="stringliteral">"RemoveStaff"</span>,
00031       <span class="stringliteral">"InsertSegStaff"</span>, <span class="stringliteral">"RemoveSegStaff"</span>,
00032       <span class="stringliteral">"InsertMStaff"</span>, <span class="stringliteral">"RemoveMStaff"</span>,
00033       <span class="stringliteral">"InsertMeasure"</span>, <span class="stringliteral">"RemoveMeasure"</span>,
00034       <span class="stringliteral">"SortStaves"</span>,
00035       };
00036 
00037 <span class="comment">//---------------------------------------------------------</span>
00038 <span class="comment">//   name</span>
00039 <span class="comment">//---------------------------------------------------------</span>
00040 
<a name="l00041"></a><a class="code" href="structUndoOp.html#a0">00041</a> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="structUndoOp.html#a0">UndoOp::name</a>()<span class="keyword"> const</span>
00042 <span class="keyword">      </span>{
00043       <span class="keywordflow">return</span> <a class="code" href="undo_8cpp.html#a2">undoName</a>[<a class="code" href="structUndoOp.html#o0">type</a>];
00044       }
00045 
00046 <span class="comment">//---------------------------------------------------------</span>
00047 <span class="comment">//   Undo</span>
00048 <span class="comment">//---------------------------------------------------------</span>
00049 
<a name="l00050"></a><a class="code" href="structUndo.html#a0">00050</a> <a class="code" href="structUndo.html#a0">Undo::Undo</a>(<span class="keyword">const</span> <a class="code" href="structInputState.html">InputState</a>&amp; is, <span class="keyword">const</span> <a class="code" href="classSelection.html">Selection</a>&amp; s)
00051       {
00052       <a class="code" href="structUndo.html#o0">inputState</a> = is;
00053       <a class="code" href="structUndo.html#o1">selection</a>  = s;
00054       }
00055 
<a name="l00056"></a><a class="code" href="structUndo.html#a1">00056</a> <a class="code" href="structUndo.html#a1">Undo::~Undo</a>()
00057       {
00058       }
00059 
00060 <span class="comment">//---------------------------------------------------------</span>
00061 <span class="comment">//    startUndo</span>
00062 <span class="comment">//---------------------------------------------------------</span>
00063 
<a name="l00064"></a><a class="code" href="classScore.html#a31">00064</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a31">Score::startUndo</a>()
00065       {
00066 <span class="comment">// printf("start undo\n");</span>
00067       <span class="keywordflow">if</span> (<a class="code" href="classScore.html#r20">undoActive</a>) {
00068             fprintf(stderr, <span class="stringliteral">"startUndo: already active\n"</span>);
00069             abort();
00070             }
00071       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(<span class="keyword">new</span> <a class="code" href="structUndo.html">Undo</a>(*<a class="code" href="input_8h.html#a0">cis</a>, *<a class="code" href="classScore.html#o14">sel</a>));
00072 
00073 <span class="comment">/*      ElementList*el = sel-&gt;elements();</span>
00074 <span class="comment">printf("StartUndo: ==store selection %d\n", el-&gt;size());</span>
00075 <span class="comment">      for (iElement i = el-&gt;begin(); i != el-&gt;end(); ++i)</span>
00076 <span class="comment">            printf("  sel %p\n", *i);</span>
00077 <span class="comment">  */</span>
00078       <a class="code" href="classScore.html#r20">undoActive</a> = <span class="keyword">true</span>;
00079       }
00080 
00081 <span class="comment">//---------------------------------------------------------</span>
00082 <span class="comment">//   endUndo</span>
00083 <span class="comment">//---------------------------------------------------------</span>
00084 
<a name="l00085"></a><a class="code" href="classScore.html#a32">00085</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a32">Score::endUndo</a>()
00086       {
00087 <span class="comment">// printf("   end undo\n");</span>
00088       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00089             fprintf(stderr, <span class="stringliteral">"endUndo: not active\n"</span>);
00090             abort();
00091             }
00092 
00093       <span class="keywordflow">if</span> (<a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;empty()) {
00094             <span class="comment">// nothing to undo</span>
00095             <span class="keyword">delete</span> <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00096             <a class="code" href="classScore.html#r18">undoList</a>.pop_back();
00097             }
00098       <span class="keywordflow">else</span> {
00099 <span class="preprocessor">#if 0</span>
00100 <span class="preprocessor"></span>            <a class="code" href="structUndo.html">Undo</a>* u = <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00101 
00102             <a class="code" href="classElementList.html">ElementList</a>*el = u-&gt;<a class="code" href="structUndo.html#o1">selection</a>.<a class="code" href="classSelection.html#a0">elements</a>();
00103 printf(<span class="stringliteral">"EndUndo: %d ==store selection %d\n"</span>, <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;size(), el-&gt;size());
00104             <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = el-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != el-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00105                   printf(<span class="stringliteral">"  sel %p\n"</span>, *i);
00106 <span class="preprocessor">#endif</span>
00107 <span class="preprocessor"></span>            <a class="code" href="classScore.html#o2">dirty</a> = <span class="keyword">true</span>;
00108             <span class="keywordflow">for</span> (<a class="code" href="undo_8h.html#a2">iUndo</a> i = <a class="code" href="classScore.html#r19">redoList</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classScore.html#r19">redoList</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00109                   <span class="keyword">delete</span> *i;
00110             <a class="code" href="classScore.html#r19">redoList</a>.clear();
00111             <a class="code" href="mscore_8cpp.html#a11">undoAction</a>-&gt;setEnabled(<span class="keyword">true</span>);
00112             <a class="code" href="mscore_8cpp.html#a12">redoAction</a>-&gt;setEnabled(<span class="keyword">false</span>);
00113             }
00114       <a class="code" href="classScore.html#r20">undoActive</a> = <span class="keyword">false</span>;
00115       }
00116 
00117 <span class="comment">//---------------------------------------------------------</span>
00118 <span class="comment">//   doUndo</span>
00119 <span class="comment">//---------------------------------------------------------</span>
00120 
<a name="l00121"></a><a class="code" href="classScore.html#i8">00121</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#i8">Score::doUndo</a>()
00122       {
00123       <a class="code" href="classSelection.html">Selection</a> oSel(*<a class="code" href="classScore.html#o14">sel</a>);
00124       <a class="code" href="structInputState.html">InputState</a> oIs(*<a class="code" href="input_8h.html#a0">cis</a>);
00125       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a3">deselectAll</a>(<span class="keyword">this</span>);
00126       <a class="code" href="structUndo.html">Undo</a>* u = <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00127 <span class="comment">// printf("doUndo %d\n", u-&gt;size());</span>
00128       <span class="keywordflow">for</span> (<a class="code" href="undo_8h.html#a1">riUndoOp</a> i = u-&gt;rbegin(); i != u-&gt;rend(); ++i) {
00129 <span class="comment">// printf("   doUndo %s\n", i-&gt;name());</span>
00130             <span class="keywordflow">switch</span>(i-&gt;type) {
00131                   <span class="keywordflow">case</span> UndoOp::RemoveObject:
00132                         <a class="code" href="classScore.html#a60">addObject</a>(i-&gt;obj);
00133                         <span class="keywordflow">break</span>;
00134                   <span class="keywordflow">case</span> UndoOp::AddObject:
00135                         <a class="code" href="classScore.html#a61">removeObject</a>(i-&gt;obj);
00136                         <span class="keywordflow">break</span>;
00137                   <span class="keywordflow">case</span> UndoOp::InsertPart:
00138                         <a class="code" href="classScore.html#a14">removePart</a>(i-&gt;part);
00139                         <span class="keywordflow">break</span>;
00140                   <span class="keywordflow">case</span> UndoOp::RemovePart:
00141                         <a class="code" href="classScore.html#a12">insertPart</a>(i-&gt;part, i-&gt;idx);
00142                         <span class="keywordflow">break</span>;
00143                   <span class="keywordflow">case</span> UndoOp::InsertStaff:
00144                         <a class="code" href="classScore.html#a16">removeStaff</a>(i-&gt;staff);
00145                         <span class="keywordflow">break</span>;
00146                   <span class="keywordflow">case</span> UndoOp::RemoveStaff:
00147                         <a class="code" href="classScore.html#a15">insertStaff</a>(i-&gt;staff, i-&gt;idx);
00148                         <span class="keywordflow">break</span>;
00149                   <span class="keywordflow">case</span> UndoOp::InsertSegStaff:
00150                         i-&gt;segment-&gt;removeStaff(i-&gt;idx);
00151                         <span class="keywordflow">break</span>;
00152                   <span class="keywordflow">case</span> UndoOp::RemoveSegStaff:
00153                         i-&gt;segment-&gt;insertStaff(i-&gt;idx);
00154                         <span class="keywordflow">break</span>;
00155                   <span class="keywordflow">case</span> UndoOp::InsertMStaff:
00156                         i-&gt;measure-&gt;removeMStaff(i-&gt;mstaff, i-&gt;idx);
00157                         <span class="keywordflow">break</span>;
00158                   <span class="keywordflow">case</span> UndoOp::RemoveMStaff:
00159                         i-&gt;measure-&gt;insertMStaff(i-&gt;mstaff, i-&gt;idx);
00160                         <span class="keywordflow">break</span>;
00161                   <span class="keywordflow">case</span> UndoOp::InsertMeasure:
00162                         <a class="code" href="classScore.html#a19">removeMeasure</a>(i-&gt;measure-&gt;tick());
00163                         <span class="keywordflow">break</span>;
00164                   <span class="keywordflow">case</span> UndoOp::RemoveMeasure:
00165                         <a class="code" href="classScore.html#a18">addMeasure</a>(i-&gt;measure);
00166                         <span class="keywordflow">break</span>;
00167                   <span class="keywordflow">case</span> UndoOp::SortStaves:
00168                         <a class="code" href="classScore.html#a111">sortStaves</a>(i-&gt;di, i-&gt;si);
00169                         <span class="keywordflow">break</span>;
00170                   }
00171             }
00172       <a class="code" href="classScore.html#r19">redoList</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(u); <span class="comment">// put item on redo list</span>
00173       <a class="code" href="classScore.html#r18">undoList</a>.pop_back();
00174       <a class="code" href="classScore.html#a58">endUndoRedo</a>(u);
00175       u-&gt;<a class="code" href="structUndo.html#o0">inputState</a> = oIs;
00176       u-&gt;<a class="code" href="structUndo.html#o1">selection</a>  = oSel;
00177       }
00178 
00179 <span class="comment">//---------------------------------------------------------</span>
00180 <span class="comment">//   doRedo</span>
00181 <span class="comment">//---------------------------------------------------------</span>
00182 
<a name="l00183"></a><a class="code" href="classScore.html#i9">00183</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#i9">Score::doRedo</a>()
00184       {
00185       <a class="code" href="classSelection.html">Selection</a> oSel(*<a class="code" href="classScore.html#o14">sel</a>);
00186       <a class="code" href="structInputState.html">InputState</a> oIs(*<a class="code" href="input_8h.html#a0">cis</a>);
00187 
00188       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a3">deselectAll</a>(<span class="keyword">this</span>);
00189       <a class="code" href="structUndo.html">Undo</a>* u = <a class="code" href="classScore.html#r19">redoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00190       <span class="keywordflow">for</span> (<a class="code" href="undo_8h.html#a0">iUndoOp</a> i = u-&gt;begin(); i != u-&gt;end(); ++i) {
00191             <span class="keywordflow">switch</span>(i-&gt;type) {
00192                   <span class="keywordflow">case</span> UndoOp::RemoveObject:
00193                         <a class="code" href="classScore.html#a61">removeObject</a>(i-&gt;obj);
00194                         <span class="keywordflow">break</span>;
00195                   <span class="keywordflow">case</span> UndoOp::AddObject:
00196                         <a class="code" href="classScore.html#a60">addObject</a>(i-&gt;obj);
00197                         <span class="keywordflow">break</span>;
00198                   <span class="keywordflow">case</span> UndoOp::InsertPart:
00199                         <a class="code" href="classScore.html#a12">insertPart</a>(i-&gt;part, i-&gt;idx);
00200                         <span class="keywordflow">break</span>;
00201                   <span class="keywordflow">case</span> UndoOp::RemovePart:
00202                         <a class="code" href="classScore.html#a14">removePart</a>(i-&gt;part);
00203                         <span class="keywordflow">break</span>;
00204                   <span class="keywordflow">case</span> UndoOp::InsertStaff:
00205                         <a class="code" href="classScore.html#a15">insertStaff</a>(i-&gt;staff, i-&gt;idx);
00206                         <span class="keywordflow">break</span>;
00207                   <span class="keywordflow">case</span> UndoOp::RemoveStaff:
00208                         <a class="code" href="classScore.html#a16">removeStaff</a>(i-&gt;staff);
00209                         <span class="keywordflow">break</span>;
00210                   <span class="keywordflow">case</span> UndoOp::InsertSegStaff:
00211                         i-&gt;segment-&gt;insertStaff(i-&gt;idx);
00212                         <span class="keywordflow">break</span>;
00213                   <span class="keywordflow">case</span> UndoOp::RemoveSegStaff:
00214                         i-&gt;segment-&gt;removeStaff(i-&gt;idx);
00215                         <span class="keywordflow">break</span>;
00216                   <span class="keywordflow">case</span> UndoOp::InsertMStaff:
00217                         i-&gt;measure-&gt;insertMStaff(i-&gt;mstaff, i-&gt;idx);
00218                         <span class="keywordflow">break</span>;
00219                   <span class="keywordflow">case</span> UndoOp::RemoveMStaff:
00220                         i-&gt;measure-&gt;removeMStaff(i-&gt;mstaff, i-&gt;idx);
00221                         <span class="keywordflow">break</span>;
00222                   <span class="keywordflow">case</span> UndoOp::InsertMeasure:
00223                         <a class="code" href="classScore.html#a18">addMeasure</a>(i-&gt;measure);
00224                         <span class="keywordflow">break</span>;
00225                   <span class="keywordflow">case</span> UndoOp::RemoveMeasure:
00226                         i-&gt;measure-&gt;score()-&gt;removeMeasure(i-&gt;measure-&gt;tick());
00227                         <span class="keywordflow">break</span>;
00228                   <span class="keywordflow">case</span> UndoOp::SortStaves:
00229                         <a class="code" href="classScore.html#a111">sortStaves</a>(i-&gt;si, i-&gt;di);
00230                         <span class="keywordflow">break</span>;
00231                   }
00232             }
00233       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(u); <span class="comment">// put item on undo list</span>
00234       <a class="code" href="classScore.html#r19">redoList</a>.pop_back();
00235       <a class="code" href="classScore.html#a58">endUndoRedo</a>(u);
00236       u-&gt;<a class="code" href="structUndo.html#o0">inputState</a> = oIs;
00237       u-&gt;<a class="code" href="structUndo.html#o1">selection</a>  = oSel;
00238       }
00239 
00240 <span class="comment">//---------------------------------------------------------</span>
00241 <span class="comment">//   endUndoRedo</span>
00242 <span class="comment">//---------------------------------------------------------</span>
00243 
<a name="l00244"></a><a class="code" href="classScore.html#a58">00244</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a58">Score::endUndoRedo</a>(<a class="code" href="structUndo.html">Undo</a>* undo)
00245       {
00246       <a class="code" href="mscore_8cpp.html#a11">undoAction</a>-&gt;setEnabled(!<a class="code" href="classScore.html#r18">undoList</a>.empty());
00247       <a class="code" href="mscore_8cpp.html#a12">redoAction</a>-&gt;setEnabled(!<a class="code" href="classScore.html#r19">redoList</a>.empty());
00248       <a class="code" href="classScore.html#o2">dirty</a> = <span class="keyword">true</span>;
00249 
00250       *<a class="code" href="input_8h.html#a0">cis</a> = undo-&gt;<a class="code" href="structUndo.html#o0">inputState</a>;
00251       <a class="code" href="classScore.html#d8">moveCursor</a>();
00252       *<a class="code" href="classScore.html#o14">sel</a> = undo-&gt;<a class="code" href="structUndo.html#o1">selection</a>;
00253       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a9">update</a>();
00254       <a class="code" href="classScore.html#a49">layout</a>();
00255       <a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">false</span>);
00256       }
00257 
00258 <span class="comment">//---------------------------------------------------------</span>
00259 <span class="comment">//   undoOp</span>
00260 <span class="comment">//---------------------------------------------------------</span>
00261 
<a name="l00262"></a><a class="code" href="classScore.html#a39">00262</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a33">Score::undoOp</a>(UndoOp::UndoType type, <a class="code" href="classElement.html">Element</a>* object)
00263       {
00264       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00265             fprintf(stderr, <span class="stringliteral">"undoOp: undo not started\n"</span>);
00266             abort();
00267             }
00268       assert(type == UndoOp::RemoveObject || type == UndoOp::AddObject);
00269       <a class="code" href="structUndoOp.html">UndoOp</a> i;
00270       i.<a class="code" href="structUndoOp.html#o0">type</a>  = type;
00271       i.<a class="code" href="structUndoOp.html#o1">obj</a>  = object;
00272       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;push_back(i);
00273       }
00274 
00275 <span class="comment">//---------------------------------------------------------</span>
00276 <span class="comment">//   undoOp</span>
00277 <span class="comment">//---------------------------------------------------------</span>
00278 
<a name="l00279"></a><a class="code" href="classScore.html#a38">00279</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a33">Score::undoOp</a>(UndoOp::UndoType type, <a class="code" href="classSegment.html">Segment</a>* seg, <span class="keywordtype">int</span> staff)
00280       {
00281       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00282             fprintf(stderr, <span class="stringliteral">"undoOp: undo not started\n"</span>);
00283             abort();
00284             }
00285       assert(type == UndoOp::InsertSegStaff || type == UndoOp::RemoveSegStaff);
00286       <a class="code" href="structUndoOp.html">UndoOp</a> i;
00287       i.<a class="code" href="structUndoOp.html#o0">type</a>    = type;
00288       i.<a class="code" href="structUndoOp.html#o7">segment</a> = seg;
00289       i.<a class="code" href="structUndoOp.html#o10">idx</a>     = staff;
00290       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;push_back(i);
00291       }
00292 
<a name="l00293"></a><a class="code" href="classScore.html#a37">00293</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a33">Score::undoOp</a>(UndoOp::UndoType type, <a class="code" href="classPart.html">Part</a>* part, <span class="keywordtype">int</span> idx)
00294       {
00295       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00296             fprintf(stderr, <span class="stringliteral">"undoOp: undo not started\n"</span>);
00297             abort();
00298             }
00299       <a class="code" href="structUndoOp.html">UndoOp</a> i;
00300       i.<a class="code" href="structUndoOp.html#o0">type</a> = type;
00301       i.<a class="code" href="structUndoOp.html#o2">part</a> = part;
00302       i.<a class="code" href="structUndoOp.html#o10">idx</a>  = idx;
00303       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;push_back(i);
00304       }
00305 
<a name="l00306"></a><a class="code" href="classScore.html#a36">00306</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a33">Score::undoOp</a>(UndoOp::UndoType type, <a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> idx)
00307       {
00308       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00309             fprintf(stderr, <span class="stringliteral">"undoOp: undo not started\n"</span>);
00310             abort();
00311             }
00312       <a class="code" href="structUndoOp.html">UndoOp</a> i;
00313       i.<a class="code" href="structUndoOp.html#o0">type</a>  = type;
00314       i.<a class="code" href="structUndoOp.html#o3">staff</a> = staff;
00315       i.<a class="code" href="structUndoOp.html#o10">idx</a>   = idx;
00316       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;push_back(i);
00317       }
00318 
<a name="l00319"></a><a class="code" href="classScore.html#a35">00319</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a33">Score::undoOp</a>(UndoOp::UndoType type, <a class="code" href="classMeasure.html">Measure</a>* m, <a class="code" href="structMStaff.html">MStaff</a> s, <span class="keywordtype">int</span> staff)
00320       {
00321       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00322             fprintf(stderr, <span class="stringliteral">"undoOp: undo not started\n"</span>);
00323             abort();
00324             }
00325       <a class="code" href="structUndoOp.html">UndoOp</a> i;
00326       i.<a class="code" href="structUndoOp.html#o0">type</a>    = type;
00327       i.<a class="code" href="structUndoOp.html#o6">measure</a> = m;
00328       i.<a class="code" href="structUndoOp.html#o4">mstaff</a>  = s;
00329       i.<a class="code" href="structUndoOp.html#o10">idx</a>     = staff;
00330       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;push_back(i);
00331       }
00332 
<a name="l00333"></a><a class="code" href="classScore.html#a34">00333</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a33">Score::undoOp</a>(UndoOp::UndoType type, <a class="code" href="classMeasure.html">Measure</a>* m)
00334       {
00335       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00336             fprintf(stderr, <span class="stringliteral">"undoOp: undo not started\n"</span>);
00337             abort();
00338             }
00339       <a class="code" href="structUndoOp.html">UndoOp</a> i;
00340       i.<a class="code" href="structUndoOp.html#o0">type</a>    = type;
00341       i.<a class="code" href="structUndoOp.html#o6">measure</a> = m;
00342       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;push_back(i);
00343       }
00344 
<a name="l00345"></a><a class="code" href="classScore.html#a33">00345</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a33">Score::undoOp</a>(std::list&lt;int&gt; si, std::list&lt;int&gt; di)
00346       {
00347       <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#r20">undoActive</a>) {
00348             fprintf(stderr, <span class="stringliteral">"undoOp: undo not started\n"</span>);
00349             abort();
00350             }
00351       <a class="code" href="structUndoOp.html">UndoOp</a> i;
00352       i.<a class="code" href="structUndoOp.html#o0">type</a> = UndoOp::SortStaves;
00353       i.<a class="code" href="structUndoOp.html#o8">si</a>   = si;
00354       i.<a class="code" href="structUndoOp.html#o9">di</a>   = di;
00355       <a class="code" href="classScore.html#r18">undoList</a>.<a class="code" href="classpstl_1_1plist.html#a11">back</a>()-&gt;push_back(i);
00356       }
00357 
00358 <span class="comment">//---------------------------------------------------------</span>
00359 <span class="comment">//   addObject</span>
00360 <span class="comment">//---------------------------------------------------------</span>
00361 
<a name="l00362"></a><a class="code" href="classScore.html#a60">00362</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a60">Score::addObject</a>(<a class="code" href="classElement.html">Element</a>* element)
00363       {
00364 <span class="comment">// printf("Score::addObject %p %s parent %s\n", element, element-&gt;name(), element-&gt;parent()-&gt;name());</span>
00365       element-&gt;<a class="code" href="classElement.html#a10">parent</a>()-&gt;<a class="code" href="classElement.html#a64">add</a>(element);
00366 
00367       <span class="keywordflow">if</span> (element-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a22">CLEF</a>) {
00368             <span class="keywordtype">int</span> staffIdx = element-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00369             <a class="code" href="classClef.html">Clef</a>* clef   = (<a class="code" href="classClef.html">Clef</a>*) element;
00370             <a class="code" href="classClefList.html">ClefList</a>* ct = <a class="code" href="classScore.html#a7">staff</a>(staffIdx)-&gt;clef();
00371             <span class="keywordtype">int</span> tick     = clef-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00372             ct-&gt;<a class="code" href="classClefList.html#a2">setClef</a>(clef-&gt;<a class="code" href="classElement.html#a74">tick</a>(), clef-&gt;<a class="code" href="classClef.html#a5">idx</a>());
00373 
00374             <span class="comment">//-----------------------------------------------</span>
00375             <span class="comment">//   move notes</span>
00376             <span class="comment">//-----------------------------------------------</span>
00377 
00378             <span class="keywordtype">bool</span> endFound = <span class="keyword">false</span>;
00379             <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* measure = <a class="code" href="classScore.html#a100">first</a>(); measure; measure = measure-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00380                   <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = measure-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00381                         <span class="keywordtype">int</span> startTrack = staffIdx * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00382                         <span class="keywordtype">int</span> endTrack   = startTrack + <a class="code" href="globals_8h.html#a3">VOICES</a>;
00383                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = startTrack; track &lt; endTrack; ++track) {
00384                               <a class="code" href="classElement.html">Element</a>* ie = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00385                               <span class="keywordflow">if</span> (ie &amp;&amp; ie-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a22">CLEF</a> &amp;&amp; ie-&gt;<a class="code" href="classElement.html#a74">tick</a>() &gt; tick) {
00386                                     endFound = <span class="keyword">true</span>;
00387                                     <span class="keywordflow">break</span>;
00388                                     }
00389                               }
00390                         measure-&gt;<a class="code" href="classMeasure.html#a59">layoutNoteHeads</a>(staffIdx);
00391                         <span class="keywordflow">if</span> (endFound)
00392                               <span class="keywordflow">break</span>;
00393                         }
00394                   <span class="keywordflow">if</span> (endFound)
00395                         <span class="keywordflow">break</span>;
00396                   }
00397             }
00398       }
00399 
00400 <span class="comment">//---------------------------------------------------------</span>
00401 <span class="comment">//   removeObject</span>
00402 <span class="comment">//---------------------------------------------------------</span>
00403 
<a name="l00404"></a><a class="code" href="classScore.html#a61">00404</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a61">Score::removeObject</a>(<a class="code" href="classElement.html">Element</a>* element)
00405       {
00406 <span class="comment">// printf("Score::removeObject %p %s parent %s\n", element, element-&gt;name(), element-&gt;parent()-&gt;name());</span>
00407 
00408       <a class="code" href="classElement.html">Element</a>* parent = element-&gt;<a class="code" href="classElement.html#a10">parent</a>();
00409       parent-&gt;<a class="code" href="classElement.html#a65">remove</a>(element);
00410       <span class="keywordflow">if</span> (element-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a22">CLEF</a>) {
00411             <a class="code" href="classClef.html">Clef</a>* clef = (<a class="code" href="classClef.html">Clef</a>*)element;
00412             <span class="keywordtype">int</span> tick  = clef-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00413             <span class="keywordtype">int</span> staffIdx = clef-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00414 
00415             <a class="code" href="classStaff.html">Staff</a>* instr = <a class="code" href="classScore.html#a7">staff</a>(staffIdx);
00416             <a class="code" href="classClefList.html">ClefList</a>* ct = instr-&gt;<a class="code" href="classStaff.html#a2">clef</a>();
00417             ct-&gt;erase(tick);
00418 
00419             <span class="comment">//-----------------------------------------------</span>
00420             <span class="comment">//   move notes</span>
00421             <span class="comment">//-----------------------------------------------</span>
00422 
00423             <span class="keywordtype">bool</span> endFound = <span class="keyword">false</span>;
00424             <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* measure = <a class="code" href="classScore.html#a100">first</a>(); measure; measure = measure-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00425                   <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = measure-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00426                         <span class="keywordtype">int</span> startTrack = staffIdx * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00427                         <span class="keywordtype">int</span> endTrack   = startTrack + <a class="code" href="globals_8h.html#a3">VOICES</a>;
00428                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = startTrack; track &lt; endTrack; ++track) {
00429                               <a class="code" href="classElement.html">Element</a>* ie = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00430                               <span class="keywordflow">if</span> (ie &amp;&amp; ie-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a22">CLEF</a> &amp;&amp; ie-&gt;<a class="code" href="classElement.html#a74">tick</a>() &gt; tick) {
00431                                     endFound = <span class="keyword">true</span>;
00432                                     <span class="keywordflow">break</span>;
00433                                     }
00434                               }
00435                         measure-&gt;<a class="code" href="classMeasure.html#a59">layoutNoteHeads</a>(staffIdx);
00436                         <span class="keywordflow">if</span> (endFound)
00437                               <span class="keywordflow">break</span>;
00438                         }
00439                   <span class="keywordflow">if</span> (endFound)
00440                         <span class="keywordflow">break</span>;
00441                   }
00442             }
00443       }
00444 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:30 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
