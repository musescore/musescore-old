<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: slur.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>slur.cpp</h1><a href="slur_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: slur.cpp,v 1.36 2005/06/22 07:57:08 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="xml_8h.html">xml.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="preferences_8h.html">preferences.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="painter_8h.html">painter.h</a>"</span>
00020 
00021 <span class="comment">//---------------------------------------------------------</span>
00022 <span class="comment">//   SlurSegment</span>
00023 <span class="comment">//---------------------------------------------------------</span>
00024 
<a name="l00025"></a><a class="code" href="classSlurSegment.html#a0">00025</a> <a class="code" href="classSlurSegment.html#a0">SlurSegment::SlurSegment</a>(<a class="code" href="classSlurTie.html">SlurTie</a>* st)
00026    : <a class="code" href="classElement.html">Element</a>(st-&gt;score(), <a class="code" href="element_8h.html#a65a11">SLUR_SEGMENT</a>)
00027       {
00028       <a class="code" href="classSlurSegment.html#r2">slur</a> = st;
00029       <a class="code" href="classSlurSegment.html#r5">mode</a> = 0;
00030       <a class="code" href="classSlurSegment.html#r3">rb</a>   = <span class="keyword">new</span> <a class="code" href="classRubberBand.html">RubberBand</a>(st-&gt;score());
00031       <a class="code" href="classSlurSegment.html#r1">path</a> = 0;
00032       }
00033 
<a name="l00034"></a><a class="code" href="classSlurSegment.html#a2">00034</a> <a class="code" href="classSlurSegment.html#a0">SlurSegment::SlurSegment</a>(<span class="keyword">const</span> <a class="code" href="classSlurSegment.html">SlurSegment</a>&amp; b)
00035    : <a class="code" href="classElement.html">Element</a>(b)
00036       {
00037       <a class="code" href="classSlurSegment.html#r4">bow</a>  = b.<a class="code" href="classSlurSegment.html#r4">bow</a>;
00038       <a class="code" href="classSlurSegment.html#r5">mode</a> = b.<a class="code" href="classSlurSegment.html#r5">mode</a>;
00039       <a class="code" href="classSlurSegment.html#r2">slur</a> = b.<a class="code" href="classSlurSegment.html#r2">slur</a>;
00040       <a class="code" href="classSlurSegment.html#r3">rb</a>   = b.<a class="code" href="classSlurSegment.html#r3">rb</a>-&gt;<a class="code" href="classRubberBand.html#a2">clone</a>();
00041 
00042       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i)
00043             <a class="code" href="classSlurSegment.html#r0">ups</a>[i] = b.<a class="code" href="classSlurSegment.html#r0">ups</a>[i];
00044       <a class="code" href="classSlurSegment.html#r1">path</a> = <span class="keyword">new</span> QPainterPath(*(b.<a class="code" href="classSlurSegment.html#r1">path</a>));
00045       }
00046 
00047 <span class="comment">//---------------------------------------------------------</span>
00048 <span class="comment">//   SlurSegment</span>
00049 <span class="comment">//---------------------------------------------------------</span>
00050 
<a name="l00051"></a><a class="code" href="classSlurSegment.html#a1">00051</a> <a class="code" href="classSlurSegment.html#a1">SlurSegment::~SlurSegment</a>()
00052       {
00053       <span class="keyword">delete</span> <a class="code" href="classSlurSegment.html#r3">rb</a>;
00054       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r1">path</a>)
00055             <span class="keyword">delete</span> <a class="code" href="classSlurSegment.html#r1">path</a>;
00056       }
00057 
00058 <span class="comment">//---------------------------------------------------------</span>
00059 <span class="comment">//   resetMode</span>
00060 <span class="comment">//---------------------------------------------------------</span>
00061 
<a name="l00062"></a><a class="code" href="classSlurSegment.html#a5">00062</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#a5">SlurSegment::resetMode</a>()
00063       {
00064       <a class="code" href="classSlurSegment.html#r5">mode</a> = 0;
00065       <a class="code" href="classSlurSegment.html#d0">bboxUpdate</a>();
00066       }
00067 
00068 <span class="comment">//---------------------------------------------------------</span>
00069 <span class="comment">//   updatePath</span>
00070 <span class="comment">//---------------------------------------------------------</span>
00071 
<a name="l00072"></a><a class="code" href="classSlurSegment.html#d1">00072</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#d1">SlurSegment::updatePath</a>()
00073       {
00074       QPointF pp[4];
00075       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i)
00076             pp[i] = <a class="code" href="classSlurSegment.html#r0">ups</a>[i].<a class="code" href="structUP.html#o0">p</a> + ups[i].off * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00077       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r1">path</a>)
00078             <span class="keyword">delete</span> <a class="code" href="classSlurSegment.html#r1">path</a>;
00079       <a class="code" href="classSlurSegment.html#r1">path</a> = <span class="keyword">new</span> QPainterPath;
00080       QPointF t(0.0, 5.0);    <span class="comment">// thickness of slur</span>
00081       <a class="code" href="classSlurSegment.html#r1">path</a>-&gt;moveTo(pp[0]);
00082       <a class="code" href="classSlurSegment.html#r1">path</a>-&gt;cubicTo(pp[1]-t, pp[2]-t, pp[3]);
00083       <a class="code" href="classSlurSegment.html#r1">path</a>-&gt;cubicTo(pp[2]+t, pp[1]+t, pp[0]);
00084       <a class="code" href="classSlurSegment.html#d0">bboxUpdate</a>();
00085       }
00086 
00087 <span class="comment">//---------------------------------------------------------</span>
00088 <span class="comment">//   move</span>
00089 <span class="comment">//---------------------------------------------------------</span>
00090 
<a name="l00091"></a><a class="code" href="classSlurSegment.html#a16">00091</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#a15">SlurSegment::move</a>(<span class="keyword">const</span> QPointF&amp; s)
00092       {
00093       _pos += s;
00094       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; 4; ++k)
00095             <a class="code" href="classSlurSegment.html#r0">ups</a>[k].<a class="code" href="structUP.html#o0">p</a> += s;
00096       }
00097 
00098 <span class="comment">//---------------------------------------------------------</span>
00099 <span class="comment">//   draw</span>
00100 <span class="comment">//---------------------------------------------------------</span>
00101 
<a name="l00102"></a><a class="code" href="classSlurSegment.html#a8">00102</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#a8">SlurSegment::draw1</a>(<a class="code" href="classPainter.html">Painter</a>&amp; p)<span class="keyword"> const</span>
00103 <span class="keyword">      </span>{
00104       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r1">path</a> == 0)
00105             <span class="keywordflow">return</span>;
00106 <span class="comment">//      int seg = 0;      // todo</span>
00107 <span class="comment">// printf("draw\n");</span>
00108       p.setBrush(<a class="code" href="classElement.html#a14">isSelected</a>() ? <a class="code" href="preferences_8cpp.html#a0">preferences</a>.<a class="code" href="structPreferences.html#o9">selectColor</a>[0] : Qt::black);
00109       p.drawPath(*<a class="code" href="classSlurSegment.html#r1">path</a>);
00110       <span class="keywordflow">if</span> (<a class="code" href="classElement.html#a14">isSelected</a>() &amp;&amp; <a class="code" href="classSlurSegment.html#r5">mode</a>) {
00111             qreal lw = 2.0/p.matrix().m11();
00112             QPen pen(Qt::blue);
00113             pen.setWidthF(lw);
00114             p.setPen(pen);
00115             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i) {
00116                   <span class="keywordflow">if</span> (i == (<a class="code" href="classSlurSegment.html#r5">mode</a>-1))
00117                         p.setBrush(Qt::blue);
00118                   <span class="keywordflow">else</span>
00119                         p.setBrush(Qt::NoBrush);
00120                   p.drawRect(<a class="code" href="classSlurSegment.html#r0">ups</a>[i].r);
00121                   }
00122             }
00123       <span class="keywordflow">if</span> (<a class="code" href="project_8cpp.html#a8">showRubberBand</a> &amp;&amp; (<a class="code" href="classSlurSegment.html#r5">mode</a> == 1 || mode == 4))
00124             <a class="code" href="classSlurSegment.html#r3">rb</a>-&gt;<a class="code" href="classRubberBand.html#a3">draw</a>(p);
00125       }
00126 
00127 <span class="comment">//---------------------------------------------------------</span>
00128 <span class="comment">//   startEdit</span>
00129 <span class="comment">//---------------------------------------------------------</span>
00130 
<a name="l00131"></a><a class="code" href="classSlurSegment.html#a9">00131</a> <span class="keywordtype">bool</span> <a class="code" href="classSlurSegment.html#a9">SlurSegment::startEdit</a>(QMatrix&amp; matrix)
00132       {
00133       <a class="code" href="classSlurSegment.html#r5">mode</a> = 4;
00134       <a class="code" href="classSlurSegment.html#d2">updateGrips</a>(matrix);
00135       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00136       }
00137 
00138 <span class="comment">//---------------------------------------------------------</span>
00139 <span class="comment">//   updateGrips</span>
00140 <span class="comment">//---------------------------------------------------------</span>
00141 
<a name="l00142"></a><a class="code" href="classSlurSegment.html#d2">00142</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#d2">SlurSegment::updateGrips</a>(QMatrix&amp; matrix)
00143       {
00144       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i) {
00145             qreal w = 8.0 / matrix.m11();
00146             qreal h = 8.0 / matrix.m22();
00147             QRectF r(-w/2, -h/2, w, h);
00148             r.translate(<a class="code" href="classSlurSegment.html#r0">ups</a>[i].p + <a class="code" href="classSlurSegment.html#r0">ups</a>[i].off * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00149             <a class="code" href="classSlurSegment.html#r0">ups</a>[i].<a class="code" href="structUP.html#o2">r</a> = r;
00150             }
00151       <a class="code" href="classSlurSegment.html#d1">updatePath</a>();
00152       }
00153 
00154 <span class="comment">//---------------------------------------------------------</span>
00155 <span class="comment">//   endEdit</span>
00156 <span class="comment">//---------------------------------------------------------</span>
00157 
<a name="l00158"></a><a class="code" href="classSlurSegment.html#a10">00158</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#a10">SlurSegment::endEdit</a>()
00159       {
00160       <a class="code" href="classSlurSegment.html#r5">mode</a> = 0;
00161       }
00162 
00163 <span class="comment">//---------------------------------------------------------</span>
00164 <span class="comment">//   editStartDrag</span>
00165 <span class="comment">//---------------------------------------------------------</span>
00166 
<a name="l00167"></a><a class="code" href="classSlurSegment.html#a11">00167</a> <span class="keywordtype">bool</span> <a class="code" href="classSlurSegment.html#a11">SlurSegment::editStartDrag</a>(<span class="keyword">const</span> QPointF&amp; p)
00168       {
00169       <span class="comment">// search for the clicked grip</span>
00170       <a class="code" href="classSlurSegment.html#r5">mode</a> = 1;
00171       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i) {
00172             <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r0">ups</a>[i].<a class="code" href="structUP.html#o2">r</a>.contains(p)) {
00173                   <a class="code" href="classSlurSegment.html#d0">bboxUpdate</a>();
00174                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00175                   }
00176             ++<a class="code" href="classSlurSegment.html#r5">mode</a>;
00177             }
00178       <a class="code" href="classSlurSegment.html#r5">mode</a> = 0;
00179       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00180       }
00181 
00182 <span class="comment">//---------------------------------------------------------</span>
00183 <span class="comment">//   dragOff</span>
00184 <span class="comment">//---------------------------------------------------------</span>
00185 
<a name="l00186"></a><a class="code" href="classSlurSegment.html#a6">00186</a> QPointF <a class="code" href="classSlurSegment.html#a6">SlurSegment::dragOff</a>()<span class="keyword"> const</span>
00187 <span class="keyword">      </span>{
00188       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r5">mode</a>)
00189             <span class="keywordflow">return</span> -<a class="code" href="classSlurSegment.html#r0">ups</a>[<a class="code" href="classSlurSegment.html#r5">mode</a> - 1].<a class="code" href="structUP.html#o1">off</a>;
00190       <span class="keywordflow">else</span>
00191             <span class="keywordflow">return</span> QPointF(0,0);
00192       }
00193 
00194 <span class="comment">//---------------------------------------------------------</span>
00195 <span class="comment">//   editDrag</span>
00196 <span class="comment">//---------------------------------------------------------</span>
00197 
<a name="l00198"></a><a class="code" href="classSlurSegment.html#a12">00198</a> <span class="keywordtype">bool</span> <a class="code" href="classSlurSegment.html#a12">SlurSegment::editDrag</a>(QMatrix&amp; matrix, QPointF*, <span class="keyword">const</span> QPointF&amp; delta)
00199       {
00200       <span class="keywordflow">if</span> (!<a class="code" href="classSlurSegment.html#r5">mode</a>)
00201             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00202       <span class="keywordtype">int</span> n = <a class="code" href="classSlurSegment.html#r5">mode</a> - 1;
00203 
00204       <a class="code" href="classSlurSegment.html#r0">ups</a>[n].<a class="code" href="structUP.html#o2">r</a>.translate(delta);
00205       <a class="code" href="classSlurSegment.html#r0">ups</a>[n].<a class="code" href="structUP.html#o1">off</a> += (delta / <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00206 
00207       <span class="keywordflow">if</span> (mode == 1 || mode == 4) {
00208             <a class="code" href="classSlurSegment.html#r2">slur</a>-&gt;<a class="code" href="classSlurTie.html#a8">layout2</a>(<a class="code" href="classElement.html#a35">apos</a>(), mode, <a class="code" href="classSlurSegment.html#r0">ups</a>[n]);
00209             <span class="comment">//</span>
00210             <span class="comment">//  compute bezier help points</span>
00211             <span class="comment">//</span>
00212             QPointF p0 = <a class="code" href="classSlurSegment.html#r0">ups</a>[0].<a class="code" href="structUP.html#a0">pos</a>();
00213             QPointF p3 = ups[3].pos();
00214             qreal d    = (p3.x() - p0.x()) / 4;
00215             qreal x1   = p0.x() + d;
00216             qreal x2   = p3.x() - d;
00217 
00218             qreal xdelta = p3.x() - p0.x();
00219             <span class="keywordflow">if</span> (xdelta == 0.0) {
00220                   printf(<span class="stringliteral">"bad slur slope\n"</span>);
00221                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00222                   }
00223             qreal slope = (p3.y() - p0.y()) / xdelta;
00224             qreal y1    = p0.y() + (x1-p0.y()) * slope + <a class="code" href="classSlurSegment.html#r4">bow</a>;
00225             qreal y2    = p0.y() + (x2-p0.x()) * slope + bow;
00226             ups[1].p    = QPointF(x1, y1);
00227             ups[2].p    = QPointF(x2, y2);
00228 
00229             <a class="code" href="classSlurSegment.html#d2">updateGrips</a>(matrix);
00230 
00231             <span class="keywordflow">if</span> (<a class="code" href="project_8cpp.html#a8">showRubberBand</a>) {
00232                   QPointF ppos(<a class="code" href="classElement.html#a35">apos</a>());
00233                   QPointF rp1( ups[n].p + ups[n].off * <a class="code" href="spatium_8h.html#a0">_spatium</a> + ppos);
00234                   QPointF rp2(ups[n].p + ppos);
00235                   <a class="code" href="classSlurSegment.html#r3">rb</a>-&gt;<a class="code" href="classRubberBand.html#a4">set</a>(rp1, rp2);
00236                   QPointF ppp(rp2-ppos);
00237                   <span class="comment">//TODO bbox?</span>
00238                   }
00239             }
00240       <a class="code" href="classSlurSegment.html#d1">updatePath</a>();
00241       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00242       }
00243 
00244 <span class="comment">//---------------------------------------------------------</span>
00245 <span class="comment">//    bboxUpdate</span>
00246 <span class="comment">//---------------------------------------------------------</span>
00247 
<a name="l00248"></a><a class="code" href="classSlurSegment.html#d0">00248</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#d0">SlurSegment::bboxUpdate</a>()
00249       {
00250       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r1">path</a> == 0)
00251             <span class="keywordflow">return</span>;
00252       QRectF r(<a class="code" href="classSlurSegment.html#r1">path</a>-&gt;boundingRect());
00253       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r5">mode</a>) {
00254             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i)
00255                   r |= <a class="code" href="classSlurSegment.html#r0">ups</a>[i].<a class="code" href="structUP.html#o2">r</a>;
00256             }
00257       setbbox(r);
00258       }
00259 
00260 <span class="comment">//---------------------------------------------------------</span>
00261 <span class="comment">//   writeProperties</span>
00262 <span class="comment">//---------------------------------------------------------</span>
00263 
<a name="l00264"></a><a class="code" href="classSlurSegment.html#a19">00264</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#a19">SlurSegment::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml, <span class="keywordtype">int</span> no)<span class="keyword"> const</span>
00265 <span class="keyword">      </span>{
00266       <span class="keywordtype">bool</span> empty = <span class="keyword">true</span>;
00267       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i) {
00268             <span class="keywordflow">if</span> (!(<a class="code" href="classSlurSegment.html#r0">ups</a>[i].<a class="code" href="structUP.html#o1">off</a>.isNull())) {
00269                   empty = <span class="keyword">false</span>;
00270                   <span class="keywordflow">break</span>;
00271                   }
00272             }
00273       <span class="keywordflow">if</span> (empty)
00274             <span class="keywordflow">return</span>;
00275       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Segment no=\"%d\""</span>, no);
00276       <span class="keywordflow">if</span> (!(<a class="code" href="classSlurSegment.html#r0">ups</a>[0].<a class="code" href="structUP.html#o1">off</a>.isNull()))
00277             xml.<a class="code" href="classXml.html#a20">writePoint</a>(<a class="code" href="classSlurSegment.html#r0">ups</a>[0].off, <span class="stringliteral">"o1"</span>);
00278       <span class="keywordflow">if</span> (!(<a class="code" href="classSlurSegment.html#r0">ups</a>[1].<a class="code" href="structUP.html#o1">off</a>.isNull()))
00279             xml.<a class="code" href="classXml.html#a20">writePoint</a>(<a class="code" href="classSlurSegment.html#r0">ups</a>[1].off, <span class="stringliteral">"o2"</span>);
00280       <span class="keywordflow">if</span> (!(<a class="code" href="classSlurSegment.html#r0">ups</a>[2].<a class="code" href="structUP.html#o1">off</a>.isNull()))
00281             xml.<a class="code" href="classXml.html#a20">writePoint</a>(<a class="code" href="classSlurSegment.html#r0">ups</a>[2].off, <span class="stringliteral">"o3"</span>);
00282       <span class="keywordflow">if</span> (!(<a class="code" href="classSlurSegment.html#r0">ups</a>[3].<a class="code" href="structUP.html#o1">off</a>.isNull()))
00283             xml.<a class="code" href="classXml.html#a20">writePoint</a>(<a class="code" href="classSlurSegment.html#r0">ups</a>[3].off, <span class="stringliteral">"o4"</span>);
00284       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Segment"</span>);
00285       }
00286 
00287 <span class="comment">//---------------------------------------------------------</span>
00288 <span class="comment">//   readSegment</span>
00289 <span class="comment">//---------------------------------------------------------</span>
00290 
<a name="l00291"></a><a class="code" href="classSlurSegment.html#a20">00291</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#a20">SlurSegment::read</a>(QDomNode node)
00292       {
00293       <span class="keywordflow">for</span> (node = node.firstChild(); !node.isNull(); node = node.nextSibling()) {
00294             QDomElement e = node.toElement();
00295             QString tag(e.tagName());
00296             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"o1"</span>)
00297                   <a class="code" href="classSlurSegment.html#r0">ups</a>[0].<a class="code" href="structUP.html#o1">off</a> = <a class="code" href="xml_8h.html#a2">readPoint</a>(node);
00298             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"o2"</span>)
00299                   <a class="code" href="classSlurSegment.html#r0">ups</a>[1].<a class="code" href="structUP.html#o1">off</a> = <a class="code" href="xml_8h.html#a2">readPoint</a>(node);
00300             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"o3"</span>)
00301                   <a class="code" href="classSlurSegment.html#r0">ups</a>[2].<a class="code" href="structUP.html#o1">off</a> = <a class="code" href="xml_8h.html#a2">readPoint</a>(node);
00302             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"o4"</span>)
00303                   <a class="code" href="classSlurSegment.html#r0">ups</a>[3].<a class="code" href="structUP.html#o1">off</a> = <a class="code" href="xml_8h.html#a2">readPoint</a>(node);
00304             <span class="keywordflow">else</span>
00305                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00306             }
00307       }
00308 
00309 <span class="comment">//---------------------------------------------------------</span>
00310 <span class="comment">//   contains</span>
00311 <span class="comment">//    return true if p is inside of bounding box of object</span>
00312 <span class="comment">//    p is relative to the coordinate system of parent()</span>
00313 <span class="comment">//---------------------------------------------------------</span>
00314 
<a name="l00315"></a><a class="code" href="classSlurSegment.html#a7">00315</a> <span class="keywordtype">bool</span> <a class="code" href="classSlurSegment.html#a7">SlurSegment::contains</a>(<span class="keyword">const</span> QPointF&amp; p)<span class="keyword"> const</span>
00316 <span class="keyword">      </span>{
00317       QPointF <a class="code" href="dynamics_8cpp.html#a0">pp</a>(p);
00318       pp -= <a class="code" href="classElement.html#a20">pos</a>();
00319       QPointF ffp[4];
00320       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i)
00321             ffp[i] = <a class="code" href="classSlurSegment.html#r0">ups</a>[i].<a class="code" href="structUP.html#o0">p</a> + ups[i].off * <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00322 
00323       QRectF r(ffp[0], QSizeF(ffp[1].<a class="code" href="classElement.html#a21">x</a>(), ffp[1].<a class="code" href="classElement.html#a22">y</a>()));
00324       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 2; i &lt; 4; ++i)
00325             r |= QRectF(ffp[i], QSizeF(1, 1));
00326       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r5">mode</a>) {
00327             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 4; ++i)
00328                   r |= ups[i].r;
00329             }
00330 <span class="comment">//      QRectF rr(r.expand(1));</span>
00331       <span class="keywordflow">if</span> (r.contains(pp))
00332             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00333       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00334       }
00335 
00336 <span class="comment">//---------------------------------------------------------</span>
00337 <span class="comment">//   edit</span>
00338 <span class="comment">//---------------------------------------------------------</span>
00339 
<a name="l00340"></a><a class="code" href="classSlurSegment.html#a14">00340</a> <span class="keywordtype">bool</span> <a class="code" href="classSlurSegment.html#a14">SlurSegment::edit</a>(QKeyEvent*)
00341       {
00342 <span class="preprocessor">#if 0</span>
00343 <span class="preprocessor"></span>      QPointF ppos(<a class="code" href="classElement.html#a35">apos</a>());
00344 
00345       <span class="keywordflow">if</span> ((ev-&gt;state() &amp; Qt::ShiftButton)) {
00346             <span class="keywordflow">if</span> (ev-&gt;key() == Qt::Key_Left)
00347                   <a class="code" href="classSlurSegment.html#r2">slur</a>-&gt;<a class="code" href="classSlurTie.html#a10">prevSeg</a>(<a class="code" href="classElement.html#a35">apos</a>(), <a class="code" href="classSlurSegment.html#r5">mode</a>, <a class="code" href="classSlurSegment.html#r0">ups</a>[<a class="code" href="classSlurSegment.html#r5">mode</a>-1]);
00348             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ev-&gt;key() == Qt::Key_Right)
00349                   <a class="code" href="classSlurSegment.html#r2">slur</a>-&gt;<a class="code" href="classSlurTie.html#a9">nextSeg</a>(<a class="code" href="classElement.html#a35">apos</a>(), mode, <a class="code" href="classSlurSegment.html#r0">ups</a>[mode-1]);
00350             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00351             }
00352 
00353       QPointF delta;
00354       qreal val = 1.0;
00355       <span class="keywordflow">if</span> (ev-&gt;state() &amp; Qt::ControlButton)
00356             val = 0.1;
00357       <span class="keywordflow">switch</span> (ev-&gt;key()) {
00358             <span class="keywordflow">case</span> Qt::Key_Left:
00359                   delta = QPointF(-val, 0);
00360                   <span class="keywordflow">break</span>;
00361             <span class="keywordflow">case</span> Qt::Key_Right:
00362                   delta = QPointF(val, 0);
00363                   <span class="keywordflow">break</span>;
00364             <span class="keywordflow">case</span> Qt::Key_Up:
00365                   delta = QPointF(0, -val);
00366                   <span class="keywordflow">break</span>;
00367             <span class="keywordflow">case</span> Qt::Key_Down:
00368                   delta = QPointF(0, val);
00369                   <span class="keywordflow">break</span>;
00370             <span class="keywordflow">case</span> Qt::Key_Tab:
00371                   <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r5">mode</a> &lt; 4)
00372                         ++<a class="code" href="classSlurSegment.html#r5">mode</a>;
00373                   <span class="keywordflow">else</span>
00374                         <a class="code" href="classSlurSegment.html#r5">mode</a> = 1;
00375                   <span class="keywordflow">break</span>;
00376             <span class="keywordflow">case</span> Qt::Key_X:
00377                   <a class="code" href="classSlurSegment.html#r2">slur</a>-&gt;<a class="code" href="classSlurTie.html#a7">setSlurDirection</a>(<a class="code" href="classSlurSegment.html#r2">slur</a>-&gt;<a class="code" href="classSlurTie.html#a4">isUp</a>() ? <a class="code" href="globals_8h.html#a24a9">DOWN</a> : <a class="code" href="structUP.html">UP</a>);
00378                   <span class="keywordflow">break</span>;
00379             }
00380       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r5">mode</a> == 0)
00381             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00382 
00383       <span class="keywordtype">int</span> idx       = (<a class="code" href="classSlurSegment.html#r5">mode</a>-1) % 4;
00384       <a class="code" href="classSlurSegment.html#r0">ups</a>[idx].<a class="code" href="structUP.html#o1">off</a> += delta;
00385       <a class="code" href="classSlurSegment.html#r0">ups</a>[idx].<a class="code" href="structUP.html#o2">r</a>   += (delta * <a class="code" href="spatium_8h.html#a0">_spatium</a>);
00386 
00387       <span class="keywordflow">if</span> (<a class="code" href="classSlurSegment.html#r5">mode</a> == 1 || <a class="code" href="classSlurSegment.html#r5">mode</a> == 4) {
00388             <a class="code" href="classSlurSegment.html#r2">slur</a>-&gt;<a class="code" href="classSlurTie.html#a8">layout2</a>(<a class="code" href="classElement.html#a35">apos</a>(), <a class="code" href="classSlurSegment.html#r5">mode</a>, <a class="code" href="classSlurSegment.html#r0">ups</a>[idx]);
00389             <span class="keywordflow">if</span> (!<a class="code" href="project_8cpp.html#a8">showRubberBand</a> || (<a class="code" href="classSlurSegment.html#r5">mode</a> != 1 &amp;&amp; <a class="code" href="classSlurSegment.html#r5">mode</a> != 4))
00390                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00391             QPointF ppos(<a class="code" href="classElement.html#a35">apos</a>());
00392             QPointF rp1, rp2;
00393             rp1 = <a class="code" href="classSlurSegment.html#r0">ups</a>[idx].<a class="code" href="structUP.html#o0">p</a> + ups[idx].off * <a class="code" href="spatium_8h.html#a0">_spatium</a> + ppos;
00394             rp2 = ups[idx].p + ppos;
00395             <a class="code" href="classSlurSegment.html#r3">rb</a>-&gt;<a class="code" href="classRubberBand.html#a4">set</a>(rp1, rp2);
00396             setbbox(<a class="code" href="classElement.html#a33">bbox</a>() | QRectF(rp1-ppos, rp2-ppos));
00397             }
00398 <span class="preprocessor">#endif</span>
00399 <span class="preprocessor"></span>      <span class="keywordflow">return</span> <span class="keyword">false</span>;
00400       }
00401 
00402 <span class="comment">//---------------------------------------------------------</span>
00403 <span class="comment">//   layout</span>
00404 <span class="comment">//---------------------------------------------------------</span>
00405 
<a name="l00406"></a><a class="code" href="classSlurSegment.html#a4">00406</a> <span class="keywordtype">void</span> <a class="code" href="classElement.html#a66">SlurSegment::layout</a>(<span class="keyword">const</span> QPointF&amp; p1, <span class="keyword">const</span> QPointF&amp; p2, qreal b)
00407       {
00408       <a class="code" href="classSlurSegment.html#r4">bow</a> = b;
00409       QPointF ppos(<a class="code" href="classElement.html#a35">apos</a>());
00410       <a class="code" href="classSlurSegment.html#r0">ups</a>[0].<a class="code" href="structUP.html#o0">p</a> = p1 - ppos;
00411       <a class="code" href="classSlurSegment.html#r0">ups</a>[3].<a class="code" href="structUP.html#o0">p</a> = p2 - ppos;
00412 
00413       <span class="comment">//</span>
00414       <span class="comment">//  compute bezier help points</span>
00415       <span class="comment">//</span>
00416       qreal x0 = <a class="code" href="classSlurSegment.html#r0">ups</a>[0].<a class="code" href="structUP.html#o0">p</a>.x();
00417       qreal x3 = ups[3].p.x();
00418       qreal y0 = ups[0].p.y();
00419       qreal y3 = ups[3].p.y();
00420 
00421       qreal delta = (x3 - x0) / 4;
00422       qreal x1 = x0 + delta;
00423       qreal x2 = x3 - delta;
00424 
00425       qreal xdelta = x3 - x0;
00426       <span class="keywordflow">if</span> (xdelta == 0.0) {
00427             printf(<span class="stringliteral">"bad slur slope\n"</span>);
00428             <span class="keywordflow">return</span>;
00429             }
00430       qreal slope = (y3 - y0) / xdelta;
00431 
00432       qreal y1 = y0 + (x1-x0) * slope + <a class="code" href="classSlurSegment.html#r4">bow</a>;
00433       qreal y2 = y0 + (x2-x0) * slope + bow;
00434 
00435       ups[1].p = QPointF(x1, y1);
00436       ups[2].p = QPointF(x2, y2);
00437       <a class="code" href="classSlurSegment.html#d1">updatePath</a>();
00438       }
00439 
00440 <span class="comment">//---------------------------------------------------------</span>
00441 <span class="comment">//   editEndDrag</span>
00442 <span class="comment">//---------------------------------------------------------</span>
00443 
<a name="l00444"></a><a class="code" href="classSlurSegment.html#a13">00444</a> <span class="keywordtype">bool</span> <a class="code" href="classSlurSegment.html#a13">SlurSegment::editEndDrag</a>()
00445       {
00446       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00447       }
00448 
00449 <span class="comment">//---------------------------------------------------------</span>
00450 <span class="comment">//   dump</span>
00451 <span class="comment">//---------------------------------------------------------</span>
00452 
<a name="l00453"></a><a class="code" href="classSlurSegment.html#a21">00453</a> <span class="keywordtype">void</span> <a class="code" href="classSlurSegment.html#a21">SlurSegment::dump</a>()<span class="keyword"> const</span>
00454 <span class="keyword">      </span>{
00455       printf(<span class="stringliteral">"SlurSegment %f/%f %f/%f %f/%f %f/%f\n"</span>,
00456             <a class="code" href="classSlurSegment.html#r0">ups</a>[0].off.x(), <a class="code" href="classSlurSegment.html#r0">ups</a>[0].<a class="code" href="structUP.html#o1">off</a>.y(),
00457             <a class="code" href="classSlurSegment.html#r0">ups</a>[1].<a class="code" href="structUP.html#o1">off</a>.x(), <a class="code" href="classSlurSegment.html#r0">ups</a>[1].<a class="code" href="structUP.html#o1">off</a>.y(),
00458             <a class="code" href="classSlurSegment.html#r0">ups</a>[2].<a class="code" href="structUP.html#o1">off</a>.x(), <a class="code" href="classSlurSegment.html#r0">ups</a>[2].<a class="code" href="structUP.html#o1">off</a>.y(),
00459             <a class="code" href="classSlurSegment.html#r0">ups</a>[3].<a class="code" href="structUP.html#o1">off</a>.x(), <a class="code" href="classSlurSegment.html#r0">ups</a>[3].<a class="code" href="structUP.html#o1">off</a>.y());
00460       }
00461 
00462 <span class="comment">//---------------------------------------------------------</span>
00463 <span class="comment">//   SlurTie</span>
00464 <span class="comment">//---------------------------------------------------------</span>
00465 
<a name="l00466"></a><a class="code" href="classSlurTie.html#a0">00466</a> <a class="code" href="classSlurTie.html#a0">SlurTie::SlurTie</a>(<a class="code" href="classScore.html">Score</a>* s, ElementType t)
00467    : <a class="code" href="classElement.html">Element</a>(s, t)
00468       {
00469       <a class="code" href="classSlurTie.html#p2">_slurDirection</a> = <a class="code" href="globals_8h.html#a24a7">AUTO</a>;
00470       <a class="code" href="classSlurTie.html#p0">up</a> = <span class="keyword">true</span>;
00471       }
00472 
<a name="l00473"></a><a class="code" href="classSlurTie.html#a1">00473</a> <a class="code" href="classSlurTie.html#a0">SlurTie::SlurTie</a>(<span class="keyword">const</span> <a class="code" href="classSlurTie.html">SlurTie</a>&amp; t)
00474    : <a class="code" href="classElement.html">Element</a>(t)
00475       {
00476       <a class="code" href="classSlurTie.html#p0">up</a>             = t.<a class="code" href="classSlurTie.html#p0">up</a>;
00477       <a class="code" href="classSlurTie.html#p2">_slurDirection</a> = t.<a class="code" href="classSlurTie.html#p2">_slurDirection</a>;
00478       <a class="code" href="classSlurTie.html#p1">segments</a>.clear();
00479       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> ie = t.<a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ie != t.<a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ie) {
00480             <a class="code" href="classSlurSegment.html">SlurSegment</a>* ss = <span class="keyword">new</span> <a class="code" href="classSlurSegment.html">SlurSegment</a>(*(SlurSegment*)(*ie));
00481             ss-&gt;<a class="code" href="classSlurSegment.html#a18">setSlurTie</a>(<span class="keyword">this</span>);
00482             <a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(ss);
00483             }
00484       }
00485 
00486 <span class="comment">//---------------------------------------------------------</span>
00487 <span class="comment">//   SlurTie</span>
00488 <span class="comment">//---------------------------------------------------------</span>
00489 
<a name="l00490"></a><a class="code" href="classSlurTie.html#a2">00490</a> <a class="code" href="classSlurTie.html#a2">SlurTie::~SlurTie</a>()
00491       {
00492       }
00493 
00494 <span class="comment">//---------------------------------------------------------</span>
00495 <span class="comment">//   add</span>
00496 <span class="comment">//---------------------------------------------------------</span>
00497 
<a name="l00498"></a><a class="code" href="classSlurTie.html#a14">00498</a> <span class="keywordtype">void</span> <a class="code" href="classSlurTie.html#a14">SlurTie::add</a>(<a class="code" href="classElement.html">Element</a>* s)
00499       {
00500 <span class="comment">//      printf("SlurTie: %d vor add %p\n", segments.size(), s);</span>
00501       <a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(s);
00502       }
00503 
00504 <span class="comment">//---------------------------------------------------------</span>
00505 <span class="comment">//   remove</span>
00506 <span class="comment">//---------------------------------------------------------</span>
00507 
<a name="l00508"></a><a class="code" href="classSlurTie.html#a15">00508</a> <span class="keywordtype">void</span> <a class="code" href="classSlurTie.html#a15">SlurTie::remove</a>(<a class="code" href="classElement.html">Element</a>* s)
00509       {
00510       <span class="keywordflow">if</span> (!<a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classElementList.html#a1">remove</a>(s))
00511             printf(<span class="stringliteral">"SlurTie: cannot remove %p\n"</span>, s);
00512 <span class="comment">//      printf("SlurTie: %d nach remove %p\n", segments.size(), s);</span>
00513       }
00514 
00515 <span class="comment">//---------------------------------------------------------</span>
00516 <span class="comment">//   slurPos</span>
00517 <span class="comment">//---------------------------------------------------------</span>
00518 
<a name="l00519"></a><a class="code" href="classSlurTie.html#b0">00519</a> QPointF <a class="code" href="classSlurTie.html#b0">SlurTie::slurPos</a>(<span class="keywordtype">int</span> tick, <a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> voice, <a class="code" href="classSystem.html">System</a>*&amp; s)
00520       {
00521       <a class="code" href="classMeasure.html">Measure</a>* m = _score-&gt;<a class="code" href="classScore.html#a128">tick2measure</a>(tick);
00522       <span class="keywordflow">if</span> (m == 0) {
00523             printf(<span class="stringliteral">"SlurTie: cannot find measure for tick %d\n"</span>, tick);
00524             <span class="keywordflow">return</span> QPointF(0,0);
00525             }
00526       s = m-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
00527       <a class="code" href="classChordRest.html">ChordRest</a>* cr = m-&gt;<a class="code" href="classMeasure.html#a50">findChordRest</a>(tick, staff, voice, <span class="keyword">false</span>);
00528       <span class="keywordflow">if</span> (cr == 0) {
00529             printf(<span class="stringliteral">"SlurTie: cannot find chord/rest at tick:%d staff:%d voice:%d, measure %d-%d\n"</span>,
00530                tick, staff-&gt;<a class="code" href="classStaff.html#a15">idx</a>(), voice, m-&gt;<a class="code" href="classElement.html#a74">tick</a>(), m-&gt;<a class="code" href="classElement.html#a74">tick</a>() + m-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>());
00531             <span class="keywordflow">return</span> QPointF(0,0);
00532             }
00533 
00534       <span class="comment">//-----------------------------------------</span>
00535       <span class="comment">//    off</span>
00536       <span class="comment">//-----------------------------------------</span>
00537 
00538       qreal w  = cr-&gt;<a class="code" href="classElement.html#a37">width</a>() / 2.0;
00539       qreal yo = 0.0;
00540       <span class="keywordflow">if</span> (cr-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>) {
00541             <a class="code" href="classChord.html">Chord</a>* c = (<a class="code" href="classChord.html">Chord</a>*)cr;
00542             <a class="code" href="classStem.html">Stem</a>* stem = c-&gt;<a class="code" href="classChord.html#a23">stem</a>();
00543             <span class="keywordflow">if</span> (<a class="code" href="classSlurTie.html#p0">up</a>) {
00544                   yo = c-&gt;<a class="code" href="classChord.html#a17">upNote</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().y() - <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00545                   <span class="keywordflow">if</span> (c-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>() &amp;&amp; stem)
00546                         yo = c-&gt;<a class="code" href="classChord.html#a18">downNote</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().y() - stem-&gt;<a class="code" href="classElement.html#a36">height</a>() - <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00547                   }
00548             <span class="keywordflow">else</span> {
00549                   yo = c-&gt;<a class="code" href="classChord.html#a18">downNote</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().y() + <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00550                   <span class="keywordflow">if</span> (!c-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>() &amp;&amp; stem)
00551                         yo = c-&gt;<a class="code" href="classChord.html#a17">upNote</a>()-&gt;<a class="code" href="classElement.html#a20">pos</a>().y() + stem-&gt;<a class="code" href="classElement.html#a36">height</a>() + <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00552                   }
00553             }
00554       QPointF off(w, yo);
00555 
00556       <span class="comment">//-----------------------------------------</span>
00557       <span class="comment">//    p</span>
00558       <span class="comment">//-----------------------------------------</span>
00559 
00560       <span class="keywordflow">return</span> cr-&gt;<a class="code" href="classElement.html#a35">apos</a>() + off;
00561       }
00562 
00563 <span class="comment">//---------------------------------------------------------</span>
00564 <span class="comment">//   writeProperties</span>
00565 <span class="comment">//---------------------------------------------------------</span>
00566 
<a name="l00567"></a><a class="code" href="classSlurTie.html#a16">00567</a> <span class="keywordtype">void</span> <a class="code" href="classSlurTie.html#a16">SlurTie::writeProperties</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00568 <span class="keyword">      </span>{
00569       <span class="keywordtype">int</span> idx = 0;
00570       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i, ++idx)
00571             ((<a class="code" href="classSlurSegment.html">SlurSegment</a>*)*i)-&gt;write(xml, idx);
00572       <span class="keywordflow">if</span> (<a class="code" href="classSlurTie.html#p2">_slurDirection</a>)
00573             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"up"</span>, <a class="code" href="classSlurTie.html#p2">_slurDirection</a>);
00574       }
00575 
00576 <span class="comment">//---------------------------------------------------------</span>
00577 <span class="comment">//   setSelected</span>
00578 <span class="comment">//---------------------------------------------------------</span>
00579 
<a name="l00580"></a><a class="code" href="classSlurTie.html#a11">00580</a> <span class="keywordtype">void</span> <a class="code" href="classSlurTie.html#a11">SlurTie::setSelected</a>(<span class="keywordtype">bool</span> f)
00581       {
00582       Element::setSelected(f);
00583       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00584             (*i)-&gt;setSelected(f);
00585       }
00586 
00587 <span class="comment">//---------------------------------------------------------</span>
00588 <span class="comment">//   readProperties</span>
00589 <span class="comment">//---------------------------------------------------------</span>
00590 
<a name="l00591"></a><a class="code" href="classSlurTie.html#a17">00591</a> <span class="keywordtype">bool</span> <a class="code" href="classSlurTie.html#a17">SlurTie::readProperties</a>(QDomNode node)
00592       {
00593       QDomElement e = node.toElement();
00594       QString tag(e.tagName());
00595       QString val(e.text());
00596 
00597       <span class="keywordflow">if</span> (tag == <span class="stringliteral">"Segment"</span>) {
00598             <a class="code" href="classSlurSegment.html">SlurSegment</a>* segment = <span class="keyword">new</span> <a class="code" href="classSlurSegment.html">SlurSegment</a>(<span class="keyword">this</span>);
00599             segment-&gt;<a class="code" href="classSlurSegment.html#a20">read</a>(node);
00600             <a class="code" href="classSlurTie.html#p1">segments</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(segment);
00601             }
00602       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"up"</span>)
00603             <a class="code" href="classSlurTie.html#p2">_slurDirection</a> = <a class="code" href="globals_8h.html#a24">Direction</a>(val.toInt());
00604       <span class="keywordflow">else</span>
00605             <span class="keywordflow">return</span> <span class="keyword">false</span>;
00606       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00607       }
00608 
00609 <span class="comment">//---------------------------------------------------------</span>
00610 <span class="comment">//   Slur</span>
00611 <span class="comment">//---------------------------------------------------------</span>
00612 
<a name="l00613"></a><a class="code" href="classSlur.html#a0">00613</a> <a class="code" href="classSlur.html#a0">Slur::Slur</a>(<a class="code" href="classScore.html">Score</a>* s)
00614    : <a class="code" href="classSlurTie.html">SlurTie</a>(s, <a class="code" href="element_8h.html#a65a28">SLUR</a>)
00615       {
00616       <a class="code" href="classSlur.html#r0">_tick1</a>  = 0;
00617       <a class="code" href="classSlur.html#r1">_tick2</a>  = 0;
00618       <a class="code" href="classSlur.html#r4">_staff1</a> = 0;
00619       <a class="code" href="classSlur.html#r5">_staff2</a> = 0;
00620       <a class="code" href="classSlur.html#r2">_voice1</a> = 0;
00621       <a class="code" href="classSlur.html#r3">_voice2</a> = 0;
00622       }
00623 
<a name="l00624"></a><a class="code" href="classSlur.html#a1">00624</a> <a class="code" href="classSlur.html#a0">Slur::Slur</a>(<span class="keyword">const</span> <a class="code" href="classSlur.html">Slur</a>&amp; s)
00625    : <a class="code" href="classSlurTie.html">SlurTie</a>(s)
00626       {
00627       <a class="code" href="classSlur.html#r0">_tick1</a>  = s.<a class="code" href="classSlur.html#r0">_tick1</a>;
00628       <a class="code" href="classSlur.html#r1">_tick2</a>  = s.<a class="code" href="classSlur.html#r1">_tick2</a>;
00629       <a class="code" href="classSlur.html#r4">_staff1</a> = s.<a class="code" href="classSlur.html#r4">_staff1</a>;
00630       <a class="code" href="classSlur.html#r5">_staff2</a> = s.<a class="code" href="classSlur.html#r5">_staff2</a>;
00631       <a class="code" href="classSlur.html#r2">_voice1</a> = s.<a class="code" href="classSlur.html#r2">_voice1</a>;
00632       <a class="code" href="classSlur.html#r3">_voice2</a> = s.<a class="code" href="classSlur.html#r3">_voice2</a>;
00633       }
00634 
00635 <span class="comment">//---------------------------------------------------------</span>
00636 <span class="comment">//   Slur</span>
00637 <span class="comment">//---------------------------------------------------------</span>
00638 
<a name="l00639"></a><a class="code" href="classSlur.html#a2">00639</a> <a class="code" href="classSlur.html#a2">Slur::~Slur</a>()
00640       {
00641       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> e = segments.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); e != segments.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++e)
00642             <span class="keyword">delete</span> *e;
00643       }
00644 
00645 <span class="comment">//---------------------------------------------------------</span>
00646 <span class="comment">//   nextSeg</span>
00647 <span class="comment">//---------------------------------------------------------</span>
00648 
<a name="l00649"></a><a class="code" href="classSlur.html#a8">00649</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a8">Slur::nextSeg</a>(<span class="keyword">const</span> QPointF ppos, <span class="keywordtype">int</span> mode, <span class="keyword">struct</span> <a class="code" href="structUP.html">UP</a>&amp; ups)
00650       {
00651       <span class="keywordflow">if</span> (mode != 1 &amp;&amp; mode != 4)
00652             <span class="keywordflow">return</span>;
00653       <span class="keywordtype">int</span> tick = mode == 1 ? <a class="code" href="classSlur.html#r0">_tick1</a> : <a class="code" href="classSlur.html#r1">_tick2</a>;
00654       <a class="code" href="classSegment.html">Segment</a>* seg = _score-&gt;<a class="code" href="classScore.html#a129">tick2segment</a>(tick);
00655       seg = seg-&gt;<a class="code" href="classSegment.html#a6">next1</a>();
00656       <span class="keywordflow">if</span> (seg == 0) {
00657             printf(<span class="stringliteral">"no seg found\n"</span>);
00658             <span class="keywordflow">return</span>;
00659             }
00660       <span class="keywordflow">if</span> (tick == seg-&gt;<a class="code" href="classElement.html#a74">tick</a>())
00661             <span class="keywordflow">return</span>;
00662 
00663       <a class="code" href="classSystem.html">System</a>* s;
00664       <span class="keywordflow">if</span> (mode == 1) {
00665             QPointF p(ups.<a class="code" href="structUP.html#o0">p</a> + ups.<a class="code" href="structUP.html#o1">off</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a> + ppos);
00666             <a class="code" href="classSlur.html#r0">_tick1</a> = seg-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00667             ups.<a class="code" href="structUP.html#o0">p</a> = slurPos(<a class="code" href="classSlur.html#r0">_tick1</a>, <a class="code" href="classSlur.html#r4">_staff1</a>, <a class="code" href="classSlur.html#r2">_voice1</a>, s);
00668             }
00669       <span class="keywordflow">else</span> {
00670             QPointF p(ups.<a class="code" href="structUP.html#o0">p</a> + ups.<a class="code" href="structUP.html#o1">off</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a> + ppos);
00671             <a class="code" href="classSlur.html#r1">_tick2</a>  = seg-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00672             ups.<a class="code" href="structUP.html#o0">p</a> = slurPos(<a class="code" href="classSlur.html#r1">_tick2</a>, <a class="code" href="classSlur.html#r5">_staff2</a>, <a class="code" href="classSlur.html#r3">_voice2</a>, s);
00673             }
00674       }
00675 
00676 <span class="comment">//---------------------------------------------------------</span>
00677 <span class="comment">//   prevSeg</span>
00678 <span class="comment">//---------------------------------------------------------</span>
00679 
<a name="l00680"></a><a class="code" href="classSlur.html#a9">00680</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a9">Slur::prevSeg</a>(<span class="keyword">const</span> QPointF ppos, <span class="keywordtype">int</span> mode, <span class="keyword">struct</span> <a class="code" href="structUP.html">UP</a>&amp; ups)
00681       {
00682       <span class="keywordflow">if</span> (mode != 1 &amp;&amp; mode != 4)
00683             <span class="keywordflow">return</span>;
00684       <span class="keywordtype">int</span> tick = mode == 1 ? <a class="code" href="classSlur.html#r0">_tick1</a> : <a class="code" href="classSlur.html#r1">_tick2</a>;
00685       <a class="code" href="classSegment.html">Segment</a>* seg = _score-&gt;<a class="code" href="classScore.html#a129">tick2segment</a>(tick);
00686       seg = seg-&gt;<a class="code" href="classSegment.html#a7">prev1</a>();
00687       <span class="keywordflow">if</span> (seg == 0) {
00688             printf(<span class="stringliteral">"no seg found\n"</span>);
00689             <span class="keywordflow">return</span>;
00690             }
00691       <span class="keywordflow">if</span> (tick == seg-&gt;<a class="code" href="classElement.html#a74">tick</a>())
00692             <span class="keywordflow">return</span>;
00693 
00694       <a class="code" href="classSystem.html">System</a>* s;
00695       <span class="keywordflow">if</span> (mode == 1) {
00696             QPointF p(ups.<a class="code" href="structUP.html#o0">p</a> + ups.<a class="code" href="structUP.html#o1">off</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a> + ppos);
00697             <a class="code" href="classSlur.html#r0">_tick1</a> = seg-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00698             ups.<a class="code" href="structUP.html#o0">p</a> = slurPos(<a class="code" href="classSlur.html#r0">_tick1</a>, <a class="code" href="classSlur.html#r4">_staff1</a>, <a class="code" href="classSlur.html#r2">_voice1</a>, s);
00699             }
00700       <span class="keywordflow">else</span> {
00701             QPointF p(ups.<a class="code" href="structUP.html#o0">p</a> + ups.<a class="code" href="structUP.html#o1">off</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a> + ppos);
00702             <a class="code" href="classSlur.html#r1">_tick2</a>  = seg-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00703             ups.<a class="code" href="structUP.html#o0">p</a> = slurPos(<a class="code" href="classSlur.html#r1">_tick2</a>, <a class="code" href="classSlur.html#r5">_staff2</a>, <a class="code" href="classSlur.html#r3">_voice2</a>, s);
00704             }
00705       }
00706 
00707 <span class="comment">//---------------------------------------------------------</span>
00708 <span class="comment">//   setStart</span>
00709 <span class="comment">//---------------------------------------------------------</span>
00710 
<a name="l00711"></a><a class="code" href="classSlur.html#a10">00711</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a10">Slur::setStart</a>(<span class="keywordtype">int</span> t, <a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> voice)
00712       {
00713       <a class="code" href="classSlur.html#r0">_tick1</a>  = t;
00714       <a class="code" href="classSlur.html#r4">_staff1</a> = staff;
00715       <a class="code" href="classSlur.html#r2">_voice1</a> = voice;
00716       }
00717 
00718 <span class="comment">//---------------------------------------------------------</span>
00719 <span class="comment">//   setEnd</span>
00720 <span class="comment">//---------------------------------------------------------</span>
00721 
<a name="l00722"></a><a class="code" href="classSlur.html#a11">00722</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a11">Slur::setEnd</a>(<span class="keywordtype">int</span> t, <a class="code" href="classStaff.html">Staff</a>* staff, <span class="keywordtype">int</span> voice)
00723       {
00724       <a class="code" href="classSlur.html#r1">_tick2</a>  = t;
00725       <a class="code" href="classSlur.html#r5">_staff2</a> = staff;
00726       <a class="code" href="classSlur.html#r3">_voice2</a> = voice;
00727       }
00728 
00729 <span class="comment">//---------------------------------------------------------</span>
00730 <span class="comment">//   write</span>
00731 <span class="comment">//---------------------------------------------------------</span>
00732 
<a name="l00733"></a><a class="code" href="classSlur.html#a4">00733</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a4">Slur::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
00734 <span class="keyword">      </span>{
00735       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Slur"</span>);
00736       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"startTick"</span>, <a class="code" href="classSlur.html#r0">_tick1</a>);
00737       xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"endTick"</span>, <a class="code" href="classSlur.html#r1">_tick2</a>);
00738       <span class="keywordflow">if</span> (<a class="code" href="classSlur.html#r2">_voice1</a>)
00739             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"startVoice"</span>, <a class="code" href="classSlur.html#r2">_voice1</a>);
00740       <span class="keywordflow">if</span> (<a class="code" href="classSlur.html#r3">_voice2</a>)
00741             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"endVoice"</span>, <a class="code" href="classSlur.html#r3">_voice2</a>);
00742       <span class="keywordtype">int</span> s1 = <a class="code" href="classSlur.html#r4">_staff1</a>-&gt;<a class="code" href="classStaff.html#a15">idx</a>();
00743       <span class="keywordtype">int</span> s2 = <a class="code" href="classSlur.html#r5">_staff2</a>-&gt;<a class="code" href="classStaff.html#a15">idx</a>();
00744       <span class="keywordflow">if</span> (s1)
00745             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"startStaff"</span>, s1);
00746       <span class="keywordflow">if</span> (s2)
00747             xml.<a class="code" href="classXml.html#a12">intTag</a>(<span class="stringliteral">"endStaff"</span>, s2);
00748       SlurTie::writeProperties(xml);
00749       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Slur"</span>);
00750       }
00751 
00752 <span class="comment">//---------------------------------------------------------</span>
00753 <span class="comment">//   read</span>
00754 <span class="comment">//---------------------------------------------------------</span>
00755 
<a name="l00756"></a><a class="code" href="classSlur.html#a5">00756</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a5">Slur::read</a>(<a class="code" href="classScore.html">Score</a>* score, QDomNode node)
00757       {
00758       <a class="code" href="classSlur.html#r4">_staff1</a> = 0;
00759       <a class="code" href="classSlur.html#r5">_staff2</a> = 0;
00760       node = node.firstChild();
00761       <span class="keywordflow">while</span> (!node.isNull()) {
00762             QDomElement e = node.toElement();
00763             QString tag(e.tagName());
00764             QString val(e.text());
00765             <span class="keywordtype">int</span> i = val.toInt();
00766             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"startTick"</span>)
00767                   <a class="code" href="classSlur.html#r0">_tick1</a> = i;
00768             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"endTick"</span>)
00769                   <a class="code" href="classSlur.html#r1">_tick2</a> = i;
00770             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"startVoice"</span>)
00771                   <a class="code" href="classSlur.html#r2">_voice1</a> = i;
00772             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"endVoice"</span>)
00773                   <a class="code" href="classSlur.html#r3">_voice2</a> = i;
00774             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"startStaff"</span>)
00775                   <a class="code" href="classSlur.html#r4">_staff1</a> = score-&gt;<a class="code" href="classScore.html#a7">staff</a>(i);
00776             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"endStaff"</span>)
00777                   <a class="code" href="classSlur.html#r5">_staff2</a> = score-&gt;<a class="code" href="classScore.html#a7">staff</a>(i);
00778             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SlurTie::readProperties(node))
00779                   ;
00780             <span class="keywordflow">else</span>
00781                   printf(<span class="stringliteral">"Mscore:Slur: unknown tag %s\n"</span>,
00782                      tag.latin1());
00783             node = node.nextSibling();
00784             }
00785       <span class="keywordflow">if</span> (<a class="code" href="classSlur.html#r4">_staff1</a> == 0)
00786             <a class="code" href="classSlur.html#r4">_staff1</a> = score-&gt;<a class="code" href="classScore.html#a7">staff</a>(0);
00787       <span class="keywordflow">if</span> (<a class="code" href="classSlur.html#r5">_staff2</a> == 0)
00788             <a class="code" href="classSlur.html#r5">_staff2</a> = score-&gt;<a class="code" href="classScore.html#a7">staff</a>(0);
00789       }
00790 
00791 <span class="comment">//---------------------------------------------------------</span>
00792 <span class="comment">//   layout</span>
00793 <span class="comment">//---------------------------------------------------------</span>
00794 
<a name="l00795"></a><a class="code" href="classSlur.html#a6">00795</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a6">Slur::layout</a>()
00796       {
00797 <span class="comment">// printf("Slur layout\n");</span>
00798       <span class="keywordflow">switch</span> (_slurDirection) {
00799             <span class="keywordflow">case</span> <a class="code" href="structUP.html">UP</a>:    up = <span class="keyword">true</span>; <span class="keywordflow">break</span>;
00800             <span class="keywordflow">case</span> <a class="code" href="globals_8h.html#a24a9">DOWN</a>:  up = <span class="keyword">false</span>; <span class="keywordflow">break</span>;
00801             <span class="keywordflow">case</span> <a class="code" href="globals_8h.html#a24a7">AUTO</a>:
00802                   {
00803                   <a class="code" href="classMeasure.html">Measure</a>* m1 = _score-&gt;<a class="code" href="classScore.html#a128">tick2measure</a>(<a class="code" href="classSlur.html#r0">_tick1</a>);
00804                   <span class="keywordflow">if</span> (m1 == 0) {
00805                         printf(<span class="stringliteral">"Slur: cannot find measure for tick %d\n"</span>, <a class="code" href="classSlur.html#r0">_tick1</a>);
00806                         <span class="keywordflow">return</span>;
00807                         }
00808                   <span class="keywordflow">if</span> ((<a class="code" href="classSlur.html#r1">_tick2</a> - <a class="code" href="classSlur.html#r0">_tick1</a>) &gt; m1-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>()) {
00809                         <span class="comment">// long slurs are always above</span>
00810                         up = <span class="keyword">true</span>;
00811                         }
00812                   <span class="keywordflow">else</span> {
00813                         <a class="code" href="classChordRest.html">ChordRest</a>* c1 = m1-&gt;<a class="code" href="classMeasure.html#a50">findChordRest</a>(<a class="code" href="classSlur.html#r0">_tick1</a>, <a class="code" href="classSlur.html#r4">_staff1</a>, <a class="code" href="classSlur.html#r2">_voice1</a>, <span class="keyword">false</span>);
00814                         <span class="keywordflow">if</span> (c1 == 0) {
00815                               printf(<span class="stringliteral">"Slur-1: cannot find chord/rest at tick:%d staff:%d voice:%d, measure %d-%d\n"</span>,
00816                                  <a class="code" href="classSlur.html#r0">_tick1</a>, <a class="code" href="classSlur.html#r4">_staff1</a>-&gt;<a class="code" href="classStaff.html#a15">idx</a>(), <a class="code" href="classSlur.html#r2">_voice1</a>, m1-&gt;<a class="code" href="classElement.html#a74">tick</a>(), m1-&gt;<a class="code" href="classElement.html#a74">tick</a>() + m1-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>());
00817                               <span class="keywordflow">return</span>;
00818                               }
00819 
00820                         <a class="code" href="classMeasure.html">Measure</a>* m2 = _score-&gt;<a class="code" href="classScore.html#a128">tick2measure</a>(<a class="code" href="classSlur.html#r1">_tick2</a>);
00821                         <span class="keywordflow">if</span> (m2 == 0) {
00822                               printf(<span class="stringliteral">"Slur: cannot find measure for tick %d\n"</span>, <a class="code" href="classSlur.html#r1">_tick2</a>);
00823                               <span class="keywordflow">return</span>;
00824                               }
00825                         <a class="code" href="classChordRest.html">ChordRest</a>* c2 = m2-&gt;<a class="code" href="classMeasure.html#a50">findChordRest</a>(<a class="code" href="classSlur.html#r1">_tick2</a>, <a class="code" href="classSlur.html#r5">_staff2</a>, <a class="code" href="classSlur.html#r3">_voice2</a>, <span class="keyword">false</span>);
00826                         <span class="keywordflow">if</span> (c2 == 0) {
00827                               printf(<span class="stringliteral">"Slur-2: cannot find chord/rest at tick:%d staff:%d voice:%d, measure %d-%d\n"</span>,
00828                                  <a class="code" href="classSlur.html#r1">_tick2</a>, <a class="code" href="classSlur.html#r5">_staff2</a>-&gt;<a class="code" href="classStaff.html#a15">idx</a>(), <a class="code" href="classSlur.html#r3">_voice2</a>, m2-&gt;<a class="code" href="classElement.html#a74">tick</a>(), m2-&gt;<a class="code" href="classElement.html#a74">tick</a>() + m2-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>());
00829                               <span class="keywordflow">return</span>;
00830                               }
00831                         <span class="keywordflow">if</span> (c1-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>())
00832                               up = <span class="keyword">false</span>;
00833                         <span class="keywordflow">else</span>
00834                               up = <span class="keyword">true</span>;
00835                         }
00836                   }
00837                   <span class="keywordflow">break</span>;
00838             }
00839 
00840       QPointF ppos(<a class="code" href="classElement.html#a35">apos</a>());
00841       <a class="code" href="classSystem.html">System</a> *s1, *s2;
00842 
00843       QPointF p1 = slurPos(<a class="code" href="classSlur.html#r0">_tick1</a>, <a class="code" href="classSlur.html#r4">_staff1</a>, <a class="code" href="classSlur.html#r2">_voice1</a>, s1);
00844       QPointF p2 = slurPos(<a class="code" href="classSlur.html#r1">_tick2</a>, <a class="code" href="classSlur.html#r5">_staff2</a>, <a class="code" href="classSlur.html#r3">_voice2</a>, s2);
00845 
00846       <a class="code" href="classpstl_1_1plist.html">iSystem</a> is = _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00847       <span class="keywordflow">while</span> (is != _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00848             <span class="keywordflow">if</span> (*is == s1)
00849                   <span class="keywordflow">break</span>;
00850             ++is;
00851             }
00852       setpos(0, 0);
00853 
00854       <span class="comment">//---------------------------------------------------------</span>
00855       <span class="comment">//   count number of segments, if no change, all</span>
00856       <span class="comment">//    user offsets (drags) are retained</span>
00857       <span class="comment">//---------------------------------------------------------</span>
00858 
00859       <span class="keywordtype">unsigned</span> nsegs = 1;
00860       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">iSystem</a> iis = is; (iis != _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) &amp;&amp; (*iis != s2); ++iis)
00861             ++nsegs;
00862 
00863       <span class="keywordtype">unsigned</span> onsegs = segments.size();
00864       <a class="code" href="classElementList.html">ElementList</a> segments1 = segments;
00865       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = segments1.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != segments1.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00866             <a class="code" href="classElement.html">Element</a>* el = *i;
00867             <a class="code" href="classElement.html">Element</a>* pa = el-&gt;<a class="code" href="classElement.html#a10">parent</a>();
00868 <span class="comment">// printf("Slur layout %d: remove segment %p from parent %p\n", segments.size(), el, pa);</span>
00869 
00870             <span class="keywordflow">if</span> (pa)           <span class="comment">// if layout was not called, parent is zero</span>
00871                   pa-&gt;<a class="code" href="classElement.html#a65">remove</a>(el);
00872             }
00873       segments.clear();
00874       <span class="keywordflow">if</span> (nsegs != onsegs) {
00875 <span class="comment">// printf("Slur layout: create new segment list\n");</span>
00876             <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = segments1.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != segments1.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00877                   <span class="keyword">delete</span> *i;
00878             segments1.clear();
00879             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; nsegs; ++i) {
00880                   <a class="code" href="classSlurSegment.html">SlurSegment</a>* s = <span class="keyword">new</span> <a class="code" href="classSlurSegment.html">SlurSegment</a>(<span class="keyword">this</span>);
00881                   segments1.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(s);
00882                   }
00883             }
00884 
00885       qreal bow = up ? 2*-<a class="code" href="spatium_8h.html#a0">_spatium</a> : 2*<a class="code" href="spatium_8h.html#a0">_spatium</a>;
00886       <a class="code" href="element_8h.html#a1">iElement</a> ibss = segments1.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00887       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; is != _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i, ++is, ++ibss) {
00888             <a class="code" href="classSystem.html">System</a>* system = *is;
00889             QPointF sp(system-&gt;<a class="code" href="classElement.html#a35">apos</a>());
00890             <a class="code" href="classSlurSegment.html">SlurSegment</a>* bs = (<a class="code" href="classSlurSegment.html">SlurSegment</a>*)*ibss;
00891             bs-&gt;<a class="code" href="classElement.html#a11">setParent</a>(<a class="code" href="classElement.html#a10">parent</a>());
00892             bs-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classElement.html#a59">staff</a>());
00893             <span class="comment">// case 1: one segment</span>
00894             <span class="keywordflow">if</span> (s1 == s2) {
00895                   bs-&gt;<a class="code" href="classSlurSegment.html#a4">layout</a>(p1, p2, bow);
00896                   }
00897             <span class="comment">// case 2: start segment</span>
00898             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 0) {
00899                   <a class="code" href="classSystem.html">System</a>* system = *is;
00900                   qreal x       = system-&gt;<a class="code" href="classElement.html#a35">apos</a>().x() + system-&gt;<a class="code" href="classElement.html#a33">bbox</a>().width();
00901                   bs-&gt;<a class="code" href="classSlurSegment.html#a4">layout</a>(p1, QPointF(x, p1.y()), bow);
00902                   }
00903             <span class="comment">// case 3: middle segment</span>
00904             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i != 0 &amp;&amp; *is != s2) {
00905                   <a class="code" href="classSystem.html">System</a>* system = *is;
00906                   <a class="code" href="classMeasure.html">Measure</a>* m = system-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a12">front</a>();
00907                   bs-&gt;<a class="code" href="classElement.html#a11">setParent</a>(m);
00908                   QPointF p = system-&gt;<a class="code" href="classElement.html#a35">apos</a>();
00909                   qreal x1 = p.x();
00910                   qreal x2 = x1 + system-&gt;<a class="code" href="classElement.html#a33">bbox</a>().width();
00911                   bs-&gt;<a class="code" href="classSlurSegment.html#a4">layout</a>(QPointF(x1, p.y()), QPointF(x2, p.y()), bow);
00912                   }
00913             <span class="comment">// case 4: end segment</span>
00914             <span class="keywordflow">else</span> {
00915                   <a class="code" href="classSystem.html">System</a>* system = *is;
00916                   <a class="code" href="classMeasure.html">Measure</a>* m = system-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a12">front</a>();
00917                   bs-&gt;<a class="code" href="classElement.html#a11">setParent</a>(m);
00918                   qreal x = system-&gt;<a class="code" href="classElement.html#a35">apos</a>().x();
00919                   bs-&gt;<a class="code" href="classSlurSegment.html#a4">layout</a>(QPointF(x, p2.y()), p2, bow);
00920                   }
00921 <span class="comment">// printf("Slur layout: add segment %p to parent %p\n", bs, bs-&gt;parent());</span>
00922             bs-&gt;<a class="code" href="classElement.html#a10">parent</a>()-&gt;<a class="code" href="classElement.html#a64">add</a>(bs);  <span class="comment">// puts segment also on segments list</span>
00923             <span class="keywordflow">if</span> (*is == s2)
00924                   <span class="keywordflow">break</span>;
00925             }
00926       _bbox = QRectF(0, 0, 0, 0);
00927       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = segments.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != segments.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00928             _bbox |= (*i)-&gt;abbox().translated(<a class="code" href="classElement.html#a35">apos</a>());
00929       }
00930 
00931 <span class="comment">//---------------------------------------------------------</span>
00932 <span class="comment">//   layout2</span>
00933 <span class="comment">//    snap to next tick positions</span>
00934 <span class="comment">//---------------------------------------------------------</span>
00935 
<a name="l00936"></a><a class="code" href="classSlur.html#a7">00936</a> <span class="keywordtype">void</span> <a class="code" href="classSlur.html#a7">Slur::layout2</a>(<span class="keyword">const</span> QPointF ppos, <span class="keywordtype">int</span> mode, <span class="keyword">struct</span> <a class="code" href="structUP.html">UP</a>&amp; ups)
00937       {
00938       <span class="comment">//</span>
00939       <span class="comment">// compute absolute position of control point on canvas:</span>
00940       <span class="comment">//</span>
00941       QPointF p(ups.<a class="code" href="structUP.html#o0">p</a> + ups.<a class="code" href="structUP.html#o1">off</a> * <a class="code" href="spatium_8h.html#a0">_spatium</a> + ppos);
00942 
00943       <a class="code" href="classSystem.html">System</a>* s;
00944       <span class="keywordflow">if</span> (mode == 1) {
00945             <span class="keywordtype">int</span> tick = _score-&gt;<a class="code" href="classScore.html#a28">snapNote</a>(<a class="code" href="classSlur.html#r0">_tick1</a>, p, <a class="code" href="classSlur.html#r4">_staff1</a>-&gt;<a class="code" href="classStaff.html#a15">idx</a>());
00946             <span class="keywordflow">if</span> (tick != <a class="code" href="classSlur.html#r0">_tick1</a>) {
00947                   <a class="code" href="classSlur.html#r0">_tick1</a>     = tick;
00948                   QPointF p2 = slurPos(<a class="code" href="classSlur.html#r0">_tick1</a>, <a class="code" href="classSlur.html#r4">_staff1</a>, <a class="code" href="classSlur.html#r2">_voice1</a>, s);
00949                   ups.<a class="code" href="structUP.html#o0">p</a>      = p2 - ppos;    <span class="comment">// relative to parent position</span>
00950                   ups.<a class="code" href="structUP.html#o1">off</a>    = (p - p2) / <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00951                   }
00952             }
00953       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mode == 4) {
00954             <span class="comment">//</span>
00955             <span class="comment">// search for nearest segment at p</span>
00956             <span class="comment">//</span>
00957             <span class="keywordtype">int</span> tick = _score-&gt;<a class="code" href="classScore.html#a28">snapNote</a>(<a class="code" href="classSlur.html#r1">_tick2</a>, p, <a class="code" href="classSlur.html#r5">_staff2</a>-&gt;<a class="code" href="classStaff.html#a15">idx</a>());
00958 
00959             <span class="comment">//</span>
00960             <span class="comment">// if found new segment, and reference point is different,</span>
00961             <span class="comment">// then update ups.p and ups.off</span>
00962             <span class="comment">//</span>
00963             <span class="keywordflow">if</span> (tick != <a class="code" href="classSlur.html#r1">_tick2</a>) {
00964                   <a class="code" href="classSlur.html#r1">_tick2</a>         = tick;
00965                   QPointF p2         = slurPos(<a class="code" href="classSlur.html#r1">_tick2</a>, <a class="code" href="classSlur.html#r5">_staff2</a>, <a class="code" href="classSlur.html#r3">_voice2</a>, s);
00966                   ups.<a class="code" href="structUP.html#o0">p</a>   = p2 - ppos;    <span class="comment">// relative to parent position</span>
00967                   ups.<a class="code" href="structUP.html#o1">off</a> = (p - p2) / <a class="code" href="spatium_8h.html#a0">_spatium</a>;
00968                   }
00969             }
00970       }
00971 
00972 <span class="comment">//---------------------------------------------------------</span>
00973 <span class="comment">//   Tie</span>
00974 <span class="comment">//---------------------------------------------------------</span>
00975 
<a name="l00976"></a><a class="code" href="classTie.html#a0">00976</a> <a class="code" href="classTie.html#a0">Tie::Tie</a>(<a class="code" href="classScore.html">Score</a>* s)
00977    : <a class="code" href="classSlurTie.html">SlurTie</a>(s, <a class="code" href="element_8h.html#a65a27">TIE</a>)
00978       {
00979       <a class="code" href="classTie.html#r0">_startNote</a> = 0;
00980       <a class="code" href="classTie.html#r1">_endNote</a>   = 0;
00981       }
00982 
<a name="l00983"></a><a class="code" href="classTie.html#a1">00983</a> <a class="code" href="classTie.html#a0">Tie::Tie</a>(<span class="keyword">const</span> <a class="code" href="classTie.html">Tie</a>&amp; s)
00984    : <a class="code" href="classSlurTie.html">SlurTie</a>(s)
00985       {
00986       <a class="code" href="classTie.html#r0">_startNote</a> = s.<a class="code" href="classTie.html#r0">_startNote</a>;
00987       <a class="code" href="classTie.html#r1">_endNote</a>   = s.<a class="code" href="classTie.html#r1">_endNote</a>;
00988       }
00989 
00990 <span class="comment">//---------------------------------------------------------</span>
00991 <span class="comment">//   setStartNote</span>
00992 <span class="comment">//---------------------------------------------------------</span>
00993 
<a name="l00994"></a><a class="code" href="classTie.html#a3">00994</a> <span class="keywordtype">void</span> <a class="code" href="classTie.html#a3">Tie::setStartNote</a>(<a class="code" href="classNote.html">Note</a>* note)
00995       {
00996       <a class="code" href="classTie.html#r0">_startNote</a> = note;
00997       setParent(note);
00998       }
00999 
01000 <span class="comment">//---------------------------------------------------------</span>
01001 <span class="comment">//   write</span>
01002 <span class="comment">//---------------------------------------------------------</span>
01003 
<a name="l01004"></a><a class="code" href="classTie.html#a7">01004</a> <span class="keywordtype">void</span> <a class="code" href="classTie.html#a7">Tie::write</a>(<a class="code" href="classXml.html">Xml</a>&amp; xml)<span class="keyword"> const</span>
01005 <span class="keyword">      </span>{
01006       xml.<a class="code" href="classXml.html#a8">tag</a>(<span class="stringliteral">"Tie"</span>);
01007       Element::writeProperties(xml);
01008       SlurTie::writeProperties(xml);
01009       xml.<a class="code" href="classXml.html#a9">etag</a>(<span class="stringliteral">"Tie"</span>);
01010       }
01011 
01012 <span class="comment">//---------------------------------------------------------</span>
01013 <span class="comment">//   read</span>
01014 <span class="comment">//---------------------------------------------------------</span>
01015 
<a name="l01016"></a><a class="code" href="classTie.html#a8">01016</a> <span class="keywordtype">void</span> <a class="code" href="classTie.html#a8">Tie::read</a>(QDomNode node)
01017       {
01018       node = node.firstChild();
01019       <span class="keywordflow">while</span> (!node.isNull()) {
01020             QDomElement e = node.toElement();
01021             QString tag(e.tagName());
01022             QString val(e.text());
01023             <span class="keywordflow">if</span> (SlurTie::readProperties(node))
01024                   ;
01025             <span class="keywordflow">else</span>
01026                   printf(<span class="stringliteral">"Mscore:Tie: unknown tag %s\n"</span>,
01027                      tag.latin1());
01028             node = node.nextSibling();
01029             }
01030       }
01031 
01032 <span class="comment">//---------------------------------------------------------</span>
01033 <span class="comment">//   layout</span>
01034 <span class="comment">//---------------------------------------------------------</span>
01035 
<a name="l01036"></a><a class="code" href="classTie.html#a9">01036</a> <span class="keywordtype">void</span> <a class="code" href="classTie.html#a9">Tie::layout</a>()
01037       {
01038       <span class="comment">//</span>
01039       <span class="comment">// TODO: if there is a startNote but no endNote</span>
01040       <span class="comment">//    show short bow</span>
01041 
01042       <span class="keywordflow">if</span> (<a class="code" href="classTie.html#r0">_startNote</a> == 0 || <a class="code" href="classTie.html#r1">_endNote</a> == 0)
01043             <span class="keywordflow">return</span>;
01044 
01045       <a class="code" href="classChord.html">Chord</a>* c1   = <a class="code" href="classTie.html#r0">_startNote</a>-&gt;<a class="code" href="classNote.html#a37">chord</a>();
01046       <a class="code" href="classMeasure.html">Measure</a>* m1 = c1-&gt;<a class="code" href="classChordRest.html#a11">measure</a>();
01047       <a class="code" href="classSystem.html">System</a>* s1  = m1-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
01048       <a class="code" href="classChord.html">Chord</a>* c2   = <a class="code" href="classTie.html#r1">_endNote</a>-&gt;<a class="code" href="classNote.html#a37">chord</a>();
01049       <a class="code" href="classMeasure.html">Measure</a>* m2 = c2-&gt;<a class="code" href="classChordRest.html#a11">measure</a>();
01050       <a class="code" href="classSystem.html">System</a>* s2  = m2-&gt;<a class="code" href="classMeasure.html#a40">system</a>();
01051 
01052       <span class="keywordflow">if</span> (_slurDirection == <a class="code" href="globals_8h.html#a24a7">AUTO</a>)
01053             up = !c1-&gt;<a class="code" href="classChordRest.html#a19">isUp</a>();
01054       <span class="keywordflow">else</span>
01055             up = _slurDirection == <a class="code" href="structUP.html">UP</a> ? <span class="keyword">true</span> : <span class="keyword">false</span>;
01056       qreal h   = 3.0; <span class="comment">// w * 0.3;</span>
01057       qreal yo  = up ? -h : h;
01058 
01059       QPointF off1(6.0, yo);
01060       QPointF off2(0.0, yo);
01061 
01062       QPointF ppos(<a class="code" href="classElement.html#a35">apos</a>());
01063       QPointF p1 = <a class="code" href="classTie.html#r0">_startNote</a>-&gt;<a class="code" href="classElement.html#a35">apos</a>() + off1;
01064       QPointF p2 = <a class="code" href="classTie.html#r1">_endNote</a>-&gt;<a class="code" href="classElement.html#a35">apos</a>()   + off2;
01065 
01066       <a class="code" href="classpstl_1_1plist.html">iSystem</a> is = _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
01067       <span class="keywordflow">while</span> (is != _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
01068             <span class="keywordflow">if</span> (*is == s1)
01069                   <span class="keywordflow">break</span>;
01070             ++is;
01071             }
01072       setpos(0, 0);
01073 
01074       <span class="comment">//---------------------------------------------------------</span>
01075       <span class="comment">//   count number of segments, if no change, all</span>
01076       <span class="comment">//    user offsets (drags) are retained</span>
01077       <span class="comment">//---------------------------------------------------------</span>
01078 
01079       <span class="keywordtype">unsigned</span> nsegs = 1;
01080       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">iSystem</a> iis = is; (iis != _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) &amp;&amp; (*iis != s2); ++iis)
01081             ++nsegs;
01082 
01083       <span class="keywordtype">unsigned</span> onsegs = segments.size();
01084       <a class="code" href="classElementList.html">ElementList</a> segments1 = segments;
01085       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = segments1.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != segments1.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
01086             <a class="code" href="classElement.html">Element</a>* el = *i;
01087             <a class="code" href="classElement.html">Element</a>* pa = el-&gt;<a class="code" href="classElement.html#a10">parent</a>();
01088             <span class="keywordflow">if</span> (pa)           <span class="comment">// if layout was not called, parent is zero</span>
01089                   pa-&gt;<a class="code" href="classElement.html#a65">remove</a>(el);
01090             }
01091       segments.clear();
01092       <span class="keywordflow">if</span> (nsegs != onsegs) {
01093             <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = segments1.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != segments1.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
01094                   <span class="keyword">delete</span> *i;
01095             segments1.clear();
01096             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i &lt; nsegs; ++i) {
01097                   <a class="code" href="classSlurSegment.html">SlurSegment</a>* s = <span class="keyword">new</span> <a class="code" href="classSlurSegment.html">SlurSegment</a>(<span class="keyword">this</span>);
01098                   segments1.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(s);
01099                   }
01100             }
01101 
01102       qreal bow = up ? -<a class="code" href="spatium_8h.html#a0">_spatium</a> : <a class="code" href="spatium_8h.html#a0">_spatium</a>;
01103       <a class="code" href="element_8h.html#a1">iElement</a> ibss = segments1.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
01104       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; is != _score-&gt;<a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i, ++is, ++ibss) {
01105             <a class="code" href="classSystem.html">System</a>* system = *is;
01106             QPointF sp(system-&gt;<a class="code" href="classElement.html#a35">apos</a>());
01107             <a class="code" href="classSlurSegment.html">SlurSegment</a>* bs = (<a class="code" href="classSlurSegment.html">SlurSegment</a>*)*ibss;
01108             bs-&gt;<a class="code" href="classElement.html#a11">setParent</a>(m1);
01109             bs-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classElement.html#a59">staff</a>());
01110             <span class="comment">// case 1: one segment</span>
01111             <span class="keywordflow">if</span> (s1 == s2) {
01112                   bs-&gt;<a class="code" href="classSlurSegment.html#a4">layout</a>(p1, p2, bow);
01113                   }
01114             <span class="comment">// case 2: start segment</span>
01115             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 0) {
01116                   bs-&gt;<a class="code" href="classSlurSegment.html#a4">layout</a>(p1, QPointF(p1.x()+2*<a class="code" href="spatium_8h.html#a0">_spatium</a>, p1.y()), bow);
01117                   }
01118             <span class="comment">// case 3: end segment</span>
01119             <span class="keywordflow">else</span> {
01120                   <a class="code" href="classMeasure.html">Measure</a>* m = (*is)-&gt;measures()-&gt;front();
01121                   bs-&gt;<a class="code" href="classElement.html#a11">setParent</a>(m);
01122                   bs-&gt;<a class="code" href="classSlurSegment.html#a4">layout</a>(QPointF(p2.x()-2*<a class="code" href="spatium_8h.html#a0">_spatium</a>, p2.y()), p2, bow);
01123                   }
01124             bs-&gt;<a class="code" href="classElement.html#a10">parent</a>()-&gt;<a class="code" href="classElement.html#a64">add</a>(bs);  <span class="comment">// puts segment also on segments list</span>
01125             <span class="keywordflow">if</span> (*is == s2)
01126                   <span class="keywordflow">break</span>;
01127             }
01128       }
01129 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
