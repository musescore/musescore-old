<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: layout.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>layout.cpp</h1><a href="layout_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: layout.cpp,v 1.36 2005/06/27 19:50:20 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="key_8h.html">key.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="navigate_8h.html">navigate.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="input_8h.html">input.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00024 
00025 <span class="comment">//---------------------------------------------------------</span>
00026 <span class="comment">//   searchNote</span>
00027 <span class="comment">//    search for note or rest before or at tick position tick</span>
00028 <span class="comment">//    in staff</span>
00029 <span class="comment">//---------------------------------------------------------</span>
00030 
<a name="l00031"></a><a class="code" href="classScore.html#a57">00031</a> <a class="code" href="classElement.html">Element</a>* <a class="code" href="classScore.html#a57">Score::searchNote</a>(<span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> staff)<span class="keyword"> const</span>
00032 <span class="keyword">      </span>{
00033       <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="classMeasure.html">Measure</a>* measure = <a class="code" href="classScore.html#a100">first</a>(); measure; measure = measure-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00034             <a class="code" href="classElement.html">Element</a>* ipe = 0;
00035             <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = measure-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00036                   <a class="code" href="classElement.html">Element</a>* ie  = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(staff);
00037                   <span class="keywordflow">if</span> (ie-&gt;<a class="code" href="classElement.html#a74">tick</a>() == tick)
00038                         <span class="keywordflow">return</span> ie;
00039                   <span class="keywordflow">if</span> (ie-&gt;<a class="code" href="classElement.html#a74">tick</a>() &gt;  tick)
00040                         <span class="keywordflow">return</span> ipe ? ipe : ie;
00041                   ipe = ie;
00042                   }
00043             }
00044       <span class="keywordflow">return</span> 0;
00045       }
00046 
00047 <span class="comment">//---------------------------------------------------------</span>
00048 <span class="comment">//   clefOffset</span>
00049 <span class="comment">//---------------------------------------------------------</span>
00050 
<a name="l00051"></a><a class="code" href="classScore.html#a43">00051</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a43">Score::clefOffset</a>(<span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> staffIdx)<span class="keyword"> const</span>
00052 <span class="keyword">      </span>{
00053       <span class="keywordflow">return</span> <a class="code" href="clef_8h.html#a0">clefTable</a>[<a class="code" href="classScore.html#a7">staff</a>(staffIdx)-&gt;clef()-&gt;clef(tick)].<a class="code" href="structClefInfo.html#o2">yOffset</a>;
00054       }
00055 
<a name="l00056"></a><a class="code" href="classScore.html#a42">00056</a> <span class="keywordtype">int</span> <a class="code" href="classScore.html#a42">Score::clefPitchOffset</a>(<span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> staffIdx)<span class="keyword"> const</span>
00057 <span class="keyword">      </span>{
00058       <span class="keywordflow">return</span> <a class="code" href="clef_8h.html#a0">clefTable</a>[<a class="code" href="classScore.html#a7">staff</a>(staffIdx)-&gt;clef()-&gt;clef(tick)].<a class="code" href="structClefInfo.html#o3">pitchOffset</a>;
00059       }
00060 
00061 <span class="comment">//---------------------------------------------------------</span>
00062 <span class="comment">//   doLayout</span>
00063 <span class="comment">//    place all elements in staves into page structure</span>
00064 <span class="comment">//---------------------------------------------------------</span>
00065 
<a name="l00066"></a><a class="code" href="classScore.html#a51">00066</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a51">Score::doLayout</a>()
00067       {
00068       <a class="code" href="classScore.html#r2">_needLayout</a> = <span class="keyword">false</span>;
00069       <a class="code" href="classMeasure.html">Measure</a>* im = <a class="code" href="classScore.html#a100">first</a>();
00070       <a class="code" href="page_8h.html#a0">iPage</a>    ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00071       <a class="code" href="classpstl_1_1plist.html">iSystem</a>  is = <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>();
00072 
00073       <span class="comment">//-----------------------------------------</span>
00074       <span class="comment">//    pass I:  process pages</span>
00075       <span class="comment">//-----------------------------------------</span>
00076 
00077       <span class="keywordflow">while</span> (im) {
00078             <a class="code" href="classPage.html">Page</a>* page;
00079             <span class="keywordflow">if</span> (ip == <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00080                   page = <a class="code" href="classScore.html#a25">addPage</a>();
00081                   ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>();
00082                   page-&gt;<a class="code" href="classPage.html#a19">layout</a>();
00083                   }
00084             <span class="keywordflow">else</span> {
00085                   page = *ip;
00086                   ++ip;
00087                   }
00088             <a class="code" href="classScore.html#a52">layoutPage</a>(page, im, is);
00089             <a class="code" href="classScore.html#r1">refresh</a> |= page-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00090             }
00091 
00092       <span class="comment">//---------------------------------------------------</span>
00093       <span class="comment">//   pass II:  place ties &amp; slurs &amp; hairpins</span>
00094       <span class="comment">//---------------------------------------------------</span>
00095 
00096       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00097             m-&gt;<a class="code" href="classMeasure.html#a48">layout2</a>();
00098             }
00099 
00100       <span class="comment">//---------------------------------------------------</span>
00101       <span class="comment">//    remove uneccesary pages</span>
00102       <span class="comment">//---------------------------------------------------</span>
00103 
00104       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a0">iPage</a> i = ip; i != <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00105             <a class="code" href="classScore.html#r1">refresh</a> |= (*i)-&gt;abbox();
00106             <span class="keyword">delete</span> *i;
00107             }
00108       <a class="code" href="classScore.html#o12">pages</a>-&gt;erase(ip, <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>());
00109       }
00110 
00111 <span class="comment">//---------------------------------------------------------</span>
00112 <span class="comment">//   processSystemHeader</span>
00113 <span class="comment">//    add generated timesig keysig and clef</span>
00114 <span class="comment">//---------------------------------------------------------</span>
00115 
<a name="l00116"></a><a class="code" href="classScore.html#d6">00116</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#d6">Score::processSystemHeader</a>(<a class="code" href="classMeasure.html">Measure</a>* m)
00117       {
00118       <span class="keywordtype">int</span> tick = m-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00119       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classScore.html#a6">nstaves</a>(); ++i) {
00120             <a class="code" href="classStaff.html">Staff</a>* staffp   = <a class="code" href="classScore.html#a7">staff</a>(i);
00121             <span class="keywordtype">bool</span> hasTimesig = <span class="keyword">false</span>;
00122             <span class="keywordtype">bool</span> hasKeysig  = <span class="keyword">false</span>;
00123             <span class="keywordtype">bool</span> hasClef    = <span class="keyword">false</span>;
00124             <span class="keywordtype">int</span> strack      = i * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00125             <span class="keywordtype">int</span> etrack      = strack + <a class="code" href="globals_8h.html#a3">VOICES</a>;
00126 
00127             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = strack; track &lt; etrack; ++track) {
00128                   <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00129                         <span class="keywordflow">if</span> (seg-&gt;<a class="code" href="classSegment.html#a18">type</a>() == Segment::SegChordRest)
00130                               <span class="keywordflow">break</span>;
00131                         <a class="code" href="classElement.html">Element</a>* el = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00132                         <span class="keywordflow">if</span> (!el)
00133                               <span class="keywordflow">continue</span>;
00134                         <span class="keywordflow">switch</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>()) {
00135                               <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a24">TIMESIG</a>:
00136                                     hasTimesig = <span class="keyword">true</span>;
00137                                     <span class="keywordflow">break</span>;
00138                               <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a23">KEYSIG</a>:
00139                                     hasKeysig = <span class="keyword">true</span>;
00140                                     <span class="keywordflow">break</span>;
00141                               <span class="keywordflow">case</span> <a class="code" href="element_8h.html#a65a22">CLEF</a>:
00142                                     hasClef = <span class="keyword">true</span>;
00143                                     ((<a class="code" href="classClef.html">Clef</a>*)el)-&gt;setSmall(<span class="keyword">false</span>);
00144                                     <span class="keywordflow">break</span>;
00145                               <span class="keywordflow">default</span>:
00146                                     <span class="keywordflow">break</span>;
00147                               }
00148                         }
00149                   }
00150             <span class="keywordflow">if</span> (tick == 0 &amp;&amp; !hasTimesig) {
00151 <span class="comment">// printf("Layout: %p no Timesig\n", m);</span>
00152                   <span class="keywordtype">int</span> z, n;
00153                   <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a6">timesig</a>(tick, z, n);
00154                   <a class="code" href="classTimeSig.html">TimeSig</a>* ts = <span class="keyword">new</span> <a class="code" href="classTimeSig.html">TimeSig</a>(<span class="keyword">this</span>);
00155                   ts-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staffp);
00156                   ts-&gt;<a class="code" href="classElement.html#a75">setTick</a>(tick);
00157                   ts-&gt;<a class="code" href="classTimeSig.html#a9">setSig</a>(z, n);
00158                   ts-&gt;<a class="code" href="classElement.html#a19">setGenerated</a>(<span class="keyword">true</span>);
00159                   m-&gt;<a class="code" href="classMeasure.html#a8">add</a>(ts);
00160                   }
00161             <span class="keywordflow">if</span> (!hasKeysig) {
00162                   <span class="keywordtype">int</span> clef = staff(i)-&gt;<a class="code" href="classStaff.html#a2">clef</a>()-&gt;<a class="code" href="classClefList.html#a1">clef</a>(tick);
00163                   <span class="keywordtype">int</span> <a class="code" href="classScore.html#a43">clefOffset</a> = <a class="code" href="clef_8h.html#a0">clefTable</a>[clef].<a class="code" href="structClefInfo.html#o2">yOffset</a>;
00164                   <span class="keywordtype">int</span> idx = <a class="code" href="classScore.html#o10">keymap</a>-&gt;<a class="code" href="classKeyList.html#a1">key</a>(tick);
00165                   <span class="keywordflow">if</span> (idx) {
00166                         <a class="code" href="classKeySig.html">KeySig</a>* ks = <span class="keyword">new</span> <a class="code" href="classKeySig.html">KeySig</a>(<span class="keyword">this</span>, idx, clefOffset);
00167                         ks-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staffp);
00168                         ks-&gt;<a class="code" href="classElement.html#a75">setTick</a>(tick);
00169                         ks-&gt;<a class="code" href="classElement.html#a19">setGenerated</a>(<span class="keyword">true</span>);
00170                         m-&gt;<a class="code" href="classMeasure.html#a8">add</a>(ks);
00171                         }
00172                   }
00173             <span class="keywordflow">if</span> (!hasClef) {
00174                   <span class="keywordtype">int</span> idx = staff(i)-&gt;<a class="code" href="classStaff.html#a2">clef</a>()-&gt;<a class="code" href="classClefList.html#a1">clef</a>(tick);
00175                   <a class="code" href="classClef.html">Clef</a>* cs = <span class="keyword">new</span> <a class="code" href="classClef.html">Clef</a>(<span class="keyword">this</span>, idx, <span class="keyword">false</span>);
00176                   cs-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staffp);
00177                   cs-&gt;<a class="code" href="classElement.html#a75">setTick</a>(tick);
00178                   cs-&gt;<a class="code" href="classElement.html#a19">setGenerated</a>(<span class="keyword">true</span>);
00179                   m-&gt;<a class="code" href="classMeasure.html#a8">add</a>(cs);
00180                   }
00181             }
00182       }
00183 
00184 <span class="comment">//---------------------------------------------------------</span>
00185 <span class="comment">//   clearGenerated</span>
00186 <span class="comment">//    remove generated elements form measure</span>
00187 <span class="comment">//---------------------------------------------------------</span>
00188 
<a name="l00189"></a><a class="code" href="classScore.html#d7">00189</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#d7">Score::clearGenerated</a>(<a class="code" href="classMeasure.html">Measure</a>* m)
00190       {
00191       <span class="keywordtype">int</span> n = <a class="code" href="classScore.html#a6">nstaves</a>() * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00192       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n; ++i) {
00193             <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00194                   <span class="keywordflow">if</span> (seg == 0)
00195                         <span class="keywordflow">continue</span>;
00196                   <a class="code" href="classElement.html">Element</a>* el = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(i);
00197                   <span class="keywordflow">if</span> (el &amp;&amp; el-&gt;<a class="code" href="classElement.html#a18">generated</a>()) {
00198                         seg-&gt;<a class="code" href="classSegment.html#a10">setElement</a>(i, 0);
00199                         }
00200                   }
00201             }
00202       }
00203 
00204 <span class="comment">//---------------------------------------------------------</span>
00205 <span class="comment">//   addMeasure</span>
00206 <span class="comment">//---------------------------------------------------------</span>
00207 
<a name="l00208"></a><a class="code" href="classPage.html#a6">00208</a> <span class="keywordtype">double</span> <a class="code" href="classPage.html#a6">Page::addMeasure</a>(<a class="code" href="classMeasure.html">Measure</a>* m, <span class="keywordtype">double</span> y)
00209       {
00210       <span class="comment">//---------------------------------------------------</span>
00211       <span class="comment">//    collect page elements from measure</span>
00212       <span class="comment">//---------------------------------------------------</span>
00213 
00214       <a class="code" href="classElementList.html">ElementList</a> sel = *(m-&gt;<a class="code" href="classMeasure.html#a13">pel</a>());
00215       m-&gt;<a class="code" href="classMeasure.html#a13">pel</a>()-&gt;clear();
00216       <span class="keywordtype">bool</span> textFound = <span class="keyword">false</span>;
00217       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> ie = sel.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ie != sel.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ie) {
00218             <a class="code" href="classElement.html">Element</a>* el = *ie;
00219             <a class="code" href="classPage.html#a16">add</a>(el);
00220             el-&gt;<a class="code" href="classElement.html#a66">layout</a>();
00221             <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a8">TEXT</a>) {
00222                   <span class="keywordtype">int</span> <a class="code" href="style_8cpp.html#a1">style</a> = ((<a class="code" href="classSText.html">SText</a>*)el)-&gt;style();
00223                   <span class="keywordflow">if</span> (<a class="code" href="style_8cpp.html#a1">style</a> == <a class="code" href="style_8h.html#a45a21">TEXT_STYLE_TITLE</a>
00224                      || <a class="code" href="style_8cpp.html#a1">style</a> == <a class="code" href="style_8h.html#a45a22">TEXT_STYLE_SUBTITLE</a>
00225                      || <a class="code" href="style_8cpp.html#a1">style</a> == <a class="code" href="style_8h.html#a45a23">TEXT_STYLE_COMPOSER</a>
00226                      || <a class="code" href="style_8cpp.html#a1">style</a> == <a class="code" href="style_8h.html#a45a24">TEXT_STYLE_POET</a>
00227                      || <a class="code" href="style_8cpp.html#a1">style</a> == <a class="code" href="style_8h.html#a45a37">TEXT_STYLE_TRANSLATOR</a>) {
00228                         <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a20">pos</a>().y() &gt; y)
00229                               y = el-&gt;<a class="code" href="classElement.html#a20">pos</a>().y();
00230                         textFound = <span class="keyword">true</span>;
00231                         }
00232                   }
00233             }
00234       <span class="keywordflow">if</span> (textFound)
00235             y += point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o0">staffUpperBorder</a>);
00236       <span class="keywordflow">return</span> y;
00237       }
00238 
00239 <span class="comment">//---------------------------------------------------------</span>
00240 <span class="comment">//   layoutPage</span>
00241 <span class="comment">//    return true, if next page must be relayouted</span>
00242 <span class="comment">//---------------------------------------------------------</span>
00243 
<a name="l00244"></a><a class="code" href="classScore.html#a52">00244</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a52">Score::layoutPage</a>(<a class="code" href="classPage.html">Page</a>* page, <a class="code" href="classMeasure.html">Measure</a>*&amp; im, <a class="code" href="classpstl_1_1plist.html">iSystem</a>&amp; is)
00245       {
00246       <span class="keywordtype">bool</span> reformatNextPage = <span class="keyword">false</span>;
00247 
00248       <span class="comment">// usable width of page:</span>
00249       <span class="keywordtype">double</span> w  = <a class="code" href="classScore.html#a135">pageFormat</a>()-&gt;<a class="code" href="structPageFormat.html#a1">width</a>() - page-&gt;<a class="code" href="classPage.html#a12">lm</a>() - page-&gt;<a class="code" href="classPage.html#a13">rm</a>();
00250       <span class="keywordtype">double</span> x  = page-&gt;<a class="code" href="classPage.html#a12">lm</a>();
00251       <span class="keywordtype">double</span> ey = page-&gt;<a class="code" href="classElement.html#a36">height</a>() - page-&gt;<a class="code" href="classPage.html#a11">bm</a>() - point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o1">staffLowerBorder</a>);
00252 
00253       page-&gt;<a class="code" href="classPage.html#a4">systems</a>()-&gt;clear();
00254       page-&gt;<a class="code" href="classPage.html#a14">pel</a>()-&gt;clear();
00255       <span class="keywordtype">double</span> y = page-&gt;<a class="code" href="classPage.html#a6">addMeasure</a>(im, page-&gt;<a class="code" href="classPage.html#a10">tm</a>());
00256 
00257       <span class="keywordflow">while</span> (im) {
00258             <span class="comment">// get next system:</span>
00259             <a class="code" href="classSystem.html">System</a>* system;
00260             <span class="keywordflow">if</span> (is == <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00261                   system = <span class="keyword">new</span> <a class="code" href="classSystem.html">System</a>(<span class="keyword">this</span>);
00262                   <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(system);
00263                   is = <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>();
00264                   --is;
00265                   }
00266             <span class="keywordflow">else</span>
00267                   system = *is;
00268 
00269             QPointF systemPos(x, y);
00270             system-&gt;<a class="code" href="classElement.html#a11">setParent</a>(page);
00271             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> oldMeasures = system-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;size();
00272             system-&gt;<a class="code" href="classSystem.html#a8">clear</a>();   <span class="comment">// remove measures from system</span>
00273             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = system-&gt;<a class="code" href="classSystem.html#a12">staves</a>()-&gt;size(); i &lt; <a class="code" href="classScore.html#a6">nstaves</a>(); ++i)
00274                   system-&gt;<a class="code" href="classSystem.html#a16">insertStaff</a>(<a class="code" href="classScore.html#a7">staff</a>(i), i);
00275             system-&gt;<a class="code" href="classSystem.html#a6">layout</a>(systemPos, w);
00276 
00277             <span class="keywordtype">double</span> h = system-&gt;<a class="code" href="classElement.html#a33">bbox</a>().height() + point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o4">systemDistance</a>);
00278             <span class="keywordflow">if</span> (y + h &gt;= ey) { <span class="comment">// system does not fit on page</span>
00279                   <span class="keywordflow">break</span>;
00280                   }
00281             page-&gt;<a class="code" href="classPage.html#a5">appendSystem</a>(system);
00282 
00283             <span class="comment">//-------------------------------------------------------</span>
00284             <span class="comment">//    Round I</span>
00285             <span class="comment">//    find out how many measures fit on current line</span>
00286             <span class="comment">//-------------------------------------------------------</span>
00287 
00288             <span class="keywordtype">int</span> nm              = 0;
00289             <span class="keywordtype">double</span> systemOffset = point(system-&gt;<a class="code" href="classSystem.html#a19">minWidth</a>());
00290             <span class="keywordtype">double</span> systemWidth  = w - systemOffset;
00291             <span class="keywordtype">double</span> minWidth     = 0;
00292             std::vector&lt;double&gt; mwList;
00293             <span class="keywordtype">double</span> uStretch = 0.0;
00294 
00295             <span class="keywordtype">bool</span> <a class="code" href="classScore.html#i22">pageBreak</a> = <span class="keyword">false</span>;
00296             <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = im; m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00297                   pageBreak = m-&gt;<a class="code" href="classMeasure.html#a34">pageBreak</a>();
00298                   <span class="keywordflow">if</span> (nm &amp;&amp; m-&gt;<a class="code" href="classMeasure.html#a33">lineBreak</a>())
00299                         <span class="keywordflow">break</span>;
00300                   <a class="code" href="classScore.html#d7">clearGenerated</a>(m);
00301                   <span class="keywordflow">if</span> (m == im)
00302                         <a class="code" href="classScore.html#d6">processSystemHeader</a>(m);  <span class="comment">// add generated clef+keysig+timesig</span>
00303                   <span class="keywordflow">else</span> {
00304                         <span class="comment">// collect page elements:</span>
00305                         <span class="comment">// first measure of this page was already processed</span>
00306                         <span class="comment">// above; this is necessary to process elements which</span>
00307                         <span class="comment">// modify page layout like title, composer etc.</span>
00308 
00309                         page-&gt;<a class="code" href="classPage.html#a6">addMeasure</a>(m, 0.0);
00310                         }
00311 
00312                   m-&gt;<a class="code" href="classMeasure.html#a41">setSystem</a>(system);   <span class="comment">// needed by m-&gt;layout()</span>
00313                   <a class="code" href="structMeasureWidth.html">MeasureWidth</a> mw = m-&gt;<a class="code" href="classMeasure.html#a45">layoutX</a>(1.0);
00314                   <span class="keywordtype">double</span> ww = mw.<a class="code" href="structMeasureWidth.html#o0">stretchable</a>;
00315 
00316                   mwList.push_back(ww);
00317                   <span class="keywordtype">double</span> stretch = m-&gt;<a class="code" href="classMeasure.html#a32">userStretch</a>() * ::style-&gt;measureSpacing;
00318                   ww *= stretch;
00319                   <span class="keywordflow">if</span> (ww &lt; point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o5">minMeasureWidth</a>))
00320                         ww = point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o5">minMeasureWidth</a>);
00321 
00322                   <span class="keywordflow">if</span> (minWidth + ww &gt; systemWidth) {
00323                         <span class="comment">// minimum is one measure</span>
00324                         <span class="keywordflow">if</span> (nm == 0) {
00325                               minWidth  += ww;
00326                               nm = 1;
00327                               printf(<span class="stringliteral">"warning: system too small (%f+%f) &gt; %f\n"</span>,
00328                                  minWidth, ww, systemWidth);
00329                               <span class="comment">// bad things are happening here</span>
00330                               }
00331                         <span class="keywordflow">break</span>;
00332                         }
00333 <span class="comment">//                  totalTicks += m-&gt;tickLen();</span>
00334                   ++nm;
00335                   minWidth  += ww;
00336                   uStretch  += stretch;
00337                   <span class="keywordflow">if</span> (pageBreak)
00338                         <span class="keywordflow">break</span>;
00339                   }
00340 
00341             <span class="comment">//-------------------------------------------------------</span>
00342             <span class="comment">//    Round II</span>
00343             <span class="comment">//    stretch measures</span>
00344             <span class="comment">//    "nm" measures fit on this line of score</span>
00345             <span class="comment">//    "minWidth"   is the minimum width they occupy</span>
00346             <span class="comment">//    "totalTicks" is the lenght of all nm measure</span>
00347             <span class="comment">//    uStretch is the accumulated userStretch</span>
00348             <span class="comment">//-------------------------------------------------------</span>
00349 
00350             minWidth = 0.0;
00351             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nm; ++i)
00352                   minWidth += mwList[i];
00353 
00354             <span class="keywordtype">double</span> sf = <a class="code" href="project_8cpp.html#a4">layoutDebug</a> ? 0.0 : (systemWidth - minWidth)/uStretch;
00355             QPointF pos(systemOffset, 0);
00356 
00357             <a class="code" href="classMeasure.html">Measure</a>* itt = im;
00358             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nm; ++i) {
00359                   <span class="keywordtype">double</span> ww  = mwList[i];
00360                   system-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(itt);
00361                   itt-&gt;<a class="code" href="classElement.html#a23">setpos</a>(pos);
00362                   ww += sf * itt-&gt;<a class="code" href="classMeasure.html#a32">userStretch</a>() * ::style-&gt;measureSpacing;
00363 
00364                   <span class="comment">//-----------------------------</span>
00365                   itt-&gt;<a class="code" href="classMeasure.html#a46">layout</a>(ww);
00366                   <span class="comment">//-----------------------------</span>
00367 
00368                   pos.rx() += ww;
00369                   itt = itt-&gt;<a class="code" href="classMeasure.html#a64">next</a>();
00370                   <span class="keywordflow">if</span> (!itt)
00371                         <span class="keywordflow">break</span>;
00372                   }
00373 
00374             system-&gt;<a class="code" href="classSystem.html#a7">layout2</a>();
00375 
00376             <span class="comment">//  move system vertically to final position:</span>
00377 
00378             <span class="keywordtype">double</span> systemDistance = system-&gt;<a class="code" href="classSystem.html#a14">distance</a>(0);
00379             system-&gt;<a class="code" href="classElement.html#a25">move</a>(0.0, systemDistance);
00380             y += system-&gt;<a class="code" href="classElement.html#a33">bbox</a>().height() + systemDistance;
00381 
00382             im = itt;
00383 
00384             <span class="keywordflow">if</span> (is != <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>())
00385                   ++is;
00386             reformatNextPage = reformatNextPage
00387                || (oldMeasures != system-&gt;<a class="code" href="classSystem.html#a10">measures</a>()-&gt;size());
00388             <span class="keywordflow">if</span> (pageBreak)
00389                   <span class="keywordflow">break</span>;
00390             }
00391 
00392       <span class="comment">//-----------------------------------------------------------------------</span>
00393       <span class="comment">// if remaining y space on page is greater (pageHeight*pageFillLimit)</span>
00394       <span class="comment">// then insert space between staffs to fill page</span>
00395       <span class="comment">//-----------------------------------------------------------------------</span>
00396 
00397       <span class="keywordtype">double</span> restHeight = ey - y;
00398       <span class="keywordtype">double</span> ph = page-&gt;<a class="code" href="classElement.html#a36">height</a>()
00399             - point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o1">staffLowerBorder</a> + ::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o0">staffUpperBorder</a>);
00400 
00401       <span class="keywordflow">if</span> (restHeight &gt; (ph * ::style-&gt;pageFillLimit))
00402             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00403 
00404       <a class="code" href="classSystemList.html">SystemList</a>* sl   = page-&gt;<a class="code" href="classPage.html#a4">systems</a>();
00405       <span class="keywordtype">int</span> <a class="code" href="classScore.html#o13">systems</a>      = sl-&gt;size();
00406       <span class="keywordtype">double</span> extraDist = restHeight / (systems-1);
00407       y                = 0;
00408       <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">iSystem</a> i = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00409             (*i)-&gt;move(0, y);
00410             y += extraDist;
00411             }
00412       <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">// reformatNextPage || (oldSystems != page-&gt;systems()-&gt;size());</span>
00413       }
00414 
00415 <span class="comment">//---------------------------------------------------------</span>
00416 <span class="comment">//   layout1</span>
00417 <span class="comment">//    called after staff was dragged</span>
00418 <span class="comment">//---------------------------------------------------------</span>
00419 
<a name="l00420"></a><a class="code" href="classScore.html#a53">00420</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a53">Score::layout1</a>()
00421       {
00422       <a class="code" href="page_8h.html#a0">iPage</a> ip   = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a13">find</a>(<a class="code" href="classScore.html#o17">dragSystem</a>-&gt;<a class="code" href="classSystem.html#a5">page</a>());
00423       <a class="code" href="classpstl_1_1plist.html">iSystem</a> is = <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a13">find</a>(<a class="code" href="classScore.html#o17">dragSystem</a>-&gt;<a class="code" href="classSystem.html#a5">page</a>()-&gt;<a class="code" href="classPage.html#a4">systems</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a12">front</a>());
00424 
00425       <span class="keywordflow">if</span> (is == <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00426             printf(<span class="stringliteral">"NO SYSTEMS\n"</span>);
00427             <span class="keywordflow">return</span>;
00428             }
00429       <span class="keywordflow">do</span> {
00430             <a class="code" href="classPage.html">Page</a>* page;
00431             <span class="keywordflow">if</span> (ip == <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00432                   page = <a class="code" href="classScore.html#a25">addPage</a>();
00433                   }
00434             <span class="keywordflow">else</span> {
00435                   page = *ip++;
00436                   }
00437             page-&gt;<a class="code" href="classPage.html#a19">layout</a>();
00438             <a class="code" href="classScore.html#r1">refresh</a> |= page-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00439             <span class="keywordflow">if</span> (!<a class="code" href="classScore.html#a54">layoutPage1</a>(page, is))
00440                   <span class="keywordflow">break</span>;
00441             } <span class="keywordflow">while</span> (is != <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>());
00442 
00443       <span class="comment">//---------------------------------------------------</span>
00444       <span class="comment">//    remove remaining empty pages</span>
00445       <span class="comment">//---------------------------------------------------</span>
00446 
00447       <span class="keywordflow">if</span> (is == <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00448             <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a0">iPage</a> i = ip; i != <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00449                   <a class="code" href="classScore.html#r1">refresh</a> |= (*i)-&gt;abbox();
00450                   <span class="keyword">delete</span> *i;
00451                   }
00452             <a class="code" href="classScore.html#o12">pages</a>-&gt;erase(ip, <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>());
00453             }
00454 
00455       <a class="code" href="classScore.html#d8">moveCursor</a>();
00456       }
00457 
00458 <span class="comment">//---------------------------------------------------------</span>
00459 <span class="comment">//   layoutPage1</span>
00460 <span class="comment">//    returns false if changes do not propagate to next</span>
00461 <span class="comment">//    page, i.e. we need not to layout the next page(es)</span>
00462 <span class="comment">//---------------------------------------------------------</span>
00463 
<a name="l00464"></a><a class="code" href="classScore.html#a54">00464</a> <span class="keywordtype">bool</span> <a class="code" href="classScore.html#a54">Score::layoutPage1</a>(<a class="code" href="classPage.html">Page</a>* page, <a class="code" href="classpstl_1_1plist.html">iSystem</a>&amp; is)
00465       {
00466       <span class="keywordtype">double</span> y  = 0;
00467       <span class="keywordtype">double</span> ey = page-&gt;<a class="code" href="classElement.html#a36">height</a>() - (page-&gt;<a class="code" href="classPage.html#a11">bm</a>() + point(::<a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o1">staffLowerBorder</a>));
00468 
00469       <a class="code" href="classSystem.html">System</a>* lastSystem = page-&gt;<a class="code" href="classPage.html#a4">systems</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00470       page-&gt;<a class="code" href="classPage.html#a4">systems</a>()-&gt;clear();
00471       <span class="keywordflow">while</span> (is != <a class="code" href="classScore.html#o13">systems</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00472             <a class="code" href="classSystem.html">System</a>* s = *is;
00473             y         += s-&gt;<a class="code" href="classSystem.html#a14">distance</a>(0);
00474             <span class="keywordtype">double</span> h  = s-&gt;<a class="code" href="classElement.html#a33">bbox</a>().height();
00475             <span class="keywordflow">if</span> (y + h &gt;= ey)  <span class="comment">// system does not fit on page</span>
00476                   <span class="keywordflow">break</span>;
00477 
00478             page-&gt;<a class="code" href="classPage.html#a5">appendSystem</a>(s);
00479             <span class="keywordflow">if</span> (s == <a class="code" href="classScore.html#o17">dragSystem</a> &amp;&amp; <a class="code" href="classScore.html#o18">dragStaff</a>)
00480                   s-&gt;<a class="code" href="classSystem.html#a9">layoutY</a>();
00481             <span class="keywordflow">else</span>
00482                   s-&gt;<a class="code" href="classElement.html#a25">move</a>(0, y - s-&gt;<a class="code" href="classElement.html#a22">y</a>());
00483             y += h;
00484             ++is;
00485             }
00486       <span class="keywordflow">return</span> lastSystem != page-&gt;<a class="code" href="classPage.html#a4">systems</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a11">back</a>();
00487       }
00488 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
