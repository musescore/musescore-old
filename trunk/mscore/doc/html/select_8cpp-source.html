<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: select.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>select.cpp</h1><a href="select_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: select.cpp,v 1.34 2005/06/20 13:54:54 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="globals_8h.html">globals.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="padstate_8h.html">padstate.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="select_8h.html">select.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="input_8h.html">input.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00023 
00024 <span class="comment">//---------------------------------------------------------</span>
00025 <span class="comment">//   element</span>
00026 <span class="comment">//---------------------------------------------------------</span>
00027 
<a name="l00028"></a><a class="code" href="classSelection.html#a6">00028</a> <a class="code" href="classElement.html">Element</a>* <a class="code" href="classSelection.html#a6">Selection::element</a>()<span class="keyword"> const</span>
00029 <span class="keyword">      </span>{
00030       <span class="keywordflow">if</span> (<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a1">SEL_SINGLE</a>)
00031             <span class="keywordflow">return</span> <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a12">front</a>();
00032       <span class="keywordflow">return</span> 0;
00033       }
00034 
00035 <span class="comment">//---------------------------------------------------------</span>
00036 <span class="comment">//   firstChordRest</span>
00037 <span class="comment">//---------------------------------------------------------</span>
00038 
<a name="l00039"></a><a class="code" href="classSelection.html#a7">00039</a> <a class="code" href="classChordRest.html">ChordRest</a>* <a class="code" href="classSelection.html#a7">Selection::firstChordRest</a>()<span class="keyword"> const</span>
00040 <span class="keyword">      </span>{
00041       <a class="code" href="classChordRest.html">ChordRest</a>* cr = 0;
00042       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00043             <a class="code" href="classElement.html">Element</a>* el = *i;
00044             <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>) {
00045                   el = ((<a class="code" href="classNote.html">Note</a>*)el)-&gt;chord();
00046                   }
00047             <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>()) {
00048                   <span class="keywordflow">if</span> (cr) {
00049                         <span class="keywordflow">if</span> (((<a class="code" href="classChordRest.html">ChordRest</a>*)el)-&gt;tick() &lt; cr-&gt;<a class="code" href="classElement.html#a74">tick</a>())
00050                               cr = (<a class="code" href="classChordRest.html">ChordRest</a>*)el;
00051                         }
00052                   <span class="keywordflow">else</span>
00053                         cr = (<a class="code" href="classChordRest.html">ChordRest</a>*)el;
00054                   }
00055             }
00056       <span class="keywordflow">return</span> cr;
00057       }
00058 
00059 <span class="comment">//---------------------------------------------------------</span>
00060 <span class="comment">//   lastChordRest</span>
00061 <span class="comment">//---------------------------------------------------------</span>
00062 
<a name="l00063"></a><a class="code" href="classSelection.html#a8">00063</a> <a class="code" href="classChordRest.html">ChordRest</a>* <a class="code" href="classSelection.html#a8">Selection::lastChordRest</a>()<span class="keyword"> const</span>
00064 <span class="keyword">      </span>{
00065       <a class="code" href="classChordRest.html">ChordRest</a>* cr = 0;
00066       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00067             <a class="code" href="classElement.html">Element</a>* el = *i;
00068             <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a12">NOTE</a>) {
00069                   el = ((<a class="code" href="classNote.html">Note</a>*)el)-&gt;chord();
00070                   }
00071             <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a42">isChordRest</a>()) {
00072                   <span class="keywordflow">if</span> (cr) {
00073                         <span class="keywordflow">if</span> (((<a class="code" href="classChordRest.html">ChordRest</a>*)el)-&gt;tick() &gt; cr-&gt;<a class="code" href="classElement.html#a74">tick</a>())
00074                               cr = (<a class="code" href="classChordRest.html">ChordRest</a>*)el;
00075                         }
00076                   <span class="keywordflow">else</span>
00077                         cr = (<a class="code" href="classChordRest.html">ChordRest</a>*)el;
00078                   }
00079             }
00080       <span class="keywordflow">return</span> cr;
00081       }
00082 
00083 <span class="comment">//---------------------------------------------------------</span>
00084 <span class="comment">//   deselectAll</span>
00085 <span class="comment">//---------------------------------------------------------</span>
00086 
<a name="l00087"></a><a class="code" href="classSelection.html#a3">00087</a> QRectF <a class="code" href="classSelection.html#a3">Selection::deselectAll</a>(<a class="code" href="classScore.html">Score</a>* cs)
00088       {
00089       QRectF r;
00090       <span class="keywordflow">if</span> (<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a3">SEL_STAFF</a> || <a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>)
00091             cs-&gt;<a class="code" href="classScore.html#a85">setUpdateAll</a>();
00092       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> i = <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00093             r |= (*i)-&gt;abbox();
00094             (*i)-&gt;setSelected(<span class="keyword">false</span>);
00095             }
00096       <a class="code" href="classSelection.html#a5">clear</a>();
00097       <span class="keywordflow">return</span> r;
00098       }
00099 
00100 <span class="comment">//---------------------------------------------------------</span>
00101 <span class="comment">//   clear</span>
00102 <span class="comment">//---------------------------------------------------------</span>
00103 
<a name="l00104"></a><a class="code" href="classSelection.html#a5">00104</a> <span class="keywordtype">void</span> <a class="code" href="classSelection.html#a5">Selection::clear</a>()
00105       {
00106       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00107             (*i)-&gt;setSelected(<span class="keyword">false</span>);
00108       <a class="code" href="classSelection.html#r0">_el</a>.clear();
00109       <a class="code" href="classSelection.html#o0">state</a> = <a class="code" href="select_8h.html#a5a0">SEL_NONE</a>;
00110       }
00111 
00112 <span class="comment">//---------------------------------------------------------</span>
00113 <span class="comment">//   remove</span>
00114 <span class="comment">//---------------------------------------------------------</span>
00115 
<a name="l00116"></a><a class="code" href="classSelection.html#a4">00116</a> <span class="keywordtype">void</span> <a class="code" href="classSelection.html#a4">Selection::remove</a>(<a class="code" href="classElement.html">Element</a>* el)
00117       {
00118       <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classElementList.html#a1">remove</a>(el);
00119       <a class="code" href="classSelection.html#a10">updateState</a>();
00120       }
00121 
00122 <span class="comment">//---------------------------------------------------------</span>
00123 <span class="comment">//   splice</span>
00124 <span class="comment">//---------------------------------------------------------</span>
00125 
<a name="l00126"></a><a class="code" href="classSelection.html#a2">00126</a> <span class="keywordtype">void</span> <a class="code" href="classSelection.html#a1">Selection::add</a>(<a class="code" href="classElementList.html">ElementList</a>&amp; ns)
00127       {
00128       <a class="code" href="classSelection.html#r0">_el</a>.splice(<a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(), ns);
00129       <a class="code" href="classSelection.html#a9">update</a>();
00130       }
00131 
00132 <span class="comment">//---------------------------------------------------------</span>
00133 <span class="comment">//   add</span>
00134 <span class="comment">//---------------------------------------------------------</span>
00135 
<a name="l00136"></a><a class="code" href="classSelection.html#a1">00136</a> <span class="keywordtype">void</span> <a class="code" href="classSelection.html#a1">Selection::add</a>(<a class="code" href="classElement.html">Element</a>* el)
00137       {
00138       <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(el);
00139       <a class="code" href="classSelection.html#a9">update</a>();
00140       }
00141 
00142 <span class="comment">//---------------------------------------------------------</span>
00143 <span class="comment">//   select</span>
00144 <span class="comment">//    staff is valid, if obj is of type MEASURE</span>
00145 <span class="comment">//---------------------------------------------------------</span>
00146 
<a name="l00147"></a><a class="code" href="classScore.html#a47">00147</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a47">Score::select</a>(<a class="code" href="classElement.html">Element</a>* obj, <span class="keywordtype">int</span> state, <span class="keywordtype">int</span> staff)
00148       {
00149 <span class="comment">//   printf("select element %s staff %d\n", obj ? obj-&gt;name() : "-0-", obj ? obj-&gt;staffIdx() : -1);</span>
00150 
00151       <span class="keywordflow">if</span> (!(state &amp; Qt::ShiftButton) || !obj) {
00152             <a class="code" href="classScore.html#r1">refresh</a> |= <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a3">deselectAll</a>(<span class="keyword">this</span>);
00153             }
00154       <span class="keywordflow">if</span> (!obj) {
00155             <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a>   = <a class="code" href="select_8h.html#a5a0">SEL_NONE</a>;
00156             <a class="code" href="canvas_8cpp.html#a0">padState</a>.<a class="code" href="structPadState.html#o1">len</a> = 0;
00157             emit <a class="code" href="classScore.html#l0">selectionChanged</a>(<span class="keywordtype">int</span>(<a class="code" href="select_8h.html#a5a0">SEL_NONE</a>));
00158             <span class="keywordflow">return</span>;
00159             }
00160       <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a29">MEASURE</a>) {
00161             <a class="code" href="classScore.html#r1">refresh</a>       |= QRectF(0, 0, 10000, 10000);   <span class="comment">// hack</span>
00162             <a class="code" href="classMeasure.html">Measure</a>* m     = (<a class="code" href="classMeasure.html">Measure</a>*)obj;
00163             <span class="keywordtype">int</span> tickStart  = m-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00164             <span class="keywordtype">int</span> tickEnd    = tickStart + m-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>();
00165             <span class="keywordtype">int</span> staffStart = staff;
00166             <span class="keywordtype">int</span> staffEnd   = staff+1;
00167 
00168             <span class="keywordflow">if</span> ((state &amp; Qt::ShiftButton)
00169                &amp;&amp; (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a> || <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a3">SEL_STAFF</a>)) {
00170                   <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o1">tickStart</a> &lt; tickStart)
00171                         tickStart = <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o1">tickStart</a>;
00172                   <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o2">tickEnd</a> &gt; tickEnd)
00173                         tickEnd = <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o2">tickEnd</a>;
00174                   <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a3">SEL_STAFF</a>) {
00175                         <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o3">staffStart</a> &lt; staffStart)
00176                               staffStart = <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o3">staffStart</a>;
00177                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o4">staffEnd</a> &gt; staffEnd)
00178                               staffEnd = <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o4">staffEnd</a>;
00179                         }
00180                   }
00181             <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o3">staffStart</a> = staffStart;
00182             <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o4">staffEnd</a>   = staffEnd;
00183             <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o1">tickStart</a>  = tickStart;
00184             <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o2">tickEnd</a>    = tickEnd;
00185 
00186             <a class="code" href="select_8h.html#a5">SelState</a> selState = <a class="code" href="select_8h.html#a5a3">SEL_STAFF</a>;
00187             <span class="keywordflow">if</span> (state &amp; Qt::ControlButton)
00188                   selState = <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>;
00189             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((state &amp; Qt::ShiftButton) &amp;&amp; (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>))
00190                   selState = <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>;
00191 
00192             <span class="keywordflow">if</span> (selState == <a class="code" href="select_8h.html#a5a4">SEL_SYSTEM</a>) {
00193                   <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o3">staffStart</a> = 0;
00194                   <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o4">staffEnd</a> = <a class="code" href="classScore.html#a6">nstaves</a>();
00195                   }
00196             <span class="keywordflow">if</span> (<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> != selState) {
00197                   <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a3">deselectAll</a>(<span class="keyword">this</span>);
00198                   <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a> = selState;
00199                   emit <a class="code" href="classScore.html#l0">selectionChanged</a>(<span class="keywordtype">int</span>(<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a>));
00200                   }
00201             <span class="comment">//</span>
00202             <span class="comment">//  select all elements in range</span>
00203             <span class="comment">//</span>
00204             <span class="keywordtype">int</span> startTrack = staffStart * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00205             <span class="keywordtype">int</span> endTrack   = staffEnd * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00206 
00207             <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00208                   <span class="keywordtype">int</span> ms = m-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00209                   <span class="keywordtype">int</span> me = ms + m-&gt;<a class="code" href="classMeasure.html#a26">tickLen</a>();
00210                   <span class="keywordflow">if</span> (me &lt; tickStart)
00211                         <span class="keywordflow">continue</span>;
00212                   <span class="keywordflow">if</span> (ms &gt;= tickEnd)
00213                         <span class="keywordflow">break</span>;
00214                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> st = startTrack; st &lt; endTrack; ++st) {
00215                         <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* segment = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00216                               <span class="keywordflow">if</span> (segment-&gt;<a class="code" href="classElement.html#a74">tick</a>() &lt; tickStart)
00217                                     <span class="keywordflow">continue</span>;
00218                               <span class="keywordflow">if</span> (segment-&gt;<a class="code" href="classElement.html#a74">tick</a>() &gt;= tickEnd)
00219                                     <span class="keywordflow">break</span>;
00220                               <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(st);
00221                               <span class="keywordflow">if</span> (!e)
00222                                     <span class="keywordflow">continue</span>;
00223                               e-&gt;<a class="code" href="classElement.html#a15">setSelected</a>(<span class="keyword">true</span>);
00224                               <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a0">elements</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(e);
00225                               }
00226                         }
00227 <span class="comment">//                  for (int st = sbar; st &lt; ebar; ++st) {</span>
00228 <span class="comment">//                        for (Segment* segment = m-&gt;first(); segment; segment = segment-&gt;next()) {</span>
00229 <span class="comment">//TODO                              if (el-&gt;lyrics()) {</span>
00230 <span class="comment">//                                    el-&gt;lyrics()-&gt;setSelected(true);</span>
00231 <span class="comment">//                                    sel-&gt;elements()-&gt;push_back(el-&gt;lyrics());</span>
00232 <span class="comment">//                                    }</span>
00233 <span class="comment">//                              }</span>
00234 <span class="comment">//                        }</span>
00235                   }
00236             <a class="code" href="canvas_8cpp.html#a0">padState</a>.<a class="code" href="structPadState.html#o1">len</a> = 0;
00237             <span class="keywordflow">return</span>;
00238             }
00239       obj-&gt;<a class="code" href="classElement.html#a15">setSelected</a>(<span class="keyword">true</span>);
00240       <a class="code" href="classScore.html#r1">refresh</a> |= obj-&gt;<a class="code" href="classElement.html#a34">abbox</a>();
00241       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a1">add</a>(obj);
00242       ::setPadState(obj);
00243       <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a> = obj-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00244       <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o2">voice</a> = obj-&gt;<a class="code" href="classElement.html#a62">voice</a>();   <span class="comment">//TODO</span>
00245       emit <a class="code" href="classScore.html#l0">selectionChanged</a>(<span class="keywordtype">int</span>(<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a>));
00246       }
00247 
00248 <span class="comment">//---------------------------------------------------------</span>
00249 <span class="comment">//   findSelectableElement</span>
00250 <span class="comment">//    p - canvas relative</span>
00251 <span class="comment">//---------------------------------------------------------</span>
00252 
<a name="l00253"></a><a class="code" href="classScore.html#a132">00253</a> <a class="code" href="classElement.html">Element</a>* <a class="code" href="classScore.html#a132">Score::findSelectableElement</a>(<span class="keyword">const</span> QPointF&amp; pp)
00254       {
00255       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a1">ciPage</a> ip = <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != <a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
00256             <span class="keyword">const</span> <a class="code" href="classPage.html">Page</a>* page = *ip;
00257             <span class="keywordflow">if</span> (!page-&gt;<a class="code" href="classElement.html#a30">contains</a>(pp))
00258                   <span class="keywordflow">continue</span>;
00259             QPointF p = pp - page-&gt;<a class="code" href="classElement.html#a20">pos</a>();  <span class="comment">// transform to page relative</span>
00260 
00261             <span class="comment">// Page Element?</span>
00262             <span class="keyword">const</span> <a class="code" href="classElementList.html">ElementList</a>* el = page-&gt;<a class="code" href="classPage.html#a14">pel</a>();
00263             <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = el-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != el-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00264                   <span class="keywordflow">if</span> ((*i)-&gt;contains(p))
00265                         <span class="keywordflow">return</span> *i;
00266                   }
00267 
00268             <span class="comment">// Element in System/Measure selected?</span>
00269             <a class="code" href="classSystemList.html">SystemList</a>* sl = page-&gt;<a class="code" href="classPage.html#a4">systems</a>();
00270             <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciSystem</a> s = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); s != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++s) {
00271                   <a class="code" href="classElement.html">Element</a>* element = (*s)-&gt;findSelectableElement(p);
00272                   <span class="keywordflow">if</span> (element)
00273                         <span class="keywordflow">return</span> element;
00274                   }
00275             <span class="comment">// System/Measure selected?</span>
00276             <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciSystem</a> s = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); s != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++s) {
00277                   QPointF ppp  = p - (*s)-&gt;pos();   <span class="comment">// system relative</span>
00278                   <a class="code" href="classBar.html">Bar</a>* bar = (*s)-&gt;getBar();
00279                   <span class="keywordflow">if</span> (bar &amp;&amp; bar-&gt;<a class="code" href="classElement.html#a30">contains</a>(ppp))
00280                         <span class="keywordflow">return</span> bar;
00281                   <a class="code" href="classMeasureList.html">MeasureList</a>* ml = (*s)-&gt;measures();
00282                   <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a11">ciMeasure</a> im = ml-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); im != ml-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++im) {
00283                         <a class="code" href="classMeasure.html">Measure</a>* m = *im;
00284                         <span class="keyword">const</span> <a class="code" href="classElementList.html">ElementList</a>* pel = m-&gt;<a class="code" href="classMeasure.html#a13">pel</a>();
00285                         <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> ie = pel-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ie != pel-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ie) {
00286                               <span class="keywordflow">if</span> ((*ie)-&gt;contains(p))
00287                                     <span class="keywordflow">return</span> *ie;
00288                               }
00289                         QPointF pppp = ppp - m-&gt;<a class="code" href="classElement.html#a20">pos</a>();  <span class="comment">// measure relative</span>
00290 
00291                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classScore.html#a6">nstaves</a>(); ++i) {
00292                               <span class="keywordtype">double</span> x = m-&gt;<a class="code" href="classElement.html#a33">bbox</a>().x();
00293                               <span class="keywordtype">double</span> w = m-&gt;<a class="code" href="classElement.html#a33">bbox</a>().width();
00294                               <span class="keywordtype">double</span> y = (*s)-&gt;staff(i)-&gt;bbox().y();
00295                               <span class="keywordtype">double</span> h = (*s)-&gt;staff(i)-&gt;bbox().height();
00296                               QRectF r(x, y, w, h);
00297                               <span class="keywordflow">if</span> (r.contains(pppp))
00298                                     <span class="keywordflow">return</span> m;
00299                               }
00300                         }
00301                   }
00302             }
00303       <span class="keywordflow">return</span> 0;
00304       }
00305 
00306 <span class="comment">//---------------------------------------------------------</span>
00307 <span class="comment">//   lassoSelect</span>
00308 <span class="comment">//---------------------------------------------------------</span>
00309 
<a name="l00310"></a><a class="code" href="classCanvas.html#d17">00310</a> QRegion <a class="code" href="classCanvas.html#d17">Canvas::lassoSelect</a>()
00311       {
00312       QRegion r;
00313       <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(0, 0, 0);
00314       QRectF lr(<a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>());
00315 
00316       <span class="keywordtype">int</span> tracks = <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a6">nstaves</a>() * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00317       <span class="keywordflow">for</span> (<a class="code" href="page_8h.html#a1">ciPage</a> ip = <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ip != <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#o12">pages</a>-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ip) {
00318             <span class="keyword">const</span> <a class="code" href="classPage.html">Page</a>* page = *ip;
00319             <span class="keywordflow">if</span> (page-&gt;<a class="code" href="classElement.html#a34">abbox</a>().intersects(<a class="code" href="classCanvas.html#r16">lasso</a>-&gt;<a class="code" href="classElement.html#a34">abbox</a>())) {
00320                   <span class="keyword">const</span> <a class="code" href="classElementList.html">ElementList</a>* el = page-&gt;<a class="code" href="classPage.html#a14">pel</a>();
00321                   <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = el-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != el-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00322                         <span class="keywordflow">if</span> (lr.contains((*i)-&gt;abbox()))
00323                               <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(*i, Qt::ShiftButton, 0);
00324                         }
00325 
00326                   <a class="code" href="classSystemList.html">SystemList</a>* sl = page-&gt;<a class="code" href="classPage.html#a4">systems</a>();
00327                   <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1plist.html">ciSystem</a> s = sl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); s != sl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++s) {
00328                         <span class="keywordflow">for</span> (<a class="code" href="measure_8h.html#a11">ciMeasure</a> im = (*s)-&gt;measures()-&gt;begin(); im != (*s)-&gt;measures()-&gt;end(); ++im) {
00329                               <a class="code" href="classMeasure.html">Measure</a>* measure = *im;
00330                               <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="classSegment.html">Segment</a>* segment = measure-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); segment; segment = segment-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00331                                     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00332                                           <a class="code" href="classElement.html">Element</a>* e = segment-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00333                                           <span class="keywordflow">if</span> (e) {
00334                                                 <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>) {
00335                                                       <a class="code" href="classNoteList.html">NoteList</a>* notes = ((<a class="code" href="classChord.html">Chord</a>*)e)-&gt;noteList();
00336                                                       <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a3">ciNote</a> in = notes-&gt;begin(); in != notes-&gt;end(); ++in) {
00337                                                             <a class="code" href="classNote.html">Note</a>* note = in-&gt;second;
00338                                                             <span class="keywordflow">if</span> (lr.contains(note-&gt;<a class="code" href="classElement.html#a34">abbox</a>()))
00339                                                                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(note, Qt::ShiftButton, 0);
00340                                                             <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>() &amp;&amp; lr.<a class="code" href="classSlurTie.html#a12">contains</a>(note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>()-&gt;<a class="code" href="classElement.html#a34">abbox</a>()))
00341                                                                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>(), Qt::ShiftButton, 0);
00342                                                             <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classNote.html#a23">accidental</a>() &amp;&amp; lr.<a class="code" href="classElement.html#a30">contains</a>(note-&gt;<a class="code" href="classNote.html#a23">accidental</a>()-&gt;<a class="code" href="classElement.html#a34">abbox</a>()))
00343                                                                   <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(note-&gt;<a class="code" href="classNote.html#a23">accidental</a>(), Qt::ShiftButton, 0);
00344                                                             }
00345                                                       }
00346                                                 <span class="keywordflow">else</span> {
00347                                                       <span class="keywordflow">if</span> (lr.contains(e-&gt;<a class="code" href="classElement.html#a34">abbox</a>()))
00348                                                             <a class="code" href="classCanvas.html#r0">_score</a>-&gt;<a class="code" href="classScore.html#a47">select</a>(e, Qt::ShiftButton, 0);
00349                                                       }
00350                                                 }
00351                                           }
00352                                     }
00353                               }
00354                         }
00355                   }
00356             }
00357       <span class="keywordflow">return</span> r;
00358       }
00359 
00360 <span class="comment">//---------------------------------------------------------</span>
00361 <span class="comment">//   searchSelectedElements</span>
00362 <span class="comment">//    rebuild list of selected Elements</span>
00363 <span class="comment">//    "ElementList selected"</span>
00364 <span class="comment">//---------------------------------------------------------</span>
00365 
<a name="l00366"></a><a class="code" href="classScore.html#a48">00366</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a48">Score::searchSelectedElements</a>()
00367       {
00368       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a5">clear</a>();
00369       <span class="keywordtype">int</span> tracks = <a class="code" href="classScore.html#a6">nstaves</a>() * <a class="code" href="globals_8h.html#a3">VOICES</a>;
00370       <a class="code" href="classElementList.html">ElementList</a>* el = <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a0">elements</a>();
00371 
00372       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00373             <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* s = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); s; s = s-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00374                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> track = 0; track &lt; tracks; ++track) {
00375                         <a class="code" href="classElement.html">Element</a>* e = s-&gt;<a class="code" href="classSegment.html#a8">element</a>(track);
00376                         <span class="keywordflow">if</span> (e == 0)
00377                               <span class="keywordflow">continue</span>;
00378                         <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a14">isSelected</a>())
00379                               el-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(e);
00380                         <span class="keywordflow">if</span> (e-&gt;<a class="code" href="classElement.html#a40">type</a>() == <a class="code" href="element_8h.html#a65a25">CHORD</a>) {
00381                               <span class="keyword">const</span> <a class="code" href="classNoteList.html">NoteList</a>* nl = ((<a class="code" href="classChord.html">Chord</a>*)e)-&gt;noteList();
00382                               <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a3">ciNote</a> in = nl-&gt;begin(); in != nl-&gt;end(); ++in) {
00383                                     <a class="code" href="classNote.html">Note</a>* note = in-&gt;second;
00384                                     <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classElement.html#a14">isSelected</a>())
00385                                           el-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(note);
00386                                     <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>() &amp;&amp; note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>()-&gt;<a class="code" href="classElement.html#a14">isSelected</a>()) {
00387                                           el-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>());
00388                                           }
00389                                     <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classNote.html#a28">fingering</a>() &amp;&amp; note-&gt;<a class="code" href="classNote.html#a28">fingering</a>()-&gt;<a class="code" href="classElement.html#a14">isSelected</a>())
00390                                           el-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(note-&gt;<a class="code" href="classNote.html#a28">fingering</a>());
00391                                     }
00392                               }
00393                         }
00394                   }
00395             <span class="keyword">const</span> <a class="code" href="classElementList.html">ElementList</a>* l = m-&gt;<a class="code" href="classMeasure.html#a42">el</a>();
00396             <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = l-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != l-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00397                   <span class="keywordflow">if</span> ((*i)-&gt;isSelected())
00398                         el-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(*i);
00399                   }
00400             }
00401       <a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#a10">updateState</a>();
00402       emit <a class="code" href="classScore.html#l0">selectionChanged</a>(<span class="keywordtype">int</span>(<a class="code" href="classScore.html#o14">sel</a>-&gt;<a class="code" href="classSelection.html#o0">state</a>));
00403       }
00404 
00405 <span class="comment">//---------------------------------------------------------</span>
00406 <span class="comment">//   update</span>
00407 <span class="comment">//    set select flag for all Elements in select list</span>
00408 <span class="comment">//---------------------------------------------------------</span>
00409 
<a name="l00410"></a><a class="code" href="classSelection.html#a9">00410</a> <span class="keywordtype">void</span> <a class="code" href="classSelection.html#a9">Selection::update</a>()
00411       {
00412       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00413             (*i)-&gt;setSelected(<span class="keyword">true</span>);
00414       <a class="code" href="classSelection.html#a10">updateState</a>();
00415       }
00416 
00417 <span class="comment">//---------------------------------------------------------</span>
00418 <span class="comment">//   dump</span>
00419 <span class="comment">//---------------------------------------------------------</span>
00420 
<a name="l00421"></a><a class="code" href="classSelection.html#a11">00421</a> <span class="keywordtype">void</span> <a class="code" href="classSelection.html#a11">Selection::dump</a>()
00422       {
00423       printf(<span class="stringliteral">"Selection dump: "</span>);
00424       <span class="keywordflow">if</span> (<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a0">SEL_NONE</a>) {
00425             printf(<span class="stringliteral">"NONE\n"</span>);
00426             <span class="keywordflow">return</span>;
00427             }
00428       <span class="keywordflow">if</span> (<a class="code" href="classSelection.html#o0">state</a> == <a class="code" href="select_8h.html#a5a1">SEL_SINGLE</a>)
00429             printf(<span class="stringliteral">"SINGLE\n"</span>);
00430       <span class="keywordflow">else</span>
00431             printf(<span class="stringliteral">"MULTI\n"</span>);
00432       <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a2">ciElement</a> i = <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != <a class="code" href="classSelection.html#r0">_el</a>.<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i)
00433             printf(<span class="stringliteral">"  %p %s\n"</span>, *i, (*i)-&gt;name());
00434       }
00435 
00436 <span class="comment">//---------------------------------------------------------</span>
00437 <span class="comment">//   updateState</span>
00438 <span class="comment">//    update cis &amp; padState</span>
00439 <span class="comment">//---------------------------------------------------------</span>
00440 
<a name="l00441"></a><a class="code" href="classSelection.html#a10">00441</a> <span class="keywordtype">void</span> <a class="code" href="classSelection.html#a10">Selection::updateState</a>()
00442       {
00443       <span class="keywordtype">int</span> n = <a class="code" href="classSelection.html#r0">_el</a>.size();
00444       <span class="keywordflow">if</span> (n == 0)
00445             <a class="code" href="classSelection.html#o0">state</a> = <a class="code" href="select_8h.html#a5a0">SEL_NONE</a>;
00446       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n == 1) {
00447             <a class="code" href="classSelection.html#o0">state</a> = <a class="code" href="select_8h.html#a5a1">SEL_SINGLE</a>;
00448             <a class="code" href="classElement.html">Element</a>* obj = <a class="code" href="classSelection.html#a6">element</a>();
00449             ::setPadState(obj);
00450             <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o1">staff</a> = obj-&gt;<a class="code" href="classElement.html#a60">staffIdx</a>();
00451             <a class="code" href="input_8h.html#a0">cis</a>-&gt;<a class="code" href="structInputState.html#o2">voice</a> = obj-&gt;<a class="code" href="classElement.html#a62">voice</a>();   <span class="comment">//TODO</span>
00452             }
00453       <span class="keywordflow">else</span>
00454             <a class="code" href="classSelection.html#o0">state</a> = <a class="code" href="select_8h.html#a5a2">SEL_MULT</a>;
00455       }
00456 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
