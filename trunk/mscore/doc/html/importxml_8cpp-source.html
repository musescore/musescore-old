<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: importxml.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>importxml.cpp</h1><a href="importxml_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MusE Score</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: importxml.cpp,v 1.50 2005/06/27 19:50:19 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="musicxml_8h.html">musicxml.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="file_8h.html">file.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="key_8h.html">key.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="element_8h.html">element.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="symbols_8h.html">symbols.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="hairpin_8h.html">hairpin.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="tuplet_8h.html">tuplet.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="dynamics_8h.html">dynamics.h</a>"</span>
00026 <span class="preprocessor">#include "<a class="code" href="page_8h.html">page.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="part_8h.html">part.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00032 
00033 <span class="comment">//---------------------------------------------------------</span>
00034 <span class="comment">//   xmlSetPitch</span>
00035 <span class="comment">//    convert to midi pitch</span>
00036 <span class="comment">//---------------------------------------------------------</span>
00037 
<a name="l00038"></a><a class="code" href="importxml_8cpp.html#a0">00038</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="importxml_8cpp.html#a0">xmlSetPitch</a>(<a class="code" href="classNote.html">Note</a>* n, <span class="keywordtype">int</span> <span class="comment">/*tick*/</span>, <span class="keywordtype">char</span> step, <span class="keywordtype">int</span> alter, <span class="keywordtype">int</span> octave, <span class="keywordtype">int</span> accidental)
00039       {
00040       <span class="comment">//                      a  b   c  d  e  f  g</span>
00041       <span class="keyword">static</span> <span class="keywordtype">int</span> table[7] = { 9, 11, 0, 2, 4, 5, 7 };
00042       step -= <span class="charliteral">'A'</span>;
00043       <span class="keywordflow">if</span> (step &lt; 0 || step &gt; 6) {
00044             printf(<span class="stringliteral">"xml2pitch: illegal pitch %d, &lt;%c&gt;\n"</span>, step, step+<span class="charliteral">'A'</span>);
00045             <span class="keywordflow">return</span>;
00046             }
00047       <span class="keywordtype">int</span> pitch = table[int(step)] + alter + (octave+1) * 12;
00048 
00049       <span class="keywordflow">if</span> (pitch &lt; 0)
00050             pitch = 0;
00051       <span class="keywordflow">if</span> (pitch &gt; 127)
00052             pitch = 127;
00053       n-&gt;<a class="code" href="classNote.html#a16">setPitch</a>(pitch);
00054       <span class="keywordflow">if</span> (accidental)
00055             n-&gt;<a class="code" href="classNote.html#a21">setUserAccidental</a>(accidental);
00056       }
00057 
00058 <span class="comment">//---------------------------------------------------------</span>
00059 <span class="comment">//   MusicXml</span>
00060 <span class="comment">//---------------------------------------------------------</span>
00061 
<a name="l00062"></a><a class="code" href="classMusicXml.html#a0">00062</a> <a class="code" href="classMusicXml.html#a0">MusicXml::MusicXml</a>(QDomDocument* d)
00063       {
00064       <a class="code" href="classMusicXml.html#r6">doc</a> = d;
00065       <a class="code" href="classMusicXml.html#r11">maxLyrics</a> = 0;
00066       }
00067 
00068 <span class="comment">//---------------------------------------------------------</span>
00069 <span class="comment">//   LoadMusicXml</span>
00070 <span class="comment">//---------------------------------------------------------</span>
00071 
<a name="l00072"></a><a class="code" href="classLoadMusicXml.html">00072</a> <span class="keyword">class </span><a class="code" href="classLoadMusicXml.html">LoadMusicXml</a> : <span class="keyword">public</span> <a class="code" href="classLoadFile.html">LoadFile</a> {
<a name="l00073"></a><a class="code" href="classLoadMusicXml.html#r0">00073</a>       QDomDocument* <a class="code" href="classLoadMusicXml.html#r0">_doc</a>;
00074 
00075    <span class="keyword">public</span>:
<a name="l00076"></a><a class="code" href="classLoadMusicXml.html#a0">00076</a>       <a class="code" href="classLoadMusicXml.html#a0">LoadMusicXml</a>() {
00077             <a class="code" href="classLoadMusicXml.html#r0">_doc</a> = <span class="keyword">new</span> QDomDocument();
00078             }
<a name="l00079"></a><a class="code" href="classLoadMusicXml.html#a1">00079</a>       <a class="code" href="classLoadMusicXml.html#a1">~LoadMusicXml</a>() {
00080             <span class="keyword">delete</span> <a class="code" href="classLoadMusicXml.html#r0">_doc</a>;
00081             }
00082       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> loader(FILE* f);
<a name="l00083"></a><a class="code" href="classLoadMusicXml.html#a3">00083</a>       QDomDocument* <a class="code" href="classLoadMusicXml.html#a3">doc</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classLoadMusicXml.html#r0">_doc</a>; }
00084       };
00085 
00086 <span class="comment">//---------------------------------------------------------</span>
00087 <span class="comment">//   loader</span>
00088 <span class="comment">//    import midi file</span>
00089 <span class="comment">//    return true on error</span>
00090 <span class="comment">//---------------------------------------------------------</span>
00091 
<a name="l00092"></a><a class="code" href="classLoadMusicXml.html#a2">00092</a> <span class="keywordtype">bool</span> <a class="code" href="classLoadMusicXml.html#a2">LoadMusicXml::loader</a>(FILE* fp)
00093       {
00094       <span class="keywordtype">int</span> line, column;
00095       QString err;
00096       QFile qf(<a class="code" href="classLoadFile.html#a5">name</a>());
00097       qf.open(IO_ReadOnly, fp);
00098 
00099       <span class="keywordflow">if</span> (!<a class="code" href="classLoadMusicXml.html#r0">_doc</a>-&gt;setContent(&amp;qf, <span class="keyword">false</span>, &amp;err, &amp;line, &amp;column)) {
00100             QString col, ln;
00101             col.setNum(column);
00102             ln.setNum(line);
00103             error = err + <span class="stringliteral">"\n at line "</span> + ln + <span class="stringliteral">" column "</span> + col;
00104             printf(<span class="stringliteral">"error: %s\n"</span>, error.latin1());
00105             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00106             }
00107       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00108       }
00109 
00110 <span class="comment">//---------------------------------------------------------</span>
00111 <span class="comment">//   importMusicXml</span>
00112 <span class="comment">//---------------------------------------------------------</span>
00113 
<a name="l00114"></a><a class="code" href="classMuseScore.html#k22">00114</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k22">MuseScore::importMusicXml</a>()
00115       {
00116       <a class="code" href="classLoadMusicXml.html">LoadMusicXml</a> lx;
00117       lx.<a class="code" href="classLoadFile.html#a3">load</a>(<span class="keyword">this</span>,
00118          QString(<span class="stringliteral">"."</span>),
00119          QString(<span class="stringliteral">"MusicXml files (*.xml *.xml.gz *.xml.bz2);; All files (*)"</span>),
00120          tr(<span class="stringliteral">"MuseScore: Import MusicXML"</span>));
00121 
00122       <a class="code" href="classScore.html">Score</a>* score = <span class="keyword">new</span> <a class="code" href="classScore.html">Score</a>();
00123       score-&gt;<a class="code" href="classScore.html#a124">importMusicXml</a>(lx.<a class="code" href="classLoadFile.html#a5">name</a>());
00124       <a class="code" href="classMuseScore.html#a8">appendScore</a>(score);
00125       <a class="code" href="classMuseScore.html#r3">tab</a>-&gt;setCurrentTab(<a class="code" href="classMuseScore.html#r43">scoreList</a>.size() - 1);
00126       }
00127 
00128 <span class="comment">//---------------------------------------------------------</span>
00129 <span class="comment">//   importMusicXml</span>
00130 <span class="comment">//---------------------------------------------------------</span>
00131 
<a name="l00132"></a><a class="code" href="classScore.html#a124">00132</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a124">Score::importMusicXml</a>(<span class="keyword">const</span> QString&amp; name)
00133       {
00134       <a class="code" href="classLoadMusicXml.html">LoadMusicXml</a> lx;
00135       lx.<a class="code" href="classLoadFile.html#a3">load</a>(name);
00136       <a class="code" href="classScore.html#o3">saved</a> = <span class="keyword">false</span>;
00137       <a class="code" href="classMusicXml.html">MusicXml</a> musicxml(lx.<a class="code" href="classLoadMusicXml.html#a3">doc</a>());
00138       musicxml.<a class="code" href="classMusicXml.html#a1">import</a>(<span class="keyword">this</span>);
00139       <a class="code" href="classScore.html#a99">connectTies</a>();
00140       }
00141 
00142 <span class="comment">//---------------------------------------------------------</span>
00143 <span class="comment">//   import</span>
00144 <span class="comment">//      scorePartwise</span>
00145 <span class="comment">//        part-list</span>
00146 <span class="comment">//        part</span>
00147 <span class="comment">//        work</span>
00148 <span class="comment">//        identification</span>
00149 <span class="comment">//---------------------------------------------------------</span>
00150 
<a name="l00151"></a><a class="code" href="classMusicXml.html#a1">00151</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#a1">MusicXml::import</a>(<a class="code" href="classScore.html">Score</a>* s)
00152       {
00153       <a class="code" href="classMusicXml.html#r0">score</a>  = s;
00154       <a class="code" href="classMusicXml.html#r3">tie</a>    = 0;
00155       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="musicxml_8h.html#a1">MAX_SLURS</a>; ++i)
00156             <a class="code" href="classMusicXml.html#r2">slur</a>[i] = 0;
00157       <a class="code" href="classMusicXml.html#r15">tuplet</a> = 0;
00158       QDomNode node = <a class="code" href="classMusicXml.html#r6">doc</a>-&gt;documentElement();
00159 
00160       <span class="keywordflow">for</span> (QDomNode node = <a class="code" href="classMusicXml.html#r6">doc</a>-&gt;documentElement(); !node.isNull(); node = node.nextSibling()) {
00161             QDomElement e = node.toElement();
00162             <span class="keywordflow">if</span> (e.isNull())
00163                   <span class="keywordflow">continue</span>;
00164             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"score-partwise"</span>)
00165                   <a class="code" href="classMusicXml.html#d3">scorePartwise</a>(node.firstChild());
00166             <span class="keywordflow">else</span>
00167                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00168             }
00169       }
00170 
00171 <span class="comment">//---------------------------------------------------------</span>
00172 <span class="comment">//   scorePartwise</span>
00173 <span class="comment">//---------------------------------------------------------</span>
00174 
<a name="l00175"></a><a class="code" href="classMusicXml.html#d3">00175</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d3">MusicXml::scorePartwise</a>(QDomNode node)
00176       {
00177       <span class="keywordflow">for</span> (;!node.isNull(); node = node.nextSibling()) {
00178             QDomElement e = node.toElement();
00179             <span class="keywordflow">if</span> (e.isNull())
00180                   <span class="keywordflow">continue</span>;
00181             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"part-list"</span>)
00182                   <a class="code" href="classMusicXml.html#d4">xmlPartList</a>(node.firstChild());
00183             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"part"</span>)
00184                   <a class="code" href="classMusicXml.html#d5">xmlPart</a>(node.firstChild(), e.attribute(QString(<span class="stringliteral">"id"</span>)));
00185             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"work"</span>) {
00186                   QDomNode n = node.firstChild();
00187                   <span class="keywordflow">while</span> (!n.isNull()) {
00188                         QDomElement e = n.toElement();
00189                         <span class="keywordflow">if</span> (e.isNull()) {
00190                               n = n.nextSibling();
00191                               <span class="keywordflow">continue</span>;
00192                               }
00193                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"work-number"</span>) {
00194                               <a class="code" href="classMusicXml.html#r17">subTitle</a> = e.text();
00195                               }
00196                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"work-title"</span>) {
00197                               <a class="code" href="classMusicXml.html#r16">title</a> = e.text();
00198                               }
00199                         <span class="keywordflow">else</span>
00200                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00201                         n = n.nextSibling();
00202                         }
00203                   }
00204             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"identification"</span>) {
00205                   QDomNode n = node.firstChild();
00206                   <span class="keywordflow">while</span> (!n.isNull()) {
00207                         QDomElement e = n.toElement();
00208                         <span class="keywordflow">if</span> (e.isNull()) {
00209                               n = n.nextSibling();
00210                               <span class="keywordflow">continue</span>;
00211                               }
00212                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"creator"</span>) {
00213                               <span class="comment">// type is an arbitrary label</span>
00214                               QString type = e.attribute(QString(<span class="stringliteral">"type"</span>));
00215                               QString str = e.text();
00216                               <span class="keywordflow">if</span> (type == <span class="stringliteral">"composer"</span>)
00217                                     <a class="code" href="classMusicXml.html#r18">composer</a> = str;
00218                               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"poet"</span>)
00219                                     <a class="code" href="classMusicXml.html#r19">poet</a> = str;
00220                               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"translator"</span>)
00221                                     <a class="code" href="classMusicXml.html#r20">translator</a> = str;
00222                               <span class="keywordflow">else</span>
00223                                     <a class="code" href="utils_8h.html#a4">domError</a>(n);
00224                               }
00225                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"rights"</span>)
00226                               <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o7">rights</a> = e.text();
00227                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"encoding"</span>)
00228                               ;
00229                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"source"</span>)
00230                               ;
00231                         <span class="keywordflow">else</span>
00232                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00233                         n = n.nextSibling();
00234                         }
00235                   }
00236             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"defaults"</span>) {
00237                   <span class="keywordflow">for</span> (QDomNode n = node.firstChild(); !n.isNull(); n = n.nextSibling()) {
00238                         QDomElement e = n.toElement();
00239                         <span class="keywordflow">if</span> (e.isNull())
00240                               <span class="keywordflow">continue</span>;
00241                         QString tag(e.tagName());
00242                         <span class="keywordflow">if</span> (tag == <span class="stringliteral">"scaling"</span>) {
00243                               <span class="keywordtype">double</span> millimeter = <a class="code" href="spatium_8h.html#a0">_spatium</a>/10.0;
00244                               <span class="keywordtype">double</span> tenths = 1.0;
00245                               <span class="keywordflow">for</span> (QDomNode node = n.firstChild(); !node.isNull(); node = node.nextSibling()) {
00246                                     QDomElement e = node.toElement();
00247                                     <span class="keywordflow">if</span> (e.isNull())
00248                                           <span class="keywordflow">continue</span>;
00249                                     QString tag(e.tagName());
00250                                     <span class="keywordflow">if</span> (tag == <span class="stringliteral">"millimeters"</span>)
00251                                           millimeter = e.text().toDouble();
00252                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"tenths"</span>)
00253                                           tenths = e.text().toDouble();
00254                                     <span class="keywordflow">else</span>
00255                                           <a class="code" href="utils_8h.html#a4">domError</a>(n);
00256                                     }
00257                               <a class="code" href="spatium_8h.html#a0">_spatium</a> = DPMM * (millimeter * 10.0 / tenths);
00258                               }
00259                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"page-layout"</span>)
00260                               <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a135">pageFormat</a>()-&gt;<a class="code" href="structPageFormat.html#a4">read</a>(n);
00261                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"system-layout"</span>) {
00262                               <span class="keywordflow">for</span> (QDomNode node = n.firstChild(); !node.isNull(); node = node.nextSibling()) {
00263                                     QDomElement e = node.toElement();
00264                                     <span class="keywordflow">if</span> (e.isNull())
00265                                           <span class="keywordflow">continue</span>;
00266                                     QString tag(e.tagName());
00267                                     <a class="code" href="classSpatium.html">Spatium</a> val(e.text().toDouble() / 10.0);
00268                                     <span class="keywordflow">if</span> (tag == <span class="stringliteral">"system-margins"</span>)
00269                                           ;
00270                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"system-distance"</span>) {
00271                                           <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o4">systemDistance</a> = val;
00272                                           printf(<span class="stringliteral">"system distance %f\n"</span>, val.<a class="code" href="classSpatium.html#a3">val</a>());
00273                                           }
00274                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"top-system-distance"</span>)
00275                                           ;
00276                                     <span class="keywordflow">else</span>
00277                                           <a class="code" href="utils_8h.html#a4">domError</a>(node);
00278                                     }
00279                               }
00280                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"staff-layout"</span>) {
00281                               <span class="keywordflow">for</span> (QDomNode node = n.firstChild(); !node.isNull(); node = node.nextSibling()) {
00282                                     QDomElement e = node.toElement();
00283                                     <span class="keywordflow">if</span> (e.isNull())
00284                                           <span class="keywordflow">continue</span>;
00285                                     QString tag(e.tagName());
00286                                     <a class="code" href="classSpatium.html">Spatium</a> val(e.text().toDouble() / 10.0);
00287                                     <span class="keywordflow">if</span> (tag == <span class="stringliteral">"staff-distance"</span>)
00288                                           <a class="code" href="style_8cpp.html#a1">style</a>-&gt;<a class="code" href="structStyle.html#o2">staffDistance</a> = val;
00289                                     <span class="keywordflow">else</span>
00290                                           <a class="code" href="utils_8h.html#a4">domError</a>(node);
00291                                     }
00292                               }
00293                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"music-font"</span>) {
00294                               }
00295                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"word-font"</span>) {
00296                               }
00297                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"lyric-font"</span>) {
00298                               }
00299                         <span class="keywordflow">else</span>
00300                               printf(<span class="stringliteral">"Import MusicXml:defaults: &lt;%s&gt; not supported\n"</span>, tag.latin1());
00301                         }
00302                   }
00303             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"movement-number"</span>) {
00304                   <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o5">movementNumber</a> = e.text();
00305                   }
00306             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"movement-title"</span>) {
00307                   <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o6">movementTitle</a> = e.text();
00308                   }
00309             <span class="keywordflow">else</span>
00310                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00311             }
00312       }
00313 
00314 <span class="comment">//---------------------------------------------------------</span>
00315 <span class="comment">//   xmlPartList</span>
00316 <span class="comment">//---------------------------------------------------------</span>
00317 
<a name="l00318"></a><a class="code" href="classMusicXml.html#d4">00318</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d4">MusicXml::xmlPartList</a>(QDomNode node)
00319       {
00320       <span class="keywordflow">while</span> (!node.isNull()) {
00321             QDomElement e = node.toElement();
00322             <span class="keywordflow">if</span> (e.isNull()) {
00323                   node = node.nextSibling();
00324                   <span class="keywordflow">continue</span>;
00325                   }
00326             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"score-part"</span>)
00327                   <a class="code" href="classMusicXml.html#d6">xmlScorePart</a>(node.firstChild(), e.attribute(QString(<span class="stringliteral">"id"</span>)));
00328             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"part-group"</span>)
00329                   ;
00330             <span class="keywordflow">else</span>
00331                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00332             node = node.nextSibling();
00333             }
00334       }
00335 
00336 <span class="comment">//---------------------------------------------------------</span>
00337 <span class="comment">//   xmlScorePart</span>
00338 <span class="comment">//---------------------------------------------------------</span>
00339 
<a name="l00340"></a><a class="code" href="classMusicXml.html#d6">00340</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d6">MusicXml::xmlScorePart</a>(QDomNode node, QString <span class="keywordtype">id</span>)
00341       {
00342       <a class="code" href="classPart.html">Part</a>* part = <span class="keyword">new</span> <a class="code" href="classPart.html">Part</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00343       part-&gt;<a class="code" href="classPart.html#a7">setId</a>(<span class="keywordtype">id</span>);
00344 
00345 <span class="comment">// printf("create track id:&lt;%s&gt;\n", id.latin1());</span>
00346 
00347       <span class="keywordflow">while</span> (!node.isNull()) {
00348             QDomElement e = node.toElement();
00349             <span class="keywordflow">if</span> (e.isNull()) {
00350                   node = node.nextSibling();
00351                   <span class="keywordflow">continue</span>;
00352                   }
00353             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"part-name"</span>) {
00354                   part-&gt;<a class="code" href="classPart.html#a12">setLongName</a>(e.text());
00355                   part-&gt;<a class="code" href="classPart.html#a14">setTrackName</a>(e.text());
00356                   }
00357             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"part-abbreviation"</span>)
00358                   ;
00359             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"score-instrument"</span>) {
00360                   QDomNode n = node.firstChild();
00361                   <span class="keywordflow">while</span> (!n.isNull()) {
00362                         QDomElement e = n.toElement();
00363                         <span class="keywordflow">if</span> (e.isNull()) {
00364                               n = n.nextSibling();
00365                               <span class="keywordflow">continue</span>;
00366                               }
00367                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"instrument-name"</span>) {
00368                               <span class="comment">// part-name or instrument-name?</span>
00369                               <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classPart.html#a10">longName</a>().isEmpty())
00370                                     part-&gt;<a class="code" href="classPart.html#a12">setLongName</a>(e.text());
00371                               }
00372                         <span class="keywordflow">else</span>
00373                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00374                         n = n.nextSibling();
00375                         }
00376                   }
00377             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"midi-instrument"</span>) {
00378                   QDomNode n = node.firstChild();
00379                   <span class="keywordflow">while</span> (!n.isNull()) {
00380                         QDomElement e = n.toElement();
00381                         <span class="keywordflow">if</span> (e.isNull()) {
00382                               n = n.nextSibling();
00383                               <span class="keywordflow">continue</span>;
00384                               }
00385                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"midi-channel"</span>)
00386                               part-&gt;<a class="code" href="classPart.html#a16">setMidiChannel</a>(e.text().toInt());
00387                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"midi-program"</span>)
00388                               part-&gt;<a class="code" href="classPart.html#a17">setMidiProgram</a>(e.text().toInt());
00389                         <span class="keywordflow">else</span>
00390                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00391                         n = n.nextSibling();
00392                         }
00393                   }
00394             <span class="keywordflow">else</span>
00395                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00396             node = node.nextSibling();
00397             }
00398       <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a109">parts</a>()-&gt;<a class="code" href="classpstl_1_1plist.html#a2">push_back</a>(part);
00399       <a class="code" href="classStaff.html">Staff</a>* staff = <span class="keyword">new</span> <a class="code" href="classStaff.html">Staff</a>(<a class="code" href="classMusicXml.html#r0">score</a>, part, 0);
00400       part-&gt;<a class="code" href="classPart.html#a5">staves</a>()-&gt;push_back(staff);
00401       <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a5">staves</a>()-&gt;push_back(staff);
00402       }
00403 
00404 <span class="comment">//---------------------------------------------------------</span>
00405 <span class="comment">//   xmlPart</span>
00406 <span class="comment">//---------------------------------------------------------</span>
00407 
<a name="l00408"></a><a class="code" href="classMusicXml.html#d5">00408</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d5">MusicXml::xmlPart</a>(QDomNode node, QString <span class="keywordtype">id</span>)
00409       {
00410       <a class="code" href="classPartList.html">PartList</a>* pl = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a109">parts</a>();
00411       <a class="code" href="part_8h.html#a0">iPart</a> i;
00412       <span class="keywordflow">for</span> (i = pl-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); i != pl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++i) {
00413             <span class="keywordflow">if</span> ((*i)-&gt;id() == <span class="keywordtype">id</span>)
00414                   <span class="keywordflow">break</span>;
00415             }
00416       <span class="keywordflow">if</span> (i == pl-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>()) {
00417             printf(<span class="stringliteral">"Import MusicXml:xmlPart: cannot find part %s\n"</span>, <span class="keywordtype">id</span>.latin1());
00418             exit(-1);
00419             }
00420       <a class="code" href="classPart.html">Part</a>* part = *i;
00421       <a class="code" href="classMusicXml.html#r7">tick</a> = 0;
00422       <a class="code" href="classMusicXml.html#r8">maxtick</a> = 0;
00423       <a class="code" href="classMusicXml.html#r9">lastMeasureLen</a> = 0;
00424 
00425       <span class="keywordtype">int</span> staves = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00426       <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a100">first</a>()) {
00427             <a class="code" href="classMeasure.html">Measure</a>* measure  = <span class="keyword">new</span> <a class="code" href="classMeasure.html">Measure</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00428             measure-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
00429 
00430             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; staves; ++staff) {
00431                   <a class="code" href="classStaff.html">Staff</a>* instr = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff);
00432                   <span class="keywordflow">if</span> (instr-&gt;<a class="code" href="classStaff.html#a4">isTop</a>()) {
00433                         <a class="code" href="classBar.html">Bar</a>* bar = <span class="keyword">new</span> <a class="code" href="classBar.html">Bar</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00434                         bar-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(instr);
00435                         measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(bar);
00436                         }
00437                   }
00438             <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a102">push_back</a>(measure);
00439             <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r16">title</a>.isEmpty()) {
00440                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a21">TEXT_STYLE_TITLE</a>);
00441                   text-&gt;<a class="code" href="classSText.html#a5">setText</a>(<a class="code" href="classMusicXml.html#r16">title</a>);
00442                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
00443                   }
00444             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o6">movementTitle</a>.isEmpty()) {
00445                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a21">TEXT_STYLE_TITLE</a>);
00446                   text-&gt;<a class="code" href="classSText.html#a5">setText</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o6">movementTitle</a>);
00447                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
00448                   }
00449             <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r17">subTitle</a>.isEmpty()) {
00450                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a22">TEXT_STYLE_SUBTITLE</a>);
00451                   text-&gt;<a class="code" href="classSText.html#a5">setText</a>(<a class="code" href="classMusicXml.html#r17">subTitle</a>);
00452                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
00453                   }
00454             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o5">movementNumber</a>.isEmpty()) {
00455                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a22">TEXT_STYLE_SUBTITLE</a>);
00456                   text-&gt;<a class="code" href="classSText.html#a5">setText</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o5">movementNumber</a>);
00457                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
00458                   }
00459             <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r18">composer</a>.isEmpty()) {
00460                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a23">TEXT_STYLE_COMPOSER</a>);
00461                   text-&gt;<a class="code" href="classSText.html#a5">setText</a>(<a class="code" href="classMusicXml.html#r18">composer</a>);
00462                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
00463                   }
00464             <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r19">poet</a>.isEmpty()) {
00465                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a24">TEXT_STYLE_POET</a>);
00466                   text-&gt;<a class="code" href="classSText.html#a5">setText</a>(<a class="code" href="classMusicXml.html#r19">poet</a>);
00467                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
00468                   }
00469             <span class="keywordflow">if</span> (!<a class="code" href="classMusicXml.html#r20">translator</a>.isEmpty()) {
00470                   <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a37">TEXT_STYLE_TRANSLATOR</a>);
00471                   text-&gt;<a class="code" href="classSText.html#a5">setText</a>(<a class="code" href="classMusicXml.html#r20">translator</a>);
00472                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
00473                   }
00474             }
00475 
00476       <span class="keywordflow">while</span> (!node.isNull()) {
00477             QDomElement e = node.toElement();
00478             <span class="keywordflow">if</span> (e.isNull()){
00479                   node = node.nextSibling();
00480                   <span class="keywordflow">continue</span>;
00481                   }
00482             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"measure"</span>)
00483                   <a class="code" href="classMusicXml.html#d7">xmlMeasure</a>(part, node, e.attribute(QString(<span class="stringliteral">"number"</span>)).toInt()-1);
00484 
00485             <span class="keywordflow">else</span>
00486                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00487             node = node.nextSibling();
00488             }
00489       }
00490 
00491 <span class="comment">//---------------------------------------------------------</span>
00492 <span class="comment">//   xmlMeasure</span>
00493 <span class="comment">//---------------------------------------------------------</span>
00494 
<a name="l00495"></a><a class="code" href="classMusicXml.html#d7">00495</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d7">MusicXml::xmlMeasure</a>(<a class="code" href="classPart.html">Part</a>* part, QDomNode node, <span class="keywordtype">int</span> number)
00496       {
00497       <span class="keywordtype">int</span> staves = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a6">nstaves</a>();
00498       <span class="keywordflow">if</span> (staves == 0) {
00499             printf(<span class="stringliteral">"no staves!\n"</span>);
00500             <span class="keywordflow">return</span>;
00501             }
00502 
00503       <span class="comment">// search measure for tick</span>
00504       <a class="code" href="classMeasure.html">Measure</a>* measure = 0;
00505       <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a100">first</a>(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00506             <span class="keywordflow">if</span> (m-&gt;<a class="code" href="classElement.html#a74">tick</a>() == <a class="code" href="classMusicXml.html#r7">tick</a>) {
00507                   measure = m;
00508                   <span class="keywordflow">break</span>;
00509                   }
00510             }
00511       <span class="keywordflow">if</span> (!measure) {
00512             measure  = <span class="keyword">new</span> <a class="code" href="classMeasure.html">Measure</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00513             measure-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
00514             measure-&gt;<a class="code" href="classMeasure.html#a21">setNo</a>(number);
00515 
00516             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staff = 0; staff &lt; staves; ++staff) {
00517                   <a class="code" href="classStaff.html">Staff</a>* staffp = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff);
00518                   <span class="keywordflow">if</span> (staffp-&gt;<a class="code" href="classStaff.html#a4">isTop</a>()) {
00519                         <a class="code" href="classBar.html">Bar</a>* bar = <span class="keyword">new</span> <a class="code" href="classBar.html">Bar</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00520                         bar-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(staffp);
00521                         measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(bar);
00522                         }
00523                   }
00524             <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a102">push_back</a>(measure);
00525             }
00526 
00527       <span class="comment">// initialize voice list</span>
00528       <span class="comment">// for (int i = 0; i &lt; part-&gt;nstaves(); ++i) {</span>
00529       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="globals_8h.html#a4">MAX_STAVES</a>; ++i)
00530             <a class="code" href="classMusicXml.html#r1">voicelist</a>[i].clear();
00531 
00532       QDomElement e = node.toElement();
00533       QString implicit = e.attribute(<span class="stringliteral">"implicit"</span>, <span class="stringliteral">"no"</span>);
00534       <span class="keywordflow">if</span> (implicit == <span class="stringliteral">"yes"</span>)
00535             measure-&gt;<a class="code" href="classMeasure.html#a17">setIrregular</a>(<span class="keyword">true</span>);
00536 
00537       node = node.firstChild();
00538       <span class="keywordtype">int</span> staff = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(part);
00539       <span class="keywordflow">while</span> (!node.isNull()) {
00540             QDomElement e = node.toElement();
00541             <span class="keywordflow">if</span> (e.isNull()) {
00542                   node = node.nextSibling();
00543                   <span class="keywordflow">continue</span>;
00544                   }
00545             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"attributes"</span>)
00546                   <a class="code" href="classMusicXml.html#d8">xmlAttributes</a>(measure, staff, node.firstChild());
00547             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"note"</span>)
00548                   <a class="code" href="classMusicXml.html#d9">xmlNote</a>(measure, staff, node.firstChild());
00549             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"backup"</span>) {
00550                   QDomNode n = node.firstChild();
00551                   <span class="keywordflow">while</span> (!n.isNull()) {
00552                         QDomElement e = n.toElement();
00553                         <span class="keywordflow">if</span> (e.isNull()) {
00554                               n = n.nextSibling();
00555                               <span class="keywordflow">continue</span>;
00556                               }
00557                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"duration"</span>) {
00558                               <span class="keywordtype">int</span> val = e.text().toInt();
00559                               <span class="keywordflow">if</span> (val == 0)     <span class="comment">// neuratron scanner produces sometimes 0 !?</span>
00560                                     val = 1;
00561                               val = (val * ::division) / <a class="code" href="classMusicXml.html#r14">divisions</a>;
00562                               <a class="code" href="classMusicXml.html#r7">tick</a> -= val;
00563                               <a class="code" href="classMusicXml.html#r10">lastLen</a> = val;    <span class="comment">// ?</span>
00564                               }
00565                         <span class="keywordflow">else</span>
00566                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00567                         n = n.nextSibling();
00568                         }
00569                   }
00570             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"direction"</span>) {
00571                   QString placement = e.attribute(QString(<span class="stringliteral">"placement"</span>));
00572                   <a class="code" href="classMusicXml.html#d2">direction</a>(measure, staff, placement, node.firstChild());
00573                   }
00574             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"print"</span>) {
00575                   QString newSystem = e.attribute(<span class="stringliteral">"new-system"</span>, <span class="stringliteral">"no"</span>);
00576                   QString newPage   = e.attribute(<span class="stringliteral">"new-page"</span>, <span class="stringliteral">"no"</span>);
00577                   <span class="keywordflow">if</span> (newSystem == <span class="stringliteral">"yes"</span>)
00578                         measure-&gt;<a class="code" href="classMeasure.html#a36">setLineBreak</a>(<span class="keyword">true</span>);
00579                   <span class="keywordflow">if</span> (newPage == <span class="stringliteral">"yes"</span>)
00580                         measure-&gt;<a class="code" href="classMeasure.html#a65">prev</a>()-&gt;<a class="code" href="classMeasure.html#a37">setPageBreak</a>(<span class="keyword">true</span>);
00581                   <span class="keywordflow">for</span> (QDomNode n = node.firstChild(); !n.isNull(); n = n.nextSibling()) {
00582                         QDomElement e = n.toElement();
00583                         <span class="keywordflow">if</span> (e.isNull())
00584                               <span class="keywordflow">continue</span>;
00585                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"system-layout"</span>) {
00586                               }
00587                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"staff-layout"</span>) {
00588                               }
00589                         <span class="keywordflow">else</span>
00590                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00591                         }
00592                   }
00593             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"forward"</span>) {
00594                   QDomNode n = node.firstChild();
00595                   <span class="keywordflow">while</span> (!n.isNull()) {
00596                         QDomElement e = n.toElement();
00597                         <span class="keywordflow">if</span> (e.isNull())
00598                               <span class="keywordflow">continue</span>;
00599                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"duration"</span>) {
00600                               <span class="keywordtype">int</span> val = (e.text().toInt() * ::division)/<a class="code" href="classMusicXml.html#r14">divisions</a>;
00601                               <a class="code" href="classMusicXml.html#r7">tick</a> += val;
00602                               <a class="code" href="classMusicXml.html#r10">lastLen</a> = val;    <span class="comment">// ?</span>
00603                               }
00604                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"voice"</span>)
00605                               ;
00606                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"staff"</span>)
00607                               ;
00608                         <span class="keywordflow">else</span>
00609                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00610                         n = n.nextSibling();
00611                         }
00612                   }
00613             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"barline"</span>) {
00614                   QDomNode n = node.firstChild();
00615                   QString loc = e.attribute(<span class="stringliteral">"location"</span>, <span class="stringliteral">"right"</span>);
00616                   QString barStyle;
00617                   QString repeat;
00618                   <span class="keywordflow">while</span> (!n.isNull()) {
00619                         QDomElement e = n.toElement();
00620                         <span class="keywordflow">if</span> (e.isNull()) {
00621                               n = n.nextSibling();
00622                               <span class="keywordflow">continue</span>;
00623                               }
00624                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"bar-style"</span>) {
00625                               barStyle = e.text();
00626                               }
00627                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"ending"</span>)
00628                               ;
00629                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"repeat"</span>)
00630                               repeat = e.attribute(<span class="stringliteral">"direction"</span>);
00631                         <span class="keywordflow">else</span>
00632                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00633                         n = n.nextSibling();
00634                         }
00635                   <a class="code" href="classBar.html">Bar</a>* bar = <span class="keyword">new</span> <a class="code" href="classBar.html">Bar</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00636                   <span class="keywordflow">if</span> (barStyle == <span class="stringliteral">"light-heavy"</span> &amp;&amp; repeat == <span class="stringliteral">"backward"</span>) {
00637                         bar-&gt;<a class="code" href="classBar.html#a2">setBarType</a>(Bar::END_REPEAT);
00638                         }
00639                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (barStyle == <span class="stringliteral">"light-heavy"</span> &amp;&amp; repeat == <span class="stringliteral">"forward"</span>) {
00640                         bar-&gt;<a class="code" href="classBar.html#a2">setBarType</a>(Bar::START_REPEAT);
00641                         }
00642                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (barStyle == <span class="stringliteral">"light-heavy"</span> &amp;&amp; repeat.isEmpty())
00643                         bar-&gt;<a class="code" href="classBar.html#a2">setBarType</a>(Bar::END_BAR);
00644                   <span class="keywordflow">else</span>
00645                         printf(<span class="stringliteral">"unsupported bar type &lt;%s&gt;\n"</span>, barStyle.latin1());
00646                   bar-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff));
00647                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(bar);
00648                   }
00649             <span class="keywordflow">else</span>
00650                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00651             node = node.nextSibling();
00652             }
00653       staves = part-&gt;<a class="code" href="classPart.html#a4">nstaves</a>();
00654       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> rstaff = 0; rstaff &lt; staves; ++rstaff)
00655             measure-&gt;<a class="code" href="classMeasure.html#a59">layoutNoteHeads</a>(staff + rstaff);
00656       <span class="keywordtype">int</span> measureLen = <a class="code" href="classMusicXml.html#r8">maxtick</a> - measure-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00657 <span class="preprocessor">#if 1</span>
00658 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r9">lastMeasureLen</a> != measureLen) {
00659             <span class="keywordtype">int</span> z, n;
00660             <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a6">timesig</a>(measure-&gt;<a class="code" href="classElement.html#a74">tick</a>(), z, n);
00661             <span class="keywordtype">int</span> tm = <a class="code" href="sig_8h.html#a2">ticks_measure</a>(z, n);
00662             <span class="keywordflow">if</span> (measureLen != <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a9">ticksMeasure</a>(measure-&gt;<a class="code" href="classElement.html#a74">tick</a>())) {
00663                   <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a1">add</a>(measure-&gt;<a class="code" href="classElement.html#a74">tick</a>(), measureLen, z, n);
00664                   <span class="keywordflow">if</span> (tm != measureLen) {
00665                         <span class="keywordflow">if</span> (!measure-&gt;<a class="code" href="classMeasure.html#a16">irregular</a>()) {
00666                               measure-&gt;<a class="code" href="classMeasure.html#a17">setIrregular</a>(<span class="keyword">true</span>);
00667                               printf(<span class="stringliteral">"irregular Measure %d Len at %d(%d)   last: %d -&gt; should be: %d (tm=%d)\n"</span>,
00668                                  number, measure-&gt;<a class="code" href="classElement.html#a74">tick</a>(), <a class="code" href="classMusicXml.html#r8">maxtick</a>, <a class="code" href="classMusicXml.html#r9">lastMeasureLen</a>, measureLen, tm);
00669                               }
00670                         }
00671                   }
00672             }
00673 <span class="preprocessor">#endif</span>
00674 <span class="preprocessor"></span>      <a class="code" href="classMusicXml.html#r9">lastMeasureLen</a> = measureLen;
00675       <a class="code" href="classMusicXml.html#r7">tick</a> = <a class="code" href="classMusicXml.html#r8">maxtick</a>;
00676       }
00677 
00678 <span class="comment">//---------------------------------------------------------</span>
00679 <span class="comment">//   direction</span>
00680 <span class="comment">//---------------------------------------------------------</span>
00681 
<a name="l00682"></a><a class="code" href="classMusicXml.html#d2">00682</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d2">MusicXml::direction</a>(<a class="code" href="classMeasure.html">Measure</a>* measure, <span class="keywordtype">int</span> staff, <span class="keyword">const</span> QString&amp; placement, QDomNode node)
00683       {
00684       QString dirType;
00685       QString type;
00686       QString txt;
00687       QString lang;
00688       QString weight;
00689       <span class="keywordtype">int</span> rx = 0;
00690       <span class="keywordtype">int</span> ry = 0;
00691       <span class="keywordtype">int</span> offset = 0;
00692       <span class="keywordtype">int</span> rstaff = 0;
00693       QStringList dynamics;
00694       <span class="keywordtype">int</span> spread = 0;
00695 
00696       <span class="keywordflow">while</span> (!node.isNull()) {
00697             QDomElement e = node.toElement();
00698             <span class="keywordflow">if</span> (e.isNull()) {
00699                   node = node.nextSibling();
00700                   <span class="keywordflow">continue</span>;
00701                   }
00702             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"direction-type"</span>) {
00703                   QDomNode n = node.firstChild();
00704                   <span class="keywordflow">while</span> (!n.isNull()) {
00705                         QDomElement e = n.toElement();
00706                         <span class="keywordflow">if</span> (e.isNull())
00707                               <span class="keywordflow">continue</span>;
00708                         ry = -(e.attribute(QString(<span class="stringliteral">"relative-y"</span>), <span class="stringliteral">"0"</span>).toInt())+10;
00709                         rx = e.attribute(QString(<span class="stringliteral">"relative-x"</span>), <span class="stringliteral">"0"</span>).toInt();
00710                         dirType = e.tagName();
00711                         <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"words"</span>) {
00712                               txt    = e.text();
00713                               lang   = e.attribute(QString(<span class="stringliteral">"xml:lang"</span>), <span class="stringliteral">"it"</span>);
00714                               weight = e.attribute(QString(<span class="stringliteral">"font-weight"</span>));
00715                               }
00716                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"pedal"</span>) {
00717                               type = e.attribute(QString(<span class="stringliteral">"type"</span>));
00718                               }
00719                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"dynamics"</span>) {
00720                               QDomNode nn = n.firstChild();
00721                               <span class="keywordflow">if</span> (!nn.isNull()) {
00722                                     QDomElement e = nn.toElement();
00723                                     <span class="keywordflow">if</span> (!e.isNull()) {
00724                                           dynamics.push_back(e.tagName());
00725                                           }
00726                                     }
00727                               }
00728                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"wedge"</span>) {
00729                               type   = e.attribute(QString(<span class="stringliteral">"type"</span>));
00730                               spread = e.attribute(QString(<span class="stringliteral">"spread"</span>), <span class="stringliteral">"0"</span>).toInt();
00731                               }
00732                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"dashes"</span>) {
00733                               }
00734                         <span class="keywordflow">else</span>
00735                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00736                         n = n.nextSibling();
00737                         }
00738                   }
00739             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"sound"</span>) {
00740                   <span class="comment">// attr: dynamics, tempo</span>
00741                   }
00742             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"offset"</span>)
00743                   offset = (e.text().toInt() * ::division)/<a class="code" href="classMusicXml.html#r14">divisions</a>;
00744             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"staff"</span>)
00745                   rstaff = e.text().toInt() - 1;
00746             <span class="keywordflow">else</span>
00747                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00748             node = node.nextSibling();
00749             }
00750       <span class="keywordflow">if</span> (placement == <span class="stringliteral">"below"</span>)
00751             ry += 60;
00752 
00753       <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"words"</span>) {
00754             <a class="code" href="classSText.html">SText</a>* t = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00755             t-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
00756             t-&gt;<a class="code" href="classSText.html#a5">setText</a>(txt);
00757             t-&gt;<a class="code" href="classSText.html#a12">setStyle</a>(<a class="code" href="style_8h.html#a45a30">TEXT_STYLE_TECHNIK</a>);
00758             <span class="keywordflow">if</span> (placement == <span class="stringliteral">"above"</span>)
00759                   ry -= 12;
00760             t-&gt;<a class="code" href="classElement.html#a29">setUserOff</a>(QPointF(rx/10.0, ry/10.0));
00761             t-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + rstaff));
00762             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(t);
00763             }
00764       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"pedal"</span>) {
00765             <a class="code" href="classSymbol.html">Symbol</a>* s = <span class="keyword">new</span> <a class="code" href="classSymbol.html">Symbol</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00766             s-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a> + offset);
00767             <span class="keywordflow">if</span> (type == <span class="stringliteral">"start"</span>)
00768                   s-&gt;<a class="code" href="classSymbol.html#a4">setSym</a>(<a class="code" href="symbols_8cpp.html#a124">pedalPedSym</a>);
00769             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"stop"</span>)
00770                   s-&gt;<a class="code" href="classSymbol.html#a4">setSym</a>(<a class="code" href="symbols_8cpp.html#a118">pedalasteriskSym</a>);
00771             <span class="keywordflow">else</span>
00772                   printf(<span class="stringliteral">"unknown pedal %s\n"</span>, type.latin1());
00773             s-&gt;<a class="code" href="classElement.html#a29">setUserOff</a>(QPointF(rx/10.0, ry/10.0));
00774             s-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + rstaff));
00775             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(s);
00776             }
00777       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"dynamics"</span>) {
00778             <span class="comment">// more than one dynamic ???</span>
00779             <span class="keywordflow">for</span> (QStringList::Iterator it = dynamics.begin(); it != dynamics.end(); ++it ) {
00780                   <a class="code" href="dynamics_8h.html#a29">DynVal</a> val = Dynamic::tag2val(*it);
00781                   <a class="code" href="classDynamic.html">Dynamic</a>* dyn = <span class="keyword">new</span> <a class="code" href="classDynamic.html">Dynamic</a>(<a class="code" href="classMusicXml.html#r0">score</a>, val);
00782                   <span class="keywordflow">if</span> (placement == <span class="stringliteral">"above"</span>)
00783                         ry -= 12;
00784                   dyn-&gt;<a class="code" href="classElement.html#a29">setUserOff</a>(QPointF(rx/10.0, ry/10.0));
00785                   dyn-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + rstaff));
00786                   dyn-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a> + offset);
00787                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(dyn);
00788                   }
00789             }
00790       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dirType == <span class="stringliteral">"wedge"</span>) {
00791             <span class="comment">//</span>
00792             <span class="comment">// mscore places wedges automatically below staves, so</span>
00793             <span class="comment">// undo the y +60 offset</span>
00794             <span class="comment">//</span>
00795             <span class="keywordflow">if</span> (type == <span class="stringliteral">"crescendo"</span>)
00796                   <a class="code" href="classMusicXml.html#d0">addWedge</a>(0, <a class="code" href="classMusicXml.html#r7">tick</a> + offset, rx, ry, spread);
00797             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"stop"</span>)
00798                   <a class="code" href="classMusicXml.html#d1">genWedge</a>(0, <a class="code" href="classMusicXml.html#r7">tick</a> + offset, measure, staff+rstaff, rx, ry-60, spread);
00799             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <span class="stringliteral">"diminuendo"</span>)
00800                   <a class="code" href="classMusicXml.html#d0">addWedge</a>(0, <a class="code" href="classMusicXml.html#r7">tick</a> + offset, rx, ry-60, spread);
00801             <span class="keywordflow">else</span>
00802                   printf(<span class="stringliteral">"unknown wedge type: %s\n"</span>, type.latin1());
00803             }
00804       }
00805 
00806 <span class="comment">//---------------------------------------------------------</span>
00807 <span class="comment">//   xmlAttributes</span>
00808 <span class="comment">//---------------------------------------------------------</span>
00809 
<a name="l00810"></a><a class="code" href="classMusicXml.html#d8">00810</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d8">MusicXml::xmlAttributes</a>(<a class="code" href="classMeasure.html">Measure</a>* measure, <span class="keywordtype">int</span> staff, QDomNode node)
00811       {
00812       <span class="keywordflow">while</span> (!node.isNull()) {
00813             QDomElement e = node.toElement();
00814             <span class="keywordflow">if</span> (e.isNull())
00815                   <span class="keywordflow">continue</span>;
00816             <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"divisions"</span>)
00817                   <a class="code" href="classMusicXml.html#r14">divisions</a> = e.text().toInt();
00818             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"key"</span>) {
00819                   QDomNode n = node.firstChild();
00820                   <span class="keywordtype">int</span> key = 0;
00821                   <span class="keywordflow">while</span> (!n.isNull()) {
00822                         QDomElement e = n.toElement();
00823                         <span class="keywordflow">if</span> (e.isNull())
00824                               <span class="keywordflow">continue</span>;
00825                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"fifths"</span>)
00826                               key = e.text().toInt();
00827                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"mode"</span>)
00828                               ;
00829                         <span class="keywordflow">else</span>
00830                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00831                         n = n.nextSibling();
00832                         }
00833                   <span class="keywordtype">int</span> oldkey = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o10">keymap</a>-&gt;<a class="code" href="classKeyList.html#a1">key</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
00834                   <span class="keywordflow">if</span> (oldkey != key)
00835                         (*<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o10">keymap</a>)[<a class="code" href="classMusicXml.html#r7">tick</a>] = key;
00836 
00837                   <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r7">tick</a> &amp;&amp; oldkey != key) {
00838                         <span class="comment">// dont generate symbol for tick 0</span>
00839                         <a class="code" href="classPart.html">Part</a>* part = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a17">part</a>(staff);
00840                         <span class="keywordtype">int</span> staves = part-&gt;<a class="code" href="classPart.html#a4">nstaves</a>();
00841                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; staves; ++i) {
00842                               <span class="keywordtype">int</span> clef = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff)-&gt;clef()-&gt;clef(<a class="code" href="classMusicXml.html#r7">tick</a>);
00843                               <span class="keywordtype">int</span> clefOffset = <a class="code" href="clef_8h.html#a0">clefTable</a>[clef].<a class="code" href="structClefInfo.html#o2">yOffset</a>;
00844                               <a class="code" href="classKeySig.html">KeySig</a>* keysig = <span class="keyword">new</span> <a class="code" href="classKeySig.html">KeySig</a>(<a class="code" href="classMusicXml.html#r0">score</a>, key, clefOffset);
00845                               keysig-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
00846                               keysig-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + i));
00847                               measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(keysig);
00848                               }
00849                         }
00850                   }
00851             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"time"</span>) {
00852                   QDomNode n = node.firstChild();
00853                   <span class="keywordflow">while</span> (!n.isNull()) {
00854                         QDomElement e = n.toElement();
00855                         <span class="keywordflow">if</span> (e.isNull())
00856                               <span class="keywordflow">continue</span>;
00857                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"beats"</span>)
00858                               <a class="code" href="classMusicXml.html#r12">beats</a> = e.text().toInt();
00859                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"beat-type"</span>) {
00860                               <a class="code" href="classMusicXml.html#r13">beatType</a> = e.text().toInt();
00861                               }
00862                         <span class="keywordflow">else</span>
00863                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00864                         n = n.nextSibling();
00865                         }
00866                   <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a1">add</a>(<a class="code" href="classMusicXml.html#r7">tick</a>, <a class="code" href="classMusicXml.html#r12">beats</a>, <a class="code" href="classMusicXml.html#r13">beatType</a>);
00867                   <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r7">tick</a>) {
00868                         <span class="comment">// dont generate symbol for tick 0</span>
00869                         <a class="code" href="classPart.html">Part</a>* part = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a17">part</a>(staff);
00870                         <span class="keywordtype">int</span> staves = part-&gt;<a class="code" href="classPart.html#a4">nstaves</a>();
00871                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; staves; ++i) {
00872                               <a class="code" href="classTimeSig.html">TimeSig</a>* timesig = <span class="keyword">new</span> <a class="code" href="classTimeSig.html">TimeSig</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
00873                               timesig-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
00874                               timesig-&gt;<a class="code" href="classTimeSig.html#a9">setSig</a>(<a class="code" href="classMusicXml.html#r12">beats</a>, <a class="code" href="classMusicXml.html#r13">beatType</a>);
00875                               timesig-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + i));
00876                               measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(timesig);
00877                               }
00878                         }
00879                   }
00880             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"clef"</span>) {
00881                   QDomNode n = node.firstChild();
00882                   <span class="keywordtype">int</span> clef   = 0;
00883                   <span class="keywordtype">int</span> clefno = e.attribute(QString(<span class="stringliteral">"number"</span>), <span class="stringliteral">"1"</span>).toInt() - 1;
00884                   QString c;
00885                   <span class="keywordtype">int</span> line = -1;
00886                   <span class="keywordflow">while</span> (!n.isNull()) {
00887                         QDomElement e = n.toElement();
00888                         <span class="keywordflow">if</span> (e.isNull())
00889                               <span class="keywordflow">continue</span>;
00890                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"sign"</span>)
00891                               c = e.text();
00892                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"line"</span>)
00893                               line = e.text().toInt();
00894                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"clef-octave-change"</span>) {
00895                               <span class="keywordtype">int</span> i = e.text().toInt();
00896                               <span class="keywordflow">if</span> (i)
00897                                     printf(<span class="stringliteral">"clef-octave-change %d not implemented\n"</span>, i);
00898                               }
00899                         <span class="keywordflow">else</span>
00900                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00901                         n = n.nextSibling();
00902                         }
00903                   <span class="keywordflow">if</span> (c == <span class="stringliteral">"G"</span>)
00904                         clef = 0;
00905                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="stringliteral">"F"</span>)
00906                         clef = 4;
00907                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="stringliteral">"C"</span>) {
00908                         <span class="keywordflow">if</span> (line == 3)
00909                               clef = 10;
00910                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (line == 2)
00911                               clef = 11;
00912                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (line == 1)
00913                               clef = 12;
00914                         }
00915                   <a class="code" href="classStaff.html">Staff</a>* part = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + clefno);
00916                   <a class="code" href="classClefList.html">ClefList</a>* ct = part-&gt;<a class="code" href="classStaff.html#a2">clef</a>();
00917                   (*ct)[<a class="code" href="classMusicXml.html#r7">tick</a>] = clef;
00918                   <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r7">tick</a>) {
00919                         <span class="comment">// dont generate symbol for tick 0</span>
00920                         <a class="code" href="classClef.html">Clef</a>* clefs = <span class="keyword">new</span> <a class="code" href="classClef.html">Clef</a>(<a class="code" href="classMusicXml.html#r0">score</a>, clef, <span class="keyword">true</span>);
00921                         clefs-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
00922                         clefs-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(part);
00923                         measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(clefs);
00924                         ++clefno;
00925                         }
00926                   }
00927             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"staves"</span>) {
00928                   <span class="keywordtype">int</span> staves = e.text().toInt();
00929                   <a class="code" href="classPart.html">Part</a>* part = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a17">part</a>(staff);
00930                   part-&gt;<a class="code" href="classPart.html#a15">setStaves</a>(staves);
00931                   }
00932             <span class="keywordflow">else</span>
00933                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
00934             node = node.nextSibling();
00935             }
00936       }
00937 
00938 <span class="comment">//---------------------------------------------------------</span>
00939 <span class="comment">//   xmlNote</span>
00940 <span class="comment">//---------------------------------------------------------</span>
00941 
<a name="l00942"></a><a class="code" href="classMusicXml.html#d9">00942</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d9">MusicXml::xmlNote</a>(<a class="code" href="classMeasure.html">Measure</a>* measure, <span class="keywordtype">int</span> staff, QDomNode node)
00943       {
00944       <a class="code" href="classMusicXml.html#r4">voice</a> = 0;
00945       <a class="code" href="classMusicXml.html#r5">move</a>  = 0;
00946 
00947       <span class="keywordtype">int</span> duration = 0;
00948       <span class="keywordtype">bool</span> rest    = <span class="keyword">false</span>;
00949       <span class="keywordtype">int</span> relStaff = 0;
00950       QString lyric[<a class="code" href="musicxml_8h.html#a0">MAX_LYRICS</a>];
00951       QString syllabic[<a class="code" href="musicxml_8h.html#a0">MAX_LYRICS</a>];
00952       <a class="code" href="note_8h.html#a36">BeamMode</a> bm  = <a class="code" href="note_8h.html#a36a33">BEAM_NO</a>;
00953       <a class="code" href="globals_8h.html#a24">Direction</a> sd = <a class="code" href="globals_8h.html#a24a7">AUTO</a>;
00954       <span class="keywordtype">int</span> dots     = 0;
00955       <span class="keywordtype">bool</span> grace   = <span class="keyword">false</span>;
00956       QString tupletType;
00957       QString tupletPlacement;
00958       QString tupletBracket;
00959       QString step;
00960       QString graceSlash;
00961       <span class="keywordtype">int</span> alter  = 0;
00962       <span class="keywordtype">int</span> octave = 4;
00963       <span class="keywordtype">int</span> accidental = 0;
00964       <a class="code" href="globals_8h.html#a26">DurationType</a> durationType = <a class="code" href="globals_8h.html#a26a13">D_QUARTER</a>;
00965 
00966       <span class="keywordflow">while</span> (!node.isNull()) {
00967             QDomElement e = node.toElement();
00968             <span class="keywordflow">if</span> (e.isNull())
00969                   <span class="keywordflow">continue</span>;
00970             QString tag(e.tagName());
00971             <span class="keywordflow">if</span> (tag == <span class="stringliteral">"pitch"</span>) {
00972                   QDomNode n = node.firstChild();
00973                   step   = <span class="stringliteral">"C"</span>;
00974                   alter  = 0;
00975                   octave = 4;
00976                   <span class="keywordflow">while</span> (!n.isNull()) {
00977                         QDomElement e = n.toElement();
00978                         <span class="keywordflow">if</span> (e.isNull())
00979                               <span class="keywordflow">continue</span>;
00980                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"step"</span>)          <span class="comment">// A-G</span>
00981                               step = e.text();
00982                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"alter"</span>)    <span class="comment">// -1=flat 1=sharp (0.5=quarter sharp)</span>
00983                               alter = e.text().toInt();
00984                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"octave"</span>)   <span class="comment">// 0-9 4=middle C</span>
00985                               octave = e.text().toInt();
00986                         <span class="keywordflow">else</span>
00987                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
00988                         n = n.nextSibling();
00989                         }
00990                   }
00991             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"duration"</span>)
00992                   duration = e.text().toInt();
00993             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"type"</span>) {
00994                   QString s = e.text();
00995                   <span class="keywordflow">if</span> (s == <span class="stringliteral">"quarter"</span>)
00996                         durationType = <a class="code" href="globals_8h.html#a26a13">D_QUARTER</a>;
00997                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"eighth"</span>)
00998                         durationType = <a class="code" href="globals_8h.html#a26a14">D_EIGHT</a>;
00999                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"256th"</span>)
01000                         durationType = <a class="code" href="globals_8h.html#a26a15">D_256TH</a>;
01001                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"128th"</span>)
01002                         durationType = <a class="code" href="globals_8h.html#a26a16">D_128TH</a>;
01003                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"64th"</span>)
01004                         durationType = <a class="code" href="globals_8h.html#a26a17">D_64TH</a>;
01005                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"32nd"</span>)
01006                         durationType = <a class="code" href="globals_8h.html#a26a18">D_32ND</a>;
01007                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"16th"</span>)
01008                         durationType = <a class="code" href="globals_8h.html#a26a19">D_16TH</a>;
01009                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"half"</span>)
01010                         durationType = <a class="code" href="globals_8h.html#a26a20">D_HALF</a>;
01011                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"whole"</span>)
01012                         durationType = <a class="code" href="globals_8h.html#a26a21">D_WHOLE</a>;
01013                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"breve"</span>)
01014                         durationType = <a class="code" href="globals_8h.html#a26a22">D_BREVE</a>;
01015                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"long"</span>)
01016                         durationType = <a class="code" href="globals_8h.html#a26a23">D_LONG</a>;
01017                   <span class="keywordflow">else</span>
01018                         printf(<span class="stringliteral">"unknown note type &lt;%s&gt;\n"</span>, s.latin1());
01019                   }
01020             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"chord"</span>)
01021                   <a class="code" href="classMusicXml.html#r7">tick</a> -= <a class="code" href="classMusicXml.html#r10">lastLen</a>;
01022             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"voice"</span>) {
01023                   <a class="code" href="classMusicXml.html#r4">voice</a> = e.text().toInt() - 1;
01024                   }
01025             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"stem"</span>) {
01026                   <span class="keywordflow">if</span> (e.text() == <span class="stringliteral">"up"</span>)
01027                         sd = <a class="code" href="structUP.html">UP</a>;
01028                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.text() == <span class="stringliteral">"down"</span>)
01029                         sd = <a class="code" href="globals_8h.html#a24a9">DOWN</a>;
01030                   <span class="keywordflow">else</span>
01031                         printf(<span class="stringliteral">"unknown stem direction %s\n"</span>, e.text().latin1());
01032                   }
01033             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"staff"</span>) {
01034                   relStaff = e.text().toInt() - 1;
01035                   <span class="comment">//</span>
01036                   <span class="comment">// Musicxml voices are counted for all staffs of an</span>
01037                   <span class="comment">// instrument. They are not limited. In mscore voices are associated</span>
01038                   <span class="comment">// with a staff. Every staff can have at most VOICES voices.</span>
01039                   <span class="comment">// The following lines map musicXml voices to mscore voices.</span>
01040                   <span class="comment">// If a voice crosses two staffs, this is expressed with the</span>
01041                   <span class="comment">// "move" parameter in mscore.</span>
01042                   <span class="comment">//</span>
01043 
01044                   <span class="keywordtype">int</span> found = <span class="keyword">false</span>;
01045                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s = 0; s &lt; <a class="code" href="globals_8h.html#a4">MAX_STAVES</a>; ++s) {
01046                         <span class="keywordtype">int</span> v = 0;
01047                         <span class="keywordflow">for</span> (std::vector&lt;int&gt;::iterator i = <a class="code" href="classMusicXml.html#r1">voicelist</a>[s].begin(); i != voicelist[s].end(); ++i, ++v) {
01048                               <span class="keywordflow">if</span> (*i == <a class="code" href="classMusicXml.html#r4">voice</a>) {
01049                                     <span class="keywordtype">int</span> d = relStaff + staff - s;
01050                                     relStaff -= d;
01051                                     <a class="code" href="classMusicXml.html#r5">move</a> += d;
01052                                     <a class="code" href="classMusicXml.html#r4">voice</a> = v;
01053                                     found = <span class="keyword">true</span>;
01054                                     <span class="keywordflow">break</span>;
01055                                     }
01056                               }
01057                         }
01058                   <span class="keywordflow">if</span> (!found) {
01059                         <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r1">voicelist</a>[staff+relStaff].size() &gt;= unsigned(<a class="code" href="globals_8h.html#a3">VOICES</a>))
01060                               printf(<span class="stringliteral">"ImportMusicXml: too many voices (&gt; %d)\n"</span>, <a class="code" href="globals_8h.html#a3">VOICES</a>);
01061                         <span class="keywordflow">else</span> {
01062                               <a class="code" href="classMusicXml.html#r1">voicelist</a>[staff+relStaff].push_back(<a class="code" href="classMusicXml.html#r4">voice</a>);
01063                               <a class="code" href="classMusicXml.html#r4">voice</a> = <a class="code" href="classMusicXml.html#r1">voicelist</a>[staff+relStaff].size() -1;
01064                               }
01065                         }
01066                   }
01067             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"beam"</span>) {
01068                   QString s = e.text();
01069                   <span class="keywordflow">if</span> (s == <span class="stringliteral">"begin"</span>) {
01070                         bm = <a class="code" href="note_8h.html#a36a30">BEAM_BEGIN</a>;
01071                         }
01072                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"end"</span>) {
01073                         bm = <a class="code" href="note_8h.html#a36a32">BEAM_END</a>;
01074                         }
01075                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"continue"</span>)
01076                         bm = <a class="code" href="note_8h.html#a36a31">BEAM_MID</a>;
01077                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"backward hook"</span>)
01078                         ;
01079                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"forward hook"</span>)
01080                         ;
01081                   <span class="keywordflow">else</span>
01082                         printf(<span class="stringliteral">"unknown beam keyword &lt;%s&gt;\n"</span>, s.latin1());
01083                   }
01084             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"rest"</span>)
01085                   rest = <span class="keyword">true</span>;
01086             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"lyric"</span>) {
01087                   <span class="keywordtype">int</span> lyricNo = e.attribute(QString(<span class="stringliteral">"number"</span>), <span class="stringliteral">"1"</span>).toInt() - 1;
01088                   <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r11">maxLyrics</a> &lt;= lyricNo)
01089                         <a class="code" href="classMusicXml.html#r11">maxLyrics</a> = lyricNo + 1;
01090                   <span class="keywordflow">if</span> (lyricNo &gt; <a class="code" href="musicxml_8h.html#a0">MAX_LYRICS</a>)
01091                         printf(<span class="stringliteral">"too much lyrics (&gt;%d)\n"</span>, <a class="code" href="musicxml_8h.html#a0">MAX_LYRICS</a>);
01092                   QDomNode n = node.firstChild();
01093                   <span class="keywordflow">while</span> (!n.isNull()) {
01094                         QDomElement e = n.toElement();
01095                         <span class="keywordflow">if</span> (e.isNull())
01096                               <span class="keywordflow">continue</span>;
01097                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"syllabic"</span>)
01098                               syllabic[lyricNo] = e.text();
01099                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"text"</span>)
01100                               lyric[lyricNo] = e.text();
01101                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"extend"</span>)
01102                               ;
01103                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"end-line"</span>)
01104                               ;
01105                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"end-paragraph"</span>)
01106                               ;
01107                         <span class="keywordflow">else</span>
01108                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
01109                         n = n.nextSibling();
01110                         }
01111                   }
01112             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"dot"</span>)
01113                   ++dots;
01114             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"accidental"</span>) {
01115                   QString s = e.text();
01116                   <span class="keywordflow">if</span> (s == <span class="stringliteral">"natural"</span>)
01117                         accidental = 5;
01118                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"flat"</span>)
01119                         accidental = 2;
01120                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"sharp"</span>)
01121                         accidental = 1;
01122                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"double-sharp"</span>)
01123                         accidental = 3;
01124                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"sharp-sharp"</span>)
01125                         accidental = 3;
01126                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"natural-flat"</span>)
01127                         ;
01128                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"quarter-flat"</span>)
01129                         ;
01130                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"quarter-sharp"</span>)
01131                         ;
01132                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"three-quarters-flat"</span>)
01133                         ;
01134                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"three-quarters-sharp"</span>)
01135                         ;
01136                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"flat-flat"</span>)
01137                         accidental = 4;
01138                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s == <span class="stringliteral">"natural-sharp"</span>)
01139                         ;
01140                   <span class="keywordflow">else</span>
01141                         printf(<span class="stringliteral">"unknown accidental %s\n"</span>, s.latin1());
01142                   }
01143             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"notations"</span>) {
01144                   QDomNode n = node.firstChild();
01145                   <span class="keywordflow">while</span> (!n.isNull()) {
01146                         QDomElement e = n.toElement();
01147                         <span class="keywordflow">if</span> (e.isNull())
01148                               <span class="keywordflow">continue</span>;
01149                         <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"slur"</span>) {
01150                               <span class="keywordtype">int</span> slurNo   = e.attribute(QString(<span class="stringliteral">"number"</span>), <span class="stringliteral">"1"</span>).toInt() - 1;
01151                               QString slurType = e.attribute(QString(<span class="stringliteral">"type"</span>));
01152                               <span class="keywordflow">if</span> (slurType == <span class="stringliteral">"start"</span>) {
01153                                     <span class="keywordtype">bool</span> endSlur = <span class="keyword">false</span>;
01154                                     <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r2">slur</a>[slurNo] == 0)
01155                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo] = <span class="keyword">new</span> <a class="code" href="classSlur.html">Slur</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
01156                                     <span class="keywordflow">else</span>
01157                                           endSlur = <span class="keyword">true</span>;
01158                                     QString pl = e.attribute(QString(<span class="stringliteral">"placement"</span>));
01159                                     <span class="keywordflow">if</span> (pl == <span class="stringliteral">"above"</span>)
01160                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]-&gt;<a class="code" href="classSlurTie.html#a7">setSlurDirection</a>(<a class="code" href="structUP.html">UP</a>);
01161                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pl == <span class="stringliteral">"below"</span>)
01162                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]-&gt;<a class="code" href="classSlurTie.html#a7">setSlurDirection</a>(<a class="code" href="globals_8h.html#a24a9">DOWN</a>);
01163                                     <a class="code" href="classStaff.html">Staff</a>* stf = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + relStaff);
01164                                     <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]-&gt;<a class="code" href="classSlur.html#a10">setStart</a>(<a class="code" href="classMusicXml.html#r7">tick</a>, stf, <a class="code" href="classMusicXml.html#r4">voice</a>);
01165                                     <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(stf);
01166                                     <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]-&gt;<a class="code" href="classElement.html#a11">setParent</a>(measure);
01167                                     <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a60">addObject</a>(<a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]);
01168                                     <span class="keywordflow">if</span> (endSlur)
01169                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo] = 0;
01170                                     }
01171                               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (slurType == <span class="stringliteral">"stop"</span>) {
01172                                     <a class="code" href="classStaff.html">Staff</a>* stf = <a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + relStaff);
01173                                     <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r2">slur</a>[slurNo] == 0) {
01174                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo] = <span class="keyword">new</span> <a class="code" href="classSlur.html">Slur</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
01175                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]-&gt;<a class="code" href="classSlur.html#a11">setEnd</a>(<a class="code" href="classMusicXml.html#r7">tick</a>, stf, <a class="code" href="classMusicXml.html#r4">voice</a>);
01176                                           }
01177                                     <span class="keywordflow">else</span> {
01178                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo]-&gt;<a class="code" href="classSlur.html#a11">setEnd</a>(<a class="code" href="classMusicXml.html#r7">tick</a>, stf, <a class="code" href="classMusicXml.html#r4">voice</a>);
01179                                           <a class="code" href="classMusicXml.html#r2">slur</a>[slurNo] = 0;
01180                                           }
01181                                     }
01182                               <span class="keywordflow">else</span>
01183                                     printf(<span class="stringliteral">"unknown slur type %s\n"</span>, slurType.latin1());
01184                               }
01185                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"tied"</span>) {
01186                               QString tiedType = e.attribute(QString(<span class="stringliteral">"type"</span>));
01187                               <span class="keywordflow">if</span> (tiedType == <span class="stringliteral">"start"</span>) {
01188                                     <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r3">tie</a>) {
01189                                           printf(<span class="stringliteral">"Tie already active\n"</span>);
01190                                           }
01191                                     <span class="keywordflow">else</span> {
01192                                           <a class="code" href="classMusicXml.html#r3">tie</a> = <span class="keyword">new</span> <a class="code" href="classTie.html">Tie</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
01193                                           }
01194                                     QString tiedOrientation = e.attribute(<span class="stringliteral">"orientation"</span>, <span class="stringliteral">"auto"</span>);
01195                                     <span class="keywordflow">if</span> (tiedOrientation == <span class="stringliteral">"over"</span>)
01196                                           <a class="code" href="classMusicXml.html#r3">tie</a>-&gt;<a class="code" href="classSlurTie.html#a7">setSlurDirection</a>(<a class="code" href="structUP.html">UP</a>);
01197                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tiedOrientation == <span class="stringliteral">"under"</span>)
01198                                           <a class="code" href="classMusicXml.html#r3">tie</a>-&gt;<a class="code" href="classSlurTie.html#a7">setSlurDirection</a>(<a class="code" href="globals_8h.html#a24a9">DOWN</a>);
01199                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tiedOrientation == <span class="stringliteral">"auto"</span>)
01200                                           ;
01201                                     <span class="keywordflow">else</span>
01202                                           printf(<span class="stringliteral">"unknown tied orientation: %s\n"</span>, tiedOrientation.latin1());
01203                                           ;
01204                                     }
01205                               <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tiedType == <span class="stringliteral">"stop"</span>)
01206                                     ;
01207                               <span class="keywordflow">else</span>
01208                                     printf(<span class="stringliteral">"unknown tied type %s\n"</span>, tiedType.latin1());
01209                               }
01210                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"tuplet"</span>) {
01211                               tupletType      = e.attribute(QString(<span class="stringliteral">"type"</span>));
01212                               tupletPlacement = e.attribute(<span class="stringliteral">"placement"</span>);
01213                               tupletBracket   = e.attribute(<span class="stringliteral">"bracket"</span>);
01214                               }
01215                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"dynamics"</span>) {
01216                               <span class="comment">// int rx            = e.attribute("relative-x").toInt();</span>
01217                               QString placement = e.attribute(<span class="stringliteral">"placement"</span>);
01218                               }
01219                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"articulations"</span>) {
01220                               }
01221                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"fermata"</span>) {
01222                               }
01223                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e.tagName() == <span class="stringliteral">"ornaments"</span>) {
01224                                         <span class="comment">//      &lt;trill-mark placement="above"/&gt;</span>
01225                               }
01226                         <span class="keywordflow">else</span>
01227                               <a class="code" href="utils_8h.html#a4">domError</a>(n);
01228                         n = n.nextSibling();
01229                         }
01230                   }
01231             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"tie"</span>) {
01232                   QString tieType = e.attribute(QString(<span class="stringliteral">"type"</span>));
01233                   <span class="keywordflow">if</span> (tieType == <span class="stringliteral">"start"</span>)
01234                         ;
01235                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tieType == <span class="stringliteral">"stop"</span>)
01236                         ;
01237                   <span class="keywordflow">else</span>
01238                         printf(<span class="stringliteral">"unknown tie type %s\n"</span>, tieType.latin1());
01239                   }
01240             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"grace"</span>) {
01241                   grace = <span class="keyword">true</span>;
01242                   graceSlash = e.attribute(QString(<span class="stringliteral">"slash"</span>));
01243                   }
01244             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"time-modification"</span>)  <span class="comment">// tuplets</span>
01245                   ;
01246             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tag == <span class="stringliteral">"notehead"</span>)
01247                   ;
01248             <span class="keywordflow">else</span>
01249                   <a class="code" href="utils_8h.html#a4">domError</a>(node);
01250             node = node.nextSibling();
01251             }
01252       <span class="keywordtype">int</span> ticks = (::division * duration) / <a class="code" href="classMusicXml.html#r14">divisions</a>;
01253 
01254       <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r7">tick</a> + ticks &gt; <a class="code" href="classMusicXml.html#r8">maxtick</a>)
01255             <a class="code" href="classMusicXml.html#r8">maxtick</a> = <a class="code" href="classMusicXml.html#r7">tick</a> + ticks;
01256 
01257 <span class="comment">//      printf("%s at %d voice %d dur = %d, beat %d/%d div %d pitch %d ticks %d\n",</span>
01258 <span class="comment">//         rest ? "Rest" : "Note", tick, voice, duration, beats, beatType,</span>
01259 <span class="comment">//         divisions, pitch, ticks);</span>
01260 
01261       <a class="code" href="classChordRest.html">ChordRest</a>* cr = 0;
01262 
01263       <span class="keywordflow">if</span> (rest) {
01264             cr = <span class="keyword">new</span> <a class="code" href="classRest.html">Rest</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="classMusicXml.html#r7">tick</a>, ticks);
01265             <span class="comment">// TODO: try to find out if this rest is part of a beam</span>
01266             cr-&gt;<a class="code" href="classChordRest.html#a5">setBeamMode</a>(<a class="code" href="note_8h.html#a36a33">BEAM_NO</a>);
01267 <span class="comment">//            cr-&gt;setBeamMode(BEAM_AUTO);</span>
01268             cr-&gt;<a class="code" href="classElement.html#a63">setVoice</a>(<a class="code" href="classMusicXml.html#r4">voice</a>);
01269             cr-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + relStaff));
01270             ((Rest*)cr)-&gt;setMove(<a class="code" href="classMusicXml.html#r5">move</a>);
01271             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(cr);
01272             }
01273       <span class="keywordflow">else</span> {
01274             <span class="keywordtype">char</span> c    = step[0].latin1();
01275             <a class="code" href="classNote.html">Note</a>* note = <span class="keyword">new</span> <a class="code" href="classNote.html">Note</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
01276             note-&gt;<a class="code" href="classNote.html#a7">setGrace</a>(grace);
01277 
01278             <a class="code" href="importxml_8cpp.html#a0">xmlSetPitch</a>(note, <a class="code" href="classMusicXml.html#r7">tick</a>, c, alter, octave, accidental);
01279 
01280             note-&gt;<a class="code" href="classNote.html#a10">setType</a>(durationType);
01281             note-&gt;<a class="code" href="classNote.html#a11">setDots</a>(dots);
01282             note-&gt;<a class="code" href="classElement.html#a63">setVoice</a>(<a class="code" href="classMusicXml.html#r4">voice</a>);
01283             note-&gt;<a class="code" href="classNote.html#a19">setMove</a>(<a class="code" href="classMusicXml.html#r5">move</a>);
01284 
01285             <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r3">tie</a>) {
01286                   note-&gt;<a class="code" href="classNote.html#a35">setTieFor</a>(<a class="code" href="classMusicXml.html#r3">tie</a>);
01287                   <a class="code" href="classMusicXml.html#r3">tie</a>-&gt;<a class="code" href="classTie.html#a3">setStartNote</a>(note);
01288                   <a class="code" href="classMusicXml.html#r3">tie</a>-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + relStaff));
01289                   <a class="code" href="classMusicXml.html#r3">tie</a> = 0;
01290                   }
01291 
01292             cr = measure-&gt;<a class="code" href="classMeasure.html#a49">findChord</a>(<a class="code" href="classMusicXml.html#r7">tick</a>, staff + relStaff, <a class="code" href="classMusicXml.html#r4">voice</a>, grace);
01293             <span class="keywordflow">if</span> (cr == 0) {
01294                   cr = <span class="keyword">new</span> <a class="code" href="classChord.html">Chord</a>(<a class="code" href="classMusicXml.html#r0">score</a>, <a class="code" href="classMusicXml.html#r7">tick</a>);
01295                   cr-&gt;<a class="code" href="classElement.html#a63">setVoice</a>(<a class="code" href="classMusicXml.html#r4">voice</a>);
01296                   cr-&gt;<a class="code" href="classElement.html#a77">setTickLen</a>(ticks);
01297                   ((Chord*)cr)-&gt;setGrace(grace);
01298                   cr-&gt;<a class="code" href="classChordRest.html#a5">setBeamMode</a>(bm);
01299                   cr-&gt;<a class="code" href="classElement.html#a64">add</a>(note);
01300                   cr-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + relStaff));
01301                   measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(cr);
01302                   }
01303             <span class="keywordflow">else</span> {
01304                   cr-&gt;<a class="code" href="classElement.html#a64">add</a>(note);
01305                   }
01306             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="musicxml_8h.html#a0">MAX_LYRICS</a>; ++i) {
01307                   <span class="keywordflow">if</span> (!lyric[i].isEmpty()) {
01308                         <a class="code" href="classLyrics.html">Lyrics</a>* l = <span class="keyword">new</span> <a class="code" href="classLyrics.html">Lyrics</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
01309                         l-&gt;<a class="code" href="classSText.html#a5">setText</a>(lyric[i]);
01310                         l-&gt;<a class="code" href="classElement.html#a75">setTick</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
01311                         l-&gt;<a class="code" href="classLyrics.html#a5">setNo</a>(i);
01312                         Lyrics::Syllabic s = Lyrics::SINGLE;
01313                         <span class="keywordflow">if</span> (syllabic[i] == <span class="stringliteral">"single"</span>)
01314                               ;
01315                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (syllabic[i] == <span class="stringliteral">"begin"</span>)
01316                               s = Lyrics::BEGIN;
01317                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (syllabic[i] == <span class="stringliteral">"end"</span>)
01318                               s = Lyrics::END;
01319                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (syllabic[i] == <span class="stringliteral">"middle"</span>)
01320                               s = Lyrics::MIDDLE;
01321                         <span class="keywordflow">else</span>
01322                               printf(<span class="stringliteral">"unknown syllabic %s\n"</span>, syllabic[i].latin1());
01323                         l-&gt;<a class="code" href="classLyrics.html#a7">setSyllabic</a>(s);
01324                         l-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff + relStaff));
01325                         <a class="code" href="classSegment.html">Segment</a>* segment = measure-&gt;<a class="code" href="classMeasure.html#a67">tick2segment</a>(<a class="code" href="classMusicXml.html#r7">tick</a>);
01326                         segment-&gt;<a class="code" href="classSegment.html#a22">add</a>(l);
01327                         }
01328                   }
01329             <span class="keywordflow">if</span> (cr-&gt;<a class="code" href="classChordRest.html#a6">beamMode</a>() == <a class="code" href="note_8h.html#a36a33">BEAM_NO</a>)
01330                   cr-&gt;<a class="code" href="classChordRest.html#a5">setBeamMode</a>(bm);
01331             ((<a class="code" href="classChord.html">Chord</a>*)cr)-&gt;setStemDirection(sd);
01332             }
01333       <span class="keywordflow">if</span> (!tupletType.isEmpty()) {
01334             <span class="keywordflow">if</span> (tupletType == <span class="stringliteral">"start"</span>) {
01335                   <a class="code" href="classMusicXml.html#r15">tuplet</a> = <span class="keyword">new</span> <a class="code" href="classTuplet.html">Tuplet</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
01336                   <span class="comment">// type, placement</span>
01337 
01338                   measure-&gt;<a class="code" href="classMeasure.html#a39">addTuplet</a>(<a class="code" href="classMusicXml.html#r15">tuplet</a>);
01339                   cr-&gt;<a class="code" href="classChordRest.html#a9">setTuplet</a>(<a class="code" href="classMusicXml.html#r15">tuplet</a>);
01340                   <a class="code" href="classMusicXml.html#r15">tuplet</a>-&gt;<a class="code" href="classTuplet.html#a9">add</a>(cr);
01341                   }
01342             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tupletType == <span class="stringliteral">"stop"</span>) {
01343                   cr-&gt;<a class="code" href="classChordRest.html#a9">setTuplet</a>(<a class="code" href="classMusicXml.html#r15">tuplet</a>);
01344                   <a class="code" href="classMusicXml.html#r15">tuplet</a>-&gt;<a class="code" href="classTuplet.html#a9">add</a>(cr);
01345                   <a class="code" href="classMusicXml.html#r15">tuplet</a> = 0;
01346                   }
01347             <span class="keywordflow">else</span>
01348                   printf(<span class="stringliteral">"unknown tuplet type %s\n"</span>, tupletType.latin1());
01349             }
01350       <span class="keywordflow">if</span> (<a class="code" href="classMusicXml.html#r15">tuplet</a>) {
01351             cr-&gt;<a class="code" href="classChordRest.html#a9">setTuplet</a>(<a class="code" href="classMusicXml.html#r15">tuplet</a>);
01352             <a class="code" href="classMusicXml.html#r15">tuplet</a>-&gt;<a class="code" href="classTuplet.html#a9">add</a>(cr);
01353             }
01354 
01355       <a class="code" href="classMusicXml.html#r10">lastLen</a> = ticks;
01356       <a class="code" href="classMusicXml.html#r7">tick</a> += ticks;
01357       }
01358 
01359 <span class="comment">//---------------------------------------------------------</span>
01360 <span class="comment">//   addWedge</span>
01361 <span class="comment">//---------------------------------------------------------</span>
01362 
<a name="l01363"></a><a class="code" href="classMusicXml.html#d0">01363</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d0">MusicXml::addWedge</a>(<span class="keywordtype">int</span> no, <span class="keywordtype">int</span> tick, <span class="keywordtype">int</span> rx, <span class="keywordtype">int</span> ry, <span class="keywordtype">int</span> spread)
01364       {
01365       <a class="code" href="structMusicXmlWedge.html">MusicXmlWedge</a> wedge;
01366       wedge.<a class="code" href="structMusicXmlWedge.html#o0">number</a> = no;
01367       wedge.<a class="code" href="structMusicXmlWedge.html#o1">startTick</a> = tick;
01368       wedge.<a class="code" href="structMusicXmlWedge.html#o2">rx</a> = rx;
01369       wedge.<a class="code" href="structMusicXmlWedge.html#o3">ry</a> = ry;
01370       wedge.<a class="code" href="structMusicXmlWedge.html#o4">spread</a> = spread;
01371 
01372       <span class="keywordflow">if</span> (int(<a class="code" href="classMusicXml.html#r21">wedgeList</a>.size()) &gt; no)
01373             <a class="code" href="classMusicXml.html#r21">wedgeList</a>[no] = wedge;
01374       <span class="keywordflow">else</span>
01375             <a class="code" href="classMusicXml.html#r21">wedgeList</a>.push_back(wedge);
01376       }
01377 
01378 <span class="comment">//---------------------------------------------------------</span>
01379 <span class="comment">//   genWedge</span>
01380 <span class="comment">//---------------------------------------------------------</span>
01381 
<a name="l01382"></a><a class="code" href="classMusicXml.html#d1">01382</a> <span class="keywordtype">void</span> <a class="code" href="classMusicXml.html#d1">MusicXml::genWedge</a>(<span class="keywordtype">int</span> no, <span class="keywordtype">int</span> endTick, <a class="code" href="classMeasure.html">Measure</a>* measure, <span class="keywordtype">int</span> staff,
01383    <span class="keywordtype">int</span> <span class="comment">/*rx*/</span>, <span class="keywordtype">int</span> <span class="comment">/*ry*/</span>, <span class="keywordtype">int</span> spread)
01384       {
01385       <a class="code" href="classHairpin.html">Hairpin</a>* hp = <span class="keyword">new</span> <a class="code" href="classHairpin.html">Hairpin</a>(<a class="code" href="classMusicXml.html#r0">score</a>);
01386 
01387       hp-&gt;<a class="code" href="classHairpin.html#a5">setTick1</a>(<a class="code" href="classMusicXml.html#r21">wedgeList</a>[no].startTick);
01388       hp-&gt;<a class="code" href="classHairpin.html#a6">setTick2</a>(endTick);
01389       hp-&gt;<a class="code" href="classHairpin.html#a4">setFlip</a>(spread &lt; <a class="code" href="classMusicXml.html#r21">wedgeList</a>[no].spread);
01390       hp-&gt;<a class="code" href="classElement.html#a29">setUserOff</a>(QPointF(<a class="code" href="classMusicXml.html#r21">wedgeList</a>[no].rx/10.0, <a class="code" href="classMusicXml.html#r21">wedgeList</a>[no].ry/10.0 + 1));
01391       hp-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classMusicXml.html#r0">score</a>-&gt;<a class="code" href="classScore.html#a7">staff</a>(staff));
01392       measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(hp);
01393       }
01394 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:28 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
