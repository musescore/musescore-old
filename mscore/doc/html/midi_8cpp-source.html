<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>MuseScore: midi.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>midi.cpp</h1><a href="midi_8cpp.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">//=========================================================</span>
00002 <span class="comment">//  MuseScore</span>
00003 <span class="comment">//  Linux Music Score Editor</span>
00004 <span class="comment">//  $Id: midi.cpp,v 1.21 2005/06/27 19:50:20 wschweer Exp $</span>
00005 <span class="comment">//</span>
00006 <span class="comment">//  (C) Copyright 2002-2004 Werner Schweer (ws@seh.de)</span>
00007 <span class="comment">//=========================================================</span>
00008 
00009 <span class="preprocessor">#include "<a class="code" href="mscore_8h.html">mscore.h</a>"</span>
00010 <span class="preprocessor">#include "<a class="code" href="midi_8h.html">midi.h</a>"</span>
00011 <span class="preprocessor">#include "<a class="code" href="canvas_8h.html">canvas.h</a>"</span>
00012 <span class="preprocessor">#include "<a class="code" href="file_8h.html">file.h</a>"</span>
00013 <span class="preprocessor">#include "<a class="code" href="project_8h.html">project.h</a>"</span>
00014 <span class="preprocessor">#include "<a class="code" href="key_8h.html">key.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="clef_8h.html">clef.h</a>"</span>
00016 <span class="preprocessor">#include "<a class="code" href="sig_8h.html">sig.h</a>"</span>
00017 <span class="preprocessor">#include "<a class="code" href="tempo_8h.html">tempo.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="note_8h.html">note.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="segment_8h.html">segment.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="utils_8h.html">utils.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="text_8h.html">text.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="slur_8h.html">slur.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="staff_8h.html">staff.h</a>"</span>
00024 <span class="preprocessor">#include "<a class="code" href="measure_8h.html">measure.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="style_8h.html">style.h</a>"</span>
00026 
<a name="l00027"></a><a class="code" href="midi_8cpp.html#a0">00027</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="midi_8cpp.html#a0">gmOnMsg</a>[] = { 0x7e, 0x7f, 0x09, 0x01 };
<a name="l00028"></a><a class="code" href="midi_8cpp.html#a1">00028</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="midi_8cpp.html#a1">gsOnMsg</a>[] = { 0x41, 0x10, 0x42, 0x12, 0x40, 0x00, 0x7f, 0x00, 0x41 };
<a name="l00029"></a><a class="code" href="midi_8cpp.html#a2">00029</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="midi_8cpp.html#a2">xgOnMsg</a>[] = { 0x43, 0x10, 0x4c, 0x00, 0x00, 0x7e, 0x00 };
<a name="l00030"></a><a class="code" href="midi_8cpp.html#a3">00030</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keyword">const</span> <span class="keywordtype">int</span>  <a class="code" href="midi_8cpp.html#a3">gmOnMsgLen</a> = <span class="keyword">sizeof</span>(<a class="code" href="midi_8cpp.html#a0">gmOnMsg</a>);
<a name="l00031"></a><a class="code" href="midi_8cpp.html#a4">00031</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keyword">const</span> <span class="keywordtype">int</span>  <a class="code" href="midi_8cpp.html#a4">gsOnMsgLen</a> = <span class="keyword">sizeof</span>(<a class="code" href="midi_8cpp.html#a1">gsOnMsg</a>);
<a name="l00032"></a><a class="code" href="midi_8cpp.html#a5">00032</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keyword">const</span> <span class="keywordtype">int</span>  <a class="code" href="midi_8cpp.html#a5">xgOnMsgLen</a> = <span class="keyword">sizeof</span>(<a class="code" href="midi_8cpp.html#a2">xgOnMsg</a>);
00033 
<a name="l00034"></a><a class="code" href="midi_8cpp.html#a6">00034</a> <span class="keyword">static</span> <a class="code" href="structMidiInstrument.html">MidiInstrument</a> <a class="code" href="midi_8cpp.html#a6">minstr</a>[] = {
00035       <span class="comment">// Piano</span>
00036       { 7, 0, 0,  0, 60, <span class="stringliteral">"Grand Piano"</span> },
00037       { 4, 0, 1,  0, 60, <span class="stringliteral">"GrndPnoK"</span> },
00038       { 4, 0, 18, 0, 60, <span class="stringliteral">"MelloGrP"</span> },
00039       { 4, 0, 40, 0, 60, <span class="stringliteral">"PianoStr"</span> },
00040       { 4, 0, 41, 0, 60, <span class="stringliteral">"Dream"</span> },
00041       { 7, 0, 0,  1, 60, <span class="stringliteral">"Bright Piano"</span> },
00042       { 4, 0, 1,  1, 60, <span class="stringliteral">"BritPnoK"</span> },
00043       { 7, 0, 0,  2, 60, <span class="stringliteral">"E.Grand"</span> },
00044       { 4, 0, 1,  2, 60, <span class="stringliteral">"ElGrPnoK"</span> },
00045       { 4, 0, 32, 2, 60, <span class="stringliteral">"Det.CP80"</span> },
00046       { 4, 0, 40, 2, 60, <span class="stringliteral">"ElGrPno1"</span> },
00047       { 4, 0, 41, 2, 60, <span class="stringliteral">"ElGrPno2"</span> },
00048       { 7, 0, 0,  3, 60, <span class="stringliteral">"Honky-tonk"</span> },
00049       { 4, 0, 1,  3, 60, <span class="stringliteral">"HonkyTonkK"</span> },
00050       { 7, 0, 0,  4, 60, <span class="stringliteral">"E.Piano"</span> },
00051       { 4, 0, 1,  4, 60, <span class="stringliteral">"El.Pno1K"</span> },
00052       { 4, 0, 18, 4, 60, <span class="stringliteral">"MelloEP1"</span> },
00053       { 4, 0, 32, 4, 60, <span class="stringliteral">"Chor.EP1"</span> },
00054       { 4, 0, 40, 4, 60, <span class="stringliteral">"HardEl.P"</span> },
00055       { 4, 0, 45, 4, 60, <span class="stringliteral">"VXElP1"</span> },
00056       { 4, 0, 64, 4, 60, <span class="stringliteral">"60sEl.P"</span> },
00057       { 7, 0, 0,  5, 60, <span class="stringliteral">"E.Piano 2"</span> },
00058       { 4, 0, 1,  5, 60, <span class="stringliteral">"El.Pno2K"</span> },
00059       { 4, 0, 32, 5, 60, <span class="stringliteral">"Chor.EP2"</span> },
00060       { 4, 0, 33, 5, 60, <span class="stringliteral">"DX.Hard"</span> },
00061       { 4, 0, 34, 5, 60, <span class="stringliteral">"DXLegend"</span> },
00062       { 4, 0, 40, 5, 60, <span class="stringliteral">"DXPhase"</span> },
00063       { 4, 0, 41, 5, 60, <span class="stringliteral">"DX+Analg"</span> },
00064       { 4, 0, 42, 5, 60, <span class="stringliteral">"DXKotoEP"</span> },
00065       { 4, 0, 45, 5, 60, <span class="stringliteral">"VXEl.P2"</span> },
00066       { 7, 0, 0,  6, 60, <span class="stringliteral">"Harpsichord"</span> },
00067       { 4, 0, 1,  6, 60, <span class="stringliteral">"Harpsi.K"</span> },
00068       { 4, 0, 25, 6, 60, <span class="stringliteral">"Harpsi.2"</span> },
00069       { 4, 0, 35, 6, 60, <span class="stringliteral">"Harpsi.3"</span> },
00070       { 7, 0, 0,  7, 60, <span class="stringliteral">"Clav."</span> },
00071       { 4, 0, 1,  7, 60, <span class="stringliteral">"Clavi.K"</span> },
00072       { 4, 0, 27, 7, 60, <span class="stringliteral">"ClaviWah"</span> },
00073       { 4, 0, 64, 7, 60, <span class="stringliteral">"PulseClv"</span> },
00074       { 4, 0, 65, 7, 60, <span class="stringliteral">"PierceCl"</span> },
00075 
00076 <span class="comment">// Chromatic Perc</span>
00077       { 7, 0, 0, 8, 0, <span class="stringliteral">"Celesta"</span> },
00078       { 7, 0, 0, 9, 0, <span class="stringliteral">"Glockenspiel"</span> },
00079       { 7, 0, 0, 10, 0, <span class="stringliteral">"Music Box"</span> },
00080       { 4, 0, 64, 10, 0, <span class="stringliteral">"Orgel"</span> },
00081       { 7, 0, 0, 11, 0, <span class="stringliteral">"Vibraphone"</span> },
00082       { 4, 0, 1, 11, 0, <span class="stringliteral">"VibesK"</span> },
00083       { 4, 0, 45, 11, 0, <span class="stringliteral">"HardVibe"</span> },
00084       { 7, 0, 0, 12, 0, <span class="stringliteral">"Marimba"</span> },
00085       { 4, 0, 1, 12, 0, <span class="stringliteral">"MarimbaK"</span> },
00086       { 4, 0, 64, 12, 0, <span class="stringliteral">"SineMrmb"</span> },
00087       { 4, 0, 96, 12, 0, <span class="stringliteral">"Balafon"</span> },
00088       { 4, 0, 97, 12, 0, <span class="stringliteral">"Balafon2"</span> },
00089       { 4, 0, 98, 12, 0, <span class="stringliteral">"LogDrum"</span> },
00090       { 7, 0, 0, 13, 0, <span class="stringliteral">"Xylophone"</span> },
00091       { 7, 0, 0, 14, 0, <span class="stringliteral">"Tubular Bells"</span> },
00092       { 4, 0, 96, 14, 0, <span class="stringliteral">"ChrchBel"</span> },
00093       { 4, 0, 97, 14, 0, <span class="stringliteral">"Carillon"</span> },
00094       { 7, 0, 0, 15, 0, <span class="stringliteral">"Dulcimer"</span> },
00095       { 4, 0, 35, 15, 0, <span class="stringliteral">"Dulcimr2"</span> },
00096       { 4, 0, 96, 15, 0, <span class="stringliteral">"Cimbalom"</span> },
00097       { 4, 0, 97, 15, 0, <span class="stringliteral">"Santur"</span> },
00098 <span class="comment">// Organ</span>
00099       { 7, 0, 0, 16, 0, <span class="stringliteral">"Drawbar Organ"</span> },
00100       { 4, 0, 32, 16, 0, <span class="stringliteral">"DelDrwOr"</span> },
00101       { 4, 0, 33, 16, 0, <span class="stringliteral">"60sDrOr1"</span> },
00102       { 4, 0, 34, 16, 0, <span class="stringliteral">"60sDrOr2"</span> },
00103       { 4, 0, 35, 16, 0, <span class="stringliteral">"70sDrOr1"</span> },
00104       { 4, 0, 36, 16, 0, <span class="stringliteral">"DrawOrg2"</span> },
00105       { 4, 0, 37, 16, 0, <span class="stringliteral">"60sDrOr3"</span> },
00106       { 4, 0, 38, 16, 0, <span class="stringliteral">"EvenBar"</span> },
00107       { 4, 0, 40, 16, 0, <span class="stringliteral">"16+2\"2/3"</span> },
00108       { 4, 0, 64, 16, 0, <span class="stringliteral">"OrganBa"</span> },
00109       { 4, 0, 65, 16, 0, <span class="stringliteral">"70sDrOr2"</span> },
00110       { 4, 0, 66, 16, 0, <span class="stringliteral">"CheezOrg"</span> },
00111       { 4, 0, 67, 16, 0, <span class="stringliteral">"DrawOrg3"</span> },
00112       { 7, 0, 0, 17, 0, <span class="stringliteral">"Perc. Organ"</span> },
00113       { 4, 0, 24, 17, 0, <span class="stringliteral">"70sPcOr1"</span> },
00114       { 4, 0, 32, 17, 0, <span class="stringliteral">"DetPrcOr"</span> },
00115       { 4, 0, 33, 17, 0, <span class="stringliteral">"LiteOrg"</span> },
00116       { 4, 0, 37, 17, 0, <span class="stringliteral">"PercOrg2"</span> },
00117       { 7, 0, 0, 18, 0, <span class="stringliteral">"Rock Organ"</span> },
00118       { 4, 0, 64, 18, 0, <span class="stringliteral">"RotaryOr"</span> },
00119       { 4, 0, 65, 18, 0, <span class="stringliteral">"SloRotar"</span> },
00120       { 4, 0, 66, 18, 0, <span class="stringliteral">"FstRotar"</span> },
00121       { 7, 0, 0, 19, 0, <span class="stringliteral">"Church Organ"</span> },
00122       { 4, 0, 32, 19, 0, <span class="stringliteral">"ChurOrg3"</span> },
00123       { 4, 0, 35, 19, 0, <span class="stringliteral">"ChurOrg2"</span> },
00124       { 4, 0, 40, 19, 0, <span class="stringliteral">"NotreDam"</span> },
00125       { 4, 0, 64, 19, 0, <span class="stringliteral">"OrgFlute"</span> },
00126       { 4, 0, 65, 19, 0, <span class="stringliteral">"TrmOrgFl"</span> },
00127       { 7, 0, 0, 20, 0, <span class="stringliteral">"Reed Organ"</span> },
00128       { 4, 0, 40, 20, 0, <span class="stringliteral">"PuffOrg"</span> },
00129       { 7, 0, 0, 21, 0, <span class="stringliteral">"Akkordion"</span> },
00130       { 4, 0, 32, 21, 0, <span class="stringliteral">"Accordlt"</span> },
00131       { 7, 0, 0, 22, 0, <span class="stringliteral">"Harmonica"</span> },
00132       { 4, 0, 32, 22, 0, <span class="stringliteral">"Harmo2"</span> },
00133       { 7, 0, 0, 23, 0, <span class="stringliteral">"Bandoneon"</span> },
00134       { 4, 0, 64, 23, 0, <span class="stringliteral">"TngoAcd2"</span> },
00135 <span class="comment">// Guitar</span>
00136       { 7, 0, 0, 24, 0, <span class="stringliteral">"Nylon Gtr."</span> },
00137       { 4, 0, 16, 24, 0, <span class="stringliteral">"NylonGt2"</span> },
00138       { 4, 0, 25, 24, 0, <span class="stringliteral">"NylonGt3"</span> },
00139       { 4, 0, 43, 24, 0, <span class="stringliteral">"VelGtHrm"</span> },
00140       { 4, 0, 96, 24, 0, <span class="stringliteral">"Ukelele"</span> },
00141       { 7, 0, 0, 25, 0, <span class="stringliteral">"Steel Gtr."</span> },
00142       { 4, 0, 16, 25, 0, <span class="stringliteral">"SteelGt2"</span> },
00143       { 4, 0, 35, 25, 0, <span class="stringliteral">"12StrGtr"</span> },
00144       { 4, 0, 40, 25, 0, <span class="stringliteral">"Nylon-Stl"</span> },
00145       { 4, 0, 41, 25, 0, <span class="stringliteral">"Stl-Body"</span> },
00146       { 4, 0, 96, 25, 0, <span class="stringliteral">"Mandolin"</span> },
00147       { 7, 0, 0, 26, 0, <span class="stringliteral">"Jazz Guitar"</span> },
00148       { 4, 0, 18, 26, 0, <span class="stringliteral">"MelloGtr"</span> },
00149       { 4, 0, 32, 26, 0, <span class="stringliteral">"JazzAmp"</span> },
00150       { 4, 0, 96, 26, 0, <span class="stringliteral">"PdlSteel"</span> },
00151       { 7, 0, 0, 27, 0, <span class="stringliteral">"Clean Guitar"</span> },
00152       { 4, 0, 32, 27, 0, <span class="stringliteral">"ChorusGt"</span> },
00153       { 4, 0, 64, 27, 0, <span class="stringliteral">"CleanGt2"</span> },
00154       { 7, 0, 0, 28, 0, <span class="stringliteral">"Muted Guitar"</span> },
00155       { 4, 0, 40, 28, 0, <span class="stringliteral">"FunkGtr1"</span> },
00156       { 4, 0, 41, 28, 0, <span class="stringliteral">"MuteStlG"</span> },
00157       { 4, 0, 43, 28, 0, <span class="stringliteral">"FunkGtr2"</span> },
00158       { 4, 0, 45, 28, 0, <span class="stringliteral">"JazzMan"</span> },
00159       { 4, 0, 96, 28, 0, <span class="stringliteral">"Mu.DstGt"</span> },
00160       { 7, 0, 0, 29, 0, <span class="stringliteral">"Overdrive Gtr"</span> },
00161       { 4, 0, 43, 29, 0, <span class="stringliteral">"Gt.Pinch"</span> },
00162       { 7, 0, 0, 30, 0, <span class="stringliteral">"DistortionGtr"</span> },
00163       { 4, 0, 12, 30, 0, <span class="stringliteral">"DstRthmG"</span> },
00164       { 4, 0, 24, 30, 0, <span class="stringliteral">"DistGtr2"</span> },
00165       { 4, 0, 35, 30, 0, <span class="stringliteral">"DistGtr3"</span> },
00166       { 4, 0, 36, 30, 0, <span class="stringliteral">"PowerGt2"</span> },
00167       { 4, 0, 37, 30, 0, <span class="stringliteral">"PowerGt1"</span> },
00168       { 4, 0, 38, 30, 0, <span class="stringliteral">"Dst.5ths"</span> },
00169       { 4, 0, 40, 30, 0, <span class="stringliteral">"FeedbkGt"</span> },
00170       { 4, 0, 41, 30, 0, <span class="stringliteral">"FeedbGt2"</span> },
00171       { 4, 0, 43, 30, 0, <span class="stringliteral">"RkRythm2"</span> },
00172       { 4, 0, 45, 30, 0, <span class="stringliteral">"RockRthm"</span> },
00173       { 7, 0, 0, 31, 0, <span class="stringliteral">"Gtr.Harmonics"</span> },
00174       { 4, 0, 65, 31, 0, <span class="stringliteral">"GtFeedbk"</span> },
00175       { 4, 0, 66, 31, 0, <span class="stringliteral">"GtrHrmo2"</span> },
00176       { 4, 0, 64, 31, 0, <span class="stringliteral">"AcoHarmo"</span> },
00177 <span class="comment">// Bass</span>
00178       { 7, 0, 0, 32, 0, <span class="stringliteral">"Acoustic Bass"</span> },
00179       { 4, 0, 40, 32, 0, <span class="stringliteral">"JazzRthm"</span> },
00180       { 4, 0, 45, 32, 0, <span class="stringliteral">"VXUprght"</span> },
00181       { 7, 0, 0, 33, 0, <span class="stringliteral">"Fingered Bass"</span> },
00182       { 4, 0, 18, 33, 0, <span class="stringliteral">"FingrDrk"</span> },
00183       { 4, 0, 27, 33, 0, <span class="stringliteral">"FlangeBa"</span> },
00184       { 4, 0, 40, 33, 0, <span class="stringliteral">"Ba-DstEG"</span> },
00185       { 4, 0, 43, 33, 0, <span class="stringliteral">"FngrSlap"</span> },
00186       { 4, 0, 45, 33, 0, <span class="stringliteral">"FngBass2"</span> },
00187       { 4, 0, 64, 33, 0, <span class="stringliteral">"JazzBass"</span> },
00188       { 4, 0, 65, 33, 0, <span class="stringliteral">"ModAlem"</span> },
00189       { 7, 0, 0, 34, 0, <span class="stringliteral">"Picked Bass"</span> },
00190       { 4, 0, 28, 34, 0, <span class="stringliteral">"MutePkBa"</span> },
00191       { 7, 0, 0, 35, 0, <span class="stringliteral">"Fretless Bass"</span> },
00192       { 4, 0, 32, 35, 0, <span class="stringliteral">"Fretles2"</span> },
00193       { 4, 0, 33, 35, 0, <span class="stringliteral">"Fretles3"</span> },
00194       { 4, 0, 34, 35, 0, <span class="stringliteral">"Fretles4"</span> },
00195       { 4, 0, 96, 35, 0, <span class="stringliteral">"SynFretl"</span> },
00196       { 4, 0, 97, 35, 0, <span class="stringliteral">"Smooth"</span> },
00197       { 7, 0, 0, 36, 0, <span class="stringliteral">"Slap Bass 1"</span> },
00198       { 4, 0, 27, 36, 0, <span class="stringliteral">"ResoSlap"</span> },
00199       { 4, 0, 32, 36, 0, <span class="stringliteral">"PunchThm"</span> },
00200       { 7, 0, 0, 37, 0, <span class="stringliteral">"Slap Bass 2"</span> },
00201       { 4, 0, 43, 37, 0, <span class="stringliteral">"VeloSlap"</span> },
00202       { 7, 0, 0, 38, 0, <span class="stringliteral">"Synth Bass 1"</span> },
00203       { 4, 0, 18, 38, 0, <span class="stringliteral">"SynBa1Dk"</span> },
00204       { 4, 0, 20, 38, 0, <span class="stringliteral">"FastResB"</span> },
00205       { 4, 0, 24, 38, 0, <span class="stringliteral">"AcidBass"</span> },
00206       { 4, 0, 35, 38, 0, <span class="stringliteral">"ClvBass"</span> },
00207       { 4, 0, 40, 38, 0, <span class="stringliteral">"TeknoBa"</span> },
00208       { 4, 0, 64, 38, 0, <span class="stringliteral">"Oscar"</span> },
00209       { 4, 0, 65, 38, 0, <span class="stringliteral">"SqrBass"</span> },
00210       { 4, 0, 66, 38, 0, <span class="stringliteral">"RubberBa"</span> },
00211       { 4, 0, 96, 38, 0, <span class="stringliteral">"Hammer"</span> },
00212       { 7, 0, 0, 39, 0, <span class="stringliteral">"Synth Bass 2"</span> },
00213       { 4, 0, 6, 39, 0, <span class="stringliteral">"MelloSB1"</span> },
00214       { 4, 0, 12, 39, 0, <span class="stringliteral">"SeqBass"</span> },
00215       { 4, 0, 18, 39, 0, <span class="stringliteral">"ClkSynBa"</span> },
00216       { 4, 0, 19, 39, 0, <span class="stringliteral">"SynBa2Dk"</span> },
00217       { 4, 0, 32, 39, 0, <span class="stringliteral">"SmthBa2"</span> },
00218       { 4, 0, 40, 39, 0, <span class="stringliteral">"ModulrBa"</span> },
00219       { 4, 0, 41, 39, 0, <span class="stringliteral">"DXBass"</span> },
00220       { 4, 0, 64, 39, 0, <span class="stringliteral">"XWireBa"</span> },
00221 <span class="comment">// Strings/Orch</span>
00222       { 7, 0, 0, 40, 0, <span class="stringliteral">"Violin"</span> },
00223       { 4, 0, 8, 40, 0, <span class="stringliteral">"SlowVln"</span> },
00224       { 7, 0, 0, 41, 0, <span class="stringliteral">"Viola"</span> },
00225       { 7, 0, 0, 42, 0, <span class="stringliteral">"Cello"</span> },
00226       { 7, 0, 0, 43, 0, <span class="stringliteral">"Contrabass"</span> },
00227       { 7, 0, 0, 44, 0, <span class="stringliteral">"Tremolo Str."</span> },
00228       { 4, 0, 8, 44, 0, <span class="stringliteral">"SlowTrSt"</span> },
00229       { 4, 0, 40, 44, 0, <span class="stringliteral">"SuspStr"</span> },
00230       { 7, 0, 0, 45, 0, <span class="stringliteral">"PizzicatoStr."</span> },
00231       { 7, 0, 0, 46, 0, <span class="stringliteral">"Harp"</span> },
00232       { 4, 0, 40, 46, 0, <span class="stringliteral">"YangChin"</span> },
00233       { 7, 0, 0, 47, 0, <span class="stringliteral">"Timpani"</span> },
00234 <span class="comment">// Ensemble</span>
00235       { 7, 0, 0, 48, 0, <span class="stringliteral">"Strings 1"</span> },
00236       { 4, 0, 3, 48, 0, <span class="stringliteral">"S.Strngs"</span> },
00237       { 4, 0, 8, 48, 0, <span class="stringliteral">"SlowStr"</span> },
00238       { 4, 0, 24, 48, 0, <span class="stringliteral">"ArcoStr"</span> },
00239       { 4, 0, 35, 48, 0, <span class="stringliteral">"60sStrng"</span> },
00240       { 4, 0, 40, 48, 0, <span class="stringliteral">"Orchestr"</span> },
00241       { 4, 0, 41, 48, 0, <span class="stringliteral">"Orchstr2"</span> },
00242       { 4, 0, 42, 48, 0, <span class="stringliteral">"TremOrch"</span> },
00243       { 4, 0, 45, 48, 0, <span class="stringliteral">"VeloStr"</span> },
00244       { 7, 0, 0, 49, 0, <span class="stringliteral">"Strings 2"</span> },
00245       { 4, 0, 3, 49, 0, <span class="stringliteral">"S.SlwStr"</span> },
00246       { 4, 0, 8, 49, 0, <span class="stringliteral">"LegatoSt"</span> },
00247       { 4, 0, 40, 49, 0, <span class="stringliteral">"WarmStr"</span> },
00248       { 4, 0, 41, 49, 0, <span class="stringliteral">"Kingdom"</span> },
00249       { 4, 0, 64, 49, 0, <span class="stringliteral">"70sStr"</span> },
00250       { 4, 0, 65, 49, 0, <span class="stringliteral">"StrEns3"</span> },
00251       { 7, 0, 0, 50, 0, <span class="stringliteral">"Syn.Strings 1"</span> },
00252       { 4, 0, 27, 50, 0, <span class="stringliteral">"ResoStr"</span> },
00253       { 4, 0, 64, 50, 0, <span class="stringliteral">"SynStr4"</span> },
00254       { 4, 0, 65, 50, 0, <span class="stringliteral">"SSStr"</span> },
00255       { 4, 0, 35, 50, 0, <span class="stringliteral">"SynStr3"</span> },
00256       { 7, 0, 0, 51, 0, <span class="stringliteral">"Syn.Strings 2"</span> },
00257       { 7, 0, 0, 52, 0, <span class="stringliteral">"Choir Aahs"</span> },
00258       { 4, 0, 3, 52, 0, <span class="stringliteral">"S.Choir"</span> },
00259       { 4, 0, 16, 52, 0, <span class="stringliteral">"Ch.Aahs2"</span> },
00260       { 4, 0, 32, 52, 0, <span class="stringliteral">"MelChoir"</span> },
00261       { 4, 0, 40, 52, 0, <span class="stringliteral">"ChoirStr"</span> },
00262       { 4, 0, 64, 52, 0, <span class="stringliteral">"StrngAah"</span> },
00263       { 4, 0, 65, 52, 0, <span class="stringliteral">"MaleAah"</span> },
00264       { 7, 0, 0, 53, 0, <span class="stringliteral">"Voice Oohs"</span> },
00265       { 4, 0, 64, 53, 0, <span class="stringliteral">"VoiceDoo"</span> },
00266       { 4, 0, 96, 53, 0, <span class="stringliteral">"VoiceHmn"</span> },
00267       { 7, 0, 0, 54, 0, <span class="stringliteral">"Synth Voice"</span> },
00268       { 4, 0, 40, 54, 0, <span class="stringliteral">"SynVox2"</span> },
00269       { 4, 0, 41, 54, 0, <span class="stringliteral">"Choral"</span> },
00270       { 4, 0, 64, 54, 0, <span class="stringliteral">"AnaVoice"</span> },
00271       { 7, 0, 0, 55, 0, <span class="stringliteral">"Orchestra Hit"</span> },
00272       { 4, 0, 35, 55, 0, <span class="stringliteral">"OrchHit2"</span> },
00273       { 4, 0, 64, 55, 0, <span class="stringliteral">"Impact"</span> },
00274       { 4, 0, 66, 55, 0, <span class="stringliteral">"DoublHit"</span> },
00275       { 4, 0, 67, 55, 0, <span class="stringliteral">"BrStab80"</span> },
00276 <span class="comment">// Brass</span>
00277       { 7, 0, 0, 56, 0, <span class="stringliteral">"Trumpet"</span> },
00278       { 4, 0, 16, 56, 0, <span class="stringliteral">"Trumpet2"</span> },
00279       { 4, 0, 17, 56, 0, <span class="stringliteral">"BriteTrp"</span> },
00280       { 4, 0, 32, 56, 0, <span class="stringliteral">"WarmTrp"</span> },
00281       { 4, 0, 96, 56, 0, <span class="stringliteral">"FluglHrn"</span> },
00282       { 7, 0, 0, 57, 0, <span class="stringliteral">"Trombone"</span> },
00283       { 4, 0, 18, 57, 0, <span class="stringliteral">"Trmbone2"</span> },
00284       { 7, 0, 0, 58, 0, <span class="stringliteral">"Tuba"</span> },
00285       { 4, 0, 16, 58, 0, <span class="stringliteral">"Tuba2"</span> },
00286       { 7, 0, 0, 59, 0, <span class="stringliteral">"Muted Trumpet"</span> },
00287       { 4, 2, 64, 59, 0, <span class="stringliteral">"MuteTrp2"</span> },
00288       { 7, 0, 0, 60, 0, <span class="stringliteral">"French Horn"</span> },
00289       { 4, 0, 6, 60, 0, <span class="stringliteral">"FrHrSolo"</span> },
00290       { 4, 0, 32, 60, 0, <span class="stringliteral">"FrHorn2"</span> },
00291       { 4, 0, 37, 60, 0, <span class="stringliteral">"HornOrch"</span> },
00292       { 7, 0, 0, 61, 0, <span class="stringliteral">"Brass Section"</span> },
00293       { 4, 0, 35, 61, 0, <span class="stringliteral">"Tp-TbSec"</span> },
00294       { 4, 0, 40, 61, 0, <span class="stringliteral">"BrssSec2"</span> },
00295       { 4, 0, 41, 61, 0, <span class="stringliteral">"HiBrass"</span> },
00296       { 4, 0, 42, 61, 0, <span class="stringliteral">"MelloBrs"</span> },
00297       { 4, 0, 14, 61, 0, <span class="stringliteral">"SfrzndBr"</span> },
00298       { 4, 0, 39, 61, 0, <span class="stringliteral">"BrssFall"</span> },
00299       { 7, 0, 0, 62, 0, <span class="stringliteral">"Synth Brass 1"</span> },
00300       { 4, 0, 12, 62, 0, <span class="stringliteral">"QuackBr"</span> },
00301       { 4, 0, 20, 62, 0, <span class="stringliteral">"RezSynBr"</span> },
00302       { 4, 0, 24, 62, 0, <span class="stringliteral">"PolyBrss"</span> },
00303       { 4, 0, 27, 62, 0, <span class="stringliteral">"SynBras3"</span> },
00304       { 4, 0, 32, 62, 0, <span class="stringliteral">"JumpBrss"</span> },
00305       { 4, 0, 45, 62, 0, <span class="stringliteral">"AnaVelBr"</span> },
00306       { 4, 0, 64, 62, 0, <span class="stringliteral">"AnaBrss1"</span> },
00307       { 7, 0, 0, 63, 0, <span class="stringliteral">"Synth Brass 2"</span> },
00308       { 4, 0, 18, 63, 0, <span class="stringliteral">"SoftBrs"</span> },
00309       { 4, 0, 40, 63, 0, <span class="stringliteral">"SynBras4"</span> },
00310       { 4, 0, 41, 63, 0, <span class="stringliteral">"ChoBrss"</span> },
00311       { 4, 0, 45, 63, 0, <span class="stringliteral">"VelBras2"</span> },
00312       { 4, 0, 64, 63, 0, <span class="stringliteral">"AnaBras2"</span> },
00313 <span class="comment">// Reed</span>
00314       { 7, 0, 0, 64, 0, <span class="stringliteral">"Soprano Sax"</span> },
00315       { 7, 0, 0, 65, 0, <span class="stringliteral">"Alto Sax"</span> },
00316       { 4, 0, 40, 65, 0, <span class="stringliteral">"SaxSect"</span> },
00317       { 4, 0, 43, 65, 0, <span class="stringliteral">"HyprAlto"</span> },
00318       { 7, 0, 0, 66, 0, <span class="stringliteral">"Tenor Sax"</span> },
00319       { 4, 0, 40, 66, 0, <span class="stringliteral">"BrthTnSx"</span> },
00320       { 4, 0, 41, 66, 0, <span class="stringliteral">"SoftTenr"</span> },
00321       { 4, 0, 64, 66, 0, <span class="stringliteral">"TnrSax2"</span> },
00322       { 7, 0, 0, 67, 0, <span class="stringliteral">"Baritone Sax"</span> },
00323       { 7, 0, 0, 68, 0, <span class="stringliteral">"Oboe"</span> },
00324       { 7, 0, 0, 69, 0, <span class="stringliteral">"English Horn"</span> },
00325       { 7, 0, 0, 70, 0, <span class="stringliteral">"Bassoon"</span> },
00326       { 7, 0, 0, 71, 0, <span class="stringliteral">"Clarinet"</span> },
00327       { 4, 0, 96, 71, 0, <span class="stringliteral">"BassClar"</span> },
00328 <span class="comment">// Pipe</span>
00329       { 7, 0, 0, 72, 0, <span class="stringliteral">"Piccolo"</span> },
00330       { 7, 0, 0, 73, 0, <span class="stringliteral">"Flute"</span> },
00331       { 7, 0, 0, 74, 0, <span class="stringliteral">"Recorder"</span> },
00332       { 7, 0, 0, 75, 0, <span class="stringliteral">"Pan Flute"</span> },
00333       { 4, 0, 64, 75, 0, <span class="stringliteral">"PanFlut2"</span> },
00334       { 4, 0, 96, 75, 0, <span class="stringliteral">"Kawala"</span> },
00335       { 7, 0, 0, 76, 0, <span class="stringliteral">"Blown Bottle"</span> },
00336       { 7, 0, 0, 77, 0, <span class="stringliteral">"Shakuhachi"</span> },
00337       { 7, 0, 0, 78, 0, <span class="stringliteral">"Whistle"</span> },
00338       { 7, 0, 0, 79, 0, <span class="stringliteral">"Ocarina"</span> },
00339 <span class="comment">// SynthLead</span>
00340       { 7, 0, 0, 80, 0, <span class="stringliteral">"Square Wave"</span> },
00341       { 4, 0, 6, 80, 0, <span class="stringliteral">"Square2"</span> },
00342       { 4, 0, 8, 80, 0, <span class="stringliteral">"LMSquare"</span> },
00343       { 4, 0, 18, 80, 0, <span class="stringliteral">"Hollow"</span> },
00344       { 4, 0, 19, 80, 0, <span class="stringliteral">"Shmoog"</span> },
00345       { 4, 0, 64, 80, 0, <span class="stringliteral">"Mellow"</span> },
00346       { 4, 0, 65, 80, 0, <span class="stringliteral">"SoloSine"</span> },
00347       { 4, 0, 66, 80, 0, <span class="stringliteral">"SineLead"</span> },
00348       { 7, 0, 0, 81, 0, <span class="stringliteral">"Saw Wave"</span> },
00349       { 4, 0, 6, 81, 0, <span class="stringliteral">"Saw2"</span> },
00350       { 4, 0, 8, 81, 0, <span class="stringliteral">"ThickSaw"</span> },
00351       { 4, 0, 18, 81, 0, <span class="stringliteral">"DynaSaw"</span> },
00352       { 4, 0, 19, 81, 0, <span class="stringliteral">"DigiSaw"</span> },
00353       { 4, 0, 20, 81, 0, <span class="stringliteral">"BigLead"</span> },
00354       { 4, 0, 24, 81, 0, <span class="stringliteral">"HeavySyn"</span> },
00355       { 4, 0, 25, 81, 0, <span class="stringliteral">"WaspySyn"</span> },
00356       { 4, 0, 40, 81, 0, <span class="stringliteral">"PulseSaw"</span> },
00357       { 4, 0, 41, 81, 0, <span class="stringliteral">"Dr.Lead"</span> },
00358       { 4, 0, 45, 81, 0, <span class="stringliteral">"VeloLead"</span> },
00359       { 4, 0, 96, 81, 0, <span class="stringliteral">"SeqAna"</span> },
00360       { 7, 0, 0, 82, 0, <span class="stringliteral">"Calliope"</span> },
00361       { 4, 0, 65, 82, 0, <span class="stringliteral">"PurePad"</span> },
00362       { 4, 0, 64, 82, 0, <span class="stringliteral">"VentSyn"</span> },
00363       { 7, 0, 0, 83, 0, <span class="stringliteral">"Chiffer Lead"</span> },
00364       { 4, 0, 64, 83, 0, <span class="stringliteral">"Rubby"</span> },
00365       { 7, 0, 0, 84, 0, <span class="stringliteral">"Charang"</span> },
00366       { 4, 0, 64, 84, 0, <span class="stringliteral">"DistLead"</span> },
00367       { 4, 0, 65, 84, 0, <span class="stringliteral">"WireLead"</span> },
00368       { 7, 0, 0, 85, 0, <span class="stringliteral">"Solo Vox"</span> },
00369       { 4, 0, 24, 85, 0, <span class="stringliteral">"SynthAah"</span> },
00370       { 4, 0, 64, 85, 0, <span class="stringliteral">"VoxLead"</span> },
00371       { 7, 0, 0, 86, 0, <span class="stringliteral">"Fifth Saw"</span> },
00372       { 4, 0, 35, 86, 0, <span class="stringliteral">"BigFive"</span> },
00373       { 7, 0, 0, 87, 0, <span class="stringliteral">"Bass Lead"</span> },
00374       { 4, 0, 16, 87, 0, <span class="stringliteral">"Big-Low"</span> },
00375       { 4, 0, 64, 87, 0, <span class="stringliteral">"Fat-Prky"</span> },
00376       { 4, 0, 65, 87, 0, <span class="stringliteral">"SoftWurl"</span> },
00377 <span class="comment">// Synth Pad</span>
00378       { 7, 0, 0, 88, 0, <span class="stringliteral">"New Age Pad"</span> },
00379       { 4, 0, 64, 88, 0, <span class="stringliteral">"Fantasy2"</span> },
00380       { 7, 0, 0, 89, 0, <span class="stringliteral">"Warm Pad"</span> },
00381       { 4, 0, 16, 89, 0, <span class="stringliteral">"ThickPad"</span> },
00382       { 4, 0, 17, 89, 0, <span class="stringliteral">"SoftPad"</span> },
00383       { 4, 0, 18, 89, 0, <span class="stringliteral">"SinePad"</span> },
00384       { 4, 0, 64, 89, 0, <span class="stringliteral">"HornPad"</span> },
00385       { 4, 0, 65, 89, 0, <span class="stringliteral">"RotarStr"</span> },
00386       { 7, 0, 0, 90, 0, <span class="stringliteral">"Polysynth Pad"</span> },
00387       { 4, 0, 64, 90, 0, <span class="stringliteral">"PolyPd80"</span> },
00388       { 4, 0, 65, 90, 0, <span class="stringliteral">"ClickPad"</span> },
00389       { 4, 0, 66, 90, 0, <span class="stringliteral">"AnaPad"</span> },
00390       { 4, 0, 67, 90, 0, <span class="stringliteral">"SquarPad"</span> },
00391       { 7, 0, 0, 91, 0, <span class="stringliteral">"Choir Pad"</span> },
00392       { 4, 0, 64, 91, 0, <span class="stringliteral">"Heaven2"</span> },
00393       { 4, 0, 66, 91, 0, <span class="stringliteral">"Itopia"</span> },
00394       { 4, 0, 67, 91, 0, <span class="stringliteral">"CCPad"</span> },
00395       { 4, 0, 65, 91, 0, <span class="stringliteral">"LitePad"</span> },
00396       { 7, 0, 0, 92, 0, <span class="stringliteral">"Bowed Pad"</span> },
00397       { 4, 0, 64, 92, 0, <span class="stringliteral">"Glacier"</span> },
00398       { 4, 0, 65, 92, 0, <span class="stringliteral">"GlassPad"</span> },
00399       { 7, 0, 0, 93, 0, <span class="stringliteral">"Metallic Pad"</span> },
00400       { 4, 0, 64, 93, 0, <span class="stringliteral">"TinePad"</span> },
00401       { 4, 0, 65, 93, 0, <span class="stringliteral">"PanPad"</span> },
00402       { 7, 0, 0, 94, 0, <span class="stringliteral">"Halo Pad"</span> },
00403       { 7, 0, 0, 95, 0, <span class="stringliteral">"Sweep Pad"</span> },
00404       { 4, 0, 20, 95, 0, <span class="stringliteral">"Shwimmer"</span> },
00405       { 4, 0, 27, 95, 0, <span class="stringliteral">"Converge"</span> },
00406       { 4, 0, 64, 95, 0, <span class="stringliteral">"PolarPad"</span> },
00407       { 4, 0, 66, 95, 0, <span class="stringliteral">"Celstial"</span> },
00408       { 4, 0, 65, 95, 0, <span class="stringliteral">"Sweepy"</span> },
00409 <span class="comment">// Synth FX</span>
00410       { 7, 0, 0, 96, 0, <span class="stringliteral">"Rain"</span> },
00411       { 4, 0, 45, 96, 0, <span class="stringliteral">"ClaviPad"</span> },
00412       { 4, 0, 64, 96, 0, <span class="stringliteral">"HrmoRain"</span> },
00413       { 4, 0, 65, 96, 0, <span class="stringliteral">"AfrcnWnd"</span> },
00414       { 4, 0, 66, 96, 0, <span class="stringliteral">"Caribean"</span> },
00415       { 7, 0, 0, 97, 0, <span class="stringliteral">"Soundtrack"</span> },
00416       { 4, 0, 27, 97, 0, <span class="stringliteral">"Prologue"</span> },
00417       { 4, 0, 64, 97, 0, <span class="stringliteral">"Ancestrl"</span> },
00418       { 4, 0, 65, 97, 0, <span class="stringliteral">"Rave"</span> },
00419       { 7, 0, 0, 98, 0, <span class="stringliteral">"Crystal"</span> },
00420       { 4, 0, 12, 98, 0, <span class="stringliteral">"SynDrCmp"</span> },
00421       { 4, 0, 14, 98, 0, <span class="stringliteral">"Popcorn"</span> },
00422       { 4, 0, 18, 98, 0, <span class="stringliteral">"TinyBell"</span> },
00423       { 4, 0, 35, 98, 0, <span class="stringliteral">"RndGlock"</span> },
00424       { 4, 0, 40, 98, 0, <span class="stringliteral">"GlockChi"</span> },
00425       { 4, 0, 41, 98, 0, <span class="stringliteral">"ClearBel"</span> },
00426       { 4, 0, 42, 98, 0, <span class="stringliteral">"ChorBell"</span> },
00427       { 4, 0, 64, 98, 0, <span class="stringliteral">"SynMalet"</span> },
00428       { 4, 0, 65, 98, 0, <span class="stringliteral">"SftCryst"</span> },
00429       { 4, 0, 66, 98, 0, <span class="stringliteral">"LoudGlok"</span> },
00430       { 4, 0, 67, 98, 0, <span class="stringliteral">"XmasBell"</span> },
00431       { 4, 0, 68, 98, 0, <span class="stringliteral">"VibeBell"</span> },
00432       { 4, 0, 69, 98, 0, <span class="stringliteral">"DigiBell"</span> },
00433       { 4, 0, 70, 98, 0, <span class="stringliteral">"AirBells"</span> },
00434       { 4, 0, 71, 98, 0, <span class="stringliteral">"BellHarp"</span> },
00435       { 4, 0, 72, 98, 0, <span class="stringliteral">"Gamelmba"</span> },
00436       { 7, 0, 0, 99, 0, <span class="stringliteral">"Athmosphere"</span> },
00437       { 4, 0, 18, 99, 0, <span class="stringliteral">"WarmAtms"</span> },
00438       { 4, 0, 19, 99, 0, <span class="stringliteral">"HollwRls"</span> },
00439       { 4, 0, 40, 99, 0, <span class="stringliteral">"NylonEP"</span> },
00440       { 4, 0, 64, 99, 0, <span class="stringliteral">"NylnHarp"</span> },
00441       { 4, 0, 65, 99, 0, <span class="stringliteral">"HarpVox"</span> },
00442       { 7, 0, 0, 100, 0, <span class="stringliteral">"Brightness"</span> },
00443       { 7, 0, 0, 101, 0, <span class="stringliteral">"Goblins"</span> },
00444       { 4, 0, 69, 101, 0, <span class="stringliteral">"MilkyWay"</span> },
00445       { 4, 0, 72, 101, 0, <span class="stringliteral">"Puffy"</span> },
00446       { 7, 0, 0, 102, 0, <span class="stringliteral">"Echoes"</span> },
00447       { 7, 0, 0, 103, 0, <span class="stringliteral">"Sci-Fi"</span> },
00448       { 4, 0, 65, 103, 0, <span class="stringliteral">"Odyssey"</span> },
00449 <span class="comment">// Ethnic</span>
00450       { 7, 0, 0, 104, 0, <span class="stringliteral">"Sitar"</span> },
00451       { 4, 0, 32, 104, 0, <span class="stringliteral">"DetSitar"</span> },
00452       { 4, 0, 35, 104, 0, <span class="stringliteral">"Sitar2"</span> },
00453       { 4, 0, 96, 104, 0, <span class="stringliteral">"Tambra"</span> },
00454       { 4, 0, 97, 104, 0, <span class="stringliteral">"Tamboura"</span> },
00455       { 7, 0, 0, 105, 0, <span class="stringliteral">"Banjo"</span> },
00456       { 4, 0, 28, 105, 0, <span class="stringliteral">"MuteBnjo"</span> },
00457       { 4, 0, 96, 105, 0, <span class="stringliteral">"Rabab"</span> },
00458       { 4, 0, 97, 105, 0, <span class="stringliteral">"Gopichnt"</span> },
00459       { 4, 0, 98, 105, 0, <span class="stringliteral">"Oud"</span> },
00460       { 7, 0, 0, 106, 0, <span class="stringliteral">"Shamisen"</span> },
00461       { 4, 0, 96, 106, 0, <span class="stringliteral">"Tsugaru"</span> },
00462       { 7, 0, 0, 107, 0, <span class="stringliteral">"Koto"</span> },
00463       { 4, 0, 96, 107, 0, <span class="stringliteral">"T.Koto"</span> },
00464       { 4, 0, 97, 107, 0, <span class="stringliteral">"Kanoon"</span> },
00465       { 7, 0, 0, 108, 0, <span class="stringliteral">"Kalimba"</span> },
00466       { 4, 0, 64, 108, 0, <span class="stringliteral">"BigKalim"</span> },
00467       { 7, 0, 0, 109, 0, <span class="stringliteral">"Bagpipe"</span> },
00468       { 7, 0, 0, 110, 0, <span class="stringliteral">"Fiddle"</span> },
00469       { 7, 0, 0, 111, 0, <span class="stringliteral">"Shanai"</span> },
00470       { 4, 0, 64, 111, 0, <span class="stringliteral">"Shanai2"</span> },
00471       { 4, 0, 96, 111, 0, <span class="stringliteral">"Pungi"</span> },
00472       { 4, 0, 97, 111, 0, <span class="stringliteral">"Hichriki"</span> },
00473 <span class="comment">// Percussive</span>
00474       { 7, 0, 0, 112, 0, <span class="stringliteral">"Tinkle Bell"</span> },
00475       { 4, 0, 96, 112, 0, <span class="stringliteral">"Bonang"</span> },
00476       { 4, 0, 97, 112, 0, <span class="stringliteral">"Gender"</span> },
00477       { 4, 0, 98, 112, 0, <span class="stringliteral">"Gamelan"</span> },
00478       { 4, 0, 99, 112, 0, <span class="stringliteral">"S.Gamlan"</span> },
00479       { 4, 0, 100, 112, 0, <span class="stringliteral">"RamaCym"</span> },
00480       { 4, 0, 101, 112, 0, <span class="stringliteral">"AsianBel"</span> },
00481       { 7, 0, 0, 113, 0, <span class="stringliteral">"Agogo"</span> },
00482       { 4, 0, 96, 113, 0, <span class="stringliteral">"Atrigane"</span> },
00483       { 7, 0, 0, 114, 0, <span class="stringliteral">"Steel Drums"</span> },
00484       { 4, 0, 97, 114, 0, <span class="stringliteral">"GlasPerc"</span> },
00485       { 4, 0, 98, 114, 0, <span class="stringliteral">"ThaiBell"</span> },
00486       { 4, 0, 96, 114, 0, <span class="stringliteral">"Tablas"</span> },
00487       { 7, 0, 0, 115, 0, <span class="stringliteral">"Woodblock"</span> },
00488       { 4, 0, 96, 115, 0, <span class="stringliteral">"Castanet"</span> },
00489       { 7, 0, 0, 116, 0, <span class="stringliteral">"Taiko Drum"</span> },
00490       { 4, 0, 96, 116, 0, <span class="stringliteral">"Gr.Cassa"</span> },
00491       { 7, 0, 0, 117, 0, <span class="stringliteral">"Melodic Drum"</span> },
00492       { 4, 0, 64, 117, 0, <span class="stringliteral">"MelTom2"</span> },
00493       { 4, 0, 65, 117, 0, <span class="stringliteral">"RealTom"</span> },
00494       { 4, 0, 66, 117, 0, <span class="stringliteral">"RockTom"</span> },
00495       { 7, 0, 0, 118, 0, <span class="stringliteral">"Synth Drum"</span> },
00496       { 4, 0, 64, 118, 0, <span class="stringliteral">"AnaTom"</span> },
00497       { 4, 0, 65, 118, 0, <span class="stringliteral">"ElecPerc"</span> },
00498       { 7, 0, 0, 119, 0, <span class="stringliteral">"Rev. Cymbal"</span> },
00499       { 4, 0, 64, 119, 0, <span class="stringliteral">"RevCym2"</span> },
00500       { 4, 0, 96, 119, 0, <span class="stringliteral">"RevSnar1"</span> },
00501       { 4, 0, 97, 119, 0, <span class="stringliteral">"RevSnar2"</span> },
00502       { 4, 0, 98, 119, 0, <span class="stringliteral">"RevKick1"</span> },
00503       { 4, 0, 99, 119, 0, <span class="stringliteral">"RevConBD"</span> },
00504       { 4, 0, 100, 119, 0, <span class="stringliteral">"RevTom1"</span> },
00505       { 4, 0, 101, 119, 0, <span class="stringliteral">"RevTom2"</span> },
00506 <span class="comment">// Special FX</span>
00507       { 7,  0, 0, 120, 0, <span class="stringliteral">"GtrFret Noise"</span> },
00508       { 7,  0, 0, 121, 0, <span class="stringliteral">"Breath Noise"</span> },
00509       { 7,  0, 0, 122, 0, <span class="stringliteral">"Seashore"</span> },
00510       { 7,  0, 0, 123, 0, <span class="stringliteral">"Bird Tweed"</span> },
00511       { 7,  0, 0, 124, 0, <span class="stringliteral">"Telephone"</span> },
00512       { 7,  0, 0, 125, 0, <span class="stringliteral">"Helicopter"</span> },
00513       { 7,  0, 0, 126, 0, <span class="stringliteral">"Applaus"</span> },
00514       { 7,  0, 0, 127, 0, <span class="stringliteral">"Gunshot"</span> },
00515 <span class="comment">// Drums</span>
00516       { 6, 17, 0,   0, 0, <span class="stringliteral">"Standard"</span> },
00517       { 4, 17, 0,   1, 0, <span class="stringliteral">"Standrd2"</span> },
00518       { 6, 17, 0,   8, 0, <span class="stringliteral">"Room"</span> },
00519       { 4, 17, 0,  16, 0, <span class="stringliteral">"Rock"</span> },
00520       { 6, 17, 0,  24, 0, <span class="stringliteral">"Electro"</span> },
00521       { 6, 17, 0,  25, 0, <span class="stringliteral">"Analog"</span> },
00522       { 6, 17, 0,  32, 0, <span class="stringliteral">"Jazz"</span> },
00523       { 6, 17, 0,  40, 0, <span class="stringliteral">"Brush"</span> },
00524       { 6, 17, 0,  48, 0, <span class="stringliteral">"Classic"</span> },
00525       { 2, 17, 0,  16, 0, <span class="stringliteral">"Power"</span> },
00526       { 2, 17, 0,  56, 0, <span class="stringliteral">"SFX1"</span> },
00527       { 2, 17, 0, 127, 0, <span class="stringliteral">"GM"</span> },
00528       { 4, 16, 0,   0, 0, <span class="stringliteral">"SFX1"</span> },
00529       { 4, 16, 0,   1, 0, <span class="stringliteral">"SFX2"</span> },
00530       { 4,  4, 0,   0, 0, <span class="stringliteral">"CuttngNz"</span> },
00531       { 4,  4, 0,   1, 0, <span class="stringliteral">"CuttngNz2"</span> },
00532       { 4,  4, 0,   3, 0, <span class="stringliteral">"StrSlap"</span> },
00533       { 4,  4, 0,  16, 0, <span class="stringliteral">"Fl.KClik"</span> },
00534       { 4,  4, 0,  32, 0, <span class="stringliteral">"Rain"</span> },
00535       { 4,  4, 0,  33, 0, <span class="stringliteral">"Thunder"</span> },
00536       { 4,  4, 0,  34, 0, <span class="stringliteral">"Wind"</span> },
00537       { 4,  4, 0,  35, 0, <span class="stringliteral">"Stream"</span> },
00538       { 4,  4, 0,  36, 0, <span class="stringliteral">"Bubble"</span> },
00539       { 4,  4, 0,  37, 0, <span class="stringliteral">"Feed"</span> },
00540       { 4,  4, 0,  48, 0, <span class="stringliteral">"Dog"</span> },
00541       { 4,  4, 0,  49, 0, <span class="stringliteral">"Horse"</span> },
00542       { 4,  4, 0,  50, 0, <span class="stringliteral">"Bird2"</span> },
00543       { 4,  4, 0,  54, 0, <span class="stringliteral">"Ghost"</span> },
00544       { 4,  4, 0,  55, 0, <span class="stringliteral">"Maou"</span> },
00545       { 4,  4, 0,  64, 0, <span class="stringliteral">"Tel.Dial"</span> },
00546       { 4,  4, 0,  65, 0, <span class="stringliteral">"DoorSqek"</span> },
00547       { 4,  4, 0,  66, 0, <span class="stringliteral">"DoorSlam"</span> },
00548       { 4,  4, 0,  67, 0, <span class="stringliteral">"Scratch"</span> },
00549       { 4,  4, 0,  68, 0, <span class="stringliteral">"Scratch2"</span> },
00550       { 4,  4, 0,  69, 0, <span class="stringliteral">"WindChm"</span> },
00551       { 4,  4, 0,  70, 0, <span class="stringliteral">"Telphon2"</span> },
00552       { 4,  4, 0,  80, 0, <span class="stringliteral">"CarEngin"</span> },
00553       { 4,  4, 0,  81, 0, <span class="stringliteral">"CarStop"</span> },
00554       { 4,  4, 0,  82, 0, <span class="stringliteral">"CarPass"</span> },
00555       { 4,  4, 0,  83, 0, <span class="stringliteral">"CarCrash"</span> },
00556       { 4,  4, 0,  84, 0, <span class="stringliteral">"Siren"</span> },
00557       { 4,  4, 0,  85, 0, <span class="stringliteral">"Train"</span> },
00558       { 4,  4, 0,  86, 0, <span class="stringliteral">"Jetplane"</span> },
00559       { 4,  4, 0,  87, 0, <span class="stringliteral">"Starship"</span> },
00560       { 4,  4, 0,  88, 0, <span class="stringliteral">"Burst"</span> },
00561       { 4,  4, 0,  89, 0, <span class="stringliteral">"Coaster"</span> },
00562       { 4,  4, 0,  90, 0, <span class="stringliteral">"SbMarine"</span> },
00563       { 4,  4, 0,  96, 0, <span class="stringliteral">"Laughing"</span> },
00564       { 4,  4, 0,  97, 0, <span class="stringliteral">"Scream"</span> },
00565       { 4,  4, 0,  98, 0, <span class="stringliteral">"Punch"</span> },
00566       { 4,  4, 0,  99, 0, <span class="stringliteral">"Heart"</span> },
00567       { 4,  4, 0, 100, 0, <span class="stringliteral">"FootStep"</span> },
00568       { 4,  4, 0, 112, 0, <span class="stringliteral">"MchinGun"</span> },
00569       { 4,  4, 0, 113, 0, <span class="stringliteral">"LaserGun"</span> },
00570       { 4,  4, 0, 114, 0, <span class="stringliteral">"Xplosion"</span> },
00571       { 4,  4, 0, 115, 0, <span class="stringliteral">"FireWork"</span> },
00572       { 4,  4, 0,   2, 0, <span class="stringliteral">"DstCutNz"</span> },
00573       { 4,  4, 0,   4, 0, <span class="stringliteral">"B.Slide"</span> },
00574       { 4,  4, 0,   5, 0, <span class="stringliteral">"P.Scrape"</span> },
00575       { 4,  4, 0,  51, 0, <span class="stringliteral">"Kitty"</span> },
00576       { 4,  4, 0,  52, 0, <span class="stringliteral">"Growl"</span> },
00577       { 4,  4, 0,  53, 0, <span class="stringliteral">"Haunted"</span> },
00578       { 4,  4, 0, 101, 0, <span class="stringliteral">"Applaus2"</span> },
00579       };
00580 
00581 <span class="comment">//---------------------------------------------------------</span>
00582 <span class="comment">//   exportMidi</span>
00583 <span class="comment">//---------------------------------------------------------</span>
00584 
<a name="l00585"></a><a class="code" href="classExportMidi.html">00585</a> <span class="keyword">class </span><a class="code" href="classExportMidi.html">ExportMidi</a> : <span class="keyword">public</span> <a class="code" href="classSaveFile.html">SaveFile</a> {
00586    <span class="keyword">public</span>:
<a name="l00587"></a><a class="code" href="classExportMidi.html#o0">00587</a>       <a class="code" href="classMidiFile.html">MidiFile</a> <a class="code" href="classExportMidi.html#o0">mf</a>;
00588       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classExportMidi.html#a0">saver</a>();
00589       };
00590 
00591 <span class="comment">//---------------------------------------------------------</span>
00592 <span class="comment">//   exportMidi</span>
00593 <span class="comment">//---------------------------------------------------------</span>
00594 
<a name="l00595"></a><a class="code" href="classMuseScore.html#k20">00595</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k20">MuseScore::exportMidi</a>()
00596       {
00597       <a class="code" href="classExportMidi.html">ExportMidi</a> em;
00598       em.<a class="code" href="classSaveFile.html#a3">save</a>(<span class="keyword">this</span>, QString(<span class="stringliteral">"."</span>), QString(<span class="stringliteral">".mid"</span>), tr(<span class="stringliteral">"MuseScore: Export as Midi (SMF)"</span>));
00599       }
00600 
00601 <span class="comment">//---------------------------------------------------------</span>
00602 <span class="comment">//  saver</span>
00603 <span class="comment">//    export midi file</span>
00604 <span class="comment">//    return true on error</span>
00605 <span class="comment">//---------------------------------------------------------</span>
00606 
<a name="l00607"></a><a class="code" href="classExportMidi.html#a0">00607</a> <span class="keywordtype">bool</span> <a class="code" href="classExportMidi.html#a0">ExportMidi::saver</a>()
00608       {
00609 <span class="preprocessor">#if 0 // TODO</span>
00610 <span class="preprocessor"></span>      <a class="code" href="classExportMidi.html#o0">mf</a>.<a class="code" href="classMidiFile.html#a1">setFp</a>(f);
00611       <a class="code" href="midi_8h.html#a10">MidiTrackList</a>* tracks = <a class="code" href="classExportMidi.html#o0">mf</a>.<a class="code" href="classMidiFile.html#a4">tracks</a>();
00612       <span class="keywordtype">int</span> staves = cs-&gt;nstaves();
00613       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> tr = 0; tr &lt; staves; ++tr) {
00614             <a class="code" href="classMidiTrack.html">MidiTrack</a>* track = <span class="keyword">new</span> <a class="code" href="classMidiTrack.html">MidiTrack</a>;
00615             tracks-&gt;push_back(track);
00616             <a class="code" href="midi_8h.html#a5">EventList</a>* events = track-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
00617             <a class="code" href="classStaff.html">Staff</a>* staff  = cs-&gt;staff(tr);
00618             <span class="keywordtype">int</span> channel = staff-&gt;<a class="code" href="classStaff.html#a9">midiChannel</a>();
00619             track-&gt;<a class="code" href="classMidiTrack.html#a7">setOutPort</a>(0);
00620             track-&gt;<a class="code" href="classMidiTrack.html#a5">setOutChannel</a>(channel);
00621             <span class="keywordflow">if</span> (tr == 0) {
00622                   <a class="code" href="classMeasure.html">Measure</a>* measure = cs-&gt;first();
00623                   <a class="code" href="classElementList.html">ElementList</a>* el  = measure-&gt;<a class="code" href="classMeasure.html#a13">pel</a>();
00624                   <span class="keywordflow">for</span> (<a class="code" href="element_8h.html#a1">iElement</a> ie = el-&gt;<a class="code" href="classpstl_1_1plist.html#a3">begin</a>(); ie != el-&gt;<a class="code" href="classpstl_1_1plist.html#a4">end</a>(); ++ie) {
00625                         <span class="keywordflow">if</span> ((*ie)-&gt;type() == <a class="code" href="element_8h.html#a65a8">TEXT</a>) {
00626                               <a class="code" href="classSText.html">SText</a>* text = (<a class="code" href="classSText.html">SText</a>*)(*ie);
00627                               <span class="keyword">const</span> <span class="keywordtype">char</span>* txt = text-&gt;<a class="code" href="classSText.html#a11">text</a>().latin1();
00628                               <span class="keywordtype">int</span> len = strlen(txt) + 1;
00629                               <span class="keywordflow">switch</span> (text-&gt;<a class="code" href="classSText.html#a13">style</a>()) {
00630                                     <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a21">TEXT_STYLE_TITLE</a>:
00631                                           {
00632                                           <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00633                                           ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00634                                           ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a35">META_TITLE</a>;
00635                                           ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>       = len;
00636                                           ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>      = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[len];
00637                                           strcpy((<span class="keywordtype">char</span>*)(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>), txt);
00638                                           events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (0, ev));
00639                                           }
00640                                           <span class="keywordflow">break</span>;
00641                                     <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a22">TEXT_STYLE_SUBTITLE</a>:
00642                                           {
00643                                           <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00644                                           ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00645                                           ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a36">META_SUBTITLE</a>;
00646                                           ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>       = len;
00647                                           ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>      = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[len];
00648                                           strcpy((<span class="keywordtype">char</span>*)(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>), txt);
00649                                           events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (0, ev));
00650                                           }
00651                                           <span class="keywordflow">break</span>;
00652                                     <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a23">TEXT_STYLE_COMPOSER</a>:
00653                                           {
00654                                           <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00655                                           ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00656                                           ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a37">META_COMPOSER</a>;
00657                                           ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>       = len;
00658                                           ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>      = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[len];
00659                                           strcpy((<span class="keywordtype">char</span>*)(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>), txt);
00660                                           events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (0, ev));
00661                                           }
00662                                           <span class="keywordflow">break</span>;
00663                                     <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a37">TEXT_STYLE_TRANSLATOR</a>:
00664                                           {
00665                                           <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00666                                           ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00667                                           ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a38">META_TRANSLATOR</a>;
00668                                           ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>       = len;
00669                                           ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>      = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[len];
00670                                           strcpy((<span class="keywordtype">char</span>*)(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>), txt);
00671                                           events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (0, ev));
00672                                           }
00673                                           <span class="keywordflow">break</span>;
00674                                     <span class="keywordflow">case</span> <a class="code" href="style_8h.html#a45a24">TEXT_STYLE_POET</a>:
00675                                           {
00676                                           <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00677                                           ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00678                                           ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a39">META_POET</a>;
00679                                           ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>       = len;
00680                                           ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>      = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[len];
00681                                           strcpy((<span class="keywordtype">char</span>*)(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>), txt);
00682                                           events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (0, ev));
00683                                           }
00684                                           <span class="keywordflow">break</span>;
00685                                     }
00686                               }
00687                         }
00688 
00689                   <span class="comment">//--------------------------------------------</span>
00690                   <span class="comment">//    write time signature</span>
00691                   <span class="comment">//--------------------------------------------</span>
00692 
00693                   <a class="code" href="classSigList.html">SigList</a>* sigmap = cs-&gt;sigmap;
00694                   <span class="keywordflow">for</span> (<a class="code" href="sig_8h.html#a0">iSigEvent</a> is = sigmap-&gt;begin(); is != sigmap-&gt;end(); ++is) {
00695                         <a class="code" href="structSigEvent.html">SigEvent</a> se = is-&gt;second;
00696                         <span class="keywordtype">int</span> tick = is-&gt;first;
00697                         <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00698                         ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00699                         ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a44">META_TIME_SIGNATURE</a>;
00700                         ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>  = 4;
00701                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[4];
00702                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[0] = se.<a class="code" href="structSigEvent.html#o2">z</a>;
00703                         <span class="keywordtype">int</span> n;
00704                         <span class="keywordflow">switch</span>(se.<a class="code" href="structSigEvent.html#o3">n</a>) {
00705                               <span class="keywordflow">case</span> 1: n = 0; <span class="keywordflow">break</span>;
00706                               <span class="keywordflow">case</span> 2: n = 1; <span class="keywordflow">break</span>;
00707                               <span class="keywordflow">case</span> 4: n = 2; <span class="keywordflow">break</span>;
00708                               <span class="keywordflow">case</span> 8: n = 3; <span class="keywordflow">break</span>;
00709                               <span class="keywordflow">case</span> 16: n = 4; <span class="keywordflow">break</span>;
00710                               <span class="keywordflow">case</span> 32: n = 5; <span class="keywordflow">break</span>;
00711                               <span class="keywordflow">default</span>:
00712                                     n = 2;
00713                                     printf(<span class="stringliteral">"ExportMidi: unknown time signature %d/%d\n"</span>, se.<a class="code" href="structSigEvent.html#o2">z</a>, n);
00714                                     <span class="keywordflow">break</span>;
00715                               }
00716                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[1] = n;
00717                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[2] = 24;
00718                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[3] = 8;
00719                         events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (tick, ev));
00720                         }
00721 
00722                   <span class="comment">//--------------------------------------------</span>
00723                   <span class="comment">//    write key signatures</span>
00724                   <span class="comment">//--------------------------------------------</span>
00725 
00726                   <a class="code" href="classKeyList.html">KeyList</a>* keymap = cs-&gt;keymap;
00727                   <span class="keywordflow">for</span> (<a class="code" href="key_8h.html#a0">iKeyEvent</a> ik = keymap-&gt;begin(); ik != keymap-&gt;end(); ++ik) {
00728                         <span class="keywordtype">int</span> tick      = ik-&gt;first;
00729                         <span class="keywordtype">int</span> key       = ik-&gt;second;
00730                         <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00731                         ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00732                         ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a45">META_KEY_SIGNATURE</a>;
00733                         ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>       = 2;
00734                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>      = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[2];
00735                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[0]   = key;
00736                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[1]   = 0;  <span class="comment">// major</span>
00737                         events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (tick, ev));
00738                         }
00739 
00740                   <span class="comment">//--------------------------------------------</span>
00741                   <span class="comment">//    write tempo changes</span>
00742                   <span class="comment">//--------------------------------------------</span>
00743 
00744                   <a class="code" href="classTempoList.html">TempoList</a>* <a class="code" href="tempo_8h.html#a5">tempomap</a> = cs-&gt;tempomap;
00745                   <span class="keywordflow">for</span> (<a class="code" href="classpstl_1_1ipmap.html">iTEvent</a> it = <a class="code" href="tempo_8h.html#a5">tempomap</a>-&gt;<a class="code" href="classpstl_1_1ipmap.html#a1">begin</a>(); it != <a class="code" href="tempo_8h.html#a5">tempomap</a>-&gt;<a class="code" href="classpstl_1_1ipmap.html#a2">end</a>(); ++it) {
00746                         <span class="keywordtype">int</span> tick      = it-&gt;second-&gt;tick;
00747                         <span class="keywordtype">int</span> tempo     = it-&gt;second-&gt;tempo;
00748                         <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00749                         ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
00750                         ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = <a class="code" href="midi_8h.html#a51a43">META_TEMPO</a>;
00751                         ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>       = 3;
00752                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>      = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[3];
00753                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[0]   = tempo &gt;&gt; 16;
00754                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[1]   = tempo &gt;&gt; 8;
00755                         ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>[2]   = tempo;
00756                         events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (tick, ev));
00757                         }
00758 
00759                   }
00760             <span class="keywordtype">int</span> gateTime = 80;  <span class="comment">// 100 - legato (100%)</span>
00761             <span class="keywordflow">for</span> (<a class="code" href="classMeasure.html">Measure</a>* m = cs-&gt;first(); m; m = m-&gt;<a class="code" href="classMeasure.html#a64">next</a>()) {
00762                   <span class="keywordflow">if</span> (m == cs-&gt;<a class="code" href="classMeasure.html#a28">first</a>()) {
00763                         <span class="keywordtype">int</span> program   = staff-&gt;<a class="code" href="classStaff.html#a10">midiProgram</a>();
00764                         <span class="keywordflow">if</span> (program != -1) {
00765                               <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00766                               ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>      = <a class="code" href="midi_8h.html#a50a17">ME_PROGRAM</a>;
00767                               ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>     = program;
00768                               events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (0, ev));
00769                               }
00770                         }
00771                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> voice = 0; voice &lt; <a class="code" href="globals_8h.html#a3">VOICES</a>; ++voice) {
00772                         <span class="keywordflow">for</span> (<a class="code" href="classSegment.html">Segment</a>* seg = m-&gt;<a class="code" href="classMeasure.html#a28">first</a>(); seg; seg = seg-&gt;<a class="code" href="classSegment.html#a4">next</a>()) {
00773                               <a class="code" href="classElement.html">Element</a>* el = seg-&gt;<a class="code" href="classSegment.html#a8">element</a>(tr * <a class="code" href="globals_8h.html#a3">VOICES</a> + voice);
00774                               <span class="keywordflow">if</span> (el) {
00775                                     <span class="keywordflow">if</span> (el-&gt;<a class="code" href="classElement.html#a40">type</a>() != <a class="code" href="element_8h.html#a65a25">CHORD</a>)
00776                                           <span class="keywordflow">continue</span>;
00777                                     <a class="code" href="classChord.html">Chord</a>* chord = (<a class="code" href="classChord.html">Chord</a>*)el;
00778                                     <a class="code" href="classNoteList.html">NoteList</a>* nl = chord-&gt;<a class="code" href="classChord.html#a15">noteList</a>();
00779 
00780                                     <span class="keywordflow">for</span> (<a class="code" href="note_8h.html#a1">iNote</a> in = nl-&gt;begin(); in != nl-&gt;end(); ++in) {
00781                                           <a class="code" href="classNote.html">Note</a>* note = in-&gt;second;
00782                                           <span class="keywordflow">if</span> (note-&gt;<a class="code" href="classNote.html#a34">tieBack</a>())
00783                                                 <span class="keywordflow">continue</span>;
00784                                           <span class="keywordtype">unsigned</span> len = 0;
00785                                           <span class="keywordflow">while</span> (note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>()) {
00786                                                 len += note-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a76">tickLen</a>();
00787                                                 note = note-&gt;<a class="code" href="classNote.html#a33">tieFor</a>()-&gt;<a class="code" href="classTie.html#a6">endNote</a>();
00788                                                 }
00789                                           len += (note-&gt;<a class="code" href="classNote.html#a37">chord</a>()-&gt;<a class="code" href="classElement.html#a76">tickLen</a>() * gateTime / 100);
00790 
00791                                           <span class="keywordtype">int</span> tick   = chord-&gt;<a class="code" href="classElement.html#a74">tick</a>();
00792                                           len = len * gateTime / 100;
00793                                           <span class="keywordtype">int</span> pitch  = note-&gt;<a class="code" href="classNote.html#a15">pitch</a>();
00794 
00795                                           <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
00796                                           ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a14">ME_NOTEON</a>;
00797                                           ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a> = pitch;
00798                                           ev-&gt;<a class="code" href="structMidiEvent.html#o6">dataB</a> = 0x60;
00799                                           events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (tick, ev));
00800 
00801                                           ev = <span class="keyword">new</span> MidiEvent;
00802                                           ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>  = <a class="code" href="midi_8h.html#a50a14">ME_NOTEON</a>;
00803                                           ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a> = pitch;
00804                                           ev-&gt;<a class="code" href="structMidiEvent.html#o6">dataB</a> = 0x0;
00805                                           events-&gt;insert(std::pair&lt;const unsigned, MidiEvent*&gt; (tick + len, ev));
00806                                           }
00807                                     }
00808                               }
00809                         }
00810                   }
00811             }
00812 <span class="preprocessor">#endif</span>
00813 <span class="preprocessor"></span>      <span class="keywordflow">return</span> <a class="code" href="classExportMidi.html#o0">mf</a>.<a class="code" href="classMidiFile.html#d1">write</a>();
00814       }
00815 
00816 <span class="comment">//---------------------------------------------------------</span>
00817 <span class="comment">//   LoadMidi</span>
00818 <span class="comment">//---------------------------------------------------------</span>
00819 
<a name="l00820"></a><a class="code" href="classLoadMidi.html">00820</a> <span class="keyword">class </span><a class="code" href="classLoadMidi.html">LoadMidi</a> : <span class="keyword">public</span> <a class="code" href="classLoadFile.html">LoadFile</a> {
00821    <span class="keyword">public</span>:
<a name="l00822"></a><a class="code" href="classLoadMidi.html#o0">00822</a>       <a class="code" href="classMidiFile.html">MidiFile</a> <a class="code" href="classLoadMidi.html#o0">mf</a>;
00823       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classLoadMidi.html#a0">loader</a>(FILE* f);
00824       };
00825 
00826 <span class="comment">//---------------------------------------------------------</span>
00827 <span class="comment">//   importMidi</span>
00828 <span class="comment">//---------------------------------------------------------</span>
00829 
<a name="l00830"></a><a class="code" href="classMuseScore.html#k21">00830</a> <span class="keywordtype">void</span> <a class="code" href="classMuseScore.html#k21">MuseScore::importMidi</a>()
00831       {
00832       <span class="keywordflow">if</span> (<a class="code" href="classMuseScore.html#a2">checkDirty</a>())
00833             <span class="keywordflow">return</span>;
00834       <a class="code" href="classMuseScore.html#a3">clearScore</a>();
00835 
00836       <a class="code" href="classLoadMidi.html">LoadMidi</a> lm;
00837       lm.<a class="code" href="classLoadFile.html#a3">load</a>(<span class="keyword">this</span>, QString(<span class="stringliteral">"."</span>), QString(<span class="stringliteral">"*.mid"</span>), tr(<span class="stringliteral">"MuseScore: Import Midi"</span>));
00838       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o1">projectName</a> = QString(<span class="stringliteral">""</span>); <span class="comment">// lm.name();</span>
00839       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#o3">saved</a> = <span class="keyword">false</span>;
00840       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a125">convertMidi</a>(&amp;(lm.<a class="code" href="classLoadMidi.html#o0">mf</a>));
00841       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a49">layout</a>();
00842       <a class="code" href="classMuseScore.html#r0">cs</a>-&gt;<a class="code" href="classScore.html#a84">endCmd</a>(<span class="keyword">false</span>);
00843       }
00844 
00845 <span class="comment">//---------------------------------------------------------</span>
00846 <span class="comment">//   importMidi</span>
00847 <span class="comment">//---------------------------------------------------------</span>
00848 
<a name="l00849"></a><a class="code" href="classScore.html#a126">00849</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a126">Score::importMidi</a>(<span class="keyword">const</span> QString&amp; name)
00850       {
00851       <a class="code" href="classLoadMidi.html">LoadMidi</a> lm;
00852       lm.<a class="code" href="classLoadFile.html#a3">load</a>(name);
00853       <a class="code" href="classScore.html#o3">saved</a> = <span class="keyword">false</span>;
00854       <a class="code" href="classScore.html#a125">convertMidi</a>(&amp;(lm.<a class="code" href="classLoadMidi.html#o0">mf</a>));
00855 <span class="comment">//      layout();</span>
00856       }
00857 
00858 <span class="comment">//---------------------------------------------------------</span>
00859 <span class="comment">//   loader</span>
00860 <span class="comment">//    import midi file</span>
00861 <span class="comment">//    return true on error</span>
00862 <span class="comment">//---------------------------------------------------------</span>
00863 
<a name="l00864"></a><a class="code" href="classLoadMidi.html#a0">00864</a> <span class="keywordtype">bool</span> <a class="code" href="classLoadMidi.html#a0">LoadMidi::loader</a>(FILE* fp)
00865       {
00866       <a class="code" href="classLoadMidi.html#o0">mf</a>.<a class="code" href="classMidiFile.html#a1">setFp</a>(fp);
00867       <span class="keywordflow">if</span> (<a class="code" href="classLoadMidi.html#o0">mf</a>.<a class="code" href="classMidiFile.html#d0">read</a>()) {
00868             error = <a class="code" href="classLoadMidi.html#o0">mf</a>.<a class="code" href="classMidiFile.html#o0">error</a>;
00869             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00870             }
00871       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00872       }
00873 
00874 <span class="comment">//---------------------------------------------------------</span>
00875 <span class="comment">//   MidiFile</span>
00876 <span class="comment">//---------------------------------------------------------</span>
00877 
<a name="l00878"></a><a class="code" href="classMidiFile.html#a0">00878</a> <a class="code" href="classMidiFile.html#a0">MidiFile::MidiFile</a>()
00879       {
00880       <a class="code" href="classMidiFile.html#r9">fp</a>        = 0;
00881       <a class="code" href="classMidiFile.html#o0">error</a>     = 0;
00882       <a class="code" href="classMidiFile.html#r1">timesig_z</a> = 4;
00883       <a class="code" href="classMidiFile.html#r2">timesig_n</a> = 4;
00884       <a class="code" href="classMidiFile.html#r11">curPos</a>    = 0;
00885       <a class="code" href="classMidiFile.html#r12">_midiType</a> = <a class="code" href="midi_8h.html#a52a47">MT_GM</a>;      <span class="comment">// MT_UNKNOWN;</span>
00886       }
00887 
00888 <span class="comment">//---------------------------------------------------------</span>
00889 <span class="comment">//   setFp</span>
00890 <span class="comment">//---------------------------------------------------------</span>
00891 
<a name="l00892"></a><a class="code" href="classMidiFile.html#a1">00892</a> <span class="keywordtype">void</span> <a class="code" href="classMidiFile.html#a1">MidiFile::setFp</a>(FILE* _fp)
00893       {
00894       <a class="code" href="classMidiFile.html#r9">fp</a> = _fp;
00895       }
00896 
00897 <span class="comment">//---------------------------------------------------------</span>
00898 <span class="comment">//   write</span>
00899 <span class="comment">//    returns true on error</span>
00900 <span class="comment">//---------------------------------------------------------</span>
00901 
<a name="l00902"></a><a class="code" href="classMidiFile.html#a3">00902</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#a3">MidiFile::write</a>()
00903       {
00904       <a class="code" href="classMidiFile.html#a3">write</a>(<span class="stringliteral">"MThd"</span>, 4);
00905       <a class="code" href="classMidiFile.html#d7">writeLong</a>(6);                 <span class="comment">// header len</span>
00906       <a class="code" href="classMidiFile.html#d5">writeShort</a>(1);                <span class="comment">// format</span>
00907       <a class="code" href="classMidiFile.html#d5">writeShort</a>(<a class="code" href="classMidiFile.html#r0">_tracks</a>.size());
00908       <a class="code" href="classMidiFile.html#d5">writeShort</a>(<a class="code" href="mtime_8h.html#a0">division</a>);
00909       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a12">ciMidiTrack</a> i = <a class="code" href="classMidiFile.html#r0">_tracks</a>.begin(); i != <a class="code" href="classMidiFile.html#r0">_tracks</a>.end(); ++i)
00910             <a class="code" href="classMidiFile.html#d10">writeTrack</a>(*i);
00911       <span class="keywordflow">return</span> (ferror(<a class="code" href="classMidiFile.html#r9">fp</a>) != 0);
00912       }
00913 
00914 <span class="comment">//---------------------------------------------------------</span>
00915 <span class="comment">//   writeTrack</span>
00916 <span class="comment">//---------------------------------------------------------</span>
00917 
<a name="l00918"></a><a class="code" href="classMidiFile.html#d10">00918</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#d10">MidiFile::writeTrack</a>(<span class="keyword">const</span> <a class="code" href="classMidiTrack.html">MidiTrack</a>* t)
00919       {
00920       <span class="keyword">const</span> <a class="code" href="midi_8h.html#a5">EventList</a>* events = t-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
00921       <a class="code" href="classMidiFile.html#a3">write</a>(<span class="stringliteral">"MTrk"</span>, 4);
00922       <span class="keywordtype">int</span> lenpos = ftell(<a class="code" href="classMidiFile.html#r9">fp</a>);
00923       <a class="code" href="classMidiFile.html#d7">writeLong</a>(0);                 <span class="comment">// dummy len</span>
00924 
00925       <a class="code" href="classMidiFile.html#r3">status</a> = -1;
00926       <span class="keywordtype">int</span> tick = 0;
00927       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a8">ciEvent</a> i = events-&gt;begin(); i != events-&gt;end(); ++i) {
00928             <span class="keywordtype">int</span> ntick = i-&gt;first;
00929             <span class="keywordflow">if</span> (ntick &lt; tick) {
00930                   printf(<span class="stringliteral">"MidiFile::writeTrack: ntick %d &lt; tick %d\n"</span>, ntick, tick);
00931                   ntick = tick;
00932                   }
00933             <a class="code" href="classMidiFile.html#d12">putvl</a>(ntick - tick);    <span class="comment">// write tick delta</span>
00934             <a class="code" href="classMidiFile.html#d13">writeEvent</a>(t-&gt;<a class="code" href="classMidiTrack.html#a4">outChannel</a>(), i-&gt;second);
00935             tick = ntick;
00936             }
00937 
00938       <span class="comment">//---------------------------------------------------</span>
00939       <span class="comment">//    write "End Of Track" Meta</span>
00940       <span class="comment">//    write Track Len</span>
00941       <span class="comment">//</span>
00942 
00943       <a class="code" href="classMidiFile.html#d12">putvl</a>(0);
00944       <a class="code" href="classMidiFile.html#d2">put</a>(0xff);        <span class="comment">// Meta</span>
00945       <a class="code" href="classMidiFile.html#d2">put</a>(0x2f);        <span class="comment">// EOT</span>
00946       <a class="code" href="classMidiFile.html#d12">putvl</a>(0);         <span class="comment">// len 0</span>
00947       <span class="keywordtype">int</span> endpos = ftell(<a class="code" href="classMidiFile.html#r9">fp</a>);
00948       fseek(<a class="code" href="classMidiFile.html#r9">fp</a>, lenpos, SEEK_SET);
00949       <a class="code" href="classMidiFile.html#d7">writeLong</a>(endpos-lenpos-4);   <span class="comment">// tracklen</span>
00950       fseek(<a class="code" href="classMidiFile.html#r9">fp</a>, endpos, SEEK_SET);
00951       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00952       }
00953 
00954 <span class="comment">//---------------------------------------------------------</span>
00955 <span class="comment">//   writeEvent</span>
00956 <span class="comment">//---------------------------------------------------------</span>
00957 
<a name="l00958"></a><a class="code" href="classMidiFile.html#d13">00958</a> <span class="keywordtype">void</span> <a class="code" href="classMidiFile.html#d13">MidiFile::writeEvent</a>(<span class="keywordtype">int</span> c, <span class="keyword">const</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>* event)
00959       {
00960       <span class="keywordtype">int</span> nstat = event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>;
00961 
00962       <span class="comment">// we dont save meta data into smf type 0 files:</span>
00963 
00964       nstat |= c;
00965       <span class="comment">//</span>
00966       <span class="comment">//  running status; except for Sysex- and Meta Events</span>
00967       <span class="comment">//</span>
00968       <span class="keywordflow">if</span> (((nstat &amp; 0xf0) != 0xf0) &amp;&amp; (nstat != <a class="code" href="classMidiFile.html#r3">status</a>)) {
00969             <a class="code" href="classMidiFile.html#r3">status</a> = nstat;
00970             <a class="code" href="classMidiFile.html#d2">put</a>(nstat);
00971             }
00972       <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>) {
00973             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a13">ME_NOTEOFF</a>:
00974             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a14">ME_NOTEON</a>:
00975             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a15">ME_POLYAFTER</a>:
00976             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a16">ME_CONTROLLER</a>:
00977             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a19">ME_PITCHBEND</a>:
00978                   <a class="code" href="classMidiFile.html#d2">put</a>(event-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>);
00979                   <a class="code" href="classMidiFile.html#d2">put</a>(event-&gt;<a class="code" href="structMidiEvent.html#o6">dataB</a>);
00980                   <span class="keywordflow">break</span>;
00981             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a17">ME_PROGRAM</a>:        <span class="comment">// Program Change</span>
00982             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a18">ME_AFTERTOUCH</a>:     <span class="comment">// Channel Aftertouch</span>
00983                   <a class="code" href="classMidiFile.html#d2">put</a>(event-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>);
00984                   <span class="keywordflow">break</span>;
00985             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a20">ME_SYSEX</a>:
00986                   <a class="code" href="classMidiFile.html#d2">put</a>(0xf0);
00987                   <a class="code" href="classMidiFile.html#d12">putvl</a>(event-&gt;<a class="code" href="structMidiEvent.html#o3">len</a> + 1);  <span class="comment">// including 0xf7</span>
00988                   <a class="code" href="classMidiFile.html#a3">write</a>(event-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>, event-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>);
00989                   <a class="code" href="classMidiFile.html#d2">put</a>(0xf7);
00990                   <a class="code" href="classMidiFile.html#r3">status</a> = -1;      <span class="comment">// invalidate running status</span>
00991                   <span class="keywordflow">break</span>;
00992             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a21">ME_META</a>:
00993                   <a class="code" href="classMidiFile.html#d2">put</a>(0xff);
00994                   <a class="code" href="classMidiFile.html#d2">put</a>(event-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>);
00995                   <a class="code" href="classMidiFile.html#d12">putvl</a>(event-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>);
00996                   <a class="code" href="classMidiFile.html#a3">write</a>(event-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>, event-&gt;<a class="code" href="structMidiEvent.html#o3">len</a>);
00997                   <a class="code" href="classMidiFile.html#r3">status</a> = -1;
00998                   <span class="keywordflow">break</span>;
00999             }
01000       }
01001 
01002 <span class="comment">//---------------------------------------------------------</span>
01003 <span class="comment">//   readMidi</span>
01004 <span class="comment">//    return true on error</span>
01005 <span class="comment">//---------------------------------------------------------</span>
01006 
<a name="l01007"></a><a class="code" href="classMidiFile.html#a2">01007</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#a2">MidiFile::read</a>()
01008       {
01009       <a class="code" href="classMidiFile.html#r13">errorBuffer</a>[0] = 0;
01010       <a class="code" href="classMidiFile.html#o0">error</a> = <a class="code" href="classMidiFile.html#r13">errorBuffer</a>;
01011       <a class="code" href="classMidiFile.html#r0">_tracks</a>.clear();
01012 
01013       <span class="keywordtype">char</span> tmp[4];
01014 
01015       <a class="code" href="classMidiFile.html#a2">read</a>(tmp, 4);
01016       <span class="keywordtype">int</span> len = <a class="code" href="classMidiFile.html#d6">readLong</a>();
01017       <span class="keywordflow">if</span> (memcmp(tmp, <span class="stringliteral">"MThd"</span>, 4) || len &lt; 6) {
01018             <a class="code" href="classMidiFile.html#o0">error</a> = <span class="stringliteral">"bad midifile: MThd expected\n"</span>;
01019             <span class="keywordflow">return</span> <span class="keyword">true</span>;
01020             }
01021 
01022       <span class="keywordtype">int</span> format  = <a class="code" href="classMidiFile.html#d4">readShort</a>();
01023       <span class="keywordtype">int</span> ntracks = <a class="code" href="classMidiFile.html#d4">readShort</a>();
01024       <a class="code" href="classMidiFile.html#r10">fileDivision</a> = <a class="code" href="classMidiFile.html#d4">readShort</a>();
01025 
01026       <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r10">fileDivision</a> &lt; 0)
01027             <a class="code" href="classMidiFile.html#r10">fileDivision</a> = (-(<a class="code" href="classMidiFile.html#r10">fileDivision</a>/256)) * (<a class="code" href="classMidiFile.html#r10">fileDivision</a> &amp; 0xff);
01028       <span class="keywordflow">if</span> (len &gt; 6)
01029             <a class="code" href="classMidiFile.html#d3">skip</a>(len-6); <span class="comment">// skip the excess</span>
01030 
01031       <span class="keywordflow">switch</span> (format) {
01032             <span class="keywordflow">case</span> 0:
01033                   <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#d9">readTrack</a>(<span class="keyword">true</span>))
01034                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
01035                   <span class="keywordflow">break</span>;
01036             <span class="keywordflow">case</span> 1:
01037                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ntracks; i++) {
01038                         <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#d9">readTrack</a>(<span class="keyword">false</span>))
01039                               <span class="keywordflow">return</span> <span class="keyword">true</span>;
01040                         }
01041                   <span class="keywordflow">break</span>;
01042             <span class="keywordflow">default</span>:
01043             <span class="keywordflow">case</span> 2:
01044                   sprintf(errorBuffer, <span class="stringliteral">"midi fileformat %d not implemented!\n"</span>, format);
01045                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01046             }
01047 
01048       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a11">iMidiTrack</a> t = <a class="code" href="classMidiFile.html#r0">_tracks</a>.begin(); t != <a class="code" href="classMidiFile.html#r0">_tracks</a>.end(); ++t)
01049             <a class="code" href="classMidiFile.html#d14">processTrack</a>(*t);
01050       <span class="keywordflow">return</span> <span class="keyword">false</span>;
01051       }
01052 
01053 <span class="comment">//---------------------------------------------------------</span>
01054 <span class="comment">//   readTrack</span>
01055 <span class="comment">//    return true on error</span>
01056 <span class="comment">//---------------------------------------------------------</span>
01057 
<a name="l01058"></a><a class="code" href="classMidiFile.html#d9">01058</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#d9">MidiFile::readTrack</a>(<span class="keywordtype">bool</span> mergeChannels)
01059       {
01060       <span class="keywordtype">char</span> tmp[4];
01061       <a class="code" href="classMidiFile.html#a2">read</a>(tmp, 4);
01062       <span class="keywordflow">if</span> (memcmp(tmp, <span class="stringliteral">"MTrk"</span>, 4)) {
01063             sprintf(<a class="code" href="classMidiFile.html#r13">errorBuffer</a>, <span class="stringliteral">"bad midifile: MTrk expected\n"</span>);
01064             <span class="keywordflow">return</span> <span class="keyword">true</span>;
01065             }
01066       <span class="keywordtype">int</span> len       = <a class="code" href="classMidiFile.html#d6">readLong</a>();       <span class="comment">// len</span>
01067       <span class="keywordtype">int</span> endPos    = <a class="code" href="classMidiFile.html#r11">curPos</a> + len;
01068       <a class="code" href="classMidiFile.html#r3">status</a>        = -1;
01069       <a class="code" href="classMidiFile.html#r6">sstatus</a>       = -1;  <span class="comment">// running status, der nicht bei meta oder sysex zurckgesetzt wird</span>
01070       <a class="code" href="classMidiFile.html#r4">lastchan</a>      = -1;
01071       <a class="code" href="classMidiFile.html#r7">lastport</a>      = -1;
01072       <a class="code" href="classMidiFile.html#r8">channelprefix</a> = -1;
01073       <a class="code" href="classMidiFile.html#r5">click</a>         = 0;
01074       <span class="keywordtype">int</span> channel   = -1;
01075       <span class="keywordtype">int</span> port      = -1;
01076       <a class="code" href="classMidiTrack.html">MidiTrack</a>* track  = <span class="keyword">new</span> <a class="code" href="classMidiTrack.html">MidiTrack</a>();
01077       <a class="code" href="classMidiFile.html#r0">_tracks</a>.push_back(track);
01078       <a class="code" href="midi_8h.html#a5">EventList</a>* el = track-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
01079 
01080       <span class="keywordflow">for</span> (;;) {
01081             <a class="code" href="structMidiEvent.html">MidiEvent</a>* event = <a class="code" href="classMidiFile.html#d8">readEvent</a>(track);
01082             <span class="keywordflow">if</span> (event == 0)
01083                   <span class="keywordflow">break</span>;
01084             <span class="keywordflow">if</span> (int(event) == -1)
01085                   <span class="keywordflow">continue</span>;
01086             <span class="keywordflow">if</span> (int(event) == -2)         <span class="comment">// error</span>
01087                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01088             <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r4">lastchan</a> == -1) {
01089                   el-&gt;insert(std::pair&lt;const int, MidiEvent*&gt; (event-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a>, event));
01090                   <span class="keywordflow">continue</span>;
01091                   }
01092             <span class="keywordflow">if</span> (port == -1) {
01093                   <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r7">lastport</a> == -1) {
01094                         port = 0;
01095                         }
01096                   <span class="keywordflow">else</span> {
01097                         port = <a class="code" href="classMidiFile.html#r7">lastport</a>;
01098                         <span class="keywordflow">if</span> (channel != -1) {
01099                               track-&gt;<a class="code" href="classMidiTrack.html#a7">setOutPort</a>(port);
01100                               }
01101                         }
01102                   }
01103             <span class="keywordflow">else</span> {
01104                   <span class="keywordflow">if</span> ((<a class="code" href="classMidiFile.html#r7">lastport</a> != -1) &amp;&amp; (<a class="code" href="classMidiFile.html#r7">lastport</a> != port)) {
01105                         printf(<span class="stringliteral">"PORT CHANGE in Midi File\n"</span>);
01106                         <span class="keywordflow">if</span> (channel != -1) {
01107                               track-&gt;<a class="code" href="classMidiTrack.html#a7">setOutPort</a>(port);
01108                               }
01109                         }
01110                   }
01111             <span class="keywordflow">if</span> (port &gt;= <a class="code" href="midi_8h.html#a4">MIDI_PORTS</a>) {
01112                   printf(<span class="stringliteral">"port %d &gt;= %d, reset to 1\n"</span>, port, <a class="code" href="midi_8h.html#a4">MIDI_PORTS</a>);
01113                   port = 1;
01114                   }
01115             <span class="keywordflow">if</span> (channel == -1) {
01116                   channel = <a class="code" href="classMidiFile.html#r4">lastchan</a>;
01117                   track-&gt;<a class="code" href="classMidiTrack.html#a5">setOutChannel</a>(channel);
01118                   <span class="keywordflow">if</span> (port != track-&gt;<a class="code" href="classMidiTrack.html#a6">outPort</a>())
01119                         printf(<span class="stringliteral">"2 HALOOOO %d %d\n"</span>, port, track-&gt;<a class="code" href="classMidiTrack.html#a6">outPort</a>());
01120                   el-&gt;insert(std::pair&lt;const int, MidiEvent*&gt; (event-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a>, event));
01121                   <span class="keywordflow">continue</span>;
01122                   }
01123             <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r4">lastchan</a> != channel) {
01124                   mergeChannels = <span class="keyword">true</span>;   <span class="comment">// DEBUG</span>
01125                   <span class="keywordflow">if</span> (!mergeChannels) {
01126                         <span class="comment">//</span>
01127                         <span class="comment">// try to insert in approp track</span>
01128                         <span class="comment">//</span>
01129                         <a class="code" href="midi_8h.html#a10">MidiTrackList</a>* tl = &amp;<a class="code" href="classMidiFile.html#r0">_tracks</a>;
01130                         MidiTrack* mtrack;
01131                         <a class="code" href="midi_8h.html#a11">iMidiTrack</a> t;
01132                         <span class="keywordflow">for</span> (t = tl-&gt;begin(); t != tl-&gt;end(); ++t) {
01133                               mtrack = dynamic_cast&lt;MidiTrack*&gt;(*t);
01134                               <span class="keywordflow">if</span> (mtrack == 0)
01135                                     <span class="keywordflow">continue</span>;
01136                               <span class="keywordflow">if</span> (mtrack-&gt;<a class="code" href="classMidiTrack.html#a4">outChannel</a>() == <a class="code" href="classMidiFile.html#r4">lastchan</a>) {
01137                                     mtrack-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>()-&gt;insert(std::pair&lt;const int, MidiEvent*&gt; (event-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a>, event));
01138                                     <span class="keywordflow">break</span>;
01139                                     }
01140                               }
01141                         <span class="keywordflow">if</span> (t == tl-&gt;end())
01142                               printf(<span class="stringliteral">"no approp. track found\n"</span>);
01143                         }
01144                   <span class="keywordflow">else</span> {
01145                         <span class="comment">//</span>
01146                         <span class="comment">// event with new channel in track</span>
01147                         <span class="comment">//    try to find channel with appropr. track</span>
01148                         <span class="comment">//    or create new track</span>
01149                         <span class="comment">//</span>
01150                         <a class="code" href="midi_8h.html#a10">MidiTrackList</a>* tl = &amp;<a class="code" href="classMidiFile.html#r0">_tracks</a>;
01151                         <a class="code" href="midi_8h.html#a11">iMidiTrack</a> t;
01152                         MidiTrack* mtrack = 0;
01153                         <span class="keywordflow">for</span> (t = tl-&gt;begin(); t != tl-&gt;end(); ++t) {
01154                               mtrack = dynamic_cast&lt;MidiTrack*&gt;(*t);
01155                               <span class="keywordflow">if</span> (mtrack == 0)
01156                                     <span class="keywordflow">continue</span>;
01157                               <span class="keywordflow">if</span> (mtrack-&gt;<a class="code" href="classMidiTrack.html#a4">outChannel</a>() == <a class="code" href="classMidiFile.html#r4">lastchan</a>)
01158                                     <span class="keywordflow">break</span>;
01159                               }
01160                         <span class="keywordflow">if</span> (t == tl-&gt;end()) {
01161                               mtrack = <span class="keyword">new</span> MidiTrack();
01162                               mtrack-&gt;<a class="code" href="classMidiTrack.html#a5">setOutChannel</a>(<a class="code" href="classMidiFile.html#r4">lastchan</a>);
01163                               mtrack-&gt;<a class="code" href="classMidiTrack.html#a7">setOutPort</a>(port);
01164                               _tracks.push_back(mtrack);
01165                               }
01166                         track   = mtrack;
01167                         channel = <a class="code" href="classMidiFile.html#r4">lastchan</a>;
01168                         el = track-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
01169                         }
01170                   }
01171             el-&gt;insert(std::pair&lt;const int, MidiEvent*&gt; (event-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a>, event));
01172             }
01173       <span class="keywordtype">int</span> end = <a class="code" href="classMidiFile.html#r11">curPos</a>;
01174       <span class="keywordflow">if</span> (end != endPos) {
01175             printf(<span class="stringliteral">"TRACKLAENGE pass nicht %d+%d != %d, %d zu viel\n"</span>,
01176                endPos-len, len, end, endPos-end);
01177             <span class="keywordflow">if</span> (end &lt; endPos)
01178                   <a class="code" href="classMidiFile.html#d3">skip</a>(endPos - end);
01179             }
01180       <span class="keywordflow">return</span> <span class="keyword">false</span>;
01181       }
01182 
01183 <span class="comment">/*---------------------------------------------------------</span>
01184 <span class="comment"> *    read</span>
01185 <span class="comment"> *---------------------------------------------------------*/</span>
01186 
<a name="l01187"></a><a class="code" href="classMidiFile.html#d0">01187</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#a2">MidiFile::read</a>(<span class="keywordtype">void</span>* p, size_t len)
01188       {
01189       <span class="keywordflow">for</span> (;;) {
01190             <a class="code" href="classMidiFile.html#r11">curPos</a> += len;
01191             size_t rv = fread(p, 1, len, <a class="code" href="classMidiFile.html#r9">fp</a>);
01192             <span class="keywordflow">if</span> (rv == len)
01193                   <span class="keywordflow">return</span> <span class="keyword">false</span>;
01194             <span class="keywordflow">if</span> (feof(<a class="code" href="classMidiFile.html#r9">fp</a>))
01195                   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01196             <span class="keywordflow">return</span> <span class="keyword">true</span>;
01197             }
01198       <span class="keywordflow">return</span> <span class="keyword">false</span>;
01199       }
01200 
01201 <span class="comment">//---------------------------------------------------------</span>
01202 <span class="comment">//   write</span>
01203 <span class="comment">//---------------------------------------------------------</span>
01204 
<a name="l01205"></a><a class="code" href="classMidiFile.html#d1">01205</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#a3">MidiFile::write</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* p, size_t len)
01206       {
01207       size_t rv = fwrite(p, 1, len, <a class="code" href="classMidiFile.html#r9">fp</a>);
01208       <span class="keywordflow">if</span> (rv == len)
01209             <span class="keywordflow">return</span> <span class="keyword">false</span>;
01210       printf(<span class="stringliteral">"write midifile failed: %s\n"</span>, strerror(errno));
01211       <span class="keywordflow">return</span> <span class="keyword">true</span>;
01212       }
01213 
01214 <span class="comment">//---------------------------------------------------------</span>
01215 <span class="comment">//   readShort</span>
01216 <span class="comment">//---------------------------------------------------------</span>
01217 
<a name="l01218"></a><a class="code" href="classMidiFile.html#d4">01218</a> <span class="keywordtype">int</span> <a class="code" href="classMidiFile.html#d4">MidiFile::readShort</a>()
01219       {
01220       <span class="keywordtype">short</span> format;
01221       <a class="code" href="classMidiFile.html#a2">read</a>(&amp;format, 2);
01222       <span class="keywordflow">return</span> <a class="code" href="midi_8h.html#a2">BE_SHORT</a>(format);
01223       }
01224 
01225 <span class="comment">//---------------------------------------------------------</span>
01226 <span class="comment">//   writeShort</span>
01227 <span class="comment">//---------------------------------------------------------</span>
01228 
<a name="l01229"></a><a class="code" href="classMidiFile.html#d5">01229</a> <span class="keywordtype">void</span> <a class="code" href="classMidiFile.html#d5">MidiFile::writeShort</a>(<span class="keywordtype">int</span> i)
01230       {
01231       <span class="keywordtype">int</span> format = <a class="code" href="midi_8h.html#a2">BE_SHORT</a>(i);
01232       <a class="code" href="classMidiFile.html#a3">write</a>(&amp;format, 2);
01233       }
01234 
01235 <span class="comment">//---------------------------------------------------------</span>
01236 <span class="comment">//   readLong</span>
01237 <span class="comment">//   writeLong</span>
01238 <span class="comment">//---------------------------------------------------------</span>
01239 
<a name="l01240"></a><a class="code" href="classMidiFile.html#d6">01240</a> <span class="keywordtype">int</span> <a class="code" href="classMidiFile.html#d6">MidiFile::readLong</a>()
01241       {
01242       <span class="keywordtype">int</span> format;
01243       <a class="code" href="classMidiFile.html#a2">read</a>(&amp;format, 4);
01244       <span class="keywordflow">return</span> <a class="code" href="midi_8h.html#a3">BE_LONG</a>(format);
01245       }
01246 
01247 <span class="comment">//---------------------------------------------------------</span>
01248 <span class="comment">//   writeLong</span>
01249 <span class="comment">//---------------------------------------------------------</span>
01250 
<a name="l01251"></a><a class="code" href="classMidiFile.html#d7">01251</a> <span class="keywordtype">void</span> <a class="code" href="classMidiFile.html#d7">MidiFile::writeLong</a>(<span class="keywordtype">int</span> i)
01252       {
01253       <span class="keywordtype">int</span> format = <a class="code" href="midi_8h.html#a3">BE_LONG</a>(i);
01254       <a class="code" href="classMidiFile.html#a3">write</a>(&amp;format, 4);
01255       }
01256 
01257 <span class="comment">/*---------------------------------------------------------</span>
01258 <span class="comment"> *    skip</span>
01259 <span class="comment"> *    This is meant for skipping a few bytes in a</span>
01260 <span class="comment"> *    file or fifo.</span>
01261 <span class="comment"> *---------------------------------------------------------*/</span>
01262 
<a name="l01263"></a><a class="code" href="classMidiFile.html#d3">01263</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#d3">MidiFile::skip</a>(size_t len)
01264       {
01265       <span class="keywordflow">if</span> (len &lt;= 0)
01266             <span class="keywordflow">return</span> <span class="keyword">false</span>;
01267       <span class="keywordtype">char</span> tmp[len];
01268       <span class="keywordflow">return</span> <a class="code" href="classMidiFile.html#a2">read</a>(tmp, len);
01269       }
01270 
01271 <span class="comment">/*---------------------------------------------------------</span>
01272 <span class="comment"> *    getvl</span>
01273 <span class="comment"> *    Read variable-length number (7 bits per byte, MSB first)</span>
01274 <span class="comment"> *---------------------------------------------------------*/</span>
01275 
<a name="l01276"></a><a class="code" href="classMidiFile.html#d11">01276</a> <span class="keywordtype">int</span> <a class="code" href="classMidiFile.html#d11">MidiFile::getvl</a>()
01277       {
01278       <span class="keywordtype">int</span> l = 0;
01279       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0;i &lt; 16; i++) {
01280             uchar c;
01281             <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#a2">read</a>(&amp;c, 1))
01282                   <span class="keywordflow">return</span> -1;
01283             l += (c &amp; 0x7f);
01284             <span class="keywordflow">if</span> (!(c &amp; 0x80)) {
01285                   <span class="keywordflow">return</span> l;
01286                   }
01287             l &lt;&lt;= 7;
01288             }
01289       <span class="keywordflow">return</span> -1;
01290       }
01291 
01292 <span class="comment">/*---------------------------------------------------------</span>
01293 <span class="comment"> *    putvl</span>
01294 <span class="comment"> *    Write variable-length number (7 bits per byte, MSB first)</span>
01295 <span class="comment"> *---------------------------------------------------------*/</span>
01296 
<a name="l01297"></a><a class="code" href="classMidiFile.html#d12">01297</a> <span class="keywordtype">void</span> <a class="code" href="classMidiFile.html#d12">MidiFile::putvl</a>(<span class="keywordtype">unsigned</span> val)
01298       {
01299       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> buf = val &amp; 0x7f;
01300       <span class="keywordflow">while</span> ((val &gt;&gt;= 7) &gt; 0) {
01301             buf &lt;&lt;= 8;
01302             buf |= 0x80;
01303             buf += (val &amp; 0x7f);
01304             }
01305       <span class="keywordflow">for</span> (;;) {
01306             <a class="code" href="classMidiFile.html#d2">put</a>(buf);
01307             <span class="keywordflow">if</span> (buf &amp; 0x80)
01308                   buf &gt;&gt;= 8;
01309             <span class="keywordflow">else</span>
01310                   <span class="keywordflow">break</span>;
01311             }
01312       }
01313 
01314 <span class="comment">//---------------------------------------------------------</span>
01315 <span class="comment">//   MidiTrack</span>
01316 <span class="comment">//---------------------------------------------------------</span>
01317 
<a name="l01318"></a><a class="code" href="classMidiTrack.html#a0">01318</a> <a class="code" href="classMidiTrack.html#a0">MidiTrack::MidiTrack</a>()
01319       {
01320       <a class="code" href="classMidiTrack.html#r0">_events</a>     = <span class="keyword">new</span> <a class="code" href="midi_8h.html#a5">EventList</a>;
01321       <a class="code" href="classMidiTrack.html#r1">_outChannel</a> = 0;
01322       <a class="code" href="classMidiTrack.html#r2">_outPort</a>    = 0;
01323       <a class="code" href="classMidiTrack.html#r5">_drumTrack</a>  = <span class="keyword">false</span>;
01324       <a class="code" href="classMidiTrack.html#r6">_minor</a>      = <span class="keyword">false</span>;
01325       <a class="code" href="classMidiTrack.html#r7">_key</a>        = 0;
01326       <a class="code" href="classMidiTrack.html#o0">hbank</a>       = 0;
01327       <a class="code" href="classMidiTrack.html#o1">lbank</a>       = 0;
01328       <a class="code" href="classMidiTrack.html#o2">program</a>     = 0;
01329       <a class="code" href="classMidiTrack.html#o3">minPitch</a>    = 127;
01330       <a class="code" href="classMidiTrack.html#o4">maxPitch</a>    = 0;
01331       <a class="code" href="classMidiTrack.html#o5">medPitch</a>    = 64;
01332       }
01333 
<a name="l01334"></a><a class="code" href="classMidiTrack.html#a1">01334</a> <a class="code" href="classMidiTrack.html#a1">MidiTrack::~MidiTrack</a>()
01335       {
01336       <span class="keyword">delete</span> <a class="code" href="classMidiTrack.html#r0">_events</a>;
01337       }
01338 
01339 <span class="comment">//---------------------------------------------------------</span>
01340 <span class="comment">//   checkSysex</span>
01341 <span class="comment">//---------------------------------------------------------</span>
01342 
<a name="l01343"></a><a class="code" href="classMidiFile.html#d15">01343</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiFile.html#d15">MidiFile::checkSysex</a>(<a class="code" href="classMidiTrack.html">MidiTrack</a>* track, <span class="keywordtype">unsigned</span> len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* buf)
01344       {
01345       <span class="keywordflow">if</span> ((len == <a class="code" href="midi_8cpp.html#a3">gmOnMsgLen</a>) &amp;&amp; memcmp(buf, <a class="code" href="midi_8cpp.html#a0">gmOnMsg</a>, <a class="code" href="midi_8cpp.html#a3">gmOnMsgLen</a>) == 0) {
01346             <a class="code" href="classMidiFile.html#r12">_midiType</a> = <a class="code" href="midi_8h.html#a52a47">MT_GM</a>;
01347             <span class="keywordflow">return</span> <span class="keyword">false</span>;
01348             }
01349       <span class="keywordflow">if</span> ((len == <a class="code" href="midi_8cpp.html#a4">gsOnMsgLen</a>) &amp;&amp; memcmp(buf, <a class="code" href="midi_8cpp.html#a1">gsOnMsg</a>, <a class="code" href="midi_8cpp.html#a4">gsOnMsgLen</a>) == 0) {
01350             <a class="code" href="classMidiFile.html#r12">_midiType</a> = <a class="code" href="midi_8h.html#a52a48">MT_GS</a>;
01351             <span class="keywordflow">return</span> <span class="keyword">false</span>;
01352             }
01353       <span class="keywordflow">if</span> (buf[0] == 0x41) {   <span class="comment">// Roland</span>
01354             <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r12">_midiType</a> != <a class="code" href="midi_8h.html#a52a49">MT_XG</a>)
01355                   <a class="code" href="classMidiFile.html#r12">_midiType</a> = <a class="code" href="midi_8h.html#a52a48">MT_GS</a>;
01356             }
01357 
01358       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == 0x43) {   <span class="comment">// Yamaha</span>
01359             <a class="code" href="classMidiFile.html#r12">_midiType</a> = <a class="code" href="midi_8h.html#a52a49">MT_XG</a>;
01360             <span class="keywordtype">int</span> type  = buf[1] &amp; 0xf0;
01361             <span class="keywordflow">switch</span> (type) {
01362                   <span class="keywordflow">case</span> 0x00:  <span class="comment">// bulk dump</span>
01363                         buf[1] = 0;
01364                         <span class="keywordflow">break</span>;
01365                   <span class="keywordflow">case</span> 0x10:
01366                         <span class="keywordflow">if</span> (buf[1] != 0x10) {
01367 <span class="comment">// printf("SYSEX Device changed from %d(0x%x) to 1\n", (buf[1] &amp; 0xf) + 1, buf[1]);</span>
01368                               buf[1] = 0x10;    <span class="comment">// fix to Device 1</span>
01369                               }
01370                         <span class="keywordflow">if</span> (len == 7 &amp;&amp; buf[2] == 0x4c &amp;&amp; buf[3] == 0x08 &amp;&amp; buf[5] == 7) {
01371                               <span class="comment">// part mode</span>
01372                               <span class="comment">// 0 - normal</span>
01373                               <span class="comment">// 1 - DRUM</span>
01374                               <span class="comment">// 2 - DRUM 1</span>
01375                               <span class="comment">// 3 - DRUM 2</span>
01376                               <span class="comment">// 4 - DRUM 3</span>
01377                               <span class="comment">// 5 - DRUM 4</span>
01378                               printf(<span class="stringliteral">"xg set part mode channel %d to %d\n"</span>, buf[4]+1, buf[6]);
01379                               <span class="keywordflow">if</span> (buf[6] != 0)
01380                                     track-&gt;<a class="code" href="classMidiTrack.html#a13">setDrumTrack</a>(<span class="keyword">true</span>);
01381                               }
01382                         <span class="keywordflow">break</span>;
01383                   <span class="keywordflow">case</span> 0x20:
01384                         printf(<span class="stringliteral">"YAMAHA DUMP REQUEST\n"</span>);
01385                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
01386                   <span class="keywordflow">case</span> 0x30:
01387                         printf(<span class="stringliteral">"YAMAHA PARAMETER REQUEST\n"</span>);
01388                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
01389                   <span class="keywordflow">default</span>:
01390                         printf(<span class="stringliteral">"YAMAHA unknown SYSEX: data[2]=%02x\n"</span>, buf[1]);
01391 <span class="comment">//                        dump(buf, len);</span>
01392                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
01393                   }
01394             }
01395       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == 0x42) {   <span class="comment">// Korg</span>
01396 <span class="comment">//            int device = buf[1] &amp; 0xf;</span>
01397             <span class="keywordflow">if</span> ((buf[1] &amp; 0xf0) != 0x30) {
01398                   printf(<span class="stringliteral">"KORG SYSEX??\n"</span>);
01399                   }
01400 <span class="comment">//            buf[1] &amp;= 0xf;    // fest auf Device 1 klemmen</span>
01401             fflush(stdout);
01402             }
01403       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[0] == 0x41) {   <span class="comment">// Korg</span>
01404 <span class="comment">//            int device = buf[1] &amp; 0xf;</span>
01405             <span class="keywordflow">if</span> ((buf[1] &amp; 0xf0) != 0x10) {
01406                   printf(<span class="stringliteral">"GM SYSEX??\n"</span>);
01407                   }
01408 <span class="comment">//            buf[1] &amp;= 0xf;    // fest auf Device 1 klemmen</span>
01409             fflush(stdout);
01410             }
01411 
01412       <span class="keywordflow">if</span> ((len == <a class="code" href="midi_8cpp.html#a5">xgOnMsgLen</a>) &amp;&amp; memcmp(buf, <a class="code" href="midi_8cpp.html#a2">xgOnMsg</a>, <a class="code" href="midi_8cpp.html#a5">xgOnMsgLen</a>) == 0) {
01413             <a class="code" href="classMidiFile.html#r12">_midiType</a> = <a class="code" href="midi_8h.html#a52a49">MT_XG</a>;
01414             <span class="keywordflow">return</span> <span class="keyword">false</span>;
01415             }
01416       <span class="keywordflow">return</span> <span class="keyword">true</span>;
01417       }
01418 
01419 <span class="comment">//---------------------------------------------------------</span>
01420 <span class="comment">//   readEvent</span>
01421 <span class="comment">//    returns:</span>
01422 <span class="comment">//          0     End of track</span>
01423 <span class="comment">//          -1    Event filtered</span>
01424 <span class="comment">//          -2    Error</span>
01425 <span class="comment">//---------------------------------------------------------</span>
01426 
<a name="l01427"></a><a class="code" href="classMidiFile.html#d8">01427</a> <a class="code" href="structMidiEvent.html">MidiEvent</a>* <a class="code" href="classMidiFile.html#d8">MidiFile::readEvent</a>(<a class="code" href="classMidiTrack.html">MidiTrack</a>*)
01428       {
01429 <span class="preprocessor">#if 0 // TODO</span>
01430 <span class="preprocessor"></span>      uchar me, type, a, b;
01431 
01432       <span class="keywordtype">int</span> nclick = <a class="code" href="classMidiFile.html#d11">getvl</a>();
01433       <span class="keywordflow">if</span> (nclick == -1) {
01434             printf(<span class="stringliteral">"readEvent: error 1\n"</span>);
01435             <span class="keywordflow">return</span> 0;
01436             }
01437       <a class="code" href="classMidiFile.html#r5">click</a> += nclick;
01438       <span class="keywordflow">for</span> (;;) {
01439             <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#a2">read</a>(&amp;me, 1)) {
01440                   sprintf(<a class="code" href="classMidiFile.html#r13">errorBuffer</a>, <span class="stringliteral">"readEvent: error 2\n"</span>);
01441                   <span class="keywordflow">return</span> 0;
01442                   }
01443             <span class="keywordflow">if</span> (me &gt;= 0xf8 &amp;&amp; me &lt;= 0xfe) {
01444                   <span class="keywordflow">if</span> (<a class="code" href="element_8cpp.html#a0">debugMode</a>)
01445                         printf(<span class="stringliteral">"Midi: Real Time Message 0x%02x\n"</span>, me &amp; 0xff);
01446                   }
01447             <span class="keywordflow">else</span>
01448                   <span class="keywordflow">break</span>;
01449             }
01450 
01451       <span class="keywordtype">int</span> t = (<a class="code" href="classMidiFile.html#r5">click</a> * <a class="code" href="mtime_8h.html#a0">division</a> + <a class="code" href="classMidiFile.html#r10">fileDivision</a>/2) / <a class="code" href="classMidiFile.html#r10">fileDivision</a>;
01452       <a class="code" href="structMidiEvent.html">MidiEvent</a>* event = <span class="keyword">new</span> <a class="code" href="structMidiEvent.html">MidiEvent</a>;
01453       event-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a> = t;
01454 
01455       <span class="keywordtype">int</span> len;
01456       uchar* buffer;
01457 
01458       <span class="keywordflow">switch</span> (me) {
01459             <span class="keywordflow">case</span> 0xf1:        <span class="comment">// undefined</span>
01460             <span class="keywordflow">case</span> 0xf2:        <span class="comment">// song position, 2 - 14 bit value, least significant byte first</span>
01461             <span class="keywordflow">case</span> 0xf3:        <span class="comment">// song select          1 - song number</span>
01462             <span class="keywordflow">case</span> 0xf4:        <span class="comment">// undefined</span>
01463             <span class="keywordflow">case</span> 0xf5:        <span class="comment">// Device Select + Parameter 0, 1, 2, 3</span>
01464             <span class="keywordflow">case</span> 0xf6:        <span class="comment">// tune request         0</span>
01465                   <span class="keywordflow">if</span> (<a class="code" href="element_8cpp.html#a0">debugMode</a>)
01466                         printf(<span class="stringliteral">"Midi: unknown message 0x%02x\n"</span>, me &amp; 0xff);
01467                   <span class="keywordflow">break</span>;
01468             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a20">ME_SYSEX</a>:    <span class="comment">// 0xf0</span>
01469             <span class="keywordflow">case</span> 0xf7:        <span class="comment">// EOX</span>
01470                   <a class="code" href="classMidiFile.html#r3">status</a> = -1;                  <span class="comment">// no running status</span>
01471                   len    = <a class="code" href="classMidiFile.html#d11">getvl</a>();
01472                   <span class="keywordflow">if</span> (len == -1) {
01473                         printf(<span class="stringliteral">"readEvent: error 3\n"</span>);
01474                         <span class="keyword">delete</span> event;
01475                         <span class="keywordflow">return</span> (MidiEvent*)-2;
01476                         }
01477                   buffer = <span class="keyword">new</span> uchar[len];
01478                   <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#a2">read</a>(buffer, len)) {
01479                         printf(<span class="stringliteral">"readEvent: error 4\n"</span>);
01480                         <span class="keyword">delete</span> event;
01481                         <span class="keyword">delete</span>[] buffer;
01482                         <span class="keywordflow">return</span> (MidiEvent*)-2;
01483                         }
01484                   <span class="keywordflow">if</span> (buffer[len-1] != 0xf7) {
01485                         printf(<span class="stringliteral">"SYSEX endet nicht mit 0xf7!\n"</span>);
01486                         <span class="comment">// Forstsetzung folgt?</span>
01487                         }
01488                   <span class="keywordflow">else</span>
01489                         --len;      <span class="comment">// don't count 0xf7</span>
01490                   <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#d15">checkSysex</a>(track, len, buffer)) {
01491                         event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>    = <a class="code" href="midi_8h.html#a50a20">ME_SYSEX</a>;
01492                         event-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>    = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[len];
01493                         event-&gt;<a class="code" href="structMidiEvent.html#o1">dataLen</a> = len;
01494                         memcpy(event-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>, buffer, len);
01495                         }
01496                   <span class="keywordflow">else</span> {
01497                         <span class="keyword">delete</span>[] buffer;
01498                         <span class="keyword">delete</span> event;
01499                         <span class="keywordflow">return</span> (MidiEvent*)-1;
01500                         }
01501                   <span class="keywordflow">break</span>;
01502             <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a21">ME_META</a>:     <span class="comment">// 0xff</span>
01503                   <a class="code" href="classMidiFile.html#r3">status</a> = -1;                  <span class="comment">// no running status</span>
01504                   <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#a2">read</a>(&amp;type, 1)) {            <span class="comment">// read type</span>
01505                         printf(<span class="stringliteral">"readEvent: error 5\n"</span>);
01506                         <span class="keyword">delete</span> event;
01507                         <span class="keywordflow">return</span> (MidiEvent*)-2;
01508                         }
01509                   len = <a class="code" href="classMidiFile.html#d11">getvl</a>();                <span class="comment">// read len</span>
01510                   <span class="keywordflow">if</span> (len == -1) {
01511                         printf(<span class="stringliteral">"readEvent: error 6\n"</span>);
01512                         <span class="keyword">delete</span> event;
01513                         <span class="keywordflow">return</span> (MidiEvent*)-2;
01514                         }
01515                   buffer = <span class="keyword">new</span> uchar[len+1];
01516                   <span class="keywordflow">if</span> (len) {
01517                         <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#a2">read</a>(buffer, len)) {
01518                               printf(<span class="stringliteral">"readEvent: error 7\n"</span>);
01519                               <span class="keyword">delete</span> event;
01520                               <span class="keyword">delete</span>[] buffer;
01521                               <span class="keywordflow">return</span> (MidiEvent*)-2;
01522                               }
01523                         }
01524                   buffer[len] = 0;
01525                   <span class="keywordflow">if</span> (type == 0x2f) {           <span class="comment">// End of Track</span>
01526                         <span class="keyword">delete</span> event;
01527                         <span class="keyword">delete</span>[] buffer;
01528                         <span class="keywordflow">return</span> 0;
01529                         }
01530                   <span class="keywordflow">switch</span> (type) {
01531                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a30">META_TRACK_NAME</a>:
01532                               {
01533                               QString s((<span class="keywordtype">char</span>*)buffer);
01534                               track-&gt;setName(s);
01535                               <span class="keyword">delete</span>[] buffer;
01536                               <span class="keyword">delete</span> event;
01537                               }
01538                               <span class="keywordflow">return</span> (MidiEvent*)-1;  <span class="comment">// DEBUG: eigentlich nchsten Event lesen</span>
01539                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a40">META_TRACK_COMMENT</a>:
01540                               {
01541                               QString s((<span class="keywordtype">char</span>*)buffer);
01542                               track-&gt;setComment(s);
01543                               <span class="keyword">delete</span>[] buffer;
01544                               <span class="keyword">delete</span> event;
01545                               }
01546                               <span class="keywordflow">return</span> (MidiEvent*)-1;  <span class="comment">// DEBUG: eigentlich nchsten Event lesen</span>
01547                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a42">META_CHANNEL_PREFIX</a>:
01548                               <span class="keywordflow">if</span> (len == 1) {
01549                                     <a class="code" href="classMidiFile.html#r8">channelprefix</a> = buffer[0];
01550                                     <span class="keyword">delete</span>[] buffer;
01551                                     <span class="keyword">delete</span> event;
01552                                     <span class="keywordflow">return</span> (MidiEvent*)-1;
01553                                     }
01554                               <span class="keywordflow">goto</span> rest;
01555                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a41">META_PORT_CHANGE</a>:
01556                               <span class="keywordflow">if</span> (len == 1) {
01557                                     <a class="code" href="classMidiFile.html#r7">lastport</a> = buffer[0];
01558                                     <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r7">lastport</a> == 10)
01559                                           <a class="code" href="classMidiFile.html#r7">lastport</a> = 1;
01560                                     <span class="keyword">delete</span>[] buffer;
01561                                     <span class="keyword">delete</span> event;
01562                                     <span class="keywordflow">return</span> (MidiEvent*)-1;
01563                                     }
01564                               <span class="keywordflow">goto</span> rest;
01565                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a43">META_TEMPO</a>:
01566                               {
01567                               <span class="keywordtype">int</span> tempo = buffer[2] + (buffer[1] &lt;&lt; 8) + (buffer[0] &lt;&lt;16);
01568                               cs-&gt;tempomap-&gt;addTempo(t, tempo);
01569                               <span class="keyword">delete</span>[] buffer;
01570                               <span class="keyword">delete</span> event;
01571                               }
01572                               <span class="keywordflow">return</span> (MidiEvent*)-1;  <span class="comment">// DEBUG: eigentlich nchsten Event lesen</span>
01573                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a44">META_TIME_SIGNATURE</a>:
01574                               {
01575                               <a class="code" href="classMidiFile.html#r1">timesig_z</a> = buffer[0];
01576                               <span class="keywordtype">int</span> n = buffer[1];
01577                               <a class="code" href="classMidiFile.html#r2">timesig_n</a> = 1;
01578                               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n; i++)
01579                                     <a class="code" href="classMidiFile.html#r2">timesig_n</a> *= 2;
01580                               cs-&gt;sigmap-&gt;add(t, <a class="code" href="classMidiFile.html#r1">timesig_z</a>, <a class="code" href="classMidiFile.html#r2">timesig_n</a>);
01581                               <span class="keyword">delete</span> event;
01582                               <span class="keyword">delete</span>[] buffer;
01583                               }
01584                               <span class="keywordflow">return</span> (MidiEvent*)-1;  <span class="comment">// DEBUG: eigentlich nchsten Event lesen</span>
01585                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a45">META_KEY_SIGNATURE</a>:
01586                               {
01587                               (*cs-&gt;keymap)[t] = (<span class="keywordtype">signed</span> <span class="keywordtype">char</span>)(buffer[0]);
01588                               track-&gt;setKey(buffer[0]);
01589                               track-&gt;setMinor(buffer[1]);
01590                               <span class="keyword">delete</span> event;
01591                               <span class="keyword">delete</span>[] buffer;
01592                               }
01593                               <span class="keywordflow">return</span> (MidiEvent*)-1;  <span class="comment">// DEBUG: eigentlich nchsten Event lesen</span>
01594                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a33">META_MARKER</a>:
01595 <span class="comment">//                              song-&gt;addMarker(QString((const char*)(buffer)), event-&gt;posTick(), false);</span>
01596                               <span class="keyword">delete</span> event;
01597                               <span class="keyword">delete</span>[] buffer;
01598                               <span class="keywordflow">return</span> (MidiEvent*)-1;  <span class="comment">// DEBUG: eigentlich nchsten Event lesen</span>
01599                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a35">META_TITLE</a>:
01600                               <a class="code" href="classMidiFile.html#o1">title</a> = (<span class="keywordtype">char</span>*)buffer;
01601                               <span class="keyword">delete</span> event;
01602                               <span class="keyword">delete</span>[] buffer;
01603                               <span class="keywordflow">return</span> (MidiEvent*)-1;
01604                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a36">META_SUBTITLE</a>:
01605                               <a class="code" href="classMidiFile.html#o2">subTitle</a> = (<span class="keywordtype">char</span>*)buffer;
01606                               <span class="keyword">delete</span> event;
01607                               <span class="keyword">delete</span>[] buffer;
01608                               <span class="keywordflow">return</span> (MidiEvent*)-1;
01609                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a37">META_COMPOSER</a>:
01610                               <a class="code" href="classMidiFile.html#o3">composer</a> = (<span class="keywordtype">char</span>*)buffer;
01611                               <span class="keyword">delete</span> event;
01612                               <span class="keyword">delete</span>[] buffer;
01613                               <span class="keywordflow">return</span> (MidiEvent*)-1;
01614                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a38">META_TRANSLATOR</a>:
01615                               <a class="code" href="classMidiFile.html#o4">translator</a> = (<span class="keywordtype">char</span>*)buffer;
01616                               <span class="keyword">delete</span> event;
01617                               <span class="keyword">delete</span>[] buffer;
01618                               <span class="keywordflow">return</span> (MidiEvent*)-1;
01619                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a39">META_POET</a>:
01620                               <a class="code" href="classMidiFile.html#o5">poet</a> = (<span class="keywordtype">char</span>*)buffer;
01621                               <span class="keyword">delete</span> event;
01622                               <span class="keyword">delete</span>[] buffer;
01623                               <span class="keywordflow">return</span> (MidiEvent*)-1;
01624                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a27">META_SEQUENCE_NUMBER</a>:
01625                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a28">META_TEXT</a>:
01626                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a29">META_COPYRIGHT</a>:
01627                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a31">META_INSTRUMENT_NAME</a>:     <span class="comment">// Instrument Name</span>
01628                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a32">META_LYRIC</a>:
01629                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a51a34">META_CUE_POINT</a>:
01630 rest:
01631                         <span class="keywordflow">default</span>:
01632                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a21">ME_META</a>;
01633                               {
01634                               event-&gt;<a class="code" href="structMidiEvent.html#o1">dataLen</a> = len+1;
01635                               event-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>    = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[len+1];
01636                               memcpy(event-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>, buffer, len+1);
01637                               }
01638                               event-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a> = type;
01639                               <span class="keywordflow">break</span>;
01640                         }
01641                   <span class="keywordflow">break</span>;
01642             <span class="keywordflow">default</span>:
01643                   <span class="keywordflow">if</span> (me &amp; 0x80) {                     <span class="comment">// status byte</span>
01644                         <a class="code" href="classMidiFile.html#r4">lastchan</a> = me &amp; 0x0f;
01645                         <a class="code" href="classMidiFile.html#r3">status</a>   = me &amp; 0xf0;
01646                         <a class="code" href="classMidiFile.html#r6">sstatus</a>  = <a class="code" href="classMidiFile.html#r3">status</a>;
01647                         <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#a2">read</a>(&amp;a, 1)) {
01648                               printf(<span class="stringliteral">"readEvent: error 9\n"</span>);
01649                               <span class="keyword">delete</span> event;
01650                               <span class="keywordflow">return</span> (MidiEvent*)-2;
01651                               }
01652                         a &amp;= 0x7F;
01653                         }
01654                   <span class="keywordflow">else</span> {
01655                         <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r3">status</a> == -1) {
01656                               printf(<span class="stringliteral">"readEvent: no running status, read 0x%02x\n"</span>, me);
01657                               printf(<span class="stringliteral">"sstatus ist 0x%02x\n"</span>, <a class="code" href="classMidiFile.html#r6">sstatus</a>);
01658                               <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#r6">sstatus</a> == -1) {
01659                                     <span class="keyword">delete</span> event;
01660                                     <span class="keywordflow">return</span> (MidiEvent*)-1;
01661                                     }
01662                               <a class="code" href="classMidiFile.html#r3">status</a> = <a class="code" href="classMidiFile.html#r6">sstatus</a>;
01663                               }
01664                         a = me;
01665                         }
01666                   b = 0;
01667                   <span class="keywordflow">switch</span> (<a class="code" href="classMidiFile.html#r3">status</a> &amp; 0xf0) {
01668                         <span class="keywordflow">case</span> 0x80:        <span class="comment">// Taste loslassen</span>
01669                         <span class="keywordflow">case</span> 0x90:        <span class="comment">// Taste anschlagen</span>
01670                         <span class="keywordflow">case</span> 0xa0:        <span class="comment">// Polyphoner Aftertouch</span>
01671                         <span class="keywordflow">case</span> 0xb0:        <span class="comment">// Controller</span>
01672                         <span class="keywordflow">case</span> 0xe0:        <span class="comment">// Pitch Bender</span>
01673                               <span class="keywordflow">if</span> (<a class="code" href="classMidiFile.html#a2">read</a>(&amp;b, 1)) {
01674                                     printf(<span class="stringliteral">"readEvent: error 15\n"</span>);
01675                                     <span class="keyword">delete</span> event;
01676                                     <span class="keywordflow">return</span> (MidiEvent*)-2;
01677                                     }
01678                               <span class="keywordflow">if</span> ((<a class="code" href="classMidiFile.html#r3">status</a> &amp; 0xf0) == 0xe0)
01679                                     event-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a> = (((((b &amp; 0x80) ? 0 : b) &lt;&lt; 7) + a) - 8192);
01680                               <span class="keywordflow">else</span>
01681                                     event-&gt;<a class="code" href="structMidiEvent.html#o6">dataB</a> = (b &amp; 0x80 ? 0 : b);
01682                               <span class="keywordflow">break</span>;
01683                         <span class="keywordflow">case</span> 0xc0:        <span class="comment">// Program Change</span>
01684                         <span class="keywordflow">case</span> 0xd0:        <span class="comment">// Channel Aftertouch</span>
01685                               <span class="keywordflow">break</span>;
01686                         <span class="keywordflow">default</span>:          <span class="comment">// f1 f2 f3 f4 f5 f6 f7 f8 f9</span>
01687                               printf(<span class="stringliteral">"BAD STATUS 0x%02x, me 0x%02x\n"</span>, <a class="code" href="classMidiFile.html#r3">status</a>, me);
01688                               <span class="keyword">delete</span> event;
01689                               <span class="keywordflow">return</span> (MidiEvent*)-2;
01690                         }
01691                   event-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a> = a;
01692                   <span class="keywordflow">switch</span> (<a class="code" href="classMidiFile.html#r3">status</a> &amp; 0xf0) {
01693                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a13">ME_NOTEOFF</a>:        <span class="comment">// Taste loslassen</span>
01694                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a13">ME_NOTEOFF</a>;
01695                               <span class="keywordflow">break</span>;
01696                         <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a14">ME_NOTEON</a>:        <span class="comment">// Taste anschlagen</span>
01697                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = event-&gt;<a class="code" href="structMidiEvent.html#o6">dataB</a> == 0 ? <a class="code" href="midi_8h.html#a50a13">ME_NOTEOFF</a> : <a class="code" href="midi_8h.html#a50a14">ME_NOTEON</a>;
01698                               <span class="keywordflow">break</span>;
01699                         <span class="keywordflow">case</span> 0xa0:        <span class="comment">// Polyphoner Aftertouch</span>
01700                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a15">ME_POLYAFTER</a>;
01701                               <span class="keywordflow">break</span>;
01702                         <span class="keywordflow">case</span> 0xb0:        <span class="comment">// Controller</span>
01703                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a16">ME_CONTROLLER</a>;
01704                               <span class="keywordflow">break</span>;
01705                         <span class="keywordflow">case</span> 0xc0:        <span class="comment">// Program Change</span>
01706                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a17">ME_PROGRAM</a>;
01707                               <span class="keywordflow">break</span>;
01708                         <span class="keywordflow">case</span> 0xd0:        <span class="comment">// Channel Aftertouch</span>
01709                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a18">ME_AFTERTOUCH</a>;
01710                               <span class="keywordflow">break</span>;
01711                         <span class="keywordflow">case</span> 0xe0:        <span class="comment">// Pitch Bender</span>
01712                               event-&gt;<a class="code" href="structMidiEvent.html#o4">type</a> = <a class="code" href="midi_8h.html#a50a19">ME_PITCHBEND</a>;
01713                               <span class="keywordflow">break</span>;
01714                         <span class="keywordflow">default</span>:
01715                               assert(<span class="keyword">false</span>);
01716                               <span class="keywordflow">break</span>;
01717                         }
01718                   <span class="keywordflow">if</span> ((a &amp; 0x80) || (b &amp; 0x80)) {
01719                         printf(<span class="stringliteral">"8'tes Bit in Daten(%02x %02x): tick %d read 0x%02x  status:0x%02x channel:0x%02x\n"</span>,
01720                           a &amp; 0xff, b &amp; 0xff, <a class="code" href="classMidiFile.html#r5">click</a>, me, <a class="code" href="classMidiFile.html#r3">status</a>, <a class="code" href="classMidiFile.html#r4">lastchan</a>);
01721                         printf(<span class="stringliteral">"readEvent: error 16\n"</span>);
01722                         <span class="keywordflow">if</span> (b &amp; 0x80) {
01723                               <span class="comment">// Try to fix: interpret as channel byte</span>
01724                               <a class="code" href="classMidiFile.html#r4">lastchan</a> = b &amp; 0x0f;
01725                               <a class="code" href="classMidiFile.html#r3">status</a>   = b &amp; 0xf0;
01726                               <a class="code" href="classMidiFile.html#r6">sstatus</a>  = <a class="code" href="classMidiFile.html#r3">status</a>;
01727                               <span class="keywordflow">return</span> event;
01728                               }
01729                         <span class="keyword">delete</span> event;
01730                         <span class="keywordflow">return</span> (MidiEvent*)-1;
01731                         }
01732                   <span class="keywordflow">break</span>;
01733             }
01734       <span class="keywordflow">return</span> event;
01735 <span class="preprocessor">#endif</span>
01736 <span class="preprocessor"></span>      <span class="keywordflow">return</span> 0;
01737       }
01738 
01739 <span class="comment">//---------------------------------------------------------</span>
01740 <span class="comment">//   processTrack</span>
01741 <span class="comment">//---------------------------------------------------------</span>
01742 
<a name="l01743"></a><a class="code" href="classMidiFile.html#d14">01743</a> <span class="keywordtype">void</span> <a class="code" href="classMidiFile.html#d14">MidiFile::processTrack</a>(<a class="code" href="classMidiTrack.html">MidiTrack</a>* track)
01744       {
01745       <span class="keywordflow">if</span> (track-&gt;<a class="code" href="classMidiTrack.html#a4">outChannel</a>() == 9 &amp;&amp; <a class="code" href="classMidiFile.html#a5">midiType</a>() != <a class="code" href="midi_8h.html#a52a46">MT_UNKNOWN</a>)
01746             track-&gt;<a class="code" href="classMidiTrack.html#a13">setDrumTrack</a>(<span class="keyword">true</span>);
01747 
01748       <span class="comment">//---------------------------------------------------</span>
01749       <span class="comment">//    get initial controller state</span>
01750       <span class="comment">//---------------------------------------------------</span>
01751 
01752       <a class="code" href="midi_8h.html#a5">EventList</a>* tevents = track-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
01753       track-&gt;<a class="code" href="classMidiTrack.html#o0">hbank</a>   = -1;
01754       track-&gt;<a class="code" href="classMidiTrack.html#o1">lbank</a>   = -1;
01755       track-&gt;<a class="code" href="classMidiTrack.html#o2">program</a> = -1;
01756 
01757       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> i = tevents-&gt;begin(); i != tevents-&gt;end();) {
01758             <a class="code" href="midi_8h.html#a6">iEvent</a> ie = i;
01759             ++ie;
01760             <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev  = (<a class="code" href="structMidiEvent.html">MidiEvent</a>*)i-&gt;second;
01761             <span class="keywordflow">switch</span>(ev-&gt;<a class="code" href="structMidiEvent.html#o4">type</a>) {
01762                   <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a14">ME_NOTEON</a>:
01763                         <span class="keywordflow">break</span>;
01764                   <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a17">ME_PROGRAM</a>:
01765                         <span class="keywordflow">if</span> (track-&gt;<a class="code" href="classMidiTrack.html#o2">program</a> == -1) {
01766                               track-&gt;<a class="code" href="classMidiTrack.html#o2">program</a> = ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>;
01767                               tevents-&gt;erase(i);
01768                               }
01769                         <span class="keywordflow">break</span>;
01770 <span class="preprocessor">#if 0</span>
01771 <span class="preprocessor"></span>                  <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a16">ME_CONTROLLER</a>:
01772                         <span class="keywordflow">switch</span>(ev-&gt;cntrl()) {
01773                               <span class="keywordflow">case</span> CTRL_LDATA:
01774                               <span class="keywordflow">case</span> CTRL_HDATA:
01775                               <span class="keywordflow">case</span> CTRL_LNRPN:
01776                               <span class="keywordflow">case</span> CTRL_HNRPN:
01777                               <span class="keywordflow">case</span> CTRL_LRPN:
01778                               <span class="keywordflow">case</span> CTRL_HRPN:
01779                                     <span class="keywordflow">break</span>;
01780                               <span class="keywordflow">default</span>:
01781                                     <span class="keywordflow">if</span> (port-&gt;iState(channel)-&gt;controller[ev-&gt;cntrl()] == -1) {
01782                                           port-&gt;iState(channel)-&gt;controller[ev-&gt;cntrl()] = ev-&gt;cntrlVal();
01783                                           <span class="comment">// add to controller list</span>
01784                                           addMidiController(MidiController::Controller7, ev-&gt;cntrl(), 0);
01785                                           tevents-&gt;erase(i);
01786                                           }
01787                                     <span class="keywordflow">break</span>;
01788                               }
01789                         <span class="keywordflow">break</span>;
01790 <span class="preprocessor">#endif</span>
01791 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
01792 <span class="preprocessor"></span>                  <span class="keywordflow">case</span> <a class="code" href="midi_8h.html#a50a21">ME_META</a>:
01793                         <span class="keywordflow">switch</span>(ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>) {
01794                               <span class="keywordflow">case</span> 0x1:        <span class="comment">// text event</span>
01795                                     <span class="keywordflow">if</span> (trackno == 1 &amp;&amp; memcmp(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>(), <span class="stringliteral">"@KMID"</span>, 5) == 0) {
01796                                           karaoke = <span class="keyword">true</span>;
01797                                           song-&gt;setKaraokeFlag(<span class="keyword">true</span>);
01798                                           song-&gt;setKaraokeChannel(channel);
01799                                           tevents-&gt;erase(i);
01800                                           }
01801                                     <span class="keywordflow">if</span> ((trackno == 2) &amp;&amp; karaoke) {
01802                                           <span class="keywordtype">char</span>* p = (<span class="keywordtype">char</span>*)(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>());
01803                                           <span class="keywordflow">if</span> (*p == <span class="charliteral">'@'</span>) {
01804                                                 <span class="keywordflow">switch</span>(karaokeState) {
01805                                                       <span class="keywordflow">case</span> 0:     <span class="comment">// expect language</span>
01806                                                             ++karaokeState;
01807                                                             <span class="keywordflow">break</span>;
01808                                                       <span class="keywordflow">case</span> 1:     <span class="comment">// expect titel</span>
01809                                                             ++karaokeState;  <span class="comment">// language</span>
01810                                                             song-&gt;setName(p+2);
01811                                                             <span class="keywordflow">break</span>;
01812                                                       <span class="keywordflow">case</span> 2:     <span class="comment">// expect interpret</span>
01813                                                             ++karaokeState;
01814                                                             song-&gt;setKomponist1(p+2);
01815                                                             <span class="keywordflow">break</span>;
01816                                                       <span class="keywordflow">default</span>:
01817                                                             printf(<span class="stringliteral">"unexpected @ in karaoke\n"</span>);
01818                                                             <span class="keywordflow">break</span>;
01819                                                       }
01820                                                 }
01821                                           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (karaokeState == 3) {
01822                                                 <span class="comment">// text sammeln</span>
01823                                                 song-&gt;karaoke()-&gt;add(ev);
01824                                                 }
01825                                           tevents-&gt;erase(i);
01826                                           }
01827                                     <span class="keywordflow">break</span>;
01828                               <span class="keywordflow">case</span> 0x2:         <span class="comment">// Copyright</span>
01829                                     song-&gt;setCopyright(QString((<span class="keyword">const</span> <span class="keywordtype">char</span>*)(ev-&gt;<a class="code" href="structMidiEvent.html#o0">data</a>())));
01830                                     tevents-&gt;erase(i);
01831                                     <span class="keywordflow">break</span>;
01832 
01833                               <span class="keywordflow">default</span>:
01834                                     <span class="keywordflow">break</span>;
01835                               }
01836                         <span class="keywordflow">break</span>;
01837 <span class="preprocessor">#endif</span>
01838 <span class="preprocessor"></span>                  <span class="keywordflow">default</span>:
01839                         <span class="keywordflow">break</span>;
01840                   }
01841             i = ie;
01842             }
01843 
01844       <span class="comment">//---------------------------------------------------</span>
01845       <span class="comment">//    change NoteOff events into Note events</span>
01846       <span class="comment">//    with len</span>
01847       <span class="comment">//---------------------------------------------------</span>
01848 
01849       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> i = tevents-&gt;begin(); i != tevents-&gt;end(); ++i) {
01850             <a class="code" href="structMidiEvent.html">MidiEvent</a>* event = (<a class="code" href="structMidiEvent.html">MidiEvent</a>*)i-&gt;second;
01851             <span class="keywordflow">if</span> (event-&gt;<a class="code" href="structMidiEvent.html#a2">isNote</a>())
01852                   event-&gt;<a class="code" href="structMidiEvent.html#o3">len</a> = -1;
01853             }
01854 
01855       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> i = tevents-&gt;begin(); i != tevents-&gt;end(); ++i) {
01856             <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev  = (<a class="code" href="structMidiEvent.html">MidiEvent</a>*)i-&gt;second;
01857             <span class="keywordflow">if</span> (ev-&gt;<a class="code" href="structMidiEvent.html#a2">isNote</a>()) {
01858                   <span class="keywordflow">if</span> (ev-&gt;<a class="code" href="structMidiEvent.html#a3">isNoteOff</a>()) {
01859                         printf(<span class="stringliteral">"NOTE OFF without Note ON\n"</span>);
01860                         }
01861                   <a class="code" href="midi_8h.html#a6">iEvent</a> k;
01862                   <span class="keywordflow">for</span> (k = tevents-&gt;lower_bound(ev-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a>); k != tevents-&gt;end(); ++k) {
01863                         <a class="code" href="structMidiEvent.html">MidiEvent</a>* event = (<a class="code" href="structMidiEvent.html">MidiEvent</a>*)k-&gt;second;
01864                         <span class="keywordflow">if</span> (ev-&gt;<a class="code" href="structMidiEvent.html#a3">isNoteOff</a>(event)) {
01865                               <span class="keywordtype">int</span> t = k-&gt;first - i-&gt;first;
01866                               <span class="keywordflow">if</span> (t &lt;= 0)
01867                                     t = 1;
01868                               ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a> = t;
01869                               ev-&gt;<a class="code" href="structMidiEvent.html#o7">dataC</a> = event-&gt;<a class="code" href="structMidiEvent.html#o7">dataC</a>;
01870                               <span class="keywordflow">break</span>;
01871                               }
01872                         }
01873                   <span class="keywordflow">if</span> (k == tevents-&gt;end()) {
01874                         printf(<span class="stringliteral">"-kein note-off! %d pitch %d velo %d\n"</span>,
01875                            i-&gt;first, ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>, ev-&gt;<a class="code" href="structMidiEvent.html#o6">dataB</a>);
01876                         <span class="comment">//</span>
01877                         <span class="comment">// ton am Taktende abschalten</span>
01878                         <span class="comment">//</span>
01879                         <span class="keywordtype">int</span> endTick = ev-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a> + 1; <span class="comment">// song-&gt;roundUpBar(ev-&gt;tick + 1);</span>
01880                         ev-&gt;<a class="code" href="structMidiEvent.html#o3">len</a> = endTick - ev-&gt;<a class="code" href="structMidiEvent.html#o2">tick</a>;
01881                         }
01882                   <span class="keywordflow">else</span> {
01883                         tevents-&gt;erase(k);
01884                         }
01885                   }
01886             }
01887 
01888       <span class="comment">// DEBUG: any note off left?</span>
01889 
01890       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> i = tevents-&gt;begin(); i != tevents-&gt;end(); ++i) {
01891             <a class="code" href="structMidiEvent.html">MidiEvent</a>* ev  = (<a class="code" href="structMidiEvent.html">MidiEvent</a>*)i-&gt;second;
01892             <span class="keywordflow">if</span> (ev-&gt;<a class="code" href="structMidiEvent.html#a3">isNoteOff</a>()) {
01893                   printf(<span class="stringliteral">"+extra note-off! %d pitch %d velo %d\n"</span>,
01894                            i-&gt;first, ev-&gt;<a class="code" href="structMidiEvent.html#o5">dataA</a>, ev-&gt;<a class="code" href="structMidiEvent.html#o6">dataB</a>);
01895                   }
01896             }
01897       }
01898 
01899 <span class="comment">//---------------------------------------------------------</span>
01900 <span class="comment">//   empty</span>
01901 <span class="comment">//    check for empty track</span>
01902 <span class="comment">//---------------------------------------------------------</span>
01903 
<a name="l01904"></a><a class="code" href="classMidiTrack.html#a2">01904</a> <span class="keywordtype">bool</span> <a class="code" href="classMidiTrack.html#a2">MidiTrack::empty</a>()<span class="keyword"> const</span>
01905 <span class="keyword">      </span>{
01906       <span class="keywordflow">return</span> <a class="code" href="classMidiTrack.html#r0">_events</a>-&gt;empty();
01907       }
01908 
01909 <span class="comment">//---------------------------------------------------------</span>
01910 <span class="comment">//   instrName</span>
01911 <span class="comment">//---------------------------------------------------------</span>
01912 
<a name="l01913"></a><a class="code" href="classMidiTrack.html#a14">01913</a> QString <a class="code" href="classMidiTrack.html#a14">MidiTrack::instrName</a>(<span class="keywordtype">int</span> type)<span class="keyword"> const</span>
01914 <span class="keyword">      </span>{
01915       <span class="keywordflow">if</span> (<a class="code" href="classMidiTrack.html#o2">program</a> != -1) {
01916             <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <span class="keyword">sizeof</span>(<a class="code" href="midi_8cpp.html#a6">minstr</a>)/<span class="keyword">sizeof</span>(*minstr); ++i) {
01917                   <a class="code" href="structMidiInstrument.html">MidiInstrument</a>* mi = &amp;<a class="code" href="midi_8cpp.html#a6">minstr</a>[i];
01918                   <span class="keywordflow">if</span> ((mi-&gt;<a class="code" href="structMidiInstrument.html#o3">patch</a> == <a class="code" href="classMidiTrack.html#o2">program</a>)
01919                      &amp;&amp; (mi-&gt;<a class="code" href="structMidiInstrument.html#o0">type</a> &amp; type)
01920                      &amp;&amp; (mi-&gt;<a class="code" href="structMidiInstrument.html#o1">hbank</a> == <a class="code" href="classMidiTrack.html#o0">hbank</a> || <a class="code" href="classMidiTrack.html#o0">hbank</a> == -1)
01921                      &amp;&amp; (mi-&gt;<a class="code" href="structMidiInstrument.html#o2">lbank</a> == <a class="code" href="classMidiTrack.html#o1">lbank</a> || <a class="code" href="classMidiTrack.html#o1">lbank</a> == -1)) {
01922                         <span class="keywordflow">return</span> QString(mi-&gt;<a class="code" href="structMidiInstrument.html#o5">name</a>);
01923                         }
01924                   }
01925             }
01926       <span class="keywordflow">return</span> <a class="code" href="classMidiTrack.html#a8">name</a>();
01927       }
01928 
01929 <span class="comment">// prepare:</span>
01930 <span class="comment">//    * remove empty tracks</span>
01931 <span class="comment">//    * Tracknamen feststellen; sollen Kommentare oder</span>
01932 <span class="comment">//      Instrumentennamen verwendet werden?</span>
01933 <span class="comment">//    - Instrumente feststellen</span>
01934 <span class="comment">//          - Name (kommentar?)</span>
01935 <span class="comment">//          - Schlssel</span>
01936 <span class="comment">//          - Split System?</span>
01937 <span class="comment">//    * Takte feststellen</span>
01938 <span class="comment">//    - Schlagzeugtrack markieren</span>
01939 <span class="comment">//    - Quantisierung festlegen:</span>
01940 <span class="comment">//       - krzeste Note feststellen</span>
01941 <span class="comment">//    - songtitle</span>
01942 
01943 <span class="comment">// process:</span>
01944 <span class="comment">//    for every measure:</span>
01945 <span class="comment">//          * create measure</span>
01946 <span class="comment">//          - insert notes</span>
01947 <span class="comment">//          - Triolen?</span>
01948 
01949 <span class="comment">//---------------------------------------------------------</span>
01950 <span class="comment">//   quantizeLen</span>
01951 <span class="comment">//---------------------------------------------------------</span>
01952 
<a name="l01953"></a><a class="code" href="midi_8cpp.html#a7">01953</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="midi_8cpp.html#a7">quantizeLen</a>(<span class="keywordtype">int</span> len)
01954       {
01955       <span class="keywordflow">if</span> (len &lt; <a class="code" href="mtime_8h.html#a0">division</a>/12)
01956             len = <a class="code" href="mtime_8h.html#a0">division</a>/8;
01957       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; <a class="code" href="mtime_8h.html#a0">division</a>/6)
01958             len = <a class="code" href="mtime_8h.html#a0">division</a>/4;
01959       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; <a class="code" href="mtime_8h.html#a0">division</a>/3)
01960             len = <a class="code" href="mtime_8h.html#a0">division</a>/2;
01961       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; <a class="code" href="mtime_8h.html#a0">division</a>+<a class="code" href="mtime_8h.html#a0">division</a>/2)
01962             len = <a class="code" href="mtime_8h.html#a0">division</a>;
01963       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; <a class="code" href="mtime_8h.html#a0">division</a> * 3)
01964             len = <a class="code" href="mtime_8h.html#a0">division</a>*2;
01965       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; <a class="code" href="mtime_8h.html#a0">division</a> * 6)
01966             len = <a class="code" href="mtime_8h.html#a0">division</a> * 4;
01967       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; <a class="code" href="mtime_8h.html#a0">division</a> * 12)
01968             len = <a class="code" href="mtime_8h.html#a0">division</a> * 8;
01969       <span class="keywordflow">else</span>
01970             len = <a class="code" href="mtime_8h.html#a0">division</a> * 16;
01971       <span class="keywordflow">return</span> len;
01972       }
01973 
01974 <span class="comment">//---------------------------------------------------------</span>
01975 <span class="comment">//   convertMidi</span>
01976 <span class="comment">//---------------------------------------------------------</span>
01977 
<a name="l01978"></a><a class="code" href="classScore.html#a125">01978</a> <span class="keywordtype">void</span> <a class="code" href="classScore.html#a125">Score::convertMidi</a>(<a class="code" href="classMidiFile.html">MidiFile</a>* mf)
01979       {
01980       <a class="code" href="midi_8h.html#a10">MidiTrackList</a>* tracks = mf-&gt;<a class="code" href="classMidiFile.html#a4">tracks</a>();
01981 
01982       <span class="comment">//---------------------------------------------------</span>
01983       <span class="comment">//  remove empty tracks</span>
01984       <span class="comment">//---------------------------------------------------</span>
01985 
01986       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a11">iMidiTrack</a> i = tracks-&gt;begin(); i != tracks-&gt;end();) {
01987             <span class="keywordtype">int</span> events = 0;
01988             <a class="code" href="classMidiTrack.html">MidiTrack</a>* track = *i;
01989             <a class="code" href="midi_8h.html#a5">EventList</a>* el = (*i)-&gt;events();
01990             <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> ie = el-&gt;begin(); ie != el-&gt;end(); ++ie) {
01991                   <span class="keywordflow">if</span> (ie-&gt;second-&gt;isNote()) {
01992                         ++events;
01993                         <span class="keywordtype">int</span> pitch = ie-&gt;second-&gt;pitch();
01994                         <span class="keywordflow">if</span> (pitch &gt; track-&gt;<a class="code" href="classMidiTrack.html#o4">maxPitch</a>)
01995                               track-&gt;<a class="code" href="classMidiTrack.html#o4">maxPitch</a> = pitch;
01996                         <span class="keywordflow">if</span> (pitch &lt; track-&gt;<a class="code" href="classMidiTrack.html#o3">minPitch</a>)
01997                               track-&gt;<a class="code" href="classMidiTrack.html#o3">minPitch</a> = pitch;
01998                         track-&gt;<a class="code" href="classMidiTrack.html#o5">medPitch</a> += pitch;
01999                         }
02000                   }
02001             <a class="code" href="midi_8h.html#a11">iMidiTrack</a> ii = i;
02002             ++ii;
02003             <span class="keywordflow">if</span> (events == 0) {
02004                   <span class="keyword">delete</span> *i;
02005                   tracks-&gt;erase(i);
02006                   }
02007             <span class="keywordflow">else</span>
02008                   track-&gt;<a class="code" href="classMidiTrack.html#o5">medPitch</a> = track-&gt;<a class="code" href="classMidiTrack.html#o5">medPitch</a> / events;
02009             i = ii;
02010             }
02011 
02012       <span class="comment">//---------------------------------------------------</span>
02013       <span class="comment">//  create instruments</span>
02014       <span class="comment">//---------------------------------------------------</span>
02015 
02016       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a11">iMidiTrack</a> i = tracks-&gt;begin(); i != tracks-&gt;end(); ++i) {
02017             <a class="code" href="classMidiTrack.html">MidiTrack</a>* midiTrack = *i;
02018             <span class="keywordtype">int</span> <a class="code" href="classScore.html#a5">staves</a> = (midiTrack-&gt;<a class="code" href="classMidiTrack.html#o4">maxPitch</a> - midiTrack-&gt;<a class="code" href="classMidiTrack.html#o3">minPitch</a> &gt; 36) ? 2 : 1;
02019 <span class="comment">//            Instrument* instrument = new Instrument(staves);</span>
02020 
02021 <span class="comment">/* printf("track &lt;%s&gt; channel %d  program %d/%d/%d &lt;%s&gt;\n",</span>
02022 <span class="comment">               midiTrack-&gt;name().latin1(),</span>
02023 <span class="comment">               midiTrack-&gt;outChannel(),</span>
02024 <span class="comment">               midiTrack-&gt;hbank,</span>
02025 <span class="comment">               midiTrack-&gt;lbank,</span>
02026 <span class="comment">               midiTrack-&gt;program,</span>
02027 <span class="comment">               midiTrack-&gt;instrName(mf-&gt;midiType()).latin1());</span>
02028 <span class="comment">   */</span>
02029 <span class="comment">/*            if (midiTrack-&gt;name().isEmpty())</span>
02030 <span class="comment">                  instrument-&gt;setLongName(midiTrack-&gt;instrName(mf-&gt;midiType()));</span>
02031 <span class="comment">            else</span>
02032 <span class="comment">                  instrument-&gt;setLongName(midiTrack-&gt;name());</span>
02033 <span class="comment">            instrument-&gt;setTrackName(instrument-&gt;longName());</span>
02034 <span class="comment">            instrument-&gt;setMidiChannel(midiTrack-&gt;outChannel());</span>
02035 <span class="comment">            instrument-&gt;setMidiProgram(midiTrack-&gt;program);</span>
02036 <span class="comment">*/</span>
02037             <span class="keywordflow">if</span> (staves == 2) {
02038                   <span class="comment">// construct a akkolade</span>
02039 <span class="comment">//                  instrument-&gt;setClefIdx(0, 0);</span>
02040 <span class="comment">//                  instrument-&gt;setClefIdx(1, 4);</span>
02041                   }
02042             <span class="keywordflow">else</span> {
02043                   <span class="keywordtype">int</span> clefIdx = 0;                    <span class="comment">// treble clef</span>
02044                   <span class="keywordflow">if</span> (midiTrack-&gt;<a class="code" href="classMidiTrack.html#o5">medPitch</a> &lt; 58)
02045                         clefIdx = 4;                  <span class="comment">// bass clef</span>
02046 <span class="comment">//                  instrument-&gt;setClefIdx(0, clefIdx);</span>
02047                   }
02048 <span class="comment">//TODO2            cs-&gt;appendInstrument(instrument);</span>
02049             }
02050 
02051       <span class="comment">//---------------------------------------------------</span>
02052       <span class="comment">//  remove empty measures at beginning</span>
02053       <span class="comment">//---------------------------------------------------</span>
02054 
02055       <span class="keywordtype">int</span> startBar;
02056       <span class="keywordflow">for</span> (startBar = 0; <span class="keyword">true</span>; ++startBar) {
02057             <span class="keywordtype">int</span> tick1 = <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a8">bar2tick</a>(startBar, 0, 0);
02058             <span class="keywordtype">int</span> tick2 = <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a8">bar2tick</a>(startBar + 1, 0, 0);
02059             <span class="keywordtype">int</span> events = 0;
02060             <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a11">iMidiTrack</a> i = tracks-&gt;begin(); i != tracks-&gt;end(); ++i) {
02061                   <a class="code" href="classMidiTrack.html">MidiTrack</a>* midiTrack = *i;
02062                   <a class="code" href="midi_8h.html#a5">EventList</a>* el = midiTrack-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
02063                   <a class="code" href="midi_8h.html#a6">iEvent</a> i1     = el-&gt;lower_bound(tick1);
02064                   <a class="code" href="midi_8h.html#a6">iEvent</a> i2     = el-&gt;lower_bound(tick2);
02065                   <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> ie = i1; ie != i2; ++ie) {
02066                         <span class="keywordflow">if</span> (ie-&gt;second-&gt;isNote()) {
02067                               ++events;
02068                               <span class="keywordflow">break</span>;
02069                               }
02070                         }
02071                   }
02072             <span class="keywordflow">if</span> (events)
02073                   <span class="keywordflow">break</span>;
02074             }
02075 
02076       <span class="comment">//---------------------------------------------------</span>
02077       <span class="comment">//  count measures</span>
02078       <span class="comment">//---------------------------------------------------</span>
02079 
02080       <span class="keywordtype">int</span> bars = 1;
02081       <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a11">iMidiTrack</a> i = tracks-&gt;begin(); i != tracks-&gt;end(); ++i) {
02082             <a class="code" href="classMidiTrack.html">MidiTrack</a>* midiTrack = *i;
02083             <a class="code" href="midi_8h.html#a5">EventList</a>* el = midiTrack-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
02084             <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> ie = el-&gt;begin(); ie != el-&gt;end(); ++ie) {
02085                   <span class="keywordflow">if</span> (!(ie-&gt;second-&gt;isNote()))
02086                         <span class="keywordflow">continue</span>;
02087                   <span class="keywordtype">int</span> tick = ie-&gt;first + ie-&gt;second-&gt;len;
02088                   <span class="keywordtype">int</span> bar, beat, rest;
02089                   <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a7">tickValues</a>(tick, &amp;bar, &amp;beat, &amp;rest);
02090                   <span class="keywordflow">if</span> (bar &gt; bars)
02091                         bars = bar;
02092                   }
02093             }
02094 
02095       <span class="comment">//---------------------------------------------------</span>
02096       <span class="comment">//  create measures</span>
02097       <span class="comment">//---------------------------------------------------</span>
02098 
02099       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = startBar; i &lt; bars; ++i) {
02100             <span class="keywordtype">int</span> tick1 = <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a8">bar2tick</a>(i, 0, 0);
02101             <span class="keywordtype">int</span> tick2 = <a class="code" href="classScore.html#o9">sigmap</a>-&gt;<a class="code" href="classSigList.html#a8">bar2tick</a>(i+1, 0, 0);
02102             <a class="code" href="classMeasure.html">Measure</a>* measure  = <span class="keyword">new</span> <a class="code" href="classMeasure.html">Measure</a>(<span class="keyword">this</span>);
02103             measure-&gt;<a class="code" href="classElement.html#a75">setTick</a>(tick1);
02104 
02105             <span class="keywordtype">int</span> staffIdx = 0;
02106             <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a11">iMidiTrack</a> i = tracks-&gt;begin(); i != tracks-&gt;end(); ++i, ++staffIdx) {
02107                   <a class="code" href="classMidiTrack.html">MidiTrack</a>* midiTrack = *i;
02108                   <a class="code" href="midi_8h.html#a5">EventList</a>* el = midiTrack-&gt;<a class="code" href="classMidiTrack.html#a3">events</a>();
02109                   <a class="code" href="midi_8h.html#a6">iEvent</a> i1     = el-&gt;lower_bound(tick1);
02110                   <a class="code" href="midi_8h.html#a6">iEvent</a> i2     = el-&gt;lower_bound(tick2);
02111 
02112                   <a class="code" href="classChord.html">Chord</a>* chord = 0;
02113                   <span class="keywordflow">for</span> (<a class="code" href="midi_8h.html#a6">iEvent</a> ie = i1; ie != i2; ++ie) {
02114                         <span class="keywordflow">if</span> (!(ie-&gt;second-&gt;isNote()))
02115                               <span class="keywordflow">continue</span>;
02116                         <span class="keywordtype">int</span> len  = <a class="code" href="midi_8cpp.html#a7">quantizeLen</a>(ie-&gt;second-&gt;len);
02117                         <span class="keywordtype">int</span> tick = (ie-&gt;first / len) * len;
02118                         <span class="keywordflow">if</span> (chord == 0 || tick != chord-&gt;<a class="code" href="classElement.html#a74">tick</a>() || chord-&gt;<a class="code" href="classElement.html#a76">tickLen</a>() != len) {
02119                               chord = <span class="keyword">new</span> <a class="code" href="classChord.html">Chord</a>(<span class="keyword">this</span>, tick);
02120                               chord-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classScore.html#a7">staff</a>(staffIdx));
02121                               measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(chord);
02122                               }
02123                         <span class="keywordtype">int</span> pitch  = ie-&gt;second-&gt;dataA;
02124                         <a class="code" href="classNote.html">Note</a>* note = <span class="keyword">new</span> <a class="code" href="classNote.html">Note</a>(<span class="keyword">this</span>, pitch, <span class="keyword">false</span>);
02125                         note-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classScore.html#a7">staff</a>(staffIdx));
02126                         chord-&gt;<a class="code" href="classChord.html#a28">add</a>(note);
02127                         note-&gt;<a class="code" href="classNote.html#a8">setTicks</a>(len);
02128                         chord-&gt;<a class="code" href="classElement.html#a77">setTickLen</a>(len);
02129                         }
02130                   <a class="code" href="classBar.html">Bar</a>* bar = 0;
02131                   <a class="code" href="classStaff.html">Staff</a>* s = <a class="code" href="classScore.html#a7">staff</a>(staffIdx);
02132                   <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classStaff.html#a4">isTop</a>()) {
02133                         bar = <span class="keyword">new</span> <a class="code" href="classBar.html">Bar</a>(<span class="keyword">this</span>);
02134                         bar-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(s);
02135                         measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(bar);
02136                         }
02137                   measure-&gt;<a class="code" href="classMeasure.html#a59">layoutNoteHeads</a>(staffIdx);
02138                   }
02139             <a class="code" href="classScore.html#a102">push_back</a>(measure);
02140             }
02141       <span class="keywordflow">for</span> (<a class="code" href="sig_8h.html#a0">iSigEvent</a> is = <a class="code" href="classScore.html#o9">sigmap</a>-&gt;begin(); is != <a class="code" href="classScore.html#o9">sigmap</a>-&gt;end(); ++is) {
02142             <a class="code" href="structSigEvent.html">SigEvent</a> se = is-&gt;second;
02143             <span class="keywordtype">int</span> tick    = is-&gt;first;
02144             <a class="code" href="classMeasure.html">Measure</a>* m  = <a class="code" href="undo_8cpp.html#a3">tick2measure</a>(tick);
02145             <span class="keywordflow">if</span> (m) {
02146                   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> staffIdx = 0; staffIdx &lt; <a class="code" href="classScore.html#a6">nstaves</a>(); ++staffIdx) {
02147                         <a class="code" href="classTimeSig.html">TimeSig</a>* ts = <span class="keyword">new</span> <a class="code" href="classTimeSig.html">TimeSig</a>(<span class="keyword">this</span>);
02148                         ts-&gt;<a class="code" href="classElement.html#a75">setTick</a>(tick);
02149                         ts-&gt;<a class="code" href="classTimeSig.html#a9">setSig</a>(se.<a class="code" href="structSigEvent.html#o2">z</a>, se.<a class="code" href="structSigEvent.html#o3">n</a>);
02150                         ts-&gt;<a class="code" href="classElement.html#a61">setStaff</a>(<a class="code" href="classScore.html#a7">staff</a>(staffIdx));
02151                         m-&gt;<a class="code" href="classMeasure.html#a8">add</a>(ts);
02152                         }
02153                   }
02154             }
02155       <a class="code" href="classMeasure.html">Measure</a>* measure = <a class="code" href="undo_8cpp.html#a3">tick2measure</a>(0);
02156       <span class="keywordflow">if</span> (measure == 0)
02157             <span class="keywordflow">return</span>;
02158       <span class="keywordflow">if</span> (!mf-&gt;<a class="code" href="classMidiFile.html#o1">title</a>.isEmpty()) {
02159             <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<span class="keyword">this</span>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a21">TEXT_STYLE_TITLE</a>);
02160             text-&gt;<a class="code" href="classSText.html#a5">setText</a>(mf-&gt;<a class="code" href="classMidiFile.html#o1">title</a>);
02161             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
02162             }
02163       <span class="keywordflow">if</span> (!mf-&gt;<a class="code" href="classMidiFile.html#o2">subTitle</a>.isEmpty()) {
02164             <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<span class="keyword">this</span>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a22">TEXT_STYLE_SUBTITLE</a>);
02165             text-&gt;<a class="code" href="classSText.html#a5">setText</a>(mf-&gt;<a class="code" href="classMidiFile.html#o2">subTitle</a>);
02166             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
02167             }
02168       <span class="keywordflow">if</span> (!mf-&gt;<a class="code" href="classMidiFile.html#o3">composer</a>.isEmpty()) {
02169             <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<span class="keyword">this</span>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a23">TEXT_STYLE_COMPOSER</a>);
02170             text-&gt;<a class="code" href="classSText.html#a5">setText</a>(mf-&gt;<a class="code" href="classMidiFile.html#o3">composer</a>);
02171             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
02172             }
02173       <span class="keywordflow">if</span> (!mf-&gt;<a class="code" href="classMidiFile.html#o4">translator</a>.isEmpty()) {
02174             <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<span class="keyword">this</span>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a37">TEXT_STYLE_TRANSLATOR</a>);
02175             text-&gt;<a class="code" href="classSText.html#a5">setText</a>(mf-&gt;<a class="code" href="classMidiFile.html#o4">translator</a>);
02176             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
02177             }
02178       <span class="keywordflow">if</span> (!mf-&gt;<a class="code" href="classMidiFile.html#o5">poet</a>.isEmpty()) {
02179             <a class="code" href="classSText.html">SText</a>* text = <span class="keyword">new</span> <a class="code" href="classSText.html">SText</a>(<span class="keyword">this</span>, <a class="code" href="element_8h.html#a65a8">TEXT</a>, <a class="code" href="style_8h.html#a45a24">TEXT_STYLE_POET</a>);
02180             text-&gt;<a class="code" href="classSText.html#a5">setText</a>(mf-&gt;<a class="code" href="classMidiFile.html#o5">poet</a>);
02181             measure-&gt;<a class="code" href="classMeasure.html#a8">add</a>(text);
02182             }
02183       }
02184 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Mon Jun 27 22:28:29 2005 for MuseScore by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
